{"version":3,"file":"Map.js","sources":["../../src/components/Map/withMapControls.ts","../../src/components/Map/Map.vue"],"sourcesContent":["import {\n  Map as MapboxMap,\n  FullscreenControl,\n  GeolocateControl,\n  ScaleControl,\n} from \"maplibre-gl\";\n\nexport const withMapControls = (map: MapboxMap) => {\n  return map\n    .addControl(\n      new FullscreenControl({\n        container: document.querySelector(\"body\") as HTMLBodyElement,\n      })\n    )\n    .addControl(\n      new GeolocateControl({\n        positionOptions: {\n          enableHighAccuracy: true,\n        },\n        // When active the map will receive updates to the device's location as it changes.\n        trackUserLocation: true,\n        // Draw an arrow next to the location dot to indicate which direction the device is heading.\n        // showUserHeading: true,\n      })\n    )\n    .addControl(new ScaleControl({ unit: \"imperial\" }));\n};\n","<template>\n  <div class=\"maplibre-map\">\n    <div class=\"flex gap-4 justify-end items-center my-2\">\n      <button\n        v-for=\"(style, key) in mapStyles\"\n        :key=\"key\"\n        class=\"text-sm uppercase\"\n        :class=\"{\n          'font-bold border-b-2 border-b-neutral-900':\n            key === activeMapStyleKey,\n          'text-neutral-500': key !== activeMapStyleKey,\n        }\"\n        @click=\"handleStyleButtonClick(key)\"\n      >\n        {{ style.label }}\n      </button>\n    </div>\n    <div ref=\"mapContainerRef\" class=\"map-container\" />\n    <slot />\n  </div>\n</template>\n\n<script setup lang=\"ts\">\nimport { ref, watch, provide, type Ref, onMounted } from \"vue\";\nimport { useResizeObserver } from \"@vueuse/core\";\nimport \"maplibre-gl/dist/maplibre-gl.css\";\nimport { Map as MapLibreMap, MapMouseEvent } from \"maplibre-gl\";\nimport type { LngLat } from \"@/types\";\nimport { MapInjectionKey } from \"@/constants/mapConstants\";\nimport { withMapControls } from \"./withMapControls\";\n\nconst props = defineProps<{\n  center: LngLat | null;\n  zoom: number;\n  apiKey: string;\n  esriSourceUrl?: string;\n}>();\n\nconst emit = defineEmits<{\n  (eventName: \"click\", mapMouseEvent: MapMouseEvent, mapboxMap: MapLibreMap);\n  (eventName: \"load\", mapboxMap: MapLibreMap);\n}>();\n\nconst mapContainerRef = ref<HTMLDivElement | null>(null);\nconst mapRef = ref<MapLibreMap | null>(null);\n\nconst mapStyles = {\n  satellite: {\n    label: \"Satellite\",\n    name: \"ArcGIS:Imagery\",\n    type: \"style\",\n  },\n  streets: {\n    label: \"Street\",\n    name: \"ArcGIS:Navigation\",\n    type: \"style\",\n  },\n};\n\ntype MapStyle = keyof typeof mapStyles;\nconst activeMapStyleKey = ref<MapStyle>(\"satellite\");\n\nconst toArcGISUrl = (styleKey: string) => {\n  const baseUrl = `https://basemaps-api.arcgis.com/arcgis/rest/services/styles`;\n  const { name, type, url } = mapStyles[styleKey];\n  return url || `${baseUrl}/${name}?type=${type}&token=${props.apiKey}`;\n};\n\nconst handleStyleButtonClick = (newStyleKey: MapStyle) => {\n  activeMapStyleKey.value = newStyleKey;\n};\n\n// watch style changes\nfunction updateStyle() {\n  if (!mapRef.value) return;\n  mapRef.value.setStyle(toArcGISUrl(activeMapStyleKey.value));\n}\n\nwatch(activeMapStyleKey, updateStyle);\n\nonMounted(() => {\n  if (!mapContainerRef.value) {\n    throw Error(\"Cannot create Map: container not defined:\");\n  }\n\n  // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n  // @ts-ignore\n  mapRef.value = withMapControls(\n    new MapLibreMap({\n      container: mapContainerRef.value,\n      center: props.center ? [props.center.lng, props.center.lat] : [0, 0],\n      style: toArcGISUrl(activeMapStyleKey.value),\n      zoom: props.zoom,\n    })\n  );\n  //@ts-check\n\n  // add click handler\n  mapRef.value.on(\"click\", (event: MapMouseEvent) => {\n    if (!mapRef.value) {\n      // this shouldn't happen\n      throw new Error(\"there was a click but no map\");\n    }\n\n    emit(\"click\", event, mapRef.value as MapLibreMap);\n  });\n\n  mapRef.value.on(\"load\", () => {\n    if (!mapRef.value) {\n      throw new Error(\"cannot emit load event: no mapRef\");\n    }\n    emit(\"load\", mapRef.value as MapLibreMap);\n  });\n\n  useResizeObserver(mapContainerRef, () => {\n    if (!mapRef.value) return;\n    mapRef.value.resize();\n  });\n});\n\n// ignore because of error about type instantiation being excessively deep\n// and possibly infinite\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nprovide(MapInjectionKey, mapRef as Ref<MapLibreMap | null>);\n// @ts-check\n</script>\n\n<style scoped>\n.mapbox-map,\n.map-container {\n  width: 100%;\n  height: 100%;\n  min-height: 50vh;\n  background: #ddd;\n}\n</style>\n"],"names":["withMapControls","map","FullscreenControl","GeolocateControl","ScaleControl","mapContainerRef","ref","mapRef","mapStyles","activeMapStyleKey","toArcGISUrl","styleKey","baseUrl","name","type","url","props","handleStyleButtonClick","newStyleKey","updateStyle","watch","onMounted","MapLibreMap","event","emit","useResizeObserver","provide","MapInjectionKey"],"mappings":"6UAOa,MAAAA,EAAmBC,GACvBA,EACJ,WACC,IAAIC,4BAAkB,CACpB,UAAW,SAAS,cAAc,MAAM,CAAA,CACzC,CAAA,EAEF,WACC,IAAIC,2BAAiB,CACnB,gBAAiB,CACf,mBAAoB,EACtB,EAEA,kBAAmB,EAAA,CAGpB,CAAA,EAEF,WAAW,IAAIC,EAAA,QAAA,aAAa,CAAE,KAAM,UAAY,CAAA,CAAC,gOCkBhDC,EAAkBC,EAA2B,IAAI,EACjDC,EAASD,EAAwB,IAAI,EAErCE,EAAY,CAChB,UAAW,CACT,MAAO,YACP,KAAM,iBACN,KAAM,OACR,EACA,QAAS,CACP,MAAO,SACP,KAAM,oBACN,KAAM,OACR,CAAA,EAIIC,EAAoBH,EAAc,WAAW,EAE7CI,EAAeC,GAAqB,CACxC,MAAMC,EAAU,8DACV,CAAE,KAAAC,EAAM,KAAAC,EAAM,IAAAC,CAAA,EAAQP,EAAUG,GACtC,OAAOI,GAAO,GAAGH,KAAWC,UAAaC,WAAcE,EAAM,QAAA,EAGzDC,EAA0BC,GAA0B,CACxDT,EAAkB,MAAQS,CAAA,EAI5B,SAASC,GAAc,CACjB,CAACZ,EAAO,OACZA,EAAO,MAAM,SAASG,EAAYD,EAAkB,KAAK,CAAC,CAC5D,CAEA,OAAAW,EAAMX,EAAmBU,CAAW,EAEpCE,EAAU,IAAM,CACV,GAAA,CAAChB,EAAgB,MACnB,MAAM,MAAM,2CAA2C,EAKzDE,EAAO,MAAQP,EACb,IAAIsB,cAAY,CACd,UAAWjB,EAAgB,MAC3B,OAAQW,EAAM,OAAS,CAACA,EAAM,OAAO,IAAKA,EAAM,OAAO,GAAG,EAAI,CAAC,EAAG,CAAC,EACnE,MAAON,EAAYD,EAAkB,KAAK,EAC1C,KAAMO,EAAM,IAAA,CACb,CAAA,EAKHT,EAAO,MAAM,GAAG,QAAUgB,GAAyB,CAC7C,GAAA,CAAChB,EAAO,MAEJ,MAAA,IAAI,MAAM,8BAA8B,EAG3CiB,EAAA,QAASD,EAAOhB,EAAO,KAAoB,CAAA,CACjD,EAEMA,EAAA,MAAM,GAAG,OAAQ,IAAM,CACxB,GAAA,CAACA,EAAO,MACJ,MAAA,IAAI,MAAM,mCAAmC,EAEhDiB,EAAA,OAAQjB,EAAO,KAAoB,CAAA,CACzC,EAEDkB,EAAkBpB,EAAiB,IAAM,CACnC,CAACE,EAAO,OACZA,EAAO,MAAM,QAAO,CACrB,CAAA,CACF,EAMDmB,EAAQC,EAAiBpB,CAAiC"}