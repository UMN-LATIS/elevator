{"version":3,"sources":["search.js"],"names":["MarkerSource","MarkerTemplate","TimelineTemplate","currentPageNumber","eventSource","cachedResults","cachedDates","searchId","resultsAvailable","previousEventComplete","dataAvailable","disableHashChange","totalResults","getCurrentSearchId","currentURL","window","location","href","replace","hash","currentHash","length","history","pushState","substr","lastIndexOf","parseSearch","$","empty","localLoadAll","loadAll","doSearch","loadCollectionHeader","val","get","basePath","data","html","pageNumber","ignoreResults","oldMatches","oldResults","matches","searchResults","parseJSON","e","alert","success","objectId","cookie","path","pathname","totalLoadedCount","processSearchResults","newArray","merge","parent","hasClass","prepMap","prepTimeline","populateSearchFields","searchEntry","populateSearchResults","getSuggestions","searchTerm","localSearch","post","textStatus","resultArray","each","index","value","reg","RegExp","search","addClass","append","italics","insert","prop","searchText","sort","Array","isArray","targetField","internalIndex","internalValue","newField","clone","appendTo","remove","targetText","text","searchObject","source","targetTemplate","template","Handlebars","compile","listSource","listTemplate","listTemplateCompiled","base_url","listHTML","show","hide","event","Event","document","dispatchEvent","markers","clearLayers","map","loadMap","L","markerClusterGroup","showCoverageOnHover","locations","index2","value2","entries","index3","value3","loc","coordinates","localMarker","marker","bindPopup","addLayer","fitBounds","getBounds","pad","compiledDate","geoTime","match","events","hasOwnProperty","dates","date","dateAsset","startTime","parseInt","start","newItem","start_date","startYear","Math","round","abs","year","t","Date","setSeconds","formattedStart","utc","create","display_date","getFullYear","month","getMonth","day","getDay","end","toString","end_date","endTime","endYear","formattedEnd","newElement","title","headline","media","thumb","primaryHandlerThumbnail2x","url","ignoreItem","existingDate","JSON","stringify","push","scale","injectStyles","TL","Timeline","timenav_position","timenav_height_percentage","rule","id","ready","htmlEntities","str","String","scroll","height","scrollTop","on","find","trigger","TimelineSource","tab","target","attr","preventDefault","embedPath","protocol","hostname","iFrameContent","embedContent","bootbox","dialog","message","buttons","label","className","this","submit","performSearchForButtonPress","first","select"],"mappings":"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","file":"search.min.js","sourcesContent":["\nvar MarkerSource;\nvar MarkerTemplate;\nvar TimelineTemplate;\nvar TimelineTemplate;\nvar cachedResults = \"\";\nvar cachedDates = null;\nvar searchId = null;\nvar currentPageNumber;\nvar eventSource;\nvar resultsAvailable = true;\nvar previousEventComplete = true;\nvar dataAvailable = true;\nvar disableHashChange = false;\nvar totalResults = 0;\n$(document).ready(function() {\n\n\t$(window).scroll(function(){\n\t\tif (resultsAvailable && $(document).height() - 50 <= $(window).scrollTop() + $(window).height()) {\n\t\t\tif(($('.nav-tabs .active').text() == \"Grid\" || $('.nav-tabs .active').text() == \"List\") && previousEventComplete && dataAvailable) {\n\t\t\t\tdoSearch(searchId, currentPageNumber+1);\n\t\t\t}\n\t\t}\n\t});\n\n\t$(\".searchText\").on(\"blur\", function() {\n\t\t$(\".advancedSearchText\").val($(\".searchText\").val());\n\t});\n\n\t$(\".advancedSearchText\").on(\"blur\", function() {\n\t\t$(\".searchText\").val($(\".advancedSearchText\").val());\n\t});\n\n\t$('a[href=\"#timeline\"]').on('shown.bs.tab', function() {\n\t\tcachedDates = null;\n\t\tprepTimeline();\n\t});\n\t$('a[href=\"#map\"]').on('shown.bs.tab', function() {\n\t\tprepMap();\n\t});\n\t$('a[href=\"#gallery\"]').on('shown.bs.tab', function() {\n\t});\n\t$('a[href=\"#grid\"]').on('shown.bs.tab', function() {\n\t\t$(\"#results\").find(\"img\").trigger(\"show\");\n\t});\n\t$('a[href=\"#list\"]').on('shown.bs.tab', function() {\n\t\t$(\"#listResults\").find(\"img\").trigger(\"show\");\n\t});\n\n\n\n\n\t$(\".previousPage\").on(\"click\",function() {\n\t\tdoSearch(searchId, currentPageNumber-1);\n\t\treturn false;\n\t});\n\n\t$(\".nextPage\").on(\"click\",function() {\n\t\tdoSearch(searchId, currentPageNumber+1);\n\t\treturn false;\n\t});\n\n\n\tMarkerSource   = $(\"#marker-template\").html();\n\tMarkerTemplate = Handlebars.compile(MarkerSource);\n\n\tTimelineSource   = $(\"#timeline-template\").html();\n\tTimelineTemplate = Handlebars.compile(TimelineSource);\n\n\n\tif (location.hash !== '')  {\n\t\t$('a[href=\"' + location.hash + '\"]').tab('show');\n\t}\n\n    // remember the hash in the URL without jumping\n    $('a[data-toggle=\"tab\"]').on('shown.bs.tab', function(e) {\n       if(history.pushState) {\n            history.pushState(null, null, '#'+$(e.target).attr('href').substr(1));\n       } else {\n            location.hash = '#'+$(e.target).attr('href').substr(1);\n       }\n    });\n\n    function htmlEntities(str) {\n    \treturn String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n\t}\n\n    $(\".embedMap\").on(\"click\", function(e) {\n    \te.preventDefault();\n    \tembedPath = window.location.protocol + \"//\" + window.location.hostname + basePath + \"search/map/\" + getCurrentSearchId();\n\n    \tiFrameContent = '<iframe width=\"640\" height=\"480\" src=\"' +embedPath + '\" frameborder=\"0\" allowfullscreen></iframe>';\n\n    \tembedContent = '<input size=50 class=\"embedControl\" value=\"' + htmlEntities(iFrameContent) + '\"\">';\n\n    \tbootbox.dialog(\n\t\t{\n\t\t\ttitle: \"Embed this map\",\n\t\t\tmessage: \"Use the HTML below to embed this map in another page: <br>\" + embedContent,\n\t\t\tbuttons: {\n\t\t\t\tsuccess: {\n\t\t\t\t\tlabel: \"OK\",\n\t\t\t\t\tclassName: \"btn-primary\"\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n    });\n\n    $(\".embedTimeline\").on(\"click\", function(e) {\n    \te.preventDefault();\n    \tembedPath = window.location.protocol + \"//\" + window.location.hostname + basePath + \"search/timeline/\" + getCurrentSearchId();\n\n    \tiFrameContent = '<iframe width=\"640\" height=\"480\" src=\"' +embedPath + '\" frameborder=\"0\" allowfullscreen></iframe>';\n\n    \tembedContent = '<input size=50 class=\"embedControl\" value=\"' + htmlEntities(iFrameContent) + '\"\">';\n\n    \tbootbox.dialog(\n\t\t{\n\t\t\ttitle: \"Embed this timeline\",\n\t\t\tmessage: \"Use the HTML below to embed this timeline in another page: <br>\" + embedContent,\n\t\t\tbuttons: {\n\t\t\t\tsuccess: {\n\t\t\t\t\tlabel: \"OK\",\n\t\t\t\t\tclassName: \"btn-primary\"\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n    });\n\n});\n\n\nfunction getCurrentSearchId() {\n\tcurrentURL = window.location.href.replace(window.location.hash,\"\");\n\tcurrentHash = window.location.hash.replace(\"#\", \"\");\n\tif(currentHash.length == 36) {\n\t\t// this is an old hash, we need to keep that\n\t\tsearchId = currentHash;\n\t\twindow.history.pushState({}, \"Search Results\", currentURL + \"/s/\" +searchId);\n\t}\n\telse {\n\t\tsearchId = currentURL.substr(currentURL.lastIndexOf('/') + 1);\n\t}\n\treturn searchId;\n}\n\n\nfunction parseSearch() {\n\t\n\tsearchId = getCurrentSearchId();\n\n\tif(searchId && !disableHashChange) {\n\t\t$(\"#results\").empty();\n\t\t$(\"#listResults\").empty();\n\n\n\n\t\t// you can set a global var \"loadAll\" to cause us to load all available results at pageload.\n\t\t// leaving this here just to make it explicit\n\t\tvar localLoadAll = false;\n\t\tif(typeof loadAll !== 'undefined' && loadAll == true) {\n\t\t\tlocalLoadAll = true;\n\t\t}\n\n\t\tdoSearch(searchId, 0, localLoadAll);\n\t}\n\n}\n\nfunction loadCollectionHeader() {\n\tif($(\"input[name='collection[]']\").length == 1 && $(\"input[name='collection[]']\").val() !== \"0\" && $(\"#searchText\").val() == \"\") {\n\t\t$.get(basePath + \"collections/collectionHeader/\" + $(\"input[name='collection[]']\").val(), function(data) {\n\t\t\t$(\".collectonHeader\").html(data);\n\t\t});\n\t}\n\n}\n\n// ignore results is used to force the server to pre-cache the next set of results\nfunction doSearch(searchId, pageNumber, loadAll, ignoreResults) {\n\n\n\tif(!ignoreResults) {\n\t\tpreviousEventComplete = false;\n\t\tcurrentPageNumber = pageNumber;\n\t}\n\n\n\tloadAll = (loadAll)?\"true\":\"false\";\n\n\t$.get(basePath + \"search/searchResults/\" + searchId + \"/\" + pageNumber + \"/\" + loadAll, function(data) {\n\t\t\tif(ignoreResults) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar oldMatches = [];\n\t\t\tvar oldResults = [];\n\t\t\ttry{\n\t\t\t\tif(cachedResults) {\n\t\t\t\t\toldMatches = cachedResults.matches;\n\t\t\t\t\toldResults = cachedResults.searchResults;\n\t\t\t\t}\n\t\t\t\tcachedResults = $.parseJSON(data);\n\n\t\t\t}\n\t\t\tcatch(e){\n\t\t\t\talert(e + \" \" + data);\n\t\t\t}\n\n\t\t\tif(cachedResults.success === true) {\n\n\t\t\t\tif(cachedResults.totalResults == 1 ) {\n\t\t\t\t\t// special case - one match, let's just load it\n\t\t\t\t\tvar objectId = cachedResults.matches[0].objectId;\n\t\t\t\t\t$.cookie('lastSearch', searchId, { path: \"/\"});\n\n\t\t\t\t\t// window.location.hash = \"\";\n\t\t\t\t\twindow.location.pathname = basePath + \"/asset/viewAsset/\" + objectId;\n\t\t\t\t}\n\t\t\t\tcachedResults.totalLoadedCount = cachedResults.matches.length + oldMatches.length;\n\t\t\t\tprocessSearchResults(cachedResults);\n\t\t\t\tnewArray = $.merge(cachedResults.matches, oldMatches);\n\t\t\t\tcachedResults.searchResults = $.merge(cachedResults.searchResults, oldResults);\n\t\t\t\tcachedResults.matches = newArray;\n\n\t\t\t\t// we want these to use the full stored set, not just the curret batch, so we run them after merging.\n\t\t\t\tif($('a[href=\"#map\"]').parent().hasClass(\"active\")) {\n\t\t\t\t\tprepMap();\n\t\t\t\t}\n\n\t\t\t\tif($('a[href=\"#timeline\"]').parent().hasClass(\"active\")) {\n\t\t\t\t\tcachedDates = null;\n\t\t\t\t\tprepTimeline();\n\t\t\t\t}\n\n\t\t\t}\n\t\t});\n}\n\nfunction processSearchResults(cachedResults) {\n\tpopulateSearchFields(cachedResults.searchEntry);\n\tloadCollectionHeader();\n\tpopulateSearchResults(cachedResults);\n\tif(cachedResults.matches.length === 0) {\n\t\tdataAvailable = false;\n\t}\n\tpreviousEventComplete = true;\n\t\n}\n\n$(document).on(\"click\", \".assetLink\", function(e) {\n\t$.cookie('lastSearch', searchId, { path: \"/\"});\n\n});\n\n$(document).on(\"click\", \".useSuggest\", function() {\n\n\t$(\".searchText\").val($(this).text());\n\t$(\".searchForm\").submit();\n\n});\n\n$(document).on(\"change\", \".sortBy\", function() {\n\t$(\".hiddenSort\").val($(this).val());\n\tperformSearchForButtonPress($(\".searchForm\").first());\n});\n\n\n$(document).on(\"click\", \"#loadAllResults\", function(e) {\n\te.preventDefault();\n\tif(dataAvailable) {\n\t\tdoSearch(searchId, currentPageNumber+1, true);\n\t\tdataAvailable = false;\n\t\t$(\"#loadAllResults\").hide();\n\t\t$(\".paginationBlock\").hide();\n\t\tresultsAvailable = false;\n\t}\n\n\n});\n\nfunction getSuggestions(searchTerm) {\n\n\tvar localSearch = searchTerm;\n\t$.post(basePath + \"search/getSuggestion\", {\"searchTerm\":searchTerm}, function(data, textStatus) {\n\t\tvar resultArray = $.parseJSON(data);\n\t\tif(resultArray.length === 0 ) {\n\t\t\treturn;\n\t\t}\n\t\t$.each(resultArray, function(index, value) {\n\t\t\tvar reg = new RegExp(index, 'ig');\n\t\t\tlocalSearch = localSearch.replace(reg, value);\n\t\t});\n\n\t\tvar search = $(\"<a>\").addClass(\"useSuggest\").append(localSearch);\n\t\tvar italics = $(\"<i>\").append(search);\n\t\tvar insert = $(\"<div>\").addClass('col-sm-12 suggestionText').append(\"Did you mean: \").append(italics).append(\" ?\");\n\t\t$(\".suggest\").empty();\n\t\t$(\".suggest\").append(insert);\n\n\t});\n\n\n}\n\nfunction populateSearchFields(searchEntry) {\n\t$(\".collectionSelector\").prop('checked', false);\n\t$(\"#showHidden\").prop('checked',false);\n\t$(\".advancedOption\").val();\n\n\tif(searchEntry.searchText.length > 0) {\n\t\tgetSuggestions(searchEntry.searchText);\n\t}\n\n\t$(\".sortBy\").val(searchEntry.sort);\n\n\t$.each(searchEntry, function(index, value) {\n\t\tif(Array.isArray(value)) {\n\t\t\tvar targetField = $(\"#\" + index);\n\t\t\t$.each(value, function(internalIndex, internalValue) {\n\t\t\t\tvar newField = targetField.clone();\n\t\t\t\t$(newField).val(internalValue);\n\t\t\t\t$(newField).appendTo($(\"#\" + index).parent());\n\t\t\t});\n\t\t\t$(targetField).remove();\n\t\t}\n\t\telse {\n\t\t\t$(\"#\" + index).val(value);\t\n\t\t}\n\t\n\t});\n\n\tif($(\"#collection\").val() > 0) {\n\t\ttargetText = $('[data-collection-id=\"' + $(\"#collection\").val() + '\"]').text();\n\t    $(\"#search_concept\").text(targetText);\n\t }\n\n}\n\n\n\nfunction populateSearchResults(searchObject) {\n\t// target template is defined by the hosting include - search page versus drawers, etc\n\tvar source   = $(targetTemplate).html();\n\tvar template = Handlebars.compile(source);\n\tvar listSource   = $(listTemplate).html();\n\tvar listTemplateCompiled = Handlebars.compile(listSource);\n\n\t$.each(searchObject.matches, function(index, value) {\n\t\tvalue.base_url = basePath;\n\t\tvalue.searchObject = searchObject;\n\t\tvar html    = template(value);\n\t\tvar listHTML    = listTemplateCompiled(value);\n\t\t$(\"#results\").append(html);\n\t\t$(\"#listResults\").append(listHTML);\n\t});\n\n\ttotalResults = searchObject.totalResults;\n\t$(\".resultsData\").html(\"<p>Total Results: \"+ searchObject.totalResults + \"</p>\");\n\n\tif(dataAvailable && searchObject.matches.length < searchObject.totalResults && searchObject.totalResults < 1000) {\n\t\t$(\".resultsData p\").append(\" <a href='' id='loadAllResults'>[Load All]</a>\");\n\t}\n\n\n\tif(searchObject.totalResults > searchObject.totalLoadedCount) {\n\t\t$(\".paginationBlock\").show();\n\t\tresultsAvailable = true;\n\t}\n\telse {\n\t\t$(\".paginationBlock\").hide();\n\t\tresultsAvailable = false;\n\t}\n\n\t\n\tif(searchObject.matches.length == 0) {\n\t\t$(\".paginationBlock\").hide();\n\t\tresultsAvailable = false;\n\t}\n\n\tif($('a[href=\"#map\"]').parent().hasClass(\"active\")) {\n\t\tprepMap();\n\t}\n\n\tif($('a[href=\"#timeline\"]').parent().hasClass(\"active\")) {\n\t\tprepTimeline();\n\t}\n\n\t// have the server precache the new results\n\tif(searchId !== null) {\n\t\tdoSearch(searchId, currentPageNumber+1, false, true);\n\t}\n\n\tevent = new Event(\"searchUpdated\");\n  \tdocument.dispatchEvent(event);\n\n}\n\n\nfunction prepMap() {\n\n\tif(cachedResults === \"\") {\n\t\treturn;\n\t}\n\tif(markers) {\n\t\tmarkers.clearLayers();\t\n\t}\n\t\n\tif(!map) {\n\t\tloadMap(\"mapPane\");\n\t}\n\tmarkers = L.markerClusterGroup({ showCoverageOnHover: false});\n\n\t$.each(cachedResults.matches, function(index, value) {\n\t\tif(value.locations) {\n\t\t\t$.each(value.locations, function (index2, value2) {\n\t\t\t\t$.each(value2.entries, function(index3, value3) {\n\n\t\t\t\t\tloc = value3.loc.coordinates;\n\t\t\t\t\tvalue.base_url = basePath;\n\t\t\t\t\tvar html    = MarkerTemplate(value);\n\n\t\t\t\t\tif(loc[1] === 0 && loc[0] === 0) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\tlocalMarker = L.marker([loc[1],loc[0]]);  \n\t\t\t\t\tlocalMarker.bindPopup(html);\n  \t\t\t\t\tmarkers.addLayer(localMarker);\n\t\t\t\t\t\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t});\n\n\tmap.addLayer(markers);\n\tmap.fitBounds(markers.getBounds().pad(0.5)); \n\n}\n\n\nfunction prepTimeline() {\n\tif(cachedResults === \"\") {\n\t\treturn;\n\t}\n\n\tvar compiledDate = {};\n\tvar geoTime = false;\n\n\tcompiledDate.events = new Array();\n\tfor (var match of cachedResults.matches) {\n\n\t\t// if we don't have a special dates propery, we can ignore this one\n\t\tif(!match.hasOwnProperty(\"dates\")) {\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\tfor(var dates of match.dates) {\n\t\t\tfor(var date of dates.dateAsset) {\n\t\t\t\tstartTime = parseInt(date.start[\"numeric\"], 10);\n\t\t\t\tif(startTime < -6373557595440) {\n\t\t\t\t\tgeoTime = true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\n\n\t\tfor(var dates of match.dates) {\n\t\t\tfor(var date of dates.dateAsset) {\n\t\t\t\tvar newItem = {};\n\t\t\t\tstartTime = parseInt(date.start[\"numeric\"], 10);\n\t\t\t\tnewItem.start_date = {};\n\t\t\t\tif(geoTime) {\n\t\t\t\t\tstartYear = -1 * Math.round(Math.abs((startTime + (1970*31556900)) / 31556900));\n\t\t\t\t\tnewItem.start_date.year = startYear;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tt = new Date(1970,0,1);\n\t\t\t\t\tt.setSeconds(startTime);\n\t\t\t\t\tformattedStart = Date.utc.create(t);\n\t\t\t\t\tnewItem.start_date.display_date = date.start[\"text\"];\n\t\t\t\t\tnewItem.start_date.year = formattedStart.getFullYear();\n\t\t\t\t\tnewItem.start_date.month = formattedStart.getMonth() + 1;\n\t\t\t\t\tnewItem.start_date.day = formattedStart.getDay() + 1;\n\n\t\t\t\t}\n\t\t\t\tif(date.end[\"numeric\"] && date.end[\"numeric\"].toString().length>0) {\n\t\t\t\t\tnewItem.end_date = {};\n\t\t\t\t\tendTime = parseInt(date.end[\"numeric\"], 10);\n\n\t\t\t\t\tif(geoTime) {\n\t\t\t\t\t\tendYear = -1 * Math.round(Math.abs((endTime+ (1970*31556900)) / 31556900));\n\t\t\t\t\t\tnewItem.end_date.year = endYear;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tt = new Date(1970,0,1);\n\t\t\t\t\t\tt.setSeconds(endTime);\n\t\t\t\t\t\tformattedEnd = Date.utc.create(t);\n\t\t\t\t\t\tnewItem.end_date.display_date = date.end[\"text\"];\n\t\t\t\t\t\tnewItem.end_date.year = formattedEnd.getFullYear();\n\t\t\t\t\t\tnewItem.end_date.month = formattedEnd.getMonth() + 1;\n\t\t\t\t\t\tnewItem.end_date.day = formattedEnd.getDay() + 1;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t\tvar html    = TimelineTemplate(match);\n\n\t\t\t\tnewItem.text = {};\n\t\t\t\tnewElement = $(\"<a/>\", {\"href\": basePath + \"asset/viewAsset/\" + match.objectId, \"text\": match.title});\n\t\t\t\tnewItem.text.headline = newElement.prop(\"outerHTML\");\n\t\t\t\tnewItem.text.text = html;\n\n\t\t\t\tif(match.hasOwnProperty(\"primaryHandlerThumbnail2x\")) {\n\t\t\t\t\tnewItem.media = {};\n\t\t\t\t\tnewItem.media.thumb = match.primaryHandlerThumbnail2x;\n\t\t\t\t\tnewItem.media.url = match.primaryHandlerThumbnail2x;\t\n\t\t\t\t}\n\n\t\t\t\t// dedupe our array\n\t\t\t\tvar ignoreItem = false;\n\t\t\t\tfor(var existingDate of compiledDate.events) {\n\t\t\t\t\tif(JSON.stringify(existingDate) == JSON.stringify(newItem)) {\n\t\t\t\t\t\tignoreItem = true;\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif(!ignoreItem) {\n\t\t\t\t\tcompiledDate.events.push(newItem);\t\n\t\t\t\t}\n\t\t\t\t\n\n\t\t\t}\n\t\t}\n\n\n\n\t}\n\n\tif(geoTime) {\n\t\tcompiledDate.scale = \"cosmological\"\n\t\tinjectStyles(\".tl-timeaxis-minor { display: none; }\");\n\t}\n\telse {\n\t\t$(\"#hackyGeoStyle\").remove();\n\t}\n\n\tvar timeline = new TL.Timeline('timelinePane', compiledDate, {\n        timenav_position: \"bottom\",\n        timenav_height_percentage: \"70\"\n\t});\n\n\n}\n\nfunction injectStyles(rule) {\n  var div = $(\"<div />\", {\n    id: \"hackyGeoStyle\",\n    html: '&shy;<style>' + rule + '</style>'\n  }).appendTo(\"body\");    \n}\n\n\n$(document).on(\"click\", \".embedControl\", function() {\n\t$(this).select();\n});\n\n\n$(document).on(\"click\", \".exportCSV\", function(e) {\n\te.preventDefault();\n\ttarget = e.target.href;\n\twindow.location = target + \"#\" + searchId;\n\n});\n"]}