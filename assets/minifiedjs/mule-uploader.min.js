function mule_upload(e){function t(e){var t=this;e=e||{},t.input=e.file_input,t.file=e.file,e.chunk_size=e.chunk_size||6*o,e.max_size=e.max_size||50*(1<<30),e.num_workers=e.num_workers||4,e.key=e.key||"the_key",e.bucket=e.bucket,e.host=e.host||"http://"+e.bucket+".s3.amazonaws.com",e.access_key=e.access_key,e.content_type=e.content_type||"application/octet-stream",e.acl=e.acl||"private",e.on_progress=e.on_progress||function(){},e.on_chunk_progress=e.on_chunk_progress||function(){},e.on_select=e.on_select||function(){},e.on_error=e.on_error||function(){},e.on_complete=e.on_complete||function(){},e.on_init=e.on_init||function(){},e.on_start=e.on_start||function(){},e.on_chunk_uploaded=e.on_chunk_uploaded||function(){},e.extra_params=e.extra_params||{},e.ajax_base=e.ajax_base||"/uploadBackend/upload/",e.accepted_extensions=e.accepted_extensions||"",t.settings=e,t.set_state("waiting"),t.input&&(t.input.onchange=function(e,n){if("waiting"!=t.get_state())return!1;var s=t.input.files[0];t.upload_file(s,n)}),setTimeout(function(){t.settings.on_init.apply(t)},100)}var n=!0,s=function(){};n&&console&&console.log&&(s=function(){for(var e=["[MuleUploader]"],t=0;t<arguments.length;t++)e.push(arguments[t]);return console.log.apply(console,e)});var i=function(e){e.headers=e.headers||{},e.method=e.method||"GET";var t=new XMLHttpRequest;e.load_callback&&"function"==typeof e.load_callback&&t.addEventListener("load",e.load_callback,!0),e.error_callback&&"function"==typeof e.error_callback&&t.addEventListener("error",e.error_callback,!0),e.state_change_callback&&"function"==typeof e.state_change_callback&&t.addEventListener("readystatechange",e.state_change_callback),e.progress_callback&&"function"==typeof e.progress_callback&&t.upload.addEventListener("progress",e.progress_callback),e.timeout_callback&&"function"==typeof e.timeout_callback&&t.addEventListener("timeout",timeout_callback);var n=e.url;if(e.extra_params)for(param_name in e.extra_params)n+=-1!==n.indexOf("?")?"&":"?",n+=encodeURIComponent(param_name)+"=",n+=encodeURIComponent(e.extra_params[param_name]);t.open(e.method,n);for(var s in e.headers)t.setRequestHeader(s,e.headers[s]);return e.body?t.send(e.body):t.send(),t},a=1024,o=1024*a,r=1024*o;if(File.prototype.slice=File.prototype.webkitSlice||File.prototype.mozSlice||File.prototype.slice,!(window.File&&window.FileList&&window.Blob))return-1;if(-1!==navigator.userAgent.indexOf("Firefox"))try{new Blob(["something"])}catch(l){return-1}return s("OK"),t.prototype.upload_file=function(t,n){var s=this;if("waiting"!=s.get_state())return!1;if(t&&(s.file=t),!s.file)return!1;if(s.file.lastModifiedDate=s.file.lastModifiedDate||new Date(0),s.file.size>s.settings.max_size)return void alert("The maximum allowed file size is "+s.settings.max_size/r+"GB. Please select another file.");if(s.settings.accepted_extensions){var a=t.name.split(".").pop();extensions_array=s.settings.accepted_extensions.split(",");for(var o=!1,l=0;l<extensions_array.length;l++)if(a==extensions_array[l]){o=!0;break}if(!o)return void alert("This file format is not accepted. Please use a file with an extension like '"+s.settings.accepted_extensions)}s.settings.on_select.call(s,t),s.get_init_signature(function(a,o){if(s.upload_id)n?s.get_all_signatures(function(){s.load_file(t)}):s.list_parts(function(){s.get_all_signatures(function(){s.load_file(t)})},function(){return s.upload_id=null,this._loaded_chunks=null,s._progress=null,s._total_progress=null,s._loaded_chunks=null,s._uploading_chunks=null,s._chunks=null,s.upload_file(t,!0)});else{s.upload_id=null,this._loaded_chunks=null,s._progress=null,s._total_progress=null,s._loaded_chunks=null,s._uploading_chunks=null,s._chunks=null;var r="AWS "+e.access_key+":"+a,l=function(e){var n=e.target.responseXML;s.upload_id=n.getElementsByTagName("UploadId")[0].textContent,s.get_all_signatures(function(){s.load_file(t)})};i({method:"POST",url:e.host+"/"+e.key+"?uploads",load_callback:l,error_callback:l,headers:{"x-amz-date":o,"x-amz-acl":e.acl,Authorization:r,"Content-Type":s.settings.content_type,"Content-Disposition":"attachment; filename="+s.file.name}})}},n)},t.prototype.load_file=function(e){var t=this;if("waiting"==t.get_state()){t._start_fired||(t.settings.on_start.call(t,t.file),t.settings.on_progress.call(t,0,t.file.size),t._start_fired=!0),t.set_state("processing"),t.settings.on_progress.call(t,t.get_total_progress(),t.file.size);var n=t.get_next_chunk();-1!=n?t.upload_chunk(n):t.upload_finished()&&(s("All done; finish upload"),t.finish_upload());for(var i=0;i<t.settings.num_workers-1&&(n=t.get_next_chunk(),-1!==n);i++)t.upload_chunk(n)}},t.prototype.upload_chunk=function(e){var t=this;return"processing"!=t.get_state()?void s("NOT processing; return"):t.get_chunk_uploading(e)?(s("Already Uploading"),void setTimeout(function(){var e=t.get_next_chunk();-1!==e&&t.get_all_signatures(function(){t.upload_chunk(t.get_next_chunk())})},1e3)):(t.set_chunk_uploading(e),s("Uploading Chunk: "+e),void t.get_chunk_signature(e,function(n,a){var o=t.settings.chunk_size,r=e*o,l=Math.min(r+o,t.file.size),_=new Date;if(t._intervals=t._intervals||{},t.is_chunk_loaded(e)){var u=t.get_next_chunk();-1!=u?t.upload_chunk(u):t.upload_finished()&&(s("No next chunk; finish upload"),t.finish_upload())}var c=function(n){if(n.target.readyState!=this.DONE||"processing"!=t.get_state())return void s(n);if(n.target.status/100!=2)return g();s("Chunk uploaded: "+e),t.notify_chunk_uploaded(e),t.settings.on_chunk_uploaded.call(t,e),clearInterval(t._intervals[e]),t.set_progress(e,t.get_chunk_size(e)),t.set_chunk_finished(e),t.set_chunk_uploading(e,!1);var i=t.get_next_chunk();if(-1!=i)t.upload_chunk(i);else if(t.upload_finished())s("Done"),t.finish_upload();else var a=setInterval(function(){var e=t.get_next_chunk();-1!=e?(clearInterval(a),t.upload_chunk(e)):t.upload_finished()&&(clearInterval(a),t.finish_upload())},1e3)},p=function(n){t.set_progress(e,n.loaded),t.settings.on_progress.call(t,t.get_total_progress(),t.file.size),_=new Date},d=!1,g=function(){var n=arguments,i=this;t.check_already_uploaded(function(){t.set_state("finished"),t.notify_upload_finished(),t.settings.on_progress.call(t,t.file.size,t.file.size),t.settings.on_complete.call(t)},function(){if(s("Error: "),s(n),!d){d=!0,t.set_chunk_uploading(e,!1),t.set_chunk_finished(e,!1),t.set_progress(e,0),s("Abort");try{i.abort()}catch(a){s(a)}s("Retry chunk: "+e),clearInterval(t._intervals[e]),setTimeout(function(){if("processing"==t.get_state()){var n=t.get_next_chunk(e);-1!==n&&t.get_all_signatures(function(){t.upload_chunk(t.get_next_chunk())})}},1e3)}})},h="/"+t.settings.key;h+="?partNumber="+(e+1)+"&uploadId="+t.upload_id;var f="AWS "+t.settings.access_key+":"+n,k=t.file.slice(r,l),m=i({method:"PUT",url:t.settings.host+h,progress_callback:p,state_change_callback:c,error_handler:g,timeout_handler:g,headers:{"x-amz-date":a,Authorization:f,"Content-Type":t.settings.content_type,"Content-Disposition":"attachment; filename="+t.file.name},body:k});window.xhrs=window.xhrs||[],window.xhrs.push(m),t._chunk_xhr=t._chunk_xhr||[],t._chunk_xhr.push(m),t._intervals[e]=setInterval(function(){_&&new Date-_>15e3&&(s("Chunk Failed; retry"),clearInterval(t._intervals[e]),"processing"==t.get_state()&&(m.abort(),g.call(m)))},4e3)}))},t.prototype.finish_upload=function(){var e=this;"processing"==e.get_state()&&(e.set_state("finishing"),e.settings.on_progress.call(e,e.file.size,e.file.size),this.get_end_signature(function(t,n){var a="/"+e.settings.key+"?uploadId="+e.upload_id,o="AWS "+e.settings.access_key+":"+t,r=function(t){t.target.status/100==2?(s("Finished file."),e.set_state("finished"),e.settings.on_progress.call(e,e.file.size,e.file.size),e.notify_upload_finished(),e.settings.on_complete.call(e)):400==t.target.status&&-1!==t.target.responseText.indexOf("EntityTooSmall")?e.list_parts(function(t){e.update_chunks(t);var n=e.get_next_chunk();e.set_state("processing"),e.upload_chunk(n)}):404==t.target.status?e.cancel(function(){e.upload_file(e.file,!0)}):e.check_already_uploaded(function(){r({target:{status:200}})},function(){r({target:{status:404}})})};e.list_parts(function(t){var s=Math.ceil(e.file.size/e.settings.chunk_size);if(t.length!=s){e.update_chunks(t);var l=e.get_next_chunk();return e.set_state("processing"),void e.upload_chunk(l)}for(var _="<CompleteMultipartUpload>",u=0;u<t.length;u++)_+="<Part>",_+="<PartNumber>"+t[u][0]+"</PartNumber>",_+="<ETag>"+t[u][1]+"</ETag>",_+="</Part>";_+="</CompleteMultipartUpload>",-1!==navigator.userAgent.indexOf("Firefox")&&(_=new Blob([_])),i({url:e.settings.host+a,method:"POST",load_callback:r,error_callback:r,headers:{"x-amz-date":n,Authorization:o,"Content-Type":e.settings.content_type,"Content-Disposition":"attachment; filename="+e.file.name},body:_})})}))},t.prototype.list_parts=function(e,t,n){var s=this;s.get_list_signature(function(a,o){var r=function(n){if(n.target.status/100!=2&&t)return t(n);for(var i=n.target.responseXML,a=[],o=i.getElementsByTagName("Part"),r=Math.ceil(s.file.size/s.settings.chunk_size),l=0;l<o.length;l++){var _=parseInt(o[l].getElementsByTagName("PartNumber")[0].textContent,10),u=o[l].getElementsByTagName("ETag")[0].textContent,c=parseInt(o[l].getElementsByTagName("Size")[0].textContent,10);(_==r||c==s.settings.chunk_size)&&(_!=r||c==s.file.size%s.settings.chunk_size)&&a.push([_,u,c])}var p=i.getElementsByTagName("IsTruncated")[0].textContent;if("true"===p){var d=i.getElementsByTagName("NextPartNumberMarker")[0].textContent;s.list_parts(function(t){e(a.concat(t))},t,d)}else e(a)},l="/"+s.settings.key+"?uploadId="+s.upload_id;n&&(l=l+"&part-number-marker="+n);var _="AWS "+s.settings.access_key+":"+a;i({method:"GET",load_callback:r,url:s.settings.host+l,headers:{"x-amz-date":o,Authorization:_}})})},t.prototype.get_end_signature=function(e){var t=this,n=function(t){var n=JSON.parse(t.target.responseText);e(n.signature,n.date)},s=function(){setTimeout(function(){t.get_end_signature(e)},1e3)},a=t.settings.ajax_base+"/get_end_signature/?upload_id="+escape(this.upload_id)+"&mime_type="+encodeURIComponent(t.settings.content_type)+"&key="+this.settings.key+"&collectionId="+t.settings.collectionId;i({url:a,extra_params:t.settings.extra_params,load_callback:n,error_callback:s})},t.prototype.get_list_signature=function(e,t){var n=this;t=t||function(){};var s=function(t){var n=JSON.parse(t.target.responseText);e(n.signature,n.date)},a=function(t){setTimeout(function(){n.get_list_signature(e)},1e3)},o=n.settings.ajax_base+"/get_list_signature/?upload_id="+escape(this.upload_id)+"&mime_type="+encodeURIComponent(n.settings.content_type)+"&key="+this.settings.key+"&collectionId="+n.settings.collectionId;i({url:o,extra_params:n.settings.extra_params,load_callback:s,error_callback:a})},t.prototype.get_chunk_signature=function(e,t){var n=this,s=function(e){var n=JSON.parse(e.target.responseText);t(n.signature,n.date)},a=function(s){setTimeout(function(){n.get_chunk_signature(e,t)},1e3)},o=n.settings.ajax_base+"/get_chunk_signature/?chunk="+(e+1)+"&upload_id="+escape(this.upload_id)+"&mime_type="+encodeURIComponent(n.settings.content_type)+"&collectionId="+n.settings.collectionId+"&key="+this.settings.key;i({url:o,extra_params:n.settings.extra_params,load_callback:s,error_callback:a})},t.prototype.get_init_signature=function(e,t){var n=this,a=Math.ceil(n.file.size/n.settings.chunk_size),o=function(t){var i=JSON.parse(t.target.responseText);if(i.chunks){if(i.chunks.length==a)return n.get_init_signature(e,!0);s("Resume upload...");var o=i.chunks;n._progress=n._progress||[];for(var r=0;r<o.length;r++){s("Chunk already uploaded: "+(o[r]-1));var l=n.get_chunk_size(o[r]);n._progress[o[r]]=l,n._total_progress+=l,n.add_loaded_chunk(o[r]-1),n.set_chunk_finished(o[r]-1),n.bytes_started=(n.bytes_started||0)+n.settings.chunk_size}n.upload_id=i.upload_id,n.settings.key=i.key}e(i.signature,i.date)},r=function(){s("Failed; trying again"),setTimeout(function(){n.get_init_signature(e)},1e3)},l=n.settings.ajax_base+"/get_init_signature/?key="+n.settings.key+"&mime_type="+encodeURIComponent(n.settings.content_type)+"&filename="+escape(n.file.name)+"&filesize="+n.file.size+"&upload_id="+n.upload_id+"&collectionId="+n.settings.collectionId+"&last_modified="+n.file.lastModifiedDate.valueOf()+"&collectionId="+n.settings.collectionId+(t?"&force=true":"");i({url:l,extra_params:n.settings.extra_params,load_callback:o,error_callback:r})},t.prototype.get_all_signatures=function(e){var t=this,n=t.settings.key,s=Math.ceil(t.file.size/t.settings.chunk_size),a=t.upload_id,o=function(n){var s=JSON.parse(n.target.responseText);t._chunk_signatures=s.chunk_signatures,t._list_signature=s.list_signature,t._end_signature=s.end_signature,t._delete_signature=s.delete_signature,e()},r=function(){setTimeout(function(){t.get_all_signatures(e)},1e3)},l=t.settings.ajax_base+"/get_all_signatures/?key="+n+"&mime_type="+encodeURIComponent(t.settings.content_type)+"&num_chunks="+s+"&upload_id="+a+"&filename="+escape(t.file.name)+"&filesize="+t.file.size+"&collectionId="+t.settings.collectionId+"&last_modified="+t.file.lastModifiedDate.valueOf();i({url:l,extra_params:t.settings.extra_params,load_callback:o,error_callback:r})},t.prototype.notify_chunk_uploaded=function(e){var t=this;if("processing"==t.get_state()){var n=t.settings.key,s=t.upload_id,a=t.settings.ajax_base+"/chunk_loaded/?key="+n+"&chunk="+(e+1)+"&mime_type="+encodeURIComponent(t.settings.content_type)+"&upload_id="+s+"&filename="+escape(t.file.name)+"&collectionId="+t.settings.collectionId+"&filesize="+t.file.size+"&last_modified="+t.file.lastModifiedDate.valueOf();i({url:a,extra_params:t.settings.extra_params})}},t.prototype.notify_upload_finished=function(e){var t=this;if("finished"==t.get_state()){var n=t.settings.key,s=t.upload_id,a=t.settings.ajax_base+"/upload_finished/?key="+n+"&mime_type="+encodeURIComponent(t.settings.content_type)+"&upload_id="+s+"&filename="+escape(t.file.name)+"&collectionId="+t.settings.collectionId+"&filesize="+t.file.size+"&last_modified="+t.file.lastModifiedDate.valueOf();i({url:a,extra_params:t.settings.extra_params})}},t.prototype.check_already_uploaded=function(e,t){var n=this,a="/"+n.settings.key,o=function(n){n.target.status/100==2?(s("Already Uploaded"),e()):(s("Error!"),t())};t||"function"==typeof t||(t=function(){setTimeout(function(){return n.check_already_uploaded(e,t)},2500)}),i({url:n.settings.host+a,method:"HEAD",load_callback:o,error_callback:t})},t.prototype.cancel=function(e){for(var t=this,n=0;n<t._chunk_xhr.length;n++)s("Abort chunk: "+t._chunk_xhr[n]),t._chunk_xhr[n].abort();t._intervals=t._intervals||{};for(var i in t._intervals)clearInterval(t._intervals[i]);e=e||function(){},t.set_state("canceled"),t._chunk_xhr=t._chunk_xhr||[],t.settings.on_progress.call(t,0,0),t._chunk_xhr=null,t._chunks=null,t._uploading_chunks=null,t._loaded_chunks=null,t._start_fired=!1,t.upload_id=null,t._progress=null,t._chunk_signatures=null,t._list_signature=null,t._end_signature=null,t._delete_signature=null,t.set_state("waiting"),e()},t.prototype.update_chunks=function(e){var t=this,n=[],i=Math.ceil(t.file.size/t.settings.chunk_size);t._init_chunks(!0),t._uploading_chunks=[],t._loaded_chunks=[];for(var a=0;a<e.length;a++){var o=parseInt(e[a][0],10);t.add_loaded_chunk(o-1),t.set_chunk_finished(o-1),n.push(o-1)}for(var a=0;i>a;a++)-1===n.indexOf(a)&&(s("Chunk not uploaded: ",a),t.set_progress(a,0))},t.prototype.is_selected=function(){return!!this.file},t.prototype.get_state=function(){return this._state},t.prototype.set_state=function(e){return this._state=e},t.prototype.set_progress=function(e,t){Math.ceil(this.file.size/this.settings.chunk_size);this.log_status(),this._progress=this._progress||{},this._total_progress=(this._total_progress||0)+t-(this._progress[e]||0),this._progress[e]=t,this.settings.on_chunk_progress.call(this,e,t,this.get_chunk_size(e))},t.prototype.get_total_progress=function(){return this._total_progress||0},t.prototype.is_chunk_loaded=function(e){return this._loaded_chunks=this._loaded_chunks||[],-1!==this._loaded_chunks.indexOf(e)},t.prototype.add_loaded_chunk=function(e){this._loaded_chunks=this._loaded_chunks||[],this._loaded_chunks.push(e),this.set_progress(e,this.get_chunk_size(e))},t.prototype.get_chunk_uploading=function(e){return this._uploading_chunks=this._uploading_chunks||[],-1!==this._uploading_chunks.indexOf(e)},t.prototype.set_chunk_uploading=function(e,t){if("undefined"==typeof t&&(t=!0),this._uploading_chunks=this._uploading_chunks||[],t)this._uploading_chunks.push(e);else{for(var n=[],s=0;s<this._uploading_chunks.length;s++)this._uploading_chunks[s]!=e&&n.push(this._uploading_chunks[s]);this._uploading_chunks=n}},t.prototype._init_chunks=function(e){var t=this;if(!t._chunks||e){t._chunks=[];for(var n=Math.ceil(t.file.size/t.settings.chunk_size),s=0;n>s;s++)t._chunks.push(!1)}},t.prototype.set_chunk_finished=function(e,t){"undefined"==typeof t&&(t=!0);var n=this;n._init_chunks(),n._chunks[e]=t},t.prototype.get_next_chunk=function(e){var t=this;if(t._init_chunks(),e&&!t._chunks[e]&&!t.get_chunk_uploading(e))return e;for(var n=0;n<t._chunks.length;n++)if(!t._chunks[n]&&!t.get_chunk_uploading(n))return n;return-1},t.prototype.upload_finished=function(){var e=this;e._init_chunks();for(var t=0;t<e._chunks.length;t++)if(!e._chunks[t]||e.get_chunk_uploading(t))return!1;return!0},t.prototype.is_last_chunk=function(e){return Math.ceil(this.file.size/this.settings.chunk_size)==e-1},t.prototype.get_chunk_size=function(e){return this.is_last_chunk(e)?this.file.size%this.settings.chunk_size:this.settings.chunk_size},t.prototype.log_status=function(){},t.prototype.on_chunk_progress=function(e){u.settings.on_chunk_progress=e},t.prototype.on_progress=function(e){u.settings.on_progress=e},t.prototype.on_select=function(e){u.settings.on_select=e},t.prototype.on_error=function(e){u.settings.on_error=e},t.prototype.on_complete=function(e){u.settings.on_complete=e},t.prototype.on_init=function(e){u.settings.on_init=e},t.prototype.on_start=function(e){u.settings.on_start=e},t.prototype.on_chunk_uploaded=function(e){u.settings.on_chunk_uploaded=e},new t(e)}
//# sourceMappingURL=mule-uploader.js.map
