!function(t){var e=e||function(t,e){var n={},s=n.lib={},i=function(){},r=s.Base={extend:function(t){i.prototype=this;var e=new i;return t&&e.mixIn(t),e.hasOwnProperty("init")||(e.init=function(){e.$super.init.apply(this,arguments)}),e.init.prototype=e,e.$super=this,e},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}},a=s.WordArray=r.extend({init:function(t,n){t=this.words=t||[],this.sigBytes=n!=e?n:4*t.length},toString:function(t){return(t||l).stringify(this)},concat:function(t){var e=this.words,n=t.words,s=this.sigBytes;if(t=t.sigBytes,this.clamp(),s%4)for(var i=0;t>i;i++)e[s+i>>>2]|=(n[i>>>2]>>>24-8*(i%4)&255)<<24-8*((s+i)%4);else if(65535<n.length)for(i=0;t>i;i+=4)e[s+i>>>2]=n[i>>>2];else e.push.apply(e,n);return this.sigBytes+=t,this},clamp:function(){var e=this.words,n=this.sigBytes;e[n>>>2]&=4294967295<<32-8*(n%4),e.length=t.ceil(n/4)},clone:function(){var t=r.clone.call(this);return t.words=this.words.slice(0),t},random:function(e){for(var n=[],s=0;e>s;s+=4)n.push(4294967296*t.random()|0);return new a.init(n,e)}}),o=n.enc={},l=o.Hex={stringify:function(t){var e=t.words;t=t.sigBytes;for(var n=[],s=0;t>s;s++){var i=e[s>>>2]>>>24-8*(s%4)&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16))}return n.join("")},parse:function(t){for(var e=t.length,n=[],s=0;e>s;s+=2)n[s>>>3]|=parseInt(t.substr(s,2),16)<<24-4*(s%8);return new a.init(n,e/2)}},c=o.Latin1={stringify:function(t){var e=t.words;t=t.sigBytes;for(var n=[],s=0;t>s;s++)n.push(String.fromCharCode(e[s>>>2]>>>24-8*(s%4)&255));return n.join("")},parse:function(t){for(var e=t.length,n=[],s=0;e>s;s++)n[s>>>2]|=(255&t.charCodeAt(s))<<24-8*(s%4);return new a.init(n,e)}},u=o.Utf8={stringify:function(t){try{return decodeURIComponent(escape(c.stringify(t)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(t){return c.parse(unescape(encodeURIComponent(t)))}},_=s.BufferedBlockAlgorithm=r.extend({reset:function(){this._data=new a.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=u.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(e){var n=this._data,s=n.words,i=n.sigBytes,r=this.blockSize,o=i/(4*r),o=e?t.ceil(o):t.max((0|o)-this._minBufferSize,0);if(e=o*r,i=t.min(4*e,i),e){for(var l=0;e>l;l+=r)this._doProcessBlock(s,l);l=s.splice(0,e),n.sigBytes-=i}return new a.init(l,i)},clone:function(){var t=r.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0});s.Hasher=_.extend({cfg:r.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){_.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(t){return function(e,n){return new t.init(n).finalize(e)}},_createHmacHelper:function(t){return function(e,n){return new h.HMAC.init(t,n).finalize(e)}}});var h=n.algo={};return n}(Math);!function(t){for(var n=e,s=n.lib,i=s.WordArray,r=s.Hasher,s=n.algo,a=[],o=[],l=function(t){return 4294967296*(t-(0|t))|0},c=2,u=0;64>u;){var _;t:{_=c;for(var h=t.sqrt(_),d=2;h>=d;d++)if(!(_%d)){_=!1;break t}_=!0}_&&(8>u&&(a[u]=l(t.pow(c,.5))),o[u]=l(t.pow(c,1/3)),u++),c++}var p=[],s=s.SHA256=r.extend({_doReset:function(){this._hash=new i.init(a.slice(0))},_doProcessBlock:function(t,e){for(var n=this._hash.words,s=n[0],i=n[1],r=n[2],a=n[3],l=n[4],c=n[5],u=n[6],_=n[7],h=0;64>h;h++){if(16>h)p[h]=0|t[e+h];else{var d=p[h-15],g=p[h-2];p[h]=((d<<25|d>>>7)^(d<<14|d>>>18)^d>>>3)+p[h-7]+((g<<15|g>>>17)^(g<<13|g>>>19)^g>>>10)+p[h-16]}d=_+((l<<26|l>>>6)^(l<<21|l>>>11)^(l<<7|l>>>25))+(l&c^~l&u)+o[h]+p[h],g=((s<<30|s>>>2)^(s<<19|s>>>13)^(s<<10|s>>>22))+(s&i^s&r^i&r),_=u,u=c,c=l,l=a+d|0,a=r,r=i,i=s,s=d+g|0}n[0]=n[0]+s|0,n[1]=n[1]+i|0,n[2]=n[2]+r|0,n[3]=n[3]+a|0,n[4]=n[4]+l|0,n[5]=n[5]+c|0,n[6]=n[6]+u|0,n[7]=n[7]+_|0},_doFinalize:function(){var e=this._data,n=e.words,s=8*this._nDataBytes,i=8*e.sigBytes;return n[i>>>5]|=128<<24-i%32,n[(i+64>>>9<<4)+14]=t.floor(s/4294967296),n[(i+64>>>9<<4)+15]=s,e.sigBytes=4*n.length,this._process(),this._hash},clone:function(){var t=r.clone.call(this);return t._hash=this._hash.clone(),t}});n.SHA256=r._createHelper(s),n.HmacSHA256=r._createHmacHelper(s)}(Math),function(t){for(var n=e,s=n.lib,i=s.WordArray,r=s.Hasher,s=n.algo,a=[],o=[],l=function(t){return 4294967296*(t-(0|t))|0},c=2,u=0;64>u;){var _;t:{_=c;for(var h=t.sqrt(_),d=2;h>=d;d++)if(!(_%d)){_=!1;break t}_=!0}_&&(8>u&&(a[u]=l(t.pow(c,.5))),o[u]=l(t.pow(c,1/3)),u++),c++}var p=[],s=s.SHA256=r.extend({_doReset:function(){this._hash=new i.init(a.slice(0))},_doProcessBlock:function(t,e){for(var n=this._hash.words,s=n[0],i=n[1],r=n[2],a=n[3],l=n[4],c=n[5],u=n[6],_=n[7],h=0;64>h;h++){if(16>h)p[h]=0|t[e+h];else{var d=p[h-15],g=p[h-2];p[h]=((d<<25|d>>>7)^(d<<14|d>>>18)^d>>>3)+p[h-7]+((g<<15|g>>>17)^(g<<13|g>>>19)^g>>>10)+p[h-16]}d=_+((l<<26|l>>>6)^(l<<21|l>>>11)^(l<<7|l>>>25))+(l&c^~l&u)+o[h]+p[h],g=((s<<30|s>>>2)^(s<<19|s>>>13)^(s<<10|s>>>22))+(s&i^s&r^i&r),_=u,u=c,c=l,l=a+d|0,a=r,r=i,i=s,s=d+g|0}n[0]=n[0]+s|0,n[1]=n[1]+i|0,n[2]=n[2]+r|0,n[3]=n[3]+a|0,n[4]=n[4]+l|0,n[5]=n[5]+c|0,n[6]=n[6]+u|0,n[7]=n[7]+_|0},_doFinalize:function(){var e=this._data,n=e.words,s=8*this._nDataBytes,i=8*e.sigBytes;return n[i>>>5]|=128<<24-i%32,n[(i+64>>>9<<4)+14]=t.floor(s/4294967296),n[(i+64>>>9<<4)+15]=s,e.sigBytes=4*n.length,this._process(),this._hash},clone:function(){var t=r.clone.call(this);return t._hash=this._hash.clone(),t}});n.SHA256=r._createHelper(s),n.HmacSHA256=r._createHmacHelper(s)}(Math),function(){var t=e,n=t.enc.Utf8;t.algo.HMAC=t.lib.Base.extend({init:function(t,e){t=this._hasher=new t.init,"string"==typeof e&&(e=n.parse(e));var s=t.blockSize,i=4*s;e.sigBytes>i&&(e=t.finalize(e)),e.clamp();for(var r=this._oKey=e.clone(),a=this._iKey=e.clone(),o=r.words,l=a.words,c=0;s>c;c++)o[c]^=1549556828,l[c]^=909522486;r.sigBytes=a.sigBytes=i,this.reset()},reset:function(){var t=this._hasher;t.reset(),t.update(this._iKey)},update:function(t){return this._hasher.update(t),this},finalize:function(t){var e=this._hasher;return t=e.finalize(t),e.reset(),e.finalize(this._oKey.clone().concat(t))}})}(),function(){if(void 0!==typeof ArrayBuffer){var t=e.lib.WordArray,n=t.init;(t.init=function(t){if(t instanceof ArrayBuffer&&(t=new Uint8Array(t)),(t instanceof Int8Array||t instanceof Uint8ClampedArray||t instanceof Int16Array||t instanceof Uint16Array||t instanceof Int32Array||t instanceof Uint32Array||t instanceof Float32Array||t instanceof Float64Array)&&(t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),t instanceof Uint8Array){for(var e=t.byteLength,s=[],i=0;e>i;i++)s[i>>>2]|=t[i]<<24-8*(i%4);n.call(this,s,e)}else n.apply(this,arguments)}).prototype=t}}();var n=function(t){t.headers=t.headers||{},t.method=t.method||"GET";var e=new XMLHttpRequest;t.load_callback&&"function"==typeof t.load_callback&&e.addEventListener("load",t.load_callback,!0),t.error_callback&&"function"==typeof t.error_callback&&e.addEventListener("error",t.error_callback,!0),t.state_change_callback&&"function"==typeof t.state_change_callback&&e.addEventListener("readystatechange",t.state_change_callback),t.progress_callback&&"function"==typeof t.progress_callback&&e.upload.addEventListener("progress",t.progress_callback),t.timeout_callback&&"function"==typeof t.timeout_callback&&e.addEventListener("timeout",t.timeout_callback);var n=t.url;if(t.extra_params)for(var s in t.extra_params)t.extra_params.hasOwnProperty(s)&&(n+=-1!==n.indexOf("?")?"&":"?",n+=encodeURIComponent(s)+"=",n+=encodeURIComponent(t.extra_params[s]));e.open(t.method,n);for(var i in t.headers)t.headers.hasOwnProperty(i)&&e.setRequestHeader(i,t.headers[i]);return t.body?e.send(t.body):e.send(),e};t.mule_upload=function(e){function i(t){var e=this;t=t||{},e.input=t.file_input,e.file=t.file,t.chunk_size=t.chunk_size||6*l,t.max_size=t.max_size||5*c,t.num_workers=t.num_workers||4,t.key=t.key||"the_key",t.bucket=t.bucket,t.host=t.host||location.protocol+"//"+t.bucket+".s3.amazonaws.com",t.access_key=t.access_key,t.content_type=t.content_type||"application/octet-stream",t.acl=t.acl||"public-read",t.on_progress=t.on_progress||function(){},t.on_chunk_progress=t.on_chunk_progress||function(){},t.on_select=t.on_select||function(){},t.on_error=t.on_error||function(){},t.on_complete=t.on_complete||function(){},t.on_init=t.on_init||function(){},t.on_start=t.on_start||function(){},t.on_chunk_uploaded=t.on_chunk_uploaded||function(){},t.extra_params=t.extra_params||{},t.ajax_base=t.ajax_base||"/upload-backend",t.accepted_extensions=t.accepted_extensions||"",e.settings=t,e.set_state("waiting"),e.input&&(e.input.onchange=function(t,n){if("waiting"!=e.get_state())return!1;var s=t.target.files[0];return e.upload_file(s,n),!0}),setTimeout(function(){e.settings.on_init.apply(e)},100)}var r=!0,a=function(){};r&&console&&console.log&&(a=function(){for(var t=["[MuleUploader]"],e=0;e<arguments.length;e++)t.push(arguments[e]);return console.log.apply(console,t)});var o=1024,l=1024*o,c=1024*l;if(File.prototype.slice=File.prototype.webkitSlice||File.prototype.mozSlice||File.prototype.slice,!(t.File&&t.FileList&&t.Blob))return a("HTML5 APIs not available."),-1;if(-1!==navigator.userAgent.indexOf("Firefox"))try{new Blob(["something"])}catch(u){return-1}return a("OK"),i.prototype.upload_file=function(t,e){var i=this;if("waiting"!=i.get_state())return!1;if(t&&(i.file=t),!i.file)return!1;if(i.file.lastModifiedDate=i.file.lastModifiedDate||new Date(0),i.file.size>i.settings.max_size)return alert(["The maximum allowed file size is ",i.settings.max_size/c,"GB. Please select another file."].join("")),!1;if(i.settings.accepted_extensions){for(var r=t.name.split(".").pop(),a=i.settings.accepted_extensions.split(","),o=!1,l=0;l<a.length;l++)if(r==a[l]){o=!0;break}if(!o)return alert(["This file format is not accepted. ","Please use a file with an extension like ",i.settings.accepted_extensions].join("")),!1}i.settings.on_select.call(i,t);var u={filename:t.name,filesize:t.size,key:i.settings.key,mime_type:i.settings.content_type,collectionId:i.settings.collectionId,last_modified:t.lastModifiedDate.valueOf()};e&&(u.force=!0),n({url:i.settings.ajax_base+"/signing_key/",extra_params:u,load_callback:function(n){var r=JSON.parse(n.target.responseText);r.date=new Date(r.date+".000Z"),i.auth=r,i.upload_id=r.upload_id,i.chunks=r.chunks,i.settings.key=r.key||i.settings.key,i.settings.backup_key=i.settings.key,i.upload_id?e?i.load_file():s.list(i.auth,i.file,i.settings.key,i.upload_id,i.settings.chunk_size,function(t){for(var e=0;e<t.length;e++){var n=t[e][0]-1;i.set_progress(n,i.get_chunk_size(n)),i.set_chunk_finished(n),i.set_chunk_uploading(n,!1)}i.load_file()},function(){i.upload_id=null,this._loaded_chunks=null,i._progress=null,i._total_progress=null,i._loaded_chunks=null,i._uploading_chunks=null,i._chunks=null,i.settings.key=i.settings.backup_key,i.upload_file(t,!0)}):(console.log(r),s.init(r,i.settings.key,t,function(t){var e=t.target.responseXML;i.upload_id=e.getElementsByTagName("UploadId")[0].textContent,i.load_file()}))}})},i.prototype.load_file=function(){var t=this;if("waiting"==t.get_state()){t._start_fired||(t.settings.on_start.call(t,t.file),t.settings.on_progress.call(t,0,t.file.size),t._start_fired=!0),t.set_state("processing"),t.settings.on_progress.call(t,t.get_total_progress(),t.file.size);var e=t.get_next_chunk();-1!=e?t.upload_chunk(e):t.upload_finished()&&(a("All done; finish upload"),t.finish_upload());for(var n=0;n<t.settings.num_workers-1&&(e=t.get_next_chunk(),-1!==e);n++)t.upload_chunk(e)}},i.prototype.upload_chunk=function(t){var e=this;if("processing"!=e.get_state())return void a("NOT processing; return");if(e.get_chunk_uploading(t))return a("Already Uploading"),void setTimeout(function(){var t=e.get_next_chunk();-1!==t&&e.upload_chunk(e.get_next_chunk())},1e3);if(e.set_chunk_uploading(t),a("Uploading Chunk: "+t),e.is_chunk_loaded(t)){var n=e.get_next_chunk();-1!=n?e.upload_chunk(n):e.upload_finished()&&(a("No next chunk; finish upload"),e.finish_upload())}var i=e.settings.chunk_size,r=t*i,o=Math.min(r+i,e.file.size),l=new Date;e._intervals=e._intervals||{};var c=function(n){if(n.target.readyState!=this.DONE||"processing"!=e.get_state())return void a(n);if(n.target.status/100!=2)return h();a("Chunk uploaded: "+t),e.notify_chunk_uploaded(t),e.settings.on_chunk_uploaded.call(e,t),clearInterval(e._intervals[t]),e.set_progress(t,e.get_chunk_size(t)),e.set_chunk_finished(t),e.set_chunk_uploading(t,!1);var s=e.get_next_chunk();if(-1!=s)e.upload_chunk(s);else if(e.upload_finished())a("Done"),e.finish_upload();else var i=setInterval(function(){var t=e.get_next_chunk();-1!=t?(clearInterval(i),e.upload_chunk(t)):e.upload_finished()&&(clearInterval(i),e.finish_upload())},1e3)},u=function(n){e.set_progress(t,n.loaded),e.settings.on_progress.call(e,e.get_total_progress(),e.file.size),l=new Date},_=!1,h=function(){var n=arguments,s=this;e.check_already_uploaded(function(){e.set_state("finished"),e.notify_upload_finished(),e.settings.on_progress.call(e,e.file.size,e.file.size),e.settings.on_complete.call(e)},function(){if(a("Error: "),a(n),!_){_=!0,e.set_chunk_uploading(t,!1),e.set_chunk_finished(t,!1),e.set_progress(t,0),a("Abort");try{s.abort()}catch(i){a(i)}a("Retry chunk: "+t),clearInterval(e._intervals[t]),setTimeout(function(){if("processing"==e.get_state()){var n=e.get_next_chunk(t);-1!==n&&e.upload_chunk(n)}},1e3)}})};s.upload_chunk(e.auth,e.settings.key,e.upload_id,t,e.file.slice(r,o),{progress_callback:u,state_change_callback:c,error_callback:h,timeout_callback:h},function(n){e._chunk_xhr=e._chunk_xhr||[],e._chunk_xhr.push(n),e._intervals[t]=setInterval(function(){l&&new Date-l>15e3&&(a("Chunk Failed; retry"),clearInterval(e._intervals[t]),"processing"==e.get_state()&&(n.abort(),h.call(n),e._chunk_xhr[e._chunk_xhr.indexOf(n)]=null))},4e3)})},i.prototype.finish_upload=function(){var t=this;if("processing"==t.get_state()){t.set_state("finishing"),t.settings.on_progress.call(t,t.file.size,t.file.size);var e=function(n){n.target.status/100==2?(a("Finished file."),t.set_state("finished"),t.settings.on_progress.call(t,t.file.size,t.file.size),t.settings.on_complete.call(t)):400==n.target.status&&-1!==n.target.responseText.indexOf("EntityTooSmall")?s.list(t.auth,t.file,t.settings.key,t.upload_id,t.settings.chunk_size,function(e){t.update_chunks(e);var n=t.get_next_chunk();t.set_state("processing"),t.upload_chunk(n)}):404==n.target.status?t.cancel(function(){t.upload_file(t.file,!0)}):t.check_already_uploaded(function(){e({target:{status:200}})},function(){e({target:{status:404}})})};s.list(t.auth,t.file,t.settings.key,t.upload_id,t.settings.chunk_size,function(n){var i=Math.ceil(t.file.size/t.settings.chunk_size);if(n.length!=i){t.update_chunks(n);var r=t.get_next_chunk();return t.set_state("processing"),void t.upload_chunk(r)}s.finish(t.auth,t.file,t.settings.key,t.upload_id,n,t.settings.chunk_size,e,e)})}},i.prototype.notify_chunk_uploaded=function(t){var e=this;if("processing"==e.get_state()){var s=e.settings.key,i=e.upload_id,r=e.settings.ajax_base+"/chunk_loaded/";n({url:r,extra_params:{chunk:t,key:s,upload_id:i,filename:e.file.name,filesize:e.file.size,mime_type:e.settings.content_type,collectionId:e.settings.collectionId,last_modified:e.file.lastModifiedDate.valueOf()}})}},i.prototype.check_already_uploaded=function(t,e){var s=this,i="HEAD",r="/"+s.settings.key,o=function(n){n.target.status/100==2?(a("Already Uploaded"),t()):(a("Error!"),e())};e||"function"==typeof e||(e=function(){setTimeout(function(){return s.check_already_uploaded(t,e)},2500)}),n({url:s.settings.host+r,method:i,load_callback:o,error_callback:e})},i.prototype.cancel=function(t){for(var e=this,n=0;n<e._chunk_xhr.length;n++)a("Abort chunk: "+e._chunk_xhr[n]),e._chunk_xhr[n].abort();e._intervals=e._intervals||{};for(var s in e._intervals)e._intervals.hasOwnProperty(s)&&clearInterval(e._intervals[s]);t=t||function(){},e.set_state("canceled"),e._chunk_xhr=e._chunk_xhr||[],e.settings.on_progress.call(e,0,0),e._chunk_xhr=null,e._chunks=null,e._uploading_chunks=null,e._loaded_chunks=null,e._start_fired=!1,e.upload_id=null,e._progress=null,e.set_state("waiting"),t()},i.prototype.update_chunks=function(t){var e=this,n=[],s=Math.ceil(e.file.size/e.settings.chunk_size);e._init_chunks(!0),e._uploading_chunks=[],e._loaded_chunks=[];var i;for(i=0;i<t.length;i++){var r=parseInt(t[i][0],10);e.add_loaded_chunk(r-1),e.set_chunk_finished(r-1),n.push(r-1)}for(i=0;s>i;i++)-1===n.indexOf(i)&&(a("Chunk not uploaded: ",i),e.set_progress(i,0))},i.prototype.is_selected=function(){return!!this.file},i.prototype.get_state=function(){return this._state},i.prototype.set_state=function(t){return this._state=t,t},i.prototype.set_progress=function(t,e){this.log_status(),this._progress=this._progress||{},this._total_progress=(this._total_progress||0)+e-(this._progress[t]||0),this._progress[t]=e,this.settings.on_chunk_progress.call(this,t,e,this.get_chunk_size(t))},i.prototype.get_total_progress=function(){return this._total_progress||0},i.prototype.is_chunk_loaded=function(t){return this._loaded_chunks=this._loaded_chunks||[],-1!==this._loaded_chunks.indexOf(t)},i.prototype.add_loaded_chunk=function(t){this._loaded_chunks=this._loaded_chunks||[],this._loaded_chunks.push(t),this.set_progress(t,this.get_chunk_size(t))},i.prototype.get_chunk_uploading=function(t){return this._uploading_chunks=this._uploading_chunks||[],-1!==this._uploading_chunks.indexOf(t)},i.prototype.set_chunk_uploading=function(t,e){if("undefined"==typeof e&&(e=!0),this._uploading_chunks=this._uploading_chunks||[],e)this._uploading_chunks.push(t);else{for(var n=[],s=0;s<this._uploading_chunks.length;s++)this._uploading_chunks[s]!=t&&n.push(this._uploading_chunks[s]);this._uploading_chunks=n}},i.prototype._init_chunks=function(t){var e=this;if(!e._chunks||t){e._chunks=[];for(var n=Math.ceil(e.file.size/e.settings.chunk_size),s=0;n>s;s++)e._chunks.push(!1)}},i.prototype.set_chunk_finished=function(t,e){"undefined"==typeof e&&(e=!0);var n=this;n._init_chunks(),n._chunks[t]=e},i.prototype.get_next_chunk=function(t){var e=this;if(e._init_chunks(),t&&!e._chunks[t]&&!e.get_chunk_uploading(t))return t;for(var n=0;n<e._chunks.length;n++)if(!e._chunks[n]&&!e.get_chunk_uploading(n))return n;return-1},i.prototype.upload_finished=function(){var t=this;t._init_chunks();for(var e=0;e<t._chunks.length;e++)if(!t._chunks[e]||t.get_chunk_uploading(e))return!1;return!0},i.prototype.is_last_chunk=function(t){return Math.ceil(this.file.size/this.settings.chunk_size)-1==t},i.prototype.get_chunk_size=function(t){return this.is_last_chunk(t)?this.file.size%this.settings.chunk_size:this.settings.chunk_size},i.prototype.log_status=function(){},i.prototype.on_chunk_progress=function(t){this.settings.on_chunk_progress=t},i.prototype.on_progress=function(t){this.settings.on_progress=t},i.prototype.on_select=function(t){this.settings.on_select=t},i.prototype.on_error=function(t){this.settings.on_error=t},i.prototype.on_complete=function(t){this.settings.on_complete=t},i.prototype.on_init=function(t){this.settings.on_init=t},i.prototype.on_start=function(t){this.settings.on_start=t},i.prototype.on_chunk_uploaded=function(t){this.settings.on_chunk_uploaded=t},new i(e)};var s=function(t){this.settings=t};s.finish=function(t,e,n,i,r,a,o){for(var l={uploadId:i},c="<CompleteMultipartUpload>",u=0;u<r.length;u++)c+="<Part>",c+="<PartNumber>"+r[u][0]+"</PartNumber>",c+="<ETag>"+r[u][1]+"</ETag>",c+="</Part>";return c+="</CompleteMultipartUpload>",-1!==navigator.userAgent.indexOf("Firefox")&&(c=new Blob([c])),new s({auth:t,key:n,method:"POST",querystring:l,headers:{},payload:c,load_callback:o}).send()},s.list=function(t,e,n,i,r,a,o,l){var c={uploadId:i};return l&&(c["part-number-marker"]=l),new s({auth:t,key:n,method:"GET",querystring:c,headers:{},payload:"",error_callback:o,load_callback:function(l){if(404===l.target.status)return void(o&&o());window.debug=l;for(var c=l.target.responseXML,u=[],_=c.getElementsByTagName("Part"),h=Math.ceil(e.size/r),d=0;d<_.length;d++){var p=parseInt(_[d].getElementsByTagName("PartNumber")[0].textContent,10),g=_[d].getElementsByTagName("ETag")[0].textContent,f=parseInt(_[d].getElementsByTagName("Size")[0].textContent,10);(p==h||f==r)&&(p!=h||f==e.size%r)&&u.push([p,g,f])}var k=c.getElementsByTagName("IsTruncated")[0].textContent;if("true"===k){var y=c.getElementsByTagName("NextPartNumberMarker")[0].textContent;s.list(t,e,n,i,r,function(t){a(u.concat(t))},o,y)}else a(u)}}).send()},s.upload_chunk=function(t,e,n,i,r,a,o){var l,c,u,_;a instanceof Object?(l=a.load_callback,c=a.error_callback,u=a.progress_callback,_=a.state_change_callback):l=a;var h={partNumber:i+1,uploadId:n};return new s({auth:t,key:e,method:"PUT",querystring:h,headers:{},payload:r,load_callback:l,error_callback:c,progress_callback:u,state_change_callback:_}).send(o)},s.init=function(t,e,n,i){return new s({auth:t,key:e,method:"POST",querystring:{uploads:""},headers:{"x-amz-acl":"public-read","Content-Disposition":"attachment; filename="+n.name,"Content-Type":t.content_type||"application/octet-stream"},payload:"",load_callback:i}).send()},s.prototype={send:function(t){var e=this;e.request_date=new Date,e.headers=e.settings.headers,e.headers.host=e.settings.auth.bucket+".s3.amazonaws.com";var s=[e.settings.auth.date.getUTCFullYear(),i.zfill(e.settings.auth.date.getUTCMonth()+1,2),i.zfill(e.settings.auth.date.getUTCDate(),2)].join("");e.settings.querystring["X-Amz-Date"]=i.uriencode(i.iso8601(e.request_date)),e.settings.querystring["X-Amz-Algorithm"]="AWS4-HMAC-SHA256",e.settings.querystring["X-Amz-Expires"]=86400,e.settings.querystring["X-Amz-Credential"]=i.uriencode([e.settings.auth.access_key,"/"+s+"/",e.settings.auth.region+"/s3/aws4_request"].join("")),e.settings.querystring["X-Amz-SignedHeaders"]="";var r=[];for(var a in e.headers)r.push(a);r.sort(),e.settings.querystring["X-Amz-SignedHeaders"]=i.uriencode(r.join(";")),e.settings.querystring["X-Amz-Signature"]=e.get_authorization_header(),delete e.headers.host;var o=location.protocol+"//"+e.settings.auth.bucket+".s3.amazonaws.com/"+e.settings.key,l=!0;for(var a in e.settings.querystring)e.settings.querystring.hasOwnProperty(a)&&(l&&(o+="?"),l=!1,o+=a+"="+e.settings.querystring[a]+"&");o=o.slice(0,-1);var c=n({url:o,method:e.settings.method,headers:e.headers,body:e.settings.payload,load_callback:e.settings.load_callback,progress_callback:e.settings.progress_callback,state_change_callback:e.settings.state_change_callback,error_callback:e.settings.error_callback,timeout_callback:e.settings.timeout_callback});t&&t(c)},get_authorization_header:function(){if(!this.settings.auth.date)throw"Invalid date given.";for(var t=i.get_sorted_keys(this.headers),e="",n=0;n<t.length;n++)e+=t[n].toLowerCase()+";";e=e.slice(0,-1);var s=this.get_canonical_request(),r=this.get_string_to_sign(s,this.request_date),a=this.sign_request(r);return a},get_canonical_request:function(){var t="";t+=this.settings.method.toUpperCase()+"\n",t+="/"+i.uriencode(this.settings.key).replace(/%2F/g,"/")+"\n";var e,n,s,r=i.get_sorted_keys(this.settings.querystring);for(s=0;s<r.length;s++)e=r[s],n=this.settings.querystring[e],t+=i.uriencode(e)+"="+n+"&amp;";t=t.slice(0,-"&amp;".length)+"\n";var a=i.get_sorted_keys(this.headers);for(s=0;s<a.length;s++)e=a[s],n=this.headers[e],t+=e.toLowerCase()+":"+n.trim()+"\n";for(t+="\n",s=0;s<a.length;s++)t+=a[s].toLowerCase()+";";return t=t.slice(0,-1)+"\n",t+="UNSIGNED-PAYLOAD"},get_string_to_sign:function(t,n){var s="";return s+="AWS4-HMAC-SHA256\n",s+=i.iso8601(n)+"\n",s+=[n.getUTCFullYear(),i.zfill(n.getUTCMonth()+1,2),i.zfill(n.getUTCDate(),2),"/"+this.settings.auth.region+"/s3/aws4_request\n"].join(""),s+=e.SHA256(t.replace(/&amp;/g,"&")).toString()},sign_request:function(t){if(!this.settings.auth.signature)throw"No signature provided.";var n=e.HmacSHA256(t,e.enc.Hex.parse(this.settings.auth.signature)).toString();return n}};var i={uriencode:function(t){var e=encodeURIComponent(t);return e=e.replace(/[^A-Za-z0-9_.~\-%]+/g,escape),e=e.replace(/;/g,"%3B"),e=e.replace(/[*]/g,function(t){return"%"+t.charCodeAt(0).toString(16).toUpperCase()})},get_sorted_keys:function(t){var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n);return e.sort()},iso8601:function(t){return[t.getUTCFullYear(),i.zfill(t.getUTCMonth()+1,2),i.zfill(t.getUTCDate(),2),"T",i.zfill(t.getUTCHours(),2),i.zfill(t.getUTCMinutes(),2),i.zfill(t.getUTCSeconds(),2),"Z"].join("")},zfill:function(t,e){return("00000000000"+t).substr(-e)}}}(this);
//# sourceMappingURL=mule2.min.js.map
