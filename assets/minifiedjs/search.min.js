function parseHash(){window.location.hash.length>0&&!disableHashChange&&($("#results").empty(),$("#listResults").empty(),searchId=window.location.hash.substring(1),doSearch(searchId,0))}function doSearch(e,t,a,n){n||(previousEventComplete=!1,currentPageNumber=t),a=a?"true":"false",$.get(basePath+"search/searchResults/"+e+"/"+t+"/"+a,function(t){if(!n){var a=[];try{cachedResults&&(a=cachedResults.matches),cachedResults=$.parseJSON(t)}catch(i){alert(i+" "+t)}if(cachedResults.success===!0){if(1==cachedResults.totalResults){var l=cachedResults.matches[0].objectId;$.cookie("lastSearch",e),window.location.hash="",window.location.pathname=basePath+"/asset/viewAsset/"+l}processSearchResults(cachedResults),newArray=$.merge(cachedResults.matches,a),cachedResults.matches=newArray}}})}function processSearchResults(e){populateSearchFields(e.searchEntry),populateSearchResults(e),0===e.matches.length&&(dataAvailable=!1),previousEventComplete=!0}function getSuggestions(e){var t=e;$.post(basePath+"search/getSuggestion",{searchTerm:e},function(e,a){var n=$.parseJSON(e);if(0!==n.length){$.each(n,function(e,a){var n=new RegExp(e,"ig");t=t.replace(n,a)});var i=$("<a>").addClass("useSuggest").append(t),l=$("<i>").append(i),s=$("<div>").addClass("col-sm-12 suggestionText").append("Did you mean: ").append(l).append(" ?");$(".suggest").empty(),$(".suggest").append(s)}})}function populateSearchFields(e){$(".collectionSelector").prop("checked",!1),$("#showHidden").prop("checked",!1),$(".advancedOption").val(),e.searchText.length>0&&getSuggestions(e.searchText),$.each(e,function(e,t){$("#"+e).val(t)})}function populateSearchResults(e){var t=$(targetTemplate).html(),a=Handlebars.compile(t),n=$(listTemplate).html(),i=Handlebars.compile(n);$.each(e.matches,function(t,n){n.base_url=basePath,n.searchObject=e;var l=a(n),s=i(n);$("#results").append(l),$("#listResults").append(s)}),$('a[href="#map"]').parent().hasClass("active")&&prepMap(),$('a[href="#timeline"]').parent().hasClass("active")&&prepTimeline(),$('a[href="#gallery"]').parent().hasClass("active")&&prepGallery(),$('a[href="#grid"]').parent().hasClass("active")?$("#results").find("img").each(function(e,t){$(t).on("load",function(){Retina.isRetina()&&($(t).removeAttr("width").removeAttr("height"),new RetinaImage(t))})}):$("#results").find("img").each(function(e,t){$(t).on("show",function(){Retina.isRetina()&&($(t).removeAttr("width").removeAttr("height"),new RetinaImage(t))})}),$('a[href="#list"]').parent().hasClass("active")?$("#listResults").find("img").each(function(e,t){$(t).on("load",function(){Retina.isRetina()&&($(t).removeAttr("width").removeAttr("height"),new RetinaImage(t))})}):$("#listResults").find("img").each(function(e,t){$(t).on("show",function(){$(t).removeAttr("width").removeAttr("height"),Retina.isRetina()&&($(t).removeAttr("width").removeAttr("height"),new RetinaImage(t))})}),$(".resultsData").html("<p>Total Results: "+e.totalResults+"</p>"),dataAvailable&&e.matches.length<e.totalResults&&e.totalResults<1e3&&$(".resultsData p").append(" <a href='' id='loadAllResults'>[Load All]</a>"),e.totalResults>e.matches.length?($(".paginationBlock").show(),resultsAvailable=!0):($(".paginationBlock").hide(),resultsAvailable=!1),null!==searchId&&doSearch(searchId,currentPageNumber+1,!1,!0)}function prepGallery(){var e=[];$.each(cachedResults.matches,function(t,a){a.base_url=basePath,a.searchObject=cachedResults,e.push({image:basePath+"fileManager/bestDerivativeByObjectId/"+a.objectId+"/true",thumb:basePath+"fileManager/previewImage/"+a.objectId,title:a.title,link:basePath+"asset/viewAsset/"+a.objectId})}),Galleria.loadTheme("/assets/themes/twelve/galleria.twelve.min.js"),$("#galleryFrame").galleria({data_source:e,imageCrop:!1,imageTimeout:9e4,popupLinks:!0,extend:function(e){this.attachKeyboard({left:this.prev,right:this.next}),this.setPlaytime(8e3),this.setOptions("showInfo",!1),this.bind("fullscreen_enter",function(){this.$("info").hide()}),this.bind("fullscreen_exit",function(){this.$("info").show()})}})}function prepMap(){$("#mapPane").removeData(),$("#mapPane").goMap({mapTypeControl:!0,maptype:"ROADMAP",mapTypeControlOptions:{position:"TOP_RIGHT",style:"DROPDOWN_MENU"},addMarker:"single"}),$.goMap.getMarkerCount()>0&&$.goMap.clearMarkers(),$.each(cachedResults.matches,function(e,a){a.locations&&$.each(a.locations,function(e,n){$.each(n.entries,function(e,n){loc=n.loc.coordinates,a.base_url=basePath;var i=MarkerTemplate(a),l=$.goMap.getMarkers("markers");if(latlng=new google.maps.LatLng(loc[1],loc[0]),finalLatLng=latlng,0!=l.length)for(t=0;t<l.length;t++){var s=l[t],r=s.getPosition();if(google.maps.geometry.spherical.computeDistanceBetween(latlng,r)<1){var o=latlng.lat()+(Math.random()-.5)/5500,c=latlng.lng()+(Math.random()-.5)/5500;finalLatLng=new google.maps.LatLng(o,c)}}else finalLatLng=latlng;$.goMap.createMarker({longitude:finalLatLng.lng(),latitude:finalLatLng.lat(),html:i})})})});var e=[];for(var t in $.goMap.markers){var a=$($.goMap.mapId).data($.goMap.markers[t]);e.push(a)}new MarkerClusterer($.goMap.map,e);$.goMap.fitBounds()}function prepTimeline(){var e=null,t=null;if(void 0===Timeline||void 0===Timeline.DateTime||void 0===Timeline.DefaultEventSource||void 0===Timeline.strings||void 0===Timeline.GregorianDateLabeller.monthNames)return void setTimeout(function(){prepTimeline()},1e3);$("#timelinePane").empty();var a=!1;null===cachedDates&&(cachedDates={events:[]},$.each(cachedResults.matches,function(e,t){t.dates&&$.each(t.dates,function(e,t){$.each(t.dateAsset,function(e,t){t.start&&(startTime=parseInt(t.start.numeric,10),startTime<-6373557595440&&(a=!0))})})}),$.each(cachedResults.matches,function(n,i){i.dates&&$.each(i.dates,function(n,l){$.each(l.dateAsset,function(n,l){if(l.start){var s=null,r=null,o=null,c=null,h=null;s=parseInt(l.start.numeric,10),a?o=Timeline.GeochronoUnit.wrapMA(Math.abs(s/315569e8)):(h=new Date(1970,0,1),h.setSeconds(s),o=Date.utc.create(h)),formattedValue={miscData:i,title:i.title,id:"/en/"+i.objectId,start:o,image:basePath+"testController/previewImage/"+i.objectId,link:basePath+"testController/viewAsset/"+i.objectId,description:"Caption goeshere"},l.end.numeric.length>0&&(r=parseInt(l.end.numeric,10),a?c=Timeline.GeochronoUnit.wrapMA(Math.abs(r/315569e8)):(h=new Date(1970,0,1),h.setSeconds(r),c=Date.utc.create(h)),formattedValue.end=c,formattedValue.durationEvent=!0),(null===e||e>s)&&(e=s),(null===t||s>t)&&(t=s),r>t&&(t=r),cachedDates.events.push(formattedValue)}})})})),eventSource&&eventSource.clear();Timeline.DefaultEventSource.Event.prototype.fillInfoBubble;Timeline.DefaultEventSource.Event.prototype.fillInfoBubble=function(e,t,a){var n=this,i=document.createElement("div");i.innerHTML=MarkerTemplate(n._obj.miscData),e.appendChild(i)},eventSource=a?new Timeline.DefaultEventSource(new SimileAjax.EventIndex(Timeline.GeochronoUnit)):new Timeline.DefaultEventSource(0),eventSource.loadJSON(cachedDates,"localJson");var n=Timeline.ClassicTheme.create(),i=null,l=null;if(a)l=Math.abs((e+t)/2/315569e8),i=Timeline.GeochronoUnit.wrapMA(l);else{l=(e+t)/2;var s=new Date(1970,0,1);s.setSeconds(l),i=Date.create(s)}var r=t-e,o=null,c=null,h=200;3600>r?(o=Timeline.DateTime.MINUTE,c=Timeline.DateTime.HOUR):86400>r?(o=Timeline.DateTime.HOUR,c=Timeline.DateTime.DAY):2592e3>r?(o=Timeline.DateTime.DAY,c=Timeline.DateTime.MONTH):31104e3>r?(o=Timeline.DateTime.MONTH,c=Timeline.DateTime.YEAR):31104e4>r?(o=Timeline.DateTime.YEAR,c=Timeline.DateTime.DECADE):31104e5>r?(o=Timeline.DateTime.DECADE,c=Timeline.DateTime.CENTURY):31104e6>r?(o=Timeline.DateTime.CENTURY,c=Timeline.DateTime.MILLENNIUM):(o=Timeline.DateTime.MILLENNIUM,c=Timeline.DateTime.MILLENNIUM,h=80),a&&(o=Timeline.GeochronoUnit.MA,c=Timeline.GeochronoUnit.EPOCH),SimileAjax.History.enabled=!1;var u;a?(u=[Timeline.Geochrono.createBandInfo({eventSource:eventSource,timeZone:-1*((new Date).getTimezoneOffset()/60),date:i,width:"86%",intervalUnit:o,intervalPixels:100,trackGap:.2,trackHeight:1.3,theme:n,eventPainter:Timeline.CompactEventPainter,eventPainterParams:{iconLabelGap:5,labelRightMargin:20,iconWidth:80,iconHeight:80,stackConcurrentPreciseInstantEvents:{limit:5,moreMessageTemplate:"%0 More Events",icon:"no-image-80.png",iconWidth:80,iconHeight:80}}}),Timeline.Geochrono.createBandInfo({width:"10%",timeZone:-1*((new Date).getTimezoneOffset()/60),intervalUnit:c,intervalPixels:h,eventSource:eventSource,date:i,theme:n,overview:"overview"})],u[1].syncWith=0,u[1].highlight=!0):(u=[Timeline.createBandInfo({width:"90%",intervalUnit:o,timeZone:-1*((new Date).getTimezoneOffset()/60),intervalPixels:200,eventSource:eventSource,date:i,theme:n,eventPainter:Timeline.CompactEventPainter,eventPainterParams:{iconLabelGap:5,labelRightMargin:20,iconWidth:80,iconHeight:80,stackConcurrentPreciseInstantEvents:{limit:5,moreMessageTemplate:"%0 More Events",icon:"/assets/timeline_js/images/blue-circle.png",iconWidth:80,iconHeight:80}}}),Timeline.createBandInfo({width:"10%",timeZone:-1*((new Date).getTimezoneOffset()/60),intervalUnit:c,intervalPixels:h,eventSource:eventSource,date:i,theme:n,overview:"overview"})],u[1].syncWith=0,u[1].highlight=!0),a?tl=Timeline.create(document.getElementById("timelinePane"),u,Timeline.HORIZONTAL,Timeline.GeochronoUnit):tl=Timeline.create(document.getElementById("timelinePane"),u,Timeline.HORIZONTAL)}var MarkerSource,MarkerTemplate,cachedResults="",cachedDates=null,searchId=null,currentPageNumber,eventSource,resultsAvailable=!0,previousEventComplete=!0,dataAvailable=!0,disableHashChange=!1;$(document).ready(function(){$(window).scroll(function(){resultsAvailable&&$(document).height()-50<=$(window).scrollTop()+$(window).height()&&("Grid"==$(".nav-tabs .active").text()||"List"==$(".nav-tabs .active").text())&&previousEventComplete&&dataAvailable&&doSearch(searchId,currentPageNumber+1)}),$(window).bind("hashchange",function(e){parseHash()}),setTimeout(function(){$.getScript("/assets/timeline_js/ext/geochrono/geochrono-api.js")},1e3),$(".searchText").on("blur",function(){$(".advancedSearchText").val($(".searchText").val())}),$(".advancedSearchText").on("blur",function(){$(".searchText").val($(".advancedSearchText").val())}),$('a[href="#timeline"]').on("shown.bs.tab",function(){cachedDates=null,prepTimeline()}),$('a[href="#map"]').on("shown.bs.tab",function(){prepMap()}),$('a[href="#gallery"]').on("shown.bs.tab",function(){prepGallery()}),$('a[href="#grid"]').on("shown.bs.tab",function(){$("#results").find("img").trigger("show")}),$('a[href="#list"]').on("shown.bs.tab",function(){$("#listResults").find("img").trigger("show")}),$(".previousPage").on("click",function(){return doSearch(searchId,currentPageNumber-1),!1}),$(".nextPage").on("click",function(){return doSearch(searchId,currentPageNumber+1),!1}),MarkerSource=$("#marker-template").html(),MarkerTemplate=Handlebars.compile(MarkerSource)}),$(document).on("click",".assetLink",function(){$.cookie("lastSearch",searchId)}),$(document).on("click",".useSuggest",function(){$(".searchText").val($(this).text()),$(".searchForm").submit()}),$(document).on("click","#loadAllResults",function(e){e.preventDefault(),dataAvailable&&(doSearch(searchId,currentPageNumber+1,!0),dataAvailable=!1,$("#loadAllResults").hide())});
//# sourceMappingURL=search.js.map
