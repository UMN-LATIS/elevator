var currentPageNumber,eventSource,MarkerSource,MarkerTemplate,TimelineTemplate,cachedResults="",cachedDates=null,searchId=null,resultsAvailable=!0,previousEventComplete=!0,dataAvailable=!0,disableHashChange=!1,totalResults=0,registerClickHandlers=($(document).ready(function(){registerScrollHandlers(),registerClickHandlers(),loadTemplates(),""!==location.hash&&$('a[href="'+location.hash+'"]').tab("show"),$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){history.pushState?history.pushState(null,null,"#"+$(e.target).attr("href").substr(1)):location.hash="#"+$(e.target).attr("href").substr(1)})}),function(){$(".searchText").on("blur",function(){$(".advancedSearchText").val($(".searchText").val())}),$(".advancedSearchText").on("blur",function(){$(".searchText").val($(".advancedSearchText").val())}),$('a[href="#timeline"]').on("shown.bs.tab",function(){cachedDates=null,prepTimeline()}),$('a[href="#map"]').on("shown.bs.tab",function(){prepMap()}),$('a[href="#gallery"]').on("shown.bs.tab",function(){prepGallery()}),$('a[href="#grid"]').on("shown.bs.tab",function(){$("#results").find("img").trigger("show")}),$('a[href="#list"]').on("shown.bs.tab",function(){$("#listResults").find("img").trigger("show")}),$(".nextPage").on("click",function(){return doSearch(searchId,currentPageNumber+1),!1}),$(".embedMap").on("click",function(e){e.preventDefault(),embedPath="//"+window.location.hostname+basePath+"search/map/"+getCurrentSearchId(),iFrameContent='<iframe width="640" height="480" src="'+embedPath+'" frameborder="0" allowfullscreen></iframe>',embedContent='<input size=50 class="embedControl" value="'+htmlEntities(iFrameContent)+'"">',bootbox.dialog({title:"Embed this map",message:"Use the HTML below to embed this map in another page: <br>"+embedContent,buttons:{success:{label:"OK",className:"btn-primary"}}})}),$(".embedTimeline").on("click",function(e){e.preventDefault(),embedPath="//"+window.location.hostname+basePath+"search/timeline/"+getCurrentSearchId(),iFrameContent='<iframe width="640" height="480" src="'+embedPath+'" frameborder="0" allowfullscreen></iframe>',embedContent='<input size=50 class="embedControl" value="'+htmlEntities(iFrameContent)+'"">',bootbox.dialog({title:"Embed this timeline",message:"Use the HTML below to embed this timeline in another page: <br>"+embedContent,buttons:{success:{label:"OK",className:"btn-primary"}}})}),$(".embedGallery").on("click",function(e){e.preventDefault(),embedPath="//"+window.location.hostname+basePath+"search/gallery/"+getCurrentSearchId(),iFrameContent='<iframe width="640" height="480" src="'+embedPath+'" frameborder="0" allowfullscreen></iframe>',embedContent='<input size=50 class="embedControl" value="'+htmlEntities(iFrameContent)+'"">',bootbox.dialog({title:"Embed this gallery",message:"Use the HTML below to embed this gallery in another page: <br>"+embedContent,buttons:{success:{label:"OK",className:"btn-primary"}}})}),$(document).on("click",".embedControl",function(){$(this).select()}),$(document).on("click",".exportCSV",function(e){e.preventDefault(),target=e.target.href,window.location=target+"#"+searchId}),$(document).on("click",".fullscreen",function(){$.fullscreen.isNativelySupported()&&$(".frameFullscreenContainer").first().fullscreen({toggleClass:"imageFullscreen"})}),$(document).on("click",".assetLink",function(e){$.cookie("lastSearch",searchId,{path:"/"})}),$(document).on("click",".useSuggest",function(){$(".searchText").val($(this).text()),$(".searchForm").submit()}),$(document).on("change",".sortBy",function(){$(".hiddenSort").val($(this).val()),performSearchForButtonPress($(".searchForm").first())}),$(document).on("click","#loadAllResults",function(e){e.preventDefault(),dataAvailable&&(doSearch(searchId,currentPageNumber+1,!0),dataAvailable=!1,$("#loadAllResults").hide(),$(".paginationBlock").hide(),resultsAvailable=!1)})}),registerScrollHandlers=function(){$(window).scroll(function(){resultsAvailable&&$(document).height()-50<=$(window).scrollTop()+$(window).height()&&("Grid"==$(".nav-tabs .active").text()||"List"==$(".nav-tabs .active").text())&&previousEventComplete&&dataAvailable&&doSearch(searchId,currentPageNumber+1)})},targetTemplate="#result-template",listTemplate="#list-template",timeline=null,loadTemplates=function(){MarkerSource=$("#marker-template").html(),MarkerTemplate=Handlebars.compile(MarkerSource),TimelineSource=$("#timeline-template").html(),TimelineTemplate=Handlebars.compile(TimelineSource)};function htmlEntities(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function getCurrentSearchId(){return currentURL=window.location.href.replace(window.location.hash,"").replace("#",""),36==(currentHash=window.location.hash.replace("#","")).length?(searchId=currentHash,window.history.pushState({},"Search Results",currentURL+"/s/"+searchId)):searchId=currentURL.substr(currentURL.lastIndexOf("/")+1),searchId}function parseSearch(){var e;(searchId=getCurrentSearchId())&&!disableHashChange&&(resetSearchFrame(),e=!1,"undefined"!=typeof loadAll&&1==loadAll&&(e=!0),searchId.length<10?"undefined"!=typeof loadDrawer&&loadDrawer():doSearch(searchId,0,e))}function loadCollectionHeader(){1==$("input[name='collection[]']").length&&"0"!==$("input[name='collection[]']").val()&&""==$("#searchText").val()&&$.get(basePath+"collections/collectionHeader/"+$("input[name='collection[]']").val(),function(e){$(".collectionHeader").html(e)})}function doSearch(r,e,a,l){l||(previousEventComplete=!1,currentPageNumber=e),a=a?"true":"false",$.get(basePath+"search/searchResults/"+r+"/"+e+"/"+a,function(a){if(!l){var e=[],t=[];try{cachedResults&&(e=cachedResults.matches,t=cachedResults.searchResults),cachedResults=a}catch(e){alert(e+" "+a)}!0===cachedResults.success&&(1==cachedResults.totalResults&&(a=cachedResults.matches[0].objectId,$.cookie("lastSearch",r,{path:"/"}),window.location.pathname=basePath+"/asset/viewAsset/"+a),cachedResults.totalLoadedCount=cachedResults.matches.length+e.length,processSearchResults(cachedResults),newArray=$.merge(cachedResults.matches,e),cachedResults.searchResults=$.merge(cachedResults.searchResults,t),cachedResults.matches=newArray,$('a[href="#map"]').parent().hasClass("active")&&prepMap(),$('a[href="#timeline"]').parent().hasClass("active"))&&(cachedDates=null,prepTimeline())}}).fail(function(e){0<e.readyState&&alert(JSON.stringify(e))})}function processSearchResults(e){populateSearchFields(e.searchEntry),loadCollectionHeader(),populateSearchResults(e),0===e.matches.length&&(dataAvailable=!1),previousEventComplete=!0}function getSuggestions(e){var t=e;$.post(basePath+"search/getSuggestion",{searchTerm:e},function(e,a){0!==e.length&&($.each(e,function(e,a){e=new RegExp(e,"ig");t=t.replace(e,a)}),e=$("<a>").addClass("useSuggest").append(t),e=$("<i>").append(e),e=$("<div>").addClass("col-sm-12 suggestionText").append("Did you mean: ").append(e).append(" ?"),$(".suggest").empty(),$(".suggest").append(e))})}function populateSearchFields(e){$(".collectionSelector").prop("checked",!1),$("#showHidden").prop("checked",!1),$(".advancedOption").val(),0<e.searchText.length&&getSuggestions(e.searchText),$(".sortBy").val(e.sort),$.each(e,function(r,e){var l;Array.isArray(e)?(l=$("#"+r),$.each(e,function(e,a){var t=l.clone();$(t).val(a),$(t).appendTo($("#"+r).parent())}),$(l).remove()):$("#"+r).val(e)}),0<$("#collection").val()&&(targetText=$('[data-collection-id="'+$("#collection").val()+'"]').text(),$("#search_concept").text(targetText))}function populateSearchResults(r){var e=$(targetTemplate).html(),l=Handlebars.compile(e),a=$(listTemplate).html(),n=Handlebars.compile(a),e=($.each(r.matches,function(e,a){a.base_url=basePath,a.searchObject=r;var t=l(a),a=n(a);$("#results").append(t),$("#listResults").append(a)}),$("#gallery-template").html()),l=Handlebars.compile(e);$.each(cachedResults.matches,function(e,a){a.base_url=basePath,a.searchObject=cachedResults;var t=a.isChild=!1,r=(1<a.fileAssets&&a.fileAssets<20&&(t=!0),a.hasChildren=t,l(a));if($("#previewFrame .frame ul").append(r),t)for(i=0;i<a.fileAssets-1;i++){a.primaryHandlerId=null,a.hasChildren=!1,a.isChild=!0;r=l(a);$("#previewFrame .frame ul").append(r)}}),totalResults=r.totalResults,$(".resultsData").html("<p>Total Results: "+r.totalResults+"</p>"),dataAvailable&&r.matches.length<r.totalResults&&r.totalResults<1e3&&$(".resultsData p").append(" <a href='' id='loadAllResults'>[Load All]</a>"),resultsAvailable=r.totalResults>r.totalLoadedCount?($(".paginationBlock").show(),!0):($(".paginationBlock").hide(),!1),0==r.matches.length&&($(".paginationBlock").hide(),resultsAvailable=!1),$('a[href="#map"]').parent().hasClass("active")&&prepMap(),$('a[href="#gallery"]').parent().hasClass("active")&&prepGallery(),$('a[href="#timeline"]').parent().hasClass("active")&&prepTimeline(),null!==searchId&&doSearch(searchId,currentPageNumber+1,!1,!0),event=new Event("searchUpdated"),document.dispatchEvent(event)}var galleryFrame=null;function prepGallery(){var e;""!==cachedResults&&(null!==galleryFrame?galleryFrame.reload():($(".frame ul").find('[data-haschildren="true"]').each(function(e,l){var n;"true"!=$(l).data("childrenloaded")&&(n=$(l).data("primaryhandler"),$.get(basePath+"asset/viewAsset/"+$(l).data("objectid")+"/true",function(e){parsed=e;var a,t=new Array;for(r in parsed)Array.isArray(parsed[r])&&(a=parsed[r].map(function(e){return e.hasOwnProperty("fileId")?e.fileId:null}).filter(e=>null!=e).filter(e=>e!=n),t=t.concat(a));if(parsed.relatedAssetCache)for(var r in parsed.relatedAssetCache)(element=parsed.relatedAssetCache[r]).ignoreForDigitalAsset||element.primaryHandler&&0<element.primaryHandler.length&&t.push(element.primaryHandler);for(fileId of t)(targetElement=$(".frame ul").find('[data-objectid="'+$(l).data("objectid")+'"]').filter('[data-ischild="true"]').filter('[data-primaryhandler=""]').first()).attr("data-primaryhandler",fileId),targetElement.children("img").attr("src",basePath+"fileManager/previewImageByFileId/"+fileId),targetElement.children("img").attr("srcset",basePath+"fileManager/previewImageByFileId/"+fileId+"/true 2x");$(l).data("childrenloaded","true")}))}),e=(sourceFrame=$("#forcecentered")).parent(),(galleryFrame=new Sly($("#forcecentered"),{horizontal:1,itemNav:"forceCentered",keyboardNavBy:"items",smart:1,activateMiddle:0,activateOn:"click",mouseDragging:1,touchDragging:1,releaseSwing:1,startAt:0,scrollBar:e.find(".scrollbar"),scrollBy:1,speed:300,elasticBounds:1,easing:"easeOutExpo",dragHandle:1,dynamicHandle:1,clickBar:1,prev:e.find(".prev"),next:e.find(".next")}).init()).on("active",function(e,a){loadGalleryElement(a)}),loadGalleryElement(0)))}function loadGalleryElement(e){targetItem=galleryFrame.items[e].el,$(".frameHeader").html("<a href='"+basePath+"asset/viewAsset/"+$(targetItem).data("objectid")+"'><h2>"+$(targetItem).data("title")+"</h2></a>"),$(".galleryIframe").attr("src",basePath+"asset/getEmbed/"+$(targetItem).data("primaryhandler")+"/"+$(targetItem).data("objectid")+"/true")}function prepMap(){""!==cachedResults&&(markers.mapPane&&markers.mapPane.clearLayers(),map.mapPane||loadMap("mapPane"),markers.mapPane=L.markerClusterGroup({showCoverageOnHover:!1}),$.each(cachedResults.matches,function(e,t){t.locations&&$.each(t.locations,function(e,a){$.each(a.entries,function(e,a){loc=a.loc.coordinates,t.base_url=basePath;a=MarkerTemplate(t);if(0===loc[1]&&0===loc[0])return!0;(localMarker=L.marker([loc[1],loc[0]])).bindPopup(a),markers.mapPane.addLayer(localMarker)})})}),map.mapPane.addLayer(markers.mapPane),map.mapPane.fitBounds(markers.mapPane.getBounds().pad(.5)))}function prepTimeline(){if(""!==cachedResults){var e,a={},r=!1;a.events=new Array;for(e of cachedResults.matches)if(e.hasOwnProperty("dates")){for(var l of e.dates)for(var n of l.dateAsset)(startTime=parseInt(n.start.numeric,10))<-6373557595440&&(r=!0);for(var l of e.dates)for(var n of l.dateAsset){var s,i={},o=(startTime=parseInt(n.start.numeric,10),i.start_date={},r?(startYear=-1*Math.round(Math.abs((startTime+62167093e3)/31556900)),i.start_date.year=startYear):((t=new Date(1970,0,1)).setSeconds(startTime),formattedStart=Sugar.Date.create(t,{fromUTC:!0}),i.start_date.display_date=n.start.text,i.start_date.year=formattedStart.getFullYear(),i.start_date.month=formattedStart.getMonth()+1,i.start_date.day=formattedStart.getDay()+1),n.end.numeric&&0<n.end.numeric.toString().length&&(i.end_date={},endTime=parseInt(n.end.numeric,10),r?(endYear=-1*Math.round(Math.abs((endTime+62167093e3)/31556900)),i.end_date.year=endYear):((t=new Date(1970,0,1)).setSeconds(endTime),formattedEnd=Sugar.Date.create(t,{fromUTC:!0}),i.end_date.display_date=n.end.text,i.end_date.year=formattedEnd.getFullYear(),i.end_date.month=formattedEnd.getMonth()+1,i.end_date.day=formattedEnd.getDay()+1)),TimelineTemplate(e)),c=(i.text={},newElement=$("<a/>",{href:basePath+"asset/viewAsset/"+e.objectId,text:e.title}),i.text.headline=newElement.prop("outerHTML"),i.text.text=o,e.hasOwnProperty("primaryHandlerThumbnail2x")&&(i.media={},i.media.thumb=e.primaryHandlerThumbnail2x,i.media.url=e.primaryHandlerThumbnail2x),!1);for(s of a.events)JSON.stringify(s)==JSON.stringify(i)&&(c=!0);c||a.events.push(i)}}r?(a.scale="cosmological",injectStyles(".tl-timeaxis-minor { display: none; }")):$("#hackyGeoStyle").remove(),timeline=new TL.Timeline("timelinePane",a,{timenav_position:"bottom",timenav_height_percentage:"70"})}}function injectStyles(e){$("<div />",{id:"hackyGeoStyle",html:"&shy;<style>"+e+"</style>"}).appendTo("body")}
//# sourceMappingURL=search.min.js.map
