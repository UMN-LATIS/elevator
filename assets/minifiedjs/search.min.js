var MarkerSource,MarkerTemplate,TimelineTemplate,currentPageNumber,eventSource,cachedResults="",cachedDates=null,searchId=null,resultsAvailable=!0,previousEventComplete=!0,dataAvailable=!0,disableHashChange=!1,totalResults=0;function getCurrentSearchId(){return currentURL=window.location.href.replace(window.location.hash,""),currentHash=window.location.hash.replace("#",""),36==currentHash.length?(searchId=currentHash,window.history.pushState({},"Search Results",currentURL+"/s/"+searchId)):searchId=currentURL.substr(currentURL.lastIndexOf("/")+1),searchId}function parseSearch(){if((searchId=getCurrentSearchId())&&!disableHashChange){resetSearchFrame();var e=!1;"undefined"!=typeof loadAll&&1==loadAll&&(e=!0),doSearch(searchId,0,e)}}function loadCollectionHeader(){1==$("input[name='collection[]']").length&&"0"!==$("input[name='collection[]']").val()&&""==$("#searchText").val()&&$.get(basePath+"collections/collectionHeader/"+$("input[name='collection[]']").val(),function(e){$(".collectonHeader").html(e)})}function doSearch(e,a,t,r){r||(previousEventComplete=!1,currentPageNumber=a),t=t?"true":"false",$.get(basePath+"search/searchResults/"+e+"/"+a+"/"+t,function(a){if(!r){var t=[],l=[];try{cachedResults&&(t=cachedResults.matches,l=cachedResults.searchResults),cachedResults=$.parseJSON(a)}catch(e){alert(e+" "+a)}if(!0===cachedResults.success){if(1==cachedResults.totalResults){var n=cachedResults.matches[0].objectId;$.cookie("lastSearch",e,{path:"/"}),window.location.pathname=basePath+"/asset/viewAsset/"+n}cachedResults.totalLoadedCount=cachedResults.matches.length+t.length,processSearchResults(cachedResults),newArray=$.merge(cachedResults.matches,t),cachedResults.searchResults=$.merge(cachedResults.searchResults,l),cachedResults.matches=newArray,$('a[href="#map"]').parent().hasClass("active")&&prepMap(),$('a[href="#timeline"]').parent().hasClass("active")&&(cachedDates=null,prepTimeline())}}})}function processSearchResults(e){populateSearchFields(e.searchEntry),loadCollectionHeader(),populateSearchResults(e),0===e.matches.length&&(dataAvailable=!1),previousEventComplete=!0}function getSuggestions(e){var a=e;$.post(basePath+"search/getSuggestion",{searchTerm:e},function(e,t){var r=$.parseJSON(e);if(0!==r.length){$.each(r,function(e,t){var r=new RegExp(e,"ig");a=a.replace(r,t)});var l=$("<a>").addClass("useSuggest").append(a),n=$("<i>").append(l),s=$("<div>").addClass("col-sm-12 suggestionText").append("Did you mean: ").append(n).append(" ?");$(".suggest").empty(),$(".suggest").append(s)}})}function populateSearchFields(e){$(".collectionSelector").prop("checked",!1),$("#showHidden").prop("checked",!1),$(".advancedOption").val(),e.searchText.length>0&&getSuggestions(e.searchText),$(".sortBy").val(e.sort),$.each(e,function(e,a){if(Array.isArray(a)){var t=$("#"+e);$.each(a,function(a,r){var l=t.clone();$(l).val(r),$(l).appendTo($("#"+e).parent())}),$(t).remove()}else $("#"+e).val(a)}),$("#collection").val()>0&&(targetText=$('[data-collection-id="'+$("#collection").val()+'"]').text(),$("#search_concept").text(targetText))}function populateSearchResults(e){var a=$(targetTemplate).html(),t=Handlebars.compile(a),r=$(listTemplate).html(),l=Handlebars.compile(r);$.each(e.matches,function(a,r){r.base_url=basePath,r.searchObject=e;var n=t(r),s=l(r);$("#results").append(n),$("#listResults").append(s)});a=$("#gallery-template").html(),t=Handlebars.compile(a);$.each(cachedResults.matches,function(e,a){a.base_url=basePath,a.searchObject=cachedResults,a.isChild=!1;var r=!1;a.fileAssets>1&&a.fileAssets<20&&(r=!0),a.hasChildren=r;var l=t(a);if($("#previewFrame .frame ul").append(l),r)for(i=0;i<a.fileAssets-1;i++){a.primaryHandlerId=null,a.hasChildren=!1,a.isChild=!0;l=t(a);$("#previewFrame .frame ul").append(l)}}),totalResults=e.totalResults,$(".resultsData").html("<p>Total Results: "+e.totalResults+"</p>"),dataAvailable&&e.matches.length<e.totalResults&&e.totalResults<1e3&&$(".resultsData p").append(" <a href='' id='loadAllResults'>[Load All]</a>"),e.totalResults>e.totalLoadedCount?($(".paginationBlock").show(),resultsAvailable=!0):($(".paginationBlock").hide(),resultsAvailable=!1),0==e.matches.length&&($(".paginationBlock").hide(),resultsAvailable=!1),$('a[href="#map"]').parent().hasClass("active")&&prepMap(),$('a[href="#gallery"]').parent().hasClass("active")&&prepGallery(),$('a[href="#timeline"]').parent().hasClass("active")&&prepTimeline(),null!==searchId&&doSearch(searchId,currentPageNumber+1,!1,!0),event=new Event("searchUpdated"),document.dispatchEvent(event)}$(document).ready(function(){function e(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}$(window).scroll(function(){resultsAvailable&&$(document).height()-50<=$(window).scrollTop()+$(window).height()&&("Grid"==$(".nav-tabs .active").text()||"List"==$(".nav-tabs .active").text())&&previousEventComplete&&dataAvailable&&doSearch(searchId,currentPageNumber+1)}),$(".searchText").on("blur",function(){$(".advancedSearchText").val($(".searchText").val())}),$(".advancedSearchText").on("blur",function(){$(".searchText").val($(".advancedSearchText").val())}),$('a[href="#timeline"]').on("shown.bs.tab",function(){cachedDates=null,prepTimeline()}),$('a[href="#map"]').on("shown.bs.tab",function(){prepMap()}),$('a[href="#gallery"]').on("shown.bs.tab",function(){prepGallery()}),$('a[href="#grid"]').on("shown.bs.tab",function(){$("#results").find("img").trigger("show")}),$('a[href="#list"]').on("shown.bs.tab",function(){$("#listResults").find("img").trigger("show")}),$(".previousPage").on("click",function(){return doSearch(searchId,currentPageNumber-1),!1}),$(".nextPage").on("click",function(){return doSearch(searchId,currentPageNumber+1),!1}),MarkerSource=$("#marker-template").html(),MarkerTemplate=Handlebars.compile(MarkerSource),TimelineSource=$("#timeline-template").html(),TimelineTemplate=Handlebars.compile(TimelineSource),""!==location.hash&&$('a[href="'+location.hash+'"]').tab("show"),$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){history.pushState?history.pushState(null,null,"#"+$(e.target).attr("href").substr(1)):location.hash="#"+$(e.target).attr("href").substr(1)}),$(".embedMap").on("click",function(a){a.preventDefault(),embedPath=window.location.protocol+"//"+window.location.hostname+basePath+"search/map/"+getCurrentSearchId(),iFrameContent='<iframe width="640" height="480" src="'+embedPath+'" frameborder="0" allowfullscreen></iframe>',embedContent='<input size=50 class="embedControl" value="'+e(iFrameContent)+'"">',bootbox.dialog({title:"Embed this map",message:"Use the HTML below to embed this map in another page: <br>"+embedContent,buttons:{success:{label:"OK",className:"btn-primary"}}})}),$(".embedTimeline").on("click",function(a){a.preventDefault(),embedPath=window.location.protocol+"//"+window.location.hostname+basePath+"search/timeline/"+getCurrentSearchId(),iFrameContent='<iframe width="640" height="480" src="'+embedPath+'" frameborder="0" allowfullscreen></iframe>',embedContent='<input size=50 class="embedControl" value="'+e(iFrameContent)+'"">',bootbox.dialog({title:"Embed this timeline",message:"Use the HTML below to embed this timeline in another page: <br>"+embedContent,buttons:{success:{label:"OK",className:"btn-primary"}}})}),$(".embedGallery").on("click",function(a){a.preventDefault(),embedPath=window.location.protocol+"//"+window.location.hostname+basePath+"search/gallery/"+getCurrentSearchId(),iFrameContent='<iframe width="640" height="480" src="'+embedPath+'" frameborder="0" allowfullscreen></iframe>',embedContent='<input size=50 class="embedControl" value="'+e(iFrameContent)+'"">',bootbox.dialog({title:"Embed this gallery",message:"Use the HTML below to embed this gallery in another page: <br>"+embedContent,buttons:{success:{label:"OK",className:"btn-primary"}}})})}),$(document).on("click",".assetLink",function(e){$.cookie("lastSearch",searchId,{path:"/"})}),$(document).on("click",".useSuggest",function(){$(".searchText").val($(this).text()),$(".searchForm").submit()}),$(document).on("change",".sortBy",function(){$(".hiddenSort").val($(this).val()),performSearchForButtonPress($(".searchForm").first())}),$(document).on("click","#loadAllResults",function(e){e.preventDefault(),dataAvailable&&(doSearch(searchId,currentPageNumber+1,!0),dataAvailable=!1,$("#loadAllResults").hide(),$(".paginationBlock").hide(),resultsAvailable=!1)});var galleryFrame=null;function prepGallery(){if(""!==cachedResults)if(null!==galleryFrame);else{$(".frame ul").find('[data-haschildren="true"]').each(function(e,a){if("true"!=$(a).data("childrenloaded")){var t=$(a).data("primaryhandler");$.get(basePath+"asset/viewAsset/"+$(a).data("objectid")+"/true",function(e){parsed=e;var r=new Array;for(var l in parsed)if(Array.isArray(parsed[l])){var n=parsed[l].map(function(e){return e.hasOwnProperty("fileId")?e.fileId:null}).filter(e=>null!=e).filter(e=>e!=t);r=r.concat(n)}if(parsed.relatedAssetCache)for(var l in parsed.relatedAssetCache)element=parsed.relatedAssetCache[l],element.primaryHandler&&element.primaryHandler.length>0&&r.push(element.primaryHandler);for(fileId of r)targetElement=$(".frame ul").find('[data-objectid="'+$(a).data("objectid")+'"]').filter('[data-ischild="true"]').filter('[data-primaryhandler=""]').first(),targetElement.attr("data-primaryhandler",fileId),targetElement.children("img").attr("src",basePath+"fileManager/previewImageByFileId/"+fileId),targetElement.children("img").attr("srcset",basePath+"fileManager/previewImageByFileId/"+fileId+"/true 2x");$(a).data("childrenloaded","true")})}}),sourceFrame=$("#forcecentered");var e=sourceFrame.parent();(galleryFrame=new Sly($("#forcecentered"),{horizontal:1,itemNav:"forceCentered",keyboardNavBy:"items",smart:1,activateMiddle:0,activateOn:"click",mouseDragging:1,touchDragging:1,releaseSwing:1,startAt:0,scrollBar:e.find(".scrollbar"),scrollBy:1,speed:300,elasticBounds:1,easing:"easeOutExpo",dragHandle:1,dynamicHandle:1,clickBar:1,prev:e.find(".prev"),next:e.find(".next")}).init()).on("active",function(e,a){loadGalleryElement(a)}),loadGalleryElement(0)}}function loadGalleryElement(e){targetItem=galleryFrame.items[e].el,$(".frameHeader").html("<a href='"+basePath+"/asset/viewAsset/"+$(targetItem).data("objectid")+"'><h2>"+$(targetItem).data("title")+"</h2></a>"),$(".galleryIframe").attr("src",basePath+"asset/getEmbed/"+$(targetItem).data("primaryhandler")+"/"+$(targetItem).data("objectid")+"/true")}function loadNestedAssets(e){}function prepMap(){""!==cachedResults&&(markers&&markers.clearLayers(),map||loadMap("mapPane"),markers=L.markerClusterGroup({showCoverageOnHover:!1}),$.each(cachedResults.matches,function(e,a){a.locations&&$.each(a.locations,function(e,t){$.each(t.entries,function(e,t){loc=t.loc.coordinates,a.base_url=basePath;var r=MarkerTemplate(a);if(0===loc[1]&&0===loc[0])return!0;localMarker=L.marker([loc[1],loc[0]]),localMarker.bindPopup(r),markers.addLayer(localMarker)})})}),map.addLayer(markers),map.fitBounds(markers.getBounds().pad(.5)))}function prepTimeline(){if(""!==cachedResults){var e={},a=!1;for(var r of(e.events=new Array,cachedResults.matches))if(r.hasOwnProperty("dates")){for(var l of r.dates)for(var n of l.dateAsset)startTime=parseInt(n.start.numeric,10),startTime<-6373557595440&&(a=!0);for(var l of r.dates)for(var n of l.dateAsset){var s={};startTime=parseInt(n.start.numeric,10),s.start_date={},a?(startYear=-1*Math.round(Math.abs((startTime+62167093e3)/31556900)),s.start_date.year=startYear):(t=new Date(1970,0,1),t.setSeconds(startTime),formattedStart=Date.utc.create(t),s.start_date.display_date=n.start.text,s.start_date.year=formattedStart.getFullYear(),s.start_date.month=formattedStart.getMonth()+1,s.start_date.day=formattedStart.getDay()+1),n.end.numeric&&n.end.numeric.toString().length>0&&(s.end_date={},endTime=parseInt(n.end.numeric,10),a?(endYear=-1*Math.round(Math.abs((endTime+62167093e3)/31556900)),s.end_date.year=endYear):(t=new Date(1970,0,1),t.setSeconds(endTime),formattedEnd=Date.utc.create(t),s.end_date.display_date=n.end.text,s.end_date.year=formattedEnd.getFullYear(),s.end_date.month=formattedEnd.getMonth()+1,s.end_date.day=formattedEnd.getDay()+1));var o=TimelineTemplate(r);s.text={},newElement=$("<a/>",{href:basePath+"asset/viewAsset/"+r.objectId,text:r.title}),s.text.headline=newElement.prop("outerHTML"),s.text.text=o,r.hasOwnProperty("primaryHandlerThumbnail2x")&&(s.media={},s.media.thumb=r.primaryHandlerThumbnail2x,s.media.url=r.primaryHandlerThumbnail2x);var i=!1;for(var c of e.events)JSON.stringify(c)==JSON.stringify(s)&&(i=!0);i||e.events.push(s)}}a?(e.scale="cosmological",injectStyles(".tl-timeaxis-minor { display: none; }")):$("#hackyGeoStyle").remove();new TL.Timeline("timelinePane",e,{timenav_position:"bottom",timenav_height_percentage:"70"})}}function injectStyles(e){$("<div />",{id:"hackyGeoStyle",html:"&shy;<style>"+e+"</style>"}).appendTo("body")}$(document).on("click",".fullscreen",function(){$.fullscreen.isNativelySupported()&&$(".frameFullscreenContainer").first().fullscreen({toggleClass:"imageFullscreen"})}),$(document).on("click",".embedControl",function(){$(this).select()}),$(document).on("click",".exportCSV",function(e){e.preventDefault(),target=e.target.href,window.location=target+"#"+searchId});
//# sourceMappingURL=search.min.js.map
