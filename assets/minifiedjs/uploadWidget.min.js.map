{"version":3,"sources":["uploadWidget.js"],"names":["format_size","num_bytes","parseInt","uploadCount","uploadFile","fileElement","uploadSettings","containerElement","last_update","fileObjectId","$","find","val","trigger","localContainer","chunkSize","pollingForNewImage","checkForNewImages","fastUpload","settings","key","path","split","reverse","join","access_key","bucketKey","ajax_base","basePath","bucket","collectionId","num_workers","chunk_size","content_type","type","max_size","on_error","console","log","prepend","on_select","fileObj","on_start","window","hide","on_progress","bytesUploaded","bytesTotal","Date","percent","width","on_init","on_complete","get","data","show","on_chunk_uploaded","upload","mule_upload","attr","upload_file","resetCollection","loadSidecars","fileIdElement","fileId","closest","html","length","rootFormField","post","append","updateImage","container","ajax","url","success","textStatus","setTimeout","this","Math","random","document","on","self","bootbox","dialog","message","title","backdrop","buttons","label","className","callback","xhr","cancel","fileObjectPreview","targetElement","imageContainer","removeAttr","checkArray","Array","each","index","el","push","JSON","stringify","decoded","parse","content","filter","status","startUpload","targetFrame","parentElement","isNumeric","jQuery","ajaxSetup","async","prop","target","addAnother","responseArray","sendingArray","file","internalTarget","nextAll","eq","filename","name","containers","parseJSON","item","sourceArray","submitFormWithDelay","e","preventDefault","win","open","focus","ready"],"mappings":"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","file":"uploadWidget.min.js","sourcesContent":["\n\nvar format_size = function(num_bytes) {\n    if(num_bytes <= 1024 * 0.8) {\n        return num_bytes + \" B\";\n    } else if(num_bytes <= 1024 * 1024 * 0.8) {\n        return parseInt(num_bytes / 1024, 10) + \".\" + parseInt(num_bytes / 1024 * 10, 10) % 10 + \" KB\";\n    } else if(num_bytes <= 1024 * 1024 * 1024 * 0.8) {\n        return parseInt(num_bytes / 1024 / 1024, 10) + \".\" + parseInt(num_bytes / 1024 / 1024 * 10, 10) % 10 + \" MB\";\n    } else {\n        return parseInt(num_bytes / 1024 / 1024 / 1024, 10) + \".\" + parseInt(num_bytes / 1024 / 1024 / 1024 * 10, 10) % 10 + \" GB\";\n    }\n};\n\nvar uploadCount=0;\n\nvar uploadFile = function(fileElement, uploadSettings, containerElement) {\n    var last_update = null;\n    var last_uploaded = null;\n    var fileObjectId = uploadSettings.fileObjectId;\n    $(containerElement).find(\".fileObjectId\").val(fileObjectId);\n    $(containerElement).find(\".fileObjectId\").trigger('change');\n    var localContainer = containerElement;\n    var chunkSize = 6*1024*1024;\n    if(!pollingForNewImage) {\n    \tcheckForNewImages();\t\n    }\n    \n    if(fastUpload) { // if we're in fast upload mode, use big chunks\n        chunkSize = 200*1024*1024;\n    }\n    var settings = {\n        key: uploadSettings.path + \"/\" + fileObjectId.split(\"\").reverse().join(\"\") +\"-source\",\n        access_key: uploadSettings.bucketKey,\n        ajax_base: basePath + \"uploadBackend/upload\",\n        bucket: uploadSettings.bucket,\n        collectionId: uploadSettings.collectionId,\n        num_workers: 6,\n        chunk_size: chunkSize,\n        content_type: fileElement.type,\n        max_size: 50 * (1 << 30), // 50gb\n        on_error: function() {\n            console.log(\"ERROR\");\n            $(localContainer).find(\".log\").prepend(\"Error occurred! You can help me fix this by filing a bug report here: https://github.com/cinely/mule-uploader/issues\\n\");\n        },\n        on_select: function(fileObj) {\n            $(localContainer).find(\".log\").prepend(\"File selected\\n\");\n        },\n        on_start: function(fileObj) {\n            window.uploadCount++;\n            $(localContainer).find(\".deleteFile\").hide();\n        },\n        on_progress: function(bytesUploaded, bytesTotal) {\n            if(!last_update || (new Date() - last_update) > 1000) {\n                var percent = bytesUploaded / bytesTotal * 100;\n                var speed = (bytesUploaded - last_uploaded) / (new Date() - last_update) * 1000;\n                last_update = new Date();\n                last_uploaded = bytesUploaded;\n                $(localContainer).find('.progress .progress-bar').width(percent / 100 * $(localContainer).find('.progress').width());\n                // var log = \"Upload progress: \" + format_size(bytesUploaded) + \" / \" + format_size(bytesTotal) + \" (\" + parseInt(percent, 10) + \".\" + parseInt(percent * 10, 10) % 10 + \"%)\";\n                // if(speed) {\n                //     log += \"; speed: \" + format_size(speed) + \"/s\";\n                // }\n                //$(parentElement).find(\".log\").prepend(log + \"\\n\");\n            }\n        },\n        on_init: function() {\n            //$(parentElement).find(\".log\").prepend(\"Uploader initialized\\n\");\n        },\n        on_complete: function() {\n            window.uploadCount--;\n            $.get(basePath+ 'assetManager/completeSourceFile/' + fileObjectId , function(data) {\n                $(localContainer).find(\".uploadProgress\").hide();\n            });\n            $(localContainer).find(\".cancelButton\").hide();\n            $(localContainer).find(\".deleteFile\").show();\n            $(localContainer).find(\".allowResume\").hide();\n\n        },\n        on_chunk_uploaded: function() {\n           // $(parentElement).find(\".log\").prepend(\"Chunk finished uploading\\n\");\n        }\n    };\n    upload = mule_upload(settings);\n    $(\"#collectionId\").attr(\"disabled\", true);\n    $(localContainer).find(\".uploadProgress\").show();\n    upload.upload_file(fileElement, false);\n    return upload;\n};\n\n\nvar resetCollection = function() {\n    if($(\"#collectionId\").val() != \"---\" && $(\"#collectionId\").val() !==\"\" && $(\"#collectionId\").val() != -1) {\n        $(\".uploadInformation\").show();\n        $(\".uploadWarning\").hide();\n    }\n    else {\n        $(\".uploadInformation\").hide();\n        $(\".uploadWarning\").show();\n    }\n};\n\n$(document).on(\"change\", \"#collectionId\", function() {\n    resetCollection();\n});\n\n$(document).on(\"click\", \".deleteData\", function() {\n\n    var fileId = $(this).closest(\".widgetContents\").find(\".fileObjectId\").val();\n    var self = this;\n    $.get(basePath+\"fileManager/removeData/\"+fileId,function(data) {\n        $(self).closest(\".widgetContents\").find(\".extractedData\").val(\"\");\n    });\n});\n\n$(document).on(\"click\", \".deleteFile\", function() {\n\n    var self = this;\n    bootbox.dialog({\n        message: \"Delete this upload object?  This action cannot be undone and will delete the source media and any derivatives.\",\n        title: \"Delete Object?\",\n        backdrop: true,\n        buttons: {\n            success: {\n                label: \"Delete\",\n                className: \"btn-danger\",\n                callback: function() {\n                    var fileObjectId = $(self).closest(\".widgetContents\").find(\".fileObjectId\").val();\n                    $.post(basePath+'fileManager/deleteFileObject', { fileObjectId: fileObjectId }, function(data, textStatus, xhr) {\n                        if(data == \"success\") {\n                            $(self).closest(\".widgetContents\").find(\".fileObjectId\").val(\"\");\n                            $(self).closest(\".widgetContents\").find(\".fileDescription\").val(\"\");\n                            $(self).closest(\".widgetContents\").find(\".extractedData\").val(\"\");\n                            $(self).closest(\".widgetContents\").find(\".deleteFile\").hide();\n                            $(self).closest(\".widgetContents\").find(\".fileLabel\").html(\"Deleted\");\n                            $(\".fileObjectId\").trigger(\"change\");\n                        }\n                        else if(data == \"notfound\") {\n                            $(self).closest(\".widgetContents\").find(\".fileObjectId\").val(\"\");\n                            $(self).closest(\".widgetContents\").find(\".fileDescription\").val(\"\");\n                            $(self).closest(\".widgetContents\").find(\".extractedData\").val(\"\");\n                            $(\".fileObjectId\").trigger(\"change\");\n\n                        }\n                        else {\n                            bootbox.dialog({message:\"Deletion Error: please reload and try again.\"});\n\n                        }\n\n                    });\n                }\n            },\n            cancel: {\n                label: \"Cancel\",\n                className: \"btn-default\"\n            }\n        }\n    });\n\n\n});\n\nfunction loadSidecars(fileIdElement) {\n    fileId = $(fileIdElement).val();\n\n    // already have sidecars, don't load another\n    if($(fileIdElement).closest('.widgetContents').find(\".sidecars\").html().length > 0) {\n        return;\n    }\n\n    var rootFormField = $(fileIdElement).closest('.widgetContents').find(\".rootFormField\").val() + \"[sidecars]\";\n\n    $.post(basePath + 'fileManager/getSidecarViewForObject/', {fileId: fileId, rootFormField: rootFormField}, function(data) {\n        $(fileIdElement).closest('.widgetContents').find(\".sidecars\").append(data);\n    });\n\n}\n\n\nfunction updateImage(fileIdElement, container) {\n    fileId = $(fileIdElement).val();\n    $.ajax({\n            type: \"GET\",\n            fileId: fileId,\n            fileIdElement: fileIdElement,\n            container: container,\n            url: basePath + \"fileManager/previewImageAvailable/\" + fileId,\n            success: function(data, textStatus) {\n                if (data == \"false\") {\n                    // data.redirect contains the string URL to redirect to\n                    $(container).find(\"img\").attr(\"src\", \"/assets/images/processing.gif\");\n                    $(container).show();\n                    setTimeout(function() {\n                        updateImage(fileIdElement, container);\n                    }, 2000);\n                }\n                else if(data == \"true\") {\n                    $(container).find(\"img\").attr(\"src\", basePath + \"fileManager/previewImageByFileId/\" + this.fileId + \"?\" + Math.random());\n\n                    $.get(basePath+\"fileManager/extractedData/\"+this.fileId,function(data) {\n                        $(container).closest(\".widgetContents\").find(\".extractedData\").val(data);\n                    });\n\n                    $(container).show();\n                }\n                else if(data == \"icon\") {\n                    // if it's an icon, we say true but keep polling\n                    $(container).find(\"img\").attr(\"src\", basePath + \"fileManager/previewImageByFileId/\" + this.fileId);\n                    $(container).show();\n                    setTimeout(function() {\n                        updateImage(fileIdElement, container);\n                    }, 5000);\n                }\n            }\n        });\n}\n\nvar fileObjectPreview = function(targetElement) {\n    var imageContainer = $(targetElement).closest(\".widgetContents\").find(\".imagePreview\");\n    if($(targetElement).val().length>0) {\n        $(\"#collectionId\").attr(\"disabled\", true);\n        $(targetElement).closest('.widgetContents').find(\".file\").attr(\"disabled\", true);\n        var self = targetElement;\n        // updateImage(self,imageContainer);\n        loadSidecars(self);\n    }\n    else {\n        // we emptied the fileObject, let's clear things out.\n        $(targetElement).closest('.widgetContents').find(\".file\").removeAttr(\"disabled\");\n        $(\"#collectionId\").removeAttr(\"disabled\");\n        $(imageContainer).hide();\n    }\n};\n\nvar pollingForNewImage = false;\n\nvar checkForNewImages = function() {\n\tpollingForNewImage = true;\n\n\tcheckArray = new Array();\n\t$(\".imagePreview img\").each(function(index, el) {\n\n\t\tif($(el).data(\"fileready\") !== true) {\n\t\t\tvar fileObjectId = $(el).closest(\".widgetContents\").find(\".fileObjectId\").val();\n\t\t\tif(fileObjectId) {\n\t\t\t\tcheckArray.push(fileObjectId);\t\n\t\t\t}\n\t\t\t\n\t\t}\n\t\telse {\n\t\t\tcontainer = $(el).closest(\".widgetContents\").find(\".imagePreview\");\n\t\t\t$(container).show();\n\t\t}\n\n\t});\n\n\tif(checkArray.length > 0) {\n\t\t$.post(basePath + \"fileManager/previewImageAvailable/\", {checkArray: JSON.stringify(checkArray)}, function(data) {\n\n\t\t\tdecoded = JSON.parse(data);\n\t\t\tif(!decoded) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t$(decoded).each(function(index, content) {\n\n\t\t\t\tcontainer = $('.fileObjectId').filter(function(index) {\n\t\t\t\t\treturn $(this).val() == content.fileId;\n\t\t\t\t}).closest(\".widgetContents\").find(\".imagePreview\");\n\n\t\t\t\tif (content.status == \"false\") {\n\t                // data.redirect contains the string URL to redirect to\n\t                $(container).find(\"img\").attr(\"src\", \"/assets/images/processing.gif\");\n\t                $(container).show();\n\t            }\n\t            else if(content.status == \"true\") {\n\t                $(container).find(\"img\").attr(\"src\", basePath + \"fileManager/previewImageByFileId/\" + content.fileId + \"?\" + Math.random());\n\t                $(container).find(\"img\").data(\"fileready\", true);\n\t                $.get(basePath+\"fileManager/extractedData/\"+content.fileId,function(data) {\n\t                    $(container).closest(\".widgetContents\").find(\".extractedData\").val(data);\n\t                });\n\n\t                $(container).show();\n\t            }\n\t            else if(content.status == \"icon\") {\n\t                // if it's an icon, we say true but keep polling\n\t                if(!$(container).find(\"img\").data(\"icon\")) {\n\t                \t$(container).find(\"img\").data(\"icon\", true);\n\t                \t$(container).find(\"img\").attr(\"src\", basePath + \"fileManager/previewImageByFileId/\" + content.fileId);\n\t                \t$(container).show();\t\n\t                }\n\t                \n\t            }\n\t\t\t});\n\t\t\tsetTimeout(checkForNewImages, 4000);\n\t\t});\n\t}\n\telse {\n\t\tpollingForNewImage = false;\n\t}\n\t\n\n\n\t\n}\n\n\n$(document).on(\"change\", \".fileObjectId\", function() {\n    fileObjectPreview(this);\n    if($(this).val() !== \"\") {\n        submitFormWithDelay(true);\n    }\n    // force a save when the fileobjectId changes\n\n});\n\n$(document).on(\"click\", \".processingLogs\", function(e) {\n     e.preventDefault();\n    var parentElement = $(this).closest(\".widgetContents\");\n    var fileObjectId = $(parentElement).find(\".fileObjectId\").val();\n    var win = window.open(basePath + \"assetManager/processingLogsForAsset/\" + fileObjectId, '_blank');\n    if(win){\n        //Browser has allowed it to be opened\n        win.focus();\n    }\n\n});\n\n$(document).ready(function(){\n    $( \"#collectionId\" ).trigger( \"change\" );\n    $(\".file\").trigger(\"change\");\n    checkForNewImages();\n    $(\".fileObjectId\").each(function(index, el) {\n        // load previews for all our file objects\n        fileObjectPreview(el);\n\n        if($(el).val() !== \"\") {\n            $(el).closest(\".widgetContents\").find(\".deleteFile\").show();\n        }\n\n    });\n\n\n\n    if($(\".allowResume\").length > 0) {\n        $(\".allowResume\").each(function() {\n\n            $(this).closest(\".widgetContents\").find(\".file\").removeAttr(\"disabled\");\n            $(this).closest(\".widgetContents\").find(\".startbutton\").removeAttr(\"disabled\");\n\n        });\n    }\n\n});\n\n$(document).on(\"change\", \".file\", function() {\n    if($(this).val() !== \"\") {\n        $(this).closest(\".widgetContents\").find(\".cancelButton\").show();\n        startUpload(this);\n    }\n    else {\n        $(this).closest(\".widgetContents\").find(\".cancelButton\").hide();\n    }\n\n});\n\n$(document).on(\"click\", \".cancelButton\", function() {\n    var parentElement = $(this).closest(\".widgetContents\");\n    var fileElement = $(parentElement).find(\".file\");\n    var upload = $(fileElement).data(\"uploader\");\n    upload.cancel();\n    window.uploadCount--;\n    $.get(basePath+ 'assetManager/cancelSourceFile/' + $(parentElement).find(\".fileObjectId\").val() , function(data) {\n        $(parentElement).find(\".uploadProgress\").hide();\n    });\n    $(parentElement).find(\".cancelButton\").hide();\n    $(parentElement).find(\".fileObjectId\").val(\"\");\n    $(this).hide();\n    $(fileElement).removeAttr(\"disabled\");\n\n});\n\nfunction startUpload(targetFrame) {\n    // only get the first file for now\n    var collectionId = $(\"#collectionId\").val();\n    var parentElement = $(targetFrame).closest(\".widgetContentsContainer\");\n    var fileElement = $(parentElement).find(\".file\");\n\n    if(!$.isNumeric(collectionId)) {\n        //TODO\n        console.log(\"error\");\n    }\n\n    jQuery.ajaxSetup({async:false}); // run sync so we wait for the next element\n    if($(fileElement).prop(\"files\").length > 1) {\n        target = addAnother(targetFrame, $(fileElement).prop(\"files\").length - 1);    \n    }\n    \n    $(target).find(\".cancelButton\").show();\n\n    jQuery.ajaxSetup({async:true});\n    \n    var responseArray = [];\n    var sendingArray = [];\n    var target = null;\n    $.each($(fileElement).prop(\"files\"), function(index, el) {\n        if(index === 0) { //operate on the real one\n            target = parentElement;\n        }\n        else {\n            target = target.nextAll(\".panel\").eq(0);\n        }\n\n        var file = el;\n        var internalTarget = target;\n        fileObjectId = $(target).find(\".fileObjectId\").val();\n        sendingArray[index] = {index: index, collectionId: collectionId, filename: file.name, fileObjectId: fileObjectId, file:file};\n        responseArray[index] = {index: index, collectionId: collectionId, filename: file.name, fileObjectId: fileObjectId, target: internalTarget, file:file};\n    });\n\n    $.post(basePath+ 'assetManager/getFileContainer', {containers: JSON.stringify(sendingArray)}, function(data, textStatus, xhr) {\n        uploadSettings = $.parseJSON(data);\n\n        $(uploadSettings).each(function(index, item) {\n            var sourceArray = responseArray[item.index];\n            $(fileElement).data('uploader', uploadFile(sourceArray.file, item, sourceArray.target));\n        });\n    \n    });\n\n   \n    return;\n\n\n\n\n}\n"]}