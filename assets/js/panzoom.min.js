(function(b,a){if(typeof define==="function"&&define.amd){define(["jquery","./pointertouch"],function(c){return a(b,c)})}else{if(typeof exports==="object"){a(b,require("jquery"),require("./pointertouch"))}else{a(b,b.jQuery)}}}(typeof window!=="undefined"?window:this,function(f,d){var j=f.document;var r="__pz__";var l=Array.prototype.slice;var g=!!f.PointerEvent;var c=(function(){var s=j.createElement("input");s.setAttribute("oninput","return");return typeof s.oninput==="function"})();var n=/([A-Z])/g;var h=/^http:[\w\.\/]+svg$/;var e=/^inline/;var i="(\\-?[\\d\\.e]+)";var m="\\,?\\s*";var q=new RegExp("^matrix\\("+i+m+i+m+i+m+i+m+i+m+i+"\\)$");function o(u,s){var t=u.length;while(--t){if(+u[t]!==+s[t]){return false}}return true}function p(t){var s={range:true,animate:true};if(typeof t==="boolean"){s.animate=t}else{d.extend(s,t)}return s}function k(A,z,y,x,w,v,u,t,s){if(d.type(A)==="array"){this.elements=[+A[0],+A[2],+A[4],+A[1],+A[3],+A[5],0,0,1]}else{this.elements=[A,z,y,x,w,v,u||0,t||0,s||1]}}k.prototype={x:function(u){var v=u instanceof a;var t=this.elements,s=u.elements;if(v&&s.length===3){return new a(t[0]*s[0]+t[1]*s[1]+t[2]*s[2],t[3]*s[0]+t[4]*s[1]+t[5]*s[2],t[6]*s[0]+t[7]*s[1]+t[8]*s[2])}else{if(s.length===t.length){return new k(t[0]*s[0]+t[1]*s[3]+t[2]*s[6],t[0]*s[1]+t[1]*s[4]+t[2]*s[7],t[0]*s[2]+t[1]*s[5]+t[2]*s[8],t[3]*s[0]+t[4]*s[3]+t[5]*s[6],t[3]*s[1]+t[4]*s[4]+t[5]*s[7],t[3]*s[2]+t[4]*s[5]+t[5]*s[8],t[6]*s[0]+t[7]*s[3]+t[8]*s[6],t[6]*s[1]+t[7]*s[4]+t[8]*s[7],t[6]*s[2]+t[7]*s[5]+t[8]*s[8])}}return false},inverse:function(){var t=1/this.determinant(),s=this.elements;return new k(t*(s[8]*s[4]-s[7]*s[5]),t*(-(s[8]*s[1]-s[7]*s[2])),t*(s[5]*s[1]-s[4]*s[2]),t*(-(s[8]*s[3]-s[6]*s[5])),t*(s[8]*s[0]-s[6]*s[2]),t*(-(s[5]*s[0]-s[3]*s[2])),t*(s[7]*s[3]-s[6]*s[4]),t*(-(s[7]*s[0]-s[6]*s[1])),t*(s[4]*s[0]-s[3]*s[1]))},determinant:function(){var s=this.elements;return s[0]*(s[8]*s[4]-s[7]*s[5])-s[3]*(s[8]*s[1]-s[7]*s[2])+s[6]*(s[5]*s[1]-s[4]*s[2])}};function a(s,u,t){this.elements=[s,u,t]}a.prototype.e=k.prototype.e=function(s){return this.elements[s]};function b(w,u){if(!(this instanceof b)){return new b(w,u)}if(w.nodeType!==1){d.error("Panzoom called on non-Element node")}if(!d.contains(j,w)){d.error("Panzoom element must be attached to the document")}var x=d.data(w,r);if(x){return x}this.options=u=d.extend({},b.defaults,u);this.elem=w;var t=this.$elem=d(w);this.$set=u.$set&&u.$set.length?u.$set:t;this.$doc=d(w.ownerDocument||j);this.$parent=t.parent();this.isSVG=h.test(w.namespaceURI)&&w.nodeName.toLowerCase()!=="svg";this.panning=false;this._buildTransform();this._transform=!this.isSVG&&d.cssProps.transform.replace(n,"-$1").toLowerCase();this._buildTransition();this.resetDimensions();var v=d();var s=this;d.each(["$zoomIn","$zoomOut","$zoomRange","$reset"],function(z,y){s[y]=u[y]||v});this.enable();d.data(w,r,this)}b.rmatrix=q;b.events=d.pointertouch;b.defaults={eventNamespace:".panzoom",transition:true,cursor:"move",disablePan:false,disableZoom:false,increment:0.3,minScale:0.4,maxScale:5,rangeStep:0.05,duration:200,easing:"ease-in-out",contain:false};b.prototype={constructor:b,instance:function(){return this},enable:function(){this._initStyle();this._bind();this.disabled=false},disable:function(){this.disabled=true;this._resetStyle();this._unbind()},isDisabled:function(){return this.disabled},destroy:function(){this.disable();d.removeData(this.elem,r)},resetDimensions:function(){var v=this.$parent;this.container={width:v.innerWidth(),height:v.innerHeight()};var t=v.offset();var u=this.elem;var s=this.$elem;var w;if(this.isSVG){w=u.getBoundingClientRect();w={left:w.left-t.left,top:w.top-t.top,width:w.width,height:w.height,margin:{left:0,top:0}}}else{w={left:d.css(u,"left",true)||0,top:d.css(u,"top",true)||0,width:s.innerWidth(),height:s.innerHeight(),margin:{top:d.css(u,"marginTop",true)||0,left:d.css(u,"marginLeft",true)||0}}}w.widthBorder=(d.css(u,"borderLeftWidth",true)+d.css(u,"borderRightWidth",true))||0;w.heightBorder=(d.css(u,"borderTopWidth",true)+d.css(u,"borderBottomWidth",true))||0;this.dimensions=w},reset:function(t){t=p(t);var s=this.setMatrix(this._origTransform,t);if(!t.silent){this._trigger("reset",s)}},resetZoom:function(t){t=p(t);var s=this.getMatrix(this._origTransform);t.dValue=s[3];this.zoom(s[0],t)},resetPan:function(t){var s=this.getMatrix(this._origTransform);this.pan(s[4],s[5],p(t))},setTransform:function(t){var v=this.isSVG?"attr":"style";var s=this.$set;var u=s.length;while(u--){d[v](s[u],"transform",t)}},getTransform:function(t){var s=this.$set;var u=s[0];if(t){this.setTransform(t)}else{t=d[this.isSVG?"attr":"style"](u,"transform")}if(t!=="none"&&!q.test(t)){this.setTransform(t=d.css(u,"transform"))}return t||"none"},getMatrix:function(t){var s=q.exec(t||this.getTransform());if(s){s.shift()}return s||[1,0,0,1,0,0]},setMatrix:function(B,G){if(this.disabled){return}if(!G){G={}}if(typeof B==="string"){B=this.getMatrix(B)}var C,s,F,y,D,x,u,A,t,E;var v=+B[0];var w=this.$parent;var z=typeof G.contain!=="undefined"?G.contain:this.options.contain;if(z){C=this._checkDims();s=this.container;t=C.width+C.widthBorder;E=C.height+C.heightBorder;F=((t*Math.abs(v))-s.width)/2;y=((E*Math.abs(v))-s.height)/2;u=C.left+C.margin.left;A=C.top+C.margin.top;if(z==="invert"){D=t>s.width?t-s.width:0;x=E>s.height?E-s.height:0;F+=(s.width-t)/2;y+=(s.height-E)/2;B[4]=Math.max(Math.min(B[4],F-u),-F-u-D);B[5]=Math.max(Math.min(B[5],y-A),-y-A-x+C.heightBorder)}else{y+=C.heightBorder/2;D=s.width>t?s.width-t:0;x=s.height>E?s.height-E:0;if(w.css("textAlign")!=="center"||!e.test(d.css(this.elem,"display"))){F=y=0}else{D=0}B[4]=Math.min(Math.max(B[4],F-u),-F-u+D);B[5]=Math.min(Math.max(B[5],y-A),-y-A+x)}}if(G.animate!=="skip"){this.transition(!G.animate)}if(G.range){this.$zoomRange.val(v)}this.setTransform("matrix("+B.join(",")+")");if(!G.silent){this._trigger("change",B)}return B},isPanning:function(){return this.panning},transition:function(v){if(!this._transition){return}var u=v||!this.options.transition?"none":this._transition;var s=this.$set;var t=s.length;while(t--){if(d.style(s[t],"transition")!==u){d.style(s[t],"transition",u)}}},pan:function(s,v,u){if(this.options.disablePan){return}if(!u){u={}}var t=u.matrix;if(!t){t=this.getMatrix()}if(u.relative){s+=+t[4];v+=+t[5]}t[4]=s;t[5]=v;this.setMatrix(t,u);if(!u.silent){this._trigger("pan",t[4],t[5])}},zoom:function(z,s){if(typeof z==="object"){s=z;z=null}else{if(!s){s={}}}var G=d.extend({},this.options,s);if(G.disableZoom){return}var v=false;var D=G.matrix||this.getMatrix();if(typeof z!=="number"){z=+D[0]+(G.increment*(z?-1:1));v=true}if(z>G.maxScale){z=G.maxScale}else{if(z<G.minScale){z=G.minScale}}var y=G.focal;if(y&&!G.disablePan){var E=this._checkDims();var u=y.clientX;var t=y.clientY;if(!this.isSVG){u-=(E.width+E.widthBorder)/2;t-=(E.height+E.heightBorder)/2}var x=new a(u,t,1);var B=new k(D);var w=this.parentOffset||this.$parent.offset();var F=new k(1,0,w.left-this.$doc.scrollLeft(),0,1,w.top-this.$doc.scrollTop());var A=B.inverse().x(F.inverse().x(x));var C=z/D[0];B=B.x(new k([C,0,0,C,0,0]));x=F.x(B.x(A));D[4]=+D[4]+(u-x.e(0));D[5]=+D[5]+(t-x.e(1))}D[0]=z;D[3]=typeof G.dValue==="number"?G.dValue:z;this.setMatrix(D,{animate:typeof G.animate==="boolean"?G.animate:v,range:!G.noSetRange});if(!G.silent){this._trigger("zoom",D[0],G)}},option:function(t,u){var s;if(!t){return d.extend({},this.options)}if(typeof t==="string"){if(arguments.length===1){return this.options[t]!==undefined?this.options[t]:null}s={};s[t]=u}else{s=t}this._setOptions(s)},_setOptions:function(s){d.each(s,d.proxy(function(t,u){switch(t){case"disablePan":this._resetStyle();case"$zoomIn":case"$zoomOut":case"$zoomRange":case"$reset":case"disableZoom":case"onStart":case"onChange":case"onZoom":case"onPan":case"onEnd":case"onReset":case"eventNamespace":this._unbind()}this.options[t]=u;switch(t){case"disablePan":this._initStyle();case"$zoomIn":case"$zoomOut":case"$zoomRange":case"$reset":this[t]=u;case"disableZoom":case"onStart":case"onChange":case"onZoom":case"onPan":case"onEnd":case"onReset":case"eventNamespace":this._bind();break;case"cursor":d.style(this.elem,"cursor",u);break;case"minScale":this.$zoomRange.attr("min",u);break;case"maxScale":this.$zoomRange.attr("max",u);break;case"rangeStep":this.$zoomRange.attr("step",u);break;case"startTransform":this._buildTransform();break;case"duration":case"easing":this._buildTransition();case"transition":this.transition();break;case"$set":if(u instanceof d&&u.length){this.$set=u;this._initStyle();this._buildTransform()}}},this))},_initStyle:function(){var s={"backface-visibility":"hidden","transform-origin":this.isSVG?"0 0":"50% 50%"};if(!this.options.disablePan){s.cursor=this.options.cursor}this.$set.css(s);var t=this.$parent;if(t.length&&!d.nodeName(t[0],"body")){s={overflow:"hidden"};if(t.css("position")==="static"){s.position="relative"}t.css(s)}},_resetStyle:function(){this.$elem.css({cursor:"",transition:""});this.$parent.css({overflow:"",position:""})},_bind:function(){var A=this;var B=this.options;var v=B.eventNamespace;var y=g?"pointerdown"+v:("touchstart"+v+" mousedown"+v);var w=g?"pointerup"+v:("touchend"+v+" click"+v);var z={};var t=this.$reset;var u=this.$zoomRange;d.each(["Start","Change","Zoom","Pan","End","Reset"],function(){var C=B["on"+this];if(d.isFunction(C)){z["panzoom"+this.toLowerCase()+v]=C}});if(!B.disablePan||!B.disableZoom){z[y]=function(D){var C;if(D.type==="touchstart"?(C=D.touches)&&((C.length===1&&!B.disablePan)||C.length===2):!B.disablePan&&D.which===1){D.preventDefault();D.stopPropagation();A._startMove(D,C)}}}this.$elem.on(z);if(t.length){t.on(w,function(C){C.preventDefault();A.reset()})}if(u.length){u.attr({step:B.rangeStep===b.defaults.rangeStep&&u.attr("step")||B.rangeStep,min:B.minScale,max:B.maxScale}).prop({value:this.getMatrix()[0]})}if(B.disableZoom){return}var x=this.$zoomIn;var s=this.$zoomOut;if(x.length&&s.length){x.on(w,function(C){C.preventDefault();A.zoom()});s.on(w,function(C){C.preventDefault();A.zoom(true)})}if(u.length){z={};z[(g?"pointerdown":"mousedown")+v]=function(){A.transition(true)};z[(c?"input":"change")+v]=function(){A.zoom(+this.value,{noSetRange:true})};u.on(z)}},_unbind:function(){this.$elem.add(this.$zoomIn).add(this.$zoomOut).add(this.$reset).off(this.options.eventNamespace)},_buildTransform:function(){return this._origTransform=this.getTransform(this.options.startTransform)},_buildTransition:function(){if(this._transform){var s=this.options;this._transition=this._transform+" "+s.duration+"ms "+s.easing}},_checkDims:function(){var s=this.dimensions;if(!s.width||!s.height){this.resetDimensions()}return this.dimensions},_getDistance:function(u){var t=u[0];var s=u[1];return Math.sqrt(Math.pow(Math.abs(s.clientX-t.clientX),2)+Math.pow(Math.abs(s.clientY-t.clientY),2))},_getMiddle:function(u){var t=u[0];var s=u[1];return{clientX:((s.clientX-t.clientX)/2)+t.clientX,clientY:((s.clientY-t.clientY)/2)+t.clientY}},_trigger:function(s){if(typeof s==="string"){s="panzoom"+s}this.$elem.triggerHandler(s,[this].concat(l.call(arguments,1)))},_startMove:function(D,w){var z,s,x,A,E,v,H,F;var y=this;var u=this.options;var J=u.eventNamespace;var C=this.getMatrix();var B=C.slice(0);var I=+B[4];var G=+B[5];var t={matrix:C,animate:"skip"};if(g){s="pointermove";x="pointerup"}else{if(D.type==="touchstart"){s="touchmove";x="touchend"}else{s="mousemove";x="mouseup"}}s+=J;x+=J;this.transition(true);this.panning=true;this._trigger("start",D,w);if(w&&w.length===2){A=this._getDistance(w);E=+C[0];v=this._getMiddle(w);z=function(M){M.preventDefault();var K=y._getMiddle(w=M.touches);var L=y._getDistance(w)-A;y.zoom(L*(u.increment/100)+E,{focal:K,matrix:C,animate:false});y.pan(+C[4]+K.clientX-v.clientX,+C[5]+K.clientY-v.clientY,t);v=K}}else{H=D.pageX;F=D.pageY;z=function(K){K.preventDefault();y.pan(I+K.pageX-H,G+K.pageY-F,t)}}d(j).off(J).on(s,z).on(x,function(K){K.preventDefault();d(this).off(J);y.panning=false;K.type="panzoomend";y._trigger(K,C,!o(C,B))})}};d.Panzoom=b;d.fn.panzoom=function(w){var t,v,s,u;if(typeof w==="string"){u=[];v=l.call(arguments,1);this.each(function(){t=d.data(this,r);if(!t){u.push(undefined)}else{if(w.charAt(0)!=="_"&&typeof(s=t[w])==="function"&&(s=s.apply(t,v))!==undefined){u.push(s)}}});return u.length?(u.length===1?u[0]:u):this}return this.each(function(){new b(this,w)})};return b}));