var MarkerSource;var MarkerTemplate;var cachedResults="";var cachedDates=null;var searchId;var currentPageNumber;var eventSource;var resultsAvailable=true;var previousEventComplete=true;var dataAvailable=true;var disableHashChange=false;$(document).ready(function(){$(window).scroll(function(){if(resultsAvailable&&$(document).height()-50<=$(window).scrollTop()+$(window).height()){if(($(".nav-tabs .active").text()=="Grid"||$(".nav-tabs .active").text()=="List")&&previousEventComplete&&dataAvailable){doSearch(searchId,currentPageNumber+1)}}});$(window).bind("hashchange",function(a){parseHash()});setTimeout(function(){$.getScript("/assets/timeline_js/ext/geochrono/geochrono-api.js")},1000);$(".searchText").on("blur",function(){$(".advancedSearchText").val($(".searchText").val())});$(".advancedSearchText").on("blur",function(){$(".searchText").val($(".advancedSearchText").val())});$('a[href="#timeline"]').on("shown.bs.tab",function(){cachedDates=null;prepTimeline()});$('a[href="#map"]').on("shown.bs.tab",function(){prepMap()});$('a[href="#gallery"]').on("shown.bs.tab",function(){prepGallery()});$('a[href="#grid"]').on("shown.bs.tab",function(){$("#results").find("img").trigger("show")});$('a[href="#list"]').on("shown.bs.tab",function(){$("#listResults").find("img").trigger("show")});$(".previousPage").on("click",function(){doSearch(searchId,currentPageNumber-1);return false});$(".nextPage").on("click",function(){doSearch(searchId,currentPageNumber+1);return false});MarkerSource=$("#marker-template").html();MarkerTemplate=Handlebars.compile(MarkerSource)});function parseHash(){if(window.location.hash.length>0&&!disableHashChange){$("#results").empty();$("#listResults").empty();searchId=window.location.hash.substring(1);doSearch(searchId,0)}}function doSearch(c,a,b){previousEventComplete=false;currentPageNumber=a;b=(b)?"true":"false";$.get(basePath+"search/searchResults/"+c+"/"+a+"/"+b,function(g){var f=[];try{if(cachedResults){f=cachedResults.matches}cachedResults=$.parseJSON(g)}catch(h){alert(h+" "+g)}if(cachedResults.success===true){if(cachedResults.totalResults==1){var d=cachedResults.matches[0].objectId;$.cookie("lastSearch",c);window.location.hash="";window.location.pathname=basePath+"/asset/viewAsset/"+d}processSearchResults(cachedResults);newArray=$.merge(cachedResults.matches,f);cachedResults.matches=newArray}})}function processSearchResults(a){populateSearchFields(a.searchEntry);populateSearchResults(a);if(a.matches.length===0){dataAvailable=false}previousEventComplete=true}$(document).on("click",".assetLink",function(){$.cookie("lastSearch",searchId)});$(document).on("click",".useSuggest",function(){$(".searchText").val($(this).text());$(".searchForm").submit()});$(document).on("click","#loadAllResults",function(a){a.preventDefault();if(dataAvailable){doSearch(searchId,currentPageNumber+1,true);dataAvailable=false;$("#loadAllResults").hide()}});function getSuggestions(a){var b=a;$.post(basePath+"search/getSuggestion",{searchTerm:a},function(g,h){var f=$.parseJSON(g);if(f.length===0){return}$.each(f,function(i,k){var j=new RegExp(i,"ig");b=b.replace(j,k)});var d=$("<a>").addClass("useSuggest").append(b);var c=$("<i>").append(d);var e=$("<div>").addClass("col-sm-12 suggestionText").append("Did you mean: ").append(c).append(" ?");$(".suggest").empty();$(".suggest").append(e)})}function populateSearchFields(a){$(".collectionSelector").prop("checked",false);$("#showHidden").prop("checked",false);$(".advancedOption").val();if(a.searchText.length>0){getSuggestions(a.searchText)}$.each(a,function(b,c){$("#"+b).val(c)})}function populateSearchResults(a){var d=$(targetTemplate).html();var c=Handlebars.compile(d);var e=$(listTemplate).html();var b=Handlebars.compile(e);$.each(a.matches,function(g,i){i.base_url=basePath;i.searchObject=a;var h=c(i);var f=b(i);$("#results").append(h);$("#listResults").append(f)});if($('a[href="#map"]').parent().hasClass("active")){prepMap()}if($('a[href="#timeline"]').parent().hasClass("active")){prepTimeline()}if($('a[href="#gallery"]').parent().hasClass("active")){prepGallery()}if($('a[href="#grid"]').parent().hasClass("active")){$("#results").find("img").each(function(f,g){$(g).on("load",function(){if(Retina.isRetina()){$(g).removeAttr("width").removeAttr("height");new RetinaImage(g)}})})}else{$("#results").find("img").each(function(f,g){$(g).on("show",function(){if(Retina.isRetina()){$(g).removeAttr("width").removeAttr("height");new RetinaImage(g)}})})}if($('a[href="#list"]').parent().hasClass("active")){$("#listResults").find("img").each(function(f,g){$(g).on("load",function(){if(Retina.isRetina()){$(g).removeAttr("width").removeAttr("height");new RetinaImage(g)}})})}else{$("#listResults").find("img").each(function(f,g){$(g).on("show",function(){$(g).removeAttr("width").removeAttr("height");if(Retina.isRetina()){$(g).removeAttr("width").removeAttr("height");new RetinaImage(g)}})})}$(".resultsData").html("<p>Total Results: "+a.totalResults+"</p>");if(dataAvailable&&a.matches.length<a.totalResults&&a.totalResults<1000){$(".resultsData p").append(" <a href='' id='loadAllResults'>[Load All]</a>")}if(a.totalResults>a.matches.length){$(".paginationBlock").show();resultsAvailable=true}else{$(".paginationBlock").hide();resultsAvailable=false}}function prepGallery(){var a=[];$.each(cachedResults.matches,function(b,c){c.base_url=basePath;c.searchObject=cachedResults;a.push({image:basePath+"fileManager/bestDerivativeByObjectId/"+c.objectId+"/true",thumb:basePath+"fileManager/previewImage/"+c.objectId,title:c.title,link:basePath+"asset/viewAsset/"+c.objectId})});Galleria.loadTheme("/assets/themes/twelve/galleria.twelve.min.js");$("#galleryFrame").galleria({data_source:a,imageCrop:false,imageTimeout:90000,popupLinks:true,extend:function(b){this.attachKeyboard({left:this.prev,right:this.next,});this.setPlaytime(8000);this.setOptions("showInfo",false);this.bind("fullscreen_enter",function(){this.$("info").hide()});this.bind("fullscreen_exit",function(){this.$("info").show()})}})}function prepMap(){$("#mapPane").removeData();$("#mapPane").goMap({mapTypeControl:true,maptype:"ROADMAP",mapTypeControlOptions:{position:"TOP_RIGHT",style:"DROPDOWN_MENU"},addMarker:"single"});if($.goMap.getMarkerCount()>0){$.goMap.clearMarkers()}$.each(cachedResults.matches,function(e,f){if(f.locations){$.each(f.locations,function(h,g){$.each(g.entries,function(m,o){loc=o.loc.coordinates;f.base_url=basePath;var k=MarkerTemplate(f);var i=$.goMap.getMarkers("markers");latlng=new google.maps.LatLng(loc[1],loc[0]);finalLatLng=latlng;if(i.length!=0){for(c=0;c<i.length;c++){var l=i[c];var q=l.getPosition();if(google.maps.geometry.spherical.computeDistanceBetween(latlng,q)<1){var n=latlng.lat()+(Math.random()-0.5)/5500;var p=latlng.lng()+(Math.random()-0.5)/5500;finalLatLng=new google.maps.LatLng(n,p)}}}else{finalLatLng=latlng}var j=$.goMap.createMarker({longitude:finalLatLng.lng(),latitude:finalLatLng.lat(),html:k})})})}});var d=[];for(var c in $.goMap.markers){var b=$($.goMap.mapId).data($.goMap.markers[c]);d.push(b)}var a=new MarkerClusterer($.goMap.map,d);$.goMap.fitBounds()}function prepTimeline(){var e=null;var n=null;if(Timeline===undefined||Timeline.DateTime===undefined||Timeline.DefaultEventSource===undefined||Timeline.strings===undefined||Timeline.GregorianDateLabeller.monthNames===undefined){setTimeout(function(){prepTimeline()},1000);return}$("#timelinePane").empty();var i=false;if(cachedDates===null){cachedDates={events:[]};$.each(cachedResults.matches,function(d,o){if(o.dates){$.each(o.dates,function(q,p){$.each(p.dateAsset,function(s,r){if(r.start){startTime=parseInt(r.start.numeric,10);if(startTime<-6373557595440){i=true}}})})}});$.each(cachedResults.matches,function(d,o){if(o.dates){$.each(o.dates,function(q,p){$.each(p.dateAsset,function(v,r){if(r.start){var x=null;var u=null;var y=null;var s=null;var w=null;x=parseInt(r.start.numeric,10);if(i){y=Timeline.GeochronoUnit.wrapMA(Math.abs(x/31556900000000))}else{w=new Date(1970,0,1);w.setSeconds(x);y=Date.utc.create(w)}formattedValue={miscData:o,title:o.title,id:"/en/"+o.objectId,start:y,image:basePath+"testController/previewImage/"+o.objectId,link:basePath+"testController/viewAsset/"+o.objectId,description:"Caption goeshere"};if(r.end.numeric.length>0){u=parseInt(r.end.numeric,10);if(i){s=Timeline.GeochronoUnit.wrapMA(Math.abs(u/31556900000000))}else{w=new Date(1970,0,1);w.setSeconds(u);s=Date.utc.create(w)}formattedValue.end=s;formattedValue.durationEvent=true}if(e===null||x<e){e=x}if(n===null||x>n){n=x}if(u>n){n=u}cachedDates.events.push(formattedValue)}})})}})}if(eventSource){eventSource.clear()}var b=Timeline.DefaultEventSource.Event.prototype.fillInfoBubble;Timeline.DefaultEventSource.Event.prototype.fillInfoBubble=function(o,p,q){var d=this;var r=document.createElement("div");r.innerHTML=MarkerTemplate(d._obj.miscData);o.appendChild(r)};if(i){eventSource=new Timeline.DefaultEventSource(new SimileAjax.EventIndex(Timeline.GeochronoUnit))}else{eventSource=new Timeline.DefaultEventSource(0)}eventSource.loadJSON(cachedDates,"localJson");var c=Timeline.ClassicTheme.create();var h=null;var j=null;if(i){j=Math.abs(((e+n)/2)/31556900000000);h=Timeline.GeochronoUnit.wrapMA(j)}else{j=(e+n)/2;var m=new Date(1970,0,1);m.setSeconds(j);h=Date.create(m)}var f=n-e;var g=null;var k=null;var a=200;if(f<60*60){g=Timeline.DateTime.MINUTE;k=Timeline.DateTime.HOUR}else{if(f<60*60*24){g=Timeline.DateTime.HOUR;k=Timeline.DateTime.DAY}else{if(f<60*60*24*30){g=Timeline.DateTime.DAY;k=Timeline.DateTime.MONTH}else{if(f<60*60*24*30*12){g=Timeline.DateTime.MONTH;k=Timeline.DateTime.YEAR}else{if(f<60*60*24*30*12*10){g=Timeline.DateTime.YEAR;k=Timeline.DateTime.DECADE}else{if(f<60*60*24*30*12*10*10){g=Timeline.DateTime.DECADE;k=Timeline.DateTime.CENTURY}else{if(f<60*60*24*30*12*10*10*10){g=Timeline.DateTime.CENTURY;k=Timeline.DateTime.MILLENNIUM}else{g=Timeline.DateTime.MILLENNIUM;k=Timeline.DateTime.MILLENNIUM;a=80}}}}}}}if(i){g=Timeline.GeochronoUnit.MA;k=Timeline.GeochronoUnit.EPOCH}SimileAjax.History.enabled=false;var l;if(i){l=[Timeline.Geochrono.createBandInfo({eventSource:eventSource,timeZone:-1*(new Date().getTimezoneOffset()/60),date:h,width:"86%",intervalUnit:g,intervalPixels:100,trackGap:0.2,trackHeight:1.3,theme:c,eventPainter:Timeline.CompactEventPainter,eventPainterParams:{iconLabelGap:5,labelRightMargin:20,iconWidth:80,iconHeight:80,stackConcurrentPreciseInstantEvents:{limit:5,moreMessageTemplate:"%0 More Events",icon:"no-image-80.png",iconWidth:80,iconHeight:80}}}),Timeline.Geochrono.createBandInfo({width:"10%",timeZone:-1*(new Date().getTimezoneOffset()/60),intervalUnit:k,intervalPixels:a,eventSource:eventSource,date:h,theme:c,overview:"overview"})];l[1].syncWith=0;l[1].highlight=true}else{l=[Timeline.createBandInfo({width:"90%",intervalUnit:g,timeZone:-1*(new Date().getTimezoneOffset()/60),intervalPixels:200,eventSource:eventSource,date:h,theme:c,eventPainter:Timeline.CompactEventPainter,eventPainterParams:{iconLabelGap:5,labelRightMargin:20,iconWidth:80,iconHeight:80,stackConcurrentPreciseInstantEvents:{limit:5,moreMessageTemplate:"%0 More Events",icon:"/assets/timeline_js/images/blue-circle.png",iconWidth:80,iconHeight:80}}}),Timeline.createBandInfo({width:"10%",timeZone:-1*(new Date().getTimezoneOffset()/60),intervalUnit:k,intervalPixels:a,eventSource:eventSource,date:h,theme:c,overview:"overview"})];l[1].syncWith=0;l[1].highlight=true}if(i){tl=Timeline.create(document.getElementById("timelinePane"),l,Timeline.HORIZONTAL,Timeline.GeochronoUnit)}else{tl=Timeline.create(document.getElementById("timelinePane"),l,Timeline.HORIZONTAL)}}var targetTemplate="#result-template";var listTemplate="#list-template";$(document).on("click",".addAnotherSpecific",function(){var b=$(this).closest(".specificSearch");var a=$(b).clone(false);a.find("input[type='text']").val("");$(b).after(a)});$(document).on("click",".addAnotherCollection",function(){var b=$(this).closest(".form-group");var a=$(b).clone(false).find("input[type='text']").val("");$(b).after(a)});$(document).on("change",".searchDropdown",function(){var b=$(this).find(":selected");var c=$(b).val();var a=$(b).data("templateid");var d=$(this).closest(".form-group").find(".specificSearchTextContainer");$.post("/search/getFieldInfo",{fieldTitle:c,template:a},function(g,j,i){var f;try{f=$.parseJSON(g)}catch(h){console.log("error occurred")}if(f.type=="text"){$(d).html("");$(d).html('<input type="text" name="specificSearchText[]"  autocomplete="off" class="form-control advancedOption advancedSearchContent" value="">')}else{$(d).html("");$(d).html('<select name="specificSearchText[]"  autocomplete="off" class="form-control advancedOption advancedSearchContent">');selectElement=$(d).find("select");$.each(f.values,function(e,k){$(selectElement).append($("<option>",{value:k}).text(k))})}})});$(document).ready(function(){parseHash();$(document).on("submit",".searchForm",function(){$("#results").empty();$("#listResults").empty();$(".suggest").empty();searchId="";if(window.location.hash.length>0){}currentPageNumber=0;previousEventComplete=false;$.post(basePath+"search/searchResults/"+searchId,{searchQuery:JSON.stringify($(this).serializeForm())},function(b){try{cachedResults=$.parseJSON(b);cachedDates=null}catch(c){alert(c+" "+b)}if(cachedResults.success===true){if(cachedResults.matches.length==1){var a=cachedResults.matches[0].objectId;$.cookie("lastSearch",searchId);window.location.hash="";window.location.pathname=basePath+"/asset/viewAsset/"+a}searchId=cachedResults.searchId;disableHashChange=true;window.location.hash=searchId;dataAvailable=true;$("#loadAllResults").show();processSearchResults(cachedResults);setTimeout(function(){disableHashChange=false},500);if($("#advancedSearchModal").hasClass("in")){$("#advancedSearchModal").modal("hide")}}});return false})});