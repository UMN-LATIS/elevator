/*************************************************************************/
/*                                                                       */
/*  WebMultiRes                                                          */
/*  JavaScript 3D Graphics Library on top of SpiderGL for web            */
/*  visualization of high resolution RTI images                          */
/*                                                                       */
/*  Copyright (C) 2013-2015                                              */
/*  Gianpaolo Palma                                                      */
/*  Visual Computing Laboratory                                          */
/*  ISTI - Italian National Research Council (CNR)                       */
/*  http://vcg.isti.cnr.it/rti/webviewer.php                             */
/*  mailto: gianpaolo[DOT]palma[AT]isti[DOT]cnr[DOT]it                   */
/*                                                                       */
/*                                                                       */
/*  This program is free software: you can redistribute it and/or modify */
/*  it under the terms of the GNU General Public License as published by */
/*  the Free Software Foundation, either version 3 of the License, or    */
/*  (at your option) any later version.                                  */
/*                                                                       */
/*  This program is distributed in the hope that it will be useful,      */
/*  but WITHOUT ANY WARRANTY; without even the implied warranty of       */
/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        */
/*  GNU General Public License for more details.                         */
/*                                                                       */ 
/*  You should have received a copy of the GNU General Public License    */
/*  along with this program.  If not, see <http://www.gnu.org/licenses/> */
/*************************************************************************/

function createRtiViewer(e,t,i,r){function s(){var t=document.getElementById(e+"_div");t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.msRequestFullscreen&&t.msRequestFullscreen(),t.style.height=screen.height+"px",t.style.width=screen.width+"px";var i=$("#"+e+"_webgl");i.height(screen.height),i.width(screen.width),i.attr("width",screen.width),i.attr("height",screen.height),b.resize(),h=!0;var r={label:"Exit Fullscreen",icons:{primary:"fullOnIcon toolbarIcon"}};$("#"+e+"_div #fullscreen").button("option",r)}function n(){var t=document.getElementById(e+"_div");document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),t.style.height=o+"px",t.style.width=l+"px";var i=$("#"+e+"_webgl");i.height(o),i.width(l),i.attr("width",l),i.attr("height",o),b.resize(),h=!1;var r={label:"Active Fullscreen",icons:{primary:"fullIcon toolbarIcon"}};$("#"+e+"_div #fullscreen").button("option",r)}function a(t){"IMAGE"==t&&$("#"+e+"_div #light").css("display","none"),$(".toolbar").css("visibility","visible")}var o=r,l=i,h=!1,d=$($("#"+e)[0]),u=document.createElement("div");u.id=e+"_div",u.style.height=r+"px",u.style.width=i+"px",u.style.margin="auto",u.style.position="relative",d.append(u);var c=$($("#"+e+"_div")[0]),m=e+"_webgl",g=document.createElement("canvas");g.id=m,g.width=i,g.height=r,c.append(g);var f=document.createElement("a");f.href="http://vcg.isti.cnr.it/rti/webviewer.php",f.target="_blank";var p=document.createElement("div");p.style.width="80px",p.style.height="50px",f.appendChild(p),f.style.position="absolute",f.style.bottom="0px",f.style.left="0px",f.style.cssFloat="left",c.append(f);var _=document.createElement("div");_.setAttribute("class","toolbar"),_.style.position="absolute",_.style.top="10px",_.style.left="10px",_.style.cssFloat="left",_.style.width="40px",_.style.height="200px",_.style.visibility="hidden",_.innerHTML='<button class = "toolbarButton" id = "zoomIn"></button><button class = "toolbarButton" id = "zoomOut"></button><button class = "toolbarButton" id = "light"></button><button class = "toolbarButton" id = "fullscreen"></button><button class = "toolbarButton" id = "help"></button>',c.append(_);var v=document.createElement("div");v.id=e+"_guide",v.style.width="100%",v.style.height="100%",v.style.position="absolute",v.style.left="0px",v.style.top="0px",v.style.color="#FFFFFF",v.style.backgroundColor="rgba(0, 0, 0, 0.9)",v.innerHTML='<div id = "guideTable"><div id = "guideCell"> <div id = "guideList"><h3>WebRTIViewer<br/></h3><ul><li>Pan: LeftMouseButton + MouseMove.</li><li>Zoom in: MouseWhell or press the button <span><img src = "css/icons/zoomin.png" alt=""/></span></li><li>Zoom out: MouseWheel or press the button <span><img src = "css/icons/zoomout.png" alt=""/></span></li><li>To change the light direction: activate the light with the button <span><img src = "css/icons/light.png" alt=""/></span> and press LeftMouseButton + MouseMove or Ctrl + LeftMouseButton + MouseMove.</li><li>Fullscreen: press the button <span><img src = "css/icons/full.png" alt=""/></span> to active the fullscreen mode and the button <span><img src = "css/icons/full_on.png" alt=""/></span> to exit</li><li>To reset the viewpoint: press R.</li></ul><a href="http://vcg.isti.cnr.it/rti/webviewer.php" target = "_black">Visual Computing Lab ISTI CNR Pisa</a></div></div></div>',v.style.display="none",c.append(v),$("#"+e+"_div #zoomIn").button({icons:{primary:"zoomInIcon toolbarIcon"},text:!1,label:"Zoom In"}).click(function(){b.startZoomIn()}),$("#"+e+"_div #zoomOut").button({icons:{primary:"zoomOutIcon toolbarIcon"},text:!1,label:"Zoom Out"}).click(function(){b.startZoomOut()}),$("#"+e+"_div #light").button({icons:{primary:"lightIcon toolbarIcon"},text:!1,label:"Light Off"}).click(function(){var e;"Light Off"==$(this).text()?(e={label:"Light On",icons:{primary:"lightOnIcon toolbarIcon"}},b.setMode(1)):(e={label:"Light Off",icons:{primary:"lightIcon toolbarIcon"}},b.setMode(0)),$(this).button("option",e)}),$("#"+e+"_div #help").button({icons:{primary:"helpIcon toolbarIcon"},text:!1,label:"Help"}).click(function(){$("#"+e+"_guide").show()}),$("#"+e+"_div #fullscreen").button({icons:{primary:"fullIcon toolbarIcon"},text:!1,label:"Active Fullscreen"}).click(function(){h?n():s(),$("#"+e+"_div #fullscreen").removeClass("ui-state-hover")}),document.addEventListener("MSFullscreenChange",function(){document.msFullscreenElement||n()},!1),document.addEventListener("mozfullscreenchange",function(){document.mozFullScreen||n()},!1),document.addEventListener("webkitfullscreenchange",function(){document.webkitIsFullScreen||n()},!1),$("#"+e+"_guide").click(function(){$("#"+e+"_guide").hide()});var x=document.createElement("div");if(x.id=e+"_error",x.style.width="100%",x.style.height="100%",x.style.position="absolute",x.style.left="0px",x.style.top="0px",x.style.color="#FFFFFF",x.style.backgroundColor="rgba(0, 0, 0, 1.0)",x.innerHTML='<canvas id = "testCanvas" width= "800" height= "600" contenteditable="true"></canvas>',x.style.display="none",c.append(x),null==sglGetCanvasContext("testCanvas"))x.style.display="block",x.innerHTML='<div id = "contentError" style = "width: 90%; height: 100%; text-align:left; padding:0% 5% 0% 5%; font-family:  Verdana,sans-serif; overflow-y: scroll;"><h3>WebGL is not available or not enabled.</h3><p><a href="http://en.wikipedia.org/wiki/WebGL">WebGL</a> is the technology we use to display the RTI images. It is currently supported, but sometimes not enabled by default, by recent versions of <a href="http://www.mozilla.org/firefox">Firefox</a>, <a href="http://www.google.com/chrome">Chrome</a> and <a href="http://www.apple.com/safari">Safari</a>. An external plugins is available for <a href="http://microsoft.com/ie">Internet  Explorer</a>.<br/> It also requires a moderately recent and capable hardware and up to date drivers.</p><p><b>Chrome</b><br/>Type "chrome://flags" in the address bar.<br/>Disable (yes, it is a confusing double negation!) the WebGL entry.<br/>Click the <em>relaunch now</em> button at the bottom.</p><p><b>Firefox</b><br/>Type "about:config" in the address bar<br/>Type "webgl" in the <em>Filter</em>.<br/>Doubleclick the entry <b>webgl.force-enable</b>, and restart Firefox.</p><p><b>Safari</b><br/>Open the Safari menu and select Preferences.<br/>Then, click the Advanced tab in the Preferences window.<br/>Then, at the bottom of the window, check the Show Develop menu in menu bar checkbox.<br/>Then, open the Develop menu in the menu bar and select Enable WebGL.</p><p><b>Internet Explorer (from version 9.0)</b><br/>Install the <a href="http://www.google.com/chromeframe">Chrome Frame</a> <br/>Open the Tools menu and select Manage add-ons.<br/>Then, enable the ChromeFrame BHO plugins and restart Internet Explorer.<br/></p><p><b>Installing updated drivers</b><br/>If the visualization of the RTI image fails you must update the drivers of your graphics cards.</p></div>';else{x.innerHTML="";var b=new MultiRes(m);b.setImageUrl(t),b.setOnLoadImageCallback(a),sglRegisterCanvas(m,b,10)}}function log(){}function MultiRes(e){this.mode=0,this.stepAnimation=0,this.idTimer,this.flipAngles=[],this.flipAngles[0]=0,this.canvas=e,this.rendering=!1,this.onDrawCallback=null,this.animating=!1,this.moveToCenter=!1,this.imageUrl="",this.OnLoadImageCallback=null,this.currentSpeed=0,this.maxStep=7,this.animationStack=[],this.isMoving=!1;for(var t=1;21>t;t++)this.flipAngles[t]=SGL_PI/2*Math.sin(t/40*SGL_PI)}function MultiResNode(){this.id=0,this.parentIndex=-1,this.childrenIndices=[-1,-1,-1,-1],this.projectedSize=1,this.zScale=1,this.box=new SglBox3,this.priority={timestamp:-1,error:Number.MAX_VALUE},this.req=null,this.data=null,this.isLeaf=!0}function MultiResTree(e,t){this.ready=!0,this.nodesCount=0,this.rootIndex=-1,this.nodes=null,this.url=null,this.tileSize=0,this.scale=[1,1,1],this.offset=[0,0,0],this.forma="",e&&this.load(e,imgW,imgH,t)}function _MultiResAssert(e){e||alert("MultiResAssert FAILED : "+e)}function _MultiResCompareNodes(e,t){return e.priority.timestamp!=t.priority.timestamp?t.priority.timestamp-e.priority.timestamp:e.priority.error!=t.priority.error?t.priority.error-e.priority.error:e.id-t.id}function MultiResRenderer(e,t){this.lg=!0,this.gl=e,this._tree=new MultiResTree,this._timestamp=0,this._frustum=new SglFrustum,this._maxError=1,this._cache=[],this._cacheSizeInBytes=t,this._maxCacheSize=1,this._maxOngoingRequests=2,this._currentOngoingRequests=0,this._toRequest=[],this._toRenderFullRes=[],this._toRenderHalfRes=[],this._readyItems=[],this.renderData=!0,this.renderBoxes=!1;var i=new Float32Array([-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5]),r=new Uint16Array([0,1,2,2,1,3,5,4,7,7,4,6,4,0,6,6,0,2,1,5,3,3,5,7,2,3,6,6,3,7,4,5,0,0,5,1]),s=new Uint16Array([0,1,1,3,3,2,2,0,5,4,4,6,6,7,7,5,0,4,1,5,3,7,2,6]),n=new SglMeshGL(e);n.addVertexAttribute("position",3,i),n.addIndexedPrimitives("triangles",e.TRIANGLES,r),n.addIndexedPrimitives("edges",e.LINES,s),this._boxMesh=n,this._tileFullMesh=null,this._tileHalfMesh=null,this._program=null;var a=sglLoadFile("spidergl/box.v.glsl"),o=sglLoadFile("spidergl/box.f.glsl"),l=new SglProgram(e,[a],[o]);log(l.log),this._boxProgram=l,this._boxRenderer=new SglMeshGLRenderer(this._boxProgram),this._treeTransform=sglIdentityM4(),this._normalizedTreeTransform=sglIdentityM4(),this.updateData=!0;var h="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform   mat4 u_mvp;\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\nvarying   vec2 v_texcoord;\nvoid main(void){\nv_texcoord  = a_texcoord;\ngl_Position = u_mvp * vec4(a_position, 0.0, 1.0);\n}",d="#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D s_texture;\nvarying vec2     v_texcoord;\nvoid main(void){vec4 color = texture2D(s_texture, v_texcoord).xyzw;\nif (color.w > 0.7)\ngl_FragData[0] = vec4(color.rgb, 1.0);\nelse\ngl_FragData[0] = vec4(0.0);}";this.texProg=new SglProgram(this.gl,[h],[d]),log(this.texProg.log);var u=new Float32Array([0,0,80,0,0,50,80,50]),c=new Float32Array([0,0,1,0,0,1,1,1]);if(this.lg){var m=new SglMeshGL(this.gl);m.addVertexAttribute("position",2,u),m.addVertexAttribute("texcoord",2,c),m.addArrayPrimitives("tristrip",this.gl.TRIANGLE_STRIP,0,4),this.lgMesh=m,this.lgtex=null,this._createLg()}this.enumType=new Object,this.enumType.HSH_RTI=1,this.enumType.LRGB_PTM=2,this.enumType.RGB_PTM=3,this.enumType.IMAGE=4}MultiRes.prototype={setMode:function(e){this.mode=e},_setLightDir:function(e,t){var i=e/this.ui.width*2.2-1.1,r=t/this.ui.height*2.2-1.1;i=Math.min(1,Math.max(-1,i)),r=Math.min(1,Math.max(-1,r));var s=Math.sqrt(i*i+r*r);s>1&&(s=1);var n=Math.PI/2;0!=i&&(n=Math.atan2(r,i)),i=s*Math.cos(n),r=s*Math.sin(n);var a=[];a=1>s?[i,r,Math.sqrt(1-i*i-r*r)]:[i,r,0],a=sglNormalizedV3(a),this.renderer.lightPos=a.slice(0,3),this.renderer.lweights=this.renderer.computeLightingFunction(a)},resetViewpoint:function(){this.translation[0]=0,this.translation[1]=0,this.mat=sglIdentityM4(),this.flipMatrix=sglIdentityM4()},setImageUrl:function(e){this.imageUrl=e},setOnLoadImageCallback:function(e){this.OnLoadImageCallback=e},load:function(e){log("SpiderGL Version : "+SGL_VERSION_STRING+"\n"),this.xform=new SglTransformStack,this.renderer=new MultiResRenderer(e,268435456),this.translation=[0,0],this.mat=sglIdentityM4(),this.flipMatrix=sglIdentityM4(),""!=this.imageUrl&&this.loadImage(this.imageUrl)},loadImage:function(e){this.renderer.loadImage(e),this.OnLoadImageCallback(this.renderer.type),this.xform=new SglTransformStack,this.translation=[0,0],this.mat=sglIdentityM4(),this.rendering=!0,this.leftBottom=[(this.renderer._tree.scale[0]-this.renderer.imgWidth)/2,(this.renderer._tree.scale[1]-this.renderer.imgHeight)/2],this.rightTop=[this.leftBottom[0]+this.renderer.imgWidth,this.leftBottom[1]+this.renderer.imgHeight],this.scale=0;var t=this.ui.width,i=this.ui.height,r=this.renderer._tree.scale[0]/this.renderer.imgWidth*t,s=this.renderer._tree.scale[1]/this.renderer.imgHeight*i;this.scale=Math.min(r,s),this.maxScale=2.5*Math.max(this.renderer.imgWidth/t,this.renderer.imgHeight/i),this.viewerdx=100,this.viewerdy=100},stopRendering:function(){this.rendering=!1},setOnDrawCallback:function(e){e&&(this.onDrawCallback=e)},keyDown:function(e,t,i){"R"==i&&this.resetViewpoint(),"1"==i&&(this.renderer.renderData=!this.renderer.renderData),"2"==i&&(this.renderer.renderBoxes=!this.renderer.renderBoxes)},mouseWheel:function(e,t,i,r){if(this.isMoving)return!1;var s=i-this.translation[0],n=r-this.translation[1],a=sglPow(.98,10*t);this._startZoom(a,s,n)},startZoomIn:function(){if(this.isMoving)return!1;var e=this.ui.width/2-this.translation[0],t=this.ui.height/2-this.translation[1],i=1.2;this._startZoom(i,e,t)},startZoomOut:function(){if(this.isMoving)return!1;var e=this.ui.width/2-this.translation[0],t=this.ui.height/2-this.translation[1],i=.8;this._startZoom(i,e,t)},_startZoom:function(e,t,i){var r=this.mat[0]*e;r>this.maxScale&&(e=this.maxScale/this.mat[0]),1>r&&(e=1/this.mat[0]),1.00000001>=r&&(this.moveToCenter=!0);var s=e*this.mat[0]-this.mat[0];if(s>1e-4||-1e-4>s){this.animationStack=[];for(var n=2*this.maxStep,a=3*s/(n*n*n),o=-2*n*a,l=a*n*n,h=this.mat[0],d=0;n>d;d++){var u=a*d+a/3+o/2+l;l+=a*(2*d+1)+o;var c=1+u/h;h+=u,this.animationStack.push([c,t,i])}this.animating=this.moveToCenter;var m=this;clearInterval(this.moveInterval),clearInterval(this.zoomInterval),this.zoomInterval=setInterval(function(){m._zoomAnimation()},35),this.renderer.updateData=!1,this.isMoving=this.moveToCenter}else if(this.moveToCenter){this.animating=!0,this.isMoving=!0;var m=this;this.animationStack=[],clearInterval(this.moveInterval),clearInterval(this.zoomInterval),this.zoomInterval=setInterval(function(){m._zoomAnimation()},35),this.renderer.updateData=!1}return!1},_zoomAnimation:function(){if(0==this.animationStack.length){if(clearInterval(this.zoomInterval),this.moveToCenter){var e=this;clearInterval(this.moveInterval),this.moveInterval=setInterval(function(){e._moveAnimation()},35),this.renderer.updateData=!1,this.isMoving=!0,this.computeModelMatrix();var t=this.xform.model.top,i=[this.renderer._tree.scale[0]/2,this.renderer._tree.scale[1]/2],r=[this.ui.width/2,this.ui.height/2],s=sglMulM4V4(t,sglV4C(i[0],i[1],0,1)).slice(0,2),n=r[0]-s[0],a=r[1]-s[1];this.currentSpeed=0,this.currentPoint=s,this._updateMoveStack(s,r,sglV2C(n,a))}else this.renderer.updateData=!0;return void(this.animating=!1)}var o=this.animationStack.splice(0,1)[0],l=o[0];tx=o[1],ty=o[2];var h=sglMulM4(sglTranslationM4C(tx,ty,0),sglMulM4(sglScalingM4C(l,l,1),sglMulM4(sglTranslationM4C(-tx,-ty,0),this.mat))),d=this.returnModelMatrix(this.translation,h),u=sglMulM4V4(d,sglV4C(this.leftBottom[0],this.leftBottom[1],0,1)).slice(0,2),c=sglMulM4V4(d,sglV4C(this.rightTop[0],this.rightTop[1],0,1)).slice(0,2);u[0]-=this.viewerdx,u[1]-=this.viewerdy,c[0]+=this.viewerdx,c[1]+=this.viewerdy;var m=c[0]-u[0],g=c[1]-u[1],n=0,a=0;if(m>this.ui.width&&g>this.ui.height)c[0]<this.ui.width?n+=this.ui.width-c[0]:u[0]>0&&(n-=u[0]),c[1]<this.ui.height?a+=this.ui.height-c[1]:u[1]>0&&(a-=u[1]);else if(m>this.ui.width)ty=this.ui.height/2-this.translation[1],c[0]<this.ui.width?n+=this.ui.width-c[0]:u[0]>0&&(n-=u[0]);else{if(!(g>this.ui.height))return tx=this.ui.width/2,ty=this.ui.height/2,this.resetViewpoint(),void(0==this.animationStack.lenght&&(clearInterval(this.zoomInterval),this.renderer.updateData=!0));tx=this.ui.width/2-this.translation[0],c[1]<this.ui.height?a+=this.ui.height-c[1]:u[1]>0&&(a-=u[1])}this.mat=sglMulM4(sglTranslationM4C(tx,ty,0),sglMulM4(sglScalingM4C(l,l,1),sglMulM4(sglTranslationM4C(-tx,-ty,0),this.mat))),this.translation[0]+=n,this.translation[1]+=a,_SGL_RegisteredCanvas[this.canvas].requestDraw()},sendMouseDown:function(e){_SGL_RegisteredCanvas[this.canvas].mouseDown(e)},mouseDown:function(e,t,i,r){if(this.animating)return!1;if(0==t){if(this.ui.keysDown[17])return this._setLightDir(i,r),!0;if(0==this.mode){this.endAnimation=!1,this.currentPoint=[i,r],this.animationStack=[];var s=this;return clearInterval(this.zoomInterval),clearInterval(this.moveInterval),this.moveInterval=setInterval(function(){s._moveAnimation()},35),this.renderer.updateData=!1,this.isMoving=!0,!1}return 1==this.mode&&this._setLightDir(i,r),!0}},_moveAnimation:function(){if((this.moveToCenter||this.endAnimation)&&0==this.animationStack.length)return clearInterval(this.moveInterval),this.renderer.updateData=!0,this.isMoving=!1,this.animating=!1,void(this.moveToCenter=!1);if(0==this.animationStack.length)return void(this.currentSpeed=0);var e=this.animationStack.splice(0,1)[0],t=e[0]-this.currentPoint[0],i=e[1]-this.currentPoint[1];this.currentSpeed=e[2],this.translation[0]+=t,this.translation[1]+=i,this.currentPoint[0]=e[0],this.currentPoint[1]=e[1],_SGL_RegisteredCanvas[this.canvas].requestDraw()},mouseUp:function(e,t){return 0==t&&0==this.mode&&(this.endAnimation=!0,this.renderer.updateData=!0,this.isMoving=!1),!1},mouseOut:function(){this.endAnimation=!0,this.isMoving=!1},mouseMove:function(e,t,i){if(this.animating)return!1;if(this.ui.mouseButtonsDown[0]){if(0==this.mode){if(this.ui.keysDown[17])return this._setLightDir(t,i),!0;var r=[t,i],s=r[0]-this.currentPoint[0],n=r[1]-this.currentPoint[1],a=this._adjustTranslation(s,n);return r=[this.currentPoint[0]+a[0],this.currentPoint[1]+a[1]],this._updateMoveStack(this.currentPoint,r,a),!1}return this._setLightDir(t,i),!0}return!1},_updateMoveStack:function(e,t,i){var r=sglLengthV2(i);if(r>.1){this.animationStack.splice(0,this.animationStack.length);var s=sglNormalizedV2(i),n=2*(r/2-this.currentSpeed*this.maxStep)/(this.maxStep*this.maxStep),a=this.currentSpeed,o=[e[0],e[1]],l=0,h=this.maxStep,d=0,u=0;if(n>0){for(var c=0;c<this.maxStep;c++){var m=n/2+a;a+=n,l+=m;var g=s[0]*m,f=s[1]*m;o[0]+=g,o[1]+=f,this.animationStack.push([o[0],o[1],a,n])}h=3*r/(2*a),u=4*a*a*a/(9*r*r),d=-4*a*a/(3*r)}else h=6*r/(2*a),u=a*a*a/(9*r*r),d=-2*a*a/(3*r);for(var c=0;h>c;c++){var m=u*c+u/3+d/2+a;a+=u*(2*c+1)+d;var g=s[0]*m,f=s[1]*m;o[0]+=g,o[1]+=f,this.animationStack.push([o[0],o[1],a,u])}this.animationStack.push([t[0],t[1],0,0])}},_adjustTranslation:function(e,t){var i=sglV4C(this.translation[0]+e,this.translation[1]+t,0,1),r=this.returnModelMatrix(i,this.mat),s=sglMulM4V4(r,sglV4C(this.leftBottom[0],this.leftBottom[1],0,1)).slice(0,2),n=sglMulM4V4(r,sglV4C(this.rightTop[0],this.rightTop[1],0,1)).slice(0,2);s[0]-=this.viewerdx,s[1]-=this.viewerdy,n[0]+=this.viewerdx,n[1]+=this.viewerdy;var a=n[0]-s[0],o=n[1]-s[1],l=e,h=t;return a>this.ui.width&&o>this.ui.height?(n[0]<this.ui.width?l+=this.ui.width-n[0]:s[0]>0&&(l-=s[0]),n[1]<this.ui.height?h+=this.ui.height-n[1]:s[1]>0&&(h-=s[1])):a>this.ui.width?(n[0]<this.ui.width?l+=this.ui.width-n[0]:s[0]>0&&(l-=s[0]),h=0):o>this.ui.height?(n[1]<this.ui.height?h+=this.ui.height-n[1]:s[1]>0&&(h-=s[1]),l=0):(l=0,h=0),sglV2C(l,h)},update:function(){},returnModelMatrix:function(e,t){var i=sglMulM4(sglTranslationM4C(e[0],e[1],1),t);i=sglMulM4(this.flipMatrix,i),this.xform.model.load(i);var r=sglTranslationM4C(this.ui.width/2,this.ui.height/2,0);return this.xform.model.multiply(r),this.xform.model.scale(this.scale,this.scale,1),this.xform.model.multiply(this.renderer.normalizedTreeTransform),this.xform.model.top},computeModelMatrix:function(){var e=sglMulM4(sglTranslationM4C(this.translation[0],this.translation[1],1),this.mat);e=sglMulM4(this.flipMatrix,e),this.xform.model.load(e);var t=sglTranslationM4C(this.ui.width/2,this.ui.height/2,0);this.xform.model.multiply(t),this.xform.model.scale(this.scale,this.scale,1),this.xform.model.multiply(this.renderer.normalizedTreeTransform)},resize:function(){this.xform=new SglTransformStack,this.translation=[0,0],this.mat=sglIdentityM4(),this.rendering=!0,this.leftBottom=[(this.renderer._tree.scale[0]-this.renderer.imgWidth)/2,(this.renderer._tree.scale[1]-this.renderer.imgHeight)/2],this.rightTop=[this.leftBottom[0]+this.renderer.imgWidth,this.leftBottom[1]+this.renderer.imgHeight],this.scale=0;var e=this.ui.width;this.offsetHeight=0;var t=this.ui.height+this.offsetHeight;this.scale=Math.min(this.renderer._tree.scale[0]/this.renderer.imgWidth*e,this.renderer._tree.scale[1]/this.renderer.imgHeight*t),this.maxScale=3*Math.max(this.renderer.imgWidth/e,this.renderer.imgHeight/t),this.viewerdx=this.ui.width/2-10,this.viewerdy=this.ui.height/2-10},draw:function(e){var t=e.getError();if(t==e.CONTEXT_LOST_WEBGL&&console.log("WebGL Context lost"),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),1==this.rendering){var i=this.ui.width,r=this.ui.height;e.viewport(0,0,i,r),this.xform.projection.loadIdentity(),this.xform.projection.ortho(0,i,0,r,-4096,4096),this.xform.view.loadIdentity(),this.xform.view.lookAt(0,0,2,0,0,0,0,1,0),this.computeModelMatrix();var s=this.xform.model.top;this.onDrawCallback&&this.onDrawCallback(s),this.renderer.render(this.xform.projectionMatrix,this.xform.modelViewMatrix,[0,0,i,r])}}},MultiResTree.prototype={_load:function(e,t,i){this.ready=!0;var r=sglGetLines(e),s=r.length,n=null,a=0;if(!(a>=s||(n=r[a++].split(" "),n.length<2))){var o=parseInt(n[0]);if(!(0>=o)){var l=parseInt(n[1]);if(!(0>l||l>=o||a>=s||(n=r[a++].split(" "),n.length<1))){var h=parseInt(n[0]);if(!(0>=h||a>=s||(n=r[a++].split(" "),n.length<3))){var d=[1,1,1];if(d[0]=parseFloat(n[0]),d[1]=parseFloat(n[1]),d[2]=parseFloat(n[2]),!(a>=s||(n=r[a++].split(" "),n.length<3))){var u=[0,0,0];u[0]=parseFloat(n[0]),u[1]=parseFloat(n[1]),u[2]=parseFloat(n[2]);var c=new Array(o);if(s>a)for(var m=0;o>m;++m){var g=new MultiResNode;if(a>=s)return;if(n=r[a++].split(" "),n.length<14)return;if(g.id=parseInt(n[0]),g.id<=0)return;if(g.parentIndex=parseInt(n[1]),g.parentIndex<-1||g.parentIndex>=o)return;for(var f=0;4>f;++f)if(g.childrenIndices[f]=parseInt(n[f+2]),g.childrenIndices[f]<-1||g.childrenIndices[f]>=o)return;g.projectedSize=parseFloat(n[6]),g.zScale=parseFloat(n[7]),g.box.min[0]=parseFloat(n[8]),g.box.min[1]=parseFloat(n[9]),g.box.min[2]=parseFloat(n[10]),g.box.max[0]=parseFloat(n[11]),g.box.max[1]=parseFloat(n[12]),g.box.max[2]=parseFloat(n[13]),g.isLeaf=!0;for(var p=0;4>p;++p)if(g.childrenIndices[p]>=0){g.isLeaf=!1;break}c[m]=g}else{for(var _=0,v=d[0],x=1;v>h;)x++,v/=2;for(var b=(d[0]-t)/2/d[0],M=(d[1]-i)/2/d[1],y=new SglBox3([b,M,0],[b+t/d[0],M+i/d[1],1]),w=y.size,S=y.center,a=0;x>a;a++)for(var I=Math.pow(4,a),p=0;I>p;p++){var g=new MultiResNode;g.id=_+1,g.parentIndex=_>0?Math.ceil(_/4)-1:-1,x-1>a&&(g.isLeaf=!1);for(var f=0;4>f;++f)g.childrenIndices[f]=a==x-1?-1:4*_+1+(f+2)%4;if(g.projectedSize=h,_>0){var T=_%4,R=c[g.parentIndex],F=R.box.min[0]+(R.box.max[0]-R.box.min[0])/2,L=R.box.min[1]+(R.box.max[1]-R.box.min[1])/2;1==T?g.box=new SglBox3([R.box.min[0],L,0],[F,R.box.max[1],1]):2==T?g.box=new SglBox3([F,L,0],R.box.max):3==T?g.box=new SglBox3(R.box.min,[F,L,1]):0==T&&(g.box=new SglBox3([F,R.box.min[1],0],[R.box.max[0],L,1]));var C=g.box.center,k=g.box.size,z=sglSelfMulV3S(sglAddV3(w,k),.5),P=sglSubV3(S,C);g.zScale=Math.abs(P[0])<=z[0]&&Math.abs(P[1])<=z[1]&&Math.abs(P[2])<=z[2]?1:0}else g.box=new SglBox3([0,0,0],[1,1,1]),g.zScale=1;c[_]=g,_++}}this.nodesCount=o,this.rootIndex=l,this.tileSize=h,this.scale=d,this.offset=u,this.nodes=c}}}}}},destroy:function(e){var t=null;for(var i in this.nodes)t=this.nodes[i],t.req&&(t.req.onLoad=null,t.req=null),t.data&&(e(t.data),t.data=null);this.ready=!0,this.nodesCount=0,this.rootIndex=-1,this.nodes=null,this.url=null,this.tileSize=0,this.scale=[1,1,1]},load:function(e,t,i){return e?void this._load(e,t,i):!1},get isEmpty(){return this.nodesCount<=0},get root(){var e=this.rootIndex;return 0>e?null:this.nodes[e]},parent:function(e){var t=e.parentIndex;return 0>t?null:this.nodes[t]},child:function(e,t){var i=e.childrenIndices[t];return 0>i?null:this.nodes[i]}},MultiResRenderer.prototype={computeLightingFunction:function(e){switch(this.enumType[this.type]){case 1:var t=Math.atan2(e[1],e[0]);0>t&&(t=2*Math.PI+t);var i=Math.min(Math.acos(e[2]),Math.PI/2-.15),r=Math.cos(t),s=Math.cos(i),n=s*s,a=new Array(9);return a[0]=1/Math.sqrt(2*Math.PI),a[1]=Math.sqrt(6/Math.PI)*r*Math.sqrt(s-n),a[2]=Math.sqrt(3/(2*Math.PI))*(-1+2*s),a[3]=Math.sqrt(6/Math.PI)*Math.sqrt(s-n)*Math.sin(t),a[4]=Math.sqrt(30/Math.PI)*Math.cos(2*t)*(-s+n),a[5]=Math.sqrt(30/Math.PI)*r*(-1+2*s)*Math.sqrt(s-n),a[6]=Math.sqrt(5/(2*Math.PI))*(1-6*s+6*n),a[7]=Math.sqrt(30/Math.PI)*(-1+2*s)*Math.sqrt(s-n)*Math.sin(t),a[8]=Math.sqrt(30/Math.PI)*(-s+n)*Math.sin(2*t),a;case 2:case 3:var a=new Array(6);return a[0]=e[0]*e[0],a[1]=e[1]*e[1],a[2]=e[0]*e[1],a[3]=e[0],a[4]=e[1],a[5]=1,a}return[]},loadImage:function(e){var t=new XMLHttpRequest;t.open("GET",e+"/info.xml",!1),t.send();var i=t.responseXML;this.format="jpg";var r=parseInt(i.getElementsByTagName("MultiRes")[0].getAttribute("format"));isNaN(r)||1==r&&(this.format="png");var s=i.getElementsByTagName("Content")[0];if(this.type=s.getAttribute("type"),!(this.type in this.enumType))return!1;var n=null;switch(this.enumType[this.type]){case 1:case 2:case 3:var a=i.getElementsByTagName("Size")[0],o=i.getElementsByTagName("Scale")[0],l=i.getElementsByTagName("Bias")[0];if(n=i.getElementsByTagName("Tree")[0],this.imgWidth=parseInt(a.getAttribute("width")),this.imgHeight=parseInt(a.getAttribute("height")),this.ordlen=parseInt(a.getAttribute("coefficients")),this.numLayers=this.ordlen,2==this.enumType[this.type]&&(this.numLayers=3),tokens=o.childNodes[0].nodeValue.split(" "),tokens.length<this.ordlen)return;this.gmax=[];for(var h=0;h<this.ordlen;h++)this.gmax[h]=parseFloat(tokens[h]);if(tokens=l.childNodes[0].nodeValue.split(" "),tokens.length<this.ordlen)return;this.gmin=[];for(var h=0;h<this.ordlen;h++)this.gmin[h]=parseFloat(tokens[h]);break;case 4:var a=i.getElementsByTagName("Size")[0];n=i.getElementsByTagName("Tree")[0],this.imgWidth=parseInt(a.getAttribute("width")),this.imgHeight=parseInt(a.getAttribute("height")),this.ordlen=parseInt(a.getAttribute("coefficients")),this.numLayers=this.ordlen;break;default:return}switch(this._tree&&this._tree.destroy(this._destroyData),this._tree.load(n.textContent,this.imgWidth,this.imgHeight),this._url=e,this._timestamp=0,this._frustum=new SglFrustum,this._maxError=1,this._cache=[],this._toRequest=[],this._toRenderFullRes=[],this._toRenderHalfRes=[],this._readyItems=[],this.renderData=!0,this.renderBoxes=!1,this.lightPos=[0,0,1],this.lweights=[],this.lweights=this.computeLightingFunction(this.lightPos),null!=this._program&&this._program.destroy(),this.enumType[this.type]){case 1:var d=sglLoadFile("spidergl/multi.v.glsl"),u=sglLoadFile("spidergl/hsh.f.glsl"),c=new SglProgram(this.gl,[d],[u]);log(c.log),this._program=c;break;case 2:var d=sglLoadFile("spidergl/multi.v.glsl"),u=sglLoadFile("spidergl/lrgbptm.f.glsl"),c=new SglProgram(this.gl,[d],[u]);log(c.log),this._program=c;break;case 3:var d=sglLoadFile("spidergl/multi.v.glsl"),u=sglLoadFile("spidergl/rgbptm.f.glsl"),c=new SglProgram(this.gl,[d],[u]);log(c.log),this._program=c;break;case 4:var d=sglLoadFile("spidergl/multi.v.glsl"),u=sglLoadFile("spidergl/image.f.glsl"),c=new SglProgram(this.gl,[d],[u]);log(c.log),this._program=c;break;default:this._program=new SglProgram}this._renderer=new SglMeshGLRenderer(this._program),this._treeTransform=sglIdentityM4(),this._normalizedTreeTransform=sglIdentityM4(),this.leftTex=(this._tree.scale[0]-this.imgWidth)/2,this.rightTex=this.leftTex+this.imgWidth,this.bottomTex=(this._tree.scale[1]-this.imgHeight)/2,this.topTex=this.bottomTex+this.imgHeight,this.leftTex/=this._tree.scale[0],this.rightTex/=this._tree.scale[0],this.bottomTex/=this._tree.scale[1],this.topTex/=this._tree.scale[1],this._tree.ready&&this._setupTree()},_createLg:function(){var e=document.createElement("canvas");e.height=50,e.width=80;var t=e.getContext("2d");t.save(),t.beginPath(),t.moveTo(0,0),t.lineTo(80,0),t.lineTo(80,50),t.lineTo(0,50),t.closePath(),t.clip(),t.strokeStyle="rgba(0,0,0,0)",t.lineCap="butt",t.lineJoin="miter",t.miterLimit=4,t.save(),t.restore(),t.save(),t.restore(),t.save(),t.transform(.21814175,0,0,.21573678,-3.3721339,-3.3665838),t.save(),t.translate(14.071762,20),t.save(),g=t.createRadialGradient(239.50893,204.66128888494003,0,239.50893,204.66128888494003,31.820419),g.addColorStop(0,"rgba(255, 255, 255, 1)"),g.addColorStop(1,"rgba(151, 151, 151, 1)"),t.fillStyle=g,t.strokeStyle="#000000",t.lineWidth=2.4923694133758545,t.lineCap="round",t.lineJoin="round",t.miterLimit=4,t.transform(2.1234583,0,0,1.6108995,-256.37574,-264.34719),t.beginPath(),t.moveTo(271.42857,233.79076),t.translate(240,233.80553976769053),t.rotate(0),t.scale(.7586207296076113,1),t.arc(0,0,41.42857,-.00035675303306008355,3.1419494066230014,0),t.scale(1.318181748760332,1),t.rotate(0),t.translate(-240,-233.80553976769053),t.translate(240,233.77598023230948),t.rotate(0),t.scale(.7586207296076113,1),t.arc(0,0,41.42857,3.141235900556733,6.2835420602127945,0),t.scale(1.318181748760332,1),t.rotate(0),t.translate(-240,-233.77598023230948),t.closePath(),t.fill(),t.stroke(),t.restore(),t.save(),t.fillStyle="#ececec",t.strokeStyle="#000000",t.lineWidth=4.609655857086182,t.lineCap="butt",t.lineJoin="round",t.miterLimit=4,t.beginPath(),t.moveTo(49.495605,44.507569),t.lineTo(129.49561,79.507569),t.lineTo(209.49561,44.507569),t.lineTo(49.495605,44.507569),t.closePath(),t.fill(),t.stroke(),t.restore(),t.save(),t.fillStyle="#999999",t.strokeStyle="#000000",t.lineWidth=4.609655857086182,t.lineCap="butt",t.lineJoin="round",t.miterLimit=4,t.beginPath(),t.moveTo(129.49561,174.50757),t.lineTo(129.49561,79.507572),t.lineTo(209.49561,44.507572),t.lineTo(129.49561,174.50757),t.closePath(),t.fill(),t.stroke(),t.restore(),t.save(),t.fillStyle="#b3b3b3",t.strokeStyle="#000000",t.lineWidth=4.609655857086182,t.lineCap="butt",t.lineJoin="round",t.miterLimit=4,t.beginPath(),t.moveTo(129.49561,174.50757),t.lineTo(129.49561,79.507569),t.lineTo(49.495605,44.507569),t.lineTo(129.49561,174.50757),t.closePath(),t.fill(),t.stroke(),t.restore(),t.save(),g=t.createLinearGradient(236.58487,196.44904,257.4877,320.66739),g.addColorStop(0,"rgba(255, 255, 255, 1)"),g.addColorStop(1,"rgba(151, 151, 151, 1)"),t.fillStyle=g,t.strokeStyle="#000000",t.lineWidth=3.3579113483428955,t.lineCap="round",t.lineJoin="round",t.miterLimit=4,t.transform(1.4965962,0,0,1.2591977,-86.218969,-182.0266),t.beginPath(),t.moveTo(271.42857,233.79076),t.translate(240,233.80553976769053),t.rotate(0),t.scale(.7586207296076113,1),t.arc(0,0,41.42857,-.00035675303306008355,3.1419494066230014,0),t.scale(1.318181748760332,1),t.rotate(0),t.translate(-240,-233.80553976769053),t.translate(240,233.77598023230948),t.rotate(0),t.scale(.7586207296076113,1),t.arc(0,0,41.42857,3.141235900556733,6.2835420602127945,0),t.scale(1.318181748760332,1),t.rotate(0),t.translate(-240,-233.77598023230948),t.closePath(),t.fill(),t.stroke(),t.restore(),t.restore(),t.restore(),t.restore();var i=new Image,r=e.toDataURL("image/png");i.src=r;var s=this;i.onload=function(){var e={generateMipmap:!1,minFilter:s.gl.NEAREST,magFilter:s.gl.NEAREST};s.lgtex=new SglTexture2D(s.gl,i,e)};var n=this.gl.getError();console.log(n)},_createData:function(e){for(var t={minFilter:this.gl.LINEAR,magFilter:this.gl.LINEAR,generateMipmap:!1},i=new Array(e.length),r=0;r<e.length;++r)i[r]=new SglTexture2D(this.gl,e[r],t);var s={textures:i};return s},_destroyData:function(e){if(e){for(var t=0;t<e.textures.length;++t)e.textures[t].destroy();e.textures=null}},_requestNode:function(e){if(!e.req){for(var t=this,i=this._url+"/"+e.id,r=new Array,s=1;s<=this.numLayers;s++)r.push(new SglImageRequest(i+"_"+s+"."+this.format));var n=new SglRequestWatcher(r,function(){t._currentOngoingRequests--,t._readyItems.push(e)});e.req=n,n.send()}},_collectNodesRec:function(e,t){var i={needed:!1,usable:e.data?!0:!1};if(0==e.zScale)return i;if(!t){var r=this._frustum.boxVisibility(e.box.min,e.box.max);if(r==SGL_OUTSIDE_FRUSTUM)return i;
t=r==SGL_INSIDE_FRUSTUM}i.needed=!0;var s=this._frustum.projectedSegmentSize(e.box.center,e.box.size[0]),n=s/e.projectedSize;if(e.priority.timestamp=this._timestamp,e.priority.error=n,!i.usable)return e.req||this._toRequest.push(e),i;if(n<this._maxError||e.isLeaf)return this._toRenderFullRes.push(e),i;for(var a=null,o=0,l=0,h=null,d=[],u=0;4>u;++u)a=this._tree.child(e,u),a&&(h=this._collectNodesRec(a,t),h.usable&&l++,h.needed&&(o++,h.usable||d.push(u)));return o>0&&(0>=l?this._toRenderFullRes.push(e):d.length>0&&this._toRenderHalfRes.push({n:e,children:d})),i},_collectNodes:function(){this._toRequest=[],this._toRenderFullRes=[],this._toRenderHalfRes=[];var e=this._tree.root;e&&this._collectNodesRec(e,!1)},_renderNodeFullRes:function(e){for(var t={u_world_box_min:e.box.min,u_world_box_max:e.box.max},i=[],r=0;r<this.numLayers;r++)i["coeff"+r]=e.data.textures[r];this._renderer.setUniforms(t),this._renderer.setSamplers(i),this._renderer.render()},_renderNodesFullRes:function(e){var t=null,i=null;t=this._tileFullMesh,i="tristrip";var r={u_model_view_projection_matrix:e,u_scale_bias:[1,1,0,0],u_texcoord_scale_bias:[this._tree.tileSize/(this._tree.tileSize+2),1/(this._tree.tileSize+2)],ordlen:this.ordlen,leftTex:this.leftTex,rightTex:this.rightTex,bottomTex:this.bottomTex,topTex:this.topTex};if(4!=this.enumType[this.type])for(var s=0;s<this.ordlen;s++)r["gmax"+s]=this.gmax[s],r["gmin"+s]=this.gmin[s],r["lweight"+s]=this.lweights[s];this._renderer.begin(),this._renderer.setUniforms(r),this._renderer.beginMesh(t),this._renderer.beginPrimitives(i);var n=null;for(var s in this._toRenderFullRes)n=this._toRenderFullRes[s],this._renderNodeFullRes(n);this._renderer.endPrimitives(),this._renderer.endMesh(),this._renderer.end()},_renderNodeHalfRes:function(e,t){for(var i={u_world_box_min:null,u_world_box_max:null,u_scale_bias:null},r=[],s=0;s<this.numLayers;s++)r["coeff"+s]=e.data.textures[s];this._renderer.setSamplers(r);var n=[[.5,.5,0,0],[.5,.5,.5,0],[.5,.5,0,.5],[.5,.5,.5,.5]],a=null;for(var s in t)a=this._tree.child(e,t[s]),i.u_world_box_min=a.box.min,i.u_world_box_max=a.box.max,i.u_scale_bias=n[t[s]],this._renderer.setUniforms(i),this._renderer.render()},_renderNodesHalfRes:function(e){var t=null,i=null;t=this._tileHalfMesh,i="tristrip";var r={u_model_view_projection_matrix:e,u_texcoord_scale_bias:[this._tree.tileSize/(this._tree.tileSize+2),1/(this._tree.tileSize+2)],ordlen:this.ordlen,leftTex:this.leftTex,rightTex:this.rightTex,bottomTex:this.bottomTex,topTex:this.topTex};if(4!=this.enumType[this.type])for(var s=0;s<this.ordlen;s++)r["gmax"+s]=this.gmax[s],r["gmin"+s]=this.gmin[s],r["lweight"+s]=this.lweights[s];this._renderer.begin(),this._renderer.setUniforms(r),this._renderer.beginMesh(t),this._renderer.beginPrimitives(i);var n=null;for(var s in this._toRenderHalfRes)n=this._toRenderHalfRes[s],this._renderNodeHalfRes(n.n,n.children);this._renderer.endPrimitives(),this._renderer.endMesh(),this._renderer.end()},_renderNodes:function(e){this._renderNodesFullRes(e),this._renderNodesHalfRes(e)},_renderNodeFullResBox:function(e){var t=e.box.size,i={u_world_box_min:sglAddV3S(e.box.min,.05*t[0]),u_world_box_max:sglSubV3S(e.box.max,.05*t[0]),u_color:e.isLeaf?[1,0,1]:[0,1,0]};this._boxRenderer.setUniforms(i),this._boxRenderer.render()},_renderNodesFullResBoxes:function(e){var t={u_model_view_projection_matrix:e};this._boxRenderer.begin(),this._boxRenderer.setUniforms(t),this._boxRenderer.beginMesh(this._boxMesh),this._boxRenderer.beginPrimitives("edges");var i=null;for(var r in this._toRenderFullRes)i=this._toRenderFullRes[r],this._renderNodeFullResBox(i);this._boxRenderer.endPrimitives(),this._boxRenderer.endMesh(),this._boxRenderer.end()},_renderNodeHalfResBox:function(e,t){var i={u_world_box_min:null,u_world_box_max:null,u_color:null},r=null;for(var s in t)r=this._tree.child(e,t[s]),sz=r.box.size,i.u_world_box_min=sglAddV3S(r.box.min,.05*sz[0]),i.u_world_box_max=sglSubV3S(r.box.max,.05*sz[0]),i.u_color=r.isLeaf?[1,1,0]:[1,1,1],this._boxRenderer.setUniforms(i),this._boxRenderer.render()},_renderNodesHalfResBoxes:function(e){var t={u_model_view_projection_matrix:e};this._boxRenderer.begin(),this._boxRenderer.setUniforms(t),this._boxRenderer.beginMesh(this._boxMesh),this._boxRenderer.beginPrimitives("edges");var i=null;for(var r in this._toRenderHalfRes)i=this._toRenderHalfRes[r],this._renderNodeHalfResBox(i.n,i.children);this._boxRenderer.endPrimitives(),this._boxRenderer.endMesh(),this._boxRenderer.end()},_renderNodesBoxes:function(e){this.gl.lineWidth(2),this.gl.depthFunc(this.gl.LEQUAL),this._renderNodesFullResBoxes(e),this._renderNodesHalfResBoxes(e),this.gl.depthFunc(this.gl.LESS),this.gl.lineWidth(1)},_doRender:function(e,t,i){var r=sglMulM4(t,this._treeTransform);this._timestamp++,this._frustum.setup(e,r,i),this._collectNodes();var s=sglMulM4(e,r);if(this.renderData&&this._renderNodes(s),this.renderBoxes&&this._renderNodesBoxes(s),this.lg&&null!=this.lgtex){this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);var n=sglMulM4(e,sglScalingM4C(1,1,1)),a={u_mvp:n},o={s_texture:this.lgtex};sglRenderMeshGLPrimitives(this.lgMesh,"tristrip",this.texProg,null,a,o),this.gl.disable(this.gl.BLEND)}},_updateCache:function(){var e=1,t=this._readyItems.slice(0,e);this._readyItems.splice(0,e);var i=this._cache.concat(t);i.sort(_MultiResCompareNodes);var r=i.length,s=this._maxCacheSize<r?this._maxCacheSize:r;this._cache=i.splice(0,s);for(var n=i,a=null,o=null,l=[],h=0;s>h;++h)if(a=this._cache[h],o=a.req,a.req=null,o)if(o.succeeded){for(var d=new Array(o.requests.length),h=0;h<d.length;++h)d[h]=o.requests[h].image;a.data&&this._destroyData(a.data),a.data=this._createData(d)}else l.push(h);var u=l.length,c=0;s=n.length;for(var h=0;s>h;++h)a=n[h],o=a.req,a.req=null,o||(u>c?(this._cache[l[c]]=a,c++):(this._destroyData(a.data),a.data=null));c>0&&this._cache.sort(_MultiResCompareNodes)},_requestNodes:function(){var e=this._cache.length,t=e>0?this._cache[e-1]:null;this._toRequest.sort(_MultiResCompareNodes);for(var i=this._maxOngoingRequests-this._currentOngoingRequests,r=0,s=this._toRequest.length,n=null,a=!1,o=0;s>o&&i>r;++o)n=this._toRequest[o],n.req||(a=!0,null!=t&&e>=this._maxCacheSize&&(a=_MultiResCompareNodes(n,t)<0),a&&(this._requestNode(n),r++))},_calculateNormalizedTreeTransform:function(){var e=this._tree.root;if(!e)return sglIdentityM4();var t=new SglBox3;t.min=sglAddV3(sglMulV3(e.box.min,this._tree.scale),this._tree.offset),t.max=sglAddV3(sglMulV3(e.box.max,this._tree.scale),this._tree.offset),this._treeTransform=sglMulM4(sglTranslationM4V(this._tree.offset),sglScalingM4V(this._tree.scale));var i=t.center,r=t.size,s=r[0];s<r[1]&&(s=r[1]),s<r[2]&&(s=r[2]);var n=s>0?1/s:1,a=sglScalingM4C(n,n,n),o=sglTranslationM4C(-i[0],-i[1],-i[2]),l=sglMulM4(a,o);this._normalizedTreeTransform=l},_setupTree:function(){var e=this._tree.root;if(e){var t=this.gl,i=(this._tree.tileSize+2)*(this._tree.tileSize+2)*this.ordlen*3;this._maxCacheSize=sglFloor(this._cacheSizeInBytes/i),this._maxCacheSize<=0&&(this._maxCacheSize=1);var r=new Float32Array([-.5,.5,-.5,-.5,.5,.5,.5,-.5]),s=new SglMeshGL(t);s.addVertexAttribute("position",2,r),s.addArrayPrimitives("tristrip",t.TRIANGLE_STRIP,0,4),this._tileFullMesh=s,this._tileHalfMesh=s,this._calculateNormalizedTreeTransform()}},render:function(e,t,i){this._tree.root&&(this._doRender(e,t,i),this.updateData&&(this._updateCache(),this._requestNodes()))},get normalizedTreeTransform(){return this._normalizedTreeTransform}};