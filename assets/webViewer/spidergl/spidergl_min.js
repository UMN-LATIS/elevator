/*************************************************************************/
/*                                                                       */
/*  SpiderGL                                                             */
/*  JavaScript 3D Graphics Library on top of WebGL                       */
/*                                                                       */
/*  Copyright (C) 2010                                                   */
/*  Marco Di Benedetto                                                   */
/*  Visual Computing Laboratory                                          */
/*  ISTI - Italian National Research Council (CNR)                       */
/*  http://vcg.isti.cnr.it                                               */
/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */
/*                                                                       */
/*  This file is part of SpiderGL.                                       */
/*                                                                       */
/*  SpiderGL is free software; you can redistribute it and/or modify     */
/*  under the terms of the GNU Lesser General Public License as          */
/*  published by the Free Software Foundation; either version 2.1 of     */
/*  the License, or (at your option) any later version.                  */
/*                                                                       */
/*  SpiderGL is distributed in the hope that it will be useful, but      */
/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */
/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */
/*  See the GNU Lesser General Public License                            */
/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */
/*                                                                       */
/*************************************************************************/

function sglUnknown(){throw new Error("SpiderGL : UNKNOWN")}function sglUnsupported(){throw new Error("SpiderGL : UNSUPPORTED")}function sglUnimplemented(){throw new Error("SpiderGL : UNIMPLEMENTED")}function sglInvalidParameter(){throw new Error("SpiderGL : INVALID_PARAMETER")}function sglInvalidCall(){throw new Error("SpiderGL : INVALID_CALL")}function sglDefineConstant(t,e,n){t[e]=n}function sglInherit(t,e){t.prototype=new e,t.prototype.constructor=t}function sglInitialize(){}function sglFinalize(){}function sglNodeText(t){var e=document.getElementById(t);if(!e)return null;for(var n="",i=e.firstChild;i;)3==i.nodeType&&(n+=i.textContent),i=i.nextSibling;return n}function sglLoadFile(t,e){var n=e?!0:!1,i=new XMLHttpRequest;n&&(i.onreadystatechange=function(){4==i.readyState&&e&&e(i.responseText)}),i.open("GET",t,n),i.send(null);var r=null;return n||(r=i.responseText),r}function sglGetLines(t){for(var e=t.split("\n"),n=e.length,i=[],r=null,s=0;n>s;++s)r=e[s].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),r.length>0&&i.push(r);return i}function SglRequest(t){this._priority=null,this._status=SGL_REQUEST_IDLE,this._queue=null,this._onReady=[],t&&this.addOnReadyCallback(t)}function SglTextFileRequest(t){SglRequest.apply(this,Array.prototype.slice.call(arguments,1)),this._url=t,this._req=null,Object.defineProperty(this,"url",{get:function(){return this._url}}),Object.defineProperty(this,"text",{get:function(){return this._req.responseText}})}function SglImageRequest(t){SglRequest.apply(this,Array.prototype.slice.call(arguments,1)),this._url=t,this._img=null,Object.defineProperty(this,"url",{get:function(){return this._url}}),Object.defineProperty(this,"image",{get:function(){return this._img}})}function SglRequestWatcher(t,e){var n=t.length;this._onReady=e?e:null,this._waitingReqs=n,this._succeededReqs=0,this._failedReqs=0,this._reqs=t.slice();for(var i=this,r=function(t){t.succeeded?i._succeededReqs++:t.failed&&i._failedReqs++,i._waitingReqs--,i.isReady&&i._onReady&&i._onReady(i)},s=0;n>s;++s)t[s].succeeded?(this._succeededReqs++,this._waitingReqs--):t[s].failed?(this._failedReqs++,this._waitingReqs--):t[s].addOnReadyCallback(r);this._waitingReqs<=0&&this._onReady&&this._onReady(this)}function SglRequestQueue(t,e){this._maxOngoing=t>0?t:0,this._maxQueued=e>0?e:0,this._ongoing=[],this._queued=[],this._onReady=null,this._minPriorityReq=null,this._priorityCompare=null,this._dirty=!0}function sglAbs(t){return Math.abs(t)}function sglFloor(t){return Math.floor(t)}function sglCeil(t){return Math.ceil(t)}function sglSqrt(t){return Math.sqrt(t)}function sglPow(t,e){return Math.pow(t,e)}function sglLog(t){return Math.log(t)}function sglExp(t){return Math.exp(t)}function sglSin(t){return Math.sin(t)}function sglAsin(t){return Math.asin(t)}function sglCos(t){return Math.cos(t)}function sglAcos(t){return Math.acos(t)}function sglTan(t){return Math.tan(t)}function sglAtan(t){return Math.atan(t)}function sglAtan2(t,e){return Math.atan2(t,e)}function sglDegToRad(t){return t*(SGL_PI/180)}function sglRadToDeg(t){return t*(180/SGL_PI)}function sglMin(t,e){return Math.min(t,e)}function sglMax(t,e){return Math.max(t,e)}function sglClamp(t,e,n){return e>=t?e:t>=n?n:t}function sglRandom01(){return Math.random()}function sglMapVN(t,e,i,r,s,o,u){s=void 0!=s?s:0,u=void 0!=u?u:e,o=void 0!=o?o:(t.length-s)/u;for(var l=s+o*u,a=new Array(n),h=0,c=0,g=s;l>g;g+=u){for(c=0;c<n;++c)a[c]=t[g+c];for(i(a,r,h++),c=0;c<n;++c)t[g+c]=a[c]}}function sglMapV2(t,e,n,i,r,s){sglMapVN(t,2,e,n,i,r,s)}function sglMapV3(t,e,n,i,r,s){sglMapVN(t,3,e,n,i,r,s)}function sglMapV4(t,e,n,i,r,s){sglMapVN(t,4,e,n,i,r,s)}function sglUndefV2(){return new Array(2)}function sglV2V(t){return t.slice(0,2)}function sglV2S(t){return[t,t]}function sglV2C(t,e){return[t,e]}function sglZeroV2(){return sglV2S(0)}function sglOneV2(){return sglV2S(1)}function sglV2(){var t=arguments.length;switch(t){case 1:return arguments[0]instanceof Array?sglV2V(arguments[0]):sglV2S(arguments[0]);case 2:return sglV2V(arguments);default:return sglZeroV2()}return null}function sglDupV2(t){return t.slice(0,2)}function sglNegV2(t){return sglV2C(-t[0],-t[1])}function sglAddV2(t,e){return sglV2C(t[0]+e[0],t[1]+e[1])}function sglAddV2S(t,e){return sglV2C(t[0]+e,t[1]+e)}function sglAddSV2(t,e){return sglAddV2S(e,t)}function sglSubV2(t,e){return sglV2C(t[0]-e[0],t[1]-e[1])}function sglSubV2S(t,e){return sglV2C(t[0]-e,t[1]-e)}function sglSubSV2(t,e){return sglV2C(e-t[0],e-t[1])}function sglMulV2(t,e){return sglV2C(t[0]*e[0],t[1]*e[1])}function sglMulV2S(t,e){return sglV2C(t[0]*e,t[1]*e)}function sglMulSV2(t,e){return sglMulV2S(e,t)}function sglDivV2(t,e){return sglV2C(t[0]/e[0],t[1]/e[1])}function sglDivV2S(t,e){return sglV2C(t[0]/e,t[1]/e)}function sglDivSV2(t,e){return sglV2C(t/e[0],t/e[1])}function sglRcpV2(t){return sglDivSV2(1,t)}function sglDotV2(t,e){return t[0]*e[0]+t[1]*e[1]}function sglCrossV2(t,e){return t[0]*e[1]-t[1]*e[0]}function sglSqLengthV2(t){return sglDotV2(t,t)}function sglLengthV2(t){return sglSqrt(sglSqLengthV2(t))}function sglNormalizedV2(t){var e=1/sglLengthV2(t);return sglMulV2S(t,e)}function sglSelfNegV2(t){return t[0]=-t[0],t[1]=-t[1],t}function sglSelfAddV2(t,e){return t[0]+=e[0],t[1]+=e[1],t}function sglSelfAddV2S(t,e){return t[0]+=e,t[1]+=e,t}function sglSelfAddSV2(t,e){return e[0]+=t,e[1]+=t,e}function sglSelfSubV2(t,e){return t[0]-=e[0],t[1]-=e[1],t}function sglSelfSubV2S(t,e){return t[0]-=e,t[1]-=e,t}function sglSelfSubSV2(t,e){return t[0]=e-t[0],t[1]=e-t[1],t}function sglSelfMulV2(t,e){return t[0]*=e[0],t[1]*=e[1],t}function sglSelfMulV2S(t,e){return t[0]*=e,t[1]*=e,t}function sglSelfMulSV2(t,e){return e[0]*=t,e[1]*=t,e}function sglSelfDivV2(t,e){return t[0]/=e[0],t[1]/=e[1],t}function sglSelfDivV2S(t,e){return u[0]/=e,u[1]/=e,u}function sglSelfDivSV2(t,e){return e[0]=t/e[0],e[1]=t/e[1],e}function sglSelfRcpV2(t){return sglSelfDivSV2(1,t)}function sglSelfNormalizeV2(t){var e=1/sglLengthV2(t);return sglSelfMulV2S(t,e)}function sglMinV2(t,e){return[t[0]<e[0]?t[0]:e[0],t[1]<e[1]?t[1]:e[1]]}function sglMaxV2(t,e){return[t[0]>e[0]?t[0]:e[0],t[1]>e[1]?t[1]:e[1]]}function sglV2toV3(t,e){return sglV3C(t[0],t[1],e)}function sglV2toV4(t,e,n){return sglV4C(t[0],t[1],e,n)}function sglUndefV3(){return new Array(3)}function sglV3V(t){return t.slice(0,3)}function sglV3S(t){return[t,t,t]}function sglV3C(t,e,n){return[t,e,n]}function sglZeroV3(){return sglV3S(0)}function sglOneV3(){return sglV3S(1)}function sglV3(){var t=arguments.length;switch(t){case 1:return arguments[0]instanceof Array?sglV3V(arguments[0]):sglV3S(arguments[0]);case 3:return sglV3V(arguments);default:return sglZeroV3()}return null}function sglDupV3(t){return t.slice(0,3)}function sglNegV3(t){return sglV3C(-t[0],-t[1],-t[2])}function sglAddV3(t,e){return sglV3C(t[0]+e[0],t[1]+e[1],t[2]+e[2])}function sglAddV3S(t,e){return sglV3C(t[0]+e,t[1]+e,t[2]+e)}function sglAddSV3(t,e){return sglAddV3S(e,t)}function sglSubV3(t,e){return sglV3C(t[0]-e[0],t[1]-e[1],t[2]-e[2])}function sglSubV3S(t,e){return sglV3C(t[0]-e,t[1]-e,t[2]-e)}function sglSubSV3(t,e){return sglV3C(e-t[0],e-t[1],e-t[2])}function sglMulV3(t,e){return sglV3C(t[0]*e[0],t[1]*e[1],t[2]*e[2])}function sglMulV3S(t,e){return sglV3C(t[0]*e,t[1]*e,t[2]*e)}function sglMulSV3(t,e){return sglMulV3S(e,t)}function sglDivV3(t,e){return sglV3C(t[0]/e[0],t[1]/e[1],t[2]/e[2])}function sglDivV3S(t,e){return sglV3C(t[0]/e,t[1]/e,t[2]/e)}function sglDivSV3(t,e){return sglV3C(t/e[0],t/e[1],t/e[2])}function sglRcpV3(t){return sglDivSV3(1,t)}function sglDotV3(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function sglCrossV3(t,e){return sglV3C(t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0])}function sglSqLengthV3(t){return sglDotV3(t,t)}function sglLengthV3(t){return sglSqrt(sglSqLengthV3(t))}function sglNormalizedV3(t){var e=1/sglLengthV3(t);return sglMulV3S(t,e)}function sglSelfNegV3(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t}function sglSelfAddV3(t,e){return t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t}function sglSelfAddV3S(t,e){return t[0]+=e,t[1]+=e,t[2]+=e,t}function sglSelfAddSV3(t,e){return e[0]+=t,e[1]+=t,e[2]+=t,e}function sglSelfSubV3(t,e){return t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t}function sglSelfSubV3S(t,e){return t[0]-=e,t[1]-=e,t[2]-=e,t}function sglSelfSubSV3(t,e){return t[0]=e-t[0],t[1]=e-t[1],t[2]=e-t[2],t}function sglSelfMulV3(t,e){return t[0]*=e[0],t[1]*=e[1],t[2]*=e[2],t}function sglSelfMulV3S(t,e){return t[0]*=e,t[1]*=e,t[2]*=e,t}function sglSelfMulSV3(t,e){return e[0]*=t,e[1]*=t,e[2]*=t,e}function sglSelfDivV3(t,e){return t[0]/=e[0],t[1]/=e[1],t[2]/=e[2],t}function sglSelfDivV3S(t,e){return u[0]/=e,u[1]/=e,u[2]/=e,u}function sglSelfDivSV3(t,e){return e[0]=t/e[0],e[1]=t/e[1],e[2]=t/e[2],e}function sglSelfRcpV3(t){return sglSelfDivSV3(1,t)}function sglSelfCrossV3(t,e){var n=sglV3C(t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]);return t[0]=n[0],t[1]=n[1],t[2]=n[2],t}function sglSelfNormalizeV3(t){var e=1/sglLengthV3(t);return sglSelfMulV3S(t,e)}function sglMinV3(t,e){return[t[0]<e[0]?t[0]:e[0],t[1]<e[1]?t[1]:e[1],t[2]<e[2]?t[2]:e[2]]}function sglMaxV3(t,e){return[t[0]>e[0]?t[0]:e[0],t[1]>e[1]?t[1]:e[1],t[2]>e[2]?t[2]:e[2]]}function sglV3toV2(t){return t.slice(0,2)}function sglV3toV4(t,e){return sglV4C(t[0],t[1],t[2],e)}function sglUndefV4(){return new Array(4)}function sglV4V(t){return t.slice(0,4)}function sglV4S(t){return[t,t,t,t]}function sglV4C(t,e,n,i){return[t,e,n,i]}function sglZeroV4(){return sglV4S(0)}function sglOneV4(){return sglV4S(1)}function sglV4(){var t=arguments.length;switch(t){case 1:return arguments[0]instanceof Array?sglV4V(arguments[0]):sglV4S(arguments[0]);case 4:return sglV4V(arguments);default:return sglZeroV4()}return null}function sglDupV4(t){return t.slice(0,4)}function sglNegV4(t){return sglV4C(-t[0],-t[1],-t[2],-t[3])}function sglAddV4(t,e){return sglV4C(t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3])}function sglAddV4S(t,e){return sglV4C(t[0]+e,t[1]+e,t[2]+e,t[3]+e)}function sglAddSV4(t,e){return sglAddV4S(e,t)}function sglSubV4(t,e){return sglV4C(t[0]-e[0],t[1]-e[1],t[2]-e[2],t[3]-e[3])}function sglSubV4S(t,e){return sglV4C(t[0]-e,t[1]-e,t[2]-e,t[3]-e)}function sglSubSV4(t,e){return sglV4C(e-t[0],e-t[1],e-t[2],e-t[3])}function sglMulV4(t,e){return sglV4C(t[0]*e[0],t[1]*e[1],t[2]*e[2],t[3]*e[3])}function sglMulV4S(t,e){return sglV4C(t[0]*e,t[1]*e,t[2]*e,t[3]*e)}function sglMulSV4(t,e){return sglMulV4S(e,t)}function sglDivV4(t,e){return sglV4C(t[0]/e[0],t[1]/e[1],t[2]/e[2],t[3]/e[3])}function sglDivV4S(t,e){return sglV4C(t[0]/e,t[1]/e,t[2]/e,t[3]/e)}function sglDivSV4(t,e){return sglV4C(t/e[0],t/e[1],t/e[2],t/e[3])}function sglRcpV4(t){return sglDivSV4(1,t)}function sglDotV4(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function sglSqLengthV4(t){return sglDotV4(t,t)}function sglLengthV4(t){return sglSqrt(sglSqLengthV4(t))}function sglNormalizedV4(t){var e=1/sglLengthV4(t);return sglMulV4S(t,e)}function sglProjectV4(t){var e=1/t[3];return sglV4C(t[0]*e,t[1]*e,t[2]*e,1)}function sglSelfNegV4(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t[3]=-t[3],t}function sglSelfAddV4(t,e){return t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[3],t}function sglSelfAddV4S(t,e){return t[0]+=e,t[1]+=e,t[2]+=e,t[3]+=e,t}function sglSelfAddSV4(t,e){return e[0]+=t,e[1]+=t,e[2]+=t,e[3]+=t,e}function sglSelfSubV4(t,e){return t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t[3]-=e[3],t}function sglSelfSubV4S(t,e){return t[0]-=e,t[1]-=e,t[2]-=e,t[3]-=e,t}function sglSelfSubSV4(t,e){return t[0]=e-t[0],t[1]=e-t[1],t[2]=e-t[2],t[3]=e-t[3],t}function sglSelfMulV4(t,e){return t[0]*=e[0],t[1]*=e[1],t[2]*=e[2],t[3]*=e[3],t}function sglSelfMulV4S(t,e){return t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e,t}function sglSelfMulSV4(t,e){return e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e}function sglSelfDivV4(t,e){return t[0]/=e[0],t[1]/=e[1],t[2]/=e[2],t[3]/=e[3],t}function sglSelfDivV4S(t,e){return u[0]/=e,u[1]/=e,u[2]/=e,u[3]/=e,u}function sglSelfDivSV4(t,e){return e[0]=t/e[0],e[1]=t/e[1],e[2]=t/e[2],e[3]=t/e[3],e}function sglSelfRcpV4(t){return sglSelfDivSV4(1,t)}function sglSelfNormalizeV4(t){var e=1/sglLengthV4(t);return sglSelfMulV4S(t,e)}function sglSelfProjectV4(t){var e=1/t[3];return t[0]*=e,t[1]*=e,t[2]*=e,t[3]=1,t}function sglMinV4(t,e){return[t[0]<e[0]?t[0]:e[0],t[1]<e[1]?t[1]:e[1],t[2]<e[2]?t[2]:e[2],t[3]<e[3]?t[3]:e[3]]}function sglMaxV4(t,e){return[t[0]>e[0]?t[0]:e[0],t[1]>e[1]?t[1]:e[1],t[2]>e[2]?t[2]:e[2],t[3]>e[3]?t[3]:e[3]]}function sglV4toV2(t){return t.slice(0,2)}function sglV4toV3(t){return t.slice(0,3)}function sglUndefM4(){return new Array(16)}function sglM4V(t){return t.slice(0,16)}function sglM4S(t){for(var e=sglUndefM4(),n=0;16>n;++n)e[n]=t;return e}function sglDiagM4V(t){var e=sglM4S(0);return e[0]=t[0],e[5]=t[1],e[10]=t[2],e[15]=t[3],e}function sglDiagM4S(t){var e=sglM4S(0);return e[0]=t,e[5]=t,e[10]=t,e[15]=t,e}function sglDiagM4C(){return sglDiagM4V(arguments)}function sglZeroM4(){return sglM4S(0)}function sglOneM4(){return sglM4S(1)}function sglIdentityM4(){return sglDiagM4S(1)}function sglM4(){var t=arguments.length;switch(t){case 1:if(arguments[0]instanceof Array)switch(arguments[0].length){case 1:return sglDiagM4S(arguments[0]);case 4:return sglDiagM4V(arguments[0]);case 16:return sglM4V(arguments[0]);default:return sglIdentityM4()}return sglM4S(arguments[0]);case 4:return sglDiagM4V(arguments);case 16:return sglM4V(arguments);default:return sglIdentityM4()}return null}function sglDupM4(t){var e=sglUndefM4();return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function sglGetElemM4(t,e,n){return t[e+4*n]}function sglSetElemM4(t,e,n,i){t[e+4*n]=i}function sglGetRowM4(t,e){return sglV4C(t[e+0],t[e+4],t[e+8],t[e+12])}function sglSetRowM4V(t,e,n){t[e+0]=n[0],t[e+4]=n[1],t[e+8]=n[2],t[e+12]=n[3]}function sglSetRowM4S(t,e,n){t[e+0]=n,t[e+4]=n,t[e+8]=n,t[e+12]=n}function sglSetRowM4C(t,e,n,i,r,s){t[e+0]=n,t[e+4]=i,t[e+8]=r,t[e+12]=s}function sglGetColM4(t,e){var n=4*e;return sglV4C(t[n+0],t[n+1],t[n+2],t[n+3])}function sglSetColM4V(t,e,n){var i=4*e;t[i+0]=n[0],t[i+1]=n[1],t[i+2]=n[2],t[i+3]=n[3]}function sglSetColM4S(t,e,n){var i=4*e;t[i+0]=n,t[i+1]=n,t[i+2]=n,t[i+3]=n}function sglSetColM4C(t,e,n,i,r,s){var o=4*e;t[o+0]=n,t[o+1]=i,t[o+2]=r,t[o+3]=s}function sglM4toM3(t){return[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]]}function sglIsIdentityM4(t){var e=0,n=0,i=0;for(e=0;4>e;++e)for(n=0;4>n;++n)if(i=t[e+4*n],e==n){if(1!=i)return!1}else if(0!=i)return!1;return!0}function sglNegM4(t){for(var e=sglUndefM4(),n=0;16>n;++n)e[n]=-t[n];return e}function sglAddM4(t,e){for(var n=sglUndefM4(),i=0;16>i;++i)n[i]=t[i]+e[i];return n}function sglAddM4S(t,e){for(var n=sglUndefM4(),i=0;16>i;++i)n[i]=t[i]+e;return n}function sglAddSM4(t,e){return sglAddM4S(e,t)}function sglSubM4(t,e){for(var n=sglUndefM4(),i=0;16>i;++i)n[i]=t[i]-e[i];return n}function sglSubM4S(t,e){for(var n=sglUndefM4(),i=0;16>i;++i)n[i]=t[i]-e;return n}function sglSubSM4(t,e){for(var n=sglUndefM4(),i=0;16>i;++i)n[i]=t-e[i];return n}function sglMulM4(t,e){var n=t[0],i=t[1],r=t[2],s=t[3],o=t[4],u=t[5],l=t[6],a=t[7],h=t[8],c=t[9],g=t[10],f=t[11],_=t[12],d=t[13],m=t[14],v=t[15],S=e[0],p=e[1],b=e[2],E=e[3],M=e[4],T=e[5],R=e[6],V=e[7],j=e[8],P=e[9],y=e[10],A=e[11],O=e[12],L=e[13],x=e[14],I=e[15],C=sglUndefM4();return C[0]=n*S+o*p+h*b+_*E,C[1]=i*S+u*p+c*b+d*E,C[2]=r*S+l*p+g*b+m*E,C[3]=s*S+a*p+f*b+v*E,C[4]=n*M+o*T+h*R+_*V,C[5]=i*M+u*T+c*R+d*V,C[6]=r*M+l*T+g*R+m*V,C[7]=s*M+a*T+f*R+v*V,C[8]=n*j+o*P+h*y+_*A,C[9]=i*j+u*P+c*y+d*A,C[10]=r*j+l*P+g*y+m*A,C[11]=s*j+a*P+f*y+v*A,C[12]=n*O+o*L+h*x+_*I,C[13]=i*O+u*L+c*x+d*I,C[14]=r*O+l*L+g*x+m*I,C[15]=s*O+a*L+f*x+v*I,C}function sglMulM4S(t,e){for(var n=sglUndefM4(),i=0;16>i;++i)n[i]=t[i]*e;return n}function sglMulSM4(t,e){return sglMulM4S(e,t)}function sglMulM4V3(t,e,n){return[t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12]*n,t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13]*n,t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14]*n]}function sglMulM4V4(t,e){return[t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12]*e[3],t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13]*e[3],t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14]*e[3],t[3]*e[0]+t[7]*e[1]+t[11]*e[2]+t[15]*e[3]]}function sglDivM4S(t,e){for(var n=sglUndefM4(),i=0;16>i;++i)n[i]=t[i]/e;return n}function sglDivSM4(t,e){for(var n=sglUndefM4(),i=0;16>i;++i)n[i]=t/e[i];return n}function sglRcpM4(t){return sglDivSM4(1,t)}function sglCompMulM4(t,e){for(var n=sglUndefM4(),i=0;16>i;++i)n[i]=t[i]*e[i];return n}function sglCompDivM4(t,e){for(var n=sglUndefM4(),i=0;16>i;++i)n[i]=t[i]/e[i];return n}function sglTransposeM4(t){var e=sglUndefM4();return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e}function sglDeterminantM4(t){var e=t[0],n=t[1],i=t[2],r=t[3],s=t[4],o=t[5],u=t[6],l=t[7],a=t[8],h=t[9],c=t[10],g=t[11],f=t[12],_=t[13],d=t[14],m=t[15];return f*h*u*r-a*_*u*r-f*o*c*r+s*_*c*r+a*o*d*r-s*h*d*r-f*h*i*l+a*_*i*l+f*n*c*l-e*_*c*l-a*n*d*l+e*h*d*l+f*o*i*g-s*_*i*g-f*n*u*g+e*_*u*g+s*n*d*g-e*o*d*g-a*o*i*m+s*h*i*m+a*n*u*m-e*h*u*m-s*n*c*m+e*o*c*m}function sglInverseM4(t){var e=t[0],n=t[1],i=t[2],r=t[3],s=t[4],o=t[5],u=t[6],l=t[7],a=t[8],h=t[9],c=t[10],g=t[11],f=t[12],_=t[13],d=t[14],m=t[15],v=sglUndefM4();v[0]=h*d*l-_*c*l+_*u*g-o*d*g-h*u*m+o*c*m,v[1]=_*c*r-h*d*r-_*i*g+n*d*g+h*i*m-n*c*m,v[2]=o*d*r-_*u*r+_*i*l-n*d*l-o*i*m+n*u*m,v[3]=h*u*r-o*c*r-h*i*l+n*c*l+o*i*g-n*u*g,v[4]=f*c*l-a*d*l-f*u*g+s*d*g+a*u*m-s*c*m,v[5]=a*d*r-f*c*r+f*i*g-e*d*g-a*i*m+e*c*m,v[6]=f*u*r-s*d*r-f*i*l+e*d*l+s*i*m-e*u*m,v[7]=s*c*r-a*u*r+a*i*l-e*c*l-s*i*g+e*u*g,v[8]=a*_*l-f*h*l+f*o*g-s*_*g-a*o*m+s*h*m,v[9]=f*h*r-a*_*r-f*n*g+e*_*g+a*n*m-e*h*m,v[10]=s*_*r-f*o*r+f*n*l-e*_*l-s*n*m+e*o*m,v[11]=a*o*r-s*h*r-a*n*l+e*h*l+s*n*g-e*o*g,v[12]=f*h*u-a*_*u-f*o*c+s*_*c+a*o*d-s*h*d,v[13]=a*_*i-f*h*i+f*n*c-e*_*c-a*n*d+e*h*d,v[14]=f*o*i-s*_*i-f*n*u+e*_*u+s*n*d-e*o*d,v[15]=s*h*i-a*o*i+a*n*u-e*h*u-s*n*c+e*o*c;for(var S=1/(f*h*u*r-a*_*u*r-f*o*c*r+s*_*c*r+a*o*d*r-s*h*d*r-f*h*i*l+a*_*i*l+f*n*c*l-e*_*c*l-a*n*d*l+e*h*d*l+f*o*i*g-s*_*i*g-f*n*u*g+e*_*u*g+s*n*d*g-e*o*d*g-a*o*i*m+s*h*i*m+a*n*u*m-e*h*u*m-s*n*c*m+e*o*c*m),p=0;16>p;++p)v[p]*=S;return v}function sglTraceM4(t){return t[0]+t[5]+t[10]+t[15]}function sglTranslationM4V(t){var e=sglIdentityM4();return e[12]=t[0],e[13]=t[1],e[14]=t[2],e}function sglTranslationM4C(t,e,n){return sglTranslationM4V([t,e,n])}function sglTranslationM4S(t){return sglTranslationM4C(t,t,t)}function sglRotationAngleAxisM4V(t,e){var n,i,r,s,o,u,l,a,h,c=sglNormalizedV3(e),g=sglSin(t),f=sglCos(t),_=1-f,d=c[0],m=c[1],v=c[2];n=d*d,i=m*m,r=v*v,s=d*m,o=m*v,u=v*d,l=d*g,a=m*g,h=v*g;var S=sglUndefM4();return S[0]=_*n+f,S[1]=_*s+h,S[2]=_*u-a,S[3]=0,S[4]=_*s-h,S[5]=_*i+f,S[6]=_*o+l,S[7]=0,S[8]=_*u+a,S[9]=_*o-l,S[10]=_*r+f,S[11]=0,S[12]=0,S[13]=0,S[14]=0,S[15]=1,S}function sglRotationAngleAxisM4C(t,e,n,i){return sglRotationAngleAxisM4V(t,[e,n,i])}function sglScalingM4V(t){var e=sglIdentityM4();return e[0]=t[0],e[5]=t[1],e[10]=t[2],e}function sglScalingM4C(t,e,n){return sglScalingM4V([t,e,n])}function sglScalingM4S(t){return sglScalingM4C(t,t,t)}function sglLookAtM4V(t,e,n){var i=sglNormalizedV3(sglSubV3(e,t)),r=sglNormalizedV3(n),s=sglNormalizedV3(sglCrossV3(i,r));r=sglNormalizedV3(sglCrossV3(s,i));var o=sglUndefM4();return o[0]=s[0],o[1]=r[0],o[2]=-i[0],o[3]=0,o[4]=s[1],o[5]=r[1],o[6]=-i[1],o[7]=0,o[8]=s[2],o[9]=r[2],o[10]=-i[2],o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o=sglMulM4(o,sglTranslationM4V(sglNegV3(t)))}function sglLookAtM4C(t,e,n,i,r,s,o,u,l){return sglLookAtM4V([t,e,n],[i,r,s],[o,u,l])}function sglOrthoM4V(t,e){var n=sglAddV3(e,t),i=sglSubV3(e,t),r=sglUndefM4();return r[0]=2/i[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2/i[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=-2/i[2],r[11]=0,r[12]=-n[0]/i[0],r[13]=-n[1]/i[1],r[14]=-n[2]/i[2],r[15]=1,r}function sglOrthoM4C(t,e,n,i,r,s){return sglOrthoM4V([t,n,r],[e,i,s])}function sglFrustumM4V(t,e){var n=sglAddV3(e,t),i=sglSubV3(e,t),r=2*t[2],s=sglUndefM4();return s[0]=r/i[0],s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=r/i[1],s[6]=0,s[7]=0,s[8]=n[0]/i[0],s[9]=n[1]/i[1],s[10]=-n[2]/i[2],s[11]=-1,s[12]=0,s[13]=0,s[14]=-r*e[2]/i[2],s[15]=0,s}function sglFrustumM4C(t,e,n,i,r,s){return sglFrustumM4V([t,n,r],[e,i,s])}function sglPerspectiveM4(t,e,n,i){var r=sglUndefV4(),s=sglUndefV4();return r[2]=n,s[2]=i,s[1]=r[2]*sglTan(t/2),r[1]=-s[1],s[0]=s[1]*e,r[0]=-s[0],sglFrustumM4V(r,s)}function sglUndefQuat(){return new Array(4)}function sglQuatV(t){return t.slice(0,4)}function sglIdentityQuat(){return[0,0,0,1]}function sglAngleAxisQuat(t,e){var n=t/2,i=sglSin(n);return[i*e[0],i*e[1],i*e[2],sglCos(n)]}function sglM4Quat(t){var e=sglGetElemM4(t,0,0)+sglGetElemM4(t,1,1)+sglGetElemM4(t,2,2),n=null,i=sglUndefQuat();if(e>0)n=sglSqrt(e+1),i[3]=n/2,n=.5/n,i[0]=(sglGetElemM4(t,2,1)-sglGetElemM4(t,1,2))*n,i[1]=(sglGetElemM4(t,0,2)-sglGetElemM4(t,2,0))*n,i[2]=(sglGetElemM4(t,1,0)-sglGetElemM4(t,0,1))*n;else{var r=0;sglGetElemM4(t,1,1)>sglGetElemM4(t,0,0)&&(r=1),sglGetElemM4(t,2,2)>sglGetElemM4(t,r,r)&&(r=2);var s=(r+1)%3,o=(s+1)%3;n=sglSqrt(sglGetElemM4(t,r,r)-sglGetElemM4(t,s,s)-sglGetElemM4(t,o,o)+1),i[r]=n/2,n=.5/n,i[3]=(sglGetElemM4(t,o,s)-sglGetElemM4(t,s,o))*n,i[s]=(sglGetElemM4(t,s,r)+sglGetElemM4(t,r,s))*n,i[o]=(sglGetElemM4(t,o,r)+sglGetElemM4(t,r,o))*n}return i}function sglGetQuatAngleAxis(t){var e=new Array(4),n=sglSqLengthV4(t);if(n>0){var i=1/sglSqrt(n);e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=2*aglAcos(t[3])}else e[0]=0,e[1]=0,e[2]=1,e[3]=0;return e}function sglGetQuatRotationM4(t){var e=2*t[0],n=2*t[1],i=2*t[2],r=e*t[3],s=n*t[3],o=i*t[3],u=e*t[0],l=n*t[0],a=i*t[0],h=n*t[1],c=i*t[1],g=i*t[2],f=sglIdentityM4();return sglSetElemM4(f,0,0,1-(h+g)),sglSetElemM4(f,0,1,l-o),sglSetElemM4(f,0,2,a+s),sglSetElemM4(f,1,0,l+o),sglSetElemM4(f,1,1,1-(u+g)),sglSetElemM4(f,1,2,c-r),sglSetElemM4(f,2,0,a-s),sglSetElemM4(f,2,1,c+r),sglSetElemM4(f,2,2,1-(u+h)),f}function sglNormalizedQuat(t){return sglNormalizedV4(t)}function sglMulQuat(){var t=sglUndefQuat();t[0]=p[3]*q[0]+p[0]*q[3]+p[1]*q[2]-p[2]*q[1],t[1]=p[3]*q[1]+p[1]*q[3]+p[2]*q[0]-p[0]*q[2],t[2]=p[3]*q[2]+p[2]*q[3]+p[0]*q[1]-p[1]*q[0],t[3]=p[3]*q[3]-p[0]*q[0]-p[1]*q[1]-p[2]*q[2]}function SglVec2(){this.v=new Array(2);var t=arguments.length;switch(t){case 1:arguments[0]instanceof Array?this.setVec(arguments[0]):arguments[0]instanceof SglVec2?this.setVec(arguments[0].v):this.setScalar(arguments[0]);break;case 2:this.setVec(arguments);break;default:this.setZero()}}function SglVec3(){this.v=new Array(3);var t=arguments.length;switch(t){case 1:arguments[0]instanceof Array?this.setVec(arguments[0]):arguments[0]instanceof SglVec3?this.setVec(arguments[0].v):this.setScalar(arguments[0]);break;case 3:this.setVec(arguments);break;default:this.setZero()}}function SglVec4(){this.v=new Array(4);var t=arguments.length;switch(t){case 1:arguments[0]instanceof Array?this.setVec(arguments[0]):arguments[0]instanceof SglVec4?this.setVec(arguments[0].v):this.setScalar(arguments[0]);break;case 4:this.setVec(arguments);break;default:this.setZero()}}function SglPlane3(t,e,n){this._normal=[0,0,1],this._offset=0,t&&e&&this.setup(t,e,n)}function SglBox3(t,e){this._min=[1,1,1],this._max=[-1,-1,-1],t&&e&&this.setup(t,e)}function SglSphere3(t,e){this._center=[0,0,0],this._radius=-1,t&&e&&this.setup(t,e)}function SglMatrixStack(){this._s=[],this._s.push(sglIdentityM4()),this._n=0}function SglTransformStack(){this._ms=new SglMatrixStack,this._vs=new SglMatrixStack,this._ps=new SglMatrixStack}function _SglFrustumPlane(){this.normal=[0,0,1],this.offset=0,this.testVertex=[0,0,0]}function SglFrustum(t,e,n){this._mvpMatrix=sglIdentityM4(),this._viewport=[0,0,1,1],this._vp=[0,0,1,1],this._billboardMatrix=sglIdentityM4(),this._planes=new Array(6);for(var i=0;6>i;++i)this._planes[i]=new _SglFrustumPlane;t&&e&&n&&this.setup(t,e,n)}function sglBoxVisibility(t,e,n){var i=new SglFrustum(t);return i.boxVisibility(e,n)}function _sglConsolidateOptions(t,e){if(e)for(var n in e)t[n]=e[n];return t}function sglGetBufferOptions(t,e){var n={usage:t.STATIC_DRAW};return _sglConsolidateOptions(n,e)}function SglBufferInfo(){this.handle=null,this.valid=!1,this.target=0,this.size=0,this.usage=0}function sglBufferFromData(t,e,n,i){var r=sglGetBufferOptions(t,i),s=t.createBuffer();t.bindBuffer(e,s),t.bufferData(e,n,r.usage),t.bindBuffer(e,null);var o=new SglBufferInfo;return o.handle=s,o.valid=!0,o.target=e,o.size=n.sizeInBytes,o.usage=r.usage,o}function sglVertexBufferFromData(t,e,n){return sglBufferFromData(t,t.ARRAY_BUFFER,e,n)}function sglIndexBufferFromData(t,e,n){return sglBufferFromData(t,t.ELEMENT_ARRAY_BUFFER,e,n)}function SglShaderInfo(){this.handle=null,this.valid=!1,this.type=0,this.log=""}function sglShaderFromSource(t,e,n){var i="";i+="----------------------\n";var r=t.createShader(e);t.shaderSource(r,n),t.compileShader(r),i+="[SHADER LOG]\n";var s=!0;0!=t.getShaderParameter(r,t.COMPILE_STATUS)?i+="SUCCESS:\n":(s=!1,i+="FAIL:\n"),i+=t.getShaderInfoLog(r),i+="\n",i+="----------------------\n";var o=new SglShaderInfo;return o.handle=r,o.valid=s,o.type=e,o.log=i,o}function sglVertexShaderFromSource(t,e){return sglShaderFromSource(t,t.VERTEX_SHADER,e)}function sglFragmentShaderFromSource(t,e){return sglShaderFromSource(t,t.FRAGMENT_SHADER,e)}function SglProgramAttributeInfo(){this.name="",this.nativeType=0,this.size=0,this.location=-1}function SglProgramUniformInfo(){this.name="",this.nativeType=0,this.size=0,this.location=-1}function SglProgramSamplerInfo(){this.name="",this.nativeType=0,this.size=0,this.location=-1}function SglProgramInfo(){this.handle=null,this.valid=!1,this.shaders=[],this.attributes=new Object,this.uniforms=new Object,this.samplers=new Object,this.log=""}function sglProgramFromShaders(t,e){var n="";n+="----------------------\n";var i=t.createProgram();for(var r in e){var s=e[r];t.attachShader(i,s.handle)}t.linkProgram(i);var o=!0;o=o&&0!=t.getProgramParameter(i,t.LINK_STATUS),n+="[PROGRAM LOG]\n",n+=o?"SUCCESS:\n":"FAIL:\n",n+=t.getProgramInfoLog(i),n+="\n",n+="----------------------\n";var u=new SglProgramInfo;u.handle=i,u.valid=o;for(var r in e){var s=e[r];u.shaders.push(s)}u.log=n;for(var l,a,h,c=t.getProgramParameter(i,t.ACTIVE_ATTRIBUTES),g=0;c>g;++g)l=t.getActiveAttrib(i,g),l&&(h=new SglProgramAttributeInfo,h.name=l.name,h.nativeType=l.type,h.size=l.size,h.location=t.getAttribLocation(i,l.name),u.attributes[h.name]=h);for(var f,a,_,d=t.getProgramParameter(i,t.ACTIVE_UNIFORMS),g=0;d>g;++g)f=t.getActiveUniform(i,g),f&&(a=t.getUniformLocation(i,f.name),f.type==t.SAMPLER_2D||f.type==t.SAMPLER_CUBE||35682==f.type?(r=new SglProgramSamplerInfo,r.name=f.name,r.nativeType=f.type,r.size=f.size,r.location=a,u.samplers[r.name]=r):(_=new SglProgramUniformInfo,_.name=f.name,_.nativeType=f.type,_.size=f.size,_.location=a,u.uniforms[_.name]=_));return sglSetDefaultProgramBindings(t,u),u}function sglProgramFromSources(t,e,n){var i=null,r=[];for(var s in e){var o=e[s];i=sglVertexShaderFromSource(t,o),r.push(i)}for(var s in n){var o=n[s];i=sglFragmentShaderFromSource(t,o),r.push(i)}return sglProgramFromShaders(t,r)}function sglSetDefaultProgramBindings(t,e){var n=e.handle,i=0;for(var r in e.attributes){var s=e.attributes[r];t.bindAttribLocation(n,i,s.name),s.location=i,i++}t.linkProgram(n);for(var o in e.uniforms){var u=e.uniforms[o];u.location=t.getUniformLocation(n,u.name)}t.useProgram(e.handle);var l=0;for(var a in e.samplers){var h=e.samplers[a];h.location=t.getUniformLocation(n,h.name),t.uniform1i(h.location,l),l++}}function sglProgramSynchronize(t,e){var n=e.handle;for(var i in e.attributes){var r=e.attributes[i];r.location=t.getAttribLocation(n,r.name)}for(var s in e.uniforms){var o=e.uniforms[s];o.location=t.getUniformLocation(n,o.name)}for(var u in e.samplers){var l=e.samplers[u];l.location=t.getUniformLocation(n,l.name)}}function sglGetTextureOptions(t,e){var n={minFilter:t.LINEAR,magFilter:t.LINEAR,wrapS:t.CLAMP_TO_EDGE,wrapT:t.CLAMP_TO_EDGE,isDepth:!1,depthMode:t.LUMINANCE,depthCompareMode:t.COMPARE_R_TO_TEXTURE,depthCompareFunc:t.LEQUAL,generateMipmap:!1,flipY:!0,premultiplyAlpha:!1,onload:null};return _sglConsolidateOptions(n,e)}function SglTextureInfo(){this.handle=null,this.valid=!1,this.target=0,this.format=0,this.width=0,this.height=0,this.minFilter=0,this.magFilter=0,this.wrapS=0,this.wrapT=0,this.isDepth=!1,this.depthMode=0,this.depthCompareMode=0,this.depthCompareFunc=0}function sglTexture2DFromData(t,e,n,i,r,s,o,u){var l=sglGetTextureOptions(t,u);o||(o=s==t.FLOAT?new Float32Array(n*i*4):new Uint8Array(n*i*4));var a=t.createTexture();t.bindTexture(t.TEXTURE_2D,a);var h=t.getParameter(t.UNPACK_FLIP_Y_WEBGL),c=l.flipY===!0;h!=c&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,c?1:0),t.texImage2D(t.TEXTURE_2D,0,e,n,i,0,r,s,o),h!=c&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,h?1:0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,l.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,l.magFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,l.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,l.wrapT),l.isDepth&&(t.texParameteri(t.TEXTURE_2D,t.DEPTH_TEXTURE_MODE,l.depthMode),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_COMPARE_MODE,l.depthCompareMode),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_COMPARE_FUNC,l.depthCompareFunc)),l.generateMipmap&&t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null);var g=new SglTextureInfo;return g.handle=a,g.valid=!0,g.target=t.TEXTURE_2D,g.format=e,g.width=n,g.height=i,g.minFilter=l.minFilter,g.magFilter=l.magFilter,g.wrapS=l.wrapS,g.wrapT=l.wrapT,g.isDepth=l.isDepth,g.depthMode=l.depthMode,g.depthCompareMode=l.depthCompareMode,g.depthCompareFunc=l.depthCompareFunc,g}function sglTexture2DFromImage(t,e,n){var i=sglGetTextureOptions(t,n),r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r);var s=t.getParameter(t.UNPACK_FLIP_Y_WEBGL),o=i.flipY===!0;s!=o&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,o?1:0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),s!=o&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,s?1:0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i.magFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,i.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,i.wrapT),i.generateMipmap&&t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null);var u=new SglTextureInfo;return u.handle=r,u.valid=!0,u.target=t.TEXTURE_2D,u.format=t.RGBA,u.width=e.width,u.height=e.height,u.minFilter=i.minFilter,u.magFilter=i.magFilter,u.wrapS=i.wrapS,u.wrapT=i.wrapT,u.isDepth=!1,u.depthMode=0,u.depthCompareMode=0,u.depthCompareFunc=0,u}function sglTexture2DFromUrl(t,e,n){var i=sglGetTextureOptions(t,n),r=new SglTextureInfo,s=new Image;return s.onload=function(){var n=sglTexture2DFromImage(t,s,i);for(var o in n)r[o]=n[o];i.onload&&i.onload(t,r,e)},s.src=e,r}function sglTextureCubeFromData(t,e,n,i,r,s,o,u){var l=sglGetTextureOptions(t,u);if(!o){var a=null;a=s==t.FLOAT?new Float32Array(n*i*4):new Uint8Array(n*i*4),o=new Array(6);for(var h=0;6>h;++h)o[h]=a}var c=t.createTexture();t.bindTexture(t.TEXTURE_CUBE_MAP,c);var g=t.getParameter(t.UNPACK_FLIP_Y_WEBGL),f=l.flipY===!0;g!=f&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,f?1:0);for(var h=0;6>h;++h)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+h,0,e,n,i,0,r,s,o[h]);g!=f&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,g?1:0),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,l.minFilter),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,l.magFilter),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,l.wrapS),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,l.wrapT),l.isDepth&&(t.texParameteri(t.TEXTURE_CUBE_MAP,t.DEPTH_TEXTURE_MODE,l.depthMode),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_COMPARE_MODE,l.depthCompareMode),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_COMPARE_FUNC,l.depthCompareFunc)),l.generateMipmap&&t.generateMipmap(t.TEXTURE_CUBE_MAP),t.bindTexture(t.TEXTURE_CUBE_MAP,null);var _=new SglTextureInfo;return _.handle=c,_.valid=!0,_.target=t.TEXTURE_CUBE_MAP,_.format=e,_.width=n,_.height=i,_.minFilter=l.minFilter,_.magFilter=l.magFilter,_.wrapS=l.wrapS,_.wrapT=l.wrapT,_.isDepth=l.isDepth,_.depthMode=l.depthMode,_.depthCompareMode=l.depthCompareMode,_.depthCompareFunc=l.depthCompareFunc,_
}function sglTextureCubeFromImages(t,e,n){var i=sglGetTextureOptions(t,n),r=t.createTexture();t.bindTexture(t.TEXTURE_CUBE_MAP,r);var s=t.getParameter(t.UNPACK_FLIP_Y_WEBGL),o=i.flipY===!0;s!=o&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,o?1:0);for(var u=0;6>u;++u)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+u,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e[u]);s!=o&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,s?1:0),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,i.minFilter),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,i.magFilter),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,i.wrapS),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,i.wrapT),i.generateMipmap&&t.generateMipmap(t.TEXTURE_CUBE_MAP),t.bindTexture(t.TEXTURE_CUBE_MAP,null);var l=new SglTextureInfo;return l.handle=r,l.valid=!0,l.target=t.TEXTURE_CUBE_MAP,l.format=t.RGBA,l.width=e[0].width,l.height=e[0].height,l.minFilter=i.minFilter,l.magFilter=i.magFilter,l.wrapS=i.wrapS,l.wrapT=i.wrapT,l.isDepth=!1,l.depthMode=0,l.depthCompareMode=0,l.depthCompareFunc=0,l}function sglTextureCubeFromUrls(t,e,n){for(var i=sglGetTextureOptions(t,n),r=new SglTextureInfo,s=6,o=new Array(6),u=0;6>u;++u)o[u]=new Image;for(var l=function(){if(s--,0==s){var n=sglTextureCubeFromImages(t,o,i);for(var u in n)r[u]=n[u];i.onload&&i.onload(t,r,e)}},u=0;6>u;++u)o[u].onload=l,o[u].src=e[u];return r}function SglRenderbufferInfo(){this.handle=null,this.valid=!1,this.target=0,this.format=0,this.width=0,this.height=0}function sglRenderbufferFromFormat(t,e,n,i){var r=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,r),t.renderbufferStorage(t.RENDERBUFFER,e,n,i),t.bindRenderbuffer(t.RENDERBUFFER,null);var s=new SglRenderbufferInfo;return s.handle=r,s.valid=!0,s.target=t.RENDERBUFFER,s.format=e,s.width=n,s.height=i,s}function sglGetFramebufferOptions(t,e){var n={minFilter:t.LINEAR,magFilter:t.LINEAR,wrapS:t.CLAMP_TO_EDGE,wrapT:t.CLAMP_TO_EDGE,isDepth:!1,depthMode:t.LUMINANCE,depthCompareMode:t.COMPARE_R_TO_TEXTURE,depthCompareFunc:t.LEQUAL,colorsAsRenderbuffer:!1,depthAsRenderbuffer:!1,stencilAsRenderbuffer:!1,generateColorsMipmap:!1,generateDepthMipmap:!1,generateStencilMipmap:!1};return _sglConsolidateOptions(n,e)}function SglFramebufferInfo(){this.handle=null,this.valid=!1,this.width=0,this.height=0,this.colorTargets=[],this.depthTarget=null,this.stencilTarget=null,this.status=0}function sglFramebufferFromTargets(t,e,n,i,r){var s=(sglGetFramebufferOptions(t,r),t.createFramebuffer());t.bindFramebuffer(t.FRAMEBUFFER,s),void 0!=n&&null!=n&&n!=t.NONE&&(n.target==t.TEXTURE_2D?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,n.handle,0):n.target==t.RENDERBUFFER&&t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,n.handle)),void 0!=i&&null!=i&&i!=t.NONE&&(i.target==t.TEXTURE_2D?t.framebufferTexture2D(t.FRAMEBUFFER,t.STENCIL_ATTACHMENT,t.TEXTURE_2D,i.handle,0):i.target==t.RENDERBUFFER&&t.framebufferRenderbuffer(t.FRAMEBUFFER,t.STENCIL_ATTACHMENT,t.RENDERBUFFER,i.handle));var o=[],u=[];if(void 0!=e&&null!=e){var l=e.length;if(0==l)u.push(t.NONE);else{var a=t.COLOR_ATTACHMENT0;for(var h in e){var c=e[h];c.target==t.TEXTURE_2D?t.framebufferTexture2D(t.FRAMEBUFFER,a,t.TEXTURE_2D,c.handle,0):c.target==t.RENDERBUFFER&&t.framebufferRenderbuffer(t.FRAMEBUFFER,a,t.RENDERBUFFER,c.handle),u.push(a),o.push(c),a++}}}var g=t.checkFramebufferStatus(t.FRAMEBUFFER);t.bindFramebuffer(t.FRAMEBUFFER,null);var f=null;o.length>0?f=o[0]:n?f=n:i&&(f=i);var _=0,d=0;f&&(_=f.width,d=f.height);var m=new SglFramebufferInfo;return m.handle=s,m.valid=g==t.FRAMEBUFFER_COMPLETE,m.width=_,m.height=d,m.colorTargets=o,m.depthTarget=n?n:null,m.stencilTarget=i?i:null,m.status=g,m}function sglFramebufferFromFormats(t,e,n,i,r,s,o){var u=sglGetFramebufferOptions(t,o),l=null;if(i){u.isDepth=!1,l=[];var a=null;if(u.colorsAsRenderbuffer)for(var h in i){var c=i[h];a=sglRenderbufferFromFormat(t,c,e,n),l.push(a)}else{u.generateMipmap=u.generateColorsMipmap;for(var h in i){var c=i[h];a=sglTexture2DFromData(t,c,e,n,t.RGBA,t.UNSIGNED_BYTE,null,u),l.push(a)}}}var g=null;r&&(u.isDepth=!0,u.depthAsRenderbuffer?g=sglRenderbufferFromFormat(t,r,e,n):(u.generateMipmap=u.generateDepthMipmap,g=sglTexture2DFromData(t,r,e,n,t.DEPTH_COMPONENT,t.FLOAT,null,u)));var f=null;return s&&(u.isDepth=!1,u.stencilAsRenderbuffer?f=sglRenderbufferFromFormat(t,s,e,n):(u.generateMipmap=u.generateStencilMipmap,f=sglTexture2DFromData(t,s,e,n,t.STENCIL_COMPONENT,t.UNSIGNED_BYTE,null,u))),sglFramebufferFromTargets(t,l,g,f,u)}function SglVertexBuffer(){this.gl=arguments[0],this._info=null,this._info=arguments[1]instanceof SglBufferInfo?arguments[1]:sglVertexBufferFromData(this.gl,arguments[1],arguments[2])}function SglIndexBuffer(){this.gl=arguments[0],this._info=null,this._info=arguments[1]instanceof SglBufferInfo?arguments[1]:sglIndexBufferFromData(this.gl,arguments[1],arguments[2])}function SglProgramAttribute(t,e){this._prog=t,this._info=e}function SglProgramUniform(t,e){this._prog=t,this._info=e,this._func=null;var n=this._prog.gl,i=this._info.nativeType;i==n.BOOL?this._func=function(t){this._prog.gl.uniform1i(this._info.location,t)}:i==n.BOOL_VEC2?this._func=function(t){this._prog.gl.uniform2iv(this._info.location,t)}:i==n.BOOL_VEC3?this._func=function(t){this._prog.gl.uniform3iv(this._info.location,t)}:i==n.BOOL_VEC4?this._func=function(t){this._prog.gl.uniform4iv(this._info.location,t)}:i==n.INT?this._func=function(t){this._prog.gl.uniform1i(this._info.location,t)}:i==n.INT_VEC2?this._func=function(t){this._prog.gl.uniform2iv(this._info.location,t)}:i==n.INT_VEC3?this._func=function(t){this._prog.gl.uniform3iv(this._info.location,t)}:i==n.INT_VEC4?this._func=function(t){this._prog.gl.uniform4iv(this._info.location,t)}:i==n.FLOAT?this._func=function(t){this._prog.gl.uniform1f(this._info.location,t)}:i==n.FLOAT_VEC2?this._func=function(t){this._prog.gl.uniform2fv(this._info.location,t)}:i==n.FLOAT_VEC3?this._func=function(t){this._prog.gl.uniform3fv(this._info.location,t)}:i==n.FLOAT_VEC4?this._func=function(t){this._prog.gl.uniform4fv(this._info.location,t)}:i==n.FLOAT_MAT2?this._func=function(t){this._prog.gl.uniformMatrix2fv(this._info.location,this._prog.gl.FALSE,t)}:i==n.FLOAT_MAT3?this._func=function(t){this._prog.gl.uniformMatrix3fv(this._info.location,this._prog.gl.FALSE,t)}:i==n.FLOAT_MAT4?this._func=function(t){this._prog.gl.uniformMatrix4fv(this._info.location,this._prog.gl.FALSE,t)}:sglUnknown()}function SglProgramSampler(t,e){this._prog=t,this._info=e,this._unit=-1;var n=this._prog.gl,i=this._info.nativeType;i==n.SAMPLER_2D||i==n.SAMPLER_CUBE||35682==i||sglUnknown()}function SglProgram(){this.gl=arguments[0],this._info=null,this._info=arguments[1]instanceof SglProgramInfo?arguments[1]:sglProgramFromSources(this.gl,arguments[1],arguments[2]),this._attributes=new Object;for(var t in this._info.attributes)this._attributes[t]=new SglProgramAttribute(this,this._info.attributes[t]);this._uniforms=new Object;for(var e in this._info.uniforms)this._uniforms[e]=new SglProgramUniform(this,this._info.uniforms[e]);var n=0;this._samplers=new Object;for(var i in this._info.samplers)this._samplers[i]=new SglProgramSampler(this,this._info.samplers[i]),this._samplers[i]._unit=n,n++}function SglTexture2D(){this.gl=arguments[0],this._info=null;var t=this.gl,e=arguments.length;this._info=2==e||3==e?arguments[1]instanceof Image?sglTexture2DFromImage(t,arguments[1],arguments[2]):"string"==typeof arguments[1]?sglTexture2DFromUrl(t,arguments[1],arguments[2]):arguments[1]:sglTexture2DFromData(t,arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}function SglTextureCube(){this.gl=arguments[0],this._info=null;var t=this.gl,e=arguments.length;2==e||3==e?arguments[1]instanceof Array?arguments[1][0]instanceof Image?this._info=sglTextureCubeFromImages(t,arguments[1],arguments[2]):"string"==typeof arguments[1][0]&&(this._info=sglTextureCubeFromUrls(t,arguments[1],arguments[2])):this._info=arguments[1]:this._info=sglTextureCubeFromData(t,arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}function SglRenderbuffer(){this.gl=arguments[0],this._info=null;var t=this.gl,e=arguments.length;this._info=2==e?arguments[1]:sglRenderbufferFromFormat(t,arguments[1],arguments[2],arguments[3])}function SglFramebuffer(){this.gl=arguments[0],this._info=null;var t=this.gl,e=arguments.length;this._info=2==e?arguments[1]:sglFramebufferFromFormats(t,arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6]);var n=null,i=null;this._colorTargets=[];for(var r in this._info.colorTargets)n=this._info.colorTargets[r],i=null,n.target==t.TEXTURE_2D?i=new SglTexture2D(t,n):n.target==t.RENDERBUFFER&&(i=new SglRenderbuffer(t,n)),this._colorTargets.push(i);this._depthTarget=null,this._info.depthTarget&&(n=this._info.depthTarget,i=null,n.target==t.TEXTURE_2D?i=new SglTexture2D(t,n):n.target==t.RENDERBUFFER&&(i=new SglRenderbuffer(t,n)),this._depthTarget=i),this._stencilTarget=null,this._info.stencilTarget&&(n=this._info.stencilTarget,i=null,n.target==t.TEXTURE_2D?i=new SglTexture2D(t,n):n.target==t.RENDERBUFFER&&(i=new SglRenderbuffer(t,n)),this._stencilTarget=i)}function SglAttributeStreamJS(t,e,n,i){this._name=t,this._size=e,this._buff=i?n?n.slice():null:n}function SglVertexStreamJS(){this._attribs={},this._length=0}function SglPrimitiveStreamJS(t,e,n,i){this._name=t,this._mode=e,this._first=n?n:0,this._length=i?i:0}function SglArrayPrimitiveStreamJS(t,e,n,i){SglPrimitiveStreamJS.call(this,t,e,n,i),Object.defineProperty(this,"type",{get:function(){return SGL_ARRAY_PRIMITIVE_STREAM}})}function SglIndexedPrimitiveStreamJS(t,e,n,i){SglPrimitiveStreamJS.call(this,t,e,0,n.length),this._buff=i?n?n.slice():null:n,Object.defineProperty(this,"type",{get:function(){return SGL_INDEXED_PRIMITIVE_STREAM}}),Object.defineProperty(this,"buffer",{get:function(){return this._buff}}),Object.defineProperty(this,"length",{get:function(){return this._buff.length}})}function SglConnectivityJS(){this._prims={}}function SglMeshJS(){this._valid=!1,this._vert=new SglVertexStreamJS,this._conn=new SglConnectivityJS}function sglMeshJSImportOBJFromString(t,e){var n=[],i=[],r=[],s=[],o=[],u=[],l=[],a={},h=0,c=null,g=null,f=0,_=0,d=0,m=0,v=0,S=0,p=null,b=!1,E=!1,M=!1,T=e.split("\n");for(var R in T)if(c=T[R].replace(/[ \t]+/g," ").replace(/\s\s*$/,""),"#"!=c[0])if(p=c.split(" "),"v"==p[0])o.push(parseFloat(p[1])),o.push(parseFloat(p[2])),o.push(parseFloat(p[3]));else if("vt"==p[0])u.push(parseFloat(p[1])),u.push(parseFloat(p[2]));else if("vn"==p[0])l.push(parseFloat(p[1])),l.push(parseFloat(p[2])),l.push(parseFloat(p[3]));else if("f"==p[0]){if(4!=p.length)continue;for(var V=1;4>V;++V){if(!(p[V]in a)){if(g=p[V].split("/"),1==g.length)f=parseInt(g[0])-1,_=f,d=f;else{if(3!=g.length)return!1;f=parseInt(g[0])-1,_=parseInt(g[1])-1,d=parseInt(g[2])-1}m=0,v=0,S=0,3*f+2<o.length&&(b=!0,m=o[3*f+0],v=o[3*f+1],S=o[3*f+2]),n.push(m),n.push(v),n.push(S),m=0,v=0,2*_+1<u.length&&(E=!0,m=u[2*_+0],v=u[2*_+1]),i.push(m),i.push(v),m=0,v=0,S=1,3*d+2<l.length&&(M=!0,m=l[3*d+0],v=l[3*d+1],S=l[3*d+2]),r.push(m),r.push(v),r.push(S),a[p[V]]=h++}s.push(a[p[V]])}}return b&&t.addVertexAttribute("position",3,n,!1),M&&t.addVertexAttribute("normal",3,r,!1),E&&t.addVertexAttribute("texcoord",2,i,!1),s.length>0&&t.addIndexedPrimitives("triangles",SGL_TRIANGLES_LIST,s,!1),!0}function sglMeshJSImportOBJFromURL(t,e,n,i){if(t.isValid=!1,!n){var r=sglLoadFile(e);return t.isValid=sglMeshJSImportOBJFromString(t,r),i&&i(t,e),t.isValid}return sglLoadFile(e,function(n){t.isValid=sglMeshJSImportOBJFromString(t,n),i&&i(t,e)}),!0}function _sglFindVertexAttributeJSON(t,e){for(var n in t.vertices)if(t.vertices[n].name===e)return t.vertices[n];return null}function _sglFindConnectivityJSON(t,e){for(var n in t.connectivity)if(t.connectivity[n].name===e)return t.connectivity[n];return null}function sglMeshJSImportJSONFromString(t,e){var n=JSON.parse(e);if(!n)return!1;var i=n.mapping,r=null;for(var s in i)if("standard"===i[s].name){r=i[s];break}if(!r)return!1;for(var o in r.attributes){var u=r.attributes[o],l=_sglFindVertexAttributeJSON(n,u.source);if(l){if(l.normalized)for(var a=0,h=l.values.length;h>a;++a)l.values[a]/=255;t.addVertexAttribute(u.semantic,l.size,l.values,!1)}}var c=_sglFindConnectivityJSON(n,r.primitives);return c?(t.addIndexedPrimitives(c.name,SGL_TRIANGLES_LIST,c.indices,!1),!0):!1}function sglMeshJSImportJSONFromURL(t,e,n,i){if(t.isValid=!1,!n){var r=sglLoadFile(e);return t.isValid=sglMeshJSImportJSONFromString(t,r),i&&i(t,e),t.isValid}return sglLoadFile(e,function(n){t.isValid=sglMeshJSImportJSONFromString(t,n),i&&i(t,e)}),!0}function sglGLTypeSize(t,e){return e==t.BYTE?1:e==t.UNSIGNED_BYTE?1:e==t.SHORT?2:e==t.UNSIGNED_SHORT?2:e==t.INT?4:e==t.UNSIGNED_INT?4:e==t.FLOAT?4:null}function sglGLTypeFromWebGLArray(t,e){return e instanceof Int8Array?t.BYTE:e instanceof Uint8Array?t.UNSIGNED_BYTE:e instanceof Int16Array?t.SHORT:e instanceof Uint16Array?t.UNSIGNED_SHORT:e instanceof Int32Array?t.INT:e instanceof Uint32Array?t.UNSIGNED_INT:e instanceof Float32Array?t.FLOAT:null}function SglAttributeStreamGL(t,e,n,i,r){var s=sglGLTypeFromWebGLArray(t,i),o=sglGLTypeSize(t,s)*n;this.gl=t,this._name=e,this._size=n,this._type=s,this._norm=r?!0:!1,this._stride=o,this._offset=0,this._length=i.length/n,this._buff=new SglVertexBuffer(t,i,{usage:t.STATIC_DRAW})}function SglVertexStreamGL(t){this.gl=t,this._attribs=new Object,this._length=0}function SglPrimitiveStreamGL(t,e,n,i,r){this.gl=t,this._name=e,this._mode=n,this._first=i?i:0,this._length=r?r:0}function SglArrayPrimitiveStreamGL(t,e,n,i,r){SglPrimitiveStreamGL.call(this,t,e,n,i,r),Object.defineProperty(this,"type",{get:function(){return SGL_ARRAY_PRIMITIVE_STREAM}})}function SglIndexedPrimitiveStreamGL(t,e,n,i){SglPrimitiveStreamGL.call(this,t,e,n,0,i.length);var r=sglGLTypeFromWebGLArray(t,i),s=sglGLTypeSize(t,r);this._idxType=r,this._stride=s,this._buff=new SglIndexBuffer(t,i,{usage:t.STATIC_DRAW}),Object.defineProperty(this,"indexType",{get:function(){return this._idxType}}),Object.defineProperty(this,"stride",{get:function(){return this._stride}}),Object.defineProperty(this,"type",{get:function(){return SGL_INDEXED_PRIMITIVE_STREAM}})}function SglPackedIndexedPrimitiveStreamGL(t,e,n,i,r,s){r.length!=s.length&&sglInvalidParameter(),SglPrimitiveStreamGL.call(this,t,e,n,0,i.length);var o=sglGLTypeFromWebGLArray(t,i),u=sglGLTypeSize(t,o);this._idxType=o,this._stride=u,this._buff=new SglIndexBuffer(t,i,{usage:t.STATIC_DRAW}),this._blockStartingVertices=s.slice();var l=this._blockStartingVertices.length;this._blockStartingIndices=r.slice(),this._blockIndicesCount=new Array(l);for(var a=this._blockStartingIndices[0],h=0;l-1>h;++h){var c=this._blockStartingIndices[h+1];this._blockIndicesCount[h]=c-a,a=c}this._blockIndicesCount[l-1]=i.length-a,Object.defineProperty(this,"isPacked",{get:function(){return!0}}),Object.defineProperty(this,"indexType",{get:function(){return this._idxType}}),Object.defineProperty(this,"stride",{get:function(){return this._stride}}),Object.defineProperty(this,"type",{get:function(){return SGL_PACKED_INDEXED_PRIMITIVE_STREAM}}),Object.defineProperty(this,"blocksCount",{get:function(){return this._blockStartingIndices.length}}),Object.defineProperty(this,"blockStartingVertices",{get:function(){return this._blockStartingVertices}}),Object.defineProperty(this,"blockIndicesCount",{get:function(){return this._blockIndicesCount}})}function SglConnectivityGL(t){this.gl=t,this._prims=new Object}function SglMeshGL(t){this.gl=t,this._vert=new SglVertexStreamGL(this.gl),this._conn=new SglConnectivityGL(this.gl)}function SglMeshGLRenderer(t,e){this._prog=t,this._mapping=null,this._meshAttrMap=null,this._mesh=null,this._primStream=null,this._phase=0,this._updateEnabledVB=!1,e&&this.synchronizeProgram(),this.setStreamMapping()}function sglRenderMeshGLPrimitives(t,e,n,i,r,s,o,u){var l=new SglMeshGLRenderer(n);if(l.begin(),i&&l.setStreamMapping(i),r&&l.setUniforms(r),s&&l.setSamplers(s),e)l.renderMeshPrimitives(t,e,o,u);else{var a=t.connectivity.primitives;for(var h in a)l.renderMeshPrimitives(t,h,o,u)}}function sglMeshJSCalculateBBox(t,e){var n=e||"position",i=t.vertices.attributes[n],r=i.size,s=i.buffer,o=new SglBox3;if(3!=r)return o;var u=s.length/r;if(0>=u)return o;u*=r;for(var l=0;r>l;++l)o.min[l]=s[l],o.max[l]=s[l];for(var a=0,h=r;u>h;h+=r)for(var l=0;r>l;++l)a=s[h+l],o.min[l]>a&&(o.min[l]=a),o.max[l]<a&&(o.max[l]=a);return o}function sglGLPrimitiveType(t,e){switch(e){case SGL_POINTS_LIST:return t.POINTS;case SGL_LINES_LIST:return t.LINES;case SGL_LINE_STRIP:return t.LINE_STRIP;case SGL_LINE_LOOP:return t.LINE_LOOP;case SGL_TRIANGLES_LIST:return t.TRIANGLES;case SGL_TRIANGLE_STRIP:return t.TRIANGLE_STRIP;case SGL_TRIANGLE_FAN:return t.TRIANGLE_FAN;default:return void 0}return void 0}function sglMeshJStoGL(t,e){var n=new SglMeshGL(t);for(a in e.vertices.attributes){var i=e.vertices.attributes[a];n.addVertexAttribute(i.name,i.size,new Float32Array(i.buffer))}for(p in e.connectivity.primitives){var r=e.connectivity.primitives[p],s=sglGLPrimitiveType(n.gl,r.mode);if(void 0!=s)switch(r.type){case SGL_ARRAY_PRIMITIVE_STREAM:n.addArrayPrimitives(r.name,s,r.first,r.length);break;case SGL_INDEXED_PRIMITIVE_STREAM:n.addIndexedPrimitives(r.name,s,new Uint16Array(r.buffer))}}return n}function sglPackMeshJStoGL(t,e,n,i){var r=n||"triangles",s=i||65e3,o=e.connectivity.primitives[r];if(!o)return null;if(o.type!=SGL_INDEXED_PRIMITIVE_STREAM)return null;var u=sglGLPrimitiveType(t,o.mode);if(void 0==u)return null;var l=0;if(u===t.TRIANGLES)l=3;else if(u===t.LINES)l=2;else{if(u!==t.POINTS)return null;l=1}var a=o.buffer,h=a.length;h-=h%l;var c=0,g=0,f=0,_=[],d=[],m=[],v={};for(var S in e.vertices.attributes){var p=e.vertices.attributes[S];v[S]={name:p.name,size:p.size,buffer:[]}}for(;h>c;){for(var b={},E=[],M=0,b={},M=0,T=c;h>T;T+=l){for(var R={},V=0,j=0;l>j;++j){var P=a[T+j];void 0==R[P]&&(R[P]=!0,void 0==b[P]&&V++)}if(!(s>=M+V))break;for(var j=0;l>j;++j){var P=a[T+j],y=b[P];void 0==y&&(b[P]=M,y=M,M++),E.push(y)}c+=l}if(0>=M)break;var A=E.length;for(var S in e.vertices.attributes){var O=e.vertices.attributes[S],L=v[S],x=O.size,I=L.buffer.length,C=new Array(M*x);L.buffer=L.buffer.concat(C);var D=O.buffer,w=L.buffer;for(var T in b)for(var y=b[T],F=0;x>F;++F)w[I+(y*x+F)]=D[T*x+F]}m=m.concat(E),_.push(g),d.push(f),g+=M,f+=A}var U=new SglMeshGL(t);for(var S in v){var p=v[S];U.addVertexAttribute(p.name,p.size,new Float32Array(p.buffer))}return 1==_.length?U.addIndexedPrimitives(r,u,new Uint16Array(m)):U.addPackedIndexedPrimitives(r,u,new Uint16Array(m),d,_),U}function SglTrackball(){this._matrix=sglIdentityM4(),this._pts=[[0,0],[0,0]],this._action=SGL_TRACKBALL_NO_ACTION,this.reset()}function SglFirstPersonCamera(){this._position=sglZeroV3(),this._angles=sglZeroV3(),this.lookAt(0,0,0,0,0,-1,0)}function sglGetCanvasContext(t){var e=document.getElementById(t);if(!e)return null;for(var n=["webgl","experimental-webgl","moz-webgl","webkit-3d"],i=null,r=0;r<n.length;r++){try{i=e.getContext(n[r])}catch(s){i=null}if(i)break}return null==i?null:(void 0==i.FALSE&&(i.FALSE=0),void 0==i.TRUE&&(i.TRUE=1),i)}function SglCanvasUI(t,e,n,i){this._manager=t,this._handler=e,this._canvas=n,this._timerID=null,this._updRate=0,this._ignoreKeyRepeat=!0,this.gl=i,this.loadEvent=null,this.unloadEvent=null,this.keyDownEvent=null,this.keyUpEvent=null,this.keyPressEvent=null,this.mouseDownEvent=null,this.mouseUpEvent=null,this.mouseMoveEvent=null,this.mouseWheelEvent=null,this.clickEvent=null,this.dblClickEvent=null,this.resizeEvent=null,this.updateEvent=null,this.drawEvent=null,this.keysDown=new Object,this.mouseButtonsDown=new Object,this.mousePos={x:0,y:0},this.mousePrevPos={x:0,y:0},this.mouseDeltaPos={x:0,y:0},this.timeNow=Date.now()/1e3,this.timePrev=this.timeNow,this.timeDelta=0}function _SglCanvasManager(t,e,n){var i=document.getElementById(t);if(!i)throw new Error("SpiderGL : Canvas not found");i.contentEditable=!0;var r=sglGetCanvasContext(t);if(!r)throw new Error("SpiderGL : Cannot get WebGL context");r.pixelStorei(r.PACK_ALIGNMENT,1),r.pixelStorei(r.UNPACK_ALIGNMENT,1),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r.pixelStorei(r.UNPACK_COLORSPACE_CONVERSION_WEBGL,r.NONE),r.bindFramebuffer(r.FRAMEBUFFER,null);var s=new SglCanvasUI(this,e,i,r);this.ui=s;var o=this;this.gl=r,this.canvas=i,this.handler=e,this.handler.ui=s,this._drawPending=!1,this.rendering=!0,this._drawFunc=function(){o.draw()},this.canvas.addEventListener("load",function(t){o.load(t)},!1),this.canvas.addEventListener("unload",function(t){o.unload(t)},!1),this.canvas.addEventListener("keydown",function(t){o.keyDown(t)},!1),this.canvas.addEventListener("keyup",function(t){o.keyUp(t)},!1),this.canvas.addEventListener("keypress",function(t){o.keyPress(t)},!1),this.canvas.addEventListener("mousedown",function(t){o.mouseDown(t)},!1),this.canvas.addEventListener("mouseup",function(t){o.mouseUp(t)},!1),this.canvas.addEventListener("mousemove",function(t){o.mouseMove(t)},!1),this.canvas.addEventListener("click",function(t){o.click(t)},!1),this.canvas.addEventListener("dblclick",function(t){o.dblClick(t)},!1),this.canvas.addEventListener("resize",function(t){o.resize(t)},!1),this.canvas.addEventListener("mousewheel",function(t){o.mouseWheel(t)},!1),this.canvas.addEventListener("DOMMouseScroll",function(t){o.mouseWheel(t)},!1),this.canvas.addEventListener("blur",function(t){o.blur(t)},!1),this.canvas.addEventListener("mouseout",function(t){o.mouseOut(t)},!1),this.canvas.addEventListener("mouseover",function(t){o.mouseOver(t)},!1),this.canvas.addEventListener("touchstart",function(t){o.touchStart(t)},!1),this.canvas.addEventListener("touchend",function(t){o.touchEnd(t)},!1),this.canvas.addEventListener("touchmove",function(t){o.touchMove(t)},!1),this.load(),n&&(this.ui.updateRate=n)}function _sglManageCanvas(t,e,n){var i=new _SglCanvasManager(t,e,n);_SGL_RegisteredCanvas[t]=i}function _sglUnmanageCanvas(t){_SGL_RegisteredCanvas[t]&&(_SGL_RegisteredCanvas[t]=null,delete _SGL_RegisteredCanvas[t])}function _sglManageCanvasOnLoad(t,e,n){window.addEventListener("load",function(){_sglManageCanvas(t,e,n)},!1)}function _sglUnmanageCanvasOnLoad(t){window.addEventListener("unload",function(){_sglUnmanageCanvas(t)},!1)}function sglRegisterCanvas(t,e,n){_sglManageCanvasOnLoad(t,e,n),_sglUnmanageCanvasOnLoad(t)}function sglRegisterLoadedCanvas(t,e,n){_sglManageCanvas(t,e,n),_sglUnmanageCanvasOnLoad(t)}var SGL_VERSION_MAJOR=0,SGL_VERSION_MINOR=1,SGL_VERSION_REVISION=1,SGL_VERSION_STRING=SGL_VERSION_MAJOR+"."+SGL_VERSION_MINOR+"."+SGL_VERSION_REVISION;window.addEventListener("load",function(){sglInitialize()},!1),window.addEventListener("unload",function(){sglFinalize()},!1);var SGL_REQUEST_FAILED=0,SGL_REQUEST_SUCCEEDED=1,SGL_REQUEST_IDLE=2,SGL_REQUEST_ONGOING=3,SGL_REQUEST_ABORTED=4,SGL_REQUEST_QUEUED=5,SGL_REQUEST_REJECTED=6,SGL_REQUEST_CANCELLED=7;SglRequest.prototype={_createOnReadyCallback:function(){var t=this,e=function(e){t._status=e?SGL_REQUEST_SUCCEEDED:SGL_REQUEST_FAILED,t._queue&&(t._queue._requestReady(t),this._queue=null);for(var n=t._onReady.length,i=0;n>i;++i)t._onReady[i](t)};return e},get status(){return this._status},get priority(){return this._priority},set priority(t){this._priority=t,this._queue&&this._queue._updateRequest(this)},get succeeded(){return this._status==SGL_REQUEST_SUCCEEDED},get failed(){return this._status==SGL_REQUEST_FAILED},addOnReadyCallback:function(t){t&&(this._onReady.push(t),this.isReady&&t(this))},removeOnReadyCallback:function(t){for(var e=-1,n=this._onReady.length,i=0;n>i;++i)if(this._onReady[i]==t){e=i;break}0>e||this._onReady.splice(e,1)},get isReady(){return this.failed||this.succeeded},get queue(){return this._queue},send:function(){if(!this._send)return!1;var t=this._send();if(t)this._status=SGL_REQUEST_ONGOING;else{this._status=SGL_REQUEST_FAILED;var e=this._createOnReadyCallback();e(!1)}return t},cancel:function(){this._status==SGL_REQUEST_QUEUED&&(this._queue&&(this._queue._removeQueuedRequest(this),this._queue=null),this._status=SGL_REQUEST_CANCELLED)},abort:function(){this.cancel(),this._status==SGL_REQUEST_ONGOING&&(this._queue&&(this._queue._removeOngoingRequest(this),this._queue=null),this._abort&&this._abort(),this._status=SGL_REQUEST_ABORTED)}},sglInherit(SglTextFileRequest,SglRequest),SglTextFileRequest.prototype._send=function(){if(!this._url)return!1;var t=new XMLHttpRequest;this._req=t;var e=this._createOnReadyCallback();return t.onreadystatechange=function(){if(4==t.readyState){var n=t.status?200==t.status:!0;e(n)}},t.open("GET",this._url,!0),t.send(),!0},SglTextFileRequest.prototype._abort=function(){this._req&&this._req.abort()},sglInherit(SglImageRequest,SglRequest),SglImageRequest.prototype._send=function(){if(!this._url)return!1;var t=new Image;this._img=t;var e=this._createOnReadyCallback();return t.onload=function(){e(t.complete)},t.onerror=function(){e(!1)},t.src=this._url,!0},SglImageRequest.prototype._abort=function(){},SglRequestWatcher.prototype={get requests(){return this._reqs},get succeeded(){return this._succeededReqs==this._reqs.length},get failed(){return this._succeededReqs+this._failedReqs<this._reqs.length?!1:this._succeededReqs<this._reqs.length},get onReady(){return this._onReady},set onReady(e){this._onReady=e,this.isReady&&this._onReady&&this._onReady(t)},get isReady(){return this._succeededReqs+this._failedReqs==this._reqs.length},send:function(){for(var t=this._reqs.length,e=0;t>e;++e)this._reqs[e].send()},cancel:function(){for(var t=this._reqs.length,e=0;t>e;++e)this._reqs[e].cancel()},abort:function(){for(var t=this._reqs.length,e=0;t>e;++e)this._reqs[e].abort()}},SglRequestQueue.prototype={_sort:function(){this._dirty&&(this._dirty=!1,this._minPriorityReq=null,this._queued.length<=0||(this._priorityCompare?this._queued.sort(this._priorityCompare):this._queued.sort(),this._queued.length>0&&(this._minPriorityReq=this._queued[0])))},_updateMinPriority:function(){this._minPriorityReq=null;var t=this._queued.length;if(!(0>=t)&&(this._minPriorityReq=this._queued[0],this._dirty))for(var e=1;t>e;++e)this.comparePriorities(this._queued[e].priority,this._minPriorityReq.priority)<=0&&(this._minPriorityReq=this._queued[e])},_removeFromArray:function(t,e){for(var n=-1,i=t.length,r=0;i>r;++r)if(t[r]==e){n=r;break}0>n||t.splice(n,1)},_removeQueuedRequest:function(t){this._removeFromArray(this._queued,t),this._queued.length<=0?this._minPriorityReq=null:t==this._minPriorityReq&&this._updateMinPriority()},_removeOngoingRequest:function(t){this._removeFromArray(this._ongoing,t),this._execute()},_updateRequest:function(t){this.comparePriorities(t.priority,this._minPriorityReq.priority)<=0&&(this._minPriorityReq=t),this._dirty=!0},_requestReady:function(t){this._removeOngoingRequest(t),this._onReady&&this._onReady(t),this._execute()},_execute:function(){var t=this._queued.length;if(!(0>=t)){var e=this._maxOngoing>0?this._maxOngoing-this._ongoing.length:t;if(!(0>=e)){e>t&&(e=t),this._sort();for(var n=null,i=0;e>i;++i)n=this._queued.pop(),n.send();this._queued.length>0&&(this._minPriorityReq=this._queued[0])}}},comparePriorities:function(t,e){return this._priorityCompare?this._priorityCompare(t,e):t-e},get priorityCompare(){return this._priorityCompare},set priorityCompare(t){this._priorityCompare=t,this._updateMinPriority()},get onReady(){return this._onReady},set onReady(t){this._onReady=t},push:function(t){var e={victims:null,result:!1};if(t.queue)return e;var n=this._queued.length,i=this._maxQueued>0&&n>=this._maxQueued;if(i&&this.comparePriorities(t.priority,this._minPriorityReq.priority)<=0)return t._status=SGL_REQUEST_REJECTED,e;this._queued.push(t),t._queue=this,t._status=SGL_REQUEST_QUEUED,n++,e.result=!0;var r=this._maxQueued>0?n-this._maxQueued:0;if(0>=r)null!=this._minPriorityReq?this.comparePriorities(t.priority,this._minPriorityReq.priority)<=0&&(this._minPriorityReq=t):this._minPriorityReq=t,this._dirty=!0;else{this._sort(),e.victims=this._queued.slice(0,r),this._queued.splice(0,r);for(var s=0;r>s;++s)e.victims[s]._status=SGL_REQUEST_REJECTED,e.victims[s]._queue=null}return this._execute(),e}};var SGL_PI=Math.PI;SglVec2.prototype={clone:function(){return new SglVec2(this)},get copy(){return this.clone()},get x(){return this.v[0]},set x(t){this.v[0]=t},get y(){return this.v[1]},set y(t){this.v[1]=t},set:function(t,e){return this.v[0]=t,this.v[1]=e,this},setVec:function(t){return this.set(t[0],t[1])},setScalar:function(t){return this.set(t,t)},setZero:function(){return this.setScalar(0)},setOne:function(){return this.setScalar(1)},at:function(t){return this.v[t]},get squaredLength(){return this.dot(this)},get length(){return sglSqrt(this.squaredLength)},normalize:function(){var t=this.length;return t>0&&(t=1/t),this.v[0]*=t,this.v[1]*=t,this},get normalized(){return this.clone().normalize()},get neg(){return new SglVec2(-this.v[0],-this.v[1])},get abs(){return new SglVec2(sglAbs(this.v[0]),sglAbs(this.v[1]))},get minComp(){var t=this.v[0];return t>this.v[1]&&(t=this.v[1]),t},get maxComp(){var t=this.v[0];return t<this.v[1]&&(t=this.v[1]),t},get argMin(){var t=0;return this.v[t]>this.v[1]&&(t=1),t},get argMax(){var t=0;return this.v[t]>this.v[1]&&(t=1),t},add:function(t){return new SglVec2(this.v[0]+t.v[0],this.v[1]+t.v[1])},sub:function(t){return new SglVec2(this.v[0]-t.v[0],this.v[1]-t.v[1])},mul:function(t){return new SglVec2(this.v[0]*t.v[0],this.v[1]*t.v[1])},div:function(t){return new SglVec2(this.v[0]/t.v[0],this.v[1]/t.v[1])},get rcp(){return new SglVec2(1/this.v[0],1/this.v[1])},dot:function(t){return this.v[0]*t.v[0]+this.v[1]*t.v[1]},cross:function(t){return this.v[0]*t.v[1]-this.v[1]*t.v[0]},min:function(t){return new SglVec2(sglMin(this.v[0],t.v[0]),sglMin(this.v[1],t.v[1]))},max:function(t){return new SglVec2(sglMax(this.v[0],t.v[0]),sglMax(this.v[1],t.v[1]))}},SglVec3.prototype={clone:function(){return new SglVec3(this)},get copy(){return this.clone()},get x(){return this.v[0]},set x(t){this.v[0]=t},get y(){return this.v[1]},set y(t){this.v[1]=t},get z(){return this.v[2]},set z(t){this.v[2]=t},set:function(t,e,n){return this.v[0]=t,this.v[1]=e,this.v[2]=n,this},setVec:function(t){return this.set(t[0],t[1],t[2])},setScalar:function(t){return this.set(t,t,t)},setZero:function(){return this.setScalar(0)},setOne:function(){return this.setScalar(1)},at:function(t){return this.v[t]},get squaredLength(){return this.dot(this)},get length(){return sglSqrt(this.squaredLength)},normalize:function(){var t=this.length;return t>0&&(t=1/t),this.v[0]*=t,this.v[1]*=t,this.v[2]*=t,this},get normalized(){return this.clone().normalize()},get neg(){return new SglVec3(-this.v[0],-this.v[1],-this.v[2])},get abs(){return new SglVec3(sglAbs(this.v[0]),sglAbs(this.v[1]),sglAbs(this.v[2]))},get minComp(){var t=this.v[0];return t>this.v[1]&&(t=this.v[1]),t>this.v[2]&&(t=this.v[2]),t},get maxComp(){var t=this.v[0];return t<this.v[1]&&(t=this.v[1]),t<this.v[2]&&(t=this.v[2]),t},get argMin(){var t=0;return this.v[t]>this.v[1]&&(t=1),this.v[t]>this.v[2]&&(t=2),t},get argMax(){var t=0;return this.v[t]>this.v[1]&&(t=1),this.v[t]>this.v[2]&&(t=2),t},add:function(t){return new SglVec3(this.v[0]+t.v[0],this.v[1]+t.v[1],this.v[2]+t.v[2])},sub:function(t){return new SglVec3(this.v[0]-t.v[0],this.v[1]-t.v[1],this.v[2]-t.v[2])},mul:function(t){return new SglVec3(this.v[0]*t.v[0],this.v[1]*t.v[1],this.v[2]*t.v[2])},div:function(t){return new SglVec3(this.v[0]/t.v[0],this.v[1]/t.v[1],this.v[2]/t.v[2])},get rcp(){return new SglVec3(1/this.v[0],1/this.v[1],1/this.v[2])},dot:function(t){return this.v[0]*t.v[0]+this.v[1]*t.v[1]+this.v[2]*t.v[2]},cross:function(t){return new SglVec3(this.v[1]*t.v[2]-this.v[2]*t.v[1],this.v[2]*t.v[0]-this.v[0]*t.v[2],this.v[0]*t.v[1]-this.v[1]*t.v[0])},min:function(t){return new SglVec3(sglMin(this.v[0],t.v[0]),sglMin(this.v[1],t.v[1]),sglMin(this.v[2],t.v[2]))},max:function(t){return new SglVec3(sglMax(this.v[0],t.v[0]),sglMax(this.v[1],t.v[1]),sglMax(this.v[2],t.v[2]))
}},SglVec4.prototype={clone:function(){return new SglVec4(this)},get copy(){return this.clone()},get x(){return this.v[0]},set x(t){this.v[0]=t},get y(){return this.v[1]},set y(t){this.v[1]=t},get z(){return this.v[2]},set z(t){this.v[2]=t},get w(){return this.v[3]},set w(t){this.v[3]=t},set:function(t,e,n,i){return this.v[0]=t,this.v[1]=e,this.v[2]=n,this.v[3]=i,this},setVec:function(t){return this.set(t[0],t[1],t[2],t[3])},setScalar:function(t){return this.set(t,t,t,t)},setZero:function(){return this.setScalar(0)},setOne:function(){return this.setScalar(1)},at:function(t){return this.v[t]},get squaredLength(){return this.dot(this)},get length(){return sglSqrt(this.squaredLength)},normalize:function(){var t=this.length;return t>0&&(t=1/t),this.v[0]*=t,this.v[1]*=t,this.v[2]*=t,this.v[3]*=t,this},get normalized(){return this.clone().normalize()},get neg(){return new SglVec4(-this.v[0],-this.v[1],-this.v[2],-this.v[3])},get abs(){return new SglVec4(sglAbs(this.v[0]),sglAbs(this.v[1]),sglAbs(this.v[2]),sglAbs(this.v[3]))},get minComp(){var t=this.v[0];return t>this.v[1]&&(t=this.v[1]),t>this.v[2]&&(t=this.v[2]),t>this.v[3]&&(t=this.v[3]),t},get maxComp(){var t=this.v[0];return t<this.v[1]&&(t=this.v[1]),t<this.v[2]&&(t=this.v[2]),t<this.v[3]&&(t=this.v[3]),t},get argMin(){var t=0;return this.v[t]>this.v[1]&&(t=1),this.v[t]>this.v[2]&&(t=2),this.v[t]>this.v[3]&&(t=2),t},get argMax(){var t=0;return this.v[t]>this.v[1]&&(t=1),this.v[t]>this.v[2]&&(t=2),this.v[t]>this.v[3]&&(t=2),t},add:function(t){return new SglVec4(this.v[0]+t.v[0],this.v[1]+t.v[1],this.v[2]+t.v[2],this.v[3]+t.v[3])},sub:function(t){return new SglVec4(this.v[0]-t.v[0],this.v[1]-t.v[1],this.v[2]-t.v[2],this.v[3]-t.v[3])},mul:function(t){return new SglVec4(this.v[0]*t.v[0],this.v[1]*t.v[1],this.v[2]*t.v[2],this.v[3]*t.v[3])},div:function(t){return new SglVec4(this.v[0]/t.v[0],this.v[1]/t.v[1],this.v[2]/t.v[2],this.v[3]/t.v[3])},get rcp(){return new SglVec4(1/this.v[0],1/this.v[1],1/this.v[2],1/this.v[3])},dot:function(t){return this.v[0]*t.v[0]+this.v[1]*t.v[1]+this.v[2]*t.v[2]+this.v[3]*t.v[3]},min:function(t){return new SglVec4(sglMin(this.v[0],t.v[0]),sglMin(this.v[1],t.v[1]),sglMin(this.v[2],t.v[2]),sglMin(this.v[3],t.v[3]))},max:function(t){return new SglVec4(sglMax(this.v[0],t.v[0]),sglMax(this.v[1],t.v[1]),sglMax(this.v[2],t.v[2]),sglMax(this.v[3],t.v[3]))}},SglPlane3.prototype={get normal(){return this._normal},set normal(t){this._normal=t.slice(0,3)},get offset(){return this._offset},set offset(t){this._offset=t.slize(0,3)},clone:function(){return new SglPlane3(this._normal,this._offset,!1)},get copy(){return this.clone()},setup:function(t,e){if(this._normal[0]=t[0],this._normal[1]=t[1],this._normal[2]=t[2],this._offset=e,normalize){var n=sglSqrt(sglDotV3(this._normal));n>0&&(n=1/n,sglSelfMulV3S(this._normal,n),this._offset*=n)}}},SglBox3.prototype={get min(){return this._min},set min(t){this._min=t.slice(0,3)},get max(){return this._max},set max(t){this._max=t.slice(0,3)},clone:function(){return new SglBox3(this._min,this._max)},get copy(){return this.clone()},setup:function(t,e){for(var n=0;3>n;++n)this._min[n]=t[n],this._max[n]=e[n];return this},get isNull(){return this._min[0]>this._max[0]},get isEmpty(){return this._min[0]==this._max[0]&&this._min[1]==this._max[1]&&this._min[2]==this._max[2]},get center(){return sglSelfMulV3S(sglAddV3(this._min,this._max),.5)},get size(){return sglSubV3(this._max,this._min)},get squaredDiagonal(){var t=this.size;return sglDotV3(t,t)},get diagonal(){return sglSqrt(this.squaredDiagonal)},get facesAreas(){var t=this.size;return[t[1]*t[2],t[0]*t[2],t[0]*t[1]]},get surfaceArea(){var t=this.facesArea;return 2*(t[0]+t[1]+t[2])},get volume(){var t=this.size;return t[0]*t[1]*t[2]},offset:function(t){return sglSelfSubV3S(this._min[i],t),sglSelfAddV3S(this._max[i],t),this},corner:function(t){var e=this.size;return[this._min[0]+(t%2!=0?1:0)*e[0],this._min[1]+(t/2%2!=0?1:0)*e[1],this._min[2]+(t>3!=0?1:0)*e[2]]},transformed:function(t){var e=new SglBox3,n=sglMulM4V3(t,this.corner(0),1);e.min=n,e.max=n;for(var i=1;8>i;++i)n=sglMulM4V3(t,this.corner(i),1),e.min=sglMinV3(e.min,n),e.max=sglMaxV3(e.max,n);return e},addPoint:function(t){return this.isNull?(this.min=t,this.max=t):(this.min=sglMinV3(this.min,t),this.max=sglMaxV3(this.min,t)),this},addBox:function(t){return t.isNull||(this.isNull?(this.min=t.min,this.max=t.max):(this.min=sglMinV3(this.min,t.min),this.max=sglMaxV3(this.max,t.max))),this}},SglSphere3.prototype={get center(){return this._center},set center(t){this._center=t.slice(0,3)},get radius(){return this._redius},set radius(t){this._radius=t},clone:function(){return new SglSphere3(this._center,this._radius)},get copy(){return this.clone()},setup:function(t,e){return this._center[0]=t[0],this._center[1]=t[1],this._center[2]=t[2],this._radius=e,this},get isNull(){return this._radius<0},get isEmpty(){return 0==this._radius},get surfaceArea(){return 4*SGL_PI*this._radius*this._radius},get volume(){return 4/3*SGL_PI*this._radius*this._radius*this._radius}},SglMatrixStack.prototype={clone:function(){var t=new SglMatrixStack;t.s=[];for(var e=0;e<this._n+1;++e)t._s.push(sglDupM4(this._s[e]));return t},get copy(){return this.clone()},reset:function(){return this._s=[],this._s.push(sglIdentityM4()),this._n=0,this},get size(){return this._n+1},get top(){return sglDupM4(this._s[this._n])},get topRef(){return this._s[this._n]},push:function(){return this._s.push(sglDupM4(this._s[this._n])),this._n++,this},pop:function(){return this._n>0&&(this._s.pop(),this._n--),this},load:function(t){return this._s[this._n]=sglDupM4(t),this},multiply:function(t){return this._s[this._n]=sglMulM4(this._s[this._n],t),this},loadIdentity:function(){return this._s[this._n]=sglIdentityM4(),this},translate:function(t,e,n){return this.multiply(sglTranslationM4C(t,e,n))},rotate:function(t,e,n,i){return this.multiply(sglRotationAngleAxisM4C(t,e,n,i))},scale:function(t,e,n){return this.multiply(sglScalingM4C(t,e,n))},lookAt:function(t,e,n,i,r,s,o,u,l){return this.multiply(sglLookAtM4C(t,e,n,i,r,s,o,u,l))},ortho:function(t,e,n,i,r,s){return this.multiply(sglOrthoM4C(t,e,n,i,r,s))},frustum:function(t,e,n,i,r,s){return this.multiply(sglFrustumM4C(t,e,n,i,r,s))},perspective:function(t,e,n,i){return this.multiply(sglPerspectiveM4(t,e,n,i))}},SglTransformStack.prototype={clone:function(){var t=new SglTransformStack;return t._ms=this._ms.clone(),t._vs=this._vs.clone(),t._ps=this._ps.clone(),t},get copy(){return this.clone()},reset:function(){return this._ms.reset(),this._vs.reset(),this._ps.reset(),this},get model(){return this._ms},get view(){return this._vs},get projection(){return this._ps},get modelMatrix(){return this.model.top},get modelMatrixRef(){return this.model.topRef},get modelMatrixTranspose(){return sglTransposeM4(this.modelMatrixRef)},get modelMatrixInverse(){return sglInverseM4(this.modelMatrixRef)},get modelMatrixInverseTranspose(){return sglTransposeM4(this.modelMatrixInverse)},get viewMatrix(){return this.view.top},get viewMatrixRef(){return this.view.topRef},get viewMatrixTranspose(){return sglTransposeM4(this.viewMatrixRef)},get viewMatrixInverse(){return sglInverseM4(this.viewMatrixRef)},get viewMatrixInverseTranspose(){return sglTransposeM4(this.viewMatrixInverse)},get projectionMatrix(){return this.projection.top},get projectionMatrixRef(){return this.projection.topRef},get projectionMatrixTranspose(){return sglTransposeM4(this.projectionMatrixRef)},get projectionMatrixInverse(){return sglInverseM4(this.projectionMatrixRef)},get projectionMatrixInverseTranspose(){return sglTransposeM4(this.projectionMatrixInverse)},get modelViewMatrix(){return sglMulM4(this.viewMatrixRef,this.modelMatrixRef)},get modelViewMatrixTranspose(){return sglTransposeM4(this.modelViewMatrix)},get modelViewMatrixInverse(){return sglInverseM4(this.modelViewMatrix)},get modelViewMatrixInverseTranspose(){return sglTransposeM4(this.modelViewMatrixInverse)},get viewProjectionMatrix(){return sglMulM4(this.projectionMatrixRef,this.viewMatrixRef)},get viewProjectionMatrixTranspose(){return sglTransposeM4(this.viewProjectionMatrix)},get viewProjectionMatrixInverse(){return sglInverseM4(this.viewProjectionMatrix)},get viewProjectionMatrixInverseTranspose(){return sglTransposeM4(this.viewProjectionMatrixInverse)},get modelViewProjectionMatrix(){return sglMulM4(this.projectionMatrixRef,sglMulM4(this.viewMatrixRef,this.modelMatrixRef))},get modelViewProjectionMatrixTranspose(){return sglTransposeM4(this.modelViewProjectionMatrix)},get modelViewProjectionMatrixInverse(){return sglInverseM4(this.modelViewProjectionMatrix)},get modelViewProjectionMatrixInverseTranspose(){return sglTransposeM4(this.modelViewProjectionMatrixInverse)},get worldSpaceNormalMatrix(){return sglM4toM3(this.modelMatrixInverseTranspose)},get viewSpaceNormalMatrix(){return sglM4toM3(this.modelViewMatrixInverseTranspose)},get modelSpaceViewerPosition(){return sglV4toV3(sglGetColM4(this.modelViewMatrixInverse,3))},get modelSpaceViewDirection(){return sglNegV3(sglV4toV3(sglGetRowM4(this.modelViewMatrix,2)))},get worldSpaceViewerPosition(){return sglV4toV3(sglGetColM4(this.viewMatrixInverse,3))},get worldSpaceViewDirection(){return ssglNegV3(sglV4toV3(sglGetRowM4(this.viewMatrixRef,2)))}},_SglFrustumPlane.prototype={setup:function(t,e,n,i){var r=1/sglSqrt(t*t+e*e+n*n);this.normal[0]=t*r,this.normal[1]=e*r,this.normal[2]=n*r,this.offset=i*r,this.testVertex[0]=this.normal[0]>=0?1:0,this.testVertex[1]=this.normal[1]>=0?1:0,this.testVertex[2]=this.normal[2]>=0?1:0}};var SGL_OUTSIDE_FRUSTUM=0,SGL_INTERSECT_FRUSTUM=1,SGL_INSIDE_FRUSTUM=2;SglFrustum.prototype={setup:function(t,e,n){var i=[sglGetColM4(e,0),sglGetColM4(e,1),sglGetColM4(e,2)],r=[sglLengthV4(i[0]),sglLengthV4(i[1]),sglLengthV4(i[2])],s=sglRcpV3(r),o=sglScalingM4V(r),u=sglScalingM4V(s);i[0]=sglMulV4S(i[0],s[0]),i[1]=sglMulV4S(i[1],s[1]),i[2]=sglMulV4S(i[2],s[2]);var l=sglIdentityM4();sglSetRowM4V(l,0,i[0]),sglSetRowM4V(l,1,i[1]),sglSetRowM4V(l,2,i[2]),this._mvpMatrix=sglMulM4(t,e),this._billboardMatrix=sglMulM4(u,sglMulM4(l,o)),this._viewport=n.slice(0,4),this._vp[0]=.5*this._viewport[2],this._vp[1]=this._viewport[0]+.5*this._viewport[2],this._vp[2]=.5*this._viewport[3],this._vp[3]=this._viewport[1]+.5*this._viewport[3];var a=this._mvpMatrix,h=[a[3],a[7],a[11]];this._planes[0].setup(h[0]-a[0],h[1]-a[4],h[2]-a[8],a[15]-a[12]),this._planes[1].setup(h[0]+a[0],h[1]+a[4],h[2]+a[8],a[15]+a[12]),this._planes[2].setup(h[0]-a[1],h[1]-a[5],h[2]-a[9],a[15]-a[13]),this._planes[3].setup(h[0]+a[1],h[1]+a[5],h[2]+a[9],a[15]+a[13]),this._planes[4].setup(h[0]-a[2],h[1]-a[6],h[2]-a[10],a[15]-a[14]),this._planes[5].setup(h[0]+a[2],h[1]+a[6],h[2]+a[10],a[15]+a[14])},boxVisibility:function(t,e){for(var n=SGL_INSIDE_FRUSTUM,i=[t,e],r=null,s=0;6>s;++s){if(r=this._planes[s],r.normal[0]*i[r.testVertex[0]][0]+r.normal[1]*i[r.testVertex[1]][1]+r.normal[2]*i[r.testVertex[2]][2]+r.offset<0)return SGL_OUTSIDE_FRUSTUM;r.normal[0]*i[1-r.testVertex[0]][0]+r.normal[1]*i[1-r.testVertex[1]][1]+r.normal[2]*i[1-r.testVertex[2]][2]+r.offset<0&&(n=SGL_INTERSECT_FRUSTUM)}return n},projectedSegmentSize:function(t,e){var n=.5*e,i=sglV3toV4(t,0),r=[-n,0,0,1],s=[n,0,0,1];r=sglMulM4V4(this._billboardMatrix,r),r=sglAddV4(r,i),r=sglProjectV4(sglMulM4V4(this._mvpMatrix,r)),s=sglMulM4V4(this._billboardMatrix,s),s=sglAddV4(s,i),s=sglProjectV4(sglMulM4V4(this._mvpMatrix,s));var o=this._vp[0]*sglAbs(s[0]-r[0]);return o}},SglVertexBuffer.prototype={get info(){return this._info},destroy:function(){this._info.valid&&this.gl.deleteBuffer(this._info.handle),this._info=null},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this._info.handle)},unbind:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},SglIndexBuffer.prototype={get info(){return this._info},destroy:function(){this._info.valid&&this.gl.deleteBuffer(this._info.handle),this._info=null},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this._info.handle)},unbind:function(){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null)}},SglProgramAttribute.prototype={set index(t){this._prog.gl.bindAttribLocation(this._prog._info.handle,t,this._info.name),this._info.location=t},get index(){return this._info.location}},SglProgramUniform.prototype={set value(t){this._func(t)},get value(){return this._prog.gl.getUniform(this._prog._info.handle,this._info.location)}},SglProgramSampler.prototype={set unit(t){this._prog.gl.uniform1i(this._info.location,t),this._unit=t},get unit(){return this._unit}},SglProgram.prototype={get info(){return this._info},get attributes(){return this._attributes},get uniforms(){return this._uniforms},get samplers(){return this._samplers},destroy:function(){if(null!=this._info.valid){var t=this.gl;t.deleteProgram(this._info.handle);for(var e in this._info.shaders)t.deleteShader(this._info.shaders[e].handle);this._attributes=null,this._uniforms=null,this._samplers=null,this._info=null}},get handle(){return this._info.handle},get isValid(){return this._info.valid},get log(){var t="";t+="-------------------------------------\n";for(var e in this._info.shaders)t+=this._info.shaders[e].log;return t+=this._info.log,t+="-------------------------------------\n",t+="\n"},setDefaultBindings:function(){sglSetDefaultProgramBindings(this.gl,this._info)},synchronize:function(){sglProgramSynchronize(this.gl,this._info)},bind:function(){this.gl.useProgram(this._info.handle)},unbind:function(){},setAttributes:function(t){var e=null;for(var n in t)e=this._attributes[n],e&&(e.index=t[n]);this.link()},setUniforms:function(t){var e=null;for(var n in t)e=this._uniforms[n],e&&(e.value=t[n])},setSamplers:function(t){var e=null;for(var n in t)e=this._samplers[n],void 0!=e&&(e.unit=t[n])}},SglTexture2D.prototype={get info(){return this._info},destroy:function(){null!=this._info.handle&&(this.gl.deleteTexture(this._info.handle),this._info=null)},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(t){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this._info.target,this._info.handle)},unbind:function(t){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this._info.target,null)},generateMipmap:function(){this.gl.generateMipmap(this._info.target)}},SglTextureCube.prototype={get info(){return this._info},destroy:function(){null!=this._info.handle&&(this.gl.deleteTexture(this._info.handle),this._info=null)},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(t){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this._info.target,this._info.handle)},unbind:function(t){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this._info.target,null)},generateMipmap:function(){this.gl.generateMipmap(this._info.target)}},SglRenderbuffer.prototype={get info(){return this._info},destroy:function(){null!=this._info.handle&&(this.gl.deleteRenderbuffer(this._info.handle),this._info=null)},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this._info.handle)},unbind:function(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null)}},SglFramebuffer.prototype={get info(){return this._info},get colorTargets(){return this._colorTargets},get depthTarget(){return this._depthTarget},get stencilTarget(){return this._stencilTarget},destroy:function(){if(null!=this._info.handle){this.gl.deleteFramebuffer(this._info.handle);for(var t in this._colorTargets){var e=this._colorTargets[t];e&&this._colorTargets[t].destroy()}this._depthTarget&&this._depthTarget.destroy(),this._stencilTarget&&this._stencilTarget.destroy(),this._info=null,this.targets=null}},get handle(){return this._info.handle},get isValid(){return this._info.valid},get width(){return this._info.width},get height(){return this._info.height},bind:function(t){var e=!0;void 0!=t&&(e=t),e&&this.gl.viewport(0,0,this._info.width,this._info.height),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._info.handle)},unbind:function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},bindColor:function(t,e){this._colorTargets[t].bind(e)},unbindColor:function(t,e){this._colorTargets[t].unbind(e)},bindDepth:function(t){this._depthTarget.bind(t)},unbindDepth:function(t){this._depthTarget.unbind(t)},bindStencil:function(t){this._stencilTarget.bind(t)},unbindStencil:function(t){this._stencilTarget.unbind(t)},generateMipmap:function(t,e,n){var i=null;if(t)for(var r in this._colorTargets)i=this._colorTargets[r],i&&i.info.target==this.gl.TEXTURE_2D&&(i.bind(0),i.generateMipmap(),i.unbind(0));e&&(i=this._depthTarget,i&&i.info.target==this.gl.TEXTURE_2D&&(i.bind(0),i.generateMipmap(),i.unbind(0))),n&&(i=this._stencilTarget,i&&i.info.target==this.gl.TEXTURE_2D&&(i.bind(0),i.generateMipmap(),i.unbind(0)))},attachColorTarget:function(t,e){if(!e)return!1;if(0>t||t>=this._colorTargets.length)return!1;if(e.width!=this.width||e.height!=this.height)return!1;var n=this.gl,i=this.gl.COLOR_ATTACHMENT0+t;return e.target==n.TEXTURE_2D?n.framebufferTexture2D(n.FRAMEBUFFER,i,n.TEXTURE_2D,e.handle,0):e.target==n.RENDERBUFFER&&n.framebufferRenderbuffer(n.FRAMEBUFFER,i,n.RENDERBUFFER,e.handle),this._colorTargets[t]=e,!0},detachColorTarget:function(t){if(0>t||t>=this._colorTargets.length)return!1;var e=this._colorTargets[t];if(!e)return!1;var n=this.gl;return e.target==n.TEXTURE_2D?n.framebufferTexture2D(n.FRAMEBUFFER,att,n.TEXTURE_2D,null,0):e.target==n.RENDERBUFFER&&n.framebufferRenderbuffer(n.FRAMEBUFFER,att,n.RENDERBUFFER,null),this._colorTargets[t]=null,!0}},SglAttributeStreamJS.prototype={get name(){return this._name},get size(){return this._size},get buffer(){return this._buff},get length(){return this._buff.length},get:function(t){return this._buff.slice(t*this._size,this._size)},set:function(t,e){for(var n=t*this._size,i=0;i<this._size;++i)this._buff[n++]=e[i];return r}},SglVertexStreamJS.prototype={get attributes(){return this._attribs},get length(){return this._length},addAttribute:function(t,e,n,i){var r=new SglAttributeStreamJS(t,e,n,i);this._attribs[t]=r,this._length=r.length},removeAttribute:function(t){if(this._attribs[t]){delete this._attribs[t],this._length=0;for(var e in this._attribs){this._length=this._attribs[e].length;break}}}};var SGL_ARRAY_PRIMITIVE_STREAM=1,SGL_INDEXED_PRIMITIVE_STREAM=2,SGL_PACKED_INDEXED_PRIMITIVE_STREAM=3,SGL_POINTS_LIST=1,SGL_LINES_LIST=2,SGL_LINE_STRIP=3,SGL_LINE_LOOP=4,SGL_TRIANGLES_LIST=5,SGL_TRIANGLE_STRIP=6,SGL_TRIANGLE_FAN=7;SglPrimitiveStreamJS.prototype={get type(){return void 0},get name(){return this._name},get mode(){return this._mode},get first(){return this._first},get length(){return this._length}},sglInherit(SglArrayPrimitiveStreamJS,SglPrimitiveStreamJS),sglInherit(SglIndexedPrimitiveStreamJS,SglPrimitiveStreamJS),SglConnectivityJS.prototype={get primitives(){return this._prims},addArrayPrimitives:function(t,e,n,i){var r=new SglArrayPrimitiveStreamJS(t,e,n,i);this._prims[t]=r},addIndexedPrimitives:function(t,e,n,i){var r=new SglIndexedPrimitiveStreamJS(t,e,n,i);this._prims[t]=r},removePrimitives:function(t){this._prims[t]&&delete this._prims[t]}},SglMeshJS.prototype={get isValid(){return this._valid},set isValid(t){this._valid=t},get vertices(){return this._vert},get connectivity(){return this._conn},addVertexAttribute:function(t,e,n,i){this._vert.addAttribute(t,e,n,i)},removeVertexAttribute:function(t){this._vert.removeAttribute(t)},addArrayPrimitives:function(t,e,n,i){this._conn.addArrayPrimitives(t,e,n,i)},addIndexedPrimitives:function(t,e,n,i){this._conn.addIndexedPrimitives(t,e,n,i)},removePrimitives:function(t){this._conn.removePrimitives(t)}},SglMeshJS.prototype.parseOBJ=function(t){return this.isValid=sglMeshJSImportOBJFromString(this,t),this.isValid},SglMeshJS.prototype.importOBJ=function(t,e,n){return sglMeshJSImportOBJFromURL(this,t,e,n)},SglMeshJS.prototype.parseJSON=function(t){return this.isValid=sglMeshJSImportJSONFromString(this,t),this.isValid},SglMeshJS.prototype.importJSON=function(t,e,n){return sglMeshJSImportJSONFromURL(this,t,e,n)},SglAttributeStreamGL.prototype={get name(){return this._name},get size(){return this._size},get type(){return this._type},get isNormalized(){return this._norm},get stride(){return this._stride},get offset(){return this._offset},get buffer(){return this._buff},get length(){return this._length},destroy:function(){this._buff.destroy()},bind:function(t,e){var n=(e?e:0)*this._stride;this._buff.bind(),this.gl.vertexAttribPointer(t,this._size,this._type,this._norm,this._stride,this._offset+n)},unbind:function(){this._buff.unbind()}},SglVertexStreamGL.prototype={get attributes(){return this._attribs},get length(){return this._length},destroy:function(){for(var t in this._attribs)this._attribs[t].destroy()},addAttribute:function(t,e,n,i){var r=new SglAttributeStreamGL(this.gl,t,e,n,i);this._attribs[t]=r,this._length=r.length},removeAttribute:function(t,e){if(this._attribs[t]){e&&this._attribs[t].destroy(),delete this._attribs[t],this._length=0;for(var n in this._attribs){this._length=this._attribs[n].length;break}}},bind:function(t,e){var n=null;for(var i in t)n=this._attribs[i],n&&n.bind(t[i],e)},unbind:function(t){var e=null;for(var n in t)e=this._attribs[n],e&&e.unbind(t[n])}},SglPrimitiveStreamGL.prototype={_clampRange:function(t,e){var n=this._first+this._length,i=this._first+(t>=0?t:0);if(i>=n)return null;var r=e>=0?e:this._length,s=i+r;return s>n&&(r-=s-n),[i,r]},_render:function(){},get type(){return void 0},get name(){return this._name},get mode(){return this._mode},get first(){return this._first},get length(){return this._length},destroy:function(){this._destroy&&this._destroy()},bind:function(){},unbind:function(){},render:function(t,e){var n=this._clampRange(t,e);this._render(n[0],n[1])}},sglInherit(SglArrayPrimitiveStreamGL,SglPrimitiveStreamGL),SglArrayPrimitiveStreamGL.prototype._render=function(t,e){this.gl.drawArrays(this._mode,t,e)},sglInherit(SglIndexedPrimitiveStreamGL,SglPrimitiveStreamGL),SglIndexedPrimitiveStreamGL.prototype._destroy=function(){this._buff.destroy(),this._buff=null},SglIndexedPrimitiveStreamGL.prototype.bind=function(){this._buff.bind()},SglIndexedPrimitiveStreamGL.prototype.unbind=function(){this._buff.unbind()},SglIndexedPrimitiveStreamGL.prototype._render=function(t,e){this.gl.drawElements(this._mode,e,this._idxType,t*this._stride)},sglInherit(SglPackedIndexedPrimitiveStreamGL,SglPrimitiveStreamGL),SglPackedIndexedPrimitiveStreamGL.prototype._destroy=function(){this._buff.destroy(),this._buff=null},SglPackedIndexedPrimitiveStreamGL.prototype.bind=function(){this._buff.bind()},SglPackedIndexedPrimitiveStreamGL.prototype.unbind=function(){this._buff.unbind()},SglPackedIndexedPrimitiveStreamGL.prototype._clampBlockRange=function(t,e,n){var i=this._blockStartingIndices[t]+this._blockIndicesCount[t],r=this._blockStartingIndices[t]+(e>=0?e:0);if(r>=i)return null;var s=n>=0?n:this._blockIndicesCount[t],o=r+s;return o>i&&(s-=o-i),[r,s]},SglPackedIndexedPrimitiveStreamGL.prototype.blockRanges=function(t,e){for(var n=this._clampRange(t,e),i=this._blockStartingIndices.length,r=0;i>r&&n[0]<this._blockStartingIndices[r];)r++;if(r>=i)return null;for(var s=n[0]+n[1]-1,o=r;i>o&&s>=this._blockStartingIndices[o]+this._blockIndicesCount[o];)o++;o>=i&&(o=i-1);var u=[],l=n[0]-this._blockStartingIndices[r],a=n[1],h=l+n[1];h>this._blockIndicesCount[r]&&(a=this._blockIndicesCount[r]-this._blockStartingIndices[r]),u.push([r,l,a,this._blockStartingVertices[r]]);for(var c=r+1;o>c;++c)u.push([c,0,this._blockIndicesCount[c],this._blockStartingVertices[c]]);return o>r&&u.push([c,0,n[0]+n[1]-this._blockStartingIndices[o],this._blockStartingVertices[o]]),u},SglPackedIndexedPrimitiveStreamGL.prototype.renderBlock=function(t,e,n){var i=this._clampBlockRange(t,e,n);this.gl.drawElements(this._mode,i[1],this._idxType,i[0]*this._stride)},SglConnectivityGL.prototype={get primitives(){return this._prims},destroy:function(){for(var t in this._prims)this._prims[t].destroy()},addArrayPrimitives:function(t,e,n,i){var r=new SglArrayPrimitiveStreamGL(this.gl,t,e,n,i);this._prims[t]=r},addIndexedPrimitives:function(t,e,n){var i=new SglIndexedPrimitiveStreamGL(this.gl,t,e,n);this._prims[t]=i},addPackedIndexedPrimitives:function(t,e,n,i,r){var s=new SglPackedIndexedPrimitiveStreamGL(this.gl,t,e,n,i,r);this._prims[t]=s},removePrimitives:function(t,e){this._prims[t]&&(e&&this._prims[t].destroy(),delete this._prims[t])}},SglMeshGL.prototype={get vertices(){return this._vert},get connectivity(){return this._conn},destroy:function(){this._vert.destroy(),this._conn.destroy()},addVertexAttribute:function(t,e,n,i){this._vert.addAttribute(t,e,n,i)},removeVertexAttribute:function(t,e){this._vert.removeAttribute(t,e)},addArrayPrimitives:function(t,e,n,i){this._conn.addArrayPrimitives(t,e,n,i)},addIndexedPrimitives:function(t,e,n){this._conn.addIndexedPrimitives(t,e,n)},addPackedIndexedPrimitives:function(t,e,n,i,r){this._conn.addPackedIndexedPrimitives(t,e,n,i,r)},removePrimitives:function(t,e){this._conn.removePrimitives(t,e)}};var SGL_DefaultStreamMappingPrefix="a_";SglMeshGLRenderer.prototype={_bindVertexBuffers:function(t){this._mesh.vertices.bind(this._meshAttrMap,t)},_unbindVertexBuffers:function(){this._mesh.vertices.unbind(this._meshAttrMap)},get program(){return this.prog},synchronizeProgram:function(){this._prog.synchronize();var t=!1,e=0,n=null;for(var i in this._prog.attributes)n=this._prog.attributes[i],n.index!=e&&(n.index=e,t=!0),e++;t&&this._prog.link();var r=0,s=null;for(var o in this._prog.samplers)s=this._prog.samplers[o],s.unit=r,r++},getStreamMappingFromPrefix:function(t){var e=t.length,n=new Object,i=null;for(var r in this._prog.attributes)r.substr(0,e)==t&&(i=r.substr(e),i.length>0&&(n[r]=i));return n},setStreamMapping:function(t){this._updateEnabledVB=!0;var e=null;this._mapping=this.getStreamMappingFromPrefix(SGL_DefaultStreamMappingPrefix);for(var n in t)e=t[i],this._prog.attributes[n]&&(this._mapping[n]=e);this._meshAttrMap={};var i=null;for(var n in this._mapping)e=this._mapping[n],i=this._prog.attributes[n],this._meshAttrMap[e]=i.index;this._mesh&&this._bindVertexBuffers(0)},setStreamMappingFromPrefix:function(t){t||(t=SGL_DefaultStreamMappingPrefix);var e=this.getStreamMappingFromPrefix(t);this.setStreamMapping(e)},setUniforms:function(t){0!=this._phase&&this._prog.setUniforms(t)},setSamplers:function(t){if(0!=this._phase){var e={},n={},i=null;for(var r in t)i=t[r],"number"==typeof i?e[r]=i:n[r]=i;this._prog.setSamplers(e);var s=null;for(var r in n)s=this._prog.samplers[r],s&&n[r].bind(s.unit)}},begin:function(){0==this._phase&&(this._prog.bind(),this._phase=1)},end:function(){if(1==this._phase){this._prog.unbind();var t=this._prog.gl;for(var e in this._prog.attributes)t.disableVertexAttribArray(this._prog.attributes[e].index);this._phase=0}},beginMesh:function(t){1==this._phase&&(this._updateEnabledVB=!0,this._mesh=t,this._bindVertexBuffers(0),this._phase=2)},endMesh:function(){2==this._phase&&(this._unbindVertexBuffers(),this._prog.gl.bindBuffer(this._prog.gl.ARRAY_BUFFER,null),this._mesh=null,this._phase=1)},beginPrimitives:function(t){2==this._phase&&(this._primStream=this._mesh.connectivity.primitives[t],this._primStream.bind(),this._phase=3)},endPrimitives:function(){3==this._phase&&(this._primStream.unbind(),this._primStream=null,this._phase=2)},render:function(t,e){if(3==this._phase){var n=this._prog.gl,i=0;if(this._updateEnabledVB){this._updateEnabledVB=!1;for(var r in this._mapping)i=this._prog.attributes[r].index,this._mesh.vertices.attributes[this._mapping[r]]?n.enableVertexAttribArray(i):n.disableVertexAttribArray(i)}if(this._primStream.isPacked){if(this._primStream.blocksCount>0)for(var s=this._primStream.blockRanges(t,e),o=s.length,u=0;o>u;++u)this._bindVertexBuffers(s[u][3]),this._primStream.renderBlock(s[u][0],s[u][1],s[u][2])}else this._primStream.render(t,e)}},renderMeshPrimitives:function(t,e,n,i){this.beginMesh(t),this.beginPrimitives(e),this.render(n,i),this.endPrimitives(),this.endMesh()}},SglMeshJS.prototype.calculateBoundingBox=function(t){return sglMeshJSCalculateBBox(this,t)},SglMeshJS.prototype.toMeshGL=function(t){return sglMeshJStoGL(t,this)},SglMeshJS.prototype.toPackedMeshGL=function(t,e,n){return sglPackMeshJStoGL(t,this,e,n)};var SGL_TRACKBALL_NO_ACTION=0,SGL_TRACKBALL_ROTATE=1,SGL_TRACKBALL_PAN=2,SGL_TRACKBALL_DOLLY=3,SGL_TRACKBALL_SCALE=4;SglTrackball.prototype={_projectOnSphere:function(e,n){var i=1,r=0,s=sglSqrt(e*e+n*n);return.7071067811865476*i>s?r=sglSqrt(i*i-s*s):(t=i/1.4142135623730951,r=t*t/s),r},_transform:function(t,e,n,i){return sglMulM4V4(t,sglV4C(e,n,i,0))},_transformOnSphere:function(t,e,n){var i=this._projectOnSphere(e,n);return this._transform(t,e,n,i)},_translate:function(t,e){var n=sglInverseM4(this._matrix),i=sglV3toV4(t,0);i=sglMulM4V4(n,i),i=sglMulSV4(e,i);var r=sglTranslationM4V(i);this._matrix=sglMulM4(this._matrix,r)},get action(){return this._action},set action(t){this._action=t},get matrix(){return this._matrix},reset:function(){this._matrix=sglIdentityM4(),this._pts=[[0,0],[0,0]],this._action=SGL_TRACKBALL_NO_ACTION},track:function(t,e,n,i){switch(this._pts[0][0]=this._pts[1][0],this._pts[0][1]=this._pts[1][1],this._pts[1][0]=e,this._pts[1][1]=n,this._action){case SGL_TRACKBALL_ROTATE:this.rotate(t);break;case SGL_TRACKBALL_PAN:this.pan(t);break;case SGL_TRACKBALL_DOLLY:this.dolly(t,i);break;case SGL_TRACKBALL_SCALE:this.scale(t,i)}},rotate:function(t){if(this._pts[0][0]!=this._pts[1][0]||this._pts[0][1]!=this._pts[1][1]){var e=sglInverseM4(t),n=this._transformOnSphere(e,this._pts[0][0],this._pts[0][1]),i=this._transformOnSphere(e,this._pts[1][0],this._pts[1][1]),r=sglCrossV3(n,i),s=sglLengthV3(r),o=sglRotationAngleAxisM4V(s,r);this._matrix=sglMulM4(o,this._matrix)}},pan:function(t){var e=sglInverseM4(t),n=this._transform(e,this._pts[0][0],this._pts[0][1],-1),i=this._transform(e,this._pts[1][0],this._pts[1][1],-1),r=sglSubV3(i,n);this._translate(r,2)},dolly:function(t,e){var n=sglInverseM4(t),i=this._transform(n,0,0,e);this._translate(i,1)},scale:function(t,e){var n=sglScalingM4C(e,e,e);this._matrix=sglMulM4(this._matrix,n)}},SglFirstPersonCamera.prototype={clone:function(){var t=new SglFirstPersonCamera;return t._position=this._position.slice(),t._angles=this._angles.slice(),t},get copy(){return this.clone()},lookAt:function(t,e,n,i,r,s,o){this._position=sglV3C(t,e,n);var u=sglSubV3([i,r,s],this._position);return this._angles[0]=sglAtan2(u[1],-u[2]),this._angles[1]=sglAtan2(-u[0],-u[2]),this._angles[2]=o?o:0,this},translate:function(t,e,n){var i=sglRotationAngleAxisM4C(this._angles[0],1,0,0),r=sglRotationAngleAxisM4C(this._angles[1],0,1,0),s=sglRotationAngleAxisM4C(this._angles[2],0,0,1),o=sglMulM4(s,sglMulM4(r,i)),u=sglMulM4V4(o,[t,e,n,0]);return this._position[0]+=u[0],this._position[1]+=u[1],this._position[2]+=u[2],this},translateOnPlane:function(t,e,n){var i=sglRotationAngleAxisM4C(this._angles[1],0,1,0),r=sglMulM4V4(i,[t,e,n,0]);return this._position[0]+=r[0],this._position[1]+=r[1],this._position[2]+=r[2],this},rotate:function(t,e,n){return this._angles[0]+=t,this._angles[1]+=e,this._angles[2]+=n,this},get matrix(){var t=sglRotationAngleAxisM4C(-this._angles[0],1,0,0),e=sglRotationAngleAxisM4C(-this._angles[1],0,1,0),n=sglRotationAngleAxisM4C(-this._angles[2],0,0,1),i=sglTranslationM4V(sglNegV3(this._position)),r=sglMulM4(n,sglMulM4(t,sglMulM4(e,i)));return r}},SglCanvasUI.prototype={get canvas(){return this._canvas},get width(){return this._canvas.width},get height(){return this._canvas.height},get ignoreKeyRepeat(){return this._ignoreKeyRepeat},set ignoreKeyRepeat(t){this._ignoreKeyRepeat=t},get updateRate(){return this._updRate<=0?0:this._updRate},set updateRate(t){var e=t;if(0>e&&(e=0),e>1e3&&(e=1e3),this._updRate!=e&&(this._updRate=e,null!=this._timerID&&(clearInterval(this._timerID),this._timerID=null),this._updRate>0)){var n=1e3/this._updRate;
1>n&&(n=1);var i=this._manager;this.timeNow=Date.now()/1e3,this.timePrev=this.timeNow,this.timeDelta=0,this._timerID=setInterval(function(){i.update()},n)}},get requestDraw(){var t=this;return function(){t._manager.requestDraw()}}},_SglCanvasManager.prototype={_getMouseClientPos:function(t){var e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}},requestDraw:function(){this.rendering&&(this._drawPending||(this._drawPending=!0,setTimeout(this._drawFunc,0)))},blur:function(){var t=!1;for(var e in this.ui.mouseButtonsDown)this.ui.mouseButtonsDown[e]&&(this.ui.mouseButtonsDown[e]=!1,this.handler.mouseUp&&0!=this.handler.mouseUp(this.gl,e,this.ui.mousePos.x,this.ui.mousePos.y)&&(t=!0));for(var n in this.ui.keysDown)this.ui.keysDown[n]&&(this.ui.keysDown[n]=!1,this.handler.keyUp&&0!=this.handler.keyUp(this.gl,0,n)&&(t=!0));t&&this.requestDraw()},mouseOut:function(){var t=!1;for(var e in this.ui.mouseButtonsDown)this.ui.mouseButtonsDown[e]&&(this.ui.mouseButtonsDown[e]=!1,this.handler.mouseOut&&0!=this.handler.mouseOut(this.gl,this.ui.mousePos.x,this.ui.mousePos.y)&&(t=!0));t&&this.requestDraw()},mouseOver:function(){},load:function(){this.ui.loadEvent=null,this.handler.load&&0!=this.handler.load(this.gl),this.requestDraw()},unload:function(){this.ui.unloadEvent=null,this.ui.updateRate=0,this.handler.unload&&this.handler.unload(this.gl),this.handler.ui=null,this.handler=null,this.ui=null},keyDown:function(t){this.ui.keyDownEvent=t;var e=String.fromCharCode(t.keyCode);this.ui.keysDown[e.toLowerCase()]=!0,this.ui.keysDown[e.toUpperCase()]=!0,this.ui.keysDown[t.keyCode]&&this.ui.ignoreKeyRepeat||(this.ui.keysDown[t.keyCode]=!0,this.handler.keyDown&&0!=this.handler.keyDown(this.gl,t.keyCode,e)&&this.requestDraw())},keyUp:function(t){this.ui.keyUpEvent=t;var e=String.fromCharCode(t.keyCode);this.ui.keysDown[e.toLowerCase()]=!1,this.ui.keysDown[e.toUpperCase()]=!1,this.ui.keysDown[t.keyCode]=!1,this.handler.keyUp&&0!=this.handler.keyUp(this.gl,t.keyCode,e)&&this.requestDraw()},keyPress:function(t){this.ui.keyPressEvent=t;var e=String.fromCharCode(t.charCode);this.handler.keyPress&&0!=this.handler.keyPress(this.gl,t.charCode,e)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},mouseDown:function(t){this.ui.mouseDownEvent=t;var e=this._getMouseClientPos(t),n=e.x,i=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=n,this.ui.mousePrevPos.y=i,this.ui.mousePos.x=n,this.ui.mousePos.y=i,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.ui.mouseButtonsDown[t.button]=!0,this.handler.mouseDown&&0!=this.handler.mouseDown(this.gl,t.button,n,i)&&this.requestDraw(),this.canvas.focus(),t.preventDefault&&t.preventDefault()},mouseUp:function(t){this.ui.mouseUpEvent=t;var e=this._getMouseClientPos(t),n=e.x,i=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=n,this.ui.mousePrevPos.y=i,this.ui.mousePos.x=n,this.ui.mousePos.y=i,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.ui.mouseButtonsDown[t.button]=!1,this.handler.mouseUp&&0!=this.handler.mouseUp(this.gl,t.button,n,i)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},mouseMove:function(t){this.ui.mouseMoveEvent=t;var e=this._getMouseClientPos(t),n=e.x,i=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=this.ui.mousePos.x,this.ui.mousePrevPos.y=this.ui.mousePos.y,this.ui.mousePos.x=n,this.ui.mousePos.y=i,this.ui.mouseDeltaPos.x=this.ui.mousePos.x-this.ui.mousePrevPos.x,this.ui.mouseDeltaPos.y=this.ui.mousePos.y-this.ui.mousePrevPos.y,this.handler.mouseMove&&0!=this.handler.mouseMove(this.gl,n,i)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},mouseWheel:function(t){this.ui.mouseWheelEvent=t;var e=this._getMouseClientPos(t),n=e.x,i=this.canvas.height-1-e.y;if(this.ui.mousePrevPos.x=n,this.ui.mousePrevPos.y=i,this.ui.mousePos.x=n,this.ui.mousePos.y=i,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.handler.mouseWheel){var r=0;t||(t=window.event),t.wheelDelta?(r=t.wheelDelta/120,window.opera&&(r=-r)):t.detail&&(r=-t.detail/3),r&&0!=this.handler.mouseWheel(this.gl,r,n,i)&&this.requestDraw()}t.preventDefault&&t.preventDefault()},touchStart:function(t){this.ui.mouseDownEvent=t.touches[0];var e=this._getMouseClientPos(t.touches[0]),n=e.x,i=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=n,this.ui.mousePrevPos.y=i,this.ui.mousePos.x=n,this.ui.mousePos.y=i,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.ui.mouseButtonsDown[0]=!0,this.handler.mouseDown&&0!=this.handler.mouseDown(this.gl,0,n,i)&&this.requestDraw(),this.canvas.focus(),t.preventDefault&&t.preventDefault()},touchEnd:function(t){this.ui.mouseUpEvent=t.changedTouches[0];var e=this._getMouseClientPos(t.changedTouches[0]),n=e.x,i=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=n,this.ui.mousePrevPos.y=i,this.ui.mousePos.x=n,this.ui.mousePos.y=i,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.ui.mouseButtonsDown[0]=!1,this.handler.mouseUp&&0!=this.handler.mouseUp(this.gl,0,n,i)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},touchMove:function(t){this.ui.mouseMoveEvent=t.changedTouches[0];var e=this._getMouseClientPos(t.changedTouches[0]),n=e.x,i=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=this.ui.mousePos.x,this.ui.mousePrevPos.y=this.ui.mousePos.y,this.ui.mousePos.x=n,this.ui.mousePos.y=i,this.ui.mouseDeltaPos.x=this.ui.mousePos.x-this.ui.mousePrevPos.x,this.ui.mouseDeltaPos.y=this.ui.mousePos.y-this.ui.mousePrevPos.y,this.handler.mouseMove&&0!=this.handler.mouseMove(this.gl,n,i)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},click:function(t){this.ui.clickEvent=t;var e=this._getMouseClientPos(t),n=e.x,i=this.canvas.height-1-e.y;this.handler.click&&0!=this.handler.click(this.gl,t.button,n,i)&&this.requestDraw()},dblClick:function(t){this.ui.dblClickEvent=t;var e=this._getMouseClientPos(t),n=e.x,i=this.canvas.height-1-e.y;this.handler.dblClick&&0!=this.handler.dblClick(this.gl,t.button,n,i)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},resize:function(t){this.ui.resizeEvent=t,this.handler.resize&&0!=this.handler.resize(this.gl,this.canvas.width,this.canvas.height)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},update:function(){this.ui.updateEvent=null;var t=Date.now()/1e3;this.ui.timePrev=this.ui.timeNow,this.ui.timeNow=t,this.ui.timeDelta=this.ui.timeNow-this.ui.timePrev;var e=!0;this.handler.update&&(e=0!=this.handler.update(this.gl,this.ui.timeDelta)),e&&this.requestDraw()},draw:function(){this.ui.drawEvent=null,this.handler.draw&&this.handler.draw(this.gl),this.gl.flush(),this._drawPending=!1}};var _SGL_RegisteredCanvas=new Object;