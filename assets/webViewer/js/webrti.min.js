var SGL_VERSION_MAJOR=0,SGL_VERSION_MINOR=1,SGL_VERSION_REVISION=1,SGL_VERSION_STRING=SGL_VERSION_MAJOR+"."+SGL_VERSION_MINOR+"."+SGL_VERSION_REVISION;function sglUnknown(){throw new Error("SpiderGL : UNKNOWN")}function sglUnsupported(){throw new Error("SpiderGL : UNSUPPORTED")}function sglUnimplemented(){throw new Error("SpiderGL : UNIMPLEMENTED")}function sglInvalidParameter(){throw new Error("SpiderGL : INVALID_PARAMETER")}function sglInvalidCall(){throw new Error("SpiderGL : INVALID_CALL")}function sglDefineConstant(t,e,i){t[e]=i}function sglInherit(t,e){t.prototype=new e,t.prototype.constructor=t}function sglInitialize(){}function sglFinalize(){}function sglNodeText(t){t=document.getElementById(t);if(!t)return null;for(var e="",i=t.firstChild;i;)3==i.nodeType&&(e+=i.textContent),i=i.nextSibling;return e}function sglLoadFile(t,e){var i=!!e,n=new XMLHttpRequest,t=(i&&(n.onreadystatechange=function(){4==n.readyState&&e&&e(n.responseText)}),n.open("GET",t,i),n.send(null),null);return t=i?t:n.responseText}function sglGetLines(t){for(var e,i=t.split("\n"),n=i.length,s=[],r=0;r<n;++r)0<(e=i[r].replace(/[ \t]+/g," ").replace(/\s\s*$/,"")).length&&s.push(e);return s}window.addEventListener("load",function(){sglInitialize()},!1),window.addEventListener("unload",function(){sglFinalize()},!1);var SGL_REQUEST_FAILED=0,SGL_REQUEST_SUCCEEDED=1,SGL_REQUEST_IDLE=2,SGL_REQUEST_ONGOING=3,SGL_REQUEST_ABORTED=4,SGL_REQUEST_QUEUED=5,SGL_REQUEST_REJECTED=6,SGL_REQUEST_CANCELLED=7;function SglRequest(t){this._priority=null,this._status=SGL_REQUEST_IDLE,this._queue=null,this._onReady=[],t&&this.addOnReadyCallback(t)}function SglTextFileRequest(t,e){SglRequest.apply(this,Array.prototype.slice.call(arguments,1)),this._url=t,this._req=null,Object.defineProperty(this,"url",{get:function(){return this._url}}),Object.defineProperty(this,"text",{get:function(){return this._req.responseText}})}function SglImageRequest(t,e){SglRequest.apply(this,Array.prototype.slice.call(arguments,1)),this._url=t,this._img=null,Object.defineProperty(this,"url",{get:function(){return this._url}}),Object.defineProperty(this,"image",{get:function(){return this._img}})}function SglRequestWatcher(t,e){for(var i=t.length,n=(this._onReady=e||null,this._waitingReqs=i,this._succeededReqs=0,this._failedReqs=0,this._reqs=t.slice(),this),s=function(t){t.succeeded?n._succeededReqs++:t.failed&&n._failedReqs++,n._waitingReqs--,n.isReady&&n._onReady&&n._onReady(n)},r=0;r<i;++r)t[r].succeeded?(this._succeededReqs++,this._waitingReqs--):t[r].failed?(this._failedReqs++,this._waitingReqs--):t[r].addOnReadyCallback(s);this._waitingReqs<=0&&this._onReady&&this._onReady(this)}function SglRequestQueue(t,e,i){this._maxOngoing=0<t?t:0,this._maxQueued=0<e?e:0,this._ongoing=[],this._queued=[],this._onReady=null,this._minPriorityReq=null,this._priorityCompare=null,this._dirty=!0}SglRequest.prototype={_createOnReadyCallback:function(){var n=this;return function(t){n._status=t?SGL_REQUEST_SUCCEEDED:SGL_REQUEST_FAILED,n._queue&&(n._queue._requestReady(n),this._queue=null);for(var e=n._onReady.length,i=0;i<e;++i)n._onReady[i](n)}},get status(){return this._status},get priority(){return this._priority},set priority(t){this._priority=t,this._queue&&this._queue._updateRequest(this)},get succeeded(){return this._status==SGL_REQUEST_SUCCEEDED},get failed(){return this._status==SGL_REQUEST_FAILED},addOnReadyCallback:function(t){t&&(this._onReady.push(t),this.isReady)&&t(this)},removeOnReadyCallback:function(t){for(var e=-1,i=this._onReady.length,n=0;n<i;++n)if(this._onReady[n]==t){e=n;break}e<0||this._onReady.splice(e,1)},get isReady(){return this.failed||this.succeeded},get queue(){return this._queue},send:function(){var t;return!!this._send&&((t=this._send())?this._status=SGL_REQUEST_ONGOING:(this._status=SGL_REQUEST_FAILED,this._createOnReadyCallback()(!1)),t)},cancel:function(){this._status==SGL_REQUEST_QUEUED&&(this._queue&&(this._queue._removeQueuedRequest(this),this._queue=null),this._status=SGL_REQUEST_CANCELLED)},abort:function(){this.cancel(),this._status==SGL_REQUEST_ONGOING&&(this._queue&&(this._queue._removeOngoingRequest(this),this._queue=null),this._abort&&this._abort(),this._status=SGL_REQUEST_ABORTED)}},sglInherit(SglTextFileRequest,SglRequest),SglTextFileRequest.prototype._send=function(){var e,i;return!!this._url&&(e=new XMLHttpRequest,this._req=e,i=this._createOnReadyCallback(),e.onreadystatechange=function(){var t;4==e.readyState&&(t=!e.status||200==e.status,i(t))},e.open("GET",this._url,!0),e.send(),!0)},SglTextFileRequest.prototype._abort=function(){this._req&&this._req.abort()},sglInherit(SglImageRequest,SglRequest),SglImageRequest.prototype._send=function(){var t,e;return!!this._url&&(t=new Image,(this._img=t).crossOrigin="",e=this._createOnReadyCallback(),t.onload=function(){e(t.complete)},t.onerror=function(){e(!1)},t.src=this._url,!0)},SglImageRequest.prototype._abort=function(){},SglRequestWatcher.prototype={get requests(){return this._reqs},get succeeded(){return this._succeededReqs==this._reqs.length},get failed(){return!(this._succeededReqs+this._failedReqs<this._reqs.length)&&this._succeededReqs<this._reqs.length},get onReady(){return this._onReady},set onReady(e){this._onReady=e,this.isReady&&this._onReady&&this._onReady(t)},get isReady(){return this._succeededReqs+this._failedReqs==this._reqs.length},send:function(){for(var t=this._reqs.length,e=0;e<t;++e)this._reqs[e].send()},cancel:function(){for(var t=this._reqs.length,e=0;e<t;++e)this._reqs[e].cancel()},abort:function(){for(var t=this._reqs.length,e=0;e<t;++e)this._reqs[e].abort()}},SglRequestQueue.prototype={_sort:function(){this._dirty&&(this._dirty=!1,this._minPriorityReq=null,this._queued.length<=0||(this._priorityCompare?this._queued.sort(this._priorityCompare):this._queued.sort(),0<this._queued.length&&(this._minPriorityReq=this._queued[0])))},_updateMinPriority:function(){this._minPriorityReq=null;var t=this._queued.length;if(!(t<=0)&&(this._minPriorityReq=this._queued[0],this._dirty))for(var e=1;e<t;++e)this.comparePriorities(this._queued[e].priority,this._minPriorityReq.priority)<=0&&(this._minPriorityReq=this._queued[e])},_removeFromArray:function(t,e){for(var i=-1,n=t.length,s=0;s<n;++s)if(t[s]==e){i=s;break}i<0||t.splice(i,1)},_removeQueuedRequest:function(t){this._removeFromArray(this._queued,t),this._queued.length<=0?this._minPriorityReq=null:t==this._minPriorityReq&&this._updateMinPriority()},_removeOngoingRequest:function(t){this._removeFromArray(this._ongoing,t),this._execute()},_updateRequest:function(t){this.comparePriorities(t.priority,this._minPriorityReq.priority)<=0&&(this._minPriorityReq=t),this._dirty=!0},_requestReady:function(t){this._removeOngoingRequest(t),this._onReady&&this._onReady(t),this._execute()},_execute:function(){var t=this._queued.length;if(!(t<=0)){var e=0<this._maxOngoing?this._maxOngoing-this._ongoing.length:t;if(!(e<=0)){t<e&&(e=t),this._sort();for(var i=0;i<e;++i)this._queued.pop().send();0<this._queued.length&&(this._minPriorityReq=this._queued[0])}}},comparePriorities:function(t,e){return this._priorityCompare?this._priorityCompare(t,e):t-e},get priorityCompare(){return this._priorityCompare},set priorityCompare(t){this._priorityCompare=t,this._updateMinPriority()},get onReady(){return this._onReady},set onReady(t){this._onReady=t},push:function(t){var e={victims:null,result:!1};if(!t.queue){var i=this._queued.length,n=0<this._maxQueued&&i>=this._maxQueued;if(n&&this.comparePriorities(t.priority,this._minPriorityReq.priority)<=0)t._status=SGL_REQUEST_REJECTED;else{this._queued.push(t),t._queue=this,t._status=SGL_REQUEST_QUEUED,i++,e.result=!0;var s=0<this._maxQueued?i-this._maxQueued:0;if(s<=0)(null==this._minPriorityReq||this.comparePriorities(t.priority,this._minPriorityReq.priority)<=0)&&(this._minPriorityReq=t),this._dirty=!0;else{this._sort(),e.victims=this._queued.slice(0,s),this._queued.splice(0,s);for(var r=0;r<s;++r)e.victims[r]._status=SGL_REQUEST_REJECTED,e.victims[r]._queue=null}this._execute()}}return e}};var SGL_PI=Math.PI;function sglAbs(t){return Math.abs(t)}function sglFloor(t){return Math.floor(t)}function sglCeil(t){return Math.ceil(t)}function sglSqrt(t){return Math.sqrt(t)}function sglPow(t,e){return Math.pow(t,e)}function sglLog(t){return Math.log(t)}function sglExp(t){return Math.exp(t)}function sglSin(t){return Math.sin(t)}function sglAsin(t){return Math.asin(t)}function sglCos(t){return Math.cos(t)}function sglAcos(t){return Math.acos(t)}function sglTan(t){return Math.tan(t)}function sglAtan(t){return Math.atan(t)}function sglAtan2(t,e){return Math.atan2(t,e)}function sglDegToRad(t){return t*(SGL_PI/180)}function sglRadToDeg(t){return t*(180/SGL_PI)}function sglMin(t,e){return Math.min(t,e)}function sglMax(t,e){return Math.max(t,e)}function sglClamp(t,e,i){return t<=e?e:i<=t?i:t}function sglRandom01(){return Math.random()}function sglMapVN(t,e,i,s,r,o,l){l=null!=l?l:e;for(var u=(r=null!=r?r:0)+(o=null!=o?o:(t.length-r)/l)*l,a=new Array(n),h=0,g=0,f=r;f<u;f+=l){for(g=0;g<n;++g)a[g]=t[f+g];for(i(a,s,h++),g=0;g<n;++g)t[f+g]=a[g]}}function sglMapV2(t,e,i,n,s,r){sglMapVN(t,2,e,i,n,s,r)}function sglMapV3(t,e,i,n,s,r){sglMapVN(t,3,e,i,n,s,r)}function sglMapV4(t,e,i,n,s,r){sglMapVN(t,4,e,i,n,s,r)}function sglUndefV2(t){return new Array(2)}function sglV2V(t){return t.slice(0,2)}function sglV2S(t){return[t,t]}function sglV2C(t,e){return[t,e]}function sglZeroV2(){return sglV2S(0)}function sglOneV2(){return sglV2S(1)}function sglV2(){switch(arguments.length){case 1:return arguments[0]instanceof Array?sglV2V(arguments[0]):sglV2S(arguments[0]);case 2:return sglV2V(arguments);default:return sglZeroV2()}return null}function sglDupV2(t){return t.slice(0,2)}function sglNegV2(t){return sglV2C(-t[0],-t[1])}function sglAddV2(t,e){return sglV2C(t[0]+e[0],t[1]+e[1])}function sglAddV2S(t,e){return sglV2C(t[0]+e,t[1]+e)}function sglAddSV2(t,e){return sglAddV2S(e,t)}function sglSubV2(t,e){return sglV2C(t[0]-e[0],t[1]-e[1])}function sglSubV2S(t,e){return sglV2C(t[0]-e,t[1]-e)}function sglSubSV2(t,e){return sglV2C(e-t[0],e-t[1])}function sglMulV2(t,e){return sglV2C(t[0]*e[0],t[1]*e[1])}function sglMulV2S(t,e){return sglV2C(t[0]*e,t[1]*e)}function sglMulSV2(t,e){return sglMulV2S(e,t)}function sglDivV2(t,e){return sglV2C(t[0]/e[0],t[1]/e[1])}function sglDivV2S(t,e){return sglV2C(t[0]/e,t[1]/e)}function sglDivSV2(t,e){return sglV2C(t/e[0],t/e[1])}function sglRcpV2(t){return sglDivSV2(1,t)}function sglDotV2(t,e){return t[0]*e[0]+t[1]*e[1]}function sglCrossV2(t,e){return t[0]*e[1]-t[1]*e[0]}function sglSqLengthV2(t){return sglDotV2(t,t)}function sglLengthV2(t){return sglSqrt(sglSqLengthV2(t))}function sglNormalizedV2(t){return sglMulV2S(t,1/sglLengthV2(t))}function sglSelfNegV2(t){return t[0]=-t[0],t[1]=-t[1],t}function sglSelfAddV2(t,e){return t[0]+=e[0],t[1]+=e[1],t}function sglSelfAddV2S(t,e){return t[0]+=e,t[1]+=e,t}function sglSelfAddSV2(t,e){return e[0]+=t,e[1]+=t,e}function sglSelfSubV2(t,e){return t[0]-=e[0],t[1]-=e[1],t}function sglSelfSubV2S(t,e){return t[0]-=e,t[1]-=e,t}function sglSelfSubSV2(t,e){return t[0]=e-t[0],t[1]=e-t[1],t}function sglSelfMulV2(t,e){return t[0]*=e[0],t[1]*=e[1],t}function sglSelfMulV2S(t,e){return t[0]*=e,t[1]*=e,t}function sglSelfMulSV2(t,e){return e[0]*=t,e[1]*=t,e}function sglSelfDivV2(t,e){return t[0]/=e[0],t[1]/=e[1],t}function sglSelfDivV2S(t,e){return u[0]/=e,u[1]/=e,u}function sglSelfDivSV2(t,e){return e[0]=t/e[0],e[1]=t/e[1],e}function sglSelfRcpV2(t){return sglSelfDivSV2(1,t)}function sglSelfNormalizeV2(t){return sglSelfMulV2S(t,1/sglLengthV2(t))}function sglMinV2(t,e){return[(t[0]<e[0]?t:e)[0],(t[1]<e[1]?t:e)[1]]}function sglMaxV2(t,e){return[(t[0]>e[0]?t:e)[0],(e[1]<t[1]?t:e)[1]]}function sglV2toV3(t,e){return sglV3C(t[0],t[1],e)}function sglV2toV4(t,e,i){return sglV4C(t[0],t[1],e,i)}function sglUndefV3(t){return new Array(3)}function sglV3V(t){return t.slice(0,3)}function sglV3S(t){return[t,t,t]}function sglV3C(t,e,i){return[t,e,i]}function sglZeroV3(){return sglV3S(0)}function sglOneV3(){return sglV3S(1)}function sglV3(){switch(arguments.length){case 1:return arguments[0]instanceof Array?sglV3V(arguments[0]):sglV3S(arguments[0]);case 3:return sglV3V(arguments);default:return sglZeroV3()}return null}function sglDupV3(t){return t.slice(0,3)}function sglNegV3(t){return sglV3C(-t[0],-t[1],-t[2])}function sglAddV3(t,e){return sglV3C(t[0]+e[0],t[1]+e[1],t[2]+e[2])}function sglAddV3S(t,e){return sglV3C(t[0]+e,t[1]+e,t[2]+e)}function sglAddSV3(t,e){return sglAddV3S(e,t)}function sglSubV3(t,e){return sglV3C(t[0]-e[0],t[1]-e[1],t[2]-e[2])}function sglSubV3S(t,e){return sglV3C(t[0]-e,t[1]-e,t[2]-e)}function sglSubSV3(t,e){return sglV3C(e-t[0],e-t[1],e-t[2])}function sglMulV3(t,e){return sglV3C(t[0]*e[0],t[1]*e[1],t[2]*e[2])}function sglMulV3S(t,e){return sglV3C(t[0]*e,t[1]*e,t[2]*e)}function sglMulSV3(t,e){return sglMulV3S(e,t)}function sglDivV3(t,e){return sglV3C(t[0]/e[0],t[1]/e[1],t[2]/e[2])}function sglDivV3S(t,e){return sglV3C(t[0]/e,t[1]/e,t[2]/e)}function sglDivSV3(t,e){return sglV3C(t/e[0],t/e[1],t/e[2])}function sglRcpV3(t){return sglDivSV3(1,t)}function sglDotV3(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function sglCrossV3(t,e){return sglV3C(t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0])}function sglSqLengthV3(t){return sglDotV3(t,t)}function sglLengthV3(t){return sglSqrt(sglSqLengthV3(t))}function sglNormalizedV3(t){return sglMulV3S(t,1/sglLengthV3(t))}function sglSelfNegV3(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t}function sglSelfAddV3(t,e){return t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t}function sglSelfAddV3S(t,e){return t[0]+=e,t[1]+=e,t[2]+=e,t}function sglSelfAddSV3(t,e){return e[0]+=t,e[1]+=t,e[2]+=t,e}function sglSelfSubV3(t,e){return t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t}function sglSelfSubV3S(t,e){return t[0]-=e,t[1]-=e,t[2]-=e,t}function sglSelfSubSV3(t,e){return t[0]=e-t[0],t[1]=e-t[1],t[2]=e-t[2],t}function sglSelfMulV3(t,e){return t[0]*=e[0],t[1]*=e[1],t[2]*=e[2],t}function sglSelfMulV3S(t,e){return t[0]*=e,t[1]*=e,t[2]*=e,t}function sglSelfMulSV3(t,e){return e[0]*=t,e[1]*=t,e[2]*=t,e}function sglSelfDivV3(t,e){return t[0]/=e[0],t[1]/=e[1],t[2]/=e[2],t}function sglSelfDivV3S(t,e){return u[0]/=e,u[1]/=e,u[2]/=e,u}function sglSelfDivSV3(t,e){return e[0]=t/e[0],e[1]=t/e[1],e[2]=t/e[2],e}function sglSelfRcpV3(t){return sglSelfDivSV3(1,t)}function sglSelfCrossV3(t,e){e=sglV3C(t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function sglSelfNormalizeV3(t){return sglSelfMulV3S(t,1/sglLengthV3(t))}function sglMinV3(t,e){return[(t[0]<e[0]?t:e)[0],(t[1]<e[1]?t:e)[1],(t[2]<e[2]?t:e)[2]]}function sglMaxV3(t,e){return[(t[0]>e[0]?t:e)[0],(e[1]<t[1]?t:e)[1],(e[2]<t[2]?t:e)[2]]}function sglV3toV2(t){return t.slice(0,2)}function sglV3toV4(t,e){return sglV4C(t[0],t[1],t[2],e)}function sglUndefV4(t){return new Array(4)}function sglV4V(t){return t.slice(0,4)}function sglV4S(t){return[t,t,t,t]}function sglV4C(t,e,i,n){return[t,e,i,n]}function sglZeroV4(){return sglV4S(0)}function sglOneV4(){return sglV4S(1)}function sglV4(){switch(arguments.length){case 1:return arguments[0]instanceof Array?sglV4V(arguments[0]):sglV4S(arguments[0]);case 4:return sglV4V(arguments);default:return sglZeroV4()}return null}function sglDupV4(t){return t.slice(0,4)}function sglNegV4(t){return sglV4C(-t[0],-t[1],-t[2],-t[3])}function sglAddV4(t,e){return sglV4C(t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3])}function sglAddV4S(t,e){return sglV4C(t[0]+e,t[1]+e,t[2]+e,t[3]+e)}function sglAddSV4(t,e){return sglAddV4S(e,t)}function sglSubV4(t,e){return sglV4C(t[0]-e[0],t[1]-e[1],t[2]-e[2],t[3]-e[3])}function sglSubV4S(t,e){return sglV4C(t[0]-e,t[1]-e,t[2]-e,t[3]-e)}function sglSubSV4(t,e){return sglV4C(e-t[0],e-t[1],e-t[2],e-t[3])}function sglMulV4(t,e){return sglV4C(t[0]*e[0],t[1]*e[1],t[2]*e[2],t[3]*e[3])}function sglMulV4S(t,e){return sglV4C(t[0]*e,t[1]*e,t[2]*e,t[3]*e)}function sglMulSV4(t,e){return sglMulV4S(e,t)}function sglDivV4(t,e){return sglV4C(t[0]/e[0],t[1]/e[1],t[2]/e[2],t[3]/e[3])}function sglDivV4S(t,e){return sglV4C(t[0]/e,t[1]/e,t[2]/e,t[3]/e)}function sglDivSV4(t,e){return sglV4C(t/e[0],t/e[1],t/e[2],t/e[3])}function sglRcpV4(t){return sglDivSV4(1,t)}function sglDotV4(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function sglSqLengthV4(t){return sglDotV4(t,t)}function sglLengthV4(t){return sglSqrt(sglSqLengthV4(t))}function sglNormalizedV4(t){return sglMulV4S(t,1/sglLengthV4(t))}function sglProjectV4(t){var e=1/t[3];return sglV4C(t[0]*e,t[1]*e,t[2]*e,1)}function sglSelfNegV4(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t[3]=-t[3],t}function sglSelfAddV4(t,e){return t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[3],t}function sglSelfAddV4S(t,e){return t[0]+=e,t[1]+=e,t[2]+=e,t[3]+=e,t}function sglSelfAddSV4(t,e){return e[0]+=t,e[1]+=t,e[2]+=t,e[3]+=t,e}function sglSelfSubV4(t,e){return t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t[3]-=e[3],t}function sglSelfSubV4S(t,e){return t[0]-=e,t[1]-=e,t[2]-=e,t[3]-=e,t}function sglSelfSubSV4(t,e){return t[0]=e-t[0],t[1]=e-t[1],t[2]=e-t[2],t[3]=e-t[3],t}function sglSelfMulV4(t,e){return t[0]*=e[0],t[1]*=e[1],t[2]*=e[2],t[3]*=e[3],t}function sglSelfMulV4S(t,e){return t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e,t}function sglSelfMulSV4(t,e){return e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e}function sglSelfDivV4(t,e){return t[0]/=e[0],t[1]/=e[1],t[2]/=e[2],t[3]/=e[3],t}function sglSelfDivV4S(t,e){return u[0]/=e,u[1]/=e,u[2]/=e,u[3]/=e,u}function sglSelfDivSV4(t,e){return e[0]=t/e[0],e[1]=t/e[1],e[2]=t/e[2],e[3]=t/e[3],e}function sglSelfRcpV4(t){return sglSelfDivSV4(1,t)}function sglSelfNormalizeV4(t){return sglSelfMulV4S(t,1/sglLengthV4(t))}function sglSelfProjectV4(t){var e=1/t[3];return t[0]*=e,t[1]*=e,t[2]*=e,t[3]=1,t}function sglMinV4(t,e){return[(t[0]<e[0]?t:e)[0],(t[1]<e[1]?t:e)[1],(t[2]<e[2]?t:e)[2],(t[3]<e[3]?t:e)[3]]}function sglMaxV4(t,e){return[(t[0]>e[0]?t:e)[0],(e[1]<t[1]?t:e)[1],(e[2]<t[2]?t:e)[2],(e[3]<t[3]?t:e)[3]]}function sglV4toV2(t){return t.slice(0,2)}function sglV4toV3(t){return t.slice(0,3)}function sglUndefM4(){return new Array(16)}function sglM4V(t){return t.slice(0,16)}function sglM4S(t){for(var e=sglUndefM4(),i=0;i<16;++i)e[i]=t;return e}function sglDiagM4V(t){var e=sglM4S(0);return e[0]=t[0],e[5]=t[1],e[10]=t[2],e[15]=t[3],e}function sglDiagM4S(t){var e=sglM4S(0);return e[0]=t,e[5]=t,e[10]=t,e[15]=t,e}function sglDiagM4C(t,e,i,n){return sglDiagM4V(arguments)}function sglZeroM4(){return sglM4S(0)}function sglOneM4(){return sglM4S(1)}function sglIdentityM4(){return sglDiagM4S(1)}function sglM4(){switch(arguments.length){case 1:if(arguments[0]instanceof Array)switch(arguments[0].length){case 1:return sglDiagM4S(arguments[0]);case 4:return sglDiagM4V(arguments[0]);case 16:return sglM4V(arguments[0]);default:return sglIdentityM4()}return sglM4S(arguments[0]);case 4:return sglDiagM4V(arguments);case 16:return sglM4V(arguments);default:return sglIdentityM4()}return null}function sglDupM4(t){var e=sglUndefM4();return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function sglGetElemM4(t,e,i){return t[e+4*i]}function sglSetElemM4(t,e,i,n){t[e+4*i]=n}function sglGetRowM4(t,e){return sglV4C(t[e+0],t[e+4],t[e+8],t[e+12])}function sglSetRowM4V(t,e,i){t[e+0]=i[0],t[e+4]=i[1],t[e+8]=i[2],t[e+12]=i[3]}function sglSetRowM4S(t,e,i){t[e+0]=i,t[e+4]=i,t[e+8]=i,t[e+12]=i}function sglSetRowM4C(t,e,i,n,s,r){t[e+0]=i,t[e+4]=n,t[e+8]=s,t[e+12]=r}function sglGetColM4(t,e){e*=4;return sglV4C(t[0+e],t[1+e],t[2+e],t[3+e])}function sglSetColM4V(t,e,i){e*=4;t[0+e]=i[0],t[1+e]=i[1],t[2+e]=i[2],t[3+e]=i[3]}function sglSetColM4S(t,e,i){e*=4;t[0+e]=i,t[1+e]=i,t[2+e]=i,t[3+e]=i}function sglSetColM4C(t,e,i,n,s,r){e*=4;t[0+e]=i,t[1+e]=n,t[2+e]=s,t[3+e]=r}function sglM4toM3(t){return[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]]}function sglIsIdentityM4(t){for(var e,i=0,n=0,i=0;i<4;++i)for(n=0;n<4;++n)if(e=t[i+4*n],i==n){if(1!=e)return!1}else if(0!=e)return!1;return!0}function sglNegM4(t){for(var e=sglUndefM4(),i=0;i<16;++i)e[i]=-t[i];return e}function sglAddM4(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]+e[n];return i}function sglAddM4S(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]+e;return i}function sglAddSM4(t,e){return sglAddM4S(e,t)}function sglSubM4(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]-e[n];return i}function sglSubM4S(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]-e;return i}function sglSubSM4(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t-e[n];return i}function sglMulM4(t,e){var i=t[0],n=t[1],s=t[2],r=t[3],o=t[4],l=t[5],u=t[6],a=t[7],h=t[8],g=t[9],f=t[10],c=t[11],_=t[12],d=t[13],m=t[14],t=t[15],p=e[0],v=e[1],S=e[2],M=e[3],E=e[4],T=e[5],R=e[6],V=e[7],b=e[8],y=e[9],P=e[10],x=e[11],A=e[12],L=e[13],I=e[14],e=e[15],w=sglUndefM4();return w[0]=i*p+o*v+h*S+_*M,w[1]=n*p+l*v+g*S+d*M,w[2]=s*p+u*v+f*S+m*M,w[3]=r*p+a*v+c*S+t*M,w[4]=i*E+o*T+h*R+_*V,w[5]=n*E+l*T+g*R+d*V,w[6]=s*E+u*T+f*R+m*V,w[7]=r*E+a*T+c*R+t*V,w[8]=i*b+o*y+h*P+_*x,w[9]=n*b+l*y+g*P+d*x,w[10]=s*b+u*y+f*P+m*x,w[11]=r*b+a*y+c*P+t*x,w[12]=i*A+o*L+h*I+_*e,w[13]=n*A+l*L+g*I+d*e,w[14]=s*A+u*L+f*I+m*e,w[15]=r*A+a*L+c*I+t*e,w}function sglMulM4S(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]*e;return i}function sglMulSM4(t,e){return sglMulM4S(e,t)}function sglMulM4V3(t,e,i){return[t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12]*i,t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13]*i,t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14]*i]}function sglMulM4V4(t,e){return[t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12]*e[3],t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13]*e[3],t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14]*e[3],t[3]*e[0]+t[7]*e[1]+t[11]*e[2]+t[15]*e[3]]}function sglDivM4S(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]/e;return i}function sglDivSM4(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t/e[n];return i}function sglRcpM4(t){return sglDivSM4(1,t)}function sglCompMulM4(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]*e[n];return i}function sglCompDivM4(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]/e[n];return i}function sglTransposeM4(t){var e=sglUndefM4();return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e}function sglDeterminantM4(t){var e=t[0],i=t[1],n=t[2],s=t[3],r=t[4],o=t[5],l=t[6],u=t[7],a=t[8],h=t[9],g=t[10],f=t[11],c=t[12],_=t[13],d=t[14],t=t[15];return c*h*l*s-a*_*l*s-c*o*g*s+r*_*g*s+a*o*d*s-r*h*d*s-c*h*n*u+a*_*n*u+c*i*g*u-e*_*g*u-a*i*d*u+e*h*d*u+c*o*n*f-r*_*n*f-c*i*l*f+e*_*l*f+r*i*d*f-e*o*d*f-a*o*n*t+r*h*n*t+a*i*l*t-e*h*l*t-r*i*g*t+e*o*g*t}function sglInverseM4(t){for(var e=t[0],i=t[1],n=t[2],s=t[3],r=t[4],o=t[5],l=t[6],u=t[7],a=t[8],h=t[9],g=t[10],f=t[11],c=t[12],_=t[13],d=t[14],t=t[15],m=sglUndefM4(),p=(m[0]=h*d*u-_*g*u+_*l*f-o*d*f-h*l*t+o*g*t,m[1]=_*g*s-h*d*s-_*n*f+i*d*f+h*n*t-i*g*t,m[2]=o*d*s-_*l*s+_*n*u-i*d*u-o*n*t+i*l*t,m[3]=h*l*s-o*g*s-h*n*u+i*g*u+o*n*f-i*l*f,m[4]=c*g*u-a*d*u-c*l*f+r*d*f+a*l*t-r*g*t,m[5]=a*d*s-c*g*s+c*n*f-e*d*f-a*n*t+e*g*t,m[6]=c*l*s-r*d*s-c*n*u+e*d*u+r*n*t-e*l*t,m[7]=r*g*s-a*l*s+a*n*u-e*g*u-r*n*f+e*l*f,m[8]=a*_*u-c*h*u+c*o*f-r*_*f-a*o*t+r*h*t,m[9]=c*h*s-a*_*s-c*i*f+e*_*f+a*i*t-e*h*t,m[10]=r*_*s-c*o*s+c*i*u-e*_*u-r*i*t+e*o*t,m[11]=a*o*s-r*h*s-a*i*u+e*h*u+r*i*f-e*o*f,m[12]=c*h*l-a*_*l-c*o*g+r*_*g+a*o*d-r*h*d,m[13]=a*_*n-c*h*n+c*i*g-e*_*g-a*i*d+e*h*d,m[14]=c*o*n-r*_*n-c*i*l+e*_*l+r*i*d-e*o*d,m[15]=r*h*n-a*o*n+a*i*l-e*h*l-r*i*g+e*o*g,1/(c*h*l*s-a*_*l*s-c*o*g*s+r*_*g*s+a*o*d*s-r*h*d*s-c*h*n*u+a*_*n*u+c*i*g*u-e*_*g*u-a*i*d*u+e*h*d*u+c*o*n*f-r*_*n*f-c*i*l*f+e*_*l*f+r*i*d*f-e*o*d*f-a*o*n*t+r*h*n*t+a*i*l*t-e*h*l*t-r*i*g*t+e*o*g*t)),v=0;v<16;++v)m[v]*=p;return m}function sglTraceM4(t){return t[0]+t[5]+t[10]+t[15]}function sglTranslationM4V(t){var e=sglIdentityM4();return e[12]=t[0],e[13]=t[1],e[14]=t[2],e}function sglTranslationM4C(t,e,i){return sglTranslationM4V([t,e,i])}function sglTranslationM4S(t){return sglTranslationM4C(t,t,t)}function sglRotationAngleAxisM4V(t,e){var e=sglNormalizedV3(e),i=sglSin(t),t=sglCos(t),n=1-t,s=e[0],r=e[1],e=e[2],o=s*s,l=r*r,u=e*e,a=s*r,h=r*e,g=e*s,s=s*i,r=r*i,e=e*i,i=sglUndefM4();return i[0]=n*o+t,i[1]=n*a+e,i[2]=n*g-r,i[3]=0,i[4]=n*a-e,i[5]=n*l+t,i[6]=n*h+s,i[7]=0,i[8]=n*g+r,i[9]=n*h-s,i[10]=n*u+t,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i}function sglRotationAngleAxisM4C(t,e,i,n){return sglRotationAngleAxisM4V(t,[e,i,n])}function sglScalingM4V(t){var e=sglIdentityM4();return e[0]=t[0],e[5]=t[1],e[10]=t[2],e}function sglScalingM4C(t,e,i){return sglScalingM4V([t,e,i])}function sglScalingM4S(t){return sglScalingM4C(t,t,t)}function sglLookAtM4V(t,e,i){var e=sglNormalizedV3(sglSubV3(e,t)),i=sglNormalizedV3(i),n=sglNormalizedV3(sglCrossV3(e,i)),i=sglNormalizedV3(sglCrossV3(n,e)),s=sglUndefM4();return s[0]=n[0],s[1]=i[0],s[2]=-e[0],s[3]=0,s[4]=n[1],s[5]=i[1],s[6]=-e[1],s[7]=0,s[8]=n[2],s[9]=i[2],s[10]=-e[2],s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s=sglMulM4(s,sglTranslationM4V(sglNegV3(t)))}function sglLookAtM4C(t,e,i,n,s,r,o,l,u){return sglLookAtM4V([t,e,i],[n,s,r],[o,l,u])}function sglOrthoM4V(t,e){var i=sglAddV3(e,t),e=sglSubV3(e,t),t=sglUndefM4();return t[0]=2/e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2/e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=-2/e[2],t[11]=0,t[12]=-i[0]/e[0],t[13]=-i[1]/e[1],t[14]=-i[2]/e[2],t[15]=1,t}function sglOrthoM4C(t,e,i,n,s,r){return sglOrthoM4V([t,i,s],[e,n,r])}function sglFrustumM4V(t,e){var i=sglAddV3(e,t),n=sglSubV3(e,t),t=2*t[2],s=sglUndefM4();return s[0]=t/n[0],s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=t/n[1],s[6]=0,s[7]=0,s[8]=i[0]/n[0],s[9]=i[1]/n[1],s[10]=-i[2]/n[2],s[11]=-1,s[12]=0,s[13]=0,s[14]=-t*e[2]/n[2],s[15]=0,s}function sglFrustumM4C(t,e,i,n,s,r){return sglFrustumM4V([t,i,s],[e,n,r])}function sglPerspectiveM4(t,e,i,n){var s=sglUndefV4(),r=sglUndefV4();return s[2]=i,r[2]=n,r[1]=s[2]*sglTan(t/2),s[1]=-r[1],r[0]=r[1]*e,s[0]=-r[0],sglFrustumM4V(s,r)}function sglUndefQuat(t){return new Array(4)}function sglQuatV(t){return t.slice(0,4)}function sglIdentityQuat(){return[0,0,0,1]}function sglAngleAxisQuat(t,e){var t=t/2,i=sglSin(t);return[i*e[0],i*e[1],i*e[2],sglCos(t)]}function sglM4Quat(t){var e,i,n=sglGetElemM4(t,0,0)+sglGetElemM4(t,1,1)+sglGetElemM4(t,2,2),s=null,r=sglUndefQuat();return 0<n?(s=sglSqrt(n+1),r[3]=s/2,s=.5/s,r[0]=(sglGetElemM4(t,2,1)-sglGetElemM4(t,1,2))*s,r[1]=(sglGetElemM4(t,0,2)-sglGetElemM4(t,2,0))*s,r[2]=(sglGetElemM4(t,1,0)-sglGetElemM4(t,0,1))*s):(n=0,sglGetElemM4(t,1,1)>sglGetElemM4(t,0,0)&&(n=1),i=(1+(e=((n=sglGetElemM4(t,2,2)>sglGetElemM4(t,n,n)?2:n)+1)%3))%3,s=sglSqrt(sglGetElemM4(t,n,n)-sglGetElemM4(t,e,e)-sglGetElemM4(t,i,i)+1),r[n]=s/2,s=.5/s,r[3]=(sglGetElemM4(t,i,e)-sglGetElemM4(t,e,i))*s,r[e]=(sglGetElemM4(t,e,n)+sglGetElemM4(t,n,e))*s,r[i]=(sglGetElemM4(t,i,n)+sglGetElemM4(t,n,i))*s),r}function sglGetQuatAngleAxis(t){var e=new Array(4),i=sglSqLengthV4(t);return 0<i?(i=1/sglSqrt(i),e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=2*aglAcos(t[3])):(e[0]=0,e[1]=0,e[2]=1,e[3]=0),e}function sglGetQuatRotationM4(t){var e=2*t[0],i=2*t[1],n=2*t[2],s=e*t[3],r=i*t[3],o=n*t[3],e=e*t[0],l=i*t[0],u=n*t[0],i=i*t[1],a=n*t[1],n=n*t[2],t=sglIdentityM4();return sglSetElemM4(t,0,0,1-(i+n)),sglSetElemM4(t,0,1,l-o),sglSetElemM4(t,0,2,u+r),sglSetElemM4(t,1,0,l+o),sglSetElemM4(t,1,1,1-(e+n)),sglSetElemM4(t,1,2,a-s),sglSetElemM4(t,2,0,u-r),sglSetElemM4(t,2,1,a+s),sglSetElemM4(t,2,2,1-(e+i)),t}function sglNormalizedQuat(t){return sglNormalizedV4(t)}function sglMulQuat(t,e){var i=sglUndefQuat();i[0]=p[3]*q[0]+p[0]*q[3]+p[1]*q[2]-p[2]*q[1],i[1]=p[3]*q[1]+p[1]*q[3]+p[2]*q[0]-p[0]*q[2],i[2]=p[3]*q[2]+p[2]*q[3]+p[0]*q[1]-p[1]*q[0],i[3]=p[3]*q[3]-p[0]*q[0]-p[1]*q[1]-p[2]*q[2]}function SglVec2(){switch(this.v=new Array(2),arguments.length){case 1:arguments[0]instanceof Array?this.setVec(arguments[0]):arguments[0]instanceof SglVec2?this.setVec(arguments[0].v):this.setScalar(arguments[0]);break;case 2:this.setVec(arguments);break;default:this.setZero()}}function SglVec3(){switch(this.v=new Array(3),arguments.length){case 1:arguments[0]instanceof Array?this.setVec(arguments[0]):arguments[0]instanceof SglVec3?this.setVec(arguments[0].v):this.setScalar(arguments[0]);break;case 3:this.setVec(arguments);break;default:this.setZero()}}function SglVec4(){switch(this.v=new Array(4),arguments.length){case 1:arguments[0]instanceof Array?this.setVec(arguments[0]):arguments[0]instanceof SglVec4?this.setVec(arguments[0].v):this.setScalar(arguments[0]);break;case 4:this.setVec(arguments);break;default:this.setZero()}}function SglPlane3(t,e,i){this._normal=[0,0,1],this._offset=0,t&&e&&this.setup(t,e,i)}function SglBox3(t,e){this._min=[1,1,1],this._max=[-1,-1,-1],t&&e&&this.setup(t,e)}function SglSphere3(t,e){this._center=[0,0,0],this._radius=-1,t&&e&&this.setup(t,e)}function SglMatrixStack(){this._s=[],this._s.push(sglIdentityM4()),this._n=0}function SglTransformStack(){this._ms=new SglMatrixStack,this._vs=new SglMatrixStack,this._ps=new SglMatrixStack}function _SglFrustumPlane(){this.normal=[0,0,1],this.offset=0,this.testVertex=[0,0,0]}SglVec2.prototype={clone:function(){return new SglVec2(this)},get copy(){return this.clone()},get x(){return this.v[0]},set x(t){this.v[0]=t},get y(){return this.v[1]},set y(t){this.v[1]=t},set:function(t,e){return this.v[0]=t,this.v[1]=e,this},setVec:function(t){return this.set(t[0],t[1])},setScalar:function(t){return this.set(t,t)},setZero:function(){return this.setScalar(0)},setOne:function(){return this.setScalar(1)},at:function(t){return this.v[t]},get squaredLength(){return this.dot(this)},get length(){return sglSqrt(this.squaredLength)},normalize:function(){var t=this.length;return this.v[0]*=t=0<t?1/t:t,this.v[1]*=t,this},get normalized(){return this.clone().normalize()},get neg(){return new SglVec2(-this.v[0],-this.v[1])},get abs(){return new SglVec2(sglAbs(this.v[0]),sglAbs(this.v[1]))},get minComp(){var t=this.v[0];return t=t>this.v[1]?this.v[1]:t},get maxComp(){var t=this.v[0];return t=t<this.v[1]?this.v[1]:t},get argMin(){var t=0;return t=this.v[t]>this.v[1]?1:t},get argMax(){var t=0;return t=this.v[t]>this.v[1]?1:t},add:function(t){return new SglVec2(this.v[0]+t.v[0],this.v[1]+t.v[1])},sub:function(t){return new SglVec2(this.v[0]-t.v[0],this.v[1]-t.v[1])},mul:function(t){return new SglVec2(this.v[0]*t.v[0],this.v[1]*t.v[1])},div:function(t){return new SglVec2(this.v[0]/t.v[0],this.v[1]/t.v[1])},get rcp(){return new SglVec2(1/this.v[0],1/this.v[1])},dot:function(t){return this.v[0]*t.v[0]+this.v[1]*t.v[1]},cross:function(t){return this.v[0]*t.v[1]-this.v[1]*t.v[0]},min:function(t){return new SglVec2(sglMin(this.v[0],t.v[0]),sglMin(this.v[1],t.v[1]))},max:function(t){return new SglVec2(sglMax(this.v[0],t.v[0]),sglMax(this.v[1],t.v[1]))}},SglVec3.prototype={clone:function(){return new SglVec3(this)},get copy(){return this.clone()},get x(){return this.v[0]},set x(t){this.v[0]=t},get y(){return this.v[1]},set y(t){this.v[1]=t},get z(){return this.v[2]},set z(t){this.v[2]=t},set:function(t,e,i){return this.v[0]=t,this.v[1]=e,this.v[2]=i,this},setVec:function(t){return this.set(t[0],t[1],t[2])},setScalar:function(t){return this.set(t,t,t)},setZero:function(){return this.setScalar(0)},setOne:function(){return this.setScalar(1)},at:function(t){return this.v[t]},get squaredLength(){return this.dot(this)},get length(){return sglSqrt(this.squaredLength)},normalize:function(){var t=this.length;return this.v[0]*=t=0<t?1/t:t,this.v[1]*=t,this.v[2]*=t,this},get normalized(){return this.clone().normalize()},get neg(){return new SglVec3(-this.v[0],-this.v[1],-this.v[2])},get abs(){return new SglVec3(sglAbs(this.v[0]),sglAbs(this.v[1]),sglAbs(this.v[2]))},get minComp(){var t=this.v[0];return t=(t=t>this.v[1]?this.v[1]:t)>this.v[2]?this.v[2]:t},get maxComp(){var t=this.v[0];return t=(t=t<this.v[1]?this.v[1]:t)<this.v[2]?this.v[2]:t},get argMin(){var t=0;return this.v[t]>this.v[1]&&(t=1),t=this.v[t]>this.v[2]?2:t},get argMax(){var t=0;return this.v[t]>this.v[1]&&(t=1),t=this.v[t]>this.v[2]?2:t},add:function(t){return new SglVec3(this.v[0]+t.v[0],this.v[1]+t.v[1],this.v[2]+t.v[2])},sub:function(t){return new SglVec3(this.v[0]-t.v[0],this.v[1]-t.v[1],this.v[2]-t.v[2])},mul:function(t){return new SglVec3(this.v[0]*t.v[0],this.v[1]*t.v[1],this.v[2]*t.v[2])},div:function(t){return new SglVec3(this.v[0]/t.v[0],this.v[1]/t.v[1],this.v[2]/t.v[2])},get rcp(){return new SglVec3(1/this.v[0],1/this.v[1],1/this.v[2])},dot:function(t){return this.v[0]*t.v[0]+this.v[1]*t.v[1]+this.v[2]*t.v[2]},cross:function(t){return new SglVec3(this.v[1]*t.v[2]-this.v[2]*t.v[1],this.v[2]*t.v[0]-this.v[0]*t.v[2],this.v[0]*t.v[1]-this.v[1]*t.v[0])},min:function(t){return new SglVec3(sglMin(this.v[0],t.v[0]),sglMin(this.v[1],t.v[1]),sglMin(this.v[2],t.v[2]))},max:function(t){return new SglVec3(sglMax(this.v[0],t.v[0]),sglMax(this.v[1],t.v[1]),sglMax(this.v[2],t.v[2]))}},SglVec4.prototype={clone:function(){return new SglVec4(this)},get copy(){return this.clone()},get x(){return this.v[0]},set x(t){this.v[0]=t},get y(){return this.v[1]},set y(t){this.v[1]=t},get z(){return this.v[2]},set z(t){this.v[2]=t},get w(){return this.v[3]},set w(t){this.v[3]=t},set:function(t,e,i,n){return this.v[0]=t,this.v[1]=e,this.v[2]=i,this.v[3]=n,this},setVec:function(t){return this.set(t[0],t[1],t[2],t[3])},setScalar:function(t){return this.set(t,t,t,t)},setZero:function(){return this.setScalar(0)},setOne:function(){return this.setScalar(1)},at:function(t){return this.v[t]},get squaredLength(){return this.dot(this)},get length(){return sglSqrt(this.squaredLength)},normalize:function(){var t=this.length;return this.v[0]*=t=0<t?1/t:t,this.v[1]*=t,this.v[2]*=t,this.v[3]*=t,this},get normalized(){return this.clone().normalize()},get neg(){return new SglVec4(-this.v[0],-this.v[1],-this.v[2],-this.v[3])},get abs(){return new SglVec4(sglAbs(this.v[0]),sglAbs(this.v[1]),sglAbs(this.v[2]),sglAbs(this.v[3]))},get minComp(){var t=this.v[0];return t=(t=(t=t>this.v[1]?this.v[1]:t)>this.v[2]?this.v[2]:t)>this.v[3]?this.v[3]:t},get maxComp(){var t=this.v[0];return t=(t=(t=t<this.v[1]?this.v[1]:t)<this.v[2]?this.v[2]:t)<this.v[3]?this.v[3]:t},get argMin(){var t=0;return this.v[t]>this.v[1]&&(t=1),this.v[t]>this.v[2]&&(t=2),t=this.v[t]>this.v[3]?2:t},get argMax(){var t=0;return this.v[t]>this.v[1]&&(t=1),this.v[t]>this.v[2]&&(t=2),t=this.v[t]>this.v[3]?2:t},add:function(t){return new SglVec4(this.v[0]+t.v[0],this.v[1]+t.v[1],this.v[2]+t.v[2],this.v[3]+t.v[3])},sub:function(t){return new SglVec4(this.v[0]-t.v[0],this.v[1]-t.v[1],this.v[2]-t.v[2],this.v[3]-t.v[3])},mul:function(t){return new SglVec4(this.v[0]*t.v[0],this.v[1]*t.v[1],this.v[2]*t.v[2],this.v[3]*t.v[3])},div:function(t){return new SglVec4(this.v[0]/t.v[0],this.v[1]/t.v[1],this.v[2]/t.v[2],this.v[3]/t.v[3])},get rcp(){return new SglVec4(1/this.v[0],1/this.v[1],1/this.v[2],1/this.v[3])},dot:function(t){return this.v[0]*t.v[0]+this.v[1]*t.v[1]+this.v[2]*t.v[2]+this.v[3]*t.v[3]},min:function(t){return new SglVec4(sglMin(this.v[0],t.v[0]),sglMin(this.v[1],t.v[1]),sglMin(this.v[2],t.v[2]),sglMin(this.v[3],t.v[3]))},max:function(t){return new SglVec4(sglMax(this.v[0],t.v[0]),sglMax(this.v[1],t.v[1]),sglMax(this.v[2],t.v[2]),sglMax(this.v[3],t.v[3]))}},SglPlane3.prototype={get normal(){return this._normal},set normal(t){this._normal=t.slice(0,3)},get offset(){return this._offset},set offset(t){this._offset=t.slize(0,3)},clone:function(){return new SglPlane3(this._normal,this._offset,!1)},get copy(){return this.clone()},setup:function(t,e,i){this._normal[0]=t[0],this._normal[1]=t[1],this._normal[2]=t[2],this._offset=e,normalize&&0<(t=sglSqrt(sglDotV3(this._normal)))&&(sglSelfMulV3S(this._normal,t=1/t),this._offset*=t)}},SglBox3.prototype={get min(){return this._min},set min(t){this._min=t.slice(0,3)},get max(){return this._max},set max(t){this._max=t.slice(0,3)},clone:function(){return new SglBox3(this._min,this._max)},get copy(){return this.clone()},setup:function(t,e){for(var i=0;i<3;++i)this._min[i]=t[i],this._max[i]=e[i];return this},get isNull(){return this._min[0]>this._max[0]},get isEmpty(){return this._min[0]==this._max[0]&&this._min[1]==this._max[1]&&this._min[2]==this._max[2]},get center(){return sglSelfMulV3S(sglAddV3(this._min,this._max),.5)},get size(){return sglSubV3(this._max,this._min)},get squaredDiagonal(){var t=this.size;return sglDotV3(t,t)},get diagonal(){return sglSqrt(this.squaredDiagonal)},get facesAreas(){var t=this.size;return[t[1]*t[2],t[0]*t[2],t[0]*t[1]]},get surfaceArea(){var t=this.facesArea;return 2*(t[0]+t[1]+t[2])},get volume(){var t=this.size;return t[0]*t[1]*t[2]},offset:function(t){return sglSelfSubV3S(this._min[i],t),sglSelfAddV3S(this._max[i],t),this},corner:function(t){var e=this.size;return[this._min[0]+(t%2!=0?1:0)*e[0],this._min[1]+(t/2%2!=0?1:0)*e[1],this._min[2]+(3<t!=0?1:0)*e[2]]},transformed:function(t){var e=new SglBox3,i=sglMulM4V3(t,this.corner(0),1);e.min=i,e.max=i;for(var n=1;n<8;++n)i=sglMulM4V3(t,this.corner(n),1),e.min=sglMinV3(e.min,i),e.max=sglMaxV3(e.max,i);return e},addPoint:function(t){return this.isNull?(this.min=t,this.max=t):(this.min=sglMinV3(this.min,t),this.max=sglMaxV3(this.min,t)),this},addBox:function(t){return t.isNull||(this.isNull?(this.min=t.min,this.max=t.max):(this.min=sglMinV3(this.min,t.min),this.max=sglMaxV3(this.max,t.max))),this}},SglSphere3.prototype={get center(){return this._center},set center(t){this._center=t.slice(0,3)},get radius(){return this._redius},set radius(t){this._radius=t},clone:function(){return new SglSphere3(this._center,this._radius)},get copy(){return this.clone()},setup:function(t,e){return this._center[0]=t[0],this._center[1]=t[1],this._center[2]=t[2],this._radius=e,this},get isNull(){return this._radius<0},get isEmpty(){return 0==this._radius},get surfaceArea(){return 4*SGL_PI*this._radius*this._radius},get volume(){return 4/3*SGL_PI*this._radius*this._radius*this._radius}},SglMatrixStack.prototype={clone:function(){var t=new SglMatrixStack;t.s=[];for(var e=0;e<this._n+1;++e)t._s.push(sglDupM4(this._s[e]));return t},get copy(){return this.clone()},reset:function(){return this._s=[],this._s.push(sglIdentityM4()),this._n=0,this},get size(){return this._n+1},get top(){return sglDupM4(this._s[this._n])},get topRef(){return this._s[this._n]},push:function(){return this._s.push(sglDupM4(this._s[this._n])),this._n++,this},pop:function(){return 0<this._n&&(this._s.pop(),this._n--),this},load:function(t){return this._s[this._n]=sglDupM4(t),this},multiply:function(t){return this._s[this._n]=sglMulM4(this._s[this._n],t),this},loadIdentity:function(){return this._s[this._n]=sglIdentityM4(),this},translate:function(t,e,i){return this.multiply(sglTranslationM4C(t,e,i))},rotate:function(t,e,i,n){return this.multiply(sglRotationAngleAxisM4C(t,e,i,n))},scale:function(t,e,i){return this.multiply(sglScalingM4C(t,e,i))},lookAt:function(t,e,i,n,s,r,o,l,u){return this.multiply(sglLookAtM4C(t,e,i,n,s,r,o,l,u))},ortho:function(t,e,i,n,s,r){return this.multiply(sglOrthoM4C(t,e,i,n,s,r))},frustum:function(t,e,i,n,s,r){return this.multiply(sglFrustumM4C(t,e,i,n,s,r))},perspective:function(t,e,i,n){return this.multiply(sglPerspectiveM4(t,e,i,n))}},SglTransformStack.prototype={clone:function(){var t=new SglTransformStack;return t._ms=this._ms.clone(),t._vs=this._vs.clone(),t._ps=this._ps.clone(),t},get copy(){return this.clone()},reset:function(){return this._ms.reset(),this._vs.reset(),this._ps.reset(),this},get model(){return this._ms},get view(){return this._vs},get projection(){return this._ps},get modelMatrix(){return this.model.top},get modelMatrixRef(){return this.model.topRef},get modelMatrixTranspose(){return sglTransposeM4(this.modelMatrixRef)},get modelMatrixInverse(){return sglInverseM4(this.modelMatrixRef)},get modelMatrixInverseTranspose(){return sglTransposeM4(this.modelMatrixInverse)},get viewMatrix(){return this.view.top},get viewMatrixRef(){return this.view.topRef},get viewMatrixTranspose(){return sglTransposeM4(this.viewMatrixRef)},get viewMatrixInverse(){return sglInverseM4(this.viewMatrixRef)},get viewMatrixInverseTranspose(){return sglTransposeM4(this.viewMatrixInverse)},get projectionMatrix(){return this.projection.top},get projectionMatrixRef(){return this.projection.topRef},get projectionMatrixTranspose(){return sglTransposeM4(this.projectionMatrixRef)},get projectionMatrixInverse(){return sglInverseM4(this.projectionMatrixRef)},get projectionMatrixInverseTranspose(){return sglTransposeM4(this.projectionMatrixInverse)},get modelViewMatrix(){return sglMulM4(this.viewMatrixRef,this.modelMatrixRef)},get modelViewMatrixTranspose(){return sglTransposeM4(this.modelViewMatrix)},get modelViewMatrixInverse(){return sglInverseM4(this.modelViewMatrix)},get modelViewMatrixInverseTranspose(){return sglTransposeM4(this.modelViewMatrixInverse)},get viewProjectionMatrix(){return sglMulM4(this.projectionMatrixRef,this.viewMatrixRef)},get viewProjectionMatrixTranspose(){return sglTransposeM4(this.viewProjectionMatrix)},get viewProjectionMatrixInverse(){return sglInverseM4(this.viewProjectionMatrix)},get viewProjectionMatrixInverseTranspose(){return sglTransposeM4(this.viewProjectionMatrixInverse)},get modelViewProjectionMatrix(){return sglMulM4(this.projectionMatrixRef,sglMulM4(this.viewMatrixRef,this.modelMatrixRef))},get modelViewProjectionMatrixTranspose(){return sglTransposeM4(this.modelViewProjectionMatrix)},get modelViewProjectionMatrixInverse(){return sglInverseM4(this.modelViewProjectionMatrix)},get modelViewProjectionMatrixInverseTranspose(){return sglTransposeM4(this.modelViewProjectionMatrixInverse)},get worldSpaceNormalMatrix(){return sglM4toM3(this.modelMatrixInverseTranspose)},get viewSpaceNormalMatrix(){return sglM4toM3(this.modelViewMatrixInverseTranspose)},get modelSpaceViewerPosition(){return sglV4toV3(sglGetColM4(this.modelViewMatrixInverse,3))},get modelSpaceViewDirection(){return sglNegV3(sglV4toV3(sglGetRowM4(this.modelViewMatrix,2)))},get worldSpaceViewerPosition(){return sglV4toV3(sglGetColM4(this.viewMatrixInverse,3))},get worldSpaceViewDirection(){return ssglNegV3(sglV4toV3(sglGetRowM4(this.viewMatrixRef,2)))}},_SglFrustumPlane.prototype={setup:function(t,e,i,n){var s=1/sglSqrt(t*t+e*e+i*i);this.normal[0]=t*s,this.normal[1]=e*s,this.normal[2]=i*s,this.offset=n*s,this.testVertex[0]=0<=this.normal[0]?1:0,this.testVertex[1]=0<=this.normal[1]?1:0,this.testVertex[2]=0<=this.normal[2]?1:0}};var SGL_OUTSIDE_FRUSTUM=0,SGL_INTERSECT_FRUSTUM=1,SGL_INSIDE_FRUSTUM=2;function SglFrustum(t,e,i){this._mvpMatrix=sglIdentityM4(),this._viewport=[0,0,1,1],this._vp=[0,0,1,1],this._billboardMatrix=sglIdentityM4(),this._planes=new Array(6);for(var n=0;n<6;++n)this._planes[n]=new _SglFrustumPlane;t&&e&&i&&this.setup(t,e,i)}function sglBoxVisibility(t,e,i){return new SglFrustum(t).boxVisibility(e,i)}function _sglConsolidateOptions(t,e){if(e)for(var i in e)t[i]=e[i];return t}function sglGetBufferOptions(t,e){return _sglConsolidateOptions({usage:t.STATIC_DRAW},e)}function SglBufferInfo(){this.handle=null,this.valid=!1,this.target=0,this.size=0,this.usage=0}function sglBufferFromData(t,e,i,n){var n=sglGetBufferOptions(t,n),s=t.createBuffer(),t=(t.bindBuffer(e,s),t.bufferData(e,i,n.usage),t.bindBuffer(e,null),new SglBufferInfo);return t.handle=s,t.valid=!0,t.target=e,t.size=i.sizeInBytes,t.usage=n.usage,t}function sglVertexBufferFromData(t,e,i){return sglBufferFromData(t,t.ARRAY_BUFFER,e,i)}function sglIndexBufferFromData(t,e,i){return sglBufferFromData(t,t.ELEMENT_ARRAY_BUFFER,e,i)}function SglShaderInfo(){this.handle=null,this.valid=!1,this.type=0,this.log=""}function sglShaderFromSource(t,e,i){var n="",s=(n+="----------------------\n",t.createShader(e)),i=(t.shaderSource(s,i),t.compileShader(s),n+="[SHADER LOG]\n",!0),t=(0!=t.getShaderParameter(s,t.COMPILE_STATUS)?n+="SUCCESS:\n":(i=!1,n+="FAIL:\n"),n=(n+=t.getShaderInfoLog(s))+"\n"+"----------------------\n",new SglShaderInfo);return t.handle=s,t.valid=i,t.type=e,t.log=n,t}function sglVertexShaderFromSource(t,e){return sglShaderFromSource(t,t.VERTEX_SHADER,e)}function sglFragmentShaderFromSource(t,e){return sglShaderFromSource(t,t.FRAGMENT_SHADER,e)}function SglProgramAttributeInfo(){this.name="",this.nativeType=0,this.size=0,this.location=-1}function SglProgramUniformInfo(){this.name="",this.nativeType=0,this.size=0,this.location=-1}function SglProgramSamplerInfo(){this.name="",this.nativeType=0,this.size=0,this.location=-1}function SglProgramInfo(){this.handle=null,this.valid=!1,this.shaders=[],this.attributes=new Object,this.uniforms=new Object,this.samplers=new Object,this.log=""}function sglProgramFromShaders(t,e){var i="",n=(i+="----------------------\n",t.createProgram());for(o in e){var s=e[o];t.attachShader(n,s.handle)}t.linkProgram(n);var r,o,i=(i=(i=i+"[PROGRAM LOG]\n"+((r=0!=t.getProgramParameter(n,t.LINK_STATUS))?"SUCCESS:\n":"FAIL:\n"))+t.getProgramInfoLog(n))+"\n"+"----------------------\n",l=new SglProgramInfo;for(o in l.handle=n,l.valid=r,e){s=e[o];l.shaders.push(s)}l.log=i;for(var u,a,h=t.getProgramParameter(n,t.ACTIVE_ATTRIBUTES),g=0;g<h;++g)(u=t.getActiveAttrib(n,g))&&((a=new SglProgramAttributeInfo).name=u.name,a.nativeType=u.type,a.size=u.size,a.location=t.getAttribLocation(n,u.name),l.attributes[a.name]=a);for(var f,c,_,d=t.getProgramParameter(n,t.ACTIVE_UNIFORMS),g=0;g<d;++g)(f=t.getActiveUniform(n,g))&&(c=t.getUniformLocation(n,f.name),f.type==t.SAMPLER_2D||f.type==t.SAMPLER_CUBE||35682==f.type?((o=new SglProgramSamplerInfo).name=f.name,o.nativeType=f.type,o.size=f.size,o.location=c,l.samplers[o.name]=o):((_=new SglProgramUniformInfo).name=f.name,_.nativeType=f.type,_.size=f.size,_.location=c,l.uniforms[_.name]=_));return sglSetDefaultProgramBindings(t,l),l}function sglProgramFromSources(t,e,i){var n,s=null,r=[];for(n in e){s=sglVertexShaderFromSource(t,e[n]);r.push(s)}for(n in i)s=sglFragmentShaderFromSource(t,i[n]),r.push(s);return sglProgramFromShaders(t,r)}function sglSetDefaultProgramBindings(t,e){var i,n,s=e.handle,r=0;for(i in e.attributes){var o=e.attributes[i];t.bindAttribLocation(s,r,o.name),o.location=r,r++}for(n in t.linkProgram(s),e.uniforms){var l=e.uniforms[n];l.location=t.getUniformLocation(s,l.name)}t.useProgram(e.handle);var u,a=0;for(u in e.samplers){var h=e.samplers[u];h.location=t.getUniformLocation(s,h.name),t.uniform1i(h.location,a),a++}}function sglProgramSynchronize(t,e){var i,n,s,r=e.handle;for(i in e.attributes){var o=e.attributes[i];o.location=t.getAttribLocation(r,o.name)}for(n in e.uniforms){var l=e.uniforms[n];l.location=t.getUniformLocation(r,l.name)}for(s in e.samplers){var u=e.samplers[s];u.location=t.getUniformLocation(r,u.name)}}function sglGetTextureOptions(t,e){return _sglConsolidateOptions({minFilter:t.LINEAR,magFilter:t.LINEAR,wrapS:t.CLAMP_TO_EDGE,wrapT:t.CLAMP_TO_EDGE,isDepth:!1,depthMode:t.LUMINANCE,depthCompareMode:t.COMPARE_R_TO_TEXTURE,depthCompareFunc:t.LEQUAL,generateMipmap:!1,flipY:!0,premultiplyAlpha:!1,onload:null},e)}function SglTextureInfo(){this.handle=null,this.valid=!1,this.target=0,this.format=0,this.width=0,this.height=0,this.minFilter=0,this.magFilter=0,this.wrapS=0,this.wrapT=0,this.isDepth=!1,this.depthMode=0,this.depthCompareMode=0,this.depthCompareFunc=0}function sglTexture2DFromData(t,e,i,n,s,r,o,l){var l=sglGetTextureOptions(t,l),u=(o=o||new(r==t.FLOAT?Float32Array:Uint8Array)(i*n*4),t.createTexture()),a=(t.bindTexture(t.TEXTURE_2D,u),t.getParameter(t.UNPACK_FLIP_Y_WEBGL)),h=!0===l.flipY,s=(a!=h&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,h?1:0),t.texImage2D(t.TEXTURE_2D,0,e,i,n,0,s,r,o),a!=h&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,a?1:0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,l.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,l.magFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,l.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,l.wrapT),l.isDepth&&(t.texParameteri(t.TEXTURE_2D,t.DEPTH_TEXTURE_MODE,l.depthMode),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_COMPARE_MODE,l.depthCompareMode),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_COMPARE_FUNC,l.depthCompareFunc)),l.generateMipmap&&t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null),new SglTextureInfo);return s.handle=u,s.valid=!0,s.target=t.TEXTURE_2D,s.format=e,s.width=i,s.height=n,s.minFilter=l.minFilter,s.magFilter=l.magFilter,s.wrapS=l.wrapS,s.wrapT=l.wrapT,s.isDepth=l.isDepth,s.depthMode=l.depthMode,s.depthCompareMode=l.depthCompareMode,s.depthCompareFunc=l.depthCompareFunc,s}function sglTexture2DFromImage(t,e,i){var i=sglGetTextureOptions(t,i),n=t.createTexture(),s=(t.bindTexture(t.TEXTURE_2D,n),t.getParameter(t.UNPACK_FLIP_Y_WEBGL)),r=!0===i.flipY,r=(s!=r&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r?1:0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),s!=r&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,s?1:0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i.magFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,i.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,i.wrapT),i.generateMipmap&&t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null),new SglTextureInfo);return r.handle=n,r.valid=!0,r.target=t.TEXTURE_2D,r.format=t.RGBA,r.width=e.width,r.height=e.height,r.minFilter=i.minFilter,r.magFilter=i.magFilter,r.wrapS=i.wrapS,r.wrapT=i.wrapT,r.isDepth=!1,r.depthMode=0,r.depthCompareMode=0,r.depthCompareFunc=0,r}function sglTexture2DFromUrl(i,n,t){var s=sglGetTextureOptions(i,t),r=new SglTextureInfo,o=new Image;return o.crossOrigin="",o.onload=function(){var t,e=sglTexture2DFromImage(i,o,s);for(t in e)r[t]=e[t];s.onload&&s.onload(i,r,n)},o.src=n,r}function sglTextureCubeFromData(t,e,i,n,s,r,o,l){l=sglGetTextureOptions(t,l);if(!o){var u=null,u=new(r==t.FLOAT?Float32Array:Uint8Array)(i*n*4);o=new Array(6);for(var a=0;a<6;++a)o[a]=u}var h=t.createTexture(),g=(t.bindTexture(t.TEXTURE_CUBE_MAP,h),t.getParameter(t.UNPACK_FLIP_Y_WEBGL)),f=!0===l.flipY;g!=f&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,f?1:0);for(a=0;a<6;++a)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+a,0,e,i,n,0,s,r,o[a]);g!=f&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,g?1:0),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,l.minFilter),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,l.magFilter),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,l.wrapS),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,l.wrapT),l.isDepth&&(t.texParameteri(t.TEXTURE_CUBE_MAP,t.DEPTH_TEXTURE_MODE,l.depthMode),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_COMPARE_MODE,l.depthCompareMode),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_COMPARE_FUNC,l.depthCompareFunc)),l.generateMipmap&&t.generateMipmap(t.TEXTURE_CUBE_MAP),t.bindTexture(t.TEXTURE_CUBE_MAP,null);f=new SglTextureInfo;return f.handle=h,f.valid=!0,f.target=t.TEXTURE_CUBE_MAP,f.format=e,f.width=i,f.height=n,f.minFilter=l.minFilter,f.magFilter=l.magFilter,f.wrapS=l.wrapS,f.wrapT=l.wrapT,f.isDepth=l.isDepth,f.depthMode=l.depthMode,f.depthCompareMode=l.depthCompareMode,f.depthCompareFunc=l.depthCompareFunc,f}function sglTextureCubeFromImages(t,e,i){var i=sglGetTextureOptions(t,i),n=t.createTexture(),s=(t.bindTexture(t.TEXTURE_CUBE_MAP,n),t.getParameter(t.UNPACK_FLIP_Y_WEBGL)),r=!0===i.flipY;s!=r&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r?1:0);for(var o=0;o<6;++o)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e[o]);s!=r&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,s?1:0),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,i.minFilter),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,i.magFilter),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,i.wrapS),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,i.wrapT),i.generateMipmap&&t.generateMipmap(t.TEXTURE_CUBE_MAP),t.bindTexture(t.TEXTURE_CUBE_MAP,null);r=new SglTextureInfo;return r.handle=n,r.valid=!0,r.target=t.TEXTURE_CUBE_MAP,r.format=t.RGBA,r.width=e[0].width,r.height=e[0].height,r.minFilter=i.minFilter,r.magFilter=i.magFilter,r.wrapS=i.wrapS,r.wrapT=i.wrapT,r.isDepth=!1,r.depthMode=0,r.depthCompareMode=0,r.depthCompareFunc=0,r}function sglTextureCubeFromUrls(i,n,t){for(var s=sglGetTextureOptions(i,t),r=new SglTextureInfo,o=6,l=new Array(6),e=0;e<6;++e)l[e]=new Image,l[e].crossOrigin="";for(var u=function(){if(0==--o){var t,e=sglTextureCubeFromImages(i,l,s);for(t in e)r[t]=e[t];s.onload&&s.onload(i,r,n)}},e=0;e<6;++e)l[e].onload=u,l[e].src=n[e];return r}function SglRenderbufferInfo(){this.handle=null,this.valid=!1,this.target=0,this.format=0,this.width=0,this.height=0}function sglRenderbufferFromFormat(t,e,i,n){var s=t.createRenderbuffer(),r=(t.bindRenderbuffer(t.RENDERBUFFER,s),t.renderbufferStorage(t.RENDERBUFFER,e,i,n),t.bindRenderbuffer(t.RENDERBUFFER,null),new SglRenderbufferInfo);return r.handle=s,r.valid=!0,r.target=t.RENDERBUFFER,r.format=e,r.width=i,r.height=n,r}function sglGetFramebufferOptions(t,e){return _sglConsolidateOptions({minFilter:t.LINEAR,magFilter:t.LINEAR,wrapS:t.CLAMP_TO_EDGE,wrapT:t.CLAMP_TO_EDGE,isDepth:!1,depthMode:t.LUMINANCE,depthCompareMode:t.COMPARE_R_TO_TEXTURE,depthCompareFunc:t.LEQUAL,colorsAsRenderbuffer:!1,depthAsRenderbuffer:!1,stencilAsRenderbuffer:!1,generateColorsMipmap:!1,generateDepthMipmap:!1,generateStencilMipmap:!1},e)}function SglFramebufferInfo(){this.handle=null,this.valid=!1,this.width=0,this.height=0,this.colorTargets=[],this.depthTarget=null,this.stencilTarget=null,this.status=0}function sglFramebufferFromTargets(t,e,i,n,s){sglGetFramebufferOptions(t,s);var s=t.createFramebuffer(),r=(t.bindFramebuffer(t.FRAMEBUFFER,s),null!=i&&i!=t.NONE&&(i.target==t.TEXTURE_2D?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,i.handle,0):i.target==t.RENDERBUFFER&&t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i.handle)),null!=n&&n!=t.NONE&&(n.target==t.TEXTURE_2D?t.framebufferTexture2D(t.FRAMEBUFFER,t.STENCIL_ATTACHMENT,t.TEXTURE_2D,n.handle,0):n.target==t.RENDERBUFFER&&t.framebufferRenderbuffer(t.FRAMEBUFFER,t.STENCIL_ATTACHMENT,t.RENDERBUFFER,n.handle)),[]),o=[];if(null!=e)if(0==e.length)o.push(t.NONE);else{var l,u=t.COLOR_ATTACHMENT0;for(l in e){var a=e[l];a.target==t.TEXTURE_2D?t.framebufferTexture2D(t.FRAMEBUFFER,u,t.TEXTURE_2D,a.handle,0):a.target==t.RENDERBUFFER&&t.framebufferRenderbuffer(t.FRAMEBUFFER,u,t.RENDERBUFFER,a.handle),o.push(u),r.push(a),u++}}var h=t.checkFramebufferStatus(t.FRAMEBUFFER),g=(t.bindFramebuffer(t.FRAMEBUFFER,null),null),f=(0<r.length?g=r[0]:i?g=i:n&&(g=n),0),c=0,g=(g&&(f=g.width,c=g.height),new SglFramebufferInfo);return g.handle=s,g.valid=h==t.FRAMEBUFFER_COMPLETE,g.width=f,g.height=c,g.colorTargets=r,g.depthTarget=i||null,g.stencilTarget=n||null,g.status=h,g}function sglFramebufferFromFormats(t,e,i,n,s,r,o){var l=sglGetFramebufferOptions(t,o),u=null;if(n){l.isDepth=!1;var u=[],a=null;if(l.colorsAsRenderbuffer)for(var h in n){a=sglRenderbufferFromFormat(t,n[h],e,i);u.push(a)}else for(var h in l.generateMipmap=l.generateColorsMipmap,n)a=sglTexture2DFromData(t,n[h],e,i,t.RGBA,t.UNSIGNED_BYTE,null,l),u.push(a)}o=null,s&&(l.isDepth=!0,o=l.depthAsRenderbuffer?sglRenderbufferFromFormat(t,s,e,i):(l.generateMipmap=l.generateDepthMipmap,sglTexture2DFromData(t,s,e,i,t.DEPTH_COMPONENT,t.FLOAT,null,l))),s=null;return r&&(l.isDepth=!1,s=l.stencilAsRenderbuffer?sglRenderbufferFromFormat(t,r,e,i):(l.generateMipmap=l.generateStencilMipmap,sglTexture2DFromData(t,r,e,i,t.STENCIL_COMPONENT,t.UNSIGNED_BYTE,null,l))),sglFramebufferFromTargets(t,u,o,s,l)}function SglVertexBuffer(){this.gl=arguments[0],this._info=null,arguments[1]instanceof SglBufferInfo?this._info=arguments[1]:this._info=sglVertexBufferFromData(this.gl,arguments[1],arguments[2])}function SglIndexBuffer(){this.gl=arguments[0],this._info=null,arguments[1]instanceof SglBufferInfo?this._info=arguments[1]:this._info=sglIndexBufferFromData(this.gl,arguments[1],arguments[2])}function SglProgramAttribute(t,e){this._prog=t,this._info=e}function SglProgramUniform(t,e){this._prog=t,this._info=e,this._func=null;t=this._prog.gl,e=this._info.nativeType;e==t.BOOL?this._func=function(t){this._prog.gl.uniform1i(this._info.location,t)}:e==t.BOOL_VEC2?this._func=function(t){this._prog.gl.uniform2iv(this._info.location,t)}:e==t.BOOL_VEC3?this._func=function(t){this._prog.gl.uniform3iv(this._info.location,t)}:e==t.BOOL_VEC4?this._func=function(t){this._prog.gl.uniform4iv(this._info.location,t)}:e==t.INT?this._func=function(t){this._prog.gl.uniform1i(this._info.location,t)}:e==t.INT_VEC2?this._func=function(t){this._prog.gl.uniform2iv(this._info.location,t)}:e==t.INT_VEC3?this._func=function(t){this._prog.gl.uniform3iv(this._info.location,t)}:e==t.INT_VEC4?this._func=function(t){this._prog.gl.uniform4iv(this._info.location,t)}:e==t.FLOAT?this._func=function(t){this._prog.gl.uniform1f(this._info.location,t)}:e==t.FLOAT_VEC2?this._func=function(t){this._prog.gl.uniform2fv(this._info.location,t)}:e==t.FLOAT_VEC3?this._func=function(t){this._prog.gl.uniform3fv(this._info.location,t)}:e==t.FLOAT_VEC4?this._func=function(t){this._prog.gl.uniform4fv(this._info.location,t)}:e==t.FLOAT_MAT2?this._func=function(t){this._prog.gl.uniformMatrix2fv(this._info.location,this._prog.gl.FALSE,t)}:e==t.FLOAT_MAT3?this._func=function(t){this._prog.gl.uniformMatrix3fv(this._info.location,this._prog.gl.FALSE,t)}:e==t.FLOAT_MAT4?this._func=function(t){this._prog.gl.uniformMatrix4fv(this._info.location,this._prog.gl.FALSE,t)}:sglUnknown()}function SglProgramSampler(t,e){this._prog=t,this._info=e,this._unit=-1;t=this._prog.gl,e=this._info.nativeType;e!=t.SAMPLER_2D&&e!=t.SAMPLER_CUBE&&35682!=e&&sglUnknown()}function SglProgram(){for(var t in this.gl=arguments[0],this._info=null,arguments[1]instanceof SglProgramInfo?this._info=arguments[1]:this._info=sglProgramFromSources(this.gl,arguments[1],arguments[2]),this._attributes=new Object,this._info.attributes)this._attributes[t]=new SglProgramAttribute(this,this._info.attributes[t]);for(var e in this._uniforms=new Object,this._info.uniforms)this._uniforms[e]=new SglProgramUniform(this,this._info.uniforms[e]);var i,n=0;for(i in this._samplers=new Object,this._info.samplers)this._samplers[i]=new SglProgramSampler(this,this._info.samplers[i]),this._samplers[i]._unit=n,n++}function SglTexture2D(){this.gl=arguments[0],this._info=null;var t=this.gl,e=arguments.length;2==e||3==e?arguments[1]instanceof Image?this._info=sglTexture2DFromImage(t,arguments[1],arguments[2]):this._info="string"==typeof arguments[1]?sglTexture2DFromUrl(t,arguments[1],arguments[2]):arguments[1]:this._info=sglTexture2DFromData(t,arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}function SglTextureCube(){this.gl=arguments[0],this._info=null;var t=this.gl,e=arguments.length;2==e||3==e?arguments[1]instanceof Array?arguments[1][0]instanceof Image?this._info=sglTextureCubeFromImages(t,arguments[1],arguments[2]):"string"==typeof arguments[1][0]&&(this._info=sglTextureCubeFromUrls(t,arguments[1],arguments[2])):this._info=arguments[1]:this._info=sglTextureCubeFromData(t,arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}function SglRenderbuffer(){this.gl=arguments[0],this._info=null;var t=this.gl;this._info=2==arguments.length?arguments[1]:sglRenderbufferFromFormat(t,arguments[1],arguments[2],arguments[3])}function SglFramebuffer(){this.gl=arguments[0],this._info=null;var t,e=this.gl,i=(this._info=2==arguments.length?arguments[1]:sglFramebufferFromFormats(e,arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6]),null),n=null;for(t in this._colorTargets=[],this._info.colorTargets)n=null,(i=this._info.colorTargets[t]).target==e.TEXTURE_2D?n=new SglTexture2D(e,i):i.target==e.RENDERBUFFER&&(n=new SglRenderbuffer(e,i)),this._colorTargets.push(n);this._depthTarget=null,this._info.depthTarget&&(n=null,(i=this._info.depthTarget).target==e.TEXTURE_2D?n=new SglTexture2D(e,i):i.target==e.RENDERBUFFER&&(n=new SglRenderbuffer(e,i)),this._depthTarget=n),this._stencilTarget=null,this._info.stencilTarget&&(n=null,(i=this._info.stencilTarget).target==e.TEXTURE_2D?n=new SglTexture2D(e,i):i.target==e.RENDERBUFFER&&(n=new SglRenderbuffer(e,i)),this._stencilTarget=n)}function SglAttributeStreamJS(t,e,i,n){this._name=t,this._size=e,this._buff=n?i?i.slice():null:i}function SglVertexStreamJS(){this._attribs={},this._length=0}SglFrustum.prototype={setup:function(t,e,i){var n=[sglGetColM4(e,0),sglGetColM4(e,1),sglGetColM4(e,2)],s=[sglLengthV4(n[0]),sglLengthV4(n[1]),sglLengthV4(n[2])],r=sglRcpV3(s),s=sglScalingM4V(s),o=sglScalingM4V(r),r=(n[0]=sglMulV4S(n[0],r[0]),n[1]=sglMulV4S(n[1],r[1]),n[2]=sglMulV4S(n[2],r[2]),sglIdentityM4()),n=(sglSetRowM4V(r,0,n[0]),sglSetRowM4V(r,1,n[1]),sglSetRowM4V(r,2,n[2]),this._mvpMatrix=sglMulM4(t,e),this._billboardMatrix=sglMulM4(o,sglMulM4(r,s)),this._viewport=i.slice(0,4),this._vp[0]=.5*this._viewport[2],this._vp[1]=this._viewport[0]+.5*this._viewport[2],this._vp[2]=.5*this._viewport[3],this._vp[3]=this._viewport[1]+.5*this._viewport[3],this._mvpMatrix),t=[n[3],n[7],n[11]];this._planes[0].setup(t[0]-n[0],t[1]-n[4],t[2]-n[8],n[15]-n[12]),this._planes[1].setup(t[0]+n[0],t[1]+n[4],t[2]+n[8],n[15]+n[12]),this._planes[2].setup(t[0]-n[1],t[1]-n[5],t[2]-n[9],n[15]-n[13]),this._planes[3].setup(t[0]+n[1],t[1]+n[5],t[2]+n[9],n[15]+n[13]),this._planes[4].setup(t[0]-n[2],t[1]-n[6],t[2]-n[10],n[15]-n[14]),this._planes[5].setup(t[0]+n[2],t[1]+n[6],t[2]+n[10],n[15]+n[14])},boxVisibility:function(t,e){for(var i,n=SGL_INSIDE_FRUSTUM,s=[t,e],r=0;r<6;++r){if((i=this._planes[r]).normal[0]*s[i.testVertex[0]][0]+i.normal[1]*s[i.testVertex[1]][1]+i.normal[2]*s[i.testVertex[2]][2]+i.offset<0)return SGL_OUTSIDE_FRUSTUM;i.normal[0]*s[1-i.testVertex[0]][0]+i.normal[1]*s[1-i.testVertex[1]][1]+i.normal[2]*s[1-i.testVertex[2]][2]+i.offset<0&&(n=SGL_INTERSECT_FRUSTUM)}return n},projectedSegmentSize:function(t,e){var e=.5*e,t=sglV3toV4(t,0),i=[e,0,0,1],i=(e=sglAddV4(sglMulM4V4(this._billboardMatrix,[-e,0,0,1]),t),e=sglProjectV4(sglMulM4V4(this._mvpMatrix,e)),i=sglAddV4(i=sglMulM4V4(this._billboardMatrix,i),t),sglProjectV4(sglMulM4V4(this._mvpMatrix,i)));return this._vp[0]*sglAbs(i[0]-e[0])}},SglVertexBuffer.prototype={get info(){return this._info},destroy:function(){this._info.valid&&this.gl.deleteBuffer(this._info.handle),this._info=null},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this._info.handle)},unbind:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},SglIndexBuffer.prototype={get info(){return this._info},destroy:function(){this._info.valid&&this.gl.deleteBuffer(this._info.handle),this._info=null},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this._info.handle)},unbind:function(){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null)}},SglProgramAttribute.prototype={set index(t){this._prog.gl.bindAttribLocation(this._prog._info.handle,t,this._info.name),this._info.location=t},get index(){return this._info.location}},SglProgramUniform.prototype={set value(t){this._func(t)},get value(){return this._prog.gl.getUniform(this._prog._info.handle,this._info.location)}},SglProgramSampler.prototype={set unit(t){this._prog.gl.uniform1i(this._info.location,t),this._unit=t},get unit(){return this._unit}},SglProgram.prototype={get info(){return this._info},get attributes(){return this._attributes},get uniforms(){return this._uniforms},get samplers(){return this._samplers},destroy:function(){if(null!=this._info.valid){var t,e=this.gl;for(t in e.deleteProgram(this._info.handle),this._info.shaders)e.deleteShader(this._info.shaders[t].handle);this._attributes=null,this._uniforms=null,this._samplers=null,this._info=null}},get handle(){return this._info.handle},get isValid(){return this._info.valid},get log(){var t,e="";for(t in e+="-------------------------------------\n",this._info.shaders)e+=this._info.shaders[t].log;return e=(e+=this._info.log)+"-------------------------------------\n"+"\n"},setDefaultBindings:function(){sglSetDefaultProgramBindings(this.gl,this._info)},synchronize:function(){sglProgramSynchronize(this.gl,this._info)},bind:function(){this.gl.useProgram(this._info.handle)},unbind:function(){},setAttributes:function(t){var e,i=null;for(e in t)(i=this._attributes[e])&&(i.index=t[e]);this.link()},setUniforms:function(t){var e,i=null;for(e in t)(i=this._uniforms[e])&&(i.value=t[e])},setSamplers:function(t){var e,i=null;for(e in t)null!=(i=this._samplers[e])&&(i.unit=t[e])}},SglTexture2D.prototype={get info(){return this._info},destroy:function(){null!=this._info.handle&&(this.gl.deleteTexture(this._info.handle),this._info=null)},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(t){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this._info.target,this._info.handle)},unbind:function(t){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this._info.target,null)},generateMipmap:function(){this.gl.generateMipmap(this._info.target)}},SglTextureCube.prototype={get info(){return this._info},destroy:function(){null!=this._info.handle&&(this.gl.deleteTexture(this._info.handle),this._info=null)},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(t){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this._info.target,this._info.handle)},unbind:function(t){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this._info.target,null)},generateMipmap:function(){this.gl.generateMipmap(this._info.target)}},SglRenderbuffer.prototype={get info(){return this._info},destroy:function(){null!=this._info.handle&&(this.gl.deleteRenderbuffer(this._info.handle),this._info=null)},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this._info.handle)},unbind:function(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null)}},SglFramebuffer.prototype={get info(){return this._info},get colorTargets(){return this._colorTargets},get depthTarget(){return this._depthTarget},get stencilTarget(){return this._stencilTarget},destroy:function(){if(null!=this._info.handle){for(var t in this.gl.deleteFramebuffer(this._info.handle),this._colorTargets)this._colorTargets[t]&&this._colorTargets[t].destroy();this._depthTarget&&this._depthTarget.destroy(),this._stencilTarget&&this._stencilTarget.destroy(),this._info=null,this.targets=null}},get handle(){return this._info.handle},get isValid(){return this._info.valid},get width(){return this._info.width},get height(){return this._info.height},bind:function(t){(null!=t?t:!0)&&this.gl.viewport(0,0,this._info.width,this._info.height),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._info.handle)},unbind:function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},bindColor:function(t,e){this._colorTargets[t].bind(e)},unbindColor:function(t,e){this._colorTargets[t].unbind(e)},bindDepth:function(t){this._depthTarget.bind(t)},unbindDepth:function(t){this._depthTarget.unbind(t)},bindStencil:function(t){this._stencilTarget.bind(t)},unbindStencil:function(t){this._stencilTarget.unbind(t)},generateMipmap:function(t,e,i){var n=null;if(t)for(var s in this._colorTargets)(n=this._colorTargets[s])&&n.info.target==this.gl.TEXTURE_2D&&(n.bind(0),n.generateMipmap(),n.unbind(0));e&&(n=this._depthTarget)&&n.info.target==this.gl.TEXTURE_2D&&(n.bind(0),n.generateMipmap(),n.unbind(0)),i&&(n=this._stencilTarget)&&n.info.target==this.gl.TEXTURE_2D&&(n.bind(0),n.generateMipmap(),n.unbind(0))},attachColorTarget:function(t,e){var i,n;return!!e&&!(t<0||t>=this._colorTargets.length||e.width!=this.width||e.height!=this.height||(i=this.gl,n=this.gl.COLOR_ATTACHMENT0+t,e.target==i.TEXTURE_2D?i.framebufferTexture2D(i.FRAMEBUFFER,n,i.TEXTURE_2D,e.handle,0):e.target==i.RENDERBUFFER&&i.framebufferRenderbuffer(i.FRAMEBUFFER,n,i.RENDERBUFFER,e.handle),this._colorTargets[t]=e,0))},detachColorTarget:function(t){var e,i;return!(t<0||t>=this._colorTargets.length||!(e=this._colorTargets[t])||(i=this.gl,e.target==i.TEXTURE_2D?i.framebufferTexture2D(i.FRAMEBUFFER,att,i.TEXTURE_2D,null,0):e.target==i.RENDERBUFFER&&i.framebufferRenderbuffer(i.FRAMEBUFFER,att,i.RENDERBUFFER,null),this._colorTargets[t]=null))}},SglAttributeStreamJS.prototype={get name(){return this._name},get size(){return this._size},get buffer(){return this._buff},get length(){return this._buff.length},get:function(t){return this._buff.slice(t*this._size,this._size)},set:function(t,e){for(var i=t*this._size,n=0;n<this._size;++n)this._buff[i++]=e[n];return r}},SglVertexStreamJS.prototype={get attributes(){return this._attribs},get length(){return this._length},addAttribute:function(t,e,i,n){e=new SglAttributeStreamJS(t,e,i,n);this._attribs[t]=e,this._length=e.length},removeAttribute:function(t){if(this._attribs[t])for(var e in delete this._attribs[t],this._length=0,this._attribs){this._length=this._attribs[e].length;break}}};var SGL_ARRAY_PRIMITIVE_STREAM=1,SGL_INDEXED_PRIMITIVE_STREAM=2,SGL_PACKED_INDEXED_PRIMITIVE_STREAM=3,SGL_POINTS_LIST=1,SGL_LINES_LIST=2,SGL_LINE_STRIP=3,SGL_LINE_LOOP=4,SGL_TRIANGLES_LIST=5,SGL_TRIANGLE_STRIP=6,SGL_TRIANGLE_FAN=7;function SglPrimitiveStreamJS(t,e,i,n){this._name=t,this._mode=e,this._first=i||0,this._length=n||0}function SglArrayPrimitiveStreamJS(t,e,i,n){SglPrimitiveStreamJS.call(this,t,e,i,n),Object.defineProperty(this,"type",{get:function(){return SGL_ARRAY_PRIMITIVE_STREAM}})}function SglIndexedPrimitiveStreamJS(t,e,i,n){SglPrimitiveStreamJS.call(this,t,e,0,i.length),this._buff=n?i?i.slice():null:i,Object.defineProperty(this,"type",{get:function(){return SGL_INDEXED_PRIMITIVE_STREAM}}),Object.defineProperty(this,"buffer",{get:function(){return this._buff}}),Object.defineProperty(this,"length",{get:function(){return this._buff.length}})}function SglConnectivityJS(){this._prims={}}function SglMeshJS(){this._valid=!1,this._vert=new SglVertexStreamJS,this._conn=new SglConnectivityJS}function sglMeshJSImportOBJFromString(t,e){var i,n,s=[],r=[],o=[],l=[],u=[],a=[],h=[],g={},f=0,c=null,_=0,d=0,m=0,p=0,v=0,S=0,M=null,E=!1,T=!1,R=!1,V=e.split("\n");for(n in V)if("#"!=(c=V[n].replace(/[ \t]+/g," ").replace(/\s\s*$/,""))[0])if("v"==(M=c.split(" "))[0])u.push(parseFloat(M[1])),u.push(parseFloat(M[2])),u.push(parseFloat(M[3]));else if("vt"==M[0])a.push(parseFloat(M[1])),a.push(parseFloat(M[2]));else if("vn"==M[0])h.push(parseFloat(M[1])),h.push(parseFloat(M[2])),h.push(parseFloat(M[3]));else if("f"==M[0]&&4==M.length)for(var b=1;b<4;++b){if(!(M[b]in g)){if(1==(i=M[b].split("/")).length)m=d=_=parseInt(i[0])-1;else{if(3!=i.length)return!1;_=parseInt(i[0])-1,d=parseInt(i[1])-1,m=parseInt(i[2])-1}S=v=p=0,3*_+2<u.length&&(E=!0,p=u[3*_+0],v=u[3*_+1],S=u[3*_+2]),s.push(p),s.push(v),s.push(S),v=p=0,2*d+1<a.length&&(T=!0,p=a[2*d+0],v=a[2*d+1]),r.push(p),r.push(v),v=p=0,S=1,3*m+2<h.length&&(R=!0,p=h[3*m+0],v=h[3*m+1],S=h[3*m+2]),o.push(p),o.push(v),o.push(S),g[M[b]]=f++}l.push(g[M[b]])}return E&&t.addVertexAttribute("position",3,s,!1),R&&t.addVertexAttribute("normal",3,o,!1),T&&t.addVertexAttribute("texcoord",2,r,!1),0<l.length&&t.addIndexedPrimitives("triangles",SGL_TRIANGLES_LIST,l,!1),!0}function sglMeshJSImportOBJFromURL(e,i,t,n){return e.isValid=!1,t?(sglLoadFile(i,function(t){e.isValid=sglMeshJSImportOBJFromString(e,t),n&&n(e,i)}),!0):(t=sglLoadFile(i),e.isValid=sglMeshJSImportOBJFromString(e,t),n&&n(e,i),e.isValid)}function _sglFindVertexAttributeJSON(t,e){for(var i in t.vertices)if(t.vertices[i].name===e)return t.vertices[i];return null}function _sglFindConnectivityJSON(t,e){for(var i in t.connectivity)if(t.connectivity[i].name===e)return t.connectivity[i];return null}function sglMeshJSImportJSONFromString(t,e){var i=JSON.parse(e);if(!i)return!1;var n,s,r=i.mapping,o=null;for(n in r)if("standard"===r[n].name){o=r[n];break}if(!o)return!1;for(s in o.attributes){var l=o.attributes[s],u=_sglFindVertexAttributeJSON(i,l.source);if(u){if(u.normalized)for(var a=0,h=u.values.length;a<h;++a)u.values[a]/=255;t.addVertexAttribute(l.semantic,u.size,u.values,!1)}}e=_sglFindConnectivityJSON(i,o.primitives);return!!e&&(t.addIndexedPrimitives(e.name,SGL_TRIANGLES_LIST,e.indices,!1),!0)}function sglMeshJSImportJSONFromURL(e,i,t,n){return e.isValid=!1,t?(sglLoadFile(i,function(t){e.isValid=sglMeshJSImportJSONFromString(e,t),n&&n(e,i)}),!0):(t=sglLoadFile(i),e.isValid=sglMeshJSImportJSONFromString(e,t),n&&n(e,i),e.isValid)}function sglGLTypeSize(t,e){return e==t.BYTE||e==t.UNSIGNED_BYTE?1:e==t.SHORT||e==t.UNSIGNED_SHORT?2:e==t.INT||e==t.UNSIGNED_INT||e==t.FLOAT?4:null}function sglGLTypeFromWebGLArray(t,e){return e instanceof Int8Array?t.BYTE:e instanceof Uint8Array?t.UNSIGNED_BYTE:e instanceof Int16Array?t.SHORT:e instanceof Uint16Array?t.UNSIGNED_SHORT:e instanceof Int32Array?t.INT:e instanceof Uint32Array?t.UNSIGNED_INT:e instanceof Float32Array?t.FLOAT:null}function SglAttributeStreamGL(t,e,i,n,s){var r=sglGLTypeFromWebGLArray(t,n),o=sglGLTypeSize(t,r)*i;this.gl=t,this._name=e,this._size=i,this._type=r,this._norm=!!s,this._stride=o,this._offset=0,this._length=n.length/i,this._buff=new SglVertexBuffer(t,n,{usage:t.STATIC_DRAW})}function SglVertexStreamGL(t){this.gl=t,this._attribs=new Object,this._length=0}function SglPrimitiveStreamGL(t,e,i,n,s){this.gl=t,this._name=e,this._mode=i,this._first=n||0,this._length=s||0}function SglArrayPrimitiveStreamGL(t,e,i,n,s){SglPrimitiveStreamGL.call(this,t,e,i,n,s),Object.defineProperty(this,"type",{get:function(){return SGL_ARRAY_PRIMITIVE_STREAM}})}function SglIndexedPrimitiveStreamGL(t,e,i,n){SglPrimitiveStreamGL.call(this,t,e,i,0,n.length);e=sglGLTypeFromWebGLArray(t,n),i=sglGLTypeSize(t,e);this._idxType=e,this._stride=i,this._buff=new SglIndexBuffer(t,n,{usage:t.STATIC_DRAW}),Object.defineProperty(this,"indexType",{get:function(){return this._idxType}}),Object.defineProperty(this,"stride",{get:function(){return this._stride}}),Object.defineProperty(this,"type",{get:function(){return SGL_INDEXED_PRIMITIVE_STREAM}})}function SglPackedIndexedPrimitiveStreamGL(t,e,i,n,s,r){s.length!=r.length&&sglInvalidParameter(),SglPrimitiveStreamGL.call(this,t,e,i,0,n.length);for(var e=sglGLTypeFromWebGLArray(t,n),i=sglGLTypeSize(t,e),o=(this._idxType=e,this._stride=i,this._buff=new SglIndexBuffer(t,n,{usage:t.STATIC_DRAW}),this._blockStartingVertices=r.slice(),this._blockStartingVertices.length),l=(this._blockStartingIndices=s.slice(),this._blockIndicesCount=new Array(o),this._blockStartingIndices[0]),u=0;u<o-1;++u){var a=this._blockStartingIndices[u+1];this._blockIndicesCount[u]=a-l,l=a}this._blockIndicesCount[o-1]=n.length-l,Object.defineProperty(this,"isPacked",{get:function(){return!0}}),Object.defineProperty(this,"indexType",{get:function(){return this._idxType}}),Object.defineProperty(this,"stride",{get:function(){return this._stride}}),Object.defineProperty(this,"type",{get:function(){return SGL_PACKED_INDEXED_PRIMITIVE_STREAM}}),Object.defineProperty(this,"blocksCount",{get:function(){return this._blockStartingIndices.length}}),Object.defineProperty(this,"blockStartingVertices",{get:function(){return this._blockStartingVertices}}),Object.defineProperty(this,"blockIndicesCount",{get:function(){return this._blockIndicesCount}})}function SglConnectivityGL(t){this.gl=t,this._prims=new Object}function SglMeshGL(t){this.gl=t,this._vert=new SglVertexStreamGL(this.gl),this._conn=new SglConnectivityGL(this.gl)}SglPrimitiveStreamJS.prototype={get type(){},get name(){return this._name},get mode(){return this._mode},get first(){return this._first},get length(){return this._length}},sglInherit(SglArrayPrimitiveStreamJS,SglPrimitiveStreamJS),sglInherit(SglIndexedPrimitiveStreamJS,SglPrimitiveStreamJS),SglConnectivityJS.prototype={get primitives(){return this._prims},addArrayPrimitives:function(t,e,i,n){e=new SglArrayPrimitiveStreamJS(t,e,i,n);this._prims[t]=e},addIndexedPrimitives:function(t,e,i,n){e=new SglIndexedPrimitiveStreamJS(t,e,i,n);this._prims[t]=e},removePrimitives:function(t){this._prims[t]&&delete this._prims[t]}},SglMeshJS.prototype={get isValid(){return this._valid},set isValid(t){this._valid=t},get vertices(){return this._vert},get connectivity(){return this._conn},addVertexAttribute:function(t,e,i,n){this._vert.addAttribute(t,e,i,n)},removeVertexAttribute:function(t){this._vert.removeAttribute(t)},addArrayPrimitives:function(t,e,i,n){this._conn.addArrayPrimitives(t,e,i,n)},addIndexedPrimitives:function(t,e,i,n){this._conn.addIndexedPrimitives(t,e,i,n)},removePrimitives:function(t){this._conn.removePrimitives(t)}},SglMeshJS.prototype.parseOBJ=function(t){return this.isValid=sglMeshJSImportOBJFromString(this,t),this.isValid},SglMeshJS.prototype.importOBJ=function(t,e,i){return sglMeshJSImportOBJFromURL(this,t,e,i)},SglMeshJS.prototype.parseJSON=function(t){return this.isValid=sglMeshJSImportJSONFromString(this,t),this.isValid},SglMeshJS.prototype.importJSON=function(t,e,i){return sglMeshJSImportJSONFromURL(this,t,e,i)},SglAttributeStreamGL.prototype={get name(){return this._name},get size(){return this._size},get type(){return this._type},get isNormalized(){return this._norm},get stride(){return this._stride},get offset(){return this._offset},get buffer(){return this._buff},get length(){return this._length},destroy:function(){this._buff.destroy()},bind:function(t,e){e=(e||0)*this._stride;this._buff.bind(),this.gl.vertexAttribPointer(t,this._size,this._type,this._norm,this._stride,this._offset+e)},unbind:function(t){this._buff.unbind()}},SglVertexStreamGL.prototype={get attributes(){return this._attribs},get length(){return this._length},destroy:function(){for(var t in this._attribs)this._attribs[t].destroy()},addAttribute:function(t,e,i,n){e=new SglAttributeStreamGL(this.gl,t,e,i,n);this._attribs[t]=e,this._length=e.length},removeAttribute:function(t,e){if(this._attribs[t])for(var i in e&&this._attribs[t].destroy(),delete this._attribs[t],this._length=0,this._attribs){this._length=this._attribs[i].length;break}},bind:function(t,e){var i,n=null;for(i in t)(n=this._attribs[i])&&n.bind(t[i],e)},unbind:function(t){var e,i=null;for(e in t)(i=this._attribs[e])&&i.unbind(t[e])}},SglPrimitiveStreamGL.prototype={_clampRange:function(t,e){var i,n=this._first+this._length,t=this._first+(0<=t?t:0);return n<=t?null:(n<(i=t+(e=0<=e?e:this._length))&&(e-=i-n),[t,e])},_render:function(t,e){},get type(){},get name(){return this._name},get mode(){return this._mode},get first(){return this._first},get length(){return this._length},destroy:function(){this._destroy&&this._destroy()},bind:function(){},unbind:function(){},render:function(t,e){t=this._clampRange(t,e);this._render(t[0],t[1])}},sglInherit(SglArrayPrimitiveStreamGL,SglPrimitiveStreamGL),SglArrayPrimitiveStreamGL.prototype._render=function(t,e){this.gl.drawArrays(this._mode,t,e)},sglInherit(SglIndexedPrimitiveStreamGL,SglPrimitiveStreamGL),SglIndexedPrimitiveStreamGL.prototype._destroy=function(){this._buff.destroy(),this._buff=null},SglIndexedPrimitiveStreamGL.prototype.bind=function(){this._buff.bind()},SglIndexedPrimitiveStreamGL.prototype.unbind=function(){this._buff.unbind()},SglIndexedPrimitiveStreamGL.prototype._render=function(t,e){this.gl.drawElements(this._mode,e,this._idxType,t*this._stride)},sglInherit(SglPackedIndexedPrimitiveStreamGL,SglPrimitiveStreamGL),SglPackedIndexedPrimitiveStreamGL.prototype._destroy=function(){this._buff.destroy(),this._buff=null},SglPackedIndexedPrimitiveStreamGL.prototype.bind=function(){this._buff.bind()},SglPackedIndexedPrimitiveStreamGL.prototype.unbind=function(){this._buff.unbind()},SglPackedIndexedPrimitiveStreamGL.prototype._clampBlockRange=function(t,e,i){var n=this._blockStartingIndices[t]+this._blockIndicesCount[t],e=this._blockStartingIndices[t]+(0<=e?e:0);return n<=e?null:(n<(t=e+(i=0<=i?i:this._blockIndicesCount[t]))&&(i-=t-n),[e,i])},SglPackedIndexedPrimitiveStreamGL.prototype.blockRanges=function(t,e){for(var i=this._clampRange(t,e),n=this._blockStartingIndices.length,s=0;s<n&&i[0]<this._blockStartingIndices[s];)s++;if(n<=s)return null;for(var r=i[0]+i[1]-1,o=s;o<n&&r>=this._blockStartingIndices[o]+this._blockIndicesCount[o];)o++;n<=o&&(o=n-1);var l=[],t=i[0]-this._blockStartingIndices[s],e=i[1];t+i[1]>this._blockIndicesCount[s]&&(e=this._blockIndicesCount[s]-this._blockStartingIndices[s]),l.push([s,t,e,this._blockStartingVertices[s]]);for(var u=s+1;u<o;++u)l.push([u,0,this._blockIndicesCount[u],this._blockStartingVertices[u]]);return s<o&&l.push([u,0,i[0]+i[1]-this._blockStartingIndices[o],this._blockStartingVertices[o]]),l},SglPackedIndexedPrimitiveStreamGL.prototype.renderBlock=function(t,e,i){t=this._clampBlockRange(t,e,i);this.gl.drawElements(this._mode,t[1],this._idxType,t[0]*this._stride)},SglConnectivityGL.prototype={get primitives(){return this._prims},destroy:function(){for(var t in this._prims)this._prims[t].destroy()},addArrayPrimitives:function(t,e,i,n){e=new SglArrayPrimitiveStreamGL(this.gl,t,e,i,n);this._prims[t]=e},addIndexedPrimitives:function(t,e,i){e=new SglIndexedPrimitiveStreamGL(this.gl,t,e,i);this._prims[t]=e},addPackedIndexedPrimitives:function(t,e,i,n,s){e=new SglPackedIndexedPrimitiveStreamGL(this.gl,t,e,i,n,s);this._prims[t]=e},removePrimitives:function(t,e){this._prims[t]&&(e&&this._prims[t].destroy(),delete this._prims[t])}},SglMeshGL.prototype={get vertices(){return this._vert},get connectivity(){return this._conn},destroy:function(){this._vert.destroy(),this._conn.destroy()},addVertexAttribute:function(t,e,i,n){this._vert.addAttribute(t,e,i,n)},removeVertexAttribute:function(t,e){this._vert.removeAttribute(t,e)},addArrayPrimitives:function(t,e,i,n){this._conn.addArrayPrimitives(t,e,i,n)},addIndexedPrimitives:function(t,e,i){this._conn.addIndexedPrimitives(t,e,i)},addPackedIndexedPrimitives:function(t,e,i,n,s){this._conn.addPackedIndexedPrimitives(t,e,i,n,s)},removePrimitives:function(t,e){this._conn.removePrimitives(t,e)}};var SGL_DefaultStreamMappingPrefix="a_";function SglMeshGLRenderer(t,e){this._prog=t,this._mapping=null,this._meshAttrMap=null,this._mesh=null,this._primStream=null,this._phase=0,this._updateEnabledVB=!1,e&&this.synchronizeProgram(),this.setStreamMapping()}function sglRenderMeshGLPrimitives(t,e,i,n,s,r,o,l){var u,a=new SglMeshGLRenderer(i);if(a.begin(),n&&a.setStreamMapping(n),s&&a.setUniforms(s),r&&a.setSamplers(r),e)a.renderMeshPrimitives(t,e,o,l);else for(u in t.connectivity.primitives)a.renderMeshPrimitives(t,u,o,l)}function sglMeshJSCalculateBBox(t,e){var t=t.vertices.attributes[e||"position"],i=t.size,n=t.buffer,s=new SglBox3;if(3==i){var r=n.length/i;if(!(r<=0)){r*=i;for(var o=0;o<i;++o)s.min[o]=n[o],s.max[o]=n[o];for(var l,u=i;u<r;u+=i)for(o=0;o<i;++o)l=n[u+o],s.min[o]>l&&(s.min[o]=l),s.max[o]<l&&(s.max[o]=l)}}return s}function sglGLPrimitiveType(t,e){switch(e){case SGL_POINTS_LIST:return t.POINTS;case SGL_LINES_LIST:return t.LINES;case SGL_LINE_STRIP:return t.LINE_STRIP;case SGL_LINE_LOOP:return t.LINE_LOOP;case SGL_TRIANGLES_LIST:return t.TRIANGLES;case SGL_TRIANGLE_STRIP:return t.TRIANGLE_STRIP;case SGL_TRIANGLE_FAN:return t.TRIANGLE_FAN;default:return}}function sglMeshJStoGL(t,e){var i=new SglMeshGL(t);for(a in e.vertices.attributes){var n=e.vertices.attributes[a];i.addVertexAttribute(n.name,n.size,new Float32Array(n.buffer))}for(p in e.connectivity.primitives){var s=e.connectivity.primitives[p],r=sglGLPrimitiveType(i.gl,s.mode);if(null!=r)switch(s.type){case SGL_ARRAY_PRIMITIVE_STREAM:i.addArrayPrimitives(s.name,r,s.first,s.length);break;case SGL_INDEXED_PRIMITIVE_STREAM:i.addIndexedPrimitives(s.name,r,new Uint16Array(s.buffer))}}return i}function sglPackMeshJStoGL(t,e,i,n){var i=i||"triangles",s=n||65e3,n=e.connectivity.primitives[i];if(!n)return null;if(n.type!=SGL_INDEXED_PRIMITIVE_STREAM)return null;var r=sglGLPrimitiveType(t,n.mode);if(null==r)return null;var o=0;if(r===t.TRIANGLES)o=3;else if(r===t.LINES)o=2;else{if(r!==t.POINTS)return null;o=1}var l=n.buffer,u=l.length,a=(u-=u%o,0),h=0,g=0,f=[],c=[],_=[],d={};for(D in e.vertices.attributes){var m=e.vertices.attributes[D];d[D]={name:m.name,size:m.size,buffer:[]}}for(;a<u;){for(var p={},v=[],S=0,p={},S=0,M=a;M<u;M+=o){for(var E={},T=0,R=0;R<o;++R)null==E[V=l[M+R]]&&(E[V]=!0,null==p[V])&&T++;if(!(S+T<=s))break;for(var V,R=0;R<o;++R)null==(w=p[V=l[M+R]])&&(w=p[V]=S,S++),v.push(w);a+=o}if(S<=0)break;var b=v.length;for(D in e.vertices.attributes){var y=e.vertices.attributes[D],P=d[D],x=y.size,A=P.buffer.length,L=new Array(S*x),I=(P.buffer=P.buffer.concat(L),y.buffer),U=P.buffer;for(M in p)for(var w=p[M],C=0;C<x;++C)U[A+(w*x+C)]=I[M*x+C]}_=_.concat(v),f.push(h),c.push(g),h+=S,g+=b}var D,F=new SglMeshGL(t);for(D in d){m=d[D];F.addVertexAttribute(m.name,m.size,new Float32Array(m.buffer))}return 1==f.length?F.addIndexedPrimitives(i,r,new Uint16Array(_)):F.addPackedIndexedPrimitives(i,r,new Uint16Array(_),c,f),F}SglMeshGLRenderer.prototype={_bindVertexBuffers:function(t){this._mesh.vertices.bind(this._meshAttrMap,t)},_unbindVertexBuffers:function(){this._mesh.vertices.unbind(this._meshAttrMap)},get program(){return this.prog},synchronizeProgram:function(){this._prog.synchronize();var t,e=!1,i=0,n=null;for(t in this._prog.attributes)(n=this._prog.attributes[t]).index!=i&&(n.index=i,e=!0),i++;e&&this._prog.link();var s,r=0;for(s in this._prog.samplers)this._prog.samplers[s].unit=r,r++},getStreamMappingFromPrefix:function(t){var e,i,n=t.length,s=new Object;for(i in this._prog.attributes)i.substr(0,n)==t&&0<(e=i.substr(n)).length&&(s[i]=e);return s},setStreamMapping:function(t){this._updateEnabledVB=!0;var e=null;for(i in this._mapping=this.getStreamMappingFromPrefix(SGL_DefaultStreamMappingPrefix),t)e=t[n],this._prog.attributes[i]&&(this._mapping[i]=e);this._meshAttrMap={};var i,n=null;for(i in this._mapping)e=this._mapping[i],n=this._prog.attributes[i],this._meshAttrMap[e]=n.index;this._mesh&&this._bindVertexBuffers(0)},setStreamMappingFromPrefix:function(t){t=this.getStreamMappingFromPrefix(t=t||SGL_DefaultStreamMappingPrefix);this.setStreamMapping(t)},setUniforms:function(t){0!=this._phase&&this._prog.setUniforms(t)},setSamplers:function(t){if(0!=this._phase){var e,i={},n={};for(r in t)"number"==typeof(e=t[r])?i[r]=e:n[r]=e;this._prog.setSamplers(i);var s,r;for(r in n)(s=this._prog.samplers[r])&&n[r].bind(s.unit)}},begin:function(){0==this._phase&&(this._prog.bind(),this._phase=1)},end:function(){if(1==this._phase){this._prog.unbind();var t,e=this._prog.gl;for(t in this._prog.attributes)e.disableVertexAttribArray(this._prog.attributes[t].index);this._phase=0}},beginMesh:function(t){1==this._phase&&(this._updateEnabledVB=!0,this._mesh=t,this._bindVertexBuffers(0),this._phase=2)},endMesh:function(){2==this._phase&&(this._unbindVertexBuffers(),this._prog.gl.bindBuffer(this._prog.gl.ARRAY_BUFFER,null),this._mesh=null,this._phase=1)},beginPrimitives:function(t){2==this._phase&&(this._primStream=this._mesh.connectivity.primitives[t],this._primStream.bind(),this._phase=3)},endPrimitives:function(){3==this._phase&&(this._primStream.unbind(),this._primStream=null,this._phase=2)},render:function(t,e){if(3==this._phase){var i,n=this._prog.gl;if(this._updateEnabledVB)for(var s in this._updateEnabledVB=!1,this._mapping)i=this._prog.attributes[s].index,this._mesh.vertices.attributes[this._mapping[s]]?n.enableVertexAttribArray(i):n.disableVertexAttribArray(i);if(this._primStream.isPacked){if(0<this._primStream.blocksCount)for(var r=this._primStream.blockRanges(t,e),o=r.length,l=0;l<o;++l)this._bindVertexBuffers(r[l][3]),this._primStream.renderBlock(r[l][0],r[l][1],r[l][2])}else this._primStream.render(t,e)}},renderMeshPrimitives:function(t,e,i,n){this.beginMesh(t),this.beginPrimitives(e),this.render(i,n),this.endPrimitives(),this.endMesh()}},SglMeshJS.prototype.calculateBoundingBox=function(t){return sglMeshJSCalculateBBox(this,t)},SglMeshJS.prototype.toMeshGL=function(t){return sglMeshJStoGL(t,this)},SglMeshJS.prototype.toPackedMeshGL=function(t,e,i){return sglPackMeshJStoGL(t,this,e,i)};var SGL_TRACKBALL_NO_ACTION=0,SGL_TRACKBALL_ROTATE=1,SGL_TRACKBALL_PAN=2,SGL_TRACKBALL_DOLLY=3,SGL_TRACKBALL_SCALE=4;function SglTrackball(){this._matrix=sglIdentityM4(),this._pts=[[0,0],[0,0]],this._action=SGL_TRACKBALL_NO_ACTION,this.reset()}function SglFirstPersonCamera(){this._position=sglZeroV3(),this._angles=sglZeroV3(),this.lookAt(0,0,0,0,0,-1,0)}function sglGetCanvasContext(t){var e=document.getElementById(t);if(!e)return null;for(var i=["webgl","experimental-webgl","moz-webgl","webkit-3d"],n=null,s=0;s<i.length;s++){try{n=e.getContext(i[s])}catch(t){n=null}if(n)break}return null==n?null:(null==n.FALSE&&(n.FALSE=0),null==n.TRUE&&(n.TRUE=1),n)}function SglCanvasUI(t,e,i,n){this._manager=t,this._handler=e,this._canvas=i,this._timerID=null,this._updRate=0,this._ignoreKeyRepeat=!0,this.gl=n,this.loadEvent=null,this.unloadEvent=null,this.keyDownEvent=null,this.keyUpEvent=null,this.keyPressEvent=null,this.mouseDownEvent=null,this.mouseUpEvent=null,this.mouseMoveEvent=null,this.mouseWheelEvent=null,this.clickEvent=null,this.dblClickEvent=null,this.resizeEvent=null,this.updateEvent=null,this.drawEvent=null,this.keysDown=new Object,this.mouseButtonsDown=new Object,this.mousePos={x:0,y:0},this.mousePrevPos={x:0,y:0},this.mouseDeltaPos={x:0,y:0},this.timeNow=Date.now()/1e3,this.timePrev=this.timeNow,this.timeDelta=0}function _SglCanvasManager(t,e,i){var n=document.getElementById(t);if(!n)throw new Error("SpiderGL : Canvas not found");n.contentEditable=!0;t=sglGetCanvasContext(t);if(!t)throw new Error("SpiderGL : Cannot get WebGL context");t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),t.bindFramebuffer(t.FRAMEBUFFER,null);var s=new SglCanvasUI(this,e,n,t),r=(this.ui=s,this);this.gl=t,this.canvas=n,this.handler=e,this.handler.ui=s,this._drawPending=!1,this.rendering=!0,this._drawFunc=function(){r.draw()},this.canvas.addEventListener("load",function(t){r.load(t)},!1),this.canvas.addEventListener("unload",function(t){r.unload(t)},!1),this.canvas.addEventListener("keydown",function(t){r.keyDown(t)},!1),this.canvas.addEventListener("keyup",function(t){r.keyUp(t)},!1),this.canvas.addEventListener("keypress",function(t){r.keyPress(t)},!1),this.canvas.addEventListener("mousedown",function(t){r.mouseDown(t)},!1),this.canvas.addEventListener("mouseup",function(t){r.mouseUp(t)},!1),this.canvas.addEventListener("mousemove",function(t){r.mouseMove(t)},!1),this.canvas.addEventListener("click",function(t){r.click(t)},!1),this.canvas.addEventListener("dblclick",function(t){r.dblClick(t)},!1),this.canvas.addEventListener("resize",function(t){r.resize(t)},!1),this.canvas.addEventListener("mousewheel",function(t){r.mouseWheel(t)},!1),this.canvas.addEventListener("DOMMouseScroll",function(t){r.mouseWheel(t)},!1),this.canvas.addEventListener("blur",function(t){r.blur(t)},!1),this.canvas.addEventListener("mouseout",function(t){r.mouseOut(t)},!1),this.canvas.addEventListener("mouseover",function(t){r.mouseOver(t)},!1),this.canvas.addEventListener("touchstart",function(t){r.touchStart(t)},!1),this.canvas.addEventListener("touchend",function(t){r.touchEnd(t)},!1),this.canvas.addEventListener("touchmove",function(t){r.touchMove(t)},!1),this.load(),i&&(this.ui.updateRate=i)}SglTrackball.prototype={_projectOnSphere:function(e,i){e=sglSqrt(e*e+i*i);return e<.7071067811865476?sglSqrt(1-e*e):(t=.7071067811865475)*t/e},_transform:function(t,e,i,n){return sglMulM4V4(t,sglV4C(e,i,n,0))},_transformOnSphere:function(t,e,i){var n=this._projectOnSphere(e,i);return this._transform(t,e,i,n)},_translate:function(t,e){e=sglTranslationM4V(sglMulSV4(e,sglMulM4V4(sglInverseM4(this._matrix),sglV3toV4(t,0))));this._matrix=sglMulM4(this._matrix,e)},get action(){return this._action},set action(t){this._action=t},get matrix(){return this._matrix},reset:function(){this._matrix=sglIdentityM4(),this._pts=[[0,0],[0,0]],this._action=SGL_TRACKBALL_NO_ACTION},track:function(t,e,i,n){switch(this._pts[0][0]=this._pts[1][0],this._pts[0][1]=this._pts[1][1],this._pts[1][0]=e,this._pts[1][1]=i,this._action){case SGL_TRACKBALL_ROTATE:this.rotate(t);break;case SGL_TRACKBALL_PAN:this.pan(t);break;case SGL_TRACKBALL_DOLLY:this.dolly(t,n);break;case SGL_TRACKBALL_SCALE:this.scale(t,n)}},rotate:function(t){this._pts[0][0]==this._pts[1][0]&&this._pts[0][1]==this._pts[1][1]||(t=sglInverseM4(t),t=sglRotationAngleAxisM4V(sglLengthV3(t=sglCrossV3(this._transformOnSphere(t,this._pts[0][0],this._pts[0][1]),this._transformOnSphere(t,this._pts[1][0],this._pts[1][1]))),t),this._matrix=sglMulM4(t,this._matrix))},pan:function(t){var t=sglInverseM4(t),e=this._transform(t,this._pts[0][0],this._pts[0][1],-1),t=sglSubV3(this._transform(t,this._pts[1][0],this._pts[1][1],-1),e);this._translate(t,2)},dolly:function(t,e){t=sglInverseM4(t),t=this._transform(t,0,0,e);this._translate(t,1)},scale:function(t,e){e=sglScalingM4C(e,e,e);this._matrix=sglMulM4(this._matrix,e)}},SglFirstPersonCamera.prototype={clone:function(){var t=new SglFirstPersonCamera;return t._position=this._position.slice(),t._angles=this._angles.slice(),t},get copy(){return this.clone()},lookAt:function(t,e,i,n,s,r,o){this._position=sglV3C(t,e,i);t=sglSubV3([n,s,r],this._position);return this._angles[0]=sglAtan2(t[1],-t[2]),this._angles[1]=sglAtan2(-t[0],-t[2]),this._angles[2]=o||0,this},translate:function(t,e,i){var n=sglRotationAngleAxisM4C(this._angles[0],1,0,0),s=sglRotationAngleAxisM4C(this._angles[1],0,1,0),s=sglMulM4V4(sglMulM4(sglRotationAngleAxisM4C(this._angles[2],0,0,1),sglMulM4(s,n)),[t,e,i,0]);return this._position[0]+=s[0],this._position[1]+=s[1],this._position[2]+=s[2],this},translateOnPlane:function(t,e,i){t=sglMulM4V4(sglRotationAngleAxisM4C(this._angles[1],0,1,0),[t,e,i,0]);return this._position[0]+=t[0],this._position[1]+=t[1],this._position[2]+=t[2],this},rotate:function(t,e,i){return this._angles[0]+=t,this._angles[1]+=e,this._angles[2]+=i,this},get matrix(){var t=sglRotationAngleAxisM4C(-this._angles[0],1,0,0),e=sglRotationAngleAxisM4C(-this._angles[1],0,1,0);return sglMulM4(sglRotationAngleAxisM4C(-this._angles[2],0,0,1),sglMulM4(t,sglMulM4(e,sglTranslationM4V(sglNegV3(this._position)))))}},SglCanvasUI.prototype={get canvas(){return this._canvas},get width(){return this._canvas.width},get height(){return this._canvas.height},get ignoreKeyRepeat(){return this._ignoreKeyRepeat},set ignoreKeyRepeat(t){this._ignoreKeyRepeat=t},get updateRate(){return this._updRate<=0?0:this._updRate},set updateRate(t){var e;1e3<(t=t<0?0:t)&&(t=1e3),this._updRate!=t&&(this._updRate=t,null!=this._timerID&&(clearInterval(this._timerID),this._timerID=null),0<this._updRate)&&((t=1e3/this._updRate)<1&&(t=1),e=this._manager,this.timeNow=Date.now()/1e3,this.timePrev=this.timeNow,this.timeDelta=0,this._timerID=setInterval(function(){e.update()},t))},get requestDraw(){var t=this;return function(){t._manager.requestDraw()}}},_SglCanvasManager.prototype={_getMouseClientPos:function(t){var e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}},requestDraw:function(){!this.rendering||this._drawPending||(this._drawPending=!0,setTimeout(this._drawFunc,0))},blur:function(t){var e,i,n=!1;for(e in this.ui.mouseButtonsDown)this.ui.mouseButtonsDown[e]&&(this.ui.mouseButtonsDown[e]=!1,this.handler.mouseUp)&&0!=this.handler.mouseUp(this.gl,e,this.ui.mousePos.x,this.ui.mousePos.y)&&(n=!0);for(i in this.ui.keysDown)this.ui.keysDown[i]&&(this.ui.keysDown[i]=!1,this.handler.keyUp)&&0!=this.handler.keyUp(this.gl,0,i)&&(n=!0);n&&this.requestDraw()},mouseOut:function(t){var e,i=!1;for(e in this.ui.mouseButtonsDown)this.ui.mouseButtonsDown[e]&&(this.ui.mouseButtonsDown[e]=!1,this.handler.mouseOut)&&0!=this.handler.mouseOut(this.gl,this.ui.mousePos.x,this.ui.mousePos.y)&&(i=!0);i&&this.requestDraw()},mouseOver:function(t){},load:function(){this.ui.loadEvent=null,this.handler.load&&this.handler.load(this.gl),this.requestDraw()},unload:function(){this.ui.unloadEvent=null,this.ui.updateRate=0,this.handler.unload&&this.handler.unload(this.gl),this.handler.ui=null,this.handler=null,this.ui=null},keyDown:function(t){this.ui.keyDownEvent=t;var e=String.fromCharCode(t.keyCode);this.ui.keysDown[e.toLowerCase()]=!0,this.ui.keysDown[e.toUpperCase()]=!0,this.ui.keysDown[t.keyCode]&&this.ui.ignoreKeyRepeat||(this.ui.keysDown[t.keyCode]=!0,this.handler.keyDown&&0!=this.handler.keyDown(this.gl,t.keyCode,e)&&this.requestDraw())},keyUp:function(t){this.ui.keyUpEvent=t;var e=String.fromCharCode(t.keyCode);this.ui.keysDown[e.toLowerCase()]=!1,this.ui.keysDown[e.toUpperCase()]=!1,this.ui.keysDown[t.keyCode]=!1,this.handler.keyUp&&0!=this.handler.keyUp(this.gl,t.keyCode,e)&&this.requestDraw()},keyPress:function(t){this.ui.keyPressEvent=t;var e=String.fromCharCode(t.charCode);this.handler.keyPress&&0!=this.handler.keyPress(this.gl,t.charCode,e)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},mouseDown:function(t){this.ui.mouseDownEvent=t;var e=this._getMouseClientPos(t),i=e.x,e=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=i,this.ui.mousePrevPos.y=e,this.ui.mousePos.x=i,this.ui.mousePos.y=e,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.ui.mouseButtonsDown[t.button]=!0,this.handler.mouseDown&&0!=this.handler.mouseDown(this.gl,t.button,i,e)&&this.requestDraw(),this.canvas.focus(),t.preventDefault&&t.preventDefault()},mouseUp:function(t){this.ui.mouseUpEvent=t;var e=this._getMouseClientPos(t),i=e.x,e=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=i,this.ui.mousePrevPos.y=e,this.ui.mousePos.x=i,this.ui.mousePos.y=e,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.ui.mouseButtonsDown[t.button]=!1,this.handler.mouseUp&&0!=this.handler.mouseUp(this.gl,t.button,i,e)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},mouseMove:function(t){this.ui.mouseMoveEvent=t;var e=this._getMouseClientPos(t),i=e.x,e=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=this.ui.mousePos.x,this.ui.mousePrevPos.y=this.ui.mousePos.y,this.ui.mousePos.x=i,this.ui.mousePos.y=e,this.ui.mouseDeltaPos.x=this.ui.mousePos.x-this.ui.mousePrevPos.x,this.ui.mouseDeltaPos.y=this.ui.mousePos.y-this.ui.mousePrevPos.y,this.handler.mouseMove&&0!=this.handler.mouseMove(this.gl,i,e)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},mouseWheel:function(t){this.ui.mouseWheelEvent=t;var e,i=this._getMouseClientPos(t),n=i.x,i=this.canvas.height-1-i.y;this.ui.mousePrevPos.x=n,this.ui.mousePrevPos.y=i,this.ui.mousePos.x=n,this.ui.mousePos.y=i,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.handler.mouseWheel&&(e=0,(t=t||window.event).wheelDelta?(e=t.wheelDelta/120,window.opera&&(e=-e)):t.detail&&(e=-t.detail/3),e)&&0!=this.handler.mouseWheel(this.gl,e,n,i)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},touchStart:function(t){this.ui.mouseDownEvent=t.touches[0];var e=this._getMouseClientPos(t.touches[0]),i=e.x,e=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=i,this.ui.mousePrevPos.y=e,this.ui.mousePos.x=i,this.ui.mousePos.y=e,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.ui.mouseButtonsDown[0]=!0,this.handler.mouseDown&&0!=this.handler.mouseDown(this.gl,0,i,e)&&this.requestDraw(),this.canvas.focus(),t.preventDefault&&t.preventDefault()},touchEnd:function(t){this.ui.mouseUpEvent=t.changedTouches[0];var e=this._getMouseClientPos(t.changedTouches[0]),i=e.x,e=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=i,this.ui.mousePrevPos.y=e,this.ui.mousePos.x=i,this.ui.mousePos.y=e,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.ui.mouseButtonsDown[0]=!1,this.handler.mouseUp&&0!=this.handler.mouseUp(this.gl,0,i,e)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},touchMove:function(t){this.ui.mouseMoveEvent=t.changedTouches[0];var e=this._getMouseClientPos(t.changedTouches[0]),i=e.x,e=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=this.ui.mousePos.x,this.ui.mousePrevPos.y=this.ui.mousePos.y,this.ui.mousePos.x=i,this.ui.mousePos.y=e,this.ui.mouseDeltaPos.x=this.ui.mousePos.x-this.ui.mousePrevPos.x,this.ui.mouseDeltaPos.y=this.ui.mousePos.y-this.ui.mousePrevPos.y,this.handler.mouseMove&&0!=this.handler.mouseMove(this.gl,i,e)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},click:function(t){this.ui.clickEvent=t;var e=this._getMouseClientPos(t),i=e.x,e=this.canvas.height-1-e.y;this.handler.click&&0!=this.handler.click(this.gl,t.button,i,e)&&this.requestDraw()},dblClick:function(t){this.ui.dblClickEvent=t;var e=this._getMouseClientPos(t),i=e.x,e=this.canvas.height-1-e.y;this.handler.dblClick&&0!=this.handler.dblClick(this.gl,t.button,i,e)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},resize:function(t){this.ui.resizeEvent=t,this.handler.resize&&0!=this.handler.resize(this.gl,this.canvas.width,this.canvas.height)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},update:function(){this.ui.updateEvent=null;var t=Date.now()/1e3,t=(this.ui.timePrev=this.ui.timeNow,this.ui.timeNow=t,this.ui.timeDelta=this.ui.timeNow-this.ui.timePrev,!0);(t=this.handler.update?0!=this.handler.update(this.gl,this.ui.timeDelta):t)&&this.requestDraw()},draw:function(){this.ui.drawEvent=null,this.handler.draw&&this.handler.draw(this.gl),this.gl.flush(),this._drawPending=!1}};var _SGL_RegisteredCanvas=new Object;function _sglManageCanvas(t,e,i){e=new _SglCanvasManager(t,e,i);_SGL_RegisteredCanvas[t]=e}function _sglUnmanageCanvas(t){_SGL_RegisteredCanvas[t]&&(_SGL_RegisteredCanvas[t]=null,delete _SGL_RegisteredCanvas[t])}function _sglManageCanvasOnLoad(t,e,i){window.addEventListener("load",function(){_sglManageCanvas(t,e,i)},!1)}function _sglUnmanageCanvasOnLoad(t){window.addEventListener("unload",function(){_sglUnmanageCanvas(t)},!1)}function sglRegisterCanvas(t,e,i){_sglManageCanvasOnLoad(t,e,i),_sglUnmanageCanvasOnLoad(t)}function sglRegisterLoadedCanvas(t,e,i){_sglManageCanvas(t,e,i),_sglUnmanageCanvasOnLoad(t)}
function createRtiViewer(t,e,i,s){var r=s,n=i,o=!1,a=$($("#"+t)[0]),l=document.createElement("div"),a=(l.id=t+"_div",l.style.height=s+"px",l.style.width=i+"px",l.style.margin="auto",l.style.position="relative",a.append(l),$($("#"+t+"_div")[0])),l=t+"_webgl",h=document.createElement("canvas"),i=(h.id=l,h.width=i,h.height=s,a.append(h),document.createElement("a")),s=(i.href="http://vcg.isti.cnr.it/rti/webviewer.php",i.target="_blank",document.createElement("div")),h=(s.style.width="80px",s.style.height="50px",i.appendChild(s),i.style.position="absolute",i.style.bottom="0px",i.style.left="0px",i.style.cssFloat="left",a.append(i),document.createElement("div")),s=(h.setAttribute("class","toolbar"),h.style.position="absolute",h.style.top="10px",h.style.left="10px",h.style.cssFloat="left",h.style.width="40px",h.style.height="200px",h.style.visibility="hidden",h.innerHTML='<button class = "toolbarButton" id = "zoomIn"></button><button class = "toolbarButton" id = "zoomOut"></button><button class = "toolbarButton" id = "light"></button><button class = "toolbarButton" id = "fullscreen"></button><button class = "toolbarButton" id = "help"></button>',a.append(h),document.createElement("div"));function d(){var e=document.getElementById(t+"_div"),e=(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),e.style.height=r+"px",e.style.width=n+"px",$("#"+t+"_webgl"));e.height(r),e.width(n),e.attr("width",n),e.attr("height",r),u.resize(),o=!1;$("#"+t+"_div #fullscreen").button("option",{label:"Active Fullscreen",icons:{primary:"fullIcon toolbarIcon"}})}s.id=t+"_guide",s.style.width="100%",s.style.height="100%",s.style.position="absolute",s.style.left="0px",s.style.top="0px",s.style.color="#FFFFFF",s.style.backgroundColor="rgba(0, 0, 0, 0.9)",s.innerHTML='<div id = "guideTable"><div id = "guideCell"> <div id = "guideList"><h3>WebRTIViewer<br/></h3><ul><li>Pan: LeftMouseButton + MouseMove.</li><li>Zoom in: MouseWhell or press the button <span><img src = "/assets/webViewer/css/icons/zoomin.png" alt=""/></span></li><li>Zoom out: MouseWheel or press the button <span><img src = "/assets/webViewer/css/icons/zoomout.png" alt=""/></span></li><li>To change the light direction: activate the light with the button <span><img src = "/assets/webViewer/css/icons/light.png" alt=""/></span> and press LeftMouseButton + MouseMove or Ctrl + LeftMouseButton + MouseMove.</li><li>Fullscreen: press the button <span><img src = "/assets/webViewer/css/icons/full.png" alt=""/></span> to active the fullscreen mode and the button <span><img src = "/assets/webViewer/css/icons/full_on.png" alt=""/></span> to exit</li><li>To reset the viewpoint: press R.</li></ul><a href="http://vcg.isti.cnr.it/rti/webviewer.php" target = "_black">Visual Computing Lab ISTI CNR Pisa</a></div></div></div>',s.style.display="none",a.append(s),$("#"+t+"_div #zoomIn").button({icons:{primary:"zoomInIcon toolbarIcon"},text:!1,label:"Zoom In"}).click(function(){u.startZoomIn()}),$("#"+t+"_div #zoomOut").button({icons:{primary:"zoomOutIcon toolbarIcon"},text:!1,label:"Zoom Out"}).click(function(){u.startZoomOut()}),$("#"+t+"_div #light").button({icons:{primary:"lightIcon toolbarIcon"},text:!1,label:"Light Off"}).click(function(){var e;"Light Off"==$.trim($(this).text())?(e={label:"Light On",icons:{primary:"lightOnIcon toolbarIcon"}},u.setMode(1)):(e={label:"Light Off",icons:{primary:"lightIcon toolbarIcon"}},u.setMode(0)),$(this).button("option",e)}),$("#"+t+"_div #help").button({icons:{primary:"helpIcon toolbarIcon"},text:!1,label:"Help"}).click(function(){$("#"+t+"_guide").show()}),$("#"+t+"_div #fullscreen").button({icons:{primary:"fullIcon toolbarIcon"},text:!1,label:"Active Fullscreen"}).click(function(){var e;o?d():((e=document.getElementById(t+"_div")).requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen(),e.style.height=screen.height+"px",e.style.width=screen.width+"px",(e=$("#"+t+"_webgl")).height(screen.height),e.width(screen.width),e.attr("width",screen.width),e.attr("height",screen.height),u.resize(),o=!0,$("#"+t+"_div #fullscreen").button("option",{label:"Exit Fullscreen",icons:{primary:"fullOnIcon toolbarIcon"}})),$("#"+t+"_div #fullscreen").removeClass("ui-state-hover")}),document.addEventListener("MSFullscreenChange",function(){document.msFullscreenElement||d()},!1),document.addEventListener("mozfullscreenchange",function(){document.mozFullScreen||d()},!1),document.addEventListener("webkitfullscreenchange",function(){document.webkitIsFullScreen||d()},!1),$("#"+t+"_guide").click(function(){$("#"+t+"_guide").hide()});var u,i=document.createElement("div");i.id=t+"_error",i.style.width="100%",i.style.height="100%",i.style.position="absolute",i.style.left="0px",i.style.top="0px",i.style.color="#FFFFFF",i.style.backgroundColor="rgba(0, 0, 0, 1.0)",i.innerHTML='<canvas id = "testCanvas" width= "800" height= "600" contenteditable="true"></canvas>',i.style.display="none",a.append(i),null==sglGetCanvasContext("testCanvas")?(i.style.display="block",i.innerHTML='<div id = "contentError" style = "width: 90%; height: 100%; text-align:left; padding:0% 5% 0% 5%; font-family:  Verdana,sans-serif; overflow-y: scroll;"><h3>WebGL is not available or not enabled.</h3><p><a href="http://en.wikipedia.org/wiki/WebGL">WebGL</a> is the technology we use to display the RTI images. It is currently supported, but sometimes not enabled by default, by recent versions of <a href="http://www.mozilla.org/firefox">Firefox</a>, <a href="http://www.google.com/chrome">Chrome</a> and <a href="http://www.apple.com/safari">Safari</a>. An external plugins is available for <a href="http://microsoft.com/ie">Internet  Explorer</a>.<br/> It also requires a moderately recent and capable hardware and up to date drivers.</p><p><b>Chrome</b><br/>Type "chrome://flags" in the address bar.<br/>Disable (yes, it is a confusing double negation!) the WebGL entry.<br/>Click the <em>relaunch now</em> button at the bottom.</p><p><b>Firefox</b><br/>Type "about:config" in the address bar<br/>Type "webgl" in the <em>Filter</em>.<br/>Doubleclick the entry <b>webgl.force-enable</b>, and restart Firefox.</p><p><b>Safari</b><br/>Open the Safari menu and select Preferences.<br/>Then, click the Advanced tab in the Preferences window.<br/>Then, at the bottom of the window, check the Show Develop menu in menu bar checkbox.<br/>Then, open the Develop menu in the menu bar and select Enable WebGL.</p><p><b>Internet Explorer (from version 9.0)</b><br/>Install the <a href="http://www.google.com/chromeframe">Chrome Frame</a> <br/>Open the Tools menu and select Manage add-ons.<br/>Then, enable the ChromeFrame BHO plugins and restart Internet Explorer.<br/></p><p><b>Installing updated drivers</b><br/>If the visualization of the RTI image fails you must update the drivers of your graphics cards.</p></div>'):(i.innerHTML="",u=new MultiRes(l),"string"===$.type(e)?u.setImageUrl(e):u.setImageFunction(e),u.setOnLoadImageCallback(function(e){"IMAGE"==e&&$("#"+t+"_div #light").css("display","none"),$(".toolbar").css("visibility","visible")}),sglRegisterCanvas(l,u,10))}function log(e){}function MultiRes(e){this.mode=0,this.stepAnimation=0,this.idTimer,this.flipAngles=[],this.flipAngles[0]=0,this.canvas=e,this.rendering=!1,this.onDrawCallback=null,this.animating=!1,this.moveToCenter=!1,this.imageUrl="",this.imageFunction=null,this.OnLoadImageCallback=null,this.currentSpeed=0,this.maxStep=7,this.animationStack=[],this.isMoving=!1;for(var t=1;t<21;t++)this.flipAngles[t]=SGL_PI/2*Math.sin(t/40*SGL_PI)}function MultiResNode(){this.id=0,this.parentIndex=-1,this.childrenIndices=[-1,-1,-1,-1],this.projectedSize=1,this.zScale=1,this.box=new SglBox3,this.priority={timestamp:-1,error:Number.MAX_VALUE},this.req=null,this.data=null,this.isLeaf=!0}function MultiResTree(e,t){this.ready=!0,this.nodesCount=0,this.rootIndex=-1,this.nodes=null,this.url=null,this.tileSize=0,this.scale=[1,1,1],this.offset=[0,0,0],this.forma="",e&&this.load(e,imgW,imgH,t)}function _MultiResAssert(e){e||alert("MultiResAssert FAILED : "+e)}function _MultiResCompareNodes(e,t){return e.priority.timestamp!=t.priority.timestamp?t.priority.timestamp-e.priority.timestamp:e.priority.error!=t.priority.error?t.priority.error-e.priority.error:e.id-t.id}function MultiResRenderer(e,t,i){this.lg=!0,this.gl=e,this._tree=new MultiResTree,this._timestamp=0,this._frustum=new SglFrustum,this._maxError=1,this._cache=[],this._cacheSizeInBytes=t,this._maxCacheSize=1,this._maxOngoingRequests=2,this._currentOngoingRequests=0,this._toRequest=[],this._toRenderFullRes=[],this._toRenderHalfRes=[],this._readyItems=[],this.renderData=!0,this.renderBoxes=!1;var t=new Float32Array([-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5]),s=new Uint16Array([0,1,2,2,1,3,5,4,7,7,4,6,4,0,6,6,0,2,1,5,3,3,5,7,2,3,6,6,3,7,4,5,0,0,5,1]),r=new Uint16Array([0,1,1,3,3,2,2,0,5,4,4,6,6,7,7,5,0,4,1,5,3,7,2,6]),n=new SglMeshGL(e),t=(n.addVertexAttribute("position",3,t),n.addIndexedPrimitives("triangles",e.TRIANGLES,s),n.addIndexedPrimitives("edges",e.LINES,r),this._boxMesh=n,this._tileFullMesh=null,this._tileHalfMesh=null,this._program=null,sglLoadFile("/assets/webViewer/spidergl/box.v.glsl")),s=sglLoadFile("/assets/webViewer/spidergl/box.f.glsl"),r=new SglProgram(e,[t],[s]),n=(log(r.log),this._boxProgram=r,this._boxRenderer=new SglMeshGLRenderer(this._boxProgram),this._treeTransform=sglIdentityM4(),this._normalizedTreeTransform=sglIdentityM4(),this.updateData=!0,this.texProg=new SglProgram(this.gl,["#ifdef GL_ES\nprecision highp float;\n#endif\nuniform   mat4 u_mvp;\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\nvarying   vec2 v_texcoord;\nvoid main(void){\nv_texcoord  = a_texcoord;\ngl_Position = u_mvp * vec4(a_position, 0.0, 1.0);\n}"],["#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D s_texture;\nvarying vec2     v_texcoord;\nvoid main(void){vec4 color = texture2D(s_texture, v_texcoord).xyzw;\nif (color.w > 0.7)\ngl_FragData[0] = vec4(color.rgb, 1.0);\nelse\ngl_FragData[0] = vec4(0.0);}"]),log(this.texProg.log),new Float32Array([0,0,80,0,0,50,80,50])),e=new Float32Array([0,0,1,0,0,1,1,1]);this.lg&&((t=new SglMeshGL(this.gl)).addVertexAttribute("position",2,n),t.addVertexAttribute("texcoord",2,e),t.addArrayPrimitives("tristrip",this.gl.TRIANGLE_STRIP,0,4),this.lgMesh=t,this.lgtex=null,this._createLg()),this.enumType=new Object,this.enumType.HSH_RTI=1,this.enumType.LRGB_PTM=2,this.enumType.RGB_PTM=3,this.enumType.IMAGE=4}MultiRes.prototype={setMode:function(e){this.mode=e},_setLightDir:function(e,t){var e=e/this.ui.width*2.2-1.1,t=t/this.ui.height*2.2-1.1,e=Math.min(1,Math.max(-1,e)),t=Math.min(1,Math.max(-1,t)),i=Math.sqrt(e*e+t*t),s=(1<i&&(i=1),Math.PI/2),s=(0!=e&&(s=Math.atan2(t,e)),e=i*Math.cos(s),t=i*Math.sin(s),[]),s=i<1?[e,t,Math.sqrt(1-e*e-t*t)]:[e,t,0];s=sglNormalizedV3(s),this.renderer.lightPos=s.slice(0,3),this.renderer.lweights=this.renderer.computeLightingFunction(s)},resetViewpoint:function(){this.translation[0]=0,this.translation[1]=0,this.mat=sglIdentityM4(),this.flipMatrix=sglIdentityM4()},setImageUrl:function(e){this.imageUrl=e},setImageFunction:function(e){this.imageFunction=e},setOnLoadImageCallback:function(e){this.OnLoadImageCallback=e},load:function(e){log("SpiderGL Version : "+SGL_VERSION_STRING+"\n"),this.xform=new SglTransformStack,this.renderer=new MultiResRenderer(e,268435456),this.translation=[0,0],this.mat=sglIdentityM4(),this.flipMatrix=sglIdentityM4(),""!=this.imageUrl?this.loadImage(this.imageUrl):null!==this.imageFunction&&this.loadImage(this.imageFunction)},loadImage:function(e){this.renderer.loadImage(e),this.OnLoadImageCallback(this.renderer.type),this.xform=new SglTransformStack,this.translation=[0,0],this.mat=sglIdentityM4(),this.rendering=!0,this.leftBottom=[(this.renderer._tree.scale[0]-this.renderer.imgWidth)/2,(this.renderer._tree.scale[1]-this.renderer.imgHeight)/2],this.rightTop=[this.leftBottom[0]+this.renderer.imgWidth,this.leftBottom[1]+this.renderer.imgHeight],this.scale=0;var e=this.ui.width,t=this.ui.height,i=this.renderer._tree.scale[0]/this.renderer.imgWidth*e,s=this.renderer._tree.scale[1]/this.renderer.imgHeight*t;this.scale=Math.min(i,s),this.maxScale=2.5*Math.max(this.renderer.imgWidth/e,this.renderer.imgHeight/t),this.viewerdx=100,this.viewerdy=100},stopRendering:function(){this.rendering=!1},setOnDrawCallback:function(e){e&&(this.onDrawCallback=e)},keyDown:function(e,t,i){"R"==i&&this.resetViewpoint(),"1"==i&&(this.renderer.renderData=!this.renderer.renderData),"2"==i&&(this.renderer.renderBoxes=!this.renderer.renderBoxes)},mouseWheel:function(e,t,i,s){if(this.isMoving)return!1;i-=this.translation[0],s-=this.translation[1],t=sglPow(.98,10*t);this._startZoom(t,i,s)},startZoomIn:function(){if(this.isMoving)return!1;var e=this.ui.width/2-this.translation[0],t=this.ui.height/2-this.translation[1];this._startZoom(1.2,e,t)},startZoomOut:function(){if(this.isMoving)return!1;var e=this.ui.width/2-this.translation[0],t=this.ui.height/2-this.translation[1];this._startZoom(.8,e,t)},_startZoom:function(e,t,i){var s=this.mat[0]*e,s=(s>this.maxScale&&(e=this.maxScale/this.mat[0]),s<1&&(e=1/this.mat[0]),s<=1.00000001&&(this.moveToCenter=!0),e*this.mat[0]-this.mat[0]);if(1e-4<s||s<-1e-4){this.animationStack=[];for(var r=2*this.maxStep,n=3*s/(r*r*r),o=-2*r*n,a=n*r*r,l=this.mat[0],h=0;h<r;h++){var d=n*h+n/3+o/2+a,u=(a+=n*(2*h+1)+o,1+d/l);l+=d,this.animationStack.push([u,t,i])}this.animating=this.moveToCenter;var m=this;clearInterval(this.moveInterval),clearInterval(this.zoomInterval),this.zoomInterval=setInterval(function(){m._zoomAnimation()},35),this.renderer.updateData=!1,this.isMoving=this.moveToCenter}else this.moveToCenter&&(this.animating=!0,this.isMoving=!0,(m=this).animationStack=[],clearInterval(this.moveInterval),clearInterval(this.zoomInterval),this.zoomInterval=setInterval(function(){m._zoomAnimation()},35),this.renderer.updateData=!1);return!1},_zoomAnimation:function(){var e;if(0==this.animationStack.length)clearInterval(this.zoomInterval),this.moveToCenter?(e=this,clearInterval(this.moveInterval),this.moveInterval=setInterval(function(){e._moveAnimation()},35),this.renderer.updateData=!1,this.isMoving=!0,this.computeModelMatrix(),t=this.xform.model.top,o=[this.renderer._tree.scale[0]/2,this.renderer._tree.scale[1]/2],i=[this.ui.width/2,this.ui.height/2],t=sglMulM4V4(t,sglV4C(o[0],o[1],0,1)).slice(0,2),o=i[0]-t[0],a=i[1]-t[1],this.currentSpeed=0,this.currentPoint=t,this._updateMoveStack(t,i,sglV2C(o,a))):this.renderer.updateData=!0,this.animating=!1;else{var t=this.animationStack.splice(0,1)[0],i=t[0],t=(tx=t[1],ty=t[2],sglMulM4(sglTranslationM4C(tx,ty,0),sglMulM4(sglScalingM4C(i,i,1),sglMulM4(sglTranslationM4C(-tx,-ty,0),this.mat)))),t=this.returnModelMatrix(this.translation,t),s=sglMulM4V4(t,sglV4C(this.leftBottom[0],this.leftBottom[1],0,1)).slice(0,2),t=sglMulM4V4(t,sglV4C(this.rightTop[0],this.rightTop[1],0,1)).slice(0,2),r=(s[0]-=this.viewerdx,s[1]-=this.viewerdy,t[0]+=this.viewerdx,t[1]+=this.viewerdy,t[0]-s[0]),n=t[1]-s[1],o=0,a=0;if(r>this.ui.width&&n>this.ui.height)t[0]<this.ui.width?o+=this.ui.width-t[0]:0<s[0]&&(o-=s[0]),t[1]<this.ui.height?a+=this.ui.height-t[1]:0<s[1]&&(a-=s[1]);else if(r>this.ui.width)ty=this.ui.height/2-this.translation[1],t[0]<this.ui.width?o+=this.ui.width-t[0]:0<s[0]&&(o-=s[0]);else{if(!(n>this.ui.height))return tx=this.ui.width/2,ty=this.ui.height/2,this.resetViewpoint(),void(0==this.animationStack.lenght&&(clearInterval(this.zoomInterval),this.renderer.updateData=!0));tx=this.ui.width/2-this.translation[0],t[1]<this.ui.height?a+=this.ui.height-t[1]:0<s[1]&&(a-=s[1])}this.mat=sglMulM4(sglTranslationM4C(tx,ty,0),sglMulM4(sglScalingM4C(i,i,1),sglMulM4(sglTranslationM4C(-tx,-ty,0),this.mat))),this.translation[0]+=o,this.translation[1]+=a,_SGL_RegisteredCanvas[this.canvas].requestDraw()}},sendMouseDown:function(e){_SGL_RegisteredCanvas[this.canvas].mouseDown(e)},mouseDown:function(e,t,i,s){if(this.animating)return!1;if(0==t){if(this.ui.keysDown[17])this._setLightDir(i,s);else{var r;if(0==this.mode)return this.endAnimation=!1,this.currentPoint=[i,s],this.animationStack=[],r=this,clearInterval(this.zoomInterval),clearInterval(this.moveInterval),this.moveInterval=setInterval(function(){r._moveAnimation()},35),this.renderer.updateData=!1,!(this.isMoving=!0);1==this.mode&&this._setLightDir(i,s)}return!0}},_moveAnimation:function(){var e,t,i;(this.moveToCenter||this.endAnimation)&&0==this.animationStack.length?(clearInterval(this.moveInterval),this.renderer.updateData=!0,this.isMoving=!1,this.animating=!1,this.moveToCenter=!1):0==this.animationStack.length?this.currentSpeed=0:(t=(e=this.animationStack.splice(0,1)[0])[0]-this.currentPoint[0],i=e[1]-this.currentPoint[1],this.currentSpeed=e[2],this.translation[0]+=t,this.translation[1]+=i,this.currentPoint[0]=e[0],this.currentPoint[1]=e[1],_SGL_RegisteredCanvas[this.canvas].requestDraw())},mouseUp:function(e,t,i,s){return 0==t&&0==this.mode&&(this.endAnimation=!0,this.renderer.updateData=!0,this.isMoving=!1),!1},mouseOut:function(e,t,i,s){this.endAnimation=!0,this.isMoving=!1},mouseMove:function(e,t,i){var s;return!(this.animating||!this.ui.mouseButtonsDown[0]||(0!=this.mode||this.ui.keysDown[17]?(this._setLightDir(t,i),0):(i=(t=[t,i])[0]-this.currentPoint[0],s=t[1]-this.currentPoint[1],i=this._adjustTranslation(i,s),t=[this.currentPoint[0]+i[0],this.currentPoint[1]+i[1]],this._updateMoveStack(this.currentPoint,t,i),1)))},_updateMoveStack:function(e,t,i){var s=sglLengthV2(i);if(.1<s){this.animationStack.splice(0,this.animationStack.length);var r=sglNormalizedV2(i),n=2*(s/2-this.currentSpeed*this.maxStep)/(this.maxStep*this.maxStep),o=this.currentSpeed,a=[e[0],e[1]],l=this.maxStep,h=0,d=0;if(0<n){for(var u=0;u<this.maxStep;u++){var m=n/2+o,c=(o+=n,r[0]*m),g=r[1]*m;a[0]+=c,a[1]+=g,this.animationStack.push([a[0],a[1],o,n])}l=3*s/(2*o),d=4*o*o*o/(9*s*s),h=-4*o*o/(3*s)}else l=6*s/(2*o),d=o*o*o/(9*s*s),h=-2*o*o/(3*s);for(u=0;u<l;u++){m=d*u+d/3+h/2+o,c=(o+=d*(2*u+1)+h,r[0]*m),g=r[1]*m;a[0]+=c,a[1]+=g,this.animationStack.push([a[0],a[1],o,d])}this.animationStack.push([t[0],t[1],0,0])}},_adjustTranslation:function(e,t){var i=sglV4C(this.translation[0]+e,this.translation[1]+t,0,1),i=this.returnModelMatrix(i,this.mat),s=sglMulM4V4(i,sglV4C(this.leftBottom[0],this.leftBottom[1],0,1)).slice(0,2),i=sglMulM4V4(i,sglV4C(this.rightTop[0],this.rightTop[1],0,1)).slice(0,2),r=(s[0]-=this.viewerdx,s[1]-=this.viewerdy,i[0]+=this.viewerdx,i[1]+=this.viewerdy,i[0]-s[0]),n=i[1]-s[1];return r>this.ui.width&&n>this.ui.height?(i[0]<this.ui.width?e+=this.ui.width-i[0]:0<s[0]&&(e-=s[0]),i[1]<this.ui.height?t+=this.ui.height-i[1]:0<s[1]&&(t-=s[1])):r>this.ui.width?(i[0]<this.ui.width?e+=this.ui.width-i[0]:0<s[0]&&(e-=s[0]),t=0):n>this.ui.height?(i[1]<this.ui.height?t+=this.ui.height-i[1]:0<s[1]&&(t-=s[1]),e=0):t=e=0,sglV2C(e,t)},update:function(e,t){},returnModelMatrix:function(e,t){e=sglMulM4(sglTranslationM4C(e[0],e[1],1),t),e=sglMulM4(this.flipMatrix,e),this.xform.model.load(e),t=sglTranslationM4C(this.ui.width/2,this.ui.height/2,0);return this.xform.model.multiply(t),this.xform.model.scale(this.scale,this.scale,1),this.xform.model.multiply(this.renderer.normalizedTreeTransform),this.xform.model.top},computeModelMatrix:function(){var e=sglMulM4(sglTranslationM4C(this.translation[0],this.translation[1],1),this.mat),e=sglMulM4(this.flipMatrix,e),e=(this.xform.model.load(e),sglTranslationM4C(this.ui.width/2,this.ui.height/2,0));this.xform.model.multiply(e),this.xform.model.scale(this.scale,this.scale,1),this.xform.model.multiply(this.renderer.normalizedTreeTransform)},resize:function(){this.xform=new SglTransformStack,this.translation=[0,0],this.mat=sglIdentityM4(),this.rendering=!0,this.leftBottom=[(this.renderer._tree.scale[0]-this.renderer.imgWidth)/2,(this.renderer._tree.scale[1]-this.renderer.imgHeight)/2],this.rightTop=[this.leftBottom[0]+this.renderer.imgWidth,this.leftBottom[1]+this.renderer.imgHeight],this.scale=0;var e=this.ui.width,t=(this.offsetHeight=0,this.ui.height+this.offsetHeight);this.scale=Math.min(this.renderer._tree.scale[0]/this.renderer.imgWidth*e,this.renderer._tree.scale[1]/this.renderer.imgHeight*t),this.maxScale=3*Math.max(this.renderer.imgWidth/e,this.renderer.imgHeight/t),this.viewerdx=this.ui.width/2-10,this.viewerdy=this.ui.height/2-10},draw:function(e){var t,i;e.getError()==e.CONTEXT_LOST_WEBGL&&console.log("WebGL Context lost"),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),1==this.rendering&&(t=this.ui.width,i=this.ui.height,e.viewport(0,0,t,i),this.xform.projection.loadIdentity(),this.xform.projection.ortho(0,t,0,i,-4096,4096),this.xform.view.loadIdentity(),this.xform.view.lookAt(0,0,2,0,0,0,0,1,0),this.computeModelMatrix(),e=this.xform.model.top,this.onDrawCallback&&this.onDrawCallback(e),this.renderer.render(this.xform.projectionMatrix,this.xform.modelViewMatrix,[0,0,t,i]))}},MultiResTree.prototype={_load:function(e,t,i){this.ready=!0;var s,r=sglGetLines(e),n=r.length,o=0;if(!(n<=o||(s=r[o++].split(" ")).length<2)){var a=parseInt(s[0]);if(!(a<=0)){e=parseInt(s[1]);if(!(e<0||a<=e||n<=o||(s=r[o++].split(" ")).length<1)){var l=parseInt(s[0]);if(!(l<=0||n<=o||(s=r[o++].split(" ")).length<3)){var h=[1,1,1];if(h[0]=parseFloat(s[0]),h[1]=parseFloat(s[1]),h[2]=parseFloat(s[2]),!(n<=o||(s=r[o++].split(" ")).length<3)){var d=[0,0,0],u=(d[0]=parseFloat(s[0]),d[1]=parseFloat(s[1]),d[2]=parseFloat(s[2]),new Array(a));if(o<n)for(var m=0;m<a;++m){var c=new MultiResNode;if(n<=o)return;if((s=r[o++].split(" ")).length<14)return;if(c.id=parseInt(s[0]),c.id<=0)return;if(c.parentIndex=parseInt(s[1]),c.parentIndex<-1||c.parentIndex>=a)return;for(var g=0;g<4;++g)if(c.childrenIndices[g]=parseInt(s[g+2]),c.childrenIndices[g]<-1||c.childrenIndices[g]>=a)return;c.projectedSize=parseFloat(s[6]),c.zScale=parseFloat(s[7]),c.box.min[0]=parseFloat(s[8]),c.box.min[1]=parseFloat(s[9]),c.box.min[2]=parseFloat(s[10]),c.box.max[0]=parseFloat(s[11]),c.box.max[1]=parseFloat(s[12]),c.box.max[2]=parseFloat(s[13]),c.isLeaf=!0;for(var p=0;p<4;++p)if(0<=c.childrenIndices[p]){c.isLeaf=!1;break}u[m]=c}else{for(var _=0,f=h[0],x=1;l<f;)x++,f/=2;for(var b=(h[0]-t)/2/h[0],v=(h[1]-i)/2/h[1],b=new SglBox3([b,v,0],[b+t/h[0],v+i/h[1],1]),M=b.size,w=b.center,o=0;o<x;o++)for(var y=Math.pow(4,o),p=0;p<y;p++){(c=new MultiResNode).id=_+1,c.parentIndex=0<_?Math.ceil(_/4)-1:-1,o<x-1&&(c.isLeaf=!1);for(var S,I,T,R,g=0;g<4;++g)c.childrenIndices[g]=o==x-1?-1:4*_+1+(g+2)%4;c.projectedSize=l,0<_?(I=(T=u[c.parentIndex]).box.min[0]+(T.box.max[0]-T.box.min[0])/2,R=T.box.min[1]+(T.box.max[1]-T.box.min[1])/2,1==(S=_%4)?c.box=new SglBox3([T.box.min[0],R,0],[I,T.box.max[1],1]):2==S?c.box=new SglBox3([I,R,0],T.box.max):3==S?c.box=new SglBox3(T.box.min,[I,R,1]):0==S&&(c.box=new SglBox3([I,T.box.min[1],0],[T.box.max[0],R,1])),S=c.box.center,I=c.box.size,T=sglSelfMulV3S(sglAddV3(M,I),.5),R=sglSubV3(w,S),Math.abs(R[0])<=T[0]&&Math.abs(R[1])<=T[1]&&Math.abs(R[2])<=T[2]?c.zScale=1:c.zScale=0):(c.box=new SglBox3([0,0,0],[1,1,1]),c.zScale=1),u[_]=c,_++}}this.nodesCount=a,this.rootIndex=e,this.tileSize=l,this.scale=h,this.offset=d,this.nodes=u}}}}}},destroy:function(e){var t,i=null;for(t in this.nodes)(i=this.nodes[t]).req&&(i.req.onLoad=null,i.req=null),i.data&&(e(i.data),i.data=null);this.ready=!0,this.nodesCount=0,this.rootIndex=-1,this.nodes=null,this.url=null,this.tileSize=0,this.scale=[1,1,1]},load:function(e,t,i,s){if(!e)return!1;this._load(e,t,i)},get isEmpty(){return this.nodesCount<=0},get root(){var e=this.rootIndex;return e<0?null:this.nodes[e]},parent:function(e){e=e.parentIndex;return e<0?null:this.nodes[e]},child:function(e,t){e=e.childrenIndices[t];return e<0?null:this.nodes[e]}},MultiResRenderer.prototype={computeLightingFunction:function(e){switch(this.enumType[this.type]){case 1:var t=Math.atan2(e[1],e[0]),i=(t<0&&(t=2*Math.PI+t),Math.min(Math.acos(e[2]),Math.PI/2-.15)),s=Math.cos(t),i=Math.cos(i),r=i*i;return(n=new Array(9))[0]=1/Math.sqrt(2*Math.PI),n[1]=Math.sqrt(6/Math.PI)*(s*Math.sqrt(i-r)),n[2]=Math.sqrt(3/(2*Math.PI))*(2*i-1),n[3]=Math.sqrt(6/Math.PI)*(Math.sqrt(i-r)*Math.sin(t)),n[4]=Math.sqrt(30/Math.PI)*(Math.cos(2*t)*(r-i)),n[5]=Math.sqrt(30/Math.PI)*(s*(2*i-1)*Math.sqrt(i-r)),n[6]=Math.sqrt(5/(2*Math.PI))*(1-6*i+6*r),n[7]=Math.sqrt(30/Math.PI)*((2*i-1)*Math.sqrt(i-r)*Math.sin(t)),n[8]=Math.sqrt(30/Math.PI)*((r-i)*Math.sin(2*t)),n;case 2:case 3:var n;return(n=new Array(6))[0]=e[0]*e[0],n[1]=e[1]*e[1],n[2]=e[0]*e[1],n[3]=e[0],n[4]=e[1],n[5]=1,n}return[]},loadImage:function(e){var t=new XMLHttpRequest,i=null,i="string"==typeof e?e+"/info.xml":e("/info.xml"),s=(t.overrideMimeType("text/xml"),t.open("GET",i,!1),t.send(),t.responseXML),i=(this.format="jpg",parseInt(s.getElementsByTagName("MultiRes")[0].getAttribute("format"))),t=(isNaN(i)||1==i&&(this.format="png"),s.getElementsByTagName("Content")[0]);if(this.type=t.getAttribute("type"),!(this.type in this.enumType))return!1;var r=null;switch(this.enumType[this.type]){case 1:case 2:case 3:var n=s.getElementsByTagName("Size")[0],o=s.getElementsByTagName("Scale")[0],a=s.getElementsByTagName("Bias")[0],r=s.getElementsByTagName("Tree")[0];if(this.imgWidth=parseInt(n.getAttribute("width")),this.imgHeight=parseInt(n.getAttribute("height")),this.ordlen=parseInt(n.getAttribute("coefficients")),this.numLayers=this.ordlen,2==this.enumType[this.type]&&(this.numLayers=3),(tokens=o.childNodes[0].nodeValue.split(" ")).length<this.ordlen)return;this.gmax=[];for(var l=0;l<this.ordlen;l++)this.gmax[l]=parseFloat(tokens[l]);if((tokens=a.childNodes[0].nodeValue.split(" ")).length<this.ordlen)return;this.gmin=[];for(l=0;l<this.ordlen;l++)this.gmin[l]=parseFloat(tokens[l]);break;case 4:n=s.getElementsByTagName("Size")[0];r=s.getElementsByTagName("Tree")[0],this.imgWidth=parseInt(n.getAttribute("width")),this.imgHeight=parseInt(n.getAttribute("height")),this.ordlen=parseInt(n.getAttribute("coefficients")),this.numLayers=this.ordlen;break;default:return}switch(this._tree&&this._tree.destroy(this._destroyData),this._tree.load(r.textContent,this.imgWidth,this.imgHeight),this._url=e,this._timestamp=0,this._frustum=new SglFrustum,this._maxError=1,this._cache=[],this._toRequest=[],this._toRenderFullRes=[],this._toRenderHalfRes=[],this._readyItems=[],this.renderData=!0,this.renderBoxes=!1,this.lightPos=[0,0,1],this.lweights=[],this.lweights=this.computeLightingFunction(this.lightPos),null!=this._program&&this._program.destroy(),this.enumType[this.type]){case 1:var h=sglLoadFile("/assets/webViewer/spidergl/multi.v.glsl"),d=sglLoadFile("/assets/webViewer/spidergl/hsh.f.glsl");log((u=new SglProgram(this.gl,[h],[d])).log),this._program=u;break;case 2:h=sglLoadFile("/assets/webViewer/spidergl/multi.v.glsl"),d=sglLoadFile("/assets/webViewer/spidergl/lrgbptm.f.glsl");log((u=new SglProgram(this.gl,[h],[d])).log),this._program=u;break;case 3:h=sglLoadFile("/assets/webViewer/spidergl/multi.v.glsl"),d=sglLoadFile("/assets/webViewer/spidergl/rgbptm.f.glsl");log((u=new SglProgram(this.gl,[h],[d])).log),this._program=u;break;case 4:var u,h=sglLoadFile("/assets/webViewer/spidergl/multi.v.glsl"),d=sglLoadFile("/assets/webViewer/spidergl/image.f.glsl");log((u=new SglProgram(this.gl,[h],[d])).log),this._program=u;break;default:this._program=new SglProgram}this._renderer=new SglMeshGLRenderer(this._program),this._treeTransform=sglIdentityM4(),this._normalizedTreeTransform=sglIdentityM4(),this.leftTex=(this._tree.scale[0]-this.imgWidth)/2,this.rightTex=this.leftTex+this.imgWidth,this.bottomTex=(this._tree.scale[1]-this.imgHeight)/2,this.topTex=this.bottomTex+this.imgHeight,this.leftTex/=this._tree.scale[0],this.rightTex/=this._tree.scale[0],this.bottomTex/=this._tree.scale[1],this.topTex/=this._tree.scale[1],this._tree.ready&&this._setupTree()},_createLg:function(){var e=document.createElement("canvas"),t=(e.height=50,e.width=80,e.getContext("2d")),i=(t.save(),t.beginPath(),t.moveTo(0,0),t.lineTo(80,0),t.lineTo(80,50),t.lineTo(0,50),t.closePath(),t.clip(),t.strokeStyle="rgba(0,0,0,0)",t.lineCap="butt",t.lineJoin="miter",t.miterLimit=4,t.save(),t.restore(),t.save(),t.restore(),t.save(),t.transform(.21814175,0,0,.21573678,-3.3721339,-3.3665838),t.save(),t.translate(14.071762,20),t.save(),(g=t.createRadialGradient(239.50893,204.66128888494003,0,239.50893,204.66128888494003,31.820419)).addColorStop(0,"rgba(255, 255, 255, 1)"),g.addColorStop(1,"rgba(151, 151, 151, 1)"),t.fillStyle=g,t.strokeStyle="#000000",t.lineWidth=2.4923694133758545,t.lineCap="round",t.lineJoin="round",t.miterLimit=4,t.transform(2.1234583,0,0,1.6108995,-256.37574,-264.34719),t.beginPath(),t.moveTo(271.42857,233.79076),t.translate(240,233.80553976769053),t.rotate(0),t.scale(.7586207296076113,1),t.arc(0,0,41.42857,-.00035675303306008355,3.1419494066230014,0),t.scale(1.318181748760332,1),t.rotate(0),t.translate(-240,-233.80553976769053),t.translate(240,233.77598023230948),t.rotate(0),t.scale(.7586207296076113,1),t.arc(0,0,41.42857,3.141235900556733,6.2835420602127945,0),t.scale(1.318181748760332,1),t.rotate(0),t.translate(-240,-233.77598023230948),t.closePath(),t.fill(),t.stroke(),t.restore(),t.save(),t.fillStyle="#ececec",t.strokeStyle="#000000",t.lineWidth=4.609655857086182,t.lineCap="butt",t.lineJoin="round",t.miterLimit=4,t.beginPath(),t.moveTo(49.495605,44.507569),t.lineTo(129.49561,79.507569),t.lineTo(209.49561,44.507569),t.lineTo(49.495605,44.507569),t.closePath(),t.fill(),t.stroke(),t.restore(),t.save(),t.fillStyle="#999999",t.strokeStyle="#000000",t.lineWidth=4.609655857086182,t.lineCap="butt",t.lineJoin="round",t.miterLimit=4,t.beginPath(),t.moveTo(129.49561,174.50757),t.lineTo(129.49561,79.507572),t.lineTo(209.49561,44.507572),t.lineTo(129.49561,174.50757),t.closePath(),t.fill(),t.stroke(),t.restore(),t.save(),t.fillStyle="#b3b3b3",t.strokeStyle="#000000",t.lineWidth=4.609655857086182,t.lineCap="butt",t.lineJoin="round",t.miterLimit=4,t.beginPath(),t.moveTo(129.49561,174.50757),t.lineTo(129.49561,79.507569),t.lineTo(49.495605,44.507569),t.lineTo(129.49561,174.50757),t.closePath(),t.fill(),t.stroke(),t.restore(),t.save(),(g=t.createLinearGradient(236.58487,196.44904,257.4877,320.66739)).addColorStop(0,"rgba(255, 255, 255, 1)"),g.addColorStop(1,"rgba(151, 151, 151, 1)"),t.fillStyle=g,t.strokeStyle="#000000",t.lineWidth=3.3579113483428955,t.lineCap="round",t.lineJoin="round",t.miterLimit=4,t.transform(1.4965962,0,0,1.2591977,-86.218969,-182.0266),t.beginPath(),t.moveTo(271.42857,233.79076),t.translate(240,233.80553976769053),t.rotate(0),t.scale(.7586207296076113,1),t.arc(0,0,41.42857,-.00035675303306008355,3.1419494066230014,0),t.scale(1.318181748760332,1),t.rotate(0),t.translate(-240,-233.80553976769053),t.translate(240,233.77598023230948),t.rotate(0),t.scale(.7586207296076113,1),t.arc(0,0,41.42857,3.141235900556733,6.2835420602127945,0),t.scale(1.318181748760332,1),t.rotate(0),t.translate(-240,-233.77598023230948),t.closePath(),t.fill(),t.stroke(),t.restore(),t.restore(),t.restore(),t.restore(),new Image),t=e.toDataURL("image/png"),s=(i.src=t,this),e=(i.onload=function(){var e={generateMipmap:!1,minFilter:s.gl.NEAREST,magFilter:s.gl.NEAREST};s.lgtex=new SglTexture2D(s.gl,i,e)},this.gl.getError());console.log(e)},_createData:function(e){for(var t={minFilter:this.gl.LINEAR,magFilter:this.gl.LINEAR,generateMipmap:!1},i=new Array(e.length),s=0;s<e.length;++s)i[s]=new SglTexture2D(this.gl,e[s],t);return{textures:i}},_destroyData:function(e){if(e){for(var t=0;t<e.textures.length;++t)e.textures[t].destroy();e.textures=null}},_requestNode:function(t){if(!t.req){for(var e,i,s=this,r=("string"==typeof this._url&&(e=this._url+"/"+t.id),new Array),n=1;n<=this.numLayers;n++)i="string"==typeof this._url?e+"_"+n+"."+this.format:this._url("/"+t.id+"_"+n+"."+this.format),r.push(new SglImageRequest(i));var o=new SglRequestWatcher(r,function(e){s._currentOngoingRequests--,s._readyItems.push(t)});(t.req=o).send()}},_collectNodesRec:function(e,t){var i={needed:!1,usable:!!e.data};if(0!=e.zScale){if(!t){var s=this._frustum.boxVisibility(e.box.min,e.box.max);if(s==SGL_OUTSIDE_FRUSTUM)return i;t=s==SGL_INSIDE_FRUSTUM}i.needed=!0;s=this._frustum.projectedSegmentSize(e.box.center,e.box.size[0])/e.projectedSize;if(e.priority.timestamp=this._timestamp,e.priority.error=s,i.usable)if(s<this._maxError||e.isLeaf)this._toRenderFullRes.push(e);else{for(var r,n=0,o=0,a=[],l=0;l<4;++l)(r=this._tree.child(e,l))&&((r=this._collectNodesRec(r,t)).usable&&o++,r.needed)&&(n++,r.usable||a.push(l));0<n&&(o<=0?this._toRenderFullRes.push(e):0<a.length&&this._toRenderHalfRes.push({n:e,children:a}))}else e.req||this._toRequest.push(e)}return i},_collectNodes:function(){this._toRequest=[],this._toRenderFullRes=[],this._toRenderHalfRes=[];var e=this._tree.root;e&&this._collectNodesRec(e,!1)},_renderNodeFullRes:function(e){for(var t={u_world_box_min:e.box.min,u_world_box_max:e.box.max},i=[],s=0;s<this.numLayers;s++)i["coeff"+s]=e.data.textures[s];this._renderer.setUniforms(t),this._renderer.setSamplers(i),this._renderer.render()},_renderNodesFullRes:function(e){var t=this._tileFullMesh,i={u_model_view_projection_matrix:e,u_scale_bias:[1,1,0,0],u_texcoord_scale_bias:[this._tree.tileSize/(this._tree.tileSize+2),1/(this._tree.tileSize+2)],ordlen:this.ordlen,leftTex:this.leftTex,rightTex:this.rightTex,bottomTex:this.bottomTex,topTex:this.topTex};if(4!=this.enumType[this.type])for(var s=0;s<this.ordlen;s++)i["gmax"+s]=this.gmax[s],i["gmin"+s]=this.gmin[s],i["lweight"+s]=this.lweights[s];this._renderer.begin(),this._renderer.setUniforms(i),this._renderer.beginMesh(t),this._renderer.beginPrimitives("tristrip");var r;for(s in this._toRenderFullRes)r=this._toRenderFullRes[s],this._renderNodeFullRes(r);this._renderer.endPrimitives(),this._renderer.endMesh(),this._renderer.end()},_renderNodeHalfRes:function(e,t){for(var i={u_world_box_min:null,u_world_box_max:null,u_scale_bias:null},s=[],r=0;r<this.numLayers;r++)s["coeff"+r]=e.data.textures[r];this._renderer.setSamplers(s);var n,o=[[.5,.5,0,0],[.5,.5,.5,0],[.5,.5,0,.5],[.5,.5,.5,.5]];for(r in t)n=this._tree.child(e,t[r]),i.u_world_box_min=n.box.min,i.u_world_box_max=n.box.max,i.u_scale_bias=o[t[r]],this._renderer.setUniforms(i),this._renderer.render()},_renderNodesHalfRes:function(e){var t=this._tileHalfMesh,i={u_model_view_projection_matrix:e,u_texcoord_scale_bias:[this._tree.tileSize/(this._tree.tileSize+2),1/(this._tree.tileSize+2)],ordlen:this.ordlen,leftTex:this.leftTex,rightTex:this.rightTex,bottomTex:this.bottomTex,topTex:this.topTex};if(4!=this.enumType[this.type])for(var s=0;s<this.ordlen;s++)i["gmax"+s]=this.gmax[s],i["gmin"+s]=this.gmin[s],i["lweight"+s]=this.lweights[s];this._renderer.begin(),this._renderer.setUniforms(i),this._renderer.beginMesh(t),this._renderer.beginPrimitives("tristrip");var r;for(s in this._toRenderHalfRes)r=this._toRenderHalfRes[s],this._renderNodeHalfRes(r.n,r.children);this._renderer.endPrimitives(),this._renderer.endMesh(),this._renderer.end()},_renderNodes:function(e){this._renderNodesFullRes(e),this._renderNodesHalfRes(e)},_renderNodeFullResBox:function(e){var t=e.box.size,t={u_world_box_min:sglAddV3S(e.box.min,.05*t[0]),u_world_box_max:sglSubV3S(e.box.max,.05*t[0]),u_color:e.isLeaf?[1,0,1]:[0,1,0]};this._boxRenderer.setUniforms(t),this._boxRenderer.render()},_renderNodesFullResBoxes:function(e){var t,i,e={u_model_view_projection_matrix:e};this._boxRenderer.begin(),this._boxRenderer.setUniforms(e),this._boxRenderer.beginMesh(this._boxMesh),this._boxRenderer.beginPrimitives("edges");for(i in this._toRenderFullRes)t=this._toRenderFullRes[i],this._renderNodeFullResBox(t);this._boxRenderer.endPrimitives(),this._boxRenderer.endMesh(),this._boxRenderer.end()},_renderNodeHalfResBox:function(e,t){var i,s,r={u_world_box_min:null,u_world_box_max:null,u_color:null};for(s in t)i=this._tree.child(e,t[s]),sz=i.box.size,r.u_world_box_min=sglAddV3S(i.box.min,.05*sz[0]),r.u_world_box_max=sglSubV3S(i.box.max,.05*sz[0]),r.u_color=i.isLeaf?[1,1,0]:[1,1,1],this._boxRenderer.setUniforms(r),this._boxRenderer.render()},_renderNodesHalfResBoxes:function(e){var t,i,e={u_model_view_projection_matrix:e};this._boxRenderer.begin(),this._boxRenderer.setUniforms(e),this._boxRenderer.beginMesh(this._boxMesh),this._boxRenderer.beginPrimitives("edges");for(i in this._toRenderHalfRes)t=this._toRenderHalfRes[i],this._renderNodeHalfResBox(t.n,t.children);this._boxRenderer.endPrimitives(),this._boxRenderer.endMesh(),this._boxRenderer.end()},_renderNodesBoxes:function(e){this.gl.lineWidth(2),this.gl.depthFunc(this.gl.LEQUAL),this._renderNodesFullResBoxes(e),this._renderNodesHalfResBoxes(e),this.gl.depthFunc(this.gl.LESS),this.gl.lineWidth(1)},_doRender:function(e,t,i){var t=sglMulM4(t,this._treeTransform),i=(this._timestamp++,this._frustum.setup(e,t,i),this._collectNodes(),sglMulM4(e,t));this.renderData&&this._renderNodes(i),this.renderBoxes&&this._renderNodesBoxes(i),this.lg&&null!=this.lgtex&&(this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),t=sglMulM4(e,sglScalingM4C(1,1,1)),i={s_texture:this.lgtex},sglRenderMeshGLPrimitives(this.lgMesh,"tristrip",this.texProg,null,{u_mvp:t},i),this.gl.disable(this.gl.BLEND))},_updateCache:function(){for(var e=this._readyItems.slice(0,1),e=(this._readyItems.splice(0,1),this._cache.concat(e)),t=(e.sort(_MultiResCompareNodes),e.length),i=this._maxCacheSize<t?this._maxCacheSize:t,s=(this._cache=e.splice(0,i),e),r=null,n=null,o=[],a=0;a<i;++a)if(n=(r=this._cache[a]).req,r.req=null,n)if(n.succeeded){for(var l=new Array(n.requests.length),a=0;a<l.length;++a)l[a]=n.requests[a].image;r.data&&this._destroyData(r.data),r.data=this._createData(l)}else o.push(a);for(var h=o.length,d=0,i=s.length,a=0;a<i;++a)n=(r=s[a]).req,r.req=null,n||(d<h?(this._cache[o[d]]=r,d++):(this._destroyData(r.data),r.data=null));0<d&&this._cache.sort(_MultiResCompareNodes)},_requestNodes:function(){for(var e,t=this._cache.length,i=0<t?this._cache[t-1]:null,s=(this._toRequest.sort(_MultiResCompareNodes),this._maxOngoingRequests-this._currentOngoingRequests),r=0,n=this._toRequest.length,o=!1,a=0;a<n&&r<s;++a)!(e=this._toRequest[a]).req&&(o=!0,o=null!=i&&t>=this._maxCacheSize?_MultiResCompareNodes(e,i)<0:o)&&(this._requestNode(e),r++)},_calculateNormalizedTreeTransform:function(){var e=this._tree.root;if(!e)return sglIdentityM4();var t=new SglBox3,e=(t.min=sglAddV3(sglMulV3(e.box.min,this._tree.scale),this._tree.offset),t.max=sglAddV3(sglMulV3(e.box.max,this._tree.scale),this._tree.offset),this._treeTransform=sglMulM4(sglTranslationM4V(this._tree.offset),sglScalingM4V(this._tree.scale)),t.center),t=t.size,i=t[0],t=0<(i=(i=i<t[1]?t[1]:i)<t[2]?t[2]:i)?1/i:1,i=sglScalingM4C(t,t,t),t=sglTranslationM4C(-e[0],-e[1],-e[2]),e=sglMulM4(i,t);this._normalizedTreeTransform=e},_setupTree:function(){var e,t,i;this._tree.root&&(e=this.gl,t=(this._tree.tileSize+2)*(this._tree.tileSize+2)*this.ordlen*3,this._maxCacheSize=sglFloor(this._cacheSizeInBytes/t),this._maxCacheSize<=0&&(this._maxCacheSize=1),t=new Float32Array([-.5,.5,-.5,-.5,.5,.5,.5,-.5]),(i=new SglMeshGL(e)).addVertexAttribute("position",2,t),i.addArrayPrimitives("tristrip",e.TRIANGLE_STRIP,0,4),this._tileFullMesh=i,this._tileHalfMesh=i,this._calculateNormalizedTreeTransform())},render:function(e,t,i){this._tree.root&&(this._doRender(e,t,i),this.updateData)&&(this._updateCache(),this._requestNodes())},get normalizedTreeTransform(){return this._normalizedTreeTransform}};
//# sourceMappingURL=webrti.min.js.map
