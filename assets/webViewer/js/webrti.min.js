var SGL_VERSION_MAJOR=0,SGL_VERSION_MINOR=1,SGL_VERSION_REVISION=1,SGL_VERSION_STRING=SGL_VERSION_MAJOR+"."+SGL_VERSION_MINOR+"."+SGL_VERSION_REVISION;function sglUnknown(){throw new Error("SpiderGL : UNKNOWN")}function sglUnsupported(){throw new Error("SpiderGL : UNSUPPORTED")}function sglUnimplemented(){throw new Error("SpiderGL : UNIMPLEMENTED")}function sglInvalidParameter(){throw new Error("SpiderGL : INVALID_PARAMETER")}function sglInvalidCall(){throw new Error("SpiderGL : INVALID_CALL")}function sglDefineConstant(t,e,i){t[e]=i}function sglInherit(t,e){t.prototype=new e,t.prototype.constructor=t}function sglInitialize(){}function sglFinalize(){}function sglNodeText(t){var e=document.getElementById(t);if(!e)return null;for(var i="",n=e.firstChild;n;)3==n.nodeType&&(i+=n.textContent),n=n.nextSibling;return i}function sglLoadFile(t,e){var i=!!e,n=new XMLHttpRequest;i&&(n.onreadystatechange=function(){4==n.readyState&&e&&e(n.responseText)}),n.open("GET",t,i),n.send(null);var r=null;return i||(r=n.responseText),r}function sglGetLines(t){for(var e=t.split("\n"),i=e.length,n=[],r=null,s=0;s<i;++s)(r=e[s].replace(/[ \t]+/g," ").replace(/\s\s*$/,"")).length>0&&n.push(r);return n}window.addEventListener("load",(function(){sglInitialize()}),!1),window.addEventListener("unload",(function(){sglFinalize()}),!1);var SGL_REQUEST_FAILED=0,SGL_REQUEST_SUCCEEDED=1,SGL_REQUEST_IDLE=2,SGL_REQUEST_ONGOING=3,SGL_REQUEST_ABORTED=4,SGL_REQUEST_QUEUED=5,SGL_REQUEST_REJECTED=6,SGL_REQUEST_CANCELLED=7;function SglRequest(t){this._priority=null,this._status=SGL_REQUEST_IDLE,this._queue=null,this._onReady=[],t&&this.addOnReadyCallback(t)}function SglTextFileRequest(t,e){SglRequest.apply(this,Array.prototype.slice.call(arguments,1)),this._url=t,this._req=null,Object.defineProperty(this,"url",{get:function(){return this._url}}),Object.defineProperty(this,"text",{get:function(){return this._req.responseText}})}function SglImageRequest(t,e){SglRequest.apply(this,Array.prototype.slice.call(arguments,1)),this._url=t,this._img=null,Object.defineProperty(this,"url",{get:function(){return this._url}}),Object.defineProperty(this,"image",{get:function(){return this._img}})}function SglRequestWatcher(t,e){var i=t.length;this._onReady=e||null,this._waitingReqs=i,this._succeededReqs=0,this._failedReqs=0,this._reqs=t.slice();for(var n=this,r=function(t){t.succeeded?n._succeededReqs++:t.failed&&n._failedReqs++,n._waitingReqs--,n.isReady&&n._onReady&&n._onReady(n)},s=0;s<i;++s)t[s].succeeded?(this._succeededReqs++,this._waitingReqs--):t[s].failed?(this._failedReqs++,this._waitingReqs--):t[s].addOnReadyCallback(r);this._waitingReqs<=0&&this._onReady&&this._onReady(this)}function SglRequestQueue(t,e,i){this._maxOngoing=t>0?t:0,this._maxQueued=e>0?e:0,this._ongoing=[],this._queued=[],this._onReady=null,this._minPriorityReq=null,this._priorityCompare=null,this._dirty=!0}SglRequest.prototype={_createOnReadyCallback:function(){var t=this;return function(e){t._status=e?SGL_REQUEST_SUCCEEDED:SGL_REQUEST_FAILED,t._queue&&(t._queue._requestReady(t),this._queue=null);for(var i=t._onReady.length,n=0;n<i;++n)t._onReady[n](t)}},get status(){return this._status},get priority(){return this._priority},set priority(t){this._priority=t,this._queue&&this._queue._updateRequest(this)},get succeeded(){return this._status==SGL_REQUEST_SUCCEEDED},get failed(){return this._status==SGL_REQUEST_FAILED},addOnReadyCallback:function(t){t&&(this._onReady.push(t),this.isReady&&t(this))},removeOnReadyCallback:function(t){for(var e=-1,i=this._onReady.length,n=0;n<i;++n)if(this._onReady[n]==t){e=n;break}e<0||this._onReady.splice(e,1)},get isReady(){return this.failed||this.succeeded},get queue(){return this._queue},send:function(){if(!this._send)return!1;var t=this._send();t?this._status=SGL_REQUEST_ONGOING:(this._status=SGL_REQUEST_FAILED,this._createOnReadyCallback()(!1));return t},cancel:function(){this._status==SGL_REQUEST_QUEUED&&(this._queue&&(this._queue._removeQueuedRequest(this),this._queue=null),this._status=SGL_REQUEST_CANCELLED)},abort:function(){this.cancel(),this._status==SGL_REQUEST_ONGOING&&(this._queue&&(this._queue._removeOngoingRequest(this),this._queue=null),this._abort&&this._abort(),this._status=SGL_REQUEST_ABORTED)}},sglInherit(SglTextFileRequest,SglRequest),SglTextFileRequest.prototype._send=function(){if(!this._url)return!1;var t=new XMLHttpRequest;this._req=t;var e=this._createOnReadyCallback();return t.onreadystatechange=function(){if(4==t.readyState){var i=!t.status||200==t.status;e(i)}},t.open("GET",this._url,!0),t.send(),!0},SglTextFileRequest.prototype._abort=function(){this._req&&this._req.abort()},sglInherit(SglImageRequest,SglRequest),SglImageRequest.prototype._send=function(){if(!this._url)return!1;var t=new Image;this._img=t,t.crossOrigin="";var e=this._createOnReadyCallback();return t.onload=function(){e(t.complete)},t.onerror=function(){e(!1)},t.src=this._url,!0},SglImageRequest.prototype._abort=function(){},SglRequestWatcher.prototype={get requests(){return this._reqs},get succeeded(){return this._succeededReqs==this._reqs.length},get failed(){return!(this._succeededReqs+this._failedReqs<this._reqs.length)&&this._succeededReqs<this._reqs.length},get onReady(){return this._onReady},set onReady(e){this._onReady=e,this.isReady&&this._onReady&&this._onReady(t)},get isReady(){return this._succeededReqs+this._failedReqs==this._reqs.length},send:function(){for(var t=this._reqs.length,e=0;e<t;++e)this._reqs[e].send()},cancel:function(){for(var t=this._reqs.length,e=0;e<t;++e)this._reqs[e].cancel()},abort:function(){for(var t=this._reqs.length,e=0;e<t;++e)this._reqs[e].abort()}},SglRequestQueue.prototype={_sort:function(){this._dirty&&(this._dirty=!1,this._minPriorityReq=null,this._queued.length<=0||(this._priorityCompare?this._queued.sort(this._priorityCompare):this._queued.sort(),this._queued.length>0&&(this._minPriorityReq=this._queued[0])))},_updateMinPriority:function(){this._minPriorityReq=null;var t=this._queued.length;if(!(t<=0)&&(this._minPriorityReq=this._queued[0],this._dirty))for(var e=1;e<t;++e)this.comparePriorities(this._queued[e].priority,this._minPriorityReq.priority)<=0&&(this._minPriorityReq=this._queued[e])},_removeFromArray:function(t,e){for(var i=-1,n=t.length,r=0;r<n;++r)if(t[r]==e){i=r;break}i<0||t.splice(i,1)},_removeQueuedRequest:function(t){this._removeFromArray(this._queued,t),this._queued.length<=0?this._minPriorityReq=null:t==this._minPriorityReq&&this._updateMinPriority()},_removeOngoingRequest:function(t){this._removeFromArray(this._ongoing,t),this._execute()},_updateRequest:function(t){this.comparePriorities(t.priority,this._minPriorityReq.priority)<=0&&(this._minPriorityReq=t),this._dirty=!0},_requestReady:function(t){this._removeOngoingRequest(t),this._onReady&&this._onReady(t),this._execute()},_execute:function(){var t=this._queued.length;if(!(t<=0)){var e=this._maxOngoing>0?this._maxOngoing-this._ongoing.length:t;if(!(e<=0)){e>t&&(e=t),this._sort();for(var i=0;i<e;++i)this._queued.pop().send();this._queued.length>0&&(this._minPriorityReq=this._queued[0])}}},comparePriorities:function(t,e){return this._priorityCompare?this._priorityCompare(t,e):t-e},get priorityCompare(){return this._priorityCompare},set priorityCompare(t){this._priorityCompare=t,this._updateMinPriority()},get onReady(){return this._onReady},set onReady(t){this._onReady=t},push:function(t){var e={victims:null,result:!1};if(t.queue)return e;var i=this._queued.length;if(this._maxQueued>0&&i>=this._maxQueued&&this.comparePriorities(t.priority,this._minPriorityReq.priority)<=0)return t._status=SGL_REQUEST_REJECTED,e;this._queued.push(t),t._queue=this,t._status=SGL_REQUEST_QUEUED,i++,e.result=!0;var n=this._maxQueued>0?i-this._maxQueued:0;if(n<=0)null!=this._minPriorityReq?this.comparePriorities(t.priority,this._minPriorityReq.priority)<=0&&(this._minPriorityReq=t):this._minPriorityReq=t,this._dirty=!0;else{this._sort(),e.victims=this._queued.slice(0,n),this._queued.splice(0,n);for(var r=0;r<n;++r)e.victims[r]._status=SGL_REQUEST_REJECTED,e.victims[r]._queue=null}return this._execute(),e}};var SGL_PI=Math.PI;function sglAbs(t){return Math.abs(t)}function sglFloor(t){return Math.floor(t)}function sglCeil(t){return Math.ceil(t)}function sglSqrt(t){return Math.sqrt(t)}function sglPow(t,e){return Math.pow(t,e)}function sglLog(t){return Math.log(t)}function sglExp(t){return Math.exp(t)}function sglSin(t){return Math.sin(t)}function sglAsin(t){return Math.asin(t)}function sglCos(t){return Math.cos(t)}function sglAcos(t){return Math.acos(t)}function sglTan(t){return Math.tan(t)}function sglAtan(t){return Math.atan(t)}function sglAtan2(t,e){return Math.atan2(t,e)}function sglDegToRad(t){return t*(SGL_PI/180)}function sglRadToDeg(t){return t*(180/SGL_PI)}function sglMin(t,e){return Math.min(t,e)}function sglMax(t,e){return Math.max(t,e)}function sglClamp(t,e,i){return t<=e?e:t>=i?i:t}function sglRandom01(){return Math.random()}function sglMapVN(t,e,i,r,s,o,l){l=null!=l?l:e;for(var u=(s=null!=s?s:0)+(o=null!=o?o:(t.length-s)/l)*l,a=new Array(n),h=0,g=0,f=s;f<u;f+=l){for(g=0;g<n;++g)a[g]=t[f+g];for(i(a,r,h++),g=0;g<n;++g)t[f+g]=a[g]}}function sglMapV2(t,e,i,n,r,s){sglMapVN(t,2,e,i,n,r,s)}function sglMapV3(t,e,i,n,r,s){sglMapVN(t,3,e,i,n,r,s)}function sglMapV4(t,e,i,n,r,s){sglMapVN(t,4,e,i,n,r,s)}function sglUndefV2(t){return new Array(2)}function sglV2V(t){return t.slice(0,2)}function sglV2S(t){return[t,t]}function sglV2C(t,e){return[t,e]}function sglZeroV2(){return sglV2S(0)}function sglOneV2(){return sglV2S(1)}function sglV2(){var t=arguments.length;switch(t){case 1:return arguments[0]instanceof Array?sglV2V(arguments[0]):sglV2S(arguments[0]);case 2:return sglV2V(arguments);default:return sglZeroV2()}return null}function sglDupV2(t){return t.slice(0,2)}function sglNegV2(t){return sglV2C(-t[0],-t[1])}function sglAddV2(t,e){return sglV2C(t[0]+e[0],t[1]+e[1])}function sglAddV2S(t,e){return sglV2C(t[0]+e,t[1]+e)}function sglAddSV2(t,e){return sglAddV2S(e,t)}function sglSubV2(t,e){return sglV2C(t[0]-e[0],t[1]-e[1])}function sglSubV2S(t,e){return sglV2C(t[0]-e,t[1]-e)}function sglSubSV2(t,e){return sglV2C(e-t[0],e-t[1])}function sglMulV2(t,e){return sglV2C(t[0]*e[0],t[1]*e[1])}function sglMulV2S(t,e){return sglV2C(t[0]*e,t[1]*e)}function sglMulSV2(t,e){return sglMulV2S(e,t)}function sglDivV2(t,e){return sglV2C(t[0]/e[0],t[1]/e[1])}function sglDivV2S(t,e){return sglV2C(t[0]/e,t[1]/e)}function sglDivSV2(t,e){return sglV2C(t/e[0],t/e[1])}function sglRcpV2(t){return sglDivSV2(1,t)}function sglDotV2(t,e){return t[0]*e[0]+t[1]*e[1]}function sglCrossV2(t,e){return t[0]*e[1]-t[1]*e[0]}function sglSqLengthV2(t){return sglDotV2(t,t)}function sglLengthV2(t){return sglSqrt(sglSqLengthV2(t))}function sglNormalizedV2(t){return sglMulV2S(t,1/sglLengthV2(t))}function sglSelfNegV2(t){return t[0]=-t[0],t[1]=-t[1],t}function sglSelfAddV2(t,e){return t[0]+=e[0],t[1]+=e[1],t}function sglSelfAddV2S(t,e){return t[0]+=e,t[1]+=e,t}function sglSelfAddSV2(t,e){return e[0]+=t,e[1]+=t,e}function sglSelfSubV2(t,e){return t[0]-=e[0],t[1]-=e[1],t}function sglSelfSubV2S(t,e){return t[0]-=e,t[1]-=e,t}function sglSelfSubSV2(t,e){return t[0]=e-t[0],t[1]=e-t[1],t}function sglSelfMulV2(t,e){return t[0]*=e[0],t[1]*=e[1],t}function sglSelfMulV2S(t,e){return t[0]*=e,t[1]*=e,t}function sglSelfMulSV2(t,e){return e[0]*=t,e[1]*=t,e}function sglSelfDivV2(t,e){return t[0]/=e[0],t[1]/=e[1],t}function sglSelfDivV2S(t,e){return u[0]/=e,u[1]/=e,u}function sglSelfDivSV2(t,e){return e[0]=t/e[0],e[1]=t/e[1],e}function sglSelfRcpV2(t){return sglSelfDivSV2(1,t)}function sglSelfNormalizeV2(t){return sglSelfMulV2S(t,1/sglLengthV2(t))}function sglMinV2(t,e){return[t[0]<e[0]?t[0]:e[0],t[1]<e[1]?t[1]:e[1]]}function sglMaxV2(t,e){return[t[0]>e[0]?t[0]:e[0],t[1]>e[1]?t[1]:e[1]]}function sglV2toV3(t,e){return sglV3C(t[0],t[1],e)}function sglV2toV4(t,e,i){return sglV4C(t[0],t[1],e,i)}function sglUndefV3(t){return new Array(3)}function sglV3V(t){return t.slice(0,3)}function sglV3S(t){return[t,t,t]}function sglV3C(t,e,i){return[t,e,i]}function sglZeroV3(){return sglV3S(0)}function sglOneV3(){return sglV3S(1)}function sglV3(){var t=arguments.length;switch(t){case 1:return arguments[0]instanceof Array?sglV3V(arguments[0]):sglV3S(arguments[0]);case 3:return sglV3V(arguments);default:return sglZeroV3()}return null}function sglDupV3(t){return t.slice(0,3)}function sglNegV3(t){return sglV3C(-t[0],-t[1],-t[2])}function sglAddV3(t,e){return sglV3C(t[0]+e[0],t[1]+e[1],t[2]+e[2])}function sglAddV3S(t,e){return sglV3C(t[0]+e,t[1]+e,t[2]+e)}function sglAddSV3(t,e){return sglAddV3S(e,t)}function sglSubV3(t,e){return sglV3C(t[0]-e[0],t[1]-e[1],t[2]-e[2])}function sglSubV3S(t,e){return sglV3C(t[0]-e,t[1]-e,t[2]-e)}function sglSubSV3(t,e){return sglV3C(e-t[0],e-t[1],e-t[2])}function sglMulV3(t,e){return sglV3C(t[0]*e[0],t[1]*e[1],t[2]*e[2])}function sglMulV3S(t,e){return sglV3C(t[0]*e,t[1]*e,t[2]*e)}function sglMulSV3(t,e){return sglMulV3S(e,t)}function sglDivV3(t,e){return sglV3C(t[0]/e[0],t[1]/e[1],t[2]/e[2])}function sglDivV3S(t,e){return sglV3C(t[0]/e,t[1]/e,t[2]/e)}function sglDivSV3(t,e){return sglV3C(t/e[0],t/e[1],t/e[2])}function sglRcpV3(t){return sglDivSV3(1,t)}function sglDotV3(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function sglCrossV3(t,e){return sglV3C(t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0])}function sglSqLengthV3(t){return sglDotV3(t,t)}function sglLengthV3(t){return sglSqrt(sglSqLengthV3(t))}function sglNormalizedV3(t){return sglMulV3S(t,1/sglLengthV3(t))}function sglSelfNegV3(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t}function sglSelfAddV3(t,e){return t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t}function sglSelfAddV3S(t,e){return t[0]+=e,t[1]+=e,t[2]+=e,t}function sglSelfAddSV3(t,e){return e[0]+=t,e[1]+=t,e[2]+=t,e}function sglSelfSubV3(t,e){return t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t}function sglSelfSubV3S(t,e){return t[0]-=e,t[1]-=e,t[2]-=e,t}function sglSelfSubSV3(t,e){return t[0]=e-t[0],t[1]=e-t[1],t[2]=e-t[2],t}function sglSelfMulV3(t,e){return t[0]*=e[0],t[1]*=e[1],t[2]*=e[2],t}function sglSelfMulV3S(t,e){return t[0]*=e,t[1]*=e,t[2]*=e,t}function sglSelfMulSV3(t,e){return e[0]*=t,e[1]*=t,e[2]*=t,e}function sglSelfDivV3(t,e){return t[0]/=e[0],t[1]/=e[1],t[2]/=e[2],t}function sglSelfDivV3S(t,e){return u[0]/=e,u[1]/=e,u[2]/=e,u}function sglSelfDivSV3(t,e){return e[0]=t/e[0],e[1]=t/e[1],e[2]=t/e[2],e}function sglSelfRcpV3(t){return sglSelfDivSV3(1,t)}function sglSelfCrossV3(t,e){var i=sglV3C(t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]);return t[0]=i[0],t[1]=i[1],t[2]=i[2],t}function sglSelfNormalizeV3(t){return sglSelfMulV3S(t,1/sglLengthV3(t))}function sglMinV3(t,e){return[t[0]<e[0]?t[0]:e[0],t[1]<e[1]?t[1]:e[1],t[2]<e[2]?t[2]:e[2]]}function sglMaxV3(t,e){return[t[0]>e[0]?t[0]:e[0],t[1]>e[1]?t[1]:e[1],t[2]>e[2]?t[2]:e[2]]}function sglV3toV2(t){return t.slice(0,2)}function sglV3toV4(t,e){return sglV4C(t[0],t[1],t[2],e)}function sglUndefV4(t){return new Array(4)}function sglV4V(t){return t.slice(0,4)}function sglV4S(t){return[t,t,t,t]}function sglV4C(t,e,i,n){return[t,e,i,n]}function sglZeroV4(){return sglV4S(0)}function sglOneV4(){return sglV4S(1)}function sglV4(){var t=arguments.length;switch(t){case 1:return arguments[0]instanceof Array?sglV4V(arguments[0]):sglV4S(arguments[0]);case 4:return sglV4V(arguments);default:return sglZeroV4()}return null}function sglDupV4(t){return t.slice(0,4)}function sglNegV4(t){return sglV4C(-t[0],-t[1],-t[2],-t[3])}function sglAddV4(t,e){return sglV4C(t[0]+e[0],t[1]+e[1],t[2]+e[2],t[3]+e[3])}function sglAddV4S(t,e){return sglV4C(t[0]+e,t[1]+e,t[2]+e,t[3]+e)}function sglAddSV4(t,e){return sglAddV4S(e,t)}function sglSubV4(t,e){return sglV4C(t[0]-e[0],t[1]-e[1],t[2]-e[2],t[3]-e[3])}function sglSubV4S(t,e){return sglV4C(t[0]-e,t[1]-e,t[2]-e,t[3]-e)}function sglSubSV4(t,e){return sglV4C(e-t[0],e-t[1],e-t[2],e-t[3])}function sglMulV4(t,e){return sglV4C(t[0]*e[0],t[1]*e[1],t[2]*e[2],t[3]*e[3])}function sglMulV4S(t,e){return sglV4C(t[0]*e,t[1]*e,t[2]*e,t[3]*e)}function sglMulSV4(t,e){return sglMulV4S(e,t)}function sglDivV4(t,e){return sglV4C(t[0]/e[0],t[1]/e[1],t[2]/e[2],t[3]/e[3])}function sglDivV4S(t,e){return sglV4C(t[0]/e,t[1]/e,t[2]/e,t[3]/e)}function sglDivSV4(t,e){return sglV4C(t/e[0],t/e[1],t/e[2],t/e[3])}function sglRcpV4(t){return sglDivSV4(1,t)}function sglDotV4(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function sglSqLengthV4(t){return sglDotV4(t,t)}function sglLengthV4(t){return sglSqrt(sglSqLengthV4(t))}function sglNormalizedV4(t){return sglMulV4S(t,1/sglLengthV4(t))}function sglProjectV4(t){var e=1/t[3];return sglV4C(t[0]*e,t[1]*e,t[2]*e,1)}function sglSelfNegV4(t){return t[0]=-t[0],t[1]=-t[1],t[2]=-t[2],t[3]=-t[3],t}function sglSelfAddV4(t,e){return t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[3],t}function sglSelfAddV4S(t,e){return t[0]+=e,t[1]+=e,t[2]+=e,t[3]+=e,t}function sglSelfAddSV4(t,e){return e[0]+=t,e[1]+=t,e[2]+=t,e[3]+=t,e}function sglSelfSubV4(t,e){return t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t[3]-=e[3],t}function sglSelfSubV4S(t,e){return t[0]-=e,t[1]-=e,t[2]-=e,t[3]-=e,t}function sglSelfSubSV4(t,e){return t[0]=e-t[0],t[1]=e-t[1],t[2]=e-t[2],t[3]=e-t[3],t}function sglSelfMulV4(t,e){return t[0]*=e[0],t[1]*=e[1],t[2]*=e[2],t[3]*=e[3],t}function sglSelfMulV4S(t,e){return t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e,t}function sglSelfMulSV4(t,e){return e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e}function sglSelfDivV4(t,e){return t[0]/=e[0],t[1]/=e[1],t[2]/=e[2],t[3]/=e[3],t}function sglSelfDivV4S(t,e){return u[0]/=e,u[1]/=e,u[2]/=e,u[3]/=e,u}function sglSelfDivSV4(t,e){return e[0]=t/e[0],e[1]=t/e[1],e[2]=t/e[2],e[3]=t/e[3],e}function sglSelfRcpV4(t){return sglSelfDivSV4(1,t)}function sglSelfNormalizeV4(t){return sglSelfMulV4S(t,1/sglLengthV4(t))}function sglSelfProjectV4(t){var e=1/t[3];return t[0]*=e,t[1]*=e,t[2]*=e,t[3]=1,t}function sglMinV4(t,e){return[t[0]<e[0]?t[0]:e[0],t[1]<e[1]?t[1]:e[1],t[2]<e[2]?t[2]:e[2],t[3]<e[3]?t[3]:e[3]]}function sglMaxV4(t,e){return[t[0]>e[0]?t[0]:e[0],t[1]>e[1]?t[1]:e[1],t[2]>e[2]?t[2]:e[2],t[3]>e[3]?t[3]:e[3]]}function sglV4toV2(t){return t.slice(0,2)}function sglV4toV3(t){return t.slice(0,3)}function sglUndefM4(){return new Array(16)}function sglM4V(t){return t.slice(0,16)}function sglM4S(t){for(var e=sglUndefM4(),i=0;i<16;++i)e[i]=t;return e}function sglDiagM4V(t){var e=sglM4S(0);return e[0]=t[0],e[5]=t[1],e[10]=t[2],e[15]=t[3],e}function sglDiagM4S(t){var e=sglM4S(0);return e[0]=t,e[5]=t,e[10]=t,e[15]=t,e}function sglDiagM4C(t,e,i,n){return sglDiagM4V(arguments)}function sglZeroM4(){return sglM4S(0)}function sglOneM4(){return sglM4S(1)}function sglIdentityM4(){return sglDiagM4S(1)}function sglM4(){var t=arguments.length;switch(t){case 1:if(arguments[0]instanceof Array)switch(arguments[0].length){case 1:return sglDiagM4S(arguments[0]);case 4:return sglDiagM4V(arguments[0]);case 16:return sglM4V(arguments[0]);default:return sglIdentityM4()}return sglM4S(arguments[0]);case 4:return sglDiagM4V(arguments);case 16:return sglM4V(arguments);default:return sglIdentityM4()}return null}function sglDupM4(t){var e=sglUndefM4();return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function sglGetElemM4(t,e,i){return t[e+4*i]}function sglSetElemM4(t,e,i,n){t[e+4*i]=n}function sglGetRowM4(t,e){return sglV4C(t[e+0],t[e+4],t[e+8],t[e+12])}function sglSetRowM4V(t,e,i){t[e+0]=i[0],t[e+4]=i[1],t[e+8]=i[2],t[e+12]=i[3]}function sglSetRowM4S(t,e,i){t[e+0]=i,t[e+4]=i,t[e+8]=i,t[e+12]=i}function sglSetRowM4C(t,e,i,n,r,s){t[e+0]=i,t[e+4]=n,t[e+8]=r,t[e+12]=s}function sglGetColM4(t,e){var i=4*e;return sglV4C(t[i+0],t[i+1],t[i+2],t[i+3])}function sglSetColM4V(t,e,i){var n=4*e;t[n+0]=i[0],t[n+1]=i[1],t[n+2]=i[2],t[n+3]=i[3]}function sglSetColM4S(t,e,i){var n=4*e;t[n+0]=i,t[n+1]=i,t[n+2]=i,t[n+3]=i}function sglSetColM4C(t,e,i,n,r,s){var o=4*e;t[o+0]=i,t[o+1]=n,t[o+2]=r,t[o+3]=s}function sglM4toM3(t){return[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]]}function sglIsIdentityM4(t){var e=0,i=0,n=0;for(e=0;e<4;++e)for(i=0;i<4;++i)if(n=t[e+4*i],e==i){if(1!=n)return!1}else if(0!=n)return!1;return!0}function sglNegM4(t){for(var e=sglUndefM4(),i=0;i<16;++i)e[i]=-t[i];return e}function sglAddM4(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]+e[n];return i}function sglAddM4S(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]+e;return i}function sglAddSM4(t,e){return sglAddM4S(e,t)}function sglSubM4(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]-e[n];return i}function sglSubM4S(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]-e;return i}function sglSubSM4(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t-e[n];return i}function sglMulM4(t,e){var i=t[0],n=t[1],r=t[2],s=t[3],o=t[4],l=t[5],u=t[6],a=t[7],h=t[8],g=t[9],f=t[10],c=t[11],_=t[12],d=t[13],v=t[14],m=t[15],p=e[0],S=e[1],M=e[2],E=e[3],T=e[4],R=e[5],V=e[6],b=e[7],y=e[8],P=e[9],x=e[10],A=e[11],L=e[12],I=e[13],w=e[14],C=e[15],D=sglUndefM4();return D[0]=i*p+o*S+h*M+_*E,D[1]=n*p+l*S+g*M+d*E,D[2]=r*p+u*S+f*M+v*E,D[3]=s*p+a*S+c*M+m*E,D[4]=i*T+o*R+h*V+_*b,D[5]=n*T+l*R+g*V+d*b,D[6]=r*T+u*R+f*V+v*b,D[7]=s*T+a*R+c*V+m*b,D[8]=i*y+o*P+h*x+_*A,D[9]=n*y+l*P+g*x+d*A,D[10]=r*y+u*P+f*x+v*A,D[11]=s*y+a*P+c*x+m*A,D[12]=i*L+o*I+h*w+_*C,D[13]=n*L+l*I+g*w+d*C,D[14]=r*L+u*I+f*w+v*C,D[15]=s*L+a*I+c*w+m*C,D}function sglMulM4S(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]*e;return i}function sglMulSM4(t,e){return sglMulM4S(e,t)}function sglMulM4V3(t,e,i){return[t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12]*i,t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13]*i,t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14]*i]}function sglMulM4V4(t,e){return[t[0]*e[0]+t[4]*e[1]+t[8]*e[2]+t[12]*e[3],t[1]*e[0]+t[5]*e[1]+t[9]*e[2]+t[13]*e[3],t[2]*e[0]+t[6]*e[1]+t[10]*e[2]+t[14]*e[3],t[3]*e[0]+t[7]*e[1]+t[11]*e[2]+t[15]*e[3]]}function sglDivM4S(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]/e;return i}function sglDivSM4(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t/e[n];return i}function sglRcpM4(t){return sglDivSM4(1,t)}function sglCompMulM4(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]*e[n];return i}function sglCompDivM4(t,e){for(var i=sglUndefM4(),n=0;n<16;++n)i[n]=t[n]/e[n];return i}function sglTransposeM4(t){var e=sglUndefM4();return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e}function sglDeterminantM4(t){var e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],o=t[5],l=t[6],u=t[7],a=t[8],h=t[9],g=t[10],f=t[11],c=t[12],_=t[13],d=t[14],v=t[15];return c*h*l*r-a*_*l*r-c*o*g*r+s*_*g*r+a*o*d*r-s*h*d*r-c*h*n*u+a*_*n*u+c*i*g*u-e*_*g*u-a*i*d*u+e*h*d*u+c*o*n*f-s*_*n*f-c*i*l*f+e*_*l*f+s*i*d*f-e*o*d*f-a*o*n*v+s*h*n*v+a*i*l*v-e*h*l*v-s*i*g*v+e*o*g*v}function sglInverseM4(t){var e=t[0],i=t[1],n=t[2],r=t[3],s=t[4],o=t[5],l=t[6],u=t[7],a=t[8],h=t[9],g=t[10],f=t[11],c=t[12],_=t[13],d=t[14],v=t[15],m=sglUndefM4();m[0]=h*d*u-_*g*u+_*l*f-o*d*f-h*l*v+o*g*v,m[1]=_*g*r-h*d*r-_*n*f+i*d*f+h*n*v-i*g*v,m[2]=o*d*r-_*l*r+_*n*u-i*d*u-o*n*v+i*l*v,m[3]=h*l*r-o*g*r-h*n*u+i*g*u+o*n*f-i*l*f,m[4]=c*g*u-a*d*u-c*l*f+s*d*f+a*l*v-s*g*v,m[5]=a*d*r-c*g*r+c*n*f-e*d*f-a*n*v+e*g*v,m[6]=c*l*r-s*d*r-c*n*u+e*d*u+s*n*v-e*l*v,m[7]=s*g*r-a*l*r+a*n*u-e*g*u-s*n*f+e*l*f,m[8]=a*_*u-c*h*u+c*o*f-s*_*f-a*o*v+s*h*v,m[9]=c*h*r-a*_*r-c*i*f+e*_*f+a*i*v-e*h*v,m[10]=s*_*r-c*o*r+c*i*u-e*_*u-s*i*v+e*o*v,m[11]=a*o*r-s*h*r-a*i*u+e*h*u+s*i*f-e*o*f,m[12]=c*h*l-a*_*l-c*o*g+s*_*g+a*o*d-s*h*d,m[13]=a*_*n-c*h*n+c*i*g-e*_*g-a*i*d+e*h*d,m[14]=c*o*n-s*_*n-c*i*l+e*_*l+s*i*d-e*o*d,m[15]=s*h*n-a*o*n+a*i*l-e*h*l-s*i*g+e*o*g;for(var p=1/(c*h*l*r-a*_*l*r-c*o*g*r+s*_*g*r+a*o*d*r-s*h*d*r-c*h*n*u+a*_*n*u+c*i*g*u-e*_*g*u-a*i*d*u+e*h*d*u+c*o*n*f-s*_*n*f-c*i*l*f+e*_*l*f+s*i*d*f-e*o*d*f-a*o*n*v+s*h*n*v+a*i*l*v-e*h*l*v-s*i*g*v+e*o*g*v),S=0;S<16;++S)m[S]*=p;return m}function sglTraceM4(t){return t[0]+t[5]+t[10]+t[15]}function sglTranslationM4V(t){var e=sglIdentityM4();return e[12]=t[0],e[13]=t[1],e[14]=t[2],e}function sglTranslationM4C(t,e,i){return sglTranslationM4V([t,e,i])}function sglTranslationM4S(t){return sglTranslationM4C(t,t,t)}function sglRotationAngleAxisM4V(t,e){var i,n,r,s,o,l,u,a,h,g=sglNormalizedV3(e),f=sglSin(t),c=sglCos(t),_=1-c,d=g[0],v=g[1],m=g[2];i=d*d,n=v*v,r=m*m,s=d*v,o=v*m,l=m*d,u=d*f,a=v*f,h=m*f;var p=sglUndefM4();return p[0]=_*i+c,p[1]=_*s+h,p[2]=_*l-a,p[3]=0,p[4]=_*s-h,p[5]=_*n+c,p[6]=_*o+u,p[7]=0,p[8]=_*l+a,p[9]=_*o-u,p[10]=_*r+c,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p}function sglRotationAngleAxisM4C(t,e,i,n){return sglRotationAngleAxisM4V(t,[e,i,n])}function sglScalingM4V(t){var e=sglIdentityM4();return e[0]=t[0],e[5]=t[1],e[10]=t[2],e}function sglScalingM4C(t,e,i){return sglScalingM4V([t,e,i])}function sglScalingM4S(t){return sglScalingM4C(t,t,t)}function sglLookAtM4V(t,e,i){var n=sglNormalizedV3(sglSubV3(e,t)),r=sglNormalizedV3(i),s=sglNormalizedV3(sglCrossV3(n,r));r=sglNormalizedV3(sglCrossV3(s,n));var o=sglUndefM4();return o[0]=s[0],o[1]=r[0],o[2]=-n[0],o[3]=0,o[4]=s[1],o[5]=r[1],o[6]=-n[1],o[7]=0,o[8]=s[2],o[9]=r[2],o[10]=-n[2],o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,o=sglMulM4(o,sglTranslationM4V(sglNegV3(t)))}function sglLookAtM4C(t,e,i,n,r,s,o,l,u){return sglLookAtM4V([t,e,i],[n,r,s],[o,l,u])}function sglOrthoM4V(t,e){var i=sglAddV3(e,t),n=sglSubV3(e,t),r=sglUndefM4();return r[0]=2/n[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=2/n[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=-2/n[2],r[11]=0,r[12]=-i[0]/n[0],r[13]=-i[1]/n[1],r[14]=-i[2]/n[2],r[15]=1,r}function sglOrthoM4C(t,e,i,n,r,s){return sglOrthoM4V([t,i,r],[e,n,s])}function sglFrustumM4V(t,e){var i=sglAddV3(e,t),n=sglSubV3(e,t),r=2*t[2],s=sglUndefM4();return s[0]=r/n[0],s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=r/n[1],s[6]=0,s[7]=0,s[8]=i[0]/n[0],s[9]=i[1]/n[1],s[10]=-i[2]/n[2],s[11]=-1,s[12]=0,s[13]=0,s[14]=-r*e[2]/n[2],s[15]=0,s}function sglFrustumM4C(t,e,i,n,r,s){return sglFrustumM4V([t,i,r],[e,n,s])}function sglPerspectiveM4(t,e,i,n){var r=sglUndefV4(),s=sglUndefV4();return r[2]=i,s[2]=n,s[1]=r[2]*sglTan(t/2),r[1]=-s[1],s[0]=s[1]*e,r[0]=-s[0],sglFrustumM4V(r,s)}function sglUndefQuat(t){return new Array(4)}function sglQuatV(t){return t.slice(0,4)}function sglIdentityQuat(){return[0,0,0,1]}function sglAngleAxisQuat(t,e){var i=t/2,n=sglSin(i);return[n*e[0],n*e[1],n*e[2],sglCos(i)]}function sglM4Quat(t){var e=sglGetElemM4(t,0,0)+sglGetElemM4(t,1,1)+sglGetElemM4(t,2,2),i=null,n=sglUndefQuat();if(e>0)i=sglSqrt(e+1),n[3]=i/2,i=.5/i,n[0]=(sglGetElemM4(t,2,1)-sglGetElemM4(t,1,2))*i,n[1]=(sglGetElemM4(t,0,2)-sglGetElemM4(t,2,0))*i,n[2]=(sglGetElemM4(t,1,0)-sglGetElemM4(t,0,1))*i;else{var r=0;sglGetElemM4(t,1,1)>sglGetElemM4(t,0,0)&&(r=1),sglGetElemM4(t,2,2)>sglGetElemM4(t,r,r)&&(r=2);var s=(r+1)%3,o=(s+1)%3;i=sglSqrt(sglGetElemM4(t,r,r)-sglGetElemM4(t,s,s)-sglGetElemM4(t,o,o)+1),n[r]=i/2,i=.5/i,n[3]=(sglGetElemM4(t,o,s)-sglGetElemM4(t,s,o))*i,n[s]=(sglGetElemM4(t,s,r)+sglGetElemM4(t,r,s))*i,n[o]=(sglGetElemM4(t,o,r)+sglGetElemM4(t,r,o))*i}return n}function sglGetQuatAngleAxis(t){var e=new Array(4),i=sglSqLengthV4(t);if(i>0){var n=1/sglSqrt(i);e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=2*aglAcos(t[3])}else e[0]=0,e[1]=0,e[2]=1,e[3]=0;return e}function sglGetQuatRotationM4(t){var e=2*t[0],i=2*t[1],n=2*t[2],r=e*t[3],s=i*t[3],o=n*t[3],l=e*t[0],u=i*t[0],a=n*t[0],h=i*t[1],g=n*t[1],f=n*t[2],c=sglIdentityM4();return sglSetElemM4(c,0,0,1-(h+f)),sglSetElemM4(c,0,1,u-o),sglSetElemM4(c,0,2,a+s),sglSetElemM4(c,1,0,u+o),sglSetElemM4(c,1,1,1-(l+f)),sglSetElemM4(c,1,2,g-r),sglSetElemM4(c,2,0,a-s),sglSetElemM4(c,2,1,g+r),sglSetElemM4(c,2,2,1-(l+h)),c}function sglNormalizedQuat(t){return sglNormalizedV4(t)}function sglMulQuat(t,e){var i=sglUndefQuat();i[0]=p[3]*q[0]+p[0]*q[3]+p[1]*q[2]-p[2]*q[1],i[1]=p[3]*q[1]+p[1]*q[3]+p[2]*q[0]-p[0]*q[2],i[2]=p[3]*q[2]+p[2]*q[3]+p[0]*q[1]-p[1]*q[0],i[3]=p[3]*q[3]-p[0]*q[0]-p[1]*q[1]-p[2]*q[2]}function SglVec2(){this.v=new Array(2);var t=arguments.length;switch(t){case 1:arguments[0]instanceof Array?this.setVec(arguments[0]):arguments[0]instanceof SglVec2?this.setVec(arguments[0].v):this.setScalar(arguments[0]);break;case 2:this.setVec(arguments);break;default:this.setZero()}}function SglVec3(){this.v=new Array(3);var t=arguments.length;switch(t){case 1:arguments[0]instanceof Array?this.setVec(arguments[0]):arguments[0]instanceof SglVec3?this.setVec(arguments[0].v):this.setScalar(arguments[0]);break;case 3:this.setVec(arguments);break;default:this.setZero()}}function SglVec4(){this.v=new Array(4);var t=arguments.length;switch(t){case 1:arguments[0]instanceof Array?this.setVec(arguments[0]):arguments[0]instanceof SglVec4?this.setVec(arguments[0].v):this.setScalar(arguments[0]);break;case 4:this.setVec(arguments);break;default:this.setZero()}}function SglPlane3(t,e,i){this._normal=[0,0,1],this._offset=0,t&&e&&this.setup(t,e,i)}function SglBox3(t,e){this._min=[1,1,1],this._max=[-1,-1,-1],t&&e&&this.setup(t,e)}function SglSphere3(t,e){this._center=[0,0,0],this._radius=-1,t&&e&&this.setup(t,e)}function SglMatrixStack(){this._s=[],this._s.push(sglIdentityM4()),this._n=0}function SglTransformStack(){this._ms=new SglMatrixStack,this._vs=new SglMatrixStack,this._ps=new SglMatrixStack}function _SglFrustumPlane(){this.normal=[0,0,1],this.offset=0,this.testVertex=[0,0,0]}SglVec2.prototype={clone:function(){return new SglVec2(this)},get copy(){return this.clone()},get x(){return this.v[0]},set x(t){this.v[0]=t},get y(){return this.v[1]},set y(t){this.v[1]=t},set:function(t,e){return this.v[0]=t,this.v[1]=e,this},setVec:function(t){return this.set(t[0],t[1])},setScalar:function(t){return this.set(t,t)},setZero:function(){return this.setScalar(0)},setOne:function(){return this.setScalar(1)},at:function(t){return this.v[t]},get squaredLength(){return this.dot(this)},get length(){return sglSqrt(this.squaredLength)},normalize:function(){var t=this.length;return t>0&&(t=1/t),this.v[0]*=t,this.v[1]*=t,this},get normalized(){return this.clone().normalize()},get neg(){return new SglVec2(-this.v[0],-this.v[1])},get abs(){return new SglVec2(sglAbs(this.v[0]),sglAbs(this.v[1]))},get minComp(){var t=this.v[0];return t>this.v[1]&&(t=this.v[1]),t},get maxComp(){var t=this.v[0];return t<this.v[1]&&(t=this.v[1]),t},get argMin(){var t=0;return this.v[t]>this.v[1]&&(t=1),t},get argMax(){var t=0;return this.v[t]>this.v[1]&&(t=1),t},add:function(t){return new SglVec2(this.v[0]+t.v[0],this.v[1]+t.v[1])},sub:function(t){return new SglVec2(this.v[0]-t.v[0],this.v[1]-t.v[1])},mul:function(t){return new SglVec2(this.v[0]*t.v[0],this.v[1]*t.v[1])},div:function(t){return new SglVec2(this.v[0]/t.v[0],this.v[1]/t.v[1])},get rcp(){return new SglVec2(1/this.v[0],1/this.v[1])},dot:function(t){return this.v[0]*t.v[0]+this.v[1]*t.v[1]},cross:function(t){return this.v[0]*t.v[1]-this.v[1]*t.v[0]},min:function(t){return new SglVec2(sglMin(this.v[0],t.v[0]),sglMin(this.v[1],t.v[1]))},max:function(t){return new SglVec2(sglMax(this.v[0],t.v[0]),sglMax(this.v[1],t.v[1]))}},SglVec3.prototype={clone:function(){return new SglVec3(this)},get copy(){return this.clone()},get x(){return this.v[0]},set x(t){this.v[0]=t},get y(){return this.v[1]},set y(t){this.v[1]=t},get z(){return this.v[2]},set z(t){this.v[2]=t},set:function(t,e,i){return this.v[0]=t,this.v[1]=e,this.v[2]=i,this},setVec:function(t){return this.set(t[0],t[1],t[2])},setScalar:function(t){return this.set(t,t,t)},setZero:function(){return this.setScalar(0)},setOne:function(){return this.setScalar(1)},at:function(t){return this.v[t]},get squaredLength(){return this.dot(this)},get length(){return sglSqrt(this.squaredLength)},normalize:function(){var t=this.length;return t>0&&(t=1/t),this.v[0]*=t,this.v[1]*=t,this.v[2]*=t,this},get normalized(){return this.clone().normalize()},get neg(){return new SglVec3(-this.v[0],-this.v[1],-this.v[2])},get abs(){return new SglVec3(sglAbs(this.v[0]),sglAbs(this.v[1]),sglAbs(this.v[2]))},get minComp(){var t=this.v[0];return t>this.v[1]&&(t=this.v[1]),t>this.v[2]&&(t=this.v[2]),t},get maxComp(){var t=this.v[0];return t<this.v[1]&&(t=this.v[1]),t<this.v[2]&&(t=this.v[2]),t},get argMin(){var t=0;return this.v[t]>this.v[1]&&(t=1),this.v[t]>this.v[2]&&(t=2),t},get argMax(){var t=0;return this.v[t]>this.v[1]&&(t=1),this.v[t]>this.v[2]&&(t=2),t},add:function(t){return new SglVec3(this.v[0]+t.v[0],this.v[1]+t.v[1],this.v[2]+t.v[2])},sub:function(t){return new SglVec3(this.v[0]-t.v[0],this.v[1]-t.v[1],this.v[2]-t.v[2])},mul:function(t){return new SglVec3(this.v[0]*t.v[0],this.v[1]*t.v[1],this.v[2]*t.v[2])},div:function(t){return new SglVec3(this.v[0]/t.v[0],this.v[1]/t.v[1],this.v[2]/t.v[2])},get rcp(){return new SglVec3(1/this.v[0],1/this.v[1],1/this.v[2])},dot:function(t){return this.v[0]*t.v[0]+this.v[1]*t.v[1]+this.v[2]*t.v[2]},cross:function(t){return new SglVec3(this.v[1]*t.v[2]-this.v[2]*t.v[1],this.v[2]*t.v[0]-this.v[0]*t.v[2],this.v[0]*t.v[1]-this.v[1]*t.v[0])},min:function(t){return new SglVec3(sglMin(this.v[0],t.v[0]),sglMin(this.v[1],t.v[1]),sglMin(this.v[2],t.v[2]))},max:function(t){return new SglVec3(sglMax(this.v[0],t.v[0]),sglMax(this.v[1],t.v[1]),sglMax(this.v[2],t.v[2]))}},SglVec4.prototype={clone:function(){return new SglVec4(this)},get copy(){return this.clone()},get x(){return this.v[0]},set x(t){this.v[0]=t},get y(){return this.v[1]},set y(t){this.v[1]=t},get z(){return this.v[2]},set z(t){this.v[2]=t},get w(){return this.v[3]},set w(t){this.v[3]=t},set:function(t,e,i,n){return this.v[0]=t,this.v[1]=e,this.v[2]=i,this.v[3]=n,this},setVec:function(t){return this.set(t[0],t[1],t[2],t[3])},setScalar:function(t){return this.set(t,t,t,t)},setZero:function(){return this.setScalar(0)},setOne:function(){return this.setScalar(1)},at:function(t){return this.v[t]},get squaredLength(){return this.dot(this)},get length(){return sglSqrt(this.squaredLength)},normalize:function(){var t=this.length;return t>0&&(t=1/t),this.v[0]*=t,this.v[1]*=t,this.v[2]*=t,this.v[3]*=t,this},get normalized(){return this.clone().normalize()},get neg(){return new SglVec4(-this.v[0],-this.v[1],-this.v[2],-this.v[3])},get abs(){return new SglVec4(sglAbs(this.v[0]),sglAbs(this.v[1]),sglAbs(this.v[2]),sglAbs(this.v[3]))},get minComp(){var t=this.v[0];return t>this.v[1]&&(t=this.v[1]),t>this.v[2]&&(t=this.v[2]),t>this.v[3]&&(t=this.v[3]),t},get maxComp(){var t=this.v[0];return t<this.v[1]&&(t=this.v[1]),t<this.v[2]&&(t=this.v[2]),t<this.v[3]&&(t=this.v[3]),t},get argMin(){var t=0;return this.v[t]>this.v[1]&&(t=1),this.v[t]>this.v[2]&&(t=2),this.v[t]>this.v[3]&&(t=2),t},get argMax(){var t=0;return this.v[t]>this.v[1]&&(t=1),this.v[t]>this.v[2]&&(t=2),this.v[t]>this.v[3]&&(t=2),t},add:function(t){return new SglVec4(this.v[0]+t.v[0],this.v[1]+t.v[1],this.v[2]+t.v[2],this.v[3]+t.v[3])},sub:function(t){return new SglVec4(this.v[0]-t.v[0],this.v[1]-t.v[1],this.v[2]-t.v[2],this.v[3]-t.v[3])},mul:function(t){return new SglVec4(this.v[0]*t.v[0],this.v[1]*t.v[1],this.v[2]*t.v[2],this.v[3]*t.v[3])},div:function(t){return new SglVec4(this.v[0]/t.v[0],this.v[1]/t.v[1],this.v[2]/t.v[2],this.v[3]/t.v[3])},get rcp(){return new SglVec4(1/this.v[0],1/this.v[1],1/this.v[2],1/this.v[3])},dot:function(t){return this.v[0]*t.v[0]+this.v[1]*t.v[1]+this.v[2]*t.v[2]+this.v[3]*t.v[3]},min:function(t){return new SglVec4(sglMin(this.v[0],t.v[0]),sglMin(this.v[1],t.v[1]),sglMin(this.v[2],t.v[2]),sglMin(this.v[3],t.v[3]))},max:function(t){return new SglVec4(sglMax(this.v[0],t.v[0]),sglMax(this.v[1],t.v[1]),sglMax(this.v[2],t.v[2]),sglMax(this.v[3],t.v[3]))}},SglPlane3.prototype={get normal(){return this._normal},set normal(t){this._normal=t.slice(0,3)},get offset(){return this._offset},set offset(t){this._offset=t.slize(0,3)},clone:function(){return new SglPlane3(this._normal,this._offset,!1)},get copy(){return this.clone()},setup:function(t,e,i){if(this._normal[0]=t[0],this._normal[1]=t[1],this._normal[2]=t[2],this._offset=e,normalize){var n=sglSqrt(sglDotV3(this._normal));n>0&&(n=1/n,sglSelfMulV3S(this._normal,n),this._offset*=n)}}},SglBox3.prototype={get min(){return this._min},set min(t){this._min=t.slice(0,3)},get max(){return this._max},set max(t){this._max=t.slice(0,3)},clone:function(){return new SglBox3(this._min,this._max)},get copy(){return this.clone()},setup:function(t,e){for(var i=0;i<3;++i)this._min[i]=t[i],this._max[i]=e[i];return this},get isNull(){return this._min[0]>this._max[0]},get isEmpty(){return this._min[0]==this._max[0]&&this._min[1]==this._max[1]&&this._min[2]==this._max[2]},get center(){return sglSelfMulV3S(sglAddV3(this._min,this._max),.5)},get size(){return sglSubV3(this._max,this._min)},get squaredDiagonal(){var t=this.size;return sglDotV3(t,t)},get diagonal(){return sglSqrt(this.squaredDiagonal)},get facesAreas(){var t=this.size;return[t[1]*t[2],t[0]*t[2],t[0]*t[1]]},get surfaceArea(){var t=this.facesArea;return 2*(t[0]+t[1]+t[2])},get volume(){var t=this.size;return t[0]*t[1]*t[2]},offset:function(t){return sglSelfSubV3S(this._min[i],t),sglSelfAddV3S(this._max[i],t),this},corner:function(t){var e=this.size;return[this._min[0]+(t%2!=0?1:0)*e[0],this._min[1]+(t/2%2!=0?1:0)*e[1],this._min[2]+(t>3!=0?1:0)*e[2]]},transformed:function(t){var e=new SglBox3,i=sglMulM4V3(t,this.corner(0),1);e.min=i,e.max=i;for(var n=1;n<8;++n)i=sglMulM4V3(t,this.corner(n),1),e.min=sglMinV3(e.min,i),e.max=sglMaxV3(e.max,i);return e},addPoint:function(t){return this.isNull?(this.min=t,this.max=t):(this.min=sglMinV3(this.min,t),this.max=sglMaxV3(this.min,t)),this},addBox:function(t){return t.isNull||(this.isNull?(this.min=t.min,this.max=t.max):(this.min=sglMinV3(this.min,t.min),this.max=sglMaxV3(this.max,t.max))),this}},SglSphere3.prototype={get center(){return this._center},set center(t){this._center=t.slice(0,3)},get radius(){return this._redius},set radius(t){this._radius=t},clone:function(){return new SglSphere3(this._center,this._radius)},get copy(){return this.clone()},setup:function(t,e){return this._center[0]=t[0],this._center[1]=t[1],this._center[2]=t[2],this._radius=e,this},get isNull(){return this._radius<0},get isEmpty(){return 0==this._radius},get surfaceArea(){return 4*SGL_PI*this._radius*this._radius},get volume(){return 4/3*SGL_PI*this._radius*this._radius*this._radius}},SglMatrixStack.prototype={clone:function(){var t=new SglMatrixStack;t.s=[];for(var e=0;e<this._n+1;++e)t._s.push(sglDupM4(this._s[e]));return t},get copy(){return this.clone()},reset:function(){return this._s=[],this._s.push(sglIdentityM4()),this._n=0,this},get size(){return this._n+1},get top(){return sglDupM4(this._s[this._n])},get topRef(){return this._s[this._n]},push:function(){return this._s.push(sglDupM4(this._s[this._n])),this._n++,this},pop:function(){return this._n>0&&(this._s.pop(),this._n--),this},load:function(t){return this._s[this._n]=sglDupM4(t),this},multiply:function(t){return this._s[this._n]=sglMulM4(this._s[this._n],t),this},loadIdentity:function(){return this._s[this._n]=sglIdentityM4(),this},translate:function(t,e,i){return this.multiply(sglTranslationM4C(t,e,i))},rotate:function(t,e,i,n){return this.multiply(sglRotationAngleAxisM4C(t,e,i,n))},scale:function(t,e,i){return this.multiply(sglScalingM4C(t,e,i))},lookAt:function(t,e,i,n,r,s,o,l,u){return this.multiply(sglLookAtM4C(t,e,i,n,r,s,o,l,u))},ortho:function(t,e,i,n,r,s){return this.multiply(sglOrthoM4C(t,e,i,n,r,s))},frustum:function(t,e,i,n,r,s){return this.multiply(sglFrustumM4C(t,e,i,n,r,s))},perspective:function(t,e,i,n){return this.multiply(sglPerspectiveM4(t,e,i,n))}},SglTransformStack.prototype={clone:function(){var t=new SglTransformStack;return t._ms=this._ms.clone(),t._vs=this._vs.clone(),t._ps=this._ps.clone(),t},get copy(){return this.clone()},reset:function(){return this._ms.reset(),this._vs.reset(),this._ps.reset(),this},get model(){return this._ms},get view(){return this._vs},get projection(){return this._ps},get modelMatrix(){return this.model.top},get modelMatrixRef(){return this.model.topRef},get modelMatrixTranspose(){return sglTransposeM4(this.modelMatrixRef)},get modelMatrixInverse(){return sglInverseM4(this.modelMatrixRef)},get modelMatrixInverseTranspose(){return sglTransposeM4(this.modelMatrixInverse)},get viewMatrix(){return this.view.top},get viewMatrixRef(){return this.view.topRef},get viewMatrixTranspose(){return sglTransposeM4(this.viewMatrixRef)},get viewMatrixInverse(){return sglInverseM4(this.viewMatrixRef)},get viewMatrixInverseTranspose(){return sglTransposeM4(this.viewMatrixInverse)},get projectionMatrix(){return this.projection.top},get projectionMatrixRef(){return this.projection.topRef},get projectionMatrixTranspose(){return sglTransposeM4(this.projectionMatrixRef)},get projectionMatrixInverse(){return sglInverseM4(this.projectionMatrixRef)},get projectionMatrixInverseTranspose(){return sglTransposeM4(this.projectionMatrixInverse)},get modelViewMatrix(){return sglMulM4(this.viewMatrixRef,this.modelMatrixRef)},get modelViewMatrixTranspose(){return sglTransposeM4(this.modelViewMatrix)},get modelViewMatrixInverse(){return sglInverseM4(this.modelViewMatrix)},get modelViewMatrixInverseTranspose(){return sglTransposeM4(this.modelViewMatrixInverse)},get viewProjectionMatrix(){return sglMulM4(this.projectionMatrixRef,this.viewMatrixRef)},get viewProjectionMatrixTranspose(){return sglTransposeM4(this.viewProjectionMatrix)},get viewProjectionMatrixInverse(){return sglInverseM4(this.viewProjectionMatrix)},get viewProjectionMatrixInverseTranspose(){return sglTransposeM4(this.viewProjectionMatrixInverse)},get modelViewProjectionMatrix(){return sglMulM4(this.projectionMatrixRef,sglMulM4(this.viewMatrixRef,this.modelMatrixRef))},get modelViewProjectionMatrixTranspose(){return sglTransposeM4(this.modelViewProjectionMatrix)},get modelViewProjectionMatrixInverse(){return sglInverseM4(this.modelViewProjectionMatrix)},get modelViewProjectionMatrixInverseTranspose(){return sglTransposeM4(this.modelViewProjectionMatrixInverse)},get worldSpaceNormalMatrix(){return sglM4toM3(this.modelMatrixInverseTranspose)},get viewSpaceNormalMatrix(){return sglM4toM3(this.modelViewMatrixInverseTranspose)},get modelSpaceViewerPosition(){return sglV4toV3(sglGetColM4(this.modelViewMatrixInverse,3))},get modelSpaceViewDirection(){return sglNegV3(sglV4toV3(sglGetRowM4(this.modelViewMatrix,2)))},get worldSpaceViewerPosition(){return sglV4toV3(sglGetColM4(this.viewMatrixInverse,3))},get worldSpaceViewDirection(){return ssglNegV3(sglV4toV3(sglGetRowM4(this.viewMatrixRef,2)))}},_SglFrustumPlane.prototype={setup:function(t,e,i,n){var r=1/sglSqrt(t*t+e*e+i*i);this.normal[0]=t*r,this.normal[1]=e*r,this.normal[2]=i*r,this.offset=n*r,this.testVertex[0]=this.normal[0]>=0?1:0,this.testVertex[1]=this.normal[1]>=0?1:0,this.testVertex[2]=this.normal[2]>=0?1:0}};var SGL_OUTSIDE_FRUSTUM=0,SGL_INTERSECT_FRUSTUM=1,SGL_INSIDE_FRUSTUM=2;function SglFrustum(t,e,i){this._mvpMatrix=sglIdentityM4(),this._viewport=[0,0,1,1],this._vp=[0,0,1,1],this._billboardMatrix=sglIdentityM4(),this._planes=new Array(6);for(var n=0;n<6;++n)this._planes[n]=new _SglFrustumPlane;t&&e&&i&&this.setup(t,e,i)}function sglBoxVisibility(t,e,i){return new SglFrustum(t).boxVisibility(e,i)}function _sglConsolidateOptions(t,e){if(e)for(var i in e)t[i]=e[i];return t}function sglGetBufferOptions(t,e){return _sglConsolidateOptions({usage:t.STATIC_DRAW},e)}function SglBufferInfo(){this.handle=null,this.valid=!1,this.target=0,this.size=0,this.usage=0}function sglBufferFromData(t,e,i,n){var r=sglGetBufferOptions(t,n),s=t.createBuffer();t.bindBuffer(e,s),t.bufferData(e,i,r.usage),t.bindBuffer(e,null);var o=new SglBufferInfo;return o.handle=s,o.valid=!0,o.target=e,o.size=i.sizeInBytes,o.usage=r.usage,o}function sglVertexBufferFromData(t,e,i){return sglBufferFromData(t,t.ARRAY_BUFFER,e,i)}function sglIndexBufferFromData(t,e,i){return sglBufferFromData(t,t.ELEMENT_ARRAY_BUFFER,e,i)}function SglShaderInfo(){this.handle=null,this.valid=!1,this.type=0,this.log=""}function sglShaderFromSource(t,e,i){var n="";n+="----------------------\n";var r=t.createShader(e);t.shaderSource(r,i),t.compileShader(r),n+="[SHADER LOG]\n";var s=!0;0!=t.getShaderParameter(r,t.COMPILE_STATUS)?n+="SUCCESS:\n":(s=!1,n+="FAIL:\n"),n+=t.getShaderInfoLog(r),n+="\n",n+="----------------------\n";var o=new SglShaderInfo;return o.handle=r,o.valid=s,o.type=e,o.log=n,o}function sglVertexShaderFromSource(t,e){return sglShaderFromSource(t,t.VERTEX_SHADER,e)}function sglFragmentShaderFromSource(t,e){return sglShaderFromSource(t,t.FRAGMENT_SHADER,e)}function SglProgramAttributeInfo(){this.name="",this.nativeType=0,this.size=0,this.location=-1}function SglProgramUniformInfo(){this.name="",this.nativeType=0,this.size=0,this.location=-1}function SglProgramSamplerInfo(){this.name="",this.nativeType=0,this.size=0,this.location=-1}function SglProgramInfo(){this.handle=null,this.valid=!1,this.shaders=[],this.attributes=new Object,this.uniforms=new Object,this.samplers=new Object,this.log=""}function sglProgramFromShaders(t,e){var i="";i+="----------------------\n";var n=t.createProgram();for(var r in e){var s=e[r];t.attachShader(n,s.handle)}t.linkProgram(n);var o=!0;i+="[PROGRAM LOG]\n",i+=(o=o&&0!=t.getProgramParameter(n,t.LINK_STATUS))?"SUCCESS:\n":"FAIL:\n",i+=t.getProgramInfoLog(n),i+="\n",i+="----------------------\n";var l=new SglProgramInfo;for(var r in l.handle=n,l.valid=o,e){s=e[r];l.shaders.push(s)}l.log=i;for(var u,a,h=t.getProgramParameter(n,t.ACTIVE_ATTRIBUTES),g=0;g<h;++g)(u=t.getActiveAttrib(n,g))&&((a=new SglProgramAttributeInfo).name=u.name,a.nativeType=u.type,a.size=u.size,a.location=t.getAttribLocation(n,u.name),l.attributes[a.name]=a);var f,c,_,d=t.getProgramParameter(n,t.ACTIVE_UNIFORMS);for(g=0;g<d;++g)(f=t.getActiveUniform(n,g))&&(c=t.getUniformLocation(n,f.name),f.type==t.SAMPLER_2D||f.type==t.SAMPLER_CUBE||35682==f.type?((r=new SglProgramSamplerInfo).name=f.name,r.nativeType=f.type,r.size=f.size,r.location=c,l.samplers[r.name]=r):((_=new SglProgramUniformInfo).name=f.name,_.nativeType=f.type,_.size=f.size,_.location=c,l.uniforms[_.name]=_));return sglSetDefaultProgramBindings(t,l),l}function sglProgramFromSources(t,e,i){var n=null,r=[];for(var s in e){n=sglVertexShaderFromSource(t,e[s]),r.push(n)}for(var s in i){n=sglFragmentShaderFromSource(t,i[s]),r.push(n)}return sglProgramFromShaders(t,r)}function sglSetDefaultProgramBindings(t,e){var i=e.handle,n=0;for(var r in e.attributes){var s=e.attributes[r];t.bindAttribLocation(i,n,s.name),s.location=n,n++}for(var o in t.linkProgram(i),e.uniforms){var l=e.uniforms[o];l.location=t.getUniformLocation(i,l.name)}t.useProgram(e.handle);var u=0;for(var a in e.samplers){var h=e.samplers[a];h.location=t.getUniformLocation(i,h.name),t.uniform1i(h.location,u),u++}}function sglProgramSynchronize(t,e){var i=e.handle;for(var n in e.attributes){var r=e.attributes[n];r.location=t.getAttribLocation(i,r.name)}for(var s in e.uniforms){var o=e.uniforms[s];o.location=t.getUniformLocation(i,o.name)}for(var l in e.samplers){var u=e.samplers[l];u.location=t.getUniformLocation(i,u.name)}}function sglGetTextureOptions(t,e){return _sglConsolidateOptions({minFilter:t.LINEAR,magFilter:t.LINEAR,wrapS:t.CLAMP_TO_EDGE,wrapT:t.CLAMP_TO_EDGE,isDepth:!1,depthMode:t.LUMINANCE,depthCompareMode:t.COMPARE_R_TO_TEXTURE,depthCompareFunc:t.LEQUAL,generateMipmap:!1,flipY:!0,premultiplyAlpha:!1,onload:null},e)}function SglTextureInfo(){this.handle=null,this.valid=!1,this.target=0,this.format=0,this.width=0,this.height=0,this.minFilter=0,this.magFilter=0,this.wrapS=0,this.wrapT=0,this.isDepth=!1,this.depthMode=0,this.depthCompareMode=0,this.depthCompareFunc=0}function sglTexture2DFromData(t,e,i,n,r,s,o,l){var u=sglGetTextureOptions(t,l);o||(o=s==t.FLOAT?new Float32Array(i*n*4):new Uint8Array(i*n*4));var a=t.createTexture();t.bindTexture(t.TEXTURE_2D,a);var h=t.getParameter(t.UNPACK_FLIP_Y_WEBGL),g=!0===u.flipY;h!=g&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,g?1:0),t.texImage2D(t.TEXTURE_2D,0,e,i,n,0,r,s,o),h!=g&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,h?1:0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,u.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,u.magFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,u.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,u.wrapT),u.isDepth&&(t.texParameteri(t.TEXTURE_2D,t.DEPTH_TEXTURE_MODE,u.depthMode),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_COMPARE_MODE,u.depthCompareMode),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_COMPARE_FUNC,u.depthCompareFunc)),u.generateMipmap&&t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null);var f=new SglTextureInfo;return f.handle=a,f.valid=!0,f.target=t.TEXTURE_2D,f.format=e,f.width=i,f.height=n,f.minFilter=u.minFilter,f.magFilter=u.magFilter,f.wrapS=u.wrapS,f.wrapT=u.wrapT,f.isDepth=u.isDepth,f.depthMode=u.depthMode,f.depthCompareMode=u.depthCompareMode,f.depthCompareFunc=u.depthCompareFunc,f}function sglTexture2DFromImage(t,e,i){var n=sglGetTextureOptions(t,i),r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r);var s=t.getParameter(t.UNPACK_FLIP_Y_WEBGL),o=!0===n.flipY;s!=o&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,o?1:0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),s!=o&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,s?1:0),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,n.minFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,n.magFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,n.wrapS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,n.wrapT),n.generateMipmap&&t.generateMipmap(t.TEXTURE_2D),t.bindTexture(t.TEXTURE_2D,null);var l=new SglTextureInfo;return l.handle=r,l.valid=!0,l.target=t.TEXTURE_2D,l.format=t.RGBA,l.width=e.width,l.height=e.height,l.minFilter=n.minFilter,l.magFilter=n.magFilter,l.wrapS=n.wrapS,l.wrapT=n.wrapT,l.isDepth=!1,l.depthMode=0,l.depthCompareMode=0,l.depthCompareFunc=0,l}function sglTexture2DFromUrl(t,e,i){var n=sglGetTextureOptions(t,i),r=new SglTextureInfo,s=new Image;return s.crossOrigin="",s.onload=function(){var i=sglTexture2DFromImage(t,s,n);for(var o in i)r[o]=i[o];n.onload&&n.onload(t,r,e)},s.src=e,r}function sglTextureCubeFromData(t,e,i,n,r,s,o,l){var u=sglGetTextureOptions(t,l);if(!o){var a=null;a=s==t.FLOAT?new Float32Array(i*n*4):new Uint8Array(i*n*4),o=new Array(6);for(var h=0;h<6;++h)o[h]=a}var g=t.createTexture();t.bindTexture(t.TEXTURE_CUBE_MAP,g);var f=t.getParameter(t.UNPACK_FLIP_Y_WEBGL),c=!0===u.flipY;f!=c&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,c?1:0);for(h=0;h<6;++h)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+h,0,e,i,n,0,r,s,o[h]);f!=c&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,f?1:0),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,u.minFilter),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,u.magFilter),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,u.wrapS),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,u.wrapT),u.isDepth&&(t.texParameteri(t.TEXTURE_CUBE_MAP,t.DEPTH_TEXTURE_MODE,u.depthMode),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_COMPARE_MODE,u.depthCompareMode),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_COMPARE_FUNC,u.depthCompareFunc)),u.generateMipmap&&t.generateMipmap(t.TEXTURE_CUBE_MAP),t.bindTexture(t.TEXTURE_CUBE_MAP,null);var _=new SglTextureInfo;return _.handle=g,_.valid=!0,_.target=t.TEXTURE_CUBE_MAP,_.format=e,_.width=i,_.height=n,_.minFilter=u.minFilter,_.magFilter=u.magFilter,_.wrapS=u.wrapS,_.wrapT=u.wrapT,_.isDepth=u.isDepth,_.depthMode=u.depthMode,_.depthCompareMode=u.depthCompareMode,_.depthCompareFunc=u.depthCompareFunc,_}function sglTextureCubeFromImages(t,e,i){var n=sglGetTextureOptions(t,i),r=t.createTexture();t.bindTexture(t.TEXTURE_CUBE_MAP,r);var s=t.getParameter(t.UNPACK_FLIP_Y_WEBGL),o=!0===n.flipY;s!=o&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,o?1:0);for(var l=0;l<6;++l)t.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e[l]);s!=o&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,s?1:0),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MIN_FILTER,n.minFilter),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_MAG_FILTER,n.magFilter),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_S,n.wrapS),t.texParameteri(t.TEXTURE_CUBE_MAP,t.TEXTURE_WRAP_T,n.wrapT),n.generateMipmap&&t.generateMipmap(t.TEXTURE_CUBE_MAP),t.bindTexture(t.TEXTURE_CUBE_MAP,null);var u=new SglTextureInfo;return u.handle=r,u.valid=!0,u.target=t.TEXTURE_CUBE_MAP,u.format=t.RGBA,u.width=e[0].width,u.height=e[0].height,u.minFilter=n.minFilter,u.magFilter=n.magFilter,u.wrapS=n.wrapS,u.wrapT=n.wrapT,u.isDepth=!1,u.depthMode=0,u.depthCompareMode=0,u.depthCompareFunc=0,u}function sglTextureCubeFromUrls(t,e,i){for(var n=sglGetTextureOptions(t,i),r=new SglTextureInfo,s=6,o=new Array(6),l=0;l<6;++l)o[l]=new Image,o[l].crossOrigin="";var u=function(){if(0==--s){var i=sglTextureCubeFromImages(t,o,n);for(var l in i)r[l]=i[l];n.onload&&n.onload(t,r,e)}};for(l=0;l<6;++l)o[l].onload=u,o[l].src=e[l];return r}function SglRenderbufferInfo(){this.handle=null,this.valid=!1,this.target=0,this.format=0,this.width=0,this.height=0}function sglRenderbufferFromFormat(t,e,i,n){var r=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,r),t.renderbufferStorage(t.RENDERBUFFER,e,i,n),t.bindRenderbuffer(t.RENDERBUFFER,null);var s=new SglRenderbufferInfo;return s.handle=r,s.valid=!0,s.target=t.RENDERBUFFER,s.format=e,s.width=i,s.height=n,s}function sglGetFramebufferOptions(t,e){return _sglConsolidateOptions({minFilter:t.LINEAR,magFilter:t.LINEAR,wrapS:t.CLAMP_TO_EDGE,wrapT:t.CLAMP_TO_EDGE,isDepth:!1,depthMode:t.LUMINANCE,depthCompareMode:t.COMPARE_R_TO_TEXTURE,depthCompareFunc:t.LEQUAL,colorsAsRenderbuffer:!1,depthAsRenderbuffer:!1,stencilAsRenderbuffer:!1,generateColorsMipmap:!1,generateDepthMipmap:!1,generateStencilMipmap:!1},e)}function SglFramebufferInfo(){this.handle=null,this.valid=!1,this.width=0,this.height=0,this.colorTargets=[],this.depthTarget=null,this.stencilTarget=null,this.status=0}function sglFramebufferFromTargets(t,e,i,n,r){sglGetFramebufferOptions(t,r);var s=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,s),null!=i&&null!=i&&i!=t.NONE&&(i.target==t.TEXTURE_2D?t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,i.handle,0):i.target==t.RENDERBUFFER&&t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i.handle)),null!=n&&null!=n&&n!=t.NONE&&(n.target==t.TEXTURE_2D?t.framebufferTexture2D(t.FRAMEBUFFER,t.STENCIL_ATTACHMENT,t.TEXTURE_2D,n.handle,0):n.target==t.RENDERBUFFER&&t.framebufferRenderbuffer(t.FRAMEBUFFER,t.STENCIL_ATTACHMENT,t.RENDERBUFFER,n.handle));var o=[],l=[];if(null!=e&&null!=e)if(0==e.length)l.push(t.NONE);else{var u=t.COLOR_ATTACHMENT0;for(var a in e){var h=e[a];h.target==t.TEXTURE_2D?t.framebufferTexture2D(t.FRAMEBUFFER,u,t.TEXTURE_2D,h.handle,0):h.target==t.RENDERBUFFER&&t.framebufferRenderbuffer(t.FRAMEBUFFER,u,t.RENDERBUFFER,h.handle),l.push(u),o.push(h),u++}}var g=t.checkFramebufferStatus(t.FRAMEBUFFER);t.bindFramebuffer(t.FRAMEBUFFER,null);var f=null;o.length>0?f=o[0]:i?f=i:n&&(f=n);var c=0,_=0;f&&(c=f.width,_=f.height);var d=new SglFramebufferInfo;return d.handle=s,d.valid=g==t.FRAMEBUFFER_COMPLETE,d.width=c,d.height=_,d.colorTargets=o,d.depthTarget=i||null,d.stencilTarget=n||null,d.status=g,d}function sglFramebufferFromFormats(t,e,i,n,r,s,o){var l=sglGetFramebufferOptions(t,o),u=null;if(n){l.isDepth=!1,u=[];var a=null;if(l.colorsAsRenderbuffer)for(var h in n){a=sglRenderbufferFromFormat(t,n[h],e,i),u.push(a)}else for(var h in l.generateMipmap=l.generateColorsMipmap,n){a=sglTexture2DFromData(t,n[h],e,i,t.RGBA,t.UNSIGNED_BYTE,null,l),u.push(a)}}var g=null;r&&(l.isDepth=!0,l.depthAsRenderbuffer?g=sglRenderbufferFromFormat(t,r,e,i):(l.generateMipmap=l.generateDepthMipmap,g=sglTexture2DFromData(t,r,e,i,t.DEPTH_COMPONENT,t.FLOAT,null,l)));var f=null;return s&&(l.isDepth=!1,l.stencilAsRenderbuffer?f=sglRenderbufferFromFormat(t,s,e,i):(l.generateMipmap=l.generateStencilMipmap,f=sglTexture2DFromData(t,s,e,i,t.STENCIL_COMPONENT,t.UNSIGNED_BYTE,null,l))),sglFramebufferFromTargets(t,u,g,f,l)}function SglVertexBuffer(){this.gl=arguments[0],this._info=null,this._info=arguments[1]instanceof SglBufferInfo?arguments[1]:sglVertexBufferFromData(this.gl,arguments[1],arguments[2])}function SglIndexBuffer(){this.gl=arguments[0],this._info=null,this._info=arguments[1]instanceof SglBufferInfo?arguments[1]:sglIndexBufferFromData(this.gl,arguments[1],arguments[2])}function SglProgramAttribute(t,e){this._prog=t,this._info=e}function SglProgramUniform(t,e){this._prog=t,this._info=e,this._func=null;var i=this._prog.gl,n=this._info.nativeType;n==i.BOOL?this._func=function(t){this._prog.gl.uniform1i(this._info.location,t)}:n==i.BOOL_VEC2?this._func=function(t){this._prog.gl.uniform2iv(this._info.location,t)}:n==i.BOOL_VEC3?this._func=function(t){this._prog.gl.uniform3iv(this._info.location,t)}:n==i.BOOL_VEC4?this._func=function(t){this._prog.gl.uniform4iv(this._info.location,t)}:n==i.INT?this._func=function(t){this._prog.gl.uniform1i(this._info.location,t)}:n==i.INT_VEC2?this._func=function(t){this._prog.gl.uniform2iv(this._info.location,t)}:n==i.INT_VEC3?this._func=function(t){this._prog.gl.uniform3iv(this._info.location,t)}:n==i.INT_VEC4?this._func=function(t){this._prog.gl.uniform4iv(this._info.location,t)}:n==i.FLOAT?this._func=function(t){this._prog.gl.uniform1f(this._info.location,t)}:n==i.FLOAT_VEC2?this._func=function(t){this._prog.gl.uniform2fv(this._info.location,t)}:n==i.FLOAT_VEC3?this._func=function(t){this._prog.gl.uniform3fv(this._info.location,t)}:n==i.FLOAT_VEC4?this._func=function(t){this._prog.gl.uniform4fv(this._info.location,t)}:n==i.FLOAT_MAT2?this._func=function(t){this._prog.gl.uniformMatrix2fv(this._info.location,this._prog.gl.FALSE,t)}:n==i.FLOAT_MAT3?this._func=function(t){this._prog.gl.uniformMatrix3fv(this._info.location,this._prog.gl.FALSE,t)}:n==i.FLOAT_MAT4?this._func=function(t){this._prog.gl.uniformMatrix4fv(this._info.location,this._prog.gl.FALSE,t)}:sglUnknown()}function SglProgramSampler(t,e){this._prog=t,this._info=e,this._unit=-1;var i=this._prog.gl,n=this._info.nativeType;n==i.SAMPLER_2D||n==i.SAMPLER_CUBE||35682==n||sglUnknown()}function SglProgram(){for(var t in this.gl=arguments[0],this._info=null,this._info=arguments[1]instanceof SglProgramInfo?arguments[1]:sglProgramFromSources(this.gl,arguments[1],arguments[2]),this._attributes=new Object,this._info.attributes)this._attributes[t]=new SglProgramAttribute(this,this._info.attributes[t]);for(var e in this._uniforms=new Object,this._info.uniforms)this._uniforms[e]=new SglProgramUniform(this,this._info.uniforms[e]);var i=0;for(var n in this._samplers=new Object,this._info.samplers)this._samplers[n]=new SglProgramSampler(this,this._info.samplers[n]),this._samplers[n]._unit=i,i++}function SglTexture2D(){this.gl=arguments[0],this._info=null;var t=this.gl,e=arguments.length;2==e||3==e?arguments[1]instanceof Image?this._info=sglTexture2DFromImage(t,arguments[1],arguments[2]):this._info="string"==typeof arguments[1]?sglTexture2DFromUrl(t,arguments[1],arguments[2]):arguments[1]:this._info=sglTexture2DFromData(t,arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}function SglTextureCube(){this.gl=arguments[0],this._info=null;var t=this.gl,e=arguments.length;2==e||3==e?arguments[1]instanceof Array?arguments[1][0]instanceof Image?this._info=sglTextureCubeFromImages(t,arguments[1],arguments[2]):"string"==typeof arguments[1][0]&&(this._info=sglTextureCubeFromUrls(t,arguments[1],arguments[2])):this._info=arguments[1]:this._info=sglTextureCubeFromData(t,arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6],arguments[7])}function SglRenderbuffer(){this.gl=arguments[0],this._info=null;var t=this.gl,e=arguments.length;this._info=2==e?arguments[1]:sglRenderbufferFromFormat(t,arguments[1],arguments[2],arguments[3])}function SglFramebuffer(){this.gl=arguments[0],this._info=null;var t=this.gl,e=arguments.length;this._info=2==e?arguments[1]:sglFramebufferFromFormats(t,arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6]);var i=null,n=null;for(var r in this._colorTargets=[],this._info.colorTargets)n=null,(i=this._info.colorTargets[r]).target==t.TEXTURE_2D?n=new SglTexture2D(t,i):i.target==t.RENDERBUFFER&&(n=new SglRenderbuffer(t,i)),this._colorTargets.push(n);this._depthTarget=null,this._info.depthTarget&&(n=null,(i=this._info.depthTarget).target==t.TEXTURE_2D?n=new SglTexture2D(t,i):i.target==t.RENDERBUFFER&&(n=new SglRenderbuffer(t,i)),this._depthTarget=n),this._stencilTarget=null,this._info.stencilTarget&&(n=null,(i=this._info.stencilTarget).target==t.TEXTURE_2D?n=new SglTexture2D(t,i):i.target==t.RENDERBUFFER&&(n=new SglRenderbuffer(t,i)),this._stencilTarget=n)}function SglAttributeStreamJS(t,e,i,n){this._name=t,this._size=e,this._buff=n?i?i.slice():null:i}function SglVertexStreamJS(){this._attribs={},this._length=0}SglFrustum.prototype={setup:function(t,e,i){var n=[sglGetColM4(e,0),sglGetColM4(e,1),sglGetColM4(e,2)],r=[sglLengthV4(n[0]),sglLengthV4(n[1]),sglLengthV4(n[2])],s=sglRcpV3(r),o=sglScalingM4V(r),l=sglScalingM4V(s);n[0]=sglMulV4S(n[0],s[0]),n[1]=sglMulV4S(n[1],s[1]),n[2]=sglMulV4S(n[2],s[2]);var u=sglIdentityM4();sglSetRowM4V(u,0,n[0]),sglSetRowM4V(u,1,n[1]),sglSetRowM4V(u,2,n[2]),this._mvpMatrix=sglMulM4(t,e),this._billboardMatrix=sglMulM4(l,sglMulM4(u,o)),this._viewport=i.slice(0,4),this._vp[0]=.5*this._viewport[2],this._vp[1]=this._viewport[0]+.5*this._viewport[2],this._vp[2]=.5*this._viewport[3],this._vp[3]=this._viewport[1]+.5*this._viewport[3];var a=this._mvpMatrix,h=[a[3],a[7],a[11]];this._planes[0].setup(h[0]-a[0],h[1]-a[4],h[2]-a[8],a[15]-a[12]),this._planes[1].setup(h[0]+a[0],h[1]+a[4],h[2]+a[8],a[15]+a[12]),this._planes[2].setup(h[0]-a[1],h[1]-a[5],h[2]-a[9],a[15]-a[13]),this._planes[3].setup(h[0]+a[1],h[1]+a[5],h[2]+a[9],a[15]+a[13]),this._planes[4].setup(h[0]-a[2],h[1]-a[6],h[2]-a[10],a[15]-a[14]),this._planes[5].setup(h[0]+a[2],h[1]+a[6],h[2]+a[10],a[15]+a[14])},boxVisibility:function(t,e){for(var i=SGL_INSIDE_FRUSTUM,n=[t,e],r=null,s=0;s<6;++s){if((r=this._planes[s]).normal[0]*n[r.testVertex[0]][0]+r.normal[1]*n[r.testVertex[1]][1]+r.normal[2]*n[r.testVertex[2]][2]+r.offset<0)return SGL_OUTSIDE_FRUSTUM;r.normal[0]*n[1-r.testVertex[0]][0]+r.normal[1]*n[1-r.testVertex[1]][1]+r.normal[2]*n[1-r.testVertex[2]][2]+r.offset<0&&(i=SGL_INTERSECT_FRUSTUM)}return i},projectedSegmentSize:function(t,e){var i=.5*e,n=sglV3toV4(t,0),r=[-i,0,0,1],s=[i,0,0,1];return r=sglAddV4(r=sglMulM4V4(this._billboardMatrix,r),n),r=sglProjectV4(sglMulM4V4(this._mvpMatrix,r)),s=sglAddV4(s=sglMulM4V4(this._billboardMatrix,s),n),s=sglProjectV4(sglMulM4V4(this._mvpMatrix,s)),this._vp[0]*sglAbs(s[0]-r[0])}},SglVertexBuffer.prototype={get info(){return this._info},destroy:function(){this._info.valid&&this.gl.deleteBuffer(this._info.handle),this._info=null},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this._info.handle)},unbind:function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null)}},SglIndexBuffer.prototype={get info(){return this._info},destroy:function(){this._info.valid&&this.gl.deleteBuffer(this._info.handle),this._info=null},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this._info.handle)},unbind:function(){this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null)}},SglProgramAttribute.prototype={set index(t){this._prog.gl.bindAttribLocation(this._prog._info.handle,t,this._info.name),this._info.location=t},get index(){return this._info.location}},SglProgramUniform.prototype={set value(t){this._func(t)},get value(){return this._prog.gl.getUniform(this._prog._info.handle,this._info.location)}},SglProgramSampler.prototype={set unit(t){this._prog.gl.uniform1i(this._info.location,t),this._unit=t},get unit(){return this._unit}},SglProgram.prototype={get info(){return this._info},get attributes(){return this._attributes},get uniforms(){return this._uniforms},get samplers(){return this._samplers},destroy:function(){if(null!=this._info.valid){var t=this.gl;for(var e in t.deleteProgram(this._info.handle),this._info.shaders)t.deleteShader(this._info.shaders[e].handle);this._attributes=null,this._uniforms=null,this._samplers=null,this._info=null}},get handle(){return this._info.handle},get isValid(){return this._info.valid},get log(){var t="";for(var e in t+="-------------------------------------\n",this._info.shaders)t+=this._info.shaders[e].log;return t+=this._info.log,t+="-------------------------------------\n",t+="\n"},setDefaultBindings:function(){sglSetDefaultProgramBindings(this.gl,this._info)},synchronize:function(){sglProgramSynchronize(this.gl,this._info)},bind:function(){this.gl.useProgram(this._info.handle)},unbind:function(){},setAttributes:function(t){var e=null;for(var i in t)(e=this._attributes[i])&&(e.index=t[i]);this.link()},setUniforms:function(t){var e=null;for(var i in t)(e=this._uniforms[i])&&(e.value=t[i])},setSamplers:function(t){var e=null;for(var i in t)null!=(e=this._samplers[i])&&(e.unit=t[i])}},SglTexture2D.prototype={get info(){return this._info},destroy:function(){null!=this._info.handle&&(this.gl.deleteTexture(this._info.handle),this._info=null)},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(t){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this._info.target,this._info.handle)},unbind:function(t){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this._info.target,null)},generateMipmap:function(){this.gl.generateMipmap(this._info.target)}},SglTextureCube.prototype={get info(){return this._info},destroy:function(){null!=this._info.handle&&(this.gl.deleteTexture(this._info.handle),this._info=null)},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(t){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this._info.target,this._info.handle)},unbind:function(t){this.gl.activeTexture(this.gl.TEXTURE0+t),this.gl.bindTexture(this._info.target,null)},generateMipmap:function(){this.gl.generateMipmap(this._info.target)}},SglRenderbuffer.prototype={get info(){return this._info},destroy:function(){null!=this._info.handle&&(this.gl.deleteRenderbuffer(this._info.handle),this._info=null)},get handle(){return this._info.handle},get isValid(){return this._info.valid},bind:function(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this._info.handle)},unbind:function(){this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null)}},SglFramebuffer.prototype={get info(){return this._info},get colorTargets(){return this._colorTargets},get depthTarget(){return this._depthTarget},get stencilTarget(){return this._stencilTarget},destroy:function(){if(null!=this._info.handle){for(var t in this.gl.deleteFramebuffer(this._info.handle),this._colorTargets){this._colorTargets[t]&&this._colorTargets[t].destroy()}this._depthTarget&&this._depthTarget.destroy(),this._stencilTarget&&this._stencilTarget.destroy(),this._info=null,this.targets=null}},get handle(){return this._info.handle},get isValid(){return this._info.valid},get width(){return this._info.width},get height(){return this._info.height},bind:function(t){var e=!0;null!=t&&(e=t),e&&this.gl.viewport(0,0,this._info.width,this._info.height),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._info.handle)},unbind:function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},bindColor:function(t,e){this._colorTargets[t].bind(e)},unbindColor:function(t,e){this._colorTargets[t].unbind(e)},bindDepth:function(t){this._depthTarget.bind(t)},unbindDepth:function(t){this._depthTarget.unbind(t)},bindStencil:function(t){this._stencilTarget.bind(t)},unbindStencil:function(t){this._stencilTarget.unbind(t)},generateMipmap:function(t,e,i){var n=null;if(t)for(var r in this._colorTargets)(n=this._colorTargets[r])&&n.info.target==this.gl.TEXTURE_2D&&(n.bind(0),n.generateMipmap(),n.unbind(0));e&&(n=this._depthTarget)&&n.info.target==this.gl.TEXTURE_2D&&(n.bind(0),n.generateMipmap(),n.unbind(0)),i&&(n=this._stencilTarget)&&n.info.target==this.gl.TEXTURE_2D&&(n.bind(0),n.generateMipmap(),n.unbind(0))},attachColorTarget:function(t,e){if(!e)return!1;if(t<0||t>=this._colorTargets.length)return!1;if(e.width!=this.width||e.height!=this.height)return!1;var i=this.gl,n=this.gl.COLOR_ATTACHMENT0+t;return e.target==i.TEXTURE_2D?i.framebufferTexture2D(i.FRAMEBUFFER,n,i.TEXTURE_2D,e.handle,0):e.target==i.RENDERBUFFER&&i.framebufferRenderbuffer(i.FRAMEBUFFER,n,i.RENDERBUFFER,e.handle),this._colorTargets[t]=e,!0},detachColorTarget:function(t){if(t<0||t>=this._colorTargets.length)return!1;var e=this._colorTargets[t];if(!e)return!1;var i=this.gl;return e.target==i.TEXTURE_2D?i.framebufferTexture2D(i.FRAMEBUFFER,att,i.TEXTURE_2D,null,0):e.target==i.RENDERBUFFER&&i.framebufferRenderbuffer(i.FRAMEBUFFER,att,i.RENDERBUFFER,null),this._colorTargets[t]=null,!0}},SglAttributeStreamJS.prototype={get name(){return this._name},get size(){return this._size},get buffer(){return this._buff},get length(){return this._buff.length},get:function(t){return this._buff.slice(t*this._size,this._size)},set:function(t,e){for(var i=t*this._size,n=0;n<this._size;++n)this._buff[i++]=e[n];return r}},SglVertexStreamJS.prototype={get attributes(){return this._attribs},get length(){return this._length},addAttribute:function(t,e,i,n){var r=new SglAttributeStreamJS(t,e,i,n);this._attribs[t]=r,this._length=r.length},removeAttribute:function(t){if(this._attribs[t])for(var e in delete this._attribs[t],this._length=0,this._attribs){this._length=this._attribs[e].length;break}}};var SGL_ARRAY_PRIMITIVE_STREAM=1,SGL_INDEXED_PRIMITIVE_STREAM=2,SGL_PACKED_INDEXED_PRIMITIVE_STREAM=3,SGL_POINTS_LIST=1,SGL_LINES_LIST=2,SGL_LINE_STRIP=3,SGL_LINE_LOOP=4,SGL_TRIANGLES_LIST=5,SGL_TRIANGLE_STRIP=6,SGL_TRIANGLE_FAN=7;function SglPrimitiveStreamJS(t,e,i,n){this._name=t,this._mode=e,this._first=i||0,this._length=n||0}function SglArrayPrimitiveStreamJS(t,e,i,n){SglPrimitiveStreamJS.call(this,t,e,i,n),Object.defineProperty(this,"type",{get:function(){return SGL_ARRAY_PRIMITIVE_STREAM}})}function SglIndexedPrimitiveStreamJS(t,e,i,n){SglPrimitiveStreamJS.call(this,t,e,0,i.length),this._buff=n?i?i.slice():null:i,Object.defineProperty(this,"type",{get:function(){return SGL_INDEXED_PRIMITIVE_STREAM}}),Object.defineProperty(this,"buffer",{get:function(){return this._buff}}),Object.defineProperty(this,"length",{get:function(){return this._buff.length}})}function SglConnectivityJS(){this._prims={}}function SglMeshJS(){this._valid=!1,this._vert=new SglVertexStreamJS,this._conn=new SglConnectivityJS}function sglMeshJSImportOBJFromString(t,e){var i=[],n=[],r=[],s=[],o=[],l=[],u=[],a={},h=0,g=null,f=null,c=0,_=0,d=0,v=0,m=0,p=0,S=null,M=!1,E=!1,T=!1,R=e.split("\n");for(var V in R)if("#"!=(g=R[V].replace(/[ \t]+/g," ").replace(/\s\s*$/,""))[0])if("v"==(S=g.split(" "))[0])o.push(parseFloat(S[1])),o.push(parseFloat(S[2])),o.push(parseFloat(S[3]));else if("vt"==S[0])l.push(parseFloat(S[1])),l.push(parseFloat(S[2]));else if("vn"==S[0])u.push(parseFloat(S[1])),u.push(parseFloat(S[2])),u.push(parseFloat(S[3]));else if("f"==S[0]){if(4!=S.length)continue;for(var b=1;b<4;++b){if(!(S[b]in a)){if(1==(f=S[b].split("/")).length)_=c=parseInt(f[0])-1,d=c;else{if(3!=f.length)return!1;c=parseInt(f[0])-1,_=parseInt(f[1])-1,d=parseInt(f[2])-1}v=0,m=0,p=0,3*c+2<o.length&&(M=!0,v=o[3*c+0],m=o[3*c+1],p=o[3*c+2]),i.push(v),i.push(m),i.push(p),v=0,m=0,2*_+1<l.length&&(E=!0,v=l[2*_+0],m=l[2*_+1]),n.push(v),n.push(m),v=0,m=0,p=1,3*d+2<u.length&&(T=!0,v=u[3*d+0],m=u[3*d+1],p=u[3*d+2]),r.push(v),r.push(m),r.push(p),a[S[b]]=h++}s.push(a[S[b]])}}return M&&t.addVertexAttribute("position",3,i,!1),T&&t.addVertexAttribute("normal",3,r,!1),E&&t.addVertexAttribute("texcoord",2,n,!1),s.length>0&&t.addIndexedPrimitives("triangles",SGL_TRIANGLES_LIST,s,!1),!0}function sglMeshJSImportOBJFromURL(t,e,i,n){if(t.isValid=!1,!i){var r=sglLoadFile(e);return t.isValid=sglMeshJSImportOBJFromString(t,r),n&&n(t,e),t.isValid}return sglLoadFile(e,(function(i){t.isValid=sglMeshJSImportOBJFromString(t,i),n&&n(t,e)})),!0}function _sglFindVertexAttributeJSON(t,e){for(var i in t.vertices)if(t.vertices[i].name===e)return t.vertices[i];return null}function _sglFindConnectivityJSON(t,e){for(var i in t.connectivity)if(t.connectivity[i].name===e)return t.connectivity[i];return null}function sglMeshJSImportJSONFromString(t,e){var i=JSON.parse(e);if(!i)return!1;var n=i.mapping,r=null;for(var s in n)if("standard"===n[s].name){r=n[s];break}if(!r)return!1;for(var o in r.attributes){var l=r.attributes[o],u=_sglFindVertexAttributeJSON(i,l.source);if(u){if(u.normalized)for(var a=0,h=u.values.length;a<h;++a)u.values[a]/=255;t.addVertexAttribute(l.semantic,u.size,u.values,!1)}}var g=_sglFindConnectivityJSON(i,r.primitives);return!!g&&(t.addIndexedPrimitives(g.name,SGL_TRIANGLES_LIST,g.indices,!1),!0)}function sglMeshJSImportJSONFromURL(t,e,i,n){if(t.isValid=!1,!i){var r=sglLoadFile(e);return t.isValid=sglMeshJSImportJSONFromString(t,r),n&&n(t,e),t.isValid}return sglLoadFile(e,(function(i){t.isValid=sglMeshJSImportJSONFromString(t,i),n&&n(t,e)})),!0}function sglGLTypeSize(t,e){return e==t.BYTE||e==t.UNSIGNED_BYTE?1:e==t.SHORT||e==t.UNSIGNED_SHORT?2:e==t.INT||e==t.UNSIGNED_INT||e==t.FLOAT?4:null}function sglGLTypeFromWebGLArray(t,e){return e instanceof Int8Array?t.BYTE:e instanceof Uint8Array?t.UNSIGNED_BYTE:e instanceof Int16Array?t.SHORT:e instanceof Uint16Array?t.UNSIGNED_SHORT:e instanceof Int32Array?t.INT:e instanceof Uint32Array?t.UNSIGNED_INT:e instanceof Float32Array?t.FLOAT:null}function SglAttributeStreamGL(t,e,i,n,r){var s=sglGLTypeFromWebGLArray(t,n),o=sglGLTypeSize(t,s)*i;this.gl=t,this._name=e,this._size=i,this._type=s,this._norm=!!r,this._stride=o,this._offset=0,this._length=n.length/i,this._buff=new SglVertexBuffer(t,n,{usage:t.STATIC_DRAW})}function SglVertexStreamGL(t){this.gl=t,this._attribs=new Object,this._length=0}function SglPrimitiveStreamGL(t,e,i,n,r){this.gl=t,this._name=e,this._mode=i,this._first=n||0,this._length=r||0}function SglArrayPrimitiveStreamGL(t,e,i,n,r){SglPrimitiveStreamGL.call(this,t,e,i,n,r),Object.defineProperty(this,"type",{get:function(){return SGL_ARRAY_PRIMITIVE_STREAM}})}function SglIndexedPrimitiveStreamGL(t,e,i,n){SglPrimitiveStreamGL.call(this,t,e,i,0,n.length);var r=sglGLTypeFromWebGLArray(t,n),s=sglGLTypeSize(t,r);this._idxType=r,this._stride=s,this._buff=new SglIndexBuffer(t,n,{usage:t.STATIC_DRAW}),Object.defineProperty(this,"indexType",{get:function(){return this._idxType}}),Object.defineProperty(this,"stride",{get:function(){return this._stride}}),Object.defineProperty(this,"type",{get:function(){return SGL_INDEXED_PRIMITIVE_STREAM}})}function SglPackedIndexedPrimitiveStreamGL(t,e,i,n,r,s){r.length!=s.length&&sglInvalidParameter(),SglPrimitiveStreamGL.call(this,t,e,i,0,n.length);var o=sglGLTypeFromWebGLArray(t,n),l=sglGLTypeSize(t,o);this._idxType=o,this._stride=l,this._buff=new SglIndexBuffer(t,n,{usage:t.STATIC_DRAW}),this._blockStartingVertices=s.slice();var u=this._blockStartingVertices.length;this._blockStartingIndices=r.slice(),this._blockIndicesCount=new Array(u);for(var a=this._blockStartingIndices[0],h=0;h<u-1;++h){var g=this._blockStartingIndices[h+1];this._blockIndicesCount[h]=g-a,a=g}this._blockIndicesCount[u-1]=n.length-a,Object.defineProperty(this,"isPacked",{get:function(){return!0}}),Object.defineProperty(this,"indexType",{get:function(){return this._idxType}}),Object.defineProperty(this,"stride",{get:function(){return this._stride}}),Object.defineProperty(this,"type",{get:function(){return SGL_PACKED_INDEXED_PRIMITIVE_STREAM}}),Object.defineProperty(this,"blocksCount",{get:function(){return this._blockStartingIndices.length}}),Object.defineProperty(this,"blockStartingVertices",{get:function(){return this._blockStartingVertices}}),Object.defineProperty(this,"blockIndicesCount",{get:function(){return this._blockIndicesCount}})}function SglConnectivityGL(t){this.gl=t,this._prims=new Object}function SglMeshGL(t){this.gl=t,this._vert=new SglVertexStreamGL(this.gl),this._conn=new SglConnectivityGL(this.gl)}SglPrimitiveStreamJS.prototype={get type(){},get name(){return this._name},get mode(){return this._mode},get first(){return this._first},get length(){return this._length}},sglInherit(SglArrayPrimitiveStreamJS,SglPrimitiveStreamJS),sglInherit(SglIndexedPrimitiveStreamJS,SglPrimitiveStreamJS),SglConnectivityJS.prototype={get primitives(){return this._prims},addArrayPrimitives:function(t,e,i,n){var r=new SglArrayPrimitiveStreamJS(t,e,i,n);this._prims[t]=r},addIndexedPrimitives:function(t,e,i,n){var r=new SglIndexedPrimitiveStreamJS(t,e,i,n);this._prims[t]=r},removePrimitives:function(t){this._prims[t]&&delete this._prims[t]}},SglMeshJS.prototype={get isValid(){return this._valid},set isValid(t){this._valid=t},get vertices(){return this._vert},get connectivity(){return this._conn},addVertexAttribute:function(t,e,i,n){this._vert.addAttribute(t,e,i,n)},removeVertexAttribute:function(t){this._vert.removeAttribute(t)},addArrayPrimitives:function(t,e,i,n){this._conn.addArrayPrimitives(t,e,i,n)},addIndexedPrimitives:function(t,e,i,n){this._conn.addIndexedPrimitives(t,e,i,n)},removePrimitives:function(t){this._conn.removePrimitives(t)}},SglMeshJS.prototype.parseOBJ=function(t){return this.isValid=sglMeshJSImportOBJFromString(this,t),this.isValid},SglMeshJS.prototype.importOBJ=function(t,e,i){return sglMeshJSImportOBJFromURL(this,t,e,i)},SglMeshJS.prototype.parseJSON=function(t){return this.isValid=sglMeshJSImportJSONFromString(this,t),this.isValid},SglMeshJS.prototype.importJSON=function(t,e,i){return sglMeshJSImportJSONFromURL(this,t,e,i)},SglAttributeStreamGL.prototype={get name(){return this._name},get size(){return this._size},get type(){return this._type},get isNormalized(){return this._norm},get stride(){return this._stride},get offset(){return this._offset},get buffer(){return this._buff},get length(){return this._length},destroy:function(){this._buff.destroy()},bind:function(t,e){var i=(e||0)*this._stride;this._buff.bind(),this.gl.vertexAttribPointer(t,this._size,this._type,this._norm,this._stride,this._offset+i)},unbind:function(t){this._buff.unbind()}},SglVertexStreamGL.prototype={get attributes(){return this._attribs},get length(){return this._length},destroy:function(){for(var t in this._attribs)this._attribs[t].destroy()},addAttribute:function(t,e,i,n){var r=new SglAttributeStreamGL(this.gl,t,e,i,n);this._attribs[t]=r,this._length=r.length},removeAttribute:function(t,e){if(this._attribs[t])for(var i in e&&this._attribs[t].destroy(),delete this._attribs[t],this._length=0,this._attribs){this._length=this._attribs[i].length;break}},bind:function(t,e){var i=null;for(var n in t)(i=this._attribs[n])&&i.bind(t[n],e)},unbind:function(t){var e=null;for(var i in t)(e=this._attribs[i])&&e.unbind(t[i])}},SglPrimitiveStreamGL.prototype={_clampRange:function(t,e){var i=this._first+this._length,n=this._first+(t>=0?t:0);if(n>=i)return null;var r=e>=0?e:this._length,s=n+r;return s>i&&(r-=s-i),[n,r]},_render:function(t,e){},get type(){},get name(){return this._name},get mode(){return this._mode},get first(){return this._first},get length(){return this._length},destroy:function(){this._destroy&&this._destroy()},bind:function(){},unbind:function(){},render:function(t,e){var i=this._clampRange(t,e);this._render(i[0],i[1])}},sglInherit(SglArrayPrimitiveStreamGL,SglPrimitiveStreamGL),SglArrayPrimitiveStreamGL.prototype._render=function(t,e){this.gl.drawArrays(this._mode,t,e)},sglInherit(SglIndexedPrimitiveStreamGL,SglPrimitiveStreamGL),SglIndexedPrimitiveStreamGL.prototype._destroy=function(){this._buff.destroy(),this._buff=null},SglIndexedPrimitiveStreamGL.prototype.bind=function(){this._buff.bind()},SglIndexedPrimitiveStreamGL.prototype.unbind=function(){this._buff.unbind()},SglIndexedPrimitiveStreamGL.prototype._render=function(t,e){this.gl.drawElements(this._mode,e,this._idxType,t*this._stride)},sglInherit(SglPackedIndexedPrimitiveStreamGL,SglPrimitiveStreamGL),SglPackedIndexedPrimitiveStreamGL.prototype._destroy=function(){this._buff.destroy(),this._buff=null},SglPackedIndexedPrimitiveStreamGL.prototype.bind=function(){this._buff.bind()},SglPackedIndexedPrimitiveStreamGL.prototype.unbind=function(){this._buff.unbind()},SglPackedIndexedPrimitiveStreamGL.prototype._clampBlockRange=function(t,e,i){var n=this._blockStartingIndices[t]+this._blockIndicesCount[t],r=this._blockStartingIndices[t]+(e>=0?e:0);if(r>=n)return null;var s=i>=0?i:this._blockIndicesCount[t],o=r+s;return o>n&&(s-=o-n),[r,s]},SglPackedIndexedPrimitiveStreamGL.prototype.blockRanges=function(t,e){for(var i=this._clampRange(t,e),n=this._blockStartingIndices.length,r=0;r<n&&i[0]<this._blockStartingIndices[r];)r++;if(r>=n)return null;for(var s=i[0]+i[1]-1,o=r;o<n&&s>=this._blockStartingIndices[o]+this._blockIndicesCount[o];)o++;o>=n&&(o=n-1);var l=[],u=i[0]-this._blockStartingIndices[r],a=i[1];u+i[1]>this._blockIndicesCount[r]&&(a=this._blockIndicesCount[r]-this._blockStartingIndices[r]),l.push([r,u,a,this._blockStartingVertices[r]]);for(var h=r+1;h<o;++h)l.push([h,0,this._blockIndicesCount[h],this._blockStartingVertices[h]]);return o>r&&l.push([h,0,i[0]+i[1]-this._blockStartingIndices[o],this._blockStartingVertices[o]]),l},SglPackedIndexedPrimitiveStreamGL.prototype.renderBlock=function(t,e,i){var n=this._clampBlockRange(t,e,i);this.gl.drawElements(this._mode,n[1],this._idxType,n[0]*this._stride)},SglConnectivityGL.prototype={get primitives(){return this._prims},destroy:function(){for(var t in this._prims)this._prims[t].destroy()},addArrayPrimitives:function(t,e,i,n){var r=new SglArrayPrimitiveStreamGL(this.gl,t,e,i,n);this._prims[t]=r},addIndexedPrimitives:function(t,e,i){var n=new SglIndexedPrimitiveStreamGL(this.gl,t,e,i);this._prims[t]=n},addPackedIndexedPrimitives:function(t,e,i,n,r){var s=new SglPackedIndexedPrimitiveStreamGL(this.gl,t,e,i,n,r);this._prims[t]=s},removePrimitives:function(t,e){this._prims[t]&&(e&&this._prims[t].destroy(),delete this._prims[t])}},SglMeshGL.prototype={get vertices(){return this._vert},get connectivity(){return this._conn},destroy:function(){this._vert.destroy(),this._conn.destroy()},addVertexAttribute:function(t,e,i,n){this._vert.addAttribute(t,e,i,n)},removeVertexAttribute:function(t,e){this._vert.removeAttribute(t,e)},addArrayPrimitives:function(t,e,i,n){this._conn.addArrayPrimitives(t,e,i,n)},addIndexedPrimitives:function(t,e,i){this._conn.addIndexedPrimitives(t,e,i)},addPackedIndexedPrimitives:function(t,e,i,n,r){this._conn.addPackedIndexedPrimitives(t,e,i,n,r)},removePrimitives:function(t,e){this._conn.removePrimitives(t,e)}};var SGL_DefaultStreamMappingPrefix="a_";function SglMeshGLRenderer(t,e){this._prog=t,this._mapping=null,this._meshAttrMap=null,this._mesh=null,this._primStream=null,this._phase=0,this._updateEnabledVB=!1,e&&this.synchronizeProgram(),this.setStreamMapping()}function sglRenderMeshGLPrimitives(t,e,i,n,r,s,o,l){var u=new SglMeshGLRenderer(i);if(u.begin(),n&&u.setStreamMapping(n),r&&u.setUniforms(r),s&&u.setSamplers(s),e)u.renderMeshPrimitives(t,e,o,l);else{var a=t.connectivity.primitives;for(var h in a)u.renderMeshPrimitives(t,h,o,l)}}function sglMeshJSCalculateBBox(t,e){var i=e||"position",n=t.vertices.attributes[i],r=n.size,s=n.buffer,o=new SglBox3;if(3!=r)return o;var l=s.length/r;if(l<=0)return o;l*=r;for(var u=0;u<r;++u)o.min[u]=s[u],o.max[u]=s[u];for(var a=0,h=r;h<l;h+=r)for(u=0;u<r;++u)a=s[h+u],o.min[u]>a&&(o.min[u]=a),o.max[u]<a&&(o.max[u]=a);return o}function sglGLPrimitiveType(t,e){switch(e){case SGL_POINTS_LIST:return t.POINTS;case SGL_LINES_LIST:return t.LINES;case SGL_LINE_STRIP:return t.LINE_STRIP;case SGL_LINE_LOOP:return t.LINE_LOOP;case SGL_TRIANGLES_LIST:return t.TRIANGLES;case SGL_TRIANGLE_STRIP:return t.TRIANGLE_STRIP;case SGL_TRIANGLE_FAN:return t.TRIANGLE_FAN;default:return}}function sglMeshJStoGL(t,e){var i=new SglMeshGL(t);for(a in e.vertices.attributes){var n=e.vertices.attributes[a];i.addVertexAttribute(n.name,n.size,new Float32Array(n.buffer))}for(p in e.connectivity.primitives){var r=e.connectivity.primitives[p],s=sglGLPrimitiveType(i.gl,r.mode);if(null!=s)switch(r.type){case SGL_ARRAY_PRIMITIVE_STREAM:i.addArrayPrimitives(r.name,s,r.first,r.length);break;case SGL_INDEXED_PRIMITIVE_STREAM:i.addIndexedPrimitives(r.name,s,new Uint16Array(r.buffer))}}return i}function sglPackMeshJStoGL(t,e,i,n){var r=i||"triangles",s=n||65e3,o=e.connectivity.primitives[r];if(!o)return null;if(o.type!=SGL_INDEXED_PRIMITIVE_STREAM)return null;var l=sglGLPrimitiveType(t,o.mode);if(null==l)return null;var u=0;if(l===t.TRIANGLES)u=3;else if(l===t.LINES)u=2;else{if(l!==t.POINTS)return null;u=1}var a=o.buffer,h=a.length;h-=h%u;var g=0,f=0,c=0,_=[],d=[],v=[],m={};for(var p in e.vertices.attributes){var S=e.vertices.attributes[p];m[p]={name:S.name,size:S.size,buffer:[]}}for(;g<h;){for(var M={},E=[],T=0,R=(M={},T=0,g);R<h;R+=u){for(var V={},b=0,y=0;y<u;++y){null==V[P=a[R+y]]&&(V[P]=!0,null==M[P]&&b++)}if(!(T+b<=s))break;for(y=0;y<u;++y){var P;null==(U=M[P=a[R+y]])&&(M[P]=T,U=T,T++),E.push(U)}g+=u}if(T<=0)break;var x=E.length;for(var p in e.vertices.attributes){var A=e.vertices.attributes[p],L=m[p],I=A.size,w=L.buffer.length,C=new Array(T*I);L.buffer=L.buffer.concat(C);var D=A.buffer,F=L.buffer;for(var R in M)for(var U=M[R],G=0;G<I;++G)F[w+(U*I+G)]=D[R*I+G]}v=v.concat(E),_.push(f),d.push(c),f+=T,c+=x}var N=new SglMeshGL(t);for(var p in m){S=m[p];N.addVertexAttribute(S.name,S.size,new Float32Array(S.buffer))}return 1==_.length?N.addIndexedPrimitives(r,l,new Uint16Array(v)):N.addPackedIndexedPrimitives(r,l,new Uint16Array(v),d,_),N}SglMeshGLRenderer.prototype={_bindVertexBuffers:function(t){this._mesh.vertices.bind(this._meshAttrMap,t)},_unbindVertexBuffers:function(){this._mesh.vertices.unbind(this._meshAttrMap)},get program(){return this.prog},synchronizeProgram:function(){this._prog.synchronize();var t=!1,e=0,i=null;for(var n in this._prog.attributes)(i=this._prog.attributes[n]).index!=e&&(i.index=e,t=!0),e++;t&&this._prog.link();var r=0;for(var s in this._prog.samplers)this._prog.samplers[s].unit=r,r++},getStreamMappingFromPrefix:function(t){var e=t.length,i=new Object,n=null;for(var r in this._prog.attributes)r.substr(0,e)==t&&(n=r.substr(e)).length>0&&(i[r]=n);return i},setStreamMapping:function(t){this._updateEnabledVB=!0;var e=null;for(var i in this._mapping=this.getStreamMappingFromPrefix(SGL_DefaultStreamMappingPrefix),t)e=t[n],this._prog.attributes[i]&&(this._mapping[i]=e);this._meshAttrMap={};var n=null;for(var i in this._mapping)e=this._mapping[i],n=this._prog.attributes[i],this._meshAttrMap[e]=n.index;this._mesh&&this._bindVertexBuffers(0)},setStreamMappingFromPrefix:function(t){t||(t=SGL_DefaultStreamMappingPrefix);var e=this.getStreamMappingFromPrefix(t);this.setStreamMapping(e)},setUniforms:function(t){0!=this._phase&&this._prog.setUniforms(t)},setSamplers:function(t){if(0!=this._phase){var e={},i={},n=null;for(var r in t)"number"==typeof(n=t[r])?e[r]=n:i[r]=n;this._prog.setSamplers(e);var s=null;for(var r in i)(s=this._prog.samplers[r])&&i[r].bind(s.unit)}},begin:function(){0==this._phase&&(this._prog.bind(),this._phase=1)},end:function(){if(1==this._phase){this._prog.unbind();var t=this._prog.gl;for(var e in this._prog.attributes)t.disableVertexAttribArray(this._prog.attributes[e].index);this._phase=0}},beginMesh:function(t){1==this._phase&&(this._updateEnabledVB=!0,this._mesh=t,this._bindVertexBuffers(0),this._phase=2)},endMesh:function(){2==this._phase&&(this._unbindVertexBuffers(),this._prog.gl.bindBuffer(this._prog.gl.ARRAY_BUFFER,null),this._mesh=null,this._phase=1)},beginPrimitives:function(t){2==this._phase&&(this._primStream=this._mesh.connectivity.primitives[t],this._primStream.bind(),this._phase=3)},endPrimitives:function(){3==this._phase&&(this._primStream.unbind(),this._primStream=null,this._phase=2)},render:function(t,e){if(3==this._phase){var i=this._prog.gl,n=0;if(this._updateEnabledVB)for(var r in this._updateEnabledVB=!1,this._mapping)n=this._prog.attributes[r].index,this._mesh.vertices.attributes[this._mapping[r]]?i.enableVertexAttribArray(n):i.disableVertexAttribArray(n);if(this._primStream.isPacked){if(this._primStream.blocksCount>0)for(var s=this._primStream.blockRanges(t,e),o=s.length,l=0;l<o;++l)this._bindVertexBuffers(s[l][3]),this._primStream.renderBlock(s[l][0],s[l][1],s[l][2])}else this._primStream.render(t,e)}},renderMeshPrimitives:function(t,e,i,n){this.beginMesh(t),this.beginPrimitives(e),this.render(i,n),this.endPrimitives(),this.endMesh()}},SglMeshJS.prototype.calculateBoundingBox=function(t){return sglMeshJSCalculateBBox(this,t)},SglMeshJS.prototype.toMeshGL=function(t){return sglMeshJStoGL(t,this)},SglMeshJS.prototype.toPackedMeshGL=function(t,e,i){return sglPackMeshJStoGL(t,this,e,i)};var SGL_TRACKBALL_NO_ACTION=0,SGL_TRACKBALL_ROTATE=1,SGL_TRACKBALL_PAN=2,SGL_TRACKBALL_DOLLY=3,SGL_TRACKBALL_SCALE=4;function SglTrackball(){this._matrix=sglIdentityM4(),this._pts=[[0,0],[0,0]],this._action=SGL_TRACKBALL_NO_ACTION,this.reset()}function SglFirstPersonCamera(){this._position=sglZeroV3(),this._angles=sglZeroV3(),this.lookAt(0,0,0,0,0,-1,0)}function sglGetCanvasContext(t){var e=document.getElementById(t);if(!e)return null;for(var i=["webgl","experimental-webgl","moz-webgl","webkit-3d"],n=null,r=0;r<i.length;r++){try{n=e.getContext(i[r])}catch(t){n=null}if(n)break}return null==n?null:(null==n.FALSE&&(n.FALSE=0),null==n.TRUE&&(n.TRUE=1),n)}function SglCanvasUI(t,e,i,n){this._manager=t,this._handler=e,this._canvas=i,this._timerID=null,this._updRate=0,this._ignoreKeyRepeat=!0,this.gl=n,this.loadEvent=null,this.unloadEvent=null,this.keyDownEvent=null,this.keyUpEvent=null,this.keyPressEvent=null,this.mouseDownEvent=null,this.mouseUpEvent=null,this.mouseMoveEvent=null,this.mouseWheelEvent=null,this.clickEvent=null,this.dblClickEvent=null,this.resizeEvent=null,this.updateEvent=null,this.drawEvent=null,this.keysDown=new Object,this.mouseButtonsDown=new Object,this.mousePos={x:0,y:0},this.mousePrevPos={x:0,y:0},this.mouseDeltaPos={x:0,y:0},this.timeNow=Date.now()/1e3,this.timePrev=this.timeNow,this.timeDelta=0}function _SglCanvasManager(t,e,i){var n=document.getElementById(t);if(!n)throw new Error("SpiderGL : Canvas not found");n.contentEditable=!0;var r=sglGetCanvasContext(t);if(!r)throw new Error("SpiderGL : Cannot get WebGL context");r.pixelStorei(r.PACK_ALIGNMENT,1),r.pixelStorei(r.UNPACK_ALIGNMENT,1),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),r.pixelStorei(r.UNPACK_COLORSPACE_CONVERSION_WEBGL,r.NONE),r.bindFramebuffer(r.FRAMEBUFFER,null);var s=new SglCanvasUI(this,e,n,r);this.ui=s;var o=this;this.gl=r,this.canvas=n,this.handler=e,this.handler.ui=s,this._drawPending=!1,this.rendering=!0,this._drawFunc=function(){o.draw()},this.canvas.addEventListener("load",(function(t){o.load(t)}),!1),this.canvas.addEventListener("unload",(function(t){o.unload(t)}),!1),this.canvas.addEventListener("keydown",(function(t){o.keyDown(t)}),!1),this.canvas.addEventListener("keyup",(function(t){o.keyUp(t)}),!1),this.canvas.addEventListener("keypress",(function(t){o.keyPress(t)}),!1),this.canvas.addEventListener("mousedown",(function(t){o.mouseDown(t)}),!1),this.canvas.addEventListener("mouseup",(function(t){o.mouseUp(t)}),!1),this.canvas.addEventListener("mousemove",(function(t){o.mouseMove(t)}),!1),this.canvas.addEventListener("click",(function(t){o.click(t)}),!1),this.canvas.addEventListener("dblclick",(function(t){o.dblClick(t)}),!1),this.canvas.addEventListener("resize",(function(t){o.resize(t)}),!1),this.canvas.addEventListener("mousewheel",(function(t){o.mouseWheel(t)}),!1),this.canvas.addEventListener("DOMMouseScroll",(function(t){o.mouseWheel(t)}),!1),this.canvas.addEventListener("blur",(function(t){o.blur(t)}),!1),this.canvas.addEventListener("mouseout",(function(t){o.mouseOut(t)}),!1),this.canvas.addEventListener("mouseover",(function(t){o.mouseOver(t)}),!1),this.canvas.addEventListener("touchstart",(function(t){o.touchStart(t)}),!1),this.canvas.addEventListener("touchend",(function(t){o.touchEnd(t)}),!1),this.canvas.addEventListener("touchmove",(function(t){o.touchMove(t)}),!1),this.load(),i&&(this.ui.updateRate=i)}SglTrackball.prototype={_projectOnSphere:function(e,i){var n=0,r=sglSqrt(e*e+i*i);return r<.7071067811865476?n=sglSqrt(1-r*r):(t=.7071067811865475,n=t*t/r),n},_transform:function(t,e,i,n){return sglMulM4V4(t,sglV4C(e,i,n,0))},_transformOnSphere:function(t,e,i){var n=this._projectOnSphere(e,i);return this._transform(t,e,i,n)},_translate:function(t,e){var i=sglInverseM4(this._matrix),n=sglV3toV4(t,0),r=sglTranslationM4V(n=sglMulSV4(e,n=sglMulM4V4(i,n)));this._matrix=sglMulM4(this._matrix,r)},get action(){return this._action},set action(t){this._action=t},get matrix(){return this._matrix},reset:function(){this._matrix=sglIdentityM4(),this._pts=[[0,0],[0,0]],this._action=SGL_TRACKBALL_NO_ACTION},track:function(t,e,i,n){switch(this._pts[0][0]=this._pts[1][0],this._pts[0][1]=this._pts[1][1],this._pts[1][0]=e,this._pts[1][1]=i,this._action){case SGL_TRACKBALL_ROTATE:this.rotate(t);break;case SGL_TRACKBALL_PAN:this.pan(t);break;case SGL_TRACKBALL_DOLLY:this.dolly(t,n);break;case SGL_TRACKBALL_SCALE:this.scale(t,n)}},rotate:function(t){if(this._pts[0][0]!=this._pts[1][0]||this._pts[0][1]!=this._pts[1][1]){var e=sglInverseM4(t),i=sglCrossV3(this._transformOnSphere(e,this._pts[0][0],this._pts[0][1]),this._transformOnSphere(e,this._pts[1][0],this._pts[1][1])),n=sglRotationAngleAxisM4V(sglLengthV3(i),i);this._matrix=sglMulM4(n,this._matrix)}},pan:function(t){var e=sglInverseM4(t),i=this._transform(e,this._pts[0][0],this._pts[0][1],-1),n=sglSubV3(this._transform(e,this._pts[1][0],this._pts[1][1],-1),i);this._translate(n,2)},dolly:function(t,e){var i=sglInverseM4(t),n=this._transform(i,0,0,e);this._translate(n,1)},scale:function(t,e){var i=sglScalingM4C(e,e,e);this._matrix=sglMulM4(this._matrix,i)}},SglFirstPersonCamera.prototype={clone:function(){var t=new SglFirstPersonCamera;return t._position=this._position.slice(),t._angles=this._angles.slice(),t},get copy(){return this.clone()},lookAt:function(t,e,i,n,r,s,o){this._position=sglV3C(t,e,i);var l=sglSubV3([n,r,s],this._position);return this._angles[0]=sglAtan2(l[1],-l[2]),this._angles[1]=sglAtan2(-l[0],-l[2]),this._angles[2]=o||0,this},translate:function(t,e,i){var n=sglRotationAngleAxisM4C(this._angles[0],1,0,0),r=sglRotationAngleAxisM4C(this._angles[1],0,1,0),s=sglMulM4V4(sglMulM4(sglRotationAngleAxisM4C(this._angles[2],0,0,1),sglMulM4(r,n)),[t,e,i,0]);return this._position[0]+=s[0],this._position[1]+=s[1],this._position[2]+=s[2],this},translateOnPlane:function(t,e,i){var n=sglMulM4V4(sglRotationAngleAxisM4C(this._angles[1],0,1,0),[t,e,i,0]);return this._position[0]+=n[0],this._position[1]+=n[1],this._position[2]+=n[2],this},rotate:function(t,e,i){return this._angles[0]+=t,this._angles[1]+=e,this._angles[2]+=i,this},get matrix(){var t=sglRotationAngleAxisM4C(-this._angles[0],1,0,0),e=sglRotationAngleAxisM4C(-this._angles[1],0,1,0);return sglMulM4(sglRotationAngleAxisM4C(-this._angles[2],0,0,1),sglMulM4(t,sglMulM4(e,sglTranslationM4V(sglNegV3(this._position)))))}},SglCanvasUI.prototype={get canvas(){return this._canvas},get width(){return this._canvas.width},get height(){return this._canvas.height},get ignoreKeyRepeat(){return this._ignoreKeyRepeat},set ignoreKeyRepeat(t){this._ignoreKeyRepeat=t},get updateRate(){return this._updRate<=0?0:this._updRate},set updateRate(t){var e=t;if(e<0&&(e=0),e>1e3&&(e=1e3),this._updRate!=e&&(this._updRate=e,null!=this._timerID&&(clearInterval(this._timerID),this._timerID=null),this._updRate>0)){var i=1e3/this._updRate;i<1&&(i=1);var n=this._manager;this.timeNow=Date.now()/1e3,this.timePrev=this.timeNow,this.timeDelta=0,this._timerID=setInterval((function(){n.update()}),i)}},get requestDraw(){var t=this;return function(){t._manager.requestDraw()}}},_SglCanvasManager.prototype={_getMouseClientPos:function(t){var e=this.canvas.getBoundingClientRect();return{x:t.clientX-e.left,y:t.clientY-e.top}},requestDraw:function(){this.rendering&&(this._drawPending||(this._drawPending=!0,setTimeout(this._drawFunc,0)))},blur:function(t){var e=!1;for(var i in this.ui.mouseButtonsDown)this.ui.mouseButtonsDown[i]&&(this.ui.mouseButtonsDown[i]=!1,this.handler.mouseUp&&0!=this.handler.mouseUp(this.gl,i,this.ui.mousePos.x,this.ui.mousePos.y)&&(e=!0));for(var n in this.ui.keysDown)this.ui.keysDown[n]&&(this.ui.keysDown[n]=!1,this.handler.keyUp&&0!=this.handler.keyUp(this.gl,0,n)&&(e=!0));e&&this.requestDraw()},mouseOut:function(t){var e=!1;for(var i in this.ui.mouseButtonsDown)this.ui.mouseButtonsDown[i]&&(this.ui.mouseButtonsDown[i]=!1,this.handler.mouseOut&&0!=this.handler.mouseOut(this.gl,this.ui.mousePos.x,this.ui.mousePos.y)&&(e=!0));e&&this.requestDraw()},mouseOver:function(t){},load:function(){this.ui.loadEvent=null,this.handler.load&&this.handler.load(this.gl),this.requestDraw()},unload:function(){this.ui.unloadEvent=null,this.ui.updateRate=0,this.handler.unload&&this.handler.unload(this.gl),this.handler.ui=null,this.handler=null,this.ui=null},keyDown:function(t){this.ui.keyDownEvent=t;var e=String.fromCharCode(t.keyCode);this.ui.keysDown[e.toLowerCase()]=!0,this.ui.keysDown[e.toUpperCase()]=!0,this.ui.keysDown[t.keyCode]&&this.ui.ignoreKeyRepeat||(this.ui.keysDown[t.keyCode]=!0,this.handler.keyDown&&0!=this.handler.keyDown(this.gl,t.keyCode,e)&&this.requestDraw())},keyUp:function(t){this.ui.keyUpEvent=t;var e=String.fromCharCode(t.keyCode);this.ui.keysDown[e.toLowerCase()]=!1,this.ui.keysDown[e.toUpperCase()]=!1,this.ui.keysDown[t.keyCode]=!1,this.handler.keyUp&&0!=this.handler.keyUp(this.gl,t.keyCode,e)&&this.requestDraw()},keyPress:function(t){this.ui.keyPressEvent=t;var e=String.fromCharCode(t.charCode);this.handler.keyPress&&0!=this.handler.keyPress(this.gl,t.charCode,e)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},mouseDown:function(t){this.ui.mouseDownEvent=t;var e=this._getMouseClientPos(t),i=e.x,n=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=i,this.ui.mousePrevPos.y=n,this.ui.mousePos.x=i,this.ui.mousePos.y=n,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.ui.mouseButtonsDown[t.button]=!0,this.handler.mouseDown&&0!=this.handler.mouseDown(this.gl,t.button,i,n)&&this.requestDraw(),this.canvas.focus(),t.preventDefault&&t.preventDefault()},mouseUp:function(t){this.ui.mouseUpEvent=t;var e=this._getMouseClientPos(t),i=e.x,n=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=i,this.ui.mousePrevPos.y=n,this.ui.mousePos.x=i,this.ui.mousePos.y=n,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.ui.mouseButtonsDown[t.button]=!1,this.handler.mouseUp&&0!=this.handler.mouseUp(this.gl,t.button,i,n)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},mouseMove:function(t){this.ui.mouseMoveEvent=t;var e=this._getMouseClientPos(t),i=e.x,n=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=this.ui.mousePos.x,this.ui.mousePrevPos.y=this.ui.mousePos.y,this.ui.mousePos.x=i,this.ui.mousePos.y=n,this.ui.mouseDeltaPos.x=this.ui.mousePos.x-this.ui.mousePrevPos.x,this.ui.mouseDeltaPos.y=this.ui.mousePos.y-this.ui.mousePrevPos.y,this.handler.mouseMove&&0!=this.handler.mouseMove(this.gl,i,n)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},mouseWheel:function(t){this.ui.mouseWheelEvent=t;var e=this._getMouseClientPos(t),i=e.x,n=this.canvas.height-1-e.y;if(this.ui.mousePrevPos.x=i,this.ui.mousePrevPos.y=n,this.ui.mousePos.x=i,this.ui.mousePos.y=n,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.handler.mouseWheel){var r=0;t||(t=window.event),t.wheelDelta?(r=t.wheelDelta/120,window.opera&&(r=-r)):t.detail&&(r=-t.detail/3),r&&0!=this.handler.mouseWheel(this.gl,r,i,n)&&this.requestDraw()}t.preventDefault&&t.preventDefault()},touchStart:function(t){this.ui.mouseDownEvent=t.touches[0];var e=this._getMouseClientPos(t.touches[0]),i=e.x,n=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=i,this.ui.mousePrevPos.y=n,this.ui.mousePos.x=i,this.ui.mousePos.y=n,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.ui.mouseButtonsDown[0]=!0,this.handler.mouseDown&&0!=this.handler.mouseDown(this.gl,0,i,n)&&this.requestDraw(),this.canvas.focus(),t.preventDefault&&t.preventDefault()},touchEnd:function(t){this.ui.mouseUpEvent=t.changedTouches[0];var e=this._getMouseClientPos(t.changedTouches[0]),i=e.x,n=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=i,this.ui.mousePrevPos.y=n,this.ui.mousePos.x=i,this.ui.mousePos.y=n,this.ui.mouseDeltaPos.x=0,this.ui.mouseDeltaPos.y=0,this.ui.mouseButtonsDown[0]=!1,this.handler.mouseUp&&0!=this.handler.mouseUp(this.gl,0,i,n)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},touchMove:function(t){this.ui.mouseMoveEvent=t.changedTouches[0];var e=this._getMouseClientPos(t.changedTouches[0]),i=e.x,n=this.canvas.height-1-e.y;this.ui.mousePrevPos.x=this.ui.mousePos.x,this.ui.mousePrevPos.y=this.ui.mousePos.y,this.ui.mousePos.x=i,this.ui.mousePos.y=n,this.ui.mouseDeltaPos.x=this.ui.mousePos.x-this.ui.mousePrevPos.x,this.ui.mouseDeltaPos.y=this.ui.mousePos.y-this.ui.mousePrevPos.y,this.handler.mouseMove&&0!=this.handler.mouseMove(this.gl,i,n)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},click:function(t){this.ui.clickEvent=t;var e=this._getMouseClientPos(t),i=e.x,n=this.canvas.height-1-e.y;this.handler.click&&0!=this.handler.click(this.gl,t.button,i,n)&&this.requestDraw()},dblClick:function(t){this.ui.dblClickEvent=t;var e=this._getMouseClientPos(t),i=e.x,n=this.canvas.height-1-e.y;this.handler.dblClick&&0!=this.handler.dblClick(this.gl,t.button,i,n)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},resize:function(t){this.ui.resizeEvent=t,this.handler.resize&&0!=this.handler.resize(this.gl,this.canvas.width,this.canvas.height)&&this.requestDraw(),t.preventDefault&&t.preventDefault()},update:function(){this.ui.updateEvent=null;var t=Date.now()/1e3;this.ui.timePrev=this.ui.timeNow,this.ui.timeNow=t,this.ui.timeDelta=this.ui.timeNow-this.ui.timePrev;var e=!0;this.handler.update&&(e=0!=this.handler.update(this.gl,this.ui.timeDelta)),e&&this.requestDraw()},draw:function(){this.ui.drawEvent=null,this.handler.draw&&this.handler.draw(this.gl),this.gl.flush(),this._drawPending=!1}};var _SGL_RegisteredCanvas=new Object;function _sglManageCanvas(t,e,i){var n=new _SglCanvasManager(t,e,i);_SGL_RegisteredCanvas[t]=n}function _sglUnmanageCanvas(t){_SGL_RegisteredCanvas[t]&&(_SGL_RegisteredCanvas[t]=null,delete _SGL_RegisteredCanvas[t])}function _sglManageCanvasOnLoad(t,e,i){window.addEventListener("load",(function(){_sglManageCanvas(t,e,i)}),!1)}function _sglUnmanageCanvasOnLoad(t){window.addEventListener("unload",(function(){_sglUnmanageCanvas(t)}),!1)}function sglRegisterCanvas(t,e,i){_sglManageCanvasOnLoad(t,e,i),_sglUnmanageCanvasOnLoad(t)}function sglRegisterLoadedCanvas(t,e,i){_sglManageCanvas(t,e,i),_sglUnmanageCanvasOnLoad(t)}
function createRtiViewer(e,t,i,s){var r=s,n=i,a=!1,o=$($("#"+e)[0]),l=document.createElement("div");l.id=e+"_div",l.style.height=s+"px",l.style.width=i+"px",l.style.margin="auto",l.style.position="relative",o.append(l);var h=$($("#"+e+"_div")[0]),d=e+"_webgl",u=document.createElement("canvas");u.id=d,u.width=i,u.height=s,h.append(u);var m=document.createElement("a");m.href="http://vcg.isti.cnr.it/rti/webviewer.php",m.target="_blank";var c=document.createElement("div");c.style.width="80px",c.style.height="50px",m.appendChild(c),m.style.position="absolute",m.style.bottom="0px",m.style.left="0px",m.style.cssFloat="left",h.append(m);var g=document.createElement("div");g.setAttribute("class","toolbar"),g.style.position="absolute",g.style.top="10px",g.style.left="10px",g.style.cssFloat="left",g.style.width="40px",g.style.height="200px",g.style.visibility="hidden",g.innerHTML='<button class = "toolbarButton" id = "zoomIn"></button><button class = "toolbarButton" id = "zoomOut"></button><button class = "toolbarButton" id = "light"></button><button class = "toolbarButton" id = "fullscreen"></button><button class = "toolbarButton" id = "help"></button>',h.append(g);var f=document.createElement("div");function p(){var t=document.getElementById(e+"_div");document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),t.style.height=r+"px",t.style.width=n+"px";var i=$("#"+e+"_webgl");i.height(r),i.width(n),i.attr("width",n),i.attr("height",r),v.resize(),a=!1;$("#"+e+"_div #fullscreen").button("option",{label:"Active Fullscreen",icons:{primary:"fullIcon toolbarIcon"}})}f.id=e+"_guide",f.style.width="100%",f.style.height="100%",f.style.position="absolute",f.style.left="0px",f.style.top="0px",f.style.color="#FFFFFF",f.style.backgroundColor="rgba(0, 0, 0, 0.9)",f.innerHTML='<div id = "guideTable"><div id = "guideCell"> <div id = "guideList"><h3>WebRTIViewer<br/></h3><ul><li>Pan: LeftMouseButton + MouseMove.</li><li>Zoom in: MouseWhell or press the button <span><img src = "/assets/webViewer/css/icons/zoomin.png" alt=""/></span></li><li>Zoom out: MouseWheel or press the button <span><img src = "/assets/webViewer/css/icons/zoomout.png" alt=""/></span></li><li>To change the light direction: activate the light with the button <span><img src = "/assets/webViewer/css/icons/light.png" alt=""/></span> and press LeftMouseButton + MouseMove or Ctrl + LeftMouseButton + MouseMove.</li><li>Fullscreen: press the button <span><img src = "/assets/webViewer/css/icons/full.png" alt=""/></span> to active the fullscreen mode and the button <span><img src = "/assets/webViewer/css/icons/full_on.png" alt=""/></span> to exit</li><li>To reset the viewpoint: press R.</li></ul><a href="http://vcg.isti.cnr.it/rti/webviewer.php" target = "_black">Visual Computing Lab ISTI CNR Pisa</a></div></div></div>',f.style.display="none",h.append(f),$("#"+e+"_div #zoomIn").button({icons:{primary:"zoomInIcon toolbarIcon"},text:!1,label:"Zoom In"}).click((function(){v.startZoomIn()})),$("#"+e+"_div #zoomOut").button({icons:{primary:"zoomOutIcon toolbarIcon"},text:!1,label:"Zoom Out"}).click((function(){v.startZoomOut()})),$("#"+e+"_div #light").button({icons:{primary:"lightIcon toolbarIcon"},text:!1,label:"Light Off"}).click((function(){var e;"Light Off"==$.trim($(this).text())?(e={label:"Light On",icons:{primary:"lightOnIcon toolbarIcon"}},v.setMode(1)):(e={label:"Light Off",icons:{primary:"lightIcon toolbarIcon"}},v.setMode(0)),$(this).button("option",e)})),$("#"+e+"_div #help").button({icons:{primary:"helpIcon toolbarIcon"},text:!1,label:"Help"}).click((function(){$("#"+e+"_guide").show()})),$("#"+e+"_div #fullscreen").button({icons:{primary:"fullIcon toolbarIcon"},text:!1,label:"Active Fullscreen"}).click((function(){a?p():function(){var t=document.getElementById(e+"_div");t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.msRequestFullscreen&&t.msRequestFullscreen(),t.style.height=screen.height+"px",t.style.width=screen.width+"px";var i=$("#"+e+"_webgl");i.height(screen.height),i.width(screen.width),i.attr("width",screen.width),i.attr("height",screen.height),v.resize(),a=!0,$("#"+e+"_div #fullscreen").button("option",{label:"Exit Fullscreen",icons:{primary:"fullOnIcon toolbarIcon"}})}(),$("#"+e+"_div #fullscreen").removeClass("ui-state-hover")})),document.addEventListener("MSFullscreenChange",(function(){document.msFullscreenElement||p()}),!1),document.addEventListener("mozfullscreenchange",(function(){document.mozFullScreen||p()}),!1),document.addEventListener("webkitfullscreenchange",(function(){document.webkitIsFullScreen||p()}),!1),$("#"+e+"_guide").click((function(){$("#"+e+"_guide").hide()}));var _=document.createElement("div");if(_.id=e+"_error",_.style.width="100%",_.style.height="100%",_.style.position="absolute",_.style.left="0px",_.style.top="0px",_.style.color="#FFFFFF",_.style.backgroundColor="rgba(0, 0, 0, 1.0)",_.innerHTML='<canvas id = "testCanvas" width= "800" height= "600" contenteditable="true"></canvas>',_.style.display="none",h.append(_),null==sglGetCanvasContext("testCanvas"))_.style.display="block",_.innerHTML='<div id = "contentError" style = "width: 90%; height: 100%; text-align:left; padding:0% 5% 0% 5%; font-family:  Verdana,sans-serif; overflow-y: scroll;"><h3>WebGL is not available or not enabled.</h3><p><a href="http://en.wikipedia.org/wiki/WebGL">WebGL</a> is the technology we use to display the RTI images. It is currently supported, but sometimes not enabled by default, by recent versions of <a href="http://www.mozilla.org/firefox">Firefox</a>, <a href="http://www.google.com/chrome">Chrome</a> and <a href="http://www.apple.com/safari">Safari</a>. An external plugins is available for <a href="http://microsoft.com/ie">Internet  Explorer</a>.<br/> It also requires a moderately recent and capable hardware and up to date drivers.</p><p><b>Chrome</b><br/>Type "chrome://flags" in the address bar.<br/>Disable (yes, it is a confusing double negation!) the WebGL entry.<br/>Click the <em>relaunch now</em> button at the bottom.</p><p><b>Firefox</b><br/>Type "about:config" in the address bar<br/>Type "webgl" in the <em>Filter</em>.<br/>Doubleclick the entry <b>webgl.force-enable</b>, and restart Firefox.</p><p><b>Safari</b><br/>Open the Safari menu and select Preferences.<br/>Then, click the Advanced tab in the Preferences window.<br/>Then, at the bottom of the window, check the Show Develop menu in menu bar checkbox.<br/>Then, open the Develop menu in the menu bar and select Enable WebGL.</p><p><b>Internet Explorer (from version 9.0)</b><br/>Install the <a href="http://www.google.com/chromeframe">Chrome Frame</a> <br/>Open the Tools menu and select Manage add-ons.<br/>Then, enable the ChromeFrame BHO plugins and restart Internet Explorer.<br/></p><p><b>Installing updated drivers</b><br/>If the visualization of the RTI image fails you must update the drivers of your graphics cards.</p></div>';else{_.innerHTML="";var v=new MultiRes(d);"string"===$.type(t)?v.setImageUrl(t):v.setImageFunction(t),v.setOnLoadImageCallback((function(t){"IMAGE"==t&&$("#"+e+"_div #light").css("display","none"),$(".toolbar").css("visibility","visible")})),sglRegisterCanvas(d,v,10)}}function log(e){}function MultiRes(e){this.mode=0,this.stepAnimation=0,this.idTimer,this.flipAngles=[],this.flipAngles[0]=0,this.canvas=e,this.rendering=!1,this.onDrawCallback=null,this.animating=!1,this.moveToCenter=!1,this.imageUrl="",this.imageFunction=null,this.OnLoadImageCallback=null,this.currentSpeed=0,this.maxStep=7,this.animationStack=[],this.isMoving=!1;for(var t=1;t<21;t++)this.flipAngles[t]=SGL_PI/2*Math.sin(t/40*SGL_PI)}function MultiResNode(){this.id=0,this.parentIndex=-1,this.childrenIndices=[-1,-1,-1,-1],this.projectedSize=1,this.zScale=1,this.box=new SglBox3,this.priority={timestamp:-1,error:Number.MAX_VALUE},this.req=null,this.data=null,this.isLeaf=!0}function MultiResTree(e,t){this.ready=!0,this.nodesCount=0,this.rootIndex=-1,this.nodes=null,this.url=null,this.tileSize=0,this.scale=[1,1,1],this.offset=[0,0,0],this.forma="",e&&this.load(e,imgW,imgH,t)}function _MultiResAssert(e){e||alert("MultiResAssert FAILED : "+e)}function _MultiResCompareNodes(e,t){return e.priority.timestamp!=t.priority.timestamp?t.priority.timestamp-e.priority.timestamp:e.priority.error!=t.priority.error?t.priority.error-e.priority.error:e.id-t.id}function MultiResRenderer(e,t,i){this.lg=!0,this.gl=e,this._tree=new MultiResTree,this._timestamp=0,this._frustum=new SglFrustum,this._maxError=1,this._cache=[],this._cacheSizeInBytes=t,this._maxCacheSize=1,this._maxOngoingRequests=2,this._currentOngoingRequests=0,this._toRequest=[],this._toRenderFullRes=[],this._toRenderHalfRes=[],this._readyItems=[],this.renderData=!0,this.renderBoxes=!1;var s=new Float32Array([-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,.5,.5,.5,-.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5]),r=new Uint16Array([0,1,2,2,1,3,5,4,7,7,4,6,4,0,6,6,0,2,1,5,3,3,5,7,2,3,6,6,3,7,4,5,0,0,5,1]),n=new Uint16Array([0,1,1,3,3,2,2,0,5,4,4,6,6,7,7,5,0,4,1,5,3,7,2,6]),a=new SglMeshGL(e);a.addVertexAttribute("position",3,s),a.addIndexedPrimitives("triangles",e.TRIANGLES,r),a.addIndexedPrimitives("edges",e.LINES,n),this._boxMesh=a,this._tileFullMesh=null,this._tileHalfMesh=null,this._program=null;var o=sglLoadFile("/assets/webViewer/spidergl/box.v.glsl"),l=sglLoadFile("/assets/webViewer/spidergl/box.f.glsl"),h=new SglProgram(e,[o],[l]);log(h.log),this._boxProgram=h,this._boxRenderer=new SglMeshGLRenderer(this._boxProgram),this._treeTransform=sglIdentityM4(),this._normalizedTreeTransform=sglIdentityM4(),this.updateData=!0;this.texProg=new SglProgram(this.gl,["#ifdef GL_ES\nprecision highp float;\n#endif\nuniform   mat4 u_mvp;\nattribute vec2 a_position;\nattribute vec2 a_texcoord;\nvarying   vec2 v_texcoord;\nvoid main(void){\nv_texcoord  = a_texcoord;\ngl_Position = u_mvp * vec4(a_position, 0.0, 1.0);\n}"],["#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D s_texture;\nvarying vec2     v_texcoord;\nvoid main(void){vec4 color = texture2D(s_texture, v_texcoord).xyzw;\nif (color.w > 0.7)\ngl_FragData[0] = vec4(color.rgb, 1.0);\nelse\ngl_FragData[0] = vec4(0.0);}"]),log(this.texProg.log);var d=new Float32Array([0,0,80,0,0,50,80,50]),u=new Float32Array([0,0,1,0,0,1,1,1]);if(this.lg){var m=new SglMeshGL(this.gl);m.addVertexAttribute("position",2,d),m.addVertexAttribute("texcoord",2,u),m.addArrayPrimitives("tristrip",this.gl.TRIANGLE_STRIP,0,4),this.lgMesh=m,this.lgtex=null,this._createLg()}this.enumType=new Object,this.enumType.HSH_RTI=1,this.enumType.LRGB_PTM=2,this.enumType.RGB_PTM=3,this.enumType.IMAGE=4}MultiRes.prototype={setMode:function(e){this.mode=e},_setLightDir:function(e,t){var i=e/this.ui.width*2.2-1.1,s=t/this.ui.height*2.2-1.1;i=Math.min(1,Math.max(-1,i)),s=Math.min(1,Math.max(-1,s));var r=Math.sqrt(i*i+s*s);r>1&&(r=1);var n=Math.PI/2;0!=i&&(n=Math.atan2(s,i)),i=r*Math.cos(n),s=r*Math.sin(n);var a=[];a=r<1?[i,s,Math.sqrt(1-i*i-s*s)]:[i,s,0],a=sglNormalizedV3(a),this.renderer.lightPos=a.slice(0,3),this.renderer.lweights=this.renderer.computeLightingFunction(a)},resetViewpoint:function(){this.translation[0]=0,this.translation[1]=0,this.mat=sglIdentityM4(),this.flipMatrix=sglIdentityM4()},setImageUrl:function(e){this.imageUrl=e},setImageFunction:function(e){this.imageFunction=e},setOnLoadImageCallback:function(e){this.OnLoadImageCallback=e},load:function(e){log("SpiderGL Version : "+SGL_VERSION_STRING+"\n"),this.xform=new SglTransformStack,this.renderer=new MultiResRenderer(e,268435456),this.translation=[0,0],this.mat=sglIdentityM4(),this.flipMatrix=sglIdentityM4(),""!=this.imageUrl?this.loadImage(this.imageUrl):null!==this.imageFunction&&this.loadImage(this.imageFunction)},loadImage:function(e){this.renderer.loadImage(e),this.OnLoadImageCallback(this.renderer.type),this.xform=new SglTransformStack,this.translation=[0,0],this.mat=sglIdentityM4(),this.rendering=!0,this.leftBottom=[(this.renderer._tree.scale[0]-this.renderer.imgWidth)/2,(this.renderer._tree.scale[1]-this.renderer.imgHeight)/2],this.rightTop=[this.leftBottom[0]+this.renderer.imgWidth,this.leftBottom[1]+this.renderer.imgHeight],this.scale=0;var t=this.ui.width,i=this.ui.height,s=this.renderer._tree.scale[0]/this.renderer.imgWidth*t,r=this.renderer._tree.scale[1]/this.renderer.imgHeight*i;this.scale=Math.min(s,r),this.maxScale=2.5*Math.max(this.renderer.imgWidth/t,this.renderer.imgHeight/i),this.viewerdx=100,this.viewerdy=100},stopRendering:function(){this.rendering=!1},setOnDrawCallback:function(e){e&&(this.onDrawCallback=e)},keyDown:function(e,t,i){"R"==i&&this.resetViewpoint(),"1"==i&&(this.renderer.renderData=!this.renderer.renderData),"2"==i&&(this.renderer.renderBoxes=!this.renderer.renderBoxes)},mouseWheel:function(e,t,i,s){if(this.isMoving)return!1;var r=i-this.translation[0],n=s-this.translation[1],a=sglPow(.98,10*t);this._startZoom(a,r,n)},startZoomIn:function(){if(this.isMoving)return!1;var e=this.ui.width/2-this.translation[0],t=this.ui.height/2-this.translation[1];this._startZoom(1.2,e,t)},startZoomOut:function(){if(this.isMoving)return!1;var e=this.ui.width/2-this.translation[0],t=this.ui.height/2-this.translation[1];this._startZoom(.8,e,t)},_startZoom:function(e,t,i){var s=this.mat[0]*e;s>this.maxScale&&(e=this.maxScale/this.mat[0]),s<1&&(e=1/this.mat[0]),s<=1.00000001&&(this.moveToCenter=!0);var r=e*this.mat[0]-this.mat[0];if(r>1e-4||r<-1e-4){this.animationStack=[];for(var n=2*this.maxStep,a=3*r/(n*n*n),o=-2*n*a,l=a*n*n,h=this.mat[0],d=0;d<n;d++){var u=a*d+a/3+o/2+l;l+=a*(2*d+1)+o;var m=1+u/h;h+=u,this.animationStack.push([m,t,i])}this.animating=this.moveToCenter;var c=this;clearInterval(this.moveInterval),clearInterval(this.zoomInterval),this.zoomInterval=setInterval((function(){c._zoomAnimation()}),35),this.renderer.updateData=!1,this.isMoving=this.moveToCenter}else if(this.moveToCenter){this.animating=!0,this.isMoving=!0;c=this;this.animationStack=[],clearInterval(this.moveInterval),clearInterval(this.zoomInterval),this.zoomInterval=setInterval((function(){c._zoomAnimation()}),35),this.renderer.updateData=!1}return!1},_zoomAnimation:function(){if(0!=this.animationStack.length){var e=this.animationStack.splice(0,1)[0],t=e[0];tx=e[1],ty=e[2];var i=sglMulM4(sglTranslationM4C(tx,ty,0),sglMulM4(sglScalingM4C(t,t,1),sglMulM4(sglTranslationM4C(-tx,-ty,0),this.mat))),s=this.returnModelMatrix(this.translation,i),r=sglMulM4V4(s,sglV4C(this.leftBottom[0],this.leftBottom[1],0,1)).slice(0,2),n=sglMulM4V4(s,sglV4C(this.rightTop[0],this.rightTop[1],0,1)).slice(0,2);r[0]-=this.viewerdx,r[1]-=this.viewerdy,n[0]+=this.viewerdx,n[1]+=this.viewerdy;var a=n[0]-r[0],o=n[1]-r[1];c=0,g=0;if(a>this.ui.width&&o>this.ui.height)n[0]<this.ui.width?c+=this.ui.width-n[0]:r[0]>0&&(c-=r[0]),n[1]<this.ui.height?g+=this.ui.height-n[1]:r[1]>0&&(g-=r[1]);else if(a>this.ui.width)ty=this.ui.height/2-this.translation[1],n[0]<this.ui.width?c+=this.ui.width-n[0]:r[0]>0&&(c-=r[0]);else{if(!(o>this.ui.height))return tx=this.ui.width/2,ty=this.ui.height/2,this.resetViewpoint(),void(0==this.animationStack.lenght&&(clearInterval(this.zoomInterval),this.renderer.updateData=!0));tx=this.ui.width/2-this.translation[0],n[1]<this.ui.height?g+=this.ui.height-n[1]:r[1]>0&&(g-=r[1])}this.mat=sglMulM4(sglTranslationM4C(tx,ty,0),sglMulM4(sglScalingM4C(t,t,1),sglMulM4(sglTranslationM4C(-tx,-ty,0),this.mat))),this.translation[0]+=c,this.translation[1]+=g,_SGL_RegisteredCanvas[this.canvas].requestDraw()}else{if(clearInterval(this.zoomInterval),this.moveToCenter){var l=this;clearInterval(this.moveInterval),this.moveInterval=setInterval((function(){l._moveAnimation()}),35),this.renderer.updateData=!1,this.isMoving=!0,this.computeModelMatrix();var h=this.xform.model.top,d=[this.renderer._tree.scale[0]/2,this.renderer._tree.scale[1]/2],u=[this.ui.width/2,this.ui.height/2],m=sglMulM4V4(h,sglV4C(d[0],d[1],0,1)).slice(0,2),c=u[0]-m[0],g=u[1]-m[1];this.currentSpeed=0,this.currentPoint=m,this._updateMoveStack(m,u,sglV2C(c,g))}else this.renderer.updateData=!0;this.animating=!1}},sendMouseDown:function(e){_SGL_RegisteredCanvas[this.canvas].mouseDown(e)},mouseDown:function(e,t,i,s){if(this.animating)return!1;if(0==t){if(this.ui.keysDown[17])return this._setLightDir(i,s),!0;if(0==this.mode){this.endAnimation=!1,this.currentPoint=[i,s],this.animationStack=[];var r=this;return clearInterval(this.zoomInterval),clearInterval(this.moveInterval),this.moveInterval=setInterval((function(){r._moveAnimation()}),35),this.renderer.updateData=!1,this.isMoving=!0,!1}return 1==this.mode&&this._setLightDir(i,s),!0}},_moveAnimation:function(){if((this.moveToCenter||this.endAnimation)&&0==this.animationStack.length)return clearInterval(this.moveInterval),this.renderer.updateData=!0,this.isMoving=!1,this.animating=!1,void(this.moveToCenter=!1);if(0!=this.animationStack.length){var e=this.animationStack.splice(0,1)[0],t=e[0]-this.currentPoint[0],i=e[1]-this.currentPoint[1];this.currentSpeed=e[2],this.translation[0]+=t,this.translation[1]+=i,this.currentPoint[0]=e[0],this.currentPoint[1]=e[1],_SGL_RegisteredCanvas[this.canvas].requestDraw()}else this.currentSpeed=0},mouseUp:function(e,t,i,s){return 0==t&&0==this.mode&&(this.endAnimation=!0,this.renderer.updateData=!0,this.isMoving=!1),!1},mouseOut:function(e,t,i,s){this.endAnimation=!0,this.isMoving=!1},mouseMove:function(e,t,i){if(this.animating)return!1;if(this.ui.mouseButtonsDown[0]){if(0==this.mode){if(this.ui.keysDown[17])return this._setLightDir(t,i),!0;var s=[t,i],r=s[0]-this.currentPoint[0],n=s[1]-this.currentPoint[1],a=this._adjustTranslation(r,n);return s=[this.currentPoint[0]+a[0],this.currentPoint[1]+a[1]],this._updateMoveStack(this.currentPoint,s,a),!1}return this._setLightDir(t,i),!0}return!1},_updateMoveStack:function(e,t,i){var s=sglLengthV2(i);if(s>.1){this.animationStack.splice(0,this.animationStack.length);var r=sglNormalizedV2(i),n=2*(s/2-this.currentSpeed*this.maxStep)/(this.maxStep*this.maxStep),a=this.currentSpeed,o=[e[0],e[1]],l=this.maxStep,h=0,d=0;if(n>0){for(var u=0;u<this.maxStep;u++){var m=n/2+a;a+=n,m;var c=r[0]*m,g=r[1]*m;o[0]+=c,o[1]+=g,this.animationStack.push([o[0],o[1],a,n])}l=3*s/(2*a),d=4*a*a*a/(9*s*s),h=-4*a*a/(3*s)}else l=6*s/(2*a),d=a*a*a/(9*s*s),h=-2*a*a/(3*s);for(u=0;u<l;u++){m=d*u+d/3+h/2+a;a+=d*(2*u+1)+h;c=r[0]*m,g=r[1]*m;o[0]+=c,o[1]+=g,this.animationStack.push([o[0],o[1],a,d])}this.animationStack.push([t[0],t[1],0,0])}},_adjustTranslation:function(e,t){var i=sglV4C(this.translation[0]+e,this.translation[1]+t,0,1),s=this.returnModelMatrix(i,this.mat),r=sglMulM4V4(s,sglV4C(this.leftBottom[0],this.leftBottom[1],0,1)).slice(0,2),n=sglMulM4V4(s,sglV4C(this.rightTop[0],this.rightTop[1],0,1)).slice(0,2);r[0]-=this.viewerdx,r[1]-=this.viewerdy,n[0]+=this.viewerdx,n[1]+=this.viewerdy;var a=n[0]-r[0],o=n[1]-r[1],l=e,h=t;return a>this.ui.width&&o>this.ui.height?(n[0]<this.ui.width?l+=this.ui.width-n[0]:r[0]>0&&(l-=r[0]),n[1]<this.ui.height?h+=this.ui.height-n[1]:r[1]>0&&(h-=r[1])):a>this.ui.width?(n[0]<this.ui.width?l+=this.ui.width-n[0]:r[0]>0&&(l-=r[0]),h=0):o>this.ui.height?(n[1]<this.ui.height?h+=this.ui.height-n[1]:r[1]>0&&(h-=r[1]),l=0):(l=0,h=0),sglV2C(l,h)},update:function(e,t){},returnModelMatrix:function(e,t){var i=sglMulM4(sglTranslationM4C(e[0],e[1],1),t);i=sglMulM4(this.flipMatrix,i),this.xform.model.load(i);var s=sglTranslationM4C(this.ui.width/2,this.ui.height/2,0);return this.xform.model.multiply(s),this.xform.model.scale(this.scale,this.scale,1),this.xform.model.multiply(this.renderer.normalizedTreeTransform),this.xform.model.top},computeModelMatrix:function(){var e=sglMulM4(sglTranslationM4C(this.translation[0],this.translation[1],1),this.mat);e=sglMulM4(this.flipMatrix,e),this.xform.model.load(e);var t=sglTranslationM4C(this.ui.width/2,this.ui.height/2,0);this.xform.model.multiply(t),this.xform.model.scale(this.scale,this.scale,1),this.xform.model.multiply(this.renderer.normalizedTreeTransform)},resize:function(){this.xform=new SglTransformStack,this.translation=[0,0],this.mat=sglIdentityM4(),this.rendering=!0,this.leftBottom=[(this.renderer._tree.scale[0]-this.renderer.imgWidth)/2,(this.renderer._tree.scale[1]-this.renderer.imgHeight)/2],this.rightTop=[this.leftBottom[0]+this.renderer.imgWidth,this.leftBottom[1]+this.renderer.imgHeight],this.scale=0;var e=this.ui.width;this.offsetHeight=0;var t=this.ui.height+this.offsetHeight;this.scale=Math.min(this.renderer._tree.scale[0]/this.renderer.imgWidth*e,this.renderer._tree.scale[1]/this.renderer.imgHeight*t),this.maxScale=3*Math.max(this.renderer.imgWidth/e,this.renderer.imgHeight/t),this.viewerdx=this.ui.width/2-10,this.viewerdy=this.ui.height/2-10},draw:function(e){if(e.getError()==e.CONTEXT_LOST_WEBGL&&console.log("WebGL Context lost"),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),1==this.rendering){var t=this.ui.width,i=this.ui.height;e.viewport(0,0,t,i),this.xform.projection.loadIdentity(),this.xform.projection.ortho(0,t,0,i,-4096,4096),this.xform.view.loadIdentity(),this.xform.view.lookAt(0,0,2,0,0,0,0,1,0),this.computeModelMatrix();var s=this.xform.model.top;this.onDrawCallback&&this.onDrawCallback(s),this.renderer.render(this.xform.projectionMatrix,this.xform.modelViewMatrix,[0,0,t,i])}}},MultiResTree.prototype={_load:function(e,t,i){this.ready=!0;var s=sglGetLines(e),r=s.length,n=null;if(!(r<=(S=0)||(n=s[S++].split(" ")).length<2)){var a=parseInt(n[0]);if(!(a<=0)){var o=parseInt(n[1]);if(!(o<0||o>=a||r<=S||(n=s[S++].split(" ")).length<1)){var l=parseInt(n[0]);if(!(l<=0||r<=S||(n=s[S++].split(" ")).length<3)){var h=[1,1,1];if(h[0]=parseFloat(n[0]),h[1]=parseFloat(n[1]),h[2]=parseFloat(n[2]),!(r<=S||(n=s[S++].split(" ")).length<3)){var d=[0,0,0];d[0]=parseFloat(n[0]),d[1]=parseFloat(n[1]),d[2]=parseFloat(n[2]);var u=new Array(a);if(r>S)for(var m=0;m<a;++m){var c=new MultiResNode;if(r<=S)return;if((n=s[S++].split(" ")).length<14)return;if(c.id=parseInt(n[0]),c.id<=0)return;if(c.parentIndex=parseInt(n[1]),c.parentIndex<-1||c.parentIndex>=a)return;for(var g=0;g<4;++g)if(c.childrenIndices[g]=parseInt(n[g+2]),c.childrenIndices[g]<-1||c.childrenIndices[g]>=a)return;c.projectedSize=parseFloat(n[6]),c.zScale=parseFloat(n[7]),c.box.min[0]=parseFloat(n[8]),c.box.min[1]=parseFloat(n[9]),c.box.min[2]=parseFloat(n[10]),c.box.max[0]=parseFloat(n[11]),c.box.max[1]=parseFloat(n[12]),c.box.max[2]=parseFloat(n[13]),c.isLeaf=!0;for(var f=0;f<4;++f)if(c.childrenIndices[f]>=0){c.isLeaf=!1;break}u[m]=c}else{for(var p=0,_=h[0],v=1;_>l;)v++,_/=2;for(var x=(h[0]-t)/2/h[0],b=(h[1]-i)/2/h[1],M=new SglBox3([x,b,0],[x+t/h[0],b+i/h[1],1]),w=M.size,y=M.center,S=0;S<v;S++){var I=Math.pow(4,S);for(f=0;f<I;f++){(c=new MultiResNode).id=p+1,c.parentIndex=p>0?Math.ceil(p/4)-1:-1,S<v-1&&(c.isLeaf=!1);for(g=0;g<4;++g)c.childrenIndices[g]=S==v-1?-1:4*p+1+(g+2)%4;if(c.projectedSize=l,p>0){var T=p%4,R=u[c.parentIndex],F=R.box.min[0]+(R.box.max[0]-R.box.min[0])/2,L=R.box.min[1]+(R.box.max[1]-R.box.min[1])/2;1==T?c.box=new SglBox3([R.box.min[0],L,0],[F,R.box.max[1],1]):2==T?c.box=new SglBox3([F,L,0],R.box.max):3==T?c.box=new SglBox3(R.box.min,[F,L,1]):0==T&&(c.box=new SglBox3([F,R.box.min[1],0],[R.box.max[0],L,1]));var C=c.box.center,k=c.box.size,z=sglSelfMulV3S(sglAddV3(w,k),.5),P=sglSubV3(y,C);Math.abs(P[0])<=z[0]&&Math.abs(P[1])<=z[1]&&Math.abs(P[2])<=z[2]?c.zScale=1:c.zScale=0}else c.box=new SglBox3([0,0,0],[1,1,1]),c.zScale=1;u[p]=c,p++}}}this.nodesCount=a,this.rootIndex=o,this.tileSize=l,this.scale=h,this.offset=d,this.nodes=u}}}}}},destroy:function(e){var t=null;for(var i in this.nodes)(t=this.nodes[i]).req&&(t.req.onLoad=null,t.req=null),t.data&&(e(t.data),t.data=null);this.ready=!0,this.nodesCount=0,this.rootIndex=-1,this.nodes=null,this.url=null,this.tileSize=0,this.scale=[1,1,1]},load:function(e,t,i,s){if(!e)return!1;this._load(e,t,i)},get isEmpty(){return this.nodesCount<=0},get root(){var e=this.rootIndex;return e<0?null:this.nodes[e]},parent:function(e){var t=e.parentIndex;return t<0?null:this.nodes[t]},child:function(e,t){var i=e.childrenIndices[t];return i<0?null:this.nodes[i]}},MultiResRenderer.prototype={computeLightingFunction:function(e){switch(this.enumType[this.type]){case 1:var t=Math.atan2(e[1],e[0]);t<0&&(t=2*Math.PI+t);var i=Math.min(Math.acos(e[2]),Math.PI/2-.15),s=Math.cos(t),r=Math.cos(i),n=r*r;return(a=new Array(9))[0]=1/Math.sqrt(2*Math.PI),a[1]=Math.sqrt(6/Math.PI)*(s*Math.sqrt(r-n)),a[2]=Math.sqrt(3/(2*Math.PI))*(2*r-1),a[3]=Math.sqrt(6/Math.PI)*(Math.sqrt(r-n)*Math.sin(t)),a[4]=Math.sqrt(30/Math.PI)*(Math.cos(2*t)*(-r+n)),a[5]=Math.sqrt(30/Math.PI)*(s*(2*r-1)*Math.sqrt(r-n)),a[6]=Math.sqrt(5/(2*Math.PI))*(1-6*r+6*n),a[7]=Math.sqrt(30/Math.PI)*((2*r-1)*Math.sqrt(r-n)*Math.sin(t)),a[8]=Math.sqrt(30/Math.PI)*((-r+n)*Math.sin(2*t)),a;case 2:case 3:var a;return(a=new Array(6))[0]=e[0]*e[0],a[1]=e[1]*e[1],a[2]=e[0]*e[1],a[3]=e[0],a[4]=e[1],a[5]=1,a}return[]},loadImage:function(e){var t=new XMLHttpRequest,i=null;i="string"==typeof e?e+"/info.xml":e("/info.xml"),t.overrideMimeType("text/xml"),t.open("GET",i,!1),t.send();var s=t.responseXML;this.format="jpg";var r=parseInt(s.getElementsByTagName("MultiRes")[0].getAttribute("format"));isNaN(r)||1==r&&(this.format="png");var n=s.getElementsByTagName("Content")[0];if(this.type=n.getAttribute("type"),!(this.type in this.enumType))return!1;var a=null;switch(this.enumType[this.type]){case 1:case 2:case 3:var o=s.getElementsByTagName("Size")[0],l=s.getElementsByTagName("Scale")[0],h=s.getElementsByTagName("Bias")[0];if(a=s.getElementsByTagName("Tree")[0],this.imgWidth=parseInt(o.getAttribute("width")),this.imgHeight=parseInt(o.getAttribute("height")),this.ordlen=parseInt(o.getAttribute("coefficients")),this.numLayers=this.ordlen,2==this.enumType[this.type]&&(this.numLayers=3),tokens=l.childNodes[0].nodeValue.split(" "),tokens.length<this.ordlen)return;this.gmax=[];for(var d=0;d<this.ordlen;d++)this.gmax[d]=parseFloat(tokens[d]);if(tokens=h.childNodes[0].nodeValue.split(" "),tokens.length<this.ordlen)return;this.gmin=[];for(d=0;d<this.ordlen;d++)this.gmin[d]=parseFloat(tokens[d]);break;case 4:o=s.getElementsByTagName("Size")[0];a=s.getElementsByTagName("Tree")[0],this.imgWidth=parseInt(o.getAttribute("width")),this.imgHeight=parseInt(o.getAttribute("height")),this.ordlen=parseInt(o.getAttribute("coefficients")),this.numLayers=this.ordlen;break;default:return}switch(this._tree&&this._tree.destroy(this._destroyData),this._tree.load(a.textContent,this.imgWidth,this.imgHeight),this._url=e,this._timestamp=0,this._frustum=new SglFrustum,this._maxError=1,this._cache=[],this._toRequest=[],this._toRenderFullRes=[],this._toRenderHalfRes=[],this._readyItems=[],this.renderData=!0,this.renderBoxes=!1,this.lightPos=[0,0,1],this.lweights=[],this.lweights=this.computeLightingFunction(this.lightPos),null!=this._program&&this._program.destroy(),this.enumType[this.type]){case 1:var u=sglLoadFile("/assets/webViewer/spidergl/multi.v.glsl"),m=sglLoadFile("/assets/webViewer/spidergl/hsh.f.glsl");log((c=new SglProgram(this.gl,[u],[m])).log),this._program=c;break;case 2:u=sglLoadFile("/assets/webViewer/spidergl/multi.v.glsl"),m=sglLoadFile("/assets/webViewer/spidergl/lrgbptm.f.glsl");log((c=new SglProgram(this.gl,[u],[m])).log),this._program=c;break;case 3:u=sglLoadFile("/assets/webViewer/spidergl/multi.v.glsl"),m=sglLoadFile("/assets/webViewer/spidergl/rgbptm.f.glsl");log((c=new SglProgram(this.gl,[u],[m])).log),this._program=c;break;case 4:var c;u=sglLoadFile("/assets/webViewer/spidergl/multi.v.glsl"),m=sglLoadFile("/assets/webViewer/spidergl/image.f.glsl");log((c=new SglProgram(this.gl,[u],[m])).log),this._program=c;break;default:this._program=new SglProgram}this._renderer=new SglMeshGLRenderer(this._program),this._treeTransform=sglIdentityM4(),this._normalizedTreeTransform=sglIdentityM4(),this.leftTex=(this._tree.scale[0]-this.imgWidth)/2,this.rightTex=this.leftTex+this.imgWidth,this.bottomTex=(this._tree.scale[1]-this.imgHeight)/2,this.topTex=this.bottomTex+this.imgHeight,this.leftTex/=this._tree.scale[0],this.rightTex/=this._tree.scale[0],this.bottomTex/=this._tree.scale[1],this.topTex/=this._tree.scale[1],this._tree.ready&&this._setupTree()},_createLg:function(){var e=document.createElement("canvas");e.height=50,e.width=80;var t=e.getContext("2d");t.save(),t.beginPath(),t.moveTo(0,0),t.lineTo(80,0),t.lineTo(80,50),t.lineTo(0,50),t.closePath(),t.clip(),t.strokeStyle="rgba(0,0,0,0)",t.lineCap="butt",t.lineJoin="miter",t.miterLimit=4,t.save(),t.restore(),t.save(),t.restore(),t.save(),t.transform(.21814175,0,0,.21573678,-3.3721339,-3.3665838),t.save(),t.translate(14.071762,20),t.save(),g=t.createRadialGradient(239.50893,204.66128888494003,0,239.50893,204.66128888494003,31.820419),g.addColorStop(0,"rgba(255, 255, 255, 1)"),g.addColorStop(1,"rgba(151, 151, 151, 1)"),t.fillStyle=g,t.strokeStyle="#000000",t.lineWidth=2.4923694133758545,t.lineCap="round",t.lineJoin="round",t.miterLimit=4,t.transform(2.1234583,0,0,1.6108995,-256.37574,-264.34719),t.beginPath(),t.moveTo(271.42857,233.79076),t.translate(240,233.80553976769053),t.rotate(0),t.scale(.7586207296076113,1),t.arc(0,0,41.42857,-.00035675303306008355,3.1419494066230014,0),t.scale(1.318181748760332,1),t.rotate(0),t.translate(-240,-233.80553976769053),t.translate(240,233.77598023230948),t.rotate(0),t.scale(.7586207296076113,1),t.arc(0,0,41.42857,3.141235900556733,6.2835420602127945,0),t.scale(1.318181748760332,1),t.rotate(0),t.translate(-240,-233.77598023230948),t.closePath(),t.fill(),t.stroke(),t.restore(),t.save(),t.fillStyle="#ececec",t.strokeStyle="#000000",t.lineWidth=4.609655857086182,t.lineCap="butt",t.lineJoin="round",t.miterLimit=4,t.beginPath(),t.moveTo(49.495605,44.507569),t.lineTo(129.49561,79.507569),t.lineTo(209.49561,44.507569),t.lineTo(49.495605,44.507569),t.closePath(),t.fill(),t.stroke(),t.restore(),t.save(),t.fillStyle="#999999",t.strokeStyle="#000000",t.lineWidth=4.609655857086182,t.lineCap="butt",t.lineJoin="round",t.miterLimit=4,t.beginPath(),t.moveTo(129.49561,174.50757),t.lineTo(129.49561,79.507572),t.lineTo(209.49561,44.507572),t.lineTo(129.49561,174.50757),t.closePath(),t.fill(),t.stroke(),t.restore(),t.save(),t.fillStyle="#b3b3b3",t.strokeStyle="#000000",t.lineWidth=4.609655857086182,t.lineCap="butt",t.lineJoin="round",t.miterLimit=4,t.beginPath(),t.moveTo(129.49561,174.50757),t.lineTo(129.49561,79.507569),t.lineTo(49.495605,44.507569),t.lineTo(129.49561,174.50757),t.closePath(),t.fill(),t.stroke(),t.restore(),t.save(),g=t.createLinearGradient(236.58487,196.44904,257.4877,320.66739),g.addColorStop(0,"rgba(255, 255, 255, 1)"),g.addColorStop(1,"rgba(151, 151, 151, 1)"),t.fillStyle=g,t.strokeStyle="#000000",t.lineWidth=3.3579113483428955,t.lineCap="round",t.lineJoin="round",t.miterLimit=4,t.transform(1.4965962,0,0,1.2591977,-86.218969,-182.0266),t.beginPath(),t.moveTo(271.42857,233.79076),t.translate(240,233.80553976769053),t.rotate(0),t.scale(.7586207296076113,1),t.arc(0,0,41.42857,-.00035675303306008355,3.1419494066230014,0),t.scale(1.318181748760332,1),t.rotate(0),t.translate(-240,-233.80553976769053),t.translate(240,233.77598023230948),t.rotate(0),t.scale(.7586207296076113,1),t.arc(0,0,41.42857,3.141235900556733,6.2835420602127945,0),t.scale(1.318181748760332,1),t.rotate(0),t.translate(-240,-233.77598023230948),t.closePath(),t.fill(),t.stroke(),t.restore(),t.restore(),t.restore(),t.restore();var i=new Image,s=e.toDataURL("image/png");i.src=s;var r=this;i.onload=function(){var e={generateMipmap:!1,minFilter:r.gl.NEAREST,magFilter:r.gl.NEAREST};r.lgtex=new SglTexture2D(r.gl,i,e)};var n=this.gl.getError();console.log(n)},_createData:function(e){for(var t={minFilter:this.gl.LINEAR,magFilter:this.gl.LINEAR,generateMipmap:!1},i=new Array(e.length),s=0;s<e.length;++s)i[s]=new SglTexture2D(this.gl,e[s],t);return{textures:i}},_destroyData:function(e){if(e){for(var t=0;t<e.textures.length;++t)e.textures[t].destroy();e.textures=null}},_requestNode:function(e){if(!e.req){var t=this;if("string"==typeof this._url)var i=this._url+"/"+e.id;for(var s=new Array,r=1;r<=this.numLayers;r++){if("string"==typeof this._url)var n=i+"_"+r+"."+this.format;else n=this._url("/"+e.id+"_"+r+"."+this.format);s.push(new SglImageRequest(n))}var a=new SglRequestWatcher(s,(function(i){t._currentOngoingRequests--,t._readyItems.push(e)}));e.req=a,a.send()}},_collectNodesRec:function(e,t){var i={needed:!1,usable:!!e.data};if(0==e.zScale)return i;if(!t){var s=this._frustum.boxVisibility(e.box.min,e.box.max);if(s==SGL_OUTSIDE_FRUSTUM)return i;t=s==SGL_INSIDE_FRUSTUM}i.needed=!0;var r=this._frustum.projectedSegmentSize(e.box.center,e.box.size[0])/e.projectedSize;if(e.priority.timestamp=this._timestamp,e.priority.error=r,!i.usable)return e.req||this._toRequest.push(e),i;if(r<this._maxError||e.isLeaf)return this._toRenderFullRes.push(e),i;for(var n=null,a=0,o=0,l=null,h=[],d=0;d<4;++d)(n=this._tree.child(e,d))&&((l=this._collectNodesRec(n,t)).usable&&o++,l.needed&&(a++,l.usable||h.push(d)));return a>0&&(o<=0?this._toRenderFullRes.push(e):h.length>0&&this._toRenderHalfRes.push({n:e,children:h})),i},_collectNodes:function(){this._toRequest=[],this._toRenderFullRes=[],this._toRenderHalfRes=[];var e=this._tree.root;e&&this._collectNodesRec(e,!1)},_renderNodeFullRes:function(e){for(var t={u_world_box_min:e.box.min,u_world_box_max:e.box.max},i=[],s=0;s<this.numLayers;s++)i["coeff"+s]=e.data.textures[s];this._renderer.setUniforms(t),this._renderer.setSamplers(i),this._renderer.render()},_renderNodesFullRes:function(e){var t;t=this._tileFullMesh;var i={u_model_view_projection_matrix:e,u_scale_bias:[1,1,0,0],u_texcoord_scale_bias:[this._tree.tileSize/(this._tree.tileSize+2),1/(this._tree.tileSize+2)],ordlen:this.ordlen,leftTex:this.leftTex,rightTex:this.rightTex,bottomTex:this.bottomTex,topTex:this.topTex};if(4!=this.enumType[this.type])for(var s=0;s<this.ordlen;s++)i["gmax"+s]=this.gmax[s],i["gmin"+s]=this.gmin[s],i["lweight"+s]=this.lweights[s];this._renderer.begin(),this._renderer.setUniforms(i),this._renderer.beginMesh(t),this._renderer.beginPrimitives("tristrip");var r=null;for(var s in this._toRenderFullRes)r=this._toRenderFullRes[s],this._renderNodeFullRes(r);this._renderer.endPrimitives(),this._renderer.endMesh(),this._renderer.end()},_renderNodeHalfRes:function(e,t){for(var i={u_world_box_min:null,u_world_box_max:null,u_scale_bias:null},s=[],r=0;r<this.numLayers;r++)s["coeff"+r]=e.data.textures[r];this._renderer.setSamplers(s);var n=[[.5,.5,0,0],[.5,.5,.5,0],[.5,.5,0,.5],[.5,.5,.5,.5]],a=null;for(var r in t)a=this._tree.child(e,t[r]),i.u_world_box_min=a.box.min,i.u_world_box_max=a.box.max,i.u_scale_bias=n[t[r]],this._renderer.setUniforms(i),this._renderer.render()},_renderNodesHalfRes:function(e){var t;t=this._tileHalfMesh;var i={u_model_view_projection_matrix:e,u_texcoord_scale_bias:[this._tree.tileSize/(this._tree.tileSize+2),1/(this._tree.tileSize+2)],ordlen:this.ordlen,leftTex:this.leftTex,rightTex:this.rightTex,bottomTex:this.bottomTex,topTex:this.topTex};if(4!=this.enumType[this.type])for(var s=0;s<this.ordlen;s++)i["gmax"+s]=this.gmax[s],i["gmin"+s]=this.gmin[s],i["lweight"+s]=this.lweights[s];this._renderer.begin(),this._renderer.setUniforms(i),this._renderer.beginMesh(t),this._renderer.beginPrimitives("tristrip");var r=null;for(var s in this._toRenderHalfRes)r=this._toRenderHalfRes[s],this._renderNodeHalfRes(r.n,r.children);this._renderer.endPrimitives(),this._renderer.endMesh(),this._renderer.end()},_renderNodes:function(e){this._renderNodesFullRes(e),this._renderNodesHalfRes(e)},_renderNodeFullResBox:function(e){var t=e.box.size,i={u_world_box_min:sglAddV3S(e.box.min,.05*t[0]),u_world_box_max:sglSubV3S(e.box.max,.05*t[0]),u_color:e.isLeaf?[1,0,1]:[0,1,0]};this._boxRenderer.setUniforms(i),this._boxRenderer.render()},_renderNodesFullResBoxes:function(e){var t={u_model_view_projection_matrix:e};this._boxRenderer.begin(),this._boxRenderer.setUniforms(t),this._boxRenderer.beginMesh(this._boxMesh),this._boxRenderer.beginPrimitives("edges");var i=null;for(var s in this._toRenderFullRes)i=this._toRenderFullRes[s],this._renderNodeFullResBox(i);this._boxRenderer.endPrimitives(),this._boxRenderer.endMesh(),this._boxRenderer.end()},_renderNodeHalfResBox:function(e,t){var i={u_world_box_min:null,u_world_box_max:null,u_color:null},s=null;for(var r in t)s=this._tree.child(e,t[r]),sz=s.box.size,i.u_world_box_min=sglAddV3S(s.box.min,.05*sz[0]),i.u_world_box_max=sglSubV3S(s.box.max,.05*sz[0]),i.u_color=s.isLeaf?[1,1,0]:[1,1,1],this._boxRenderer.setUniforms(i),this._boxRenderer.render()},_renderNodesHalfResBoxes:function(e){var t={u_model_view_projection_matrix:e};this._boxRenderer.begin(),this._boxRenderer.setUniforms(t),this._boxRenderer.beginMesh(this._boxMesh),this._boxRenderer.beginPrimitives("edges");var i=null;for(var s in this._toRenderHalfRes)i=this._toRenderHalfRes[s],this._renderNodeHalfResBox(i.n,i.children);this._boxRenderer.endPrimitives(),this._boxRenderer.endMesh(),this._boxRenderer.end()},_renderNodesBoxes:function(e){this.gl.lineWidth(2),this.gl.depthFunc(this.gl.LEQUAL),this._renderNodesFullResBoxes(e),this._renderNodesHalfResBoxes(e),this.gl.depthFunc(this.gl.LESS),this.gl.lineWidth(1)},_doRender:function(e,t,i){var s=sglMulM4(t,this._treeTransform);this._timestamp++,this._frustum.setup(e,s,i),this._collectNodes();var r=sglMulM4(e,s);if(this.renderData&&this._renderNodes(r),this.renderBoxes&&this._renderNodesBoxes(r),this.lg&&null!=this.lgtex){this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);var n={u_mvp:sglMulM4(e,sglScalingM4C(1,1,1))},a={s_texture:this.lgtex};sglRenderMeshGLPrimitives(this.lgMesh,"tristrip",this.texProg,null,n,a),this.gl.disable(this.gl.BLEND)}},_updateCache:function(){var e=this._readyItems.slice(0,1);this._readyItems.splice(0,1);var t=this._cache.concat(e);t.sort(_MultiResCompareNodes);var i=t.length,s=this._maxCacheSize<i?this._maxCacheSize:i;this._cache=t.splice(0,s);for(var r=t,n=null,a=null,o=[],l=0;l<s;++l)if(a=(n=this._cache[l]).req,n.req=null,a)if(a.succeeded){var h=new Array(a.requests.length);for(l=0;l<h.length;++l)h[l]=a.requests[l].image;n.data&&this._destroyData(n.data),n.data=this._createData(h)}else o.push(l);var d=o.length,u=0;s=r.length;for(l=0;l<s;++l)a=(n=r[l]).req,n.req=null,a||(u<d?(this._cache[o[u]]=n,u++):(this._destroyData(n.data),n.data=null));u>0&&this._cache.sort(_MultiResCompareNodes)},_requestNodes:function(){var e=this._cache.length,t=e>0?this._cache[e-1]:null;this._toRequest.sort(_MultiResCompareNodes);for(var i=this._maxOngoingRequests-this._currentOngoingRequests,s=0,r=this._toRequest.length,n=null,a=!1,o=0;o<r&&s<i;++o)(n=this._toRequest[o]).req||(a=!0,null!=t&&e>=this._maxCacheSize&&(a=_MultiResCompareNodes(n,t)<0),a&&(this._requestNode(n),s++))},_calculateNormalizedTreeTransform:function(){var e=this._tree.root;if(!e)return sglIdentityM4();var t=new SglBox3;t.min=sglAddV3(sglMulV3(e.box.min,this._tree.scale),this._tree.offset),t.max=sglAddV3(sglMulV3(e.box.max,this._tree.scale),this._tree.offset),this._treeTransform=sglMulM4(sglTranslationM4V(this._tree.offset),sglScalingM4V(this._tree.scale));var i=t.center,s=t.size,r=s[0];r<s[1]&&(r=s[1]),r<s[2]&&(r=s[2]);var n=r>0?1/r:1,a=sglScalingM4C(n,n,n),o=sglTranslationM4C(-i[0],-i[1],-i[2]),l=sglMulM4(a,o);this._normalizedTreeTransform=l},_setupTree:function(){if(this._tree.root){var e=this.gl,t=(this._tree.tileSize+2)*(this._tree.tileSize+2)*this.ordlen*3;this._maxCacheSize=sglFloor(this._cacheSizeInBytes/t),this._maxCacheSize<=0&&(this._maxCacheSize=1);var i=new Float32Array([-.5,.5,-.5,-.5,.5,.5,.5,-.5]),s=new SglMeshGL(e);s.addVertexAttribute("position",2,i),s.addArrayPrimitives("tristrip",e.TRIANGLE_STRIP,0,4),this._tileFullMesh=s,this._tileHalfMesh=s,this._calculateNormalizedTreeTransform()}},render:function(e,t,i){this._tree.root&&(this._doRender(e,t,i),this.updateData&&(this._updateCache(),this._requestNodes()))},get normalizedTreeTransform(){return this._normalizedTreeTransform}};
//# sourceMappingURL=webrti.min.js.map
