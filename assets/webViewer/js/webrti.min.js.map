{"version":3,"sources":["spidergl.js","multires.js"],"names":["sglUnknown","Error","sglUnsupported","sglUnimplemented","sglInvalidParameter","sglInvalidCall","sglDefineConstant","ClassName","constantName","constantValue","sglInherit","DerivedClassName","BaseClassName","prototype","constructor","sglInitialize","sglFinalize","sglNodeText","domNodeID","node","document","getElementById","str","n","firstChild","nodeType","textContent","nextSibling","sglLoadFile","url","callback","async","req","XMLHttpRequest","onreadystatechange","readyState","responseText","open","send","ret","sglGetLines","text","allLines","split","length","lines","line","i","replace","push","SglRequest","onReadyCallback","this","_priority","_status","SGL_REQUEST_IDLE","_queue","_onReady","addOnReadyCallback","SglTextFileRequest","apply","Array","slice","call","arguments","_url","_req","Object","defineProperty","get","SglImageRequest","_img","SglRequestWatcher","reqs","_waitingReqs","_succeededReqs","_failedReqs","_reqs","t","cb","r","succeeded","failed","isReady","SglRequestQueue","maxOngoing","maxQueued","_maxOngoing","_maxQueued","_ongoing","_queued","_minPriorityReq","_priorityCompare","_dirty","sglAbs","x","Math","abs","sglFloor","floor","sglCeil","ceil","sglSqrt","sqrt","sglPow","y","pow","sglLog","log","sglExp","exp","sglSin","sin","sglAsin","asin","sglCos","cos","sglAcos","acos","sglTan","tan","sglAtan","atan","sglAtan2","atan2","sglDegToRad","SGL_PI","sglRadToDeg","sglMin","a","b","min","sglMax","max","sglClamp","sglRandom01","random","sglMapVN","vArray","size","f","param","first","count","stride","undefined","last","v","k","j","sglMapV2","v2Array","sglMapV3","v3Array","sglMapV4","v4Array","sglUndefV2","sglV2V","sglV2S","s","sglV2C","sglZeroV2","sglOneV2","sglV2","sglDupV2","sglNegV2","sglAddV2","u","sglAddV2S","sglAddSV2","sglSubV2","sglSubV2S","sglSubSV2","sglMulV2","sglMulV2S","sglMulSV2","sglDivV2","sglDivV2S","sglDivSV2","sglRcpV2","sglDotV2","sglCrossV2","sglSqLengthV2","sglLengthV2","sglNormalizedV2","sglSelfNegV2","sglSelfAddV2","sglSelfAddV2S","sglSelfAddSV2","sglSelfSubV2","sglSelfSubV2S","sglSelfSubSV2","sglSelfMulV2","sglSelfMulV2S","sglSelfMulSV2","sglSelfDivV2","sglSelfDivV2S","sglSelfDivSV2","sglSelfRcpV2","sglSelfNormalizeV2","sglMinV2","sglMaxV2","sglV2toV3","z","sglV3C","sglV2toV4","w","sglV4C","sglUndefV3","sglV3V","sglV3S","sglZeroV3","sglOneV3","sglV3","sglDupV3","sglNegV3","sglAddV3","sglAddV3S","sglAddSV3","sglSubV3","sglSubV3S","sglSubSV3","sglMulV3","sglMulV3S","sglMulSV3","sglDivV3","sglDivV3S","sglDivSV3","sglRcpV3","sglDotV3","sglCrossV3","sglSqLengthV3","sglLengthV3","sglNormalizedV3","sglSelfNegV3","sglSelfAddV3","sglSelfAddV3S","sglSelfAddSV3","sglSelfSubV3","sglSelfSubV3S","sglSelfSubSV3","sglSelfMulV3","sglSelfMulV3S","sglSelfMulSV3","sglSelfDivV3","sglSelfDivV3S","sglSelfDivSV3","sglSelfRcpV3","sglSelfCrossV3","sglSelfNormalizeV3","sglMinV3","sglMaxV3","sglV3toV2","sglV3toV4","sglUndefV4","sglV4V","sglV4S","sglZeroV4","sglOneV4","sglV4","sglDupV4","sglNegV4","sglAddV4","sglAddV4S","sglAddSV4","sglSubV4","sglSubV4S","sglSubSV4","sglMulV4","sglMulV4S","sglMulSV4","sglDivV4","sglDivV4S","sglDivSV4","sglRcpV4","sglDotV4","sglSqLengthV4","sglLengthV4","sglNormalizedV4","sglProjectV4","sglSelfNegV4","sglSelfAddV4","sglSelfAddV4S","sglSelfAddSV4","sglSelfSubV4","sglSelfSubV4S","sglSelfSubSV4","sglSelfMulV4","sglSelfMulV4S","sglSelfMulSV4","sglSelfDivV4","sglSelfDivV4S","sglSelfDivSV4","sglSelfRcpV4","sglSelfNormalizeV4","sglSelfProjectV4","sglMinV4","sglMaxV4","sglV4toV2","sglV4toV3","sglUndefM4","sglM4V","sglM4S","m","sglDiagM4V","d","sglDiagM4S","sglDiagM4C","m00","m11","m22","m33","sglZeroM4","sglOneM4","sglIdentityM4","sglM4","sglDupM4","sglGetElemM4","row","col","sglSetElemM4","value","sglGetRowM4","sglSetRowM4V","sglSetRowM4S","sglSetRowM4C","sglGetColM4","c","sglSetColM4V","sglSetColM4S","sglSetColM4C","sglM4toM3","sglIsIdentityM4","sglNegM4","sglAddM4","sglAddM4S","sglAddSM4","sglSubM4","sglSubM4S","sglSubSM4","sglMulM4","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","a10","a11","a12","a13","a14","a15","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","b10","b11","b12","b13","b14","b15","sglMulM4S","sglMulSM4","sglMulM4V3","sglMulM4V4","sglDivM4S","sglDivSM4","sglRcpM4","sglCompMulM4","sglCompDivM4","sglTransposeM4","sglDeterminantM4","m0","m1","m2","m3","m4","m5","m6","m7","m8","m9","m10","m12","m13","m14","m15","sglInverseM4","sglTraceM4","sglTranslationM4V","sglTranslationM4C","sglTranslationM4S","sglRotationAngleAxisM4V","angleRad","axis","xx","yy","zz","xy","yz","zx","xs","ys","zs","ax","q","sglRotationAngleAxisM4C","ay","az","sglScalingM4V","sglScalingM4C","sglScalingM4S","sglLookAtM4V","position","target","up","sglLookAtM4C","positionX","positionY","positionZ","targetX","targetY","targetZ","upX","upY","upZ","sglOrthoM4V","omin","omax","sum","dif","sglOrthoM4C","left","right","bottom","top","zNear","zFar","sglFrustumM4V","fmin","fmax","sglFrustumM4C","sglPerspectiveM4","fovYRad","aspectRatio","pmin","pmax","sglUndefQuat","sglQuatV","sglIdentityQuat","sglAngleAxisQuat","halfAngle","fsin","sglM4Quat","trace","root","sglGetQuatAngleAxis","sqLen","invLen","aglAcos","sglGetQuatRotationM4","tx","ty","tz","twx","twy","twz","txx","txy","txz","tyy","tyz","tzz","sglNormalizedQuat","sglMulQuat","q1","q2","p","SglVec2","setVec","setScalar","setZero","SglVec3","SglVec4","SglPlane3","normal","offset","normalize","_normal","_offset","setup","SglBox3","_min","_max","SglSphere3","center","radius","_center","_radius","SglMatrixStack","_s","_n","SglTransformStack","_ms","_vs","_ps","_SglFrustumPlane","testVertex","SglFrustum","projectionMatrix","modelViewMatrix","viewport","_mvpMatrix","_viewport","_vp","_billboardMatrix","_planes","sglBoxVisibility","modelViewProjectionMatrix","boxMin","boxMax","fc","boxVisibility","_sglConsolidateOptions","fullOptions","usedOptions","attr","sglGetBufferOptions","gl","options","opt","usage","STATIC_DRAW","SglBufferInfo","handle","valid","sglBufferFromData","values","buff","createBuffer","bindBuffer","bufferData","obj","sizeInBytes","sglVertexBufferFromData","ARRAY_BUFFER","sglIndexBufferFromData","ELEMENT_ARRAY_BUFFER","SglShaderInfo","type","sglShaderFromSource","src","shd","createShader","shaderSource","compileShader","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","sglVertexShaderFromSource","VERTEX_SHADER","sglFragmentShaderFromSource","FRAGMENT_SHADER","SglProgramAttributeInfo","name","nativeType","location","SglProgramUniformInfo","SglProgramSamplerInfo","SglProgramInfo","shaders","attributes","uniforms","samplers","sglProgramFromShaders","prg","createProgram","attachShader","linkProgram","getProgramParameter","LINK_STATUS","getProgramInfoLog","loc","attribs_count","ACTIVE_ATTRIBUTES","getActiveAttrib","getAttribLocation","unif","uniforms_count","ACTIVE_UNIFORMS","getActiveUniform","getUniformLocation","SAMPLER_2D","SAMPLER_CUBE","sglSetDefaultProgramBindings","sglProgramFromSources","vertexSources","fragmentSources","programInfo","index","vattr","bindAttribLocation","useProgram","unit","smp","uniform1i","sglProgramSynchronize","sglGetTextureOptions","minFilter","LINEAR","magFilter","wrapS","CLAMP_TO_EDGE","wrapT","isDepth","depthMode","LUMINANCE","depthCompareMode","COMPARE_R_TO_TEXTURE","depthCompareFunc","LEQUAL","generateMipmap","flipY","premultiplyAlpha","onload","SglTextureInfo","format","width","height","sglTexture2DFromData","internalFormat","sourceFormat","sourceType","texels","FLOAT","Float32Array","Uint8Array","tex","createTexture","bindTexture","TEXTURE_2D","flipYEnabled","getParameter","UNPACK_FLIP_Y_WEBGL","flipYRequired","pixelStorei","texImage2D","texParameteri","TEXTURE_MIN_FILTER","TEXTURE_MAG_FILTER","TEXTURE_WRAP_S","TEXTURE_WRAP_T","DEPTH_TEXTURE_MODE","TEXTURE_COMPARE_MODE","TEXTURE_COMPARE_FUNC","sglTexture2DFromImage","image","RGBA","UNSIGNED_BYTE","sglTexture2DFromUrl","img","Image","crossOrigin","texInfo","sglTextureCubeFromData","facesTexels","TEXTURE_CUBE_MAP","TEXTURE_CUBE_MAP_POSITIVE_X","sglTextureCubeFromImages","images","sglTextureCubeFromUrls","urls","remaining","watcher","SglRenderbufferInfo","sglRenderbufferFromFormat","rb","createRenderbuffer","bindRenderbuffer","RENDERBUFFER","renderbufferStorage","sglGetFramebufferOptions","colorsAsRenderbuffer","depthAsRenderbuffer","stencilAsRenderbuffer","generateColorsMipmap","generateDepthMipmap","generateStencilMipmap","SglFramebufferInfo","colorTargets","depthTarget","stencilTarget","status","sglFramebufferFromTargets","fb","createFramebuffer","bindFramebuffer","FRAMEBUFFER","NONE","framebufferTexture2D","DEPTH_ATTACHMENT","framebufferRenderbuffer","STENCIL_ATTACHMENT","cts","drawBuffers","att","COLOR_ATTACHMENT0","ct","fbStatus","checkFramebufferStatus","trg","FRAMEBUFFER_COMPLETE","sglFramebufferFromFormats","colorFormats","depthFormat","stencilFormat","cc","DEPTH_COMPONENT","STENCIL_COMPONENT","SglVertexBuffer","_info","SglIndexBuffer","SglProgramAttribute","program","info","_prog","SglProgramUniform","_func","BOOL","BOOL_VEC2","uniform2iv","BOOL_VEC3","uniform3iv","BOOL_VEC4","uniform4iv","INT","INT_VEC2","INT_VEC3","INT_VEC4","uniform1f","FLOAT_VEC2","uniform2fv","FLOAT_VEC3","uniform3fv","FLOAT_VEC4","uniform4fv","FLOAT_MAT2","uniformMatrix2fv","FALSE","FLOAT_MAT3","uniformMatrix3fv","FLOAT_MAT4","uniformMatrix4fv","SglProgramSampler","_unit","SglProgram","_attributes","_uniforms","_samplers","SglTexture2D","SglTextureCube","SglRenderbuffer","SglFramebuffer","_colorTargets","_depthTarget","_stencilTarget","SglAttributeStreamJS","byCopy","_name","_size","_buff","SglVertexStreamJS","_attribs","_length","SglPrimitiveStreamJS","mode","_mode","_first","SglArrayPrimitiveStreamJS","SGL_ARRAY_PRIMITIVE_STREAM","SglIndexedPrimitiveStreamJS","indices","SGL_INDEXED_PRIMITIVE_STREAM","SglConnectivityJS","_prims","SglMeshJS","_valid","_vert","_conn","sglMeshJSImportOBJFromString","mesh","positionsArray","texcoordsArray","normalsArray","indicesArray","positions","texcoords","normals","facemap","pos","nor","tokens","hasPos","hasTex","hasNor","lineIndex","parseFloat","parseInt","addVertexAttribute","addIndexedPrimitives","SGL_TRIANGLES_LIST","sglMeshJSImportOBJFromURL","asynch","isValid","txt","_sglFindVertexAttributeJSON","vertices","_sglFindConnectivityJSON","connectivity","sglMeshJSImportJSONFromString","JSON","parse","mapping","stdMapping","vm","source","normalized","semantic","conn","primitives","sglMeshJSImportJSONFromURL","sglGLTypeSize","BYTE","SHORT","UNSIGNED_SHORT","UNSIGNED_INT","sglGLTypeFromWebGLArray","wglArray","Int8Array","Int16Array","Uint16Array","Int32Array","Uint32Array","SglAttributeStreamGL","_type","_norm","_stride","SglVertexStreamGL","SglPrimitiveStreamGL","SglArrayPrimitiveStreamGL","SglIndexedPrimitiveStreamGL","_idxType","SglPackedIndexedPrimitiveStreamGL","blockStartingIndices","blockStartingVertices","_blockStartingVertices","_blockStartingIndices","_blockIndicesCount","start","sIdx","SGL_PACKED_INDEXED_PRIMITIVE_STREAM","SglConnectivityGL","SglMeshGL","SglMeshGLRenderer","doSynchronize","_mapping","_meshAttrMap","_mesh","_primStream","_phase","_updateEnabledVB","synchronizeProgram","setStreamMapping","sglRenderMeshGLPrimitives","streamMapping","renderer","begin","setUniforms","setSamplers","renderMeshPrimitives","sglMeshJSCalculateBBox","meshJS","attribName","attrn","posAttrib","posSize","posBuffer","buffer","bbox","val","sglGLPrimitiveType","primType","SGL_POINTS_LIST","POINTS","SGL_LINES_LIST","LINES","SGL_LINE_STRIP","LINE_STRIP","SGL_LINE_LOOP","LINE_LOOP","TRIANGLES","SGL_TRIANGLE_STRIP","TRIANGLE_STRIP","SGL_TRIANGLE_FAN","TRIANGLE_FAN","sglMeshJStoGL","meshGL","prim","ptype","addArrayPrimitives","sglPackMeshJStoGL","maxVertexIndex","primName","maxInd","pmode","ariety","srcIndices","startVertex","startIndex","startVertices","startIndices","newIndices","newAttribs","indicesMap","dstIndices","vtxCount","triIndices","newVerticesCount","srcIdx","dstIdx","idxCount","srcAttr","dstAttr","asize","dstBase","newArr","concat","srcBuff","dstBuff","addPackedIndexedPrimitives","SglTrackball","_matrix","_pts","_action","SGL_TRACKBALL_NO_ACTION","reset","SglFirstPersonCamera","_position","_angles","lookAt","sglGetCanvasContext","canvasID","canvas","contextNames","getContext","TRUE","SglCanvasUI","manager","handler","_manager","_handler","_canvas","_timerID","_updRate","_ignoreKeyRepeat","loadEvent","unloadEvent","keyDownEvent","keyUpEvent","keyPressEvent","mouseDownEvent","mouseUpEvent","mouseMoveEvent","mouseWheelEvent","clickEvent","dblClickEvent","resizeEvent","updateEvent","drawEvent","keysDown","mouseButtonsDown","mousePos","mousePrevPos","mouseDeltaPos","timeNow","Date","now","timePrev","timeDelta","_SglCanvasManager","updateRate","contentEditable","PACK_ALIGNMENT","UNPACK_ALIGNMENT","UNPACK_PREMULTIPLY_ALPHA_WEBGL","UNPACK_COLORSPACE_CONVERSION_WEBGL","ui","mgr","_drawPending","rendering","_drawFunc","draw","addEventListener","e","load","unload","keyDown","keyUp","keyPress","mouseDown","mouseUp","mouseMove","click","dblClick","resize","mouseWheel","blur","mouseOut","mouseOver","touchStart","touchEnd","touchMove","_sglManageCanvas","_SGL_RegisteredCanvas","_sglUnmanageCanvas","_sglManageCanvasOnLoad","window","_sglUnmanageCanvasOnLoad","sglRegisterCanvas","sglRegisterLoadedCanvas","SGL_VERSION_MAJOR","SGL_VERSION_MINOR","SGL_VERSION_REVISION","SGL_VERSION_STRING","SGL_REQUEST_FAILED","SGL_REQUEST_SUCCEEDED","SGL_REQUEST_ONGOING","SGL_REQUEST_ABORTED","SGL_REQUEST_QUEUED","SGL_REQUEST_REJECTED","SGL_REQUEST_CANCELLED","_createOnReadyCallback","ok","_requestReady","priority","_updateRequest","removeOnReadyCallback","splice","queue","_send","cancel","_removeQueuedRequest","abort","_removeOngoingRequest","_abort","complete","onerror","requests","onReady","_sort","sort","_updateMinPriority","comparePriorities","_removeFromArray","arr","elem","_execute","sendable","pop","priorityCompare","victims","result","overflow","toKill","PI","clone","copy","set","setOne","at","squaredLength","dot","neg","minComp","maxComp","argMin","argMax","add","sub","mul","div","rcp","cross","o","slize","nomalize","isNull","isEmpty","squaredDiagonal","diagonal","facesAreas","surfaceArea","facesArea","volume","halfDelta","corner","transformed","matrix","addPoint","addBox","_redius","ss","topRef","multiply","loadIdentity","translate","rotate","scale","ortho","frustum","perspective","model","view","projection","modelMatrix","modelMatrixRef","modelMatrixTranspose","modelMatrixInverse","modelMatrixInverseTranspose","viewMatrix","viewMatrixRef","viewMatrixTranspose","viewMatrixInverse","viewMatrixInverseTranspose","projectionMatrixRef","projectionMatrixTranspose","projectionMatrixInverse","projectionMatrixInverseTranspose","modelViewMatrixTranspose","modelViewMatrixInverse","modelViewMatrixInverseTranspose","viewProjectionMatrix","viewProjectionMatrixTranspose","viewProjectionMatrixInverse","viewProjectionMatrixInverseTranspose","modelViewProjectionMatrixTranspose","modelViewProjectionMatrixInverse","modelViewProjectionMatrixInverseTranspose","worldSpaceNormalMatrix","viewSpaceNormalMatrix","modelSpaceViewerPosition","modelSpaceViewDirection","worldSpaceViewerPosition","worldSpaceViewDirection","ssglNegV3","nx","ny","nz","off","SGL_OUTSIDE_FRUSTUM","SGL_INTERSECT_FRUSTUM","SGL_INSIDE_FRUSTUM","rot","sc","scRcp","sMat","sMatInv","rMatInv","bminmax","fp","projectedSegmentSize","hs","p0","p1","p2","sz","destroy","deleteBuffer","bind","unbind","getUniform","deleteProgram","deleteShader","setDefaultBindings","synchronize","setAttributes","link","deleteTexture","activeTexture","TEXTURE0","deleteRenderbuffer","deleteFramebuffer","targets","setViewport","vp","bindColor","unbindColor","bindDepth","unbindDepth","bindStencil","unbindStencil","colors","depth","stencil","attachColorTarget","detachColorTarget","addAttribute","removeAttribute","removePrimitives","removeVertexAttribute","parseOBJ","importOBJ","parseJSON","importJSON","isNormalized","baseVertex","vertexAttribPointer","doDestroy","_clampRange","end","vEnd","_render","_destroy","render","range","drawArrays","drawElements","_clampBlockRange","block","blockRanges","firstBlock","lastBlock","ranges","renderBlock","SGL_DefaultStreamMappingPrefix","_bindVertexBuffers","_unbindVertexBuffers","prog","doLink","getStreamMappingFromPrefix","prefix","substr","meshAttrName","progAttrName","progAttr","setStreamMappingFromPrefix","textures","disableVertexAttribArray","beginMesh","endMesh","beginPrimitives","endPrimitives","vIndex","enableVertexAttribArray","isPacked","blocksCount","blocks","calculateBoundingBox","toMeshGL","toPackedMeshGL","SGL_TRACKBALL_ROTATE","SGL_TRACKBALL_PAN","SGL_TRACKBALL_DOLLY","SGL_TRACKBALL_SCALE","_projectOnSphere","_transform","_transformOnSphere","_translate","invMat","trMat","action","track","pan","dolly","mInv","v0","v1","angle","rotMat","dz","scaleMat","roll","viewDir","xOffset","yOffset","zOffset","pitchMat","yawMat","rollMat","rotOffset","translateOnPlane","pitchOffset","yawOffset","rollOffset","posMat","res","ignoreKeyRepeat","updR","clearInterval","ms","setInterval","update","requestDraw","_getMouseClientPos","rct","getBoundingClientRect","clientX","clientY","setTimeout","doDraw","button","key","keyString","String","fromCharCode","keyCode","toLowerCase","toUpperCase","charCode","preventDefault","focus","delta","event","wheelDelta","opera","detail","touches","changedTouches","flush","createRtiViewer","idDiv","imageUrlOrFunction","fullScreenOn","requestFullscreen","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen","style","screen","$","multiResRTI","fullscreen","label","icons","primary","fullScreenOff","exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen","canvasHeight","canvasWidth","isRelitable","css","canvasContainer","canvasDiv","createElement","id","margin","append","canvasNode","canvasName","aNode","href","aNodeDiv","appendChild","cssFloat","toolbar","setAttribute","visibility","innerHTML","divHelp","color","backgroundColor","display","startZoomIn","startZoomOut","trim","setMode","show","removeClass","msFullscreenElement","mozFullScreen","webkitIsFullScreen","hide","divError","MultiRes","setImageUrl","setImageFunction","setOnLoadImageCallback","msg","stepAnimation","idTimer","flipAngles","onDrawCallback","animating","moveToCenter","imageUrl","imageFunction","OnLoadImageCallback","currentSpeed","maxStep","animationStack","isMoving","MultiResNode","parentIndex","childrenIndices","projectedSize","zScale","box","timestamp","error","Number","MAX_VALUE","data","isLeaf","MultiResTree","onloadCallback","ready","nodesCount","rootIndex","nodes","tileSize","forma","imgW","imgH","_MultiResAssert","cond","alert","_MultiResCompareNodes","MultiResRenderer","cacheSizeInBytes","onLoad","lg","_tree","_timestamp","_frustum","_maxError","_cache","_cacheSizeInBytes","_maxCacheSize","_maxOngoingRequests","_currentOngoingRequests","_toRequest","_toRenderFullRes","_toRenderHalfRes","_readyItems","renderData","renderBoxes","boxPositions","trianglesIndices","edgesIndices","_boxMesh","_tileFullMesh","_tileHalfMesh","_program","bvs","bfs","bprg","_boxProgram","_boxRenderer","_treeTransform","_normalizedTreeTransform","updateData","texVsrc","texFsrc","texProg","lgPositions","lgTexcoords","tmp","lgMesh","lgtex","_createLg","enumType","_setLightDir","lx","ly","norm","alpha","lpos","lightPos","lweights","computeLightingFunction","resetViewpoint","translation","mat","flipMatrix","xform","loadImage","leftBottom","imgWidth","imgHeight","rightTop","h","scale1","scale2","maxScale","viewerdx","viewerdy","stopRendering","setOnDrawCallback","onDraw","_startZoom","deltaPos","speed","tmpScale","deltaScale","that","moveInterval","zoomInterval","_zoomAnimation","_moveAnimation","computeModelMatrix","tempPos","endPoint","deltaX","deltaY","currentPoint","_updateMoveStack","step","tmpMat","returnModelMatrix","lb","rt","realwidth","realheight","lenght","sendMouseDown","endAnimation","tmpVector","_adjustTranslation","startPoint","deltaVect","movementVector","acceleration","tmpPoint","totDelta","translVector","realDeltaX","realDeltaY","dt","translVect","scaleMatrix","normalizedTreeTransform","offsetHeight","getError","CONTEXT_LOST_WEBGL","console","clearColor","clear","COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT","_load","temp","nLevel","woffset","hoffset","imgBox","imgSize","imgCenter","parentNode","halfW","halfH","halfSize","diff","destroyData","idx","parent","child","phi","theta","cosPhi","cosTheta","cosTheta2","xhttp","targetURL","overrideMimeType","doc","responseXML","getElementsByTagName","getAttribute","isNaN","content","tree","bias","ordlen","numLayers","childNodes","nodeValue","gmax","gmin","_destroyData","vs","fs","_renderer","leftTex","rightTex","bottomTex","topTex","_setupTree","ctx","save","beginPath","moveTo","lineTo","closePath","clip","strokeStyle","lineCap","lineJoin","miterLimit","restore","transform","g","createRadialGradient","addColorStop","fillStyle","lineWidth","arc","fill","stroke","createLinearGradient","dataURL","toDataURL","texOpt","NEAREST","_createData","colorImgs","colorTexOpts","dataTextures","_requestNode","_collectNodesRec","parentFullyVisible","needed","usable","visStatus","prjSize","neededCount","usableCount","cr","missingChildren","children","_collectNodes","_renderNodeFullRes","u_world_box_min","u_world_box_max","_renderNodesFullRes","mvp","u_model_view_projection_matrix","u_scale_bias","u_texcoord_scale_bias","_renderNodeHalfRes","scaleBias","_renderNodesHalfRes","nc","_renderNodes","_renderNodeFullResBox","u_color","_renderNodesFullResBoxes","_renderNodeHalfResBox","_renderNodesHalfResBoxes","_renderNodesBoxes","depthFunc","LESS","_doRender","mv","enable","BLEND","blendFunc","SRC_ALPHA","ONE_MINUS_SRC_ALPHA","mvp2","quadUniforms","u_mvp","quadSamplers","s_texture","disable","_updateCache","maxUpdatesPerFrame","readyItems","combined","cl","outOfCache","cimgs","reinsertedCount","_requestNodes","cs","lastItem","requestableCount","requested","canRequest","_calculateNormalizedTreeTransform","rbox","bc","bs","maxDim","csize","quadPositions","quadMesh"],"mappings":"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","file":"webrti.min.js","sourcesContent":["/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// version\r\n/***********************************************************************/\r\nvar SGL_VERSION_MAJOR      = 0;\r\nvar SGL_VERSION_MINOR      = 1;\r\nvar SGL_VERSION_REVISION   = 1;\r\nvar SGL_VERSION_STRING     = SGL_VERSION_MAJOR + \".\" + SGL_VERSION_MINOR + \".\" + SGL_VERSION_REVISION;\r\n/***********************************************************************/\r\n\r\n\r\n// exceptions\r\n/***********************************************************************/\r\nfunction sglUnknown() {\r\n\tthrow new Error(\"SpiderGL : UNKNOWN\");\r\n}\r\n\r\nfunction sglUnsupported() {\r\n\tthrow new Error(\"SpiderGL : UNSUPPORTED\");\r\n}\r\n\r\nfunction sglUnimplemented() {\r\n\tthrow new Error(\"SpiderGL : UNIMPLEMENTED\");\r\n}\r\n\r\nfunction sglInvalidParameter() {\r\n\tthrow new Error(\"SpiderGL : INVALID_PARAMETER\");\r\n}\r\n\r\nfunction sglInvalidCall() {\r\n\tthrow new Error(\"SpiderGL : INVALID_CALL\");\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// utilities\r\n/***********************************************************************/\r\n/*function sglDefineGetter(ClassName, getterName, getterFunc, obj) {\r\n\tClassName.defineProperty(obj, getterName, {get: getterFunc});\r\n\t//ClassName.prototype.__defineGetter__(getterName, getterFunc);\r\n}\r\n\r\nfunction sglDefineSetter(ClassName, setterName, setterFunc, obj) {\r\n\tClassName.defineProperty(obj, setterName, {set: setterFunc});\r\n\t//ClassName.prototype.__defineSetter__(setterName, setterFunc);\r\n}*/\r\n\r\nfunction sglDefineConstant(ClassName, constantName, constantValue) {\r\n\tClassName[constantName] = constantValue;\r\n}\r\n\r\nfunction sglInherit(DerivedClassName, BaseClassName) {\r\n\tDerivedClassName.prototype = new BaseClassName();\r\n\tDerivedClassName.prototype.constructor = DerivedClassName;\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// initialization - finalization\r\n/***********************************************************************/\r\nfunction sglInitialize() {\r\n\t;\r\n}\r\n\r\nfunction sglFinalize() {\r\n\t;\r\n}\r\n\r\nwindow.addEventListener(\"load\",   function() { sglInitialize(); }, false);\r\nwindow.addEventListener(\"unload\", function() { sglFinalize();   }, false);\r\n/***********************************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// DOM utilities\r\n/*********************************************************/\r\nfunction sglNodeText(domNodeID) {\r\n\tvar node = document.getElementById(domNodeID);\r\n\tif (!node) return null;\r\n\r\n\tvar str = \"\";\r\n\tvar n   = node.firstChild;\r\n\twhile (n) {\r\n\t\tif (n.nodeType == 3) {\r\n\t\t\tstr += n.textContent;\r\n\t\t}\r\n\t\tn = n.nextSibling;\r\n\t}\r\n\treturn str;\r\n}\r\n\r\nfunction sglLoadFile(url, callback) {\r\n\tvar async = (callback) ? (true) : (false);\r\n\tvar req = new XMLHttpRequest();\r\n\r\n\tif (async) {\r\n\t\treq.onreadystatechange = function() {\r\n\t\t\tif (req.readyState == 4) {\r\n\t\t\t\tif (callback) {\r\n\t\t\t\t\tcallback(req.responseText);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\t}\r\n\r\n\treq.open(\"GET\", url, async);\r\n\treq.send(null);\r\n\r\n\tvar ret = null;\r\n\tif (!async) {\r\n\t\tret = req.responseText;\r\n\t}\r\n\r\n\treturn ret;\r\n}\r\n\r\nfunction sglGetLines(text)\r\n{\r\n\tvar allLines = text.split(\"\\n\");\r\n\tvar n = allLines.length;\r\n\tvar lines = [ ];\r\n\tvar line = null;\r\n\tfor (var i=0; i<n; ++i) {\r\n\t\tline = allLines[i].replace(/[ \\t]+/g, \" \").replace(/\\s\\s*$/, \"\");\r\n\t\tif (line.length > 0) {\r\n\t\t\tlines.push(line);\r\n\t\t}\r\n\t}\r\n\treturn lines;\r\n}\r\n/*********************************************************/\r\n\r\n\r\n// SglRequest\r\n/*********************************************************/\r\nvar SGL_REQUEST_FAILED     = 0;\r\nvar SGL_REQUEST_SUCCEEDED  = 1;\r\nvar SGL_REQUEST_IDLE       = 2;\r\nvar SGL_REQUEST_ONGOING    = 3;\r\nvar SGL_REQUEST_ABORTED    = 4;\r\nvar SGL_REQUEST_QUEUED     = 5;\r\nvar SGL_REQUEST_REJECTED   = 6;\r\nvar SGL_REQUEST_CANCELLED  = 7;\r\n\r\n/**\r\n * Constructs a SglRequest.\r\n * @class Base class for an asynchronous request.\r\n */\r\nfunction SglRequest(onReadyCallback) {\r\n\tthis._priority = null;\r\n\tthis._status   = SGL_REQUEST_IDLE;\r\n\tthis._queue    = null;\r\n\tthis._onReady  = [ ];\r\n\tif (onReadyCallback) {\r\n\t\tthis.addOnReadyCallback(onReadyCallback);\r\n\t}\r\n}\r\n\r\nSglRequest.prototype = {\r\n\t_createOnReadyCallback : function() {\r\n\t\tvar t  = this;\r\n\t\tvar cb = function(ok) {\r\n\t\t\tt._status = (ok) ? (SGL_REQUEST_SUCCEEDED) : (SGL_REQUEST_FAILED);\r\n\t\t\tif (t._queue) {\r\n\t\t\t\tt._queue._requestReady(t);\r\n\t\t\t\tthis._queue  = null;\r\n\t\t\t}\r\n\t\t\tvar n = t._onReady.length;\r\n\t\t\tfor (var i=0; i<n; ++i) {\r\n\t\t\t\tt._onReady[i](t);\r\n\t\t\t}\r\n\t\t};\r\n\t\treturn cb;\r\n\t},\r\n\r\n\tget status() {\r\n\t\treturn this._status;\r\n\t},\r\n\r\n\tget priority() {\r\n\t\treturn this._priority;\r\n\t},\r\n\r\n\tset priority(p) {\r\n\t\tthis._priority = p;\r\n\t\tif (this._queue) {\r\n\t\t\tthis._queue._updateRequest(this);\r\n\t\t}\r\n\t},\r\n\r\n\tget succeeded() {\r\n\t\treturn (this._status == SGL_REQUEST_SUCCEEDED);\r\n\t},\r\n\r\n\tget failed() {\r\n\t\treturn (this._status == SGL_REQUEST_FAILED);\r\n\t},\r\n\r\n\taddOnReadyCallback : function(f) {\r\n\t\tif (f) {\r\n\t\t\tthis._onReady.push(f);\r\n\t\t\tif (this.isReady) {\r\n\t\t\t\tf(this);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\tremoveOnReadyCallback : function(f) {\r\n\t\tvar index = -1;\r\n\t\tvar n = this._onReady.length;\r\n\t\tfor (var i=0; i<n; ++i) {\r\n\t\t\tif (this._onReady[i] == f) {\r\n\t\t\t\tindex = i;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (index < 0) return;\r\n\t\tthis._onReady.splice(index, 1);\r\n\t},\r\n\r\n\tget isReady() {\r\n\t\treturn (this.failed || this.succeeded);\r\n\t},\r\n\r\n\tget queue() {\r\n\t\treturn this._queue;\r\n\t},\r\n\r\n\tsend : function() {\r\n\t\tif (!this._send) return false;\r\n\t\tvar r = this._send();\r\n\t\tif (r) {\r\n\t\t\tthis._status = SGL_REQUEST_ONGOING;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis._status = SGL_REQUEST_FAILED;\r\n\t\t\tvar cb = this._createOnReadyCallback();\r\n\t\t\tcb(false);\r\n\t\t}\r\n\t\treturn r;\r\n\t},\r\n\r\n\tcancel : function() {\r\n\t\tif (this._status == SGL_REQUEST_QUEUED) {\r\n\t\t\tif (this._queue) {\r\n\t\t\t\tthis._queue._removeQueuedRequest(this);\r\n\t\t\t\tthis._queue  = null;\r\n\t\t\t}\r\n\t\t\tthis._status = SGL_REQUEST_CANCELLED;\r\n\t\t}\r\n\t},\r\n\r\n\tabort : function() {\r\n\t\tthis.cancel();\r\n\t\tif (this._status == SGL_REQUEST_ONGOING) {\r\n\t\t\tif (this._queue) {\r\n\t\t\t\tthis._queue._removeOngoingRequest(this);\r\n\t\t\t\tthis._queue  = null;\r\n\t\t\t}\r\n\t\t\tif (this._abort) {\r\n\t\t\t\tthis._abort();\r\n\t\t\t}\r\n\t\t\tthis._status = SGL_REQUEST_ABORTED;\r\n\t\t}\r\n\t}\r\n};\r\n/*********************************************************/\r\n\r\n\r\n// SglTextFileRequest\r\n/*********************************************************/\r\n/**\r\n * Constructs a SglTextFileRequest.\r\n * @class Asynchronous text file request.\r\n */\r\nfunction SglTextFileRequest(url, onReadyCallback) {\r\n\tSglRequest.apply(this, Array.prototype.slice.call(arguments, 1));\r\n\tthis._url = url;\r\n\tthis._req = null;\r\n\tObject.defineProperty(this, \"url\", {get: function(){return this._url;}});\r\n\tObject.defineProperty(this, \"text\", {get: function(){return this._req.responseText;}});\r\n}\r\n\r\nsglInherit(SglTextFileRequest, SglRequest);\r\n\r\n/*sglDefineGetter(SglTextFileRequest, \"url\", function() {\r\n\treturn this._url;\r\n});\r\n\r\nsglDefineGetter(SglTextFileRequest, \"text\", function() {\r\n\treturn this._req.responseText;\r\n});*/\r\n\r\nSglTextFileRequest.prototype._send = function() {\r\n\tif (!this._url) return false;\r\n\r\n\tvar req = new XMLHttpRequest();\r\n\tthis._req = req;\r\n\r\n\tvar cb = this._createOnReadyCallback();\r\n\treq.onreadystatechange = function() {\r\n\t\tif (req.readyState == 4) {\r\n\t\t\tvar ok = (req.status) ? (req.status == 200) : (true);\r\n\t\t\tcb(ok);\r\n\t\t}\r\n\t};\r\n\treq.open(\"GET\", this._url, true);\r\n\treq.send();\r\n\r\n\treturn true;\r\n};\r\n\r\nSglTextFileRequest.prototype._abort = function() {\r\n\tif (!this._req) return;\r\n\tthis._req.abort();\r\n};\r\n/*********************************************************/\r\n\r\n\r\n// SglImageRequest\r\n/*********************************************************/\r\n/**\r\n * Constructs a SglImageRequest.\r\n * @class Asynchronous image request.\r\n */\r\nfunction SglImageRequest(url, onReadyCallback) {\r\n\tSglRequest.apply(this, Array.prototype.slice.call(arguments, 1));\r\n\tthis._url = url;\r\n\tthis._img = null;\r\n\tObject.defineProperty(this, \"url\", {get: function(){return this._url;}});\r\n\tObject.defineProperty(this, \"image\", {get: function(){return this._img;}});\r\n}\r\n\r\nsglInherit(SglImageRequest, SglRequest);\r\n\r\nSglImageRequest.prototype._send = function() {\r\n\tif (!this._url) return false;\r\n\r\n\tvar img = new Image();\r\n\tthis._img = img;\r\n\timg.crossOrigin = '';\r\n\tvar cb = this._createOnReadyCallback();\r\n\timg.onload = function() {\r\n\t\tcb(img.complete);\r\n\t};\r\n\timg.onerror = function() {\r\n\t\tcb(false);\r\n\t};\r\n\timg.src = this._url;\r\n\r\n\treturn true;\r\n};\r\n\r\nSglImageRequest.prototype._abort = function() {\r\n\t;\r\n};\r\n/*********************************************************/\r\n\r\n\r\n// SglRequestWatcher\r\n/*********************************************************/\r\n/**\r\n * Constructs a SglRequestWatcher.\r\n * @class Watches for requests completion.\r\n */\r\nfunction SglRequestWatcher(reqs, onReadyCallback) {\r\n\tvar n = reqs.length;\r\n\r\n\tthis._onReady       = (onReadyCallback) ? (onReadyCallback) : (null);\r\n\tthis._waitingReqs   = n;\r\n\tthis._succeededReqs = 0;\r\n\tthis._failedReqs    = 0;\r\n\tthis._reqs          = reqs.slice();\r\n\r\n\tvar t  = this;\r\n\tvar cb = function(r) {\r\n\t\tif (r.succeeded) {\r\n\t\t\tt._succeededReqs++;\r\n\t\t}\r\n\t\telse if (r.failed) {\r\n\t\t\tt._failedReqs++;\r\n\t\t}\r\n\t\tt._waitingReqs--;\r\n\t\tif (t.isReady) {\r\n\t\t\tif (t._onReady) {\r\n\t\t\t\tt._onReady(t);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tfor (var i=0; i<n; ++i) {\r\n\t\tif (reqs[i].succeeded) {\r\n\t\t\tthis._succeededReqs++;\r\n\t\t\tthis._waitingReqs--;\r\n\t\t}\r\n\t\telse if (reqs[i].failed) {\r\n\t\t\tthis._failedReqs++;\r\n\t\t\tthis._waitingReqs--;\r\n\t\t}\r\n\t\telse {\r\n\t\t\treqs[i].addOnReadyCallback(cb);\r\n\t\t}\r\n\t}\r\n\r\n\tif (this._waitingReqs <= 0) {\r\n\t\tif (this._onReady) {\r\n\t\t\tthis._onReady(this);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nSglRequestWatcher.prototype = {\r\n\tget requests() {\r\n\t\treturn this._reqs;\r\n\t},\r\n\r\n\tget succeeded() {\r\n\t\treturn (this._succeededReqs == this._reqs.length);\r\n\t},\r\n\r\n\tget failed() {\r\n\t\tif ((this._succeededReqs + this._failedReqs) < this._reqs.length) return false;\r\n\t\treturn (this._succeededReqs < this._reqs.length);\r\n\t},\r\n\r\n\tget onReady() {\r\n\t\treturn this._onReady;\r\n\t},\r\n\r\n\tset onReady(f) {\r\n\t\tthis._onReady = f;\r\n\t\tif (this.isReady) {\r\n\t\t\tif (this._onReady) {\r\n\t\t\t\tthis._onReady(t);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\tget isReady() {\r\n\t\treturn ((this._succeededReqs + this._failedReqs) == this._reqs.length);\r\n\t},\r\n\r\n\tsend : function() {\r\n\t\tvar n = this._reqs.length;\r\n\t\tfor (var i=0; i<n; ++i) {\r\n\t\t\tthis._reqs[i].send();\r\n\t\t}\r\n\t},\r\n\r\n\tcancel : function() {\r\n\t\tvar n = this._reqs.length;\r\n\t\tfor (var i=0; i<n; ++i) {\r\n\t\t\tthis._reqs[i].cancel();\r\n\t\t}\r\n\t},\r\n\r\n\tabort : function() {\r\n\t\tvar n = this._reqs.length;\r\n\t\tfor (var i=0; i<n; ++i) {\r\n\t\t\tthis._reqs[i].abort();\r\n\t\t}\r\n\t}\r\n};\r\n/*********************************************************/\r\n\r\n\r\n// SglRequestQueue\r\n/*********************************************************/\r\n/**\r\n * Constructs a SglRequestQueue.\r\n * @class Asynchronous requests scheduler.\r\n */\r\nfunction SglRequestQueue(maxOngoing, maxQueued, onReadyCallback) {\r\n\tthis._maxOngoing = (maxOngoing > 0) ? (maxOngoing) : (0);\r\n\tthis._maxQueued  = (maxQueued  > 0) ? (maxQueued ) : (0);\r\n\r\n\tthis._ongoing = [ ];\r\n\tthis._queued  = [ ];\r\n\tthis._onReady = null;\r\n\tthis._minPriorityReq = null;\r\n\tthis._priorityCompare = null;\r\n\tthis._dirty = true;\r\n}\r\n\r\nSglRequestQueue.prototype = {\r\n\t_sort : function() {\r\n\t\tif (!this._dirty) return;\r\n\r\n\t\tthis._dirty = false;\r\n\t\tthis._minPriorityReq = null;\r\n\t\tif (this._queued.length <= 0) return;\r\n\r\n\t\tif (this._priorityCompare) {\r\n\t\t\tthis._queued.sort(this._priorityCompare);\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis._queued.sort();\r\n\t\t}\r\n\t\tif (this._queued.length > 0) {\r\n\t\t\tthis._minPriorityReq = this._queued[0];\r\n\t\t}\r\n\t},\r\n\r\n\t_updateMinPriority : function() {\r\n\t\tthis._minPriorityReq = null;\r\n\t\tvar n = this._queued.length;\r\n\t\tif (n <= 0) return;\r\n\r\n\t\tthis._minPriorityReq = this._queued[0];\r\n\t\tif (!this._dirty) return;\r\n\r\n\t\tfor (var i=1; i<n; ++i) {\r\n\t\t\tif (this.comparePriorities(this._queued[i].priority, this._minPriorityReq.priority) <= 0) {\r\n\t\t\t\tthis._minPriorityReq = this._queued[i];\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_removeFromArray : function(arr, elem) {\r\n\t\tvar index = -1;\r\n\t\tvar n = arr.length;\r\n\t\tfor (var i=0; i<n; ++i) {\r\n\t\t\tif (arr[i] == elem) {\r\n\t\t\t\tindex = i;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (index < 0) return;\r\n\t\tarr.splice(index, 1);\r\n\t},\r\n\r\n\t_removeQueuedRequest : function(r) {\r\n\t\tthis._removeFromArray(this._queued, r);\r\n\t\tif (this._queued.length <= 0) {\r\n\t\t\tthis._minPriorityReq = null;\r\n\t\t}\r\n\t\telse if (r == this._minPriorityReq) {\r\n\t\t\tthis._updateMinPriority();\r\n\t\t}\r\n\t},\r\n\r\n\t_removeOngoingRequest : function(r) {\r\n\t\tthis._removeFromArray(this._ongoing, r);\r\n\t\tthis._execute();\r\n\t},\r\n\r\n\t_updateRequest : function(r) {\r\n\t\tif (this.comparePriorities(r.priority, this._minPriorityReq.priority) <= 0) {\r\n\t\t\tthis._minPriorityReq = r;\r\n\t\t}\r\n\t\tthis._dirty = true;\r\n\t},\r\n\r\n\t_requestReady : function(r) {\r\n\t\tthis._removeOngoingRequest(r);\r\n\t\tif (this._onReady) {\r\n\t\t\tthis._onReady(r);\r\n\t\t}\r\n\t\tthis._execute();\r\n\t},\r\n\r\n\t_execute : function() {\r\n\t\tvar n = this._queued.length;\r\n\t\tif (n <= 0) return;\r\n\t\tvar sendable = (this._maxOngoing > 0) ? (this._maxOngoing - this._ongoing.length) : (n)\r\n\t\tif (sendable <= 0) return;\r\n\t\tif (sendable > n) sendable = n;\r\n\t\tthis._sort();\r\n\t\tvar r = null;\r\n\t\tfor (var i=0; i<sendable; ++i) {\r\n\t\t\tr = this._queued.pop();\r\n\t\t\tr.send();\r\n\t\t}\r\n\t\tif (this._queued.length > 0) {\r\n\t\t\tthis._minPriorityReq = this._queued[0];\r\n\t\t}\r\n\t},\r\n\r\n\tcomparePriorities : function(a, b) {\r\n\t\tif (this._priorityCompare) {\r\n\t\t\treturn this._priorityCompare(a, b);\r\n\t\t}\r\n\t\treturn (a - b);\r\n\t},\r\n\r\n\tget priorityCompare() {\r\n\t\treturn this._priorityCompare;\r\n\t},\r\n\r\n\tset priorityCompare(f) {\r\n\t\tthis._priorityCompare = f;\r\n\t\tthis._updateMinPriority();\r\n\t},\r\n\r\n\tget onReady() {\r\n\t\treturn this._onReady;\r\n\t},\r\n\r\n\tset onReady(f) {\r\n\t\tthis._onReady = f;\r\n\t},\r\n\r\n\tpush : function(r) {\r\n\t\tvar ret = {\r\n\t\t\tvictims : null,\r\n\t\t\tresult  : false\r\n\t\t};\r\n\t\t\r\n\t\tif (r.queue) return ret;\r\n\t\tvar n = this._queued.length;\r\n\t\tvar overflow = ((this._maxQueued > 0) && (n >= this._maxQueued));\r\n\r\n\t\tif  (overflow) {\r\n\t\t\tif (this.comparePriorities(r.priority, this._minPriorityReq.priority) <= 0) {\r\n\t\t\t\tr._status = SGL_REQUEST_REJECTED;\r\n\t\t\t\treturn ret;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis._queued.push(r);\r\n\t\tr._queue  = this;\r\n\t\tr._status = SGL_REQUEST_QUEUED;\r\n\t\tn++;\r\n\r\n\t\tret.result = true;\r\n\t\r\n\t\tvar toKill = (this._maxQueued > 0) ? (n - this._maxQueued) : (0);\r\n\t\tif (toKill <= 0) {\r\n\t\t\tif (this._minPriorityReq != null) {\r\n\t\t\t\tif (this.comparePriorities(r.priority, this._minPriorityReq.priority) <= 0) {\r\n\t\t\t\t\tthis._minPriorityReq = r;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthis._minPriorityReq = r;\r\n\t\t\t}\r\n\t\t\tthis._dirty = true;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis._sort();\r\n\t\t\tret.victims = this._queued.slice(0, toKill);\r\n\t\t\tthis._queued.splice(0, toKill);\r\n\t\t\tfor (var i=0; i<toKill; ++i) {\r\n\t\t\t\tret.victims[i]._status = SGL_REQUEST_REJECTED;\r\n\t\t\t\tret.victims[i]._queue  = null;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis._execute();\r\n\r\n\t\treturn ret;\r\n\t}\r\n};\r\n/*********************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// math utilities\r\n/***********************************************************************/\r\nvar SGL_PI = Math.PI;\r\n\r\nfunction sglAbs(x) {\r\n\treturn Math.abs(x);\r\n}\r\n\r\nfunction sglFloor(x) {\r\n\treturn Math.floor(x);\r\n}\r\n\r\nfunction sglCeil(x) {\r\n\treturn Math.ceil(x);\r\n}\r\n\r\nfunction sglSqrt(x) {\r\n\treturn Math.sqrt(x);\r\n}\r\n\r\nfunction sglPow(x, y) {\r\n\treturn Math.pow(x, y);\r\n}\r\n\r\nfunction sglLog(x) {\r\n\treturn Math.log(x);\r\n}\r\n\r\nfunction sglExp(x) {\r\n\treturn Math.exp(x);\r\n}\r\n\r\nfunction sglSin(x) {\r\n\treturn Math.sin(x);\r\n}\r\n\r\nfunction sglAsin(x) {\r\n\treturn Math.asin(x);\r\n}\r\n\r\nfunction sglCos(x) {\r\n\treturn Math.cos(x);\r\n}\r\n\r\nfunction sglAcos(x) {\r\n\treturn Math.acos(x);\r\n}\r\n\r\nfunction sglTan(x) {\r\n\treturn Math.tan(x);\r\n}\r\n\r\nfunction sglAtan(x) {\r\n\treturn Math.atan(x);\r\n}\r\n\r\nfunction sglAtan2(y, x) {\r\n\treturn Math.atan2(y, x);\r\n}\r\n\r\nfunction sglDegToRad(x) {\r\n\treturn (x * (SGL_PI / 180.0));\r\n}\r\n\r\nfunction sglRadToDeg(x) {\r\n\treturn (x * (180.0 / SGL_PI));\r\n}\r\n\r\nfunction sglMin(a, b) {\r\n\treturn Math.min(a, b);\r\n}\r\n\r\nfunction sglMax(a, b) {\r\n\treturn Math.max(a, b);\r\n}\r\n\r\nfunction sglClamp(x, min, max) {\r\n\treturn ((x <= min) ? (min) : ((x >= max) ? (max) : (x)));\r\n}\r\n\r\nfunction sglRandom01() {\r\n\treturn Math.random();\r\n}\r\n\r\nfunction sglMapVN(vArray, size, f, param, first, count, stride) {\r\n\tfirst  = (first  != undefined) ? first  : 0;\r\n\tstride = (stride != undefined) ? stride : size;\r\n\tcount  = (count  != undefined) ? count  : ((vArray.length - first) / stride);\r\n\r\n\tvar last = first + count * stride;\r\n\tvar v    = new Array(n);\r\n\r\n\tvar k = 0;\r\n\tvar j = 0;\r\n\tfor (var i=first; i<last; i+=stride) {\r\n\t\tfor (j=0; j<n; ++j) {\r\n\t\t\tv[j] = vArray[i+j];\r\n\t\t}\r\n\t\tf(v, param, k++);\r\n\t\tfor (j=0; j<n; ++j) {\r\n\t\t\tvArray[i+j] = v[j];\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction sglMapV2(v2Array, f, param, first, count, stride) {\r\n\tsglMapVN(v2Array, 2, f, param, first, count, stride);\r\n}\r\n\r\nfunction sglMapV3(v3Array, f, param, first, count, stride) {\r\n\tsglMapVN(v3Array, 3, f, param, first, count, stride);\r\n}\r\n\r\nfunction sglMapV4(v4Array, f, param, first, count, stride) {\r\n\tsglMapVN(v4Array, 4, f, param, first, count, stride);\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// 2-dimensional vector\r\n/***********************************************************************/\r\nfunction sglUndefV2(v) {\r\n\treturn new Array(2);\r\n}\r\n\r\nfunction sglV2V(v) {\r\n\treturn v.slice(0, 2);\r\n}\r\n\r\nfunction sglV2S(s) {\r\n\treturn [ s, s ];\r\n}\r\n\r\nfunction sglV2C(x, y) {\r\n\treturn [ x, y ];\r\n}\r\n\r\nfunction sglZeroV2() {\r\n\treturn sglV2S(0.0);\r\n}\r\n\r\nfunction sglOneV2() {\r\n\treturn sglV2S(1.0);\r\n}\r\n\r\nfunction sglV2() {\r\n\tvar n = arguments.length;\r\n\tvar s;\r\n\tswitch (n) {\r\n\t\tcase 1:\r\n\t\t\tif (arguments[0] instanceof Array) {\r\n\t\t\t\treturn sglV2V(arguments[0]);\r\n\t\t\t}\r\n\t\t\treturn sglV2S(arguments[0]);\r\n\t\tbreak;\r\n\r\n\t\tcase 2:\r\n\t\t\treturn sglV2V(arguments);\r\n\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t\t\treturn sglZeroV2();\r\n\t\tbreak;\r\n\t}\r\n\treturn null;\r\n}\r\n\r\nfunction sglDupV2(v) {\r\n\treturn v.slice(0, 2);\r\n}\r\n\r\nfunction sglNegV2(v) {\r\n\treturn sglV2C(-v[0], -v[1]);\r\n}\r\n\r\nfunction sglAddV2(u, v) {\r\n\treturn sglV2C(u[0]+v[0], u[1]+v[1]);\r\n}\r\n\r\nfunction sglAddV2S(v, s) {\r\n\treturn sglV2C(v[0]+s, v[1]+s);\r\n}\r\n\r\nfunction sglAddSV2(s, v) {\r\n\treturn sglAddV2S(v, s)\r\n}\r\n\r\nfunction sglSubV2(u, v) {\r\n\treturn sglV2C(u[0]-v[0], u[1]-v[1]);\r\n}\r\n\r\nfunction sglSubV2S(v, s) {\r\n\treturn sglV2C(v[0]-s, v[1]-s);\r\n}\r\n\r\nfunction sglSubSV2(v, s) {\r\n\treturn sglV2C(s-v[0], s-v[1]);\r\n}\r\n\r\nfunction sglMulV2(u, v) {\r\n\treturn sglV2C(u[0]*v[0], u[1]*v[1]);\r\n}\r\n\r\nfunction sglMulV2S(v, s) {\r\n\treturn sglV2C(v[0]*s, v[1]*s);\r\n}\r\n\r\nfunction sglMulSV2(s, v) {\r\n\treturn sglMulV2S(v, s);\r\n}\r\n\r\nfunction sglDivV2(u, v) {\r\n\treturn sglV2C(u[0]/v[0], u[1]/v[1]);\r\n}\r\n\r\nfunction sglDivV2S(v, s) {\r\n\treturn sglV2C(v[0]/s, v[1]/s);\r\n}\r\n\r\nfunction sglDivSV2(s, v) {\r\n\treturn sglV2C(s/v[0], s/v[1]);\r\n}\r\n\r\nfunction sglRcpV2(v) {\r\n\treturn sglDivSV2(1.0, v);\r\n}\r\n\r\nfunction sglDotV2(u, v) {\r\n\treturn (u[0]*v[0] + u[1]*v[1]);\r\n}\r\n\r\nfunction sglCrossV2(u, v) {\r\n\treturn (u[0]*v[1] - u[1]*v[0]);\r\n}\r\n\r\nfunction sglSqLengthV2(v) {\r\n\treturn sglDotV2(v, v);\r\n}\r\n\r\nfunction sglLengthV2(v) {\r\n\treturn sglSqrt(sglSqLengthV2(v));\r\n}\r\n\r\nfunction sglNormalizedV2(v) {\r\n\tvar f = 1.0 / sglLengthV2(v);\r\n\treturn sglMulV2S(v, f);\r\n}\r\n\r\nfunction sglSelfNegV2(v) {\r\n\tv[0] = -v[0];\r\n\tv[1] = -v[1];\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfAddV2(u, v) {\r\n\tu[0] += v[0];\r\n\tu[1] += v[1];\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfAddV2S(v, s) {\r\n\tv[0] += s;\r\n\tv[1] += s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfAddSV2(s, v) {\r\n\tv[0] += s;\r\n\tv[1] += s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfSubV2(u, v) {\r\n\tu[0] -= v[0];\r\n\tu[1] -= v[1];\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfSubV2S(v, s) {\r\n\tv[0] -= s;\r\n\tv[1] -= s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfSubSV2(v, s) {\r\n\tv[0] = s - v[0];\r\n\tv[1] = s - v[1];\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfMulV2(u, v) {\r\n\tu[0] *= v[0];\r\n\tu[1] *= v[1];\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfMulV2S(v, s) {\r\n\tv[0] *= s;\r\n\tv[1] *= s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfMulSV2(s, v) {\r\n\tv[0] *= s;\r\n\tv[1] *= s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfDivV2(u, v) {\r\n\tu[0] /= v[0];\r\n\tu[1] /= v[1];\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfDivV2S(v, s) {\r\n\tu[0] /= s;\r\n\tu[1] /= s;\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfDivSV2(s, v) {\r\n\tv[0] = s / v[0];\r\n\tv[1] = s / v[1];\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfRcpV2(v) {\r\n\treturn sglSelfDivSV2(1.0, v);\r\n}\r\n\r\nfunction sglSelfNormalizeV2(v) {\r\n\tvar f = 1.0 / sglLengthV2(v);\r\n\treturn sglSelfMulV2S(v, f);\r\n}\r\n\r\nfunction sglMinV2(u, v) {\r\n\treturn [\r\n\t\t((u[0] < v[0]) ? (u[0]) : (v[0])),\r\n\t\t((u[1] < v[1]) ? (u[1]) : (v[1]))\r\n\t];\r\n}\r\n\r\nfunction sglMaxV2(u, v) {\r\n\treturn [\r\n\t\t((u[0] > v[0]) ? (u[0]) : (v[0])),\r\n\t\t((u[1] > v[1]) ? (u[1]) : (v[1]))\r\n\t];\r\n}\r\n\r\nfunction sglV2toV3(v, z) {\r\n\treturn sglV3C(v[0], v[1], z);\r\n}\r\n\r\nfunction sglV2toV4(v, z, w) {\r\n\treturn sglV4C(v[0], v[1], z, w);\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// 3-dimensional vector\r\n/***********************************************************************/\r\nfunction sglUndefV3(v) {\r\n\treturn new Array(3);\r\n}\r\n\r\nfunction sglV3V(v) {\r\n\treturn v.slice(0, 3);\r\n}\r\n\r\nfunction sglV3S(s) {\r\n\treturn [ s, s, s ];\r\n}\r\n\r\nfunction sglV3C(x, y, z) {\r\n\treturn [ x, y, z ];\r\n}\r\n\r\nfunction sglZeroV3() {\r\n\treturn sglV3S(0.0);\r\n}\r\n\r\nfunction sglOneV3() {\r\n\treturn sglV3S(1.0);\r\n}\r\n\r\nfunction sglV3() {\r\n\tvar n = arguments.length;\r\n\tvar s;\r\n\tswitch (n) {\r\n\t\tcase 1:\r\n\t\t\tif (arguments[0] instanceof Array) {\r\n\t\t\t\treturn sglV3V(arguments[0]);\r\n\t\t\t}\r\n\t\t\treturn sglV3S(arguments[0]);\r\n\t\tbreak;\r\n\r\n\t\tcase 3:\r\n\t\t\treturn sglV3V(arguments);\r\n\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t\t\treturn sglZeroV3();\r\n\t\tbreak;\r\n\t}\r\n\treturn null;\r\n}\r\n\r\nfunction sglDupV3(v) {\r\n\treturn v.slice(0, 3);\r\n}\r\n\r\nfunction sglNegV3(v) {\r\n\treturn sglV3C(-v[0], -v[1], -v[2]);\r\n}\r\n\r\nfunction sglAddV3(u, v) {\r\n\treturn sglV3C(u[0]+v[0], u[1]+v[1], u[2]+v[2]);\r\n}\r\n\r\nfunction sglAddV3S(v, s) {\r\n\treturn sglV3C(v[0]+s, v[1]+s, v[2]+s);\r\n}\r\n\r\nfunction sglAddSV3(s, v) {\r\n\treturn sglAddV3S(v, s)\r\n}\r\n\r\nfunction sglSubV3(u, v) {\r\n\treturn sglV3C(u[0]-v[0], u[1]-v[1], u[2]-v[2]);\r\n}\r\n\r\nfunction sglSubV3S(v, s) {\r\n\treturn sglV3C(v[0]-s, v[1]-s, v[2]-s);\r\n}\r\n\r\nfunction sglSubSV3(v, s) {\r\n\treturn sglV3C(s-v[0], s-v[1], s-v[2]);\r\n}\r\n\r\nfunction sglMulV3(u, v) {\r\n\treturn sglV3C(u[0]*v[0], u[1]*v[1], u[2]*v[2]);\r\n}\r\n\r\nfunction sglMulV3S(v, s) {\r\n\treturn sglV3C(v[0]*s, v[1]*s, v[2]*s);\r\n}\r\n\r\nfunction sglMulSV3(s, v) {\r\n\treturn sglMulV3S(v, s);\r\n}\r\n\r\nfunction sglDivV3(u, v) {\r\n\treturn sglV3C(u[0]/v[0], u[1]/v[1], u[2]/v[2]);\r\n}\r\n\r\nfunction sglDivV3S(v, s) {\r\n\treturn sglV3C(v[0]/s, v[1]/s, v[2]/s);\r\n}\r\n\r\nfunction sglDivSV3(s, v) {\r\n\treturn sglV3C(s/v[0], s/v[1], s/v[2]);\r\n}\r\n\r\nfunction sglRcpV3(v) {\r\n\treturn sglDivSV3(1.0, v);\r\n}\r\n\r\nfunction sglDotV3(u, v) {\r\n\treturn (u[0]*v[0] + u[1]*v[1] + u[2]*v[2]);\r\n}\r\n\r\nfunction sglCrossV3(u, v) {\r\n\treturn sglV3C(u[1]*v[2] - u[2]*v[1], u[2]*v[0] - u[0]*v[2], u[0]*v[1] - u[1]*v[0]);\r\n}\r\n\r\nfunction sglSqLengthV3(v) {\r\n\treturn sglDotV3(v, v);\r\n}\r\n\r\nfunction sglLengthV3(v) {\r\n\treturn sglSqrt(sglSqLengthV3(v));\r\n}\r\n\r\nfunction sglNormalizedV3(v) {\r\n\tvar f = 1.0 / sglLengthV3(v);\r\n\treturn sglMulV3S(v, f);\r\n}\r\n\r\nfunction sglSelfNegV3(v) {\r\n\tv[0] = -v[0];\r\n\tv[1] = -v[1];\r\n\tv[2] = -v[2];\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfAddV3(u, v) {\r\n\tu[0] += v[0];\r\n\tu[1] += v[1];\r\n\tu[2] += v[2];\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfAddV3S(v, s) {\r\n\tv[0] += s;\r\n\tv[1] += s;\r\n\tv[2] += s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfAddSV3(s, v) {\r\n\tv[0] += s;\r\n\tv[1] += s;\r\n\tv[2] += s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfSubV3(u, v) {\r\n\tu[0] -= v[0];\r\n\tu[1] -= v[1];\r\n\tu[2] -= v[2];\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfSubV3S(v, s) {\r\n\tv[0] -= s;\r\n\tv[1] -= s;\r\n\tv[2] -= s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfSubSV3(v, s) {\r\n\tv[0] = s - v[0];\r\n\tv[1] = s - v[1];\r\n\tv[2] = s - v[2];\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfMulV3(u, v) {\r\n\tu[0] *= v[0];\r\n\tu[1] *= v[1];\r\n\tu[2] *= v[2];\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfMulV3S(v, s) {\r\n\tv[0] *= s;\r\n\tv[1] *= s;\r\n\tv[2] *= s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfMulSV3(s, v) {\r\n\tv[0] *= s;\r\n\tv[1] *= s;\r\n\tv[2] *= s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfDivV3(u, v) {\r\n\tu[0] /= v[0];\r\n\tu[1] /= v[1];\r\n\tu[2] /= v[2];\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfDivV3S(v, s) {\r\n\tu[0] /= s;\r\n\tu[1] /= s;\r\n\tu[2] /= s;\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfDivSV3(s, v) {\r\n\tv[0] = s / v[0];\r\n\tv[1] = s / v[1];\r\n\tv[2] = s / v[2];\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfRcpV3(v) {\r\n\treturn sglSelfDivSV3(1.0, v);\r\n}\r\n\r\nfunction sglSelfCrossV3(u, v) {\r\n\tvar t = sglV3C(u[1]*v[2] - u[2]*v[1], u[2]*v[0] - u[0]*v[2], u[0]*v[1] - u[1]*v[0]);\r\n\tu[0] = t[0];\r\n\tu[1] = t[1];\r\n\tu[2] = t[2];\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfNormalizeV3(v) {\r\n\tvar f = 1.0 / sglLengthV3(v);\r\n\treturn sglSelfMulV3S(v, f);\r\n}\r\n\r\nfunction sglMinV3(u, v) {\r\n\treturn [\r\n\t\t((u[0] < v[0]) ? (u[0]) : (v[0])),\r\n\t\t((u[1] < v[1]) ? (u[1]) : (v[1])),\r\n\t\t((u[2] < v[2]) ? (u[2]) : (v[2]))\r\n\t];\r\n}\r\n\r\nfunction sglMaxV3(u, v) {\r\n\treturn [\r\n\t\t((u[0] > v[0]) ? (u[0]) : (v[0])),\r\n\t\t((u[1] > v[1]) ? (u[1]) : (v[1])),\r\n\t\t((u[2] > v[2]) ? (u[2]) : (v[2]))\r\n\t];\r\n}\r\n\r\nfunction sglV3toV2(v) {\r\n\treturn v.slice(0, 2);\r\n}\r\n\r\nfunction sglV3toV4(v, w) {\r\n\treturn sglV4C(v[0], v[1], v[2], w);\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// 4-dimensional vector\r\n/***********************************************************************/\r\nfunction sglUndefV4(v) {\r\n\treturn new Array(4);\r\n}\r\n\r\nfunction sglV4V(v) {\r\n\treturn v.slice(0, 4);\r\n}\r\n\r\nfunction sglV4S(s) {\r\n\treturn [ s, s, s, s ];\r\n}\r\n\r\nfunction sglV4C(x, y, z, w) {\r\n\treturn [ x, y, z, w ];\r\n}\r\n\r\nfunction sglZeroV4() {\r\n\treturn sglV4S(0.0);\r\n}\r\n\r\nfunction sglOneV4() {\r\n\treturn sglV4S(1.0);\r\n}\r\n\r\nfunction sglV4() {\r\n\tvar n = arguments.length;\r\n\tvar s;\r\n\tswitch (n) {\r\n\t\tcase 1:\r\n\t\t\tif (arguments[0] instanceof Array) {\r\n\t\t\t\treturn sglV4V(arguments[0]);\r\n\t\t\t}\r\n\t\t\treturn sglV4S(arguments[0]);\r\n\t\tbreak;\r\n\r\n\t\tcase 4:\r\n\t\t\treturn sglV4V(arguments);\r\n\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t\t\treturn sglZeroV4();\r\n\t\tbreak;\r\n\t}\r\n\treturn null;\r\n}\r\n\r\nfunction sglDupV4(v) {\r\n\treturn v.slice(0, 4);\r\n}\r\n\r\nfunction sglNegV4(v) {\r\n\treturn sglV4C(-v[0], -v[1], -v[2], -v[3]);\r\n}\r\n\r\nfunction sglAddV4(u, v) {\r\n\treturn sglV4C(u[0]+v[0], u[1]+v[1], u[2]+v[2], u[3]+v[3]);\r\n}\r\n\r\nfunction sglAddV4S(v, s) {\r\n\treturn sglV4C(v[0]+s, v[1]+s, v[2]+s, v[3]+s);\r\n}\r\n\r\nfunction sglAddSV4(s, v) {\r\n\treturn sglAddV4S(v, s)\r\n}\r\n\r\nfunction sglSubV4(u, v) {\r\n\treturn sglV4C(u[0]-v[0], u[1]-v[1], u[2]-v[2], u[3]-v[3]);\r\n}\r\n\r\nfunction sglSubV4S(v, s) {\r\n\treturn sglV4C(v[0]-s, v[1]-s, v[2]-s, v[3]-s);\r\n}\r\n\r\nfunction sglSubSV4(v, s) {\r\n\treturn sglV4C(s-v[0], s-v[1], s-v[2], s-v[3]);\r\n}\r\n\r\nfunction sglMulV4(u, v) {\r\n\treturn sglV4C(u[0]*v[0], u[1]*v[1], u[2]*v[2], u[3]*v[3]);\r\n}\r\n\r\nfunction sglMulV4S(v, s) {\r\n\treturn sglV4C(v[0]*s, v[1]*s, v[2]*s, v[3]*s);\r\n}\r\n\r\nfunction sglMulSV4(s, v) {\r\n\treturn sglMulV4S(v, s);\r\n}\r\n\r\nfunction sglDivV4(u, v) {\r\n\treturn sglV4C(u[0]/v[0], u[1]/v[1], u[2]/v[2], u[3]/v[3]);\r\n}\r\n\r\nfunction sglDivV4S(v, s) {\r\n\treturn sglV4C(v[0]/s, v[1]/s, v[2]/s, v[3]/s);\r\n}\r\n\r\nfunction sglDivSV4(s, v) {\r\n\treturn sglV4C(s/v[0], s/v[1], s/v[2], s/v[3]);\r\n}\r\n\r\nfunction sglRcpV4(v) {\r\n\treturn sglDivSV4(1.0, v);\r\n}\r\n\r\nfunction sglDotV4(u, v) {\r\n\treturn (u[0]*v[0] + u[1]*v[1] + u[2]*v[2] + u[3]*v[3]);\r\n}\r\n\r\nfunction sglSqLengthV4(v) {\r\n\treturn sglDotV4(v, v);\r\n}\r\n\r\nfunction sglLengthV4(v) {\r\n\treturn sglSqrt(sglSqLengthV4(v));\r\n}\r\n\r\nfunction sglNormalizedV4(v) {\r\n\tvar f = 1.0 / sglLengthV4(v);\r\n\treturn sglMulV4S(v, f);\r\n}\r\n\r\nfunction sglProjectV4(v) {\r\n\tvar f = 1.0 / v[3];\r\n\treturn sglV4C(v[0]*f, v[1]*f, v[2]*f, 1.0);\r\n}\r\n\r\nfunction sglSelfNegV4(v) {\r\n\tv[0] = -v[0];\r\n\tv[1] = -v[1];\r\n\tv[2] = -v[2];\r\n\tv[3] = -v[3];\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfAddV4(u, v) {\r\n\tu[0] += v[0];\r\n\tu[1] += v[1];\r\n\tu[2] += v[2];\r\n\tu[3] += v[3];\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfAddV4S(v, s) {\r\n\tv[0] += s;\r\n\tv[1] += s;\r\n\tv[2] += s;\r\n\tv[3] += s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfAddSV4(s, v) {\r\n\tv[0] += s;\r\n\tv[1] += s;\r\n\tv[2] += s;\r\n\tv[3] += s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfSubV4(u, v) {\r\n\tu[0] -= v[0];\r\n\tu[1] -= v[1];\r\n\tu[2] -= v[2];\r\n\tu[3] -= v[3];\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfSubV4S(v, s) {\r\n\tv[0] -= s;\r\n\tv[1] -= s;\r\n\tv[2] -= s;\r\n\tv[3] -= s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfSubSV4(v, s) {\r\n\tv[0] = s - v[0];\r\n\tv[1] = s - v[1];\r\n\tv[2] = s - v[2];\r\n\tv[3] = s - v[3];\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfMulV4(u, v) {\r\n\tu[0] *= v[0];\r\n\tu[1] *= v[1];\r\n\tu[2] *= v[2];\r\n\tu[3] *= v[3];\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfMulV4S(v, s) {\r\n\tv[0] *= s;\r\n\tv[1] *= s;\r\n\tv[2] *= s;\r\n\tv[3] *= s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfMulSV4(s, v) {\r\n\tv[0] *= s;\r\n\tv[1] *= s;\r\n\tv[2] *= s;\r\n\tv[3] *= s;\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfDivV4(u, v) {\r\n\tu[0] /= v[0];\r\n\tu[1] /= v[1];\r\n\tu[2] /= v[2];\r\n\tu[3] /= v[3];\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfDivV4S(v, s) {\r\n\tu[0] /= s;\r\n\tu[1] /= s;\r\n\tu[2] /= s;\r\n\tu[3] /= s;\r\n\treturn u;\r\n}\r\n\r\nfunction sglSelfDivSV4(s, v) {\r\n\tv[0] = s / v[0];\r\n\tv[1] = s / v[1];\r\n\tv[2] = s / v[2];\r\n\tv[3] = s / v[3];\r\n\treturn v;\r\n}\r\n\r\nfunction sglSelfRcpV4(v) {\r\n\treturn sglSelfDivSV4(1.0, v);\r\n}\r\n\r\nfunction sglSelfNormalizeV4(v) {\r\n\tvar f = 1.0 / sglLengthV4(v);\r\n\treturn sglSelfMulV4S(v, f);\r\n}\r\n\r\nfunction sglSelfProjectV4(v) {\r\n\tvar f = 1.0 / v[3];\r\n\tv[0] *= f;\r\n\tv[1] *= f;\r\n\tv[2] *= f;\r\n\tv[3]  = 1.0;\r\n\treturn v;\r\n}\r\n\r\nfunction sglMinV4(u, v) {\r\n\treturn [\r\n\t\t((u[0] < v[0]) ? (u[0]) : (v[0])),\r\n\t\t((u[1] < v[1]) ? (u[1]) : (v[1])),\r\n\t\t((u[2] < v[2]) ? (u[2]) : (v[2])),\r\n\t\t((u[3] < v[3]) ? (u[3]) : (v[3]))\r\n\t];\r\n}\r\n\r\nfunction sglMaxV4(u, v) {\r\n\treturn [\r\n\t\t((u[0] > v[0]) ? (u[0]) : (v[0])),\r\n\t\t((u[1] > v[1]) ? (u[1]) : (v[1])),\r\n\t\t((u[2] > v[2]) ? (u[2]) : (v[2])),\r\n\t\t((u[3] > v[3]) ? (u[3]) : (v[3]))\r\n\t];\r\n}\r\n\r\nfunction sglV4toV2(v) {\r\n\treturn v.slice(0, 2);\r\n}\r\n\r\nfunction sglV4toV3(v) {\r\n\treturn v.slice(0, 3);\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// 4x4 matrix\r\n/***********************************************************************/\r\nfunction sglUndefM4() {\r\n\treturn new Array(16);\r\n}\r\n\r\nfunction sglM4V(v) {\r\n\treturn v.slice(0, 16);\r\n}\r\n\r\nfunction sglM4S(s) {\r\n\tvar m = sglUndefM4();\r\n\tfor (var i=0; i<16; ++i) {\r\n\t\tm[i] = s;\r\n\t}\r\n\treturn m;\r\n}\r\n\r\nfunction sglDiagM4V(d) {\r\n\tvar m = sglM4S(0.0);\r\n\tm[ 0] = d[0];\r\n\tm[ 5] = d[1];\r\n\tm[10] = d[2];\r\n\tm[15] = d[3];\r\n\treturn m;\r\n}\r\n\r\nfunction sglDiagM4S(s) {\r\n\tvar m = sglM4S(0.0);\r\n\tm[ 0] = s;\r\n\tm[ 5] = s;\r\n\tm[10] = s;\r\n\tm[15] = s;\r\n\treturn m;\r\n}\r\n\r\nfunction sglDiagM4C(m00, m11, m22, m33) {\r\n\treturn sglDiagM4V(arguments);\r\n}\r\n\r\nfunction sglZeroM4() {\r\n\treturn sglM4S(0.0);\r\n}\r\n\r\nfunction sglOneM4() {\r\n\treturn sglM4S(1.0);\r\n}\r\n\r\nfunction sglIdentityM4() {\r\n\treturn sglDiagM4S(1.0);\r\n}\r\n\r\nfunction sglM4() {\r\n\tvar n = arguments.length;\r\n\tswitch (n) {\r\n\t\tcase 1:\r\n\t\t\tif (arguments[0] instanceof Array) {\r\n\t\t\t\tswitch (arguments[0].length) {\r\n\t\t\t\t\tcase 1:\r\n\t\t\t\t\t\treturn sglDiagM4S(arguments[0]);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 4:\r\n\t\t\t\t\t\treturn sglDiagM4V(arguments[0]);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 16:\r\n\t\t\t\t\t\treturn sglM4V(arguments[0]);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t\tdefault:\r\n\t\t\t\t\t\treturn sglIdentityM4();\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\treturn sglM4S(arguments[0]);\r\n\t\tbreak;\r\n\r\n\t\tcase 4:\r\n\t\t\treturn sglDiagM4V(arguments);\r\n\t\tbreak;\r\n\r\n\t\tcase 16:\r\n\t\t\treturn sglM4V(arguments);\r\n\t\tbreak;\r\n\r\n\t\tdefault:\r\n\t\t\treturn sglIdentityM4();\r\n\t\tbreak;\r\n\t}\r\n\treturn null;\r\n}\r\n\r\nfunction sglDupM4(m) {\r\n\tvar r = sglUndefM4();\r\n\r\n\tr[ 0] = m[ 0];\r\n\tr[ 1] = m[ 1];\r\n\tr[ 2] = m[ 2];\r\n\tr[ 3] = m[ 3];\r\n\r\n\tr[ 4] = m[ 4];\r\n\tr[ 5] = m[ 5];\r\n\tr[ 6] = m[ 6];\r\n\tr[ 7] = m[ 7];\r\n\r\n\tr[ 8] = m[ 8];\r\n\tr[ 9] = m[ 9];\r\n\tr[10] = m[10];\r\n\tr[11] = m[11];\r\n\r\n\tr[12] = m[12];\r\n\tr[13] = m[13];\r\n\tr[14] = m[14];\r\n\tr[15] = m[15];\r\n\r\n\treturn r;\r\n\r\n\t//return m.slice(0, 16);\r\n\t//return m.slice();\r\n}\r\n\r\nfunction sglGetElemM4(m, row, col) {\r\n\treturn m[row+col*4];\r\n}\r\n\r\nfunction sglSetElemM4(m, row, col, value) {\r\n\tm[row+col*4] = value;\r\n}\r\n\r\nfunction sglGetRowM4(m, r) {\r\n\treturn sglV4C(m[r+0], m[r+4], m[r+8], m[r+12]);\r\n}\r\n\r\nfunction sglSetRowM4V(m, r, v) {\r\n\tm[r+ 0] = v[0];\r\n\tm[r+ 4] = v[1];\r\n\tm[r+ 8] = v[2];\r\n\tm[r+12] = v[3];\r\n}\r\n\r\nfunction sglSetRowM4S(m, r, s) {\r\n\tm[r+ 0] = s;\r\n\tm[r+ 4] = s;\r\n\tm[r+ 8] = s;\r\n\tm[r+12] = s;\r\n}\r\n\r\nfunction sglSetRowM4C(m, r, x, y, z, w) {\r\n\tm[r+ 0] = x;\r\n\tm[r+ 4] = y;\r\n\tm[r+ 8] = z;\r\n\tm[r+12] = w;\r\n}\r\n\r\nfunction sglGetColM4(m, c) {\r\n\tvar i = c * 4;\r\n\treturn sglV4C(m[i+0], m[i+1], m[i+2], m[i+3]);\r\n}\r\n\r\nfunction sglSetColM4V(m, c, v) {\r\n\tvar i = c * 4;\r\n\tm[i+0] = v[0];\r\n\tm[i+1] = v[1];\r\n\tm[i+2] = v[2];\r\n\tm[i+3] = v[3];\r\n}\r\n\r\nfunction sglSetColM4S(m, c, s) {\r\n\tvar i = c * 4;\r\n\tm[i+0] = s;\r\n\tm[i+1] = s;\r\n\tm[i+2] = s;\r\n\tm[i+3] = s;\r\n}\r\n\r\nfunction sglSetColM4C(m, c, x, y, z, w) {\r\n\tvar i = c * 4;\r\n\tm[i+0] = x;\r\n\tm[i+1] = y;\r\n\tm[i+2] = z;\r\n\tm[i+3] = w;\r\n}\r\n\r\nfunction sglM4toM3(m) {\r\n\treturn [\r\n\t\tm[ 0], m[ 1], m[ 2],\r\n\t\tm[ 4], m[ 5], m[ 6],\r\n\t\tm[ 8], m[ 9], m[10]\r\n\t];\r\n}\r\n\r\nfunction sglIsIdentityM4(m) {\r\n\tvar i = 0;\r\n\tvar j = 0;\r\n\tvar s = 0.0;\r\n\tfor (i=0; i<4; ++i) {\r\n\t\tfor (j=0; j<4; ++j) {\r\n\t\t\ts = m[i+j*4];\r\n\t\t\tif ((i == j)) {\r\n\t\t\t\tif (s != 1.0) {\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tif (s != 0.0) {\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn true;\r\n}\r\n\r\nfunction sglNegM4(m) {\r\n\tvar r = sglUndefM4();\r\n\tfor (var i=0; i<16; ++i) {\r\n\t\tr[i] = -m[i];\r\n\t}\r\n\treturn r;\r\n}\r\n\r\nfunction sglAddM4(a, b) {\r\n\tvar r = sglUndefM4();\r\n\tfor (var i=0; i<16; ++i) {\r\n\t\tr[i] = a[i] + b[i];\r\n\t}\r\n\treturn r;\r\n}\r\n\r\nfunction sglAddM4S(m, s)\r\n{\r\n\tvar r = sglUndefM4();\r\n\tfor (var i=0; i<16; ++i) {\r\n\t\tr[i] = m[i] + s;\r\n\t}\r\n\treturn r;\r\n}\r\n\r\nfunction sglAddSM4(s, m) {\r\n\treturn sglAddM4S(m, s);\r\n}\r\n\r\nfunction sglSubM4(a, b) {\r\n\tvar r = sglUndefM4();\r\n\tfor (var i=0; i<16; ++i) {\r\n\t\tr[i] = a[i] - b[i];\r\n\t}\r\n\treturn r;\r\n}\r\n\r\nfunction sglSubM4S(m, s) {\r\n\tvar r = sglUndefM4();\r\n\tfor (var i=0; i<16; ++i) {\r\n\t\tr[i] = m[i] - s;\r\n\t}\r\n\treturn r;\r\n}\r\n\r\nfunction sglSubSM4(s, m) {\r\n\tvar r = sglUndefM4();\r\n\tfor (var i=0; i<16; ++i) {\r\n\t\tr[i] = s - m[i];\r\n\t}\r\n\treturn r;\r\n}\r\n\r\nfunction sglMulM4(a, b) {\r\n\tvar a0  = a[ 0], a1  = a[ 1],  a2 = a[ 2], a3  = a[ 3],\r\n\t    a4  = a[ 4], a5  = a[ 5],  a6 = a[ 6], a7  = a[ 7],\r\n\t    a8  = a[ 8], a9  = a[ 9], a10 = a[10], a11 = a[11],\r\n\t    a12 = a[12], a13 = a[13], a14 = a[14], a15 = a[15],\r\n\r\n\t    b0  = b[ 0], b1  = b[ 1], b2  = b[ 2], b3  = b[ 3],\r\n\t    b4  = b[ 4], b5  = b[ 5], b6  = b[ 6], b7  = b[ 7],\r\n\t    b8  = b[ 8], b9  = b[ 9], b10 = b[10], b11 = b[11],\r\n\t    b12 = b[12], b13 = b[13], b14 = b[14], b15 = b[15];\r\n\r\n\tvar r = sglUndefM4();\r\n\r\n\tr[ 0] = a0*b0 + a4*b1 + a8*b2  + a12*b3;\r\n\tr[ 1] = a1*b0 + a5*b1 + a9*b2  + a13*b3;\r\n\tr[ 2] = a2*b0 + a6*b1 + a10*b2 + a14*b3;\r\n\tr[ 3] = a3*b0 + a7*b1 + a11*b2 + a15*b3;\r\n\r\n\tr[ 4] = a0*b4 + a4*b5 + a8*b6  + a12*b7;\r\n\tr[ 5] = a1*b4 + a5*b5 + a9*b6  + a13*b7;\r\n\tr[ 6] = a2*b4 + a6*b5 + a10*b6 + a14*b7;\r\n\tr[ 7] = a3*b4 + a7*b5 + a11*b6 + a15*b7;\r\n\r\n\tr[ 8] = a0*b8 + a4*b9 + a8*b10  + a12*b11;\r\n\tr[ 9] = a1*b8 + a5*b9 + a9*b10  + a13*b11;\r\n\tr[10] = a2*b8 + a6*b9 + a10*b10 + a14*b11;\r\n\tr[11] = a3*b8 + a7*b9 + a11*b10 + a15*b11;\r\n\r\n\tr[12] = a0*b12 + a4*b13 + a8*b14  + a12*b15;\r\n\tr[13] = a1*b12 + a5*b13 + a9*b14  + a13*b15;\r\n\tr[14] = a2*b12 + a6*b13 + a10*b14 + a14*b15;\r\n\tr[15] = a3*b12 + a7*b13 + a11*b14 + a15*b15;\r\n\r\n\t/*\r\n\tr[ 0] = a[ 0]*b[ 0] + a[ 4]*b[ 1] + a[ 8]*b[ 2] + a[12]*b[ 3];\r\n\tr[ 1] = a[ 1]*b[ 0] + a[ 5]*b[ 1] + a[ 9]*b[ 2] + a[13]*b[ 3];\r\n\tr[ 2] = a[ 2]*b[ 0] + a[ 6]*b[ 1] + a[10]*b[ 2] + a[14]*b[ 3];\r\n\tr[ 3] = a[ 3]*b[ 0] + a[ 7]*b[ 1] + a[11]*b[ 2] + a[15]*b[ 3];\r\n\r\n\tr[ 4] = a[ 0]*b[ 4] + a[ 4]*b[ 5] + a[ 8]*b[ 6] + a[12]*b[ 7];\r\n\tr[ 5] = a[ 1]*b[ 4] + a[ 5]*b[ 5] + a[ 9]*b[ 6] + a[13]*b[ 7];\r\n\tr[ 6] = a[ 2]*b[ 4] + a[ 6]*b[ 5] + a[10]*b[ 6] + a[14]*b[ 7];\r\n\tr[ 7] = a[ 3]*b[ 4] + a[ 7]*b[ 5] + a[11]*b[ 6] + a[15]*b[ 7];\r\n\r\n\tr[ 8] = a[ 0]*b[ 8] + a[ 4]*b[ 9] + a[ 8]*b[10] + a[12]*b[11];\r\n\tr[ 9] = a[ 1]*b[ 8] + a[ 5]*b[ 9] + a[ 9]*b[10] + a[13]*b[11];\r\n\tr[10] = a[ 2]*b[ 8] + a[ 6]*b[ 9] + a[10]*b[10] + a[14]*b[11];\r\n\tr[11] = a[ 3]*b[ 8] + a[ 7]*b[ 9] + a[11]*b[10] + a[15]*b[11];\r\n\r\n\tr[12] = a[ 0]*b[12] + a[ 4]*b[13] + a[ 8]*b[14] + a[12]*b[15];\r\n\tr[13] = a[ 1]*b[12] + a[ 5]*b[13] + a[ 9]*b[14] + a[13]*b[15];\r\n\tr[14] = a[ 2]*b[12] + a[ 6]*b[13] + a[10]*b[14] + a[14]*b[15];\r\n\tr[15] = a[ 3]*b[12] + a[ 7]*b[13] + a[11]*b[14] + a[15]*b[15];\r\n\t*/\r\n\r\n\treturn r;\r\n\r\n\t/*\r\n\tvar r = sglUndefM4();\r\n\r\n\tr[ 0] = a[ 0]*b[ 0] + a[ 4]*b[ 1] + a[ 8]*b[ 2] + a[12]*b[ 3];\r\n\tr[ 1] = a[ 1]*b[ 0] + a[ 5]*b[ 1] + a[ 9]*b[ 2] + a[13]*b[ 3];\r\n\tr[ 2] = a[ 2]*b[ 0] + a[ 6]*b[ 1] + a[10]*b[ 2] + a[14]*b[ 3];\r\n\tr[ 3] = a[ 3]*b[ 0] + a[ 7]*b[ 1] + a[11]*b[ 2] + a[15]*b[ 3];\r\n\r\n\tr[ 4] = a[ 0]*b[ 4] + a[ 4]*b[ 5] + a[ 8]*b[ 6] + a[12]*b[ 7];\r\n\tr[ 5] = a[ 1]*b[ 4] + a[ 5]*b[ 5] + a[ 9]*b[ 6] + a[13]*b[ 7];\r\n\tr[ 6] = a[ 2]*b[ 4] + a[ 6]*b[ 5] + a[10]*b[ 6] + a[14]*b[ 7];\r\n\tr[ 7] = a[ 3]*b[ 4] + a[ 7]*b[ 5] + a[11]*b[ 6] + a[15]*b[ 7];\r\n\r\n\tr[ 8] = a[ 0]*b[ 8] + a[ 4]*b[ 9] + a[ 8]*b[10] + a[12]*b[11];\r\n\tr[ 9] = a[ 1]*b[ 8] + a[ 5]*b[ 9] + a[ 9]*b[10] + a[13]*b[11];\r\n\tr[10] = a[ 2]*b[ 8] + a[ 6]*b[ 9] + a[10]*b[10] + a[14]*b[11];\r\n\tr[11] = a[ 3]*b[ 8] + a[ 7]*b[ 9] + a[11]*b[10] + a[15]*b[11];\r\n\r\n\tr[12] = a[ 0]*b[12] + a[ 4]*b[13] + a[ 8]*b[14] + a[12]*b[15];\r\n\tr[13] = a[ 1]*b[12] + a[ 5]*b[13] + a[ 9]*b[14] + a[13]*b[15];\r\n\tr[14] = a[ 2]*b[12] + a[ 6]*b[13] + a[10]*b[14] + a[14]*b[15];\r\n\tr[15] = a[ 3]*b[12] + a[ 7]*b[13] + a[11]*b[14] + a[15]*b[15];\r\n\r\n\treturn r;\r\n\t*/\r\n}\r\n\r\nfunction sglMulM4S(m, s) {\r\n\tvar r = sglUndefM4();\r\n\tfor (var i=0; i<16; ++i) {\r\n\t\tr[i] = m[i] * s;\r\n\t}\r\n\treturn r;\r\n}\r\n\r\nfunction sglMulSM4(s, m) {\r\n\treturn sglMulM4S(m, s);\r\n}\r\n\r\nfunction sglMulM4V3(m, v, w) {\r\n\treturn [\r\n\t\tm[ 0] * v[0] + m[ 4] * v[1] + m[ 8] * v[2] + m[12] * w,\r\n\t\tm[ 1] * v[0] + m[ 5] * v[1] + m[ 9] * v[2] + m[13] * w,\r\n\t\tm[ 2] * v[0] + m[ 6] * v[1] + m[10] * v[2] + m[14] * w /* ,\r\n\t\tm[ 3] * v[0] + m[ 7] * v[1] + m[11] * v[2] + m[15] * w*/\r\n\t];\r\n}\r\n\r\nfunction sglMulM4V4(m, v) {\r\n\treturn [\r\n\t\tm[ 0] * v[0] + m[ 4] * v[1] + m[ 8] * v[2] + m[12] * v[3],\r\n\t\tm[ 1] * v[0] + m[ 5] * v[1] + m[ 9] * v[2] + m[13] * v[3],\r\n\t\tm[ 2] * v[0] + m[ 6] * v[1] + m[10] * v[2] + m[14] * v[3],\r\n\t\tm[ 3] * v[0] + m[ 7] * v[1] + m[11] * v[2] + m[15] * v[3]\r\n\t];\r\n}\r\n\r\nfunction sglDivM4S(m, s) {\r\n\tvar r = sglUndefM4();\r\n\tfor (var i=0; i<16; ++i) {\r\n\t\tr[i] = m[i] / s;\r\n\t}\r\n\treturn r;\r\n}\r\n\r\nfunction sglDivSM4(s, m) {\r\n\tvar r = sglUndefM4();\r\n\tfor (var i=0; i<16; ++i) {\r\n\t\tr[i] = s / m[i];\r\n\t}\r\n\treturn r;\r\n}\r\n\r\nfunction sglRcpM4(m) {\r\n\treturn sglDivSM4(1.0, m);\r\n}\r\n\r\nfunction sglCompMulM4(a, b) {\r\n\tvar r = sglUndefM4();\r\n\tfor (var i=0; i<16; ++i) {\r\n\t\tr[i] = a[i] * b[i];\r\n\t}\r\n\treturn r;\r\n}\r\n\r\nfunction sglCompDivM4(a, b) {\r\n\tvar r = sglUndefM4();\r\n\tfor (var i=0; i<16; ++i) {\r\n\t\tr[i] = a[i] / b[i];\r\n\t}\r\n\treturn r;\r\n}\r\n\r\nfunction sglTransposeM4(m) {\r\n\tvar r = sglUndefM4();\r\n\r\n\tr[ 0] = m[ 0];\r\n\tr[ 1] = m[ 4];\r\n\tr[ 2] = m[ 8];\r\n\tr[ 3] = m[12];\r\n\t\r\n\tr[ 4] = m[ 1];\r\n\tr[ 5] = m[ 5];\r\n\tr[ 6] = m[ 9];\r\n\tr[ 7] = m[13];\r\n\t\r\n\tr[ 8] = m[ 2];\r\n\tr[ 9] = m[ 6];\r\n\tr[10] = m[10];\r\n\tr[11] = m[14];\r\n\t\r\n\tr[12] = m[ 3];\r\n\tr[13] = m[ 7];\r\n\tr[14] = m[11];\r\n\tr[15] = m[15];\r\n\t\r\n\treturn r;\r\n}\r\n\r\nfunction sglDeterminantM4(m) {\r\n\tvar m0  = m[ 0], m1  = m[ 1], m2  = m[ 2], m3  = m[ 3],\r\n\t    m4  = m[ 4], m5  = m[ 5], m6  = m[ 6], m7  = m[ 7],\r\n\t    m8  = m[ 8], m9  = m[ 9], m10 = m[10], m11 = m[11],\r\n\t    m12 = m[12], m13 = m[13], m14 = m[14], m15 = m[15]\r\n\r\n\treturn (\r\n\t\tm12 * m9 * m6 * m3 - m8 * m13 * m6 * m3 - m12 * m5 * m10 * m3 + m4 * m13 * m10 * m3 +\r\n\t\tm8 * m5 * m14 * m3 - m4 * m9 * m14 * m3 - m12 * m9 * m2 * m7 + m8 * m13 * m2 * m7 +\r\n\t\tm12 * m1 * m10 * m7 - m0 * m13 * m10 * m7 - m8 * m1 * m14 * m7 + m0 * m9 * m14 * m7 +\r\n\t\tm12 * m5 * m2 * m11 - m4 * m13 * m2 * m11 - m12 * m1 * m6 * m11 + m0 * m13 * m6 * m11 +\r\n\t\tm4 * m1 * m14 * m11 - m0 * m5 * m14 * m11 - m8 * m5 * m2 * m15 + m4 * m9 * m2 * m15 +\r\n\t\tm8 * m1 * m6 * m15 - m0 * m9 * m6 * m15 - m4 * m1 * m10 * m15 + m0 * m5 * m10 * m15\r\n\t);\r\n}\r\n\r\nfunction sglInverseM4(m) {\r\n\tvar m0  = m[ 0], m1  = m[ 1], m2  = m[ 2], m3  = m[ 3],\r\n\t    m4  = m[ 4], m5  = m[ 5], m6  = m[ 6], m7  = m[ 7],\r\n\t    m8  = m[ 8], m9  = m[ 9], m10 = m[10], m11 = m[11],\r\n\t    m12 = m[12], m13 = m[13], m14 = m[14], m15 = m[15]\r\n\r\n\tvar t = sglUndefM4();\r\n\r\n\tt[ 0] = (m9*m14*m7-m13*m10*m7+m13*m6*m11-m5*m14*m11-m9*m6*m15+m5*m10*m15);\r\n\tt[ 1] = (m13*m10*m3-m9*m14*m3-m13*m2*m11+m1*m14*m11+m9*m2*m15-m1*m10*m15);\r\n\tt[ 2] = (m5*m14*m3-m13*m6*m3+m13*m2*m7-m1*m14*m7-m5*m2*m15+m1*m6*m15);\r\n\tt[ 3] = (m9*m6*m3-m5*m10*m3-m9*m2*m7+m1*m10*m7+m5*m2*m11-m1*m6*m11);\r\n\r\n\tt[ 4] = (m12*m10*m7-m8*m14*m7-m12*m6*m11+m4*m14*m11+m8*m6*m15-m4*m10*m15);\r\n\tt[ 5] = (m8*m14*m3-m12*m10*m3+m12*m2*m11-m0*m14*m11-m8*m2*m15+m0*m10*m15);\r\n\tt[ 6] = (m12*m6*m3-m4*m14*m3-m12*m2*m7+m0*m14*m7+m4*m2*m15-m0*m6*m15);\r\n\tt[ 7] = (m4*m10*m3-m8*m6*m3+m8*m2*m7-m0*m10*m7-m4*m2*m11+m0*m6*m11);\r\n\r\n\tt[ 8] = (m8*m13*m7-m12*m9*m7+m12*m5*m11-m4*m13*m11-m8*m5*m15+m4*m9*m15);\r\n\tt[ 9] = (m12*m9*m3-m8*m13*m3-m12*m1*m11+m0*m13*m11+m8*m1*m15-m0*m9*m15);\r\n\tt[10] = (m4*m13*m3-m12*m5*m3+m12*m1*m7-m0*m13*m7-m4*m1*m15+m0*m5*m15);\r\n\tt[11] = (m8*m5*m3-m4*m9*m3-m8*m1*m7+m0*m9*m7+m4*m1*m11-m0*m5*m11);\r\n\r\n\tt[12] = (m12*m9*m6-m8*m13*m6-m12*m5*m10+m4*m13*m10+m8*m5*m14-m4*m9*m14);\r\n\tt[13] = (m8*m13*m2-m12*m9*m2+m12*m1*m10-m0*m13*m10-m8*m1*m14+m0*m9*m14);\r\n\tt[14] = (m12*m5*m2-m4*m13*m2-m12*m1*m6+m0*m13*m6+m4*m1*m14-m0*m5*m14);\r\n\tt[15] = (m4*m9*m2-m8*m5*m2+m8*m1*m6-m0*m9*m6-m4*m1*m10+m0*m5*m10);\r\n\r\n\tvar s = 1.0 / (\r\n\t\tm12 * m9 * m6 * m3 - m8 * m13 * m6 * m3 - m12 * m5 * m10 * m3 + m4 * m13 * m10 * m3 +\r\n\t\tm8 * m5 * m14 * m3 - m4 * m9 * m14 * m3 - m12 * m9 * m2 * m7 + m8 * m13 * m2 * m7 +\r\n\t\tm12 * m1 * m10 * m7 - m0 * m13 * m10 * m7 - m8 * m1 * m14 * m7 + m0 * m9 * m14 * m7 +\r\n\t\tm12 * m5 * m2 * m11 - m4 * m13 * m2 * m11 - m12 * m1 * m6 * m11 + m0 * m13 * m6 * m11 +\r\n\t\tm4 * m1 * m14 * m11 - m0 * m5 * m14 * m11 - m8 * m5 * m2 * m15 + m4 * m9 * m2 * m15 +\r\n\t\tm8 * m1 * m6 * m15 - m0 * m9 * m6 * m15 - m4 * m1 * m10 * m15 + m0 * m5 * m10 * m15\r\n\t);\r\n\r\n\tfor (var i=0; i<16; ++i) t[i] *= s;\r\n\r\n\treturn t;\r\n}\r\n\r\nfunction sglTraceM4(m) {\r\n\treturn (m[0] + m[5] + m[10] + m[15]);\r\n}\r\n\r\nfunction sglTranslationM4V(v) {\r\n\tvar m = sglIdentityM4();\r\n\tm[12] = v[0];\r\n\tm[13] = v[1];\r\n\tm[14] = v[2];\r\n\treturn m;\r\n}\r\n\r\nfunction sglTranslationM4C(x, y, z) {\r\n\treturn sglTranslationM4V([x, y, z]);\r\n}\r\n\r\nfunction sglTranslationM4S(s) {\r\n\treturn sglTranslationM4C(s, s, s);\r\n}\r\n\r\nfunction sglRotationAngleAxisM4V(angleRad, axis) {\r\n\tvar ax = sglNormalizedV3(axis);\r\n\tvar s  = sglSin(angleRad);\r\n\tvar c  = sglCos(angleRad);\r\n\tvar q   = 1.0 - c;\r\n\r\n\tvar x = ax[0];\r\n\tvar y = ax[1];\r\n\tvar z = ax[2];\r\n\r\n\tvar xx, yy, zz, xy, yz, zx, xs, ys, zs;\r\n\r\n\txx = x * x;\r\n\tyy = y * y;\r\n\tzz = z * z;\r\n\txy = x * y;\r\n\tyz = y * z;\r\n\tzx = z * x;\r\n\txs = x * s;\r\n\tys = y * s;\r\n\tzs = z * s;\r\n\r\n\tvar m = sglUndefM4();\r\n\r\n\tm[ 0] = (q * xx) + c;\r\n\tm[ 1] = (q * xy) + zs;\r\n\tm[ 2] = (q * zx) - ys;\r\n\tm[ 3] = 0.0;\r\n\r\n\tm[ 4] = (q * xy) - zs;\r\n\tm[ 5] = (q * yy) + c;\r\n\tm[ 6] = (q * yz) + xs;\r\n\tm[ 7] = 0.0;\r\n\r\n\tm[ 8] = (q * zx) + ys;\r\n\tm[ 9] = (q * yz) - xs;\r\n\tm[10] = (q * zz) + c;\r\n\tm[11] = 0.0;\r\n\r\n\tm[12] = 0.0;\r\n\tm[13] = 0.0;\r\n\tm[14] = 0.0;\r\n\tm[15] = 1.0;\r\n\r\n\treturn m;\r\n}\r\n\r\nfunction sglRotationAngleAxisM4C(angleRad, ax, ay, az) {\r\n\treturn sglRotationAngleAxisM4V(angleRad, [ax, ay, az]);\r\n}\r\n\r\nfunction sglScalingM4V(v) {\r\n\tvar m = sglIdentityM4();\r\n\tm[ 0] = v[0];\r\n\tm[ 5] = v[1];\r\n\tm[10] = v[2];\r\n\treturn m;\r\n}\r\n\r\nfunction sglScalingM4C(x, y, z) {\r\n\treturn sglScalingM4V([x, y, z]);\r\n}\r\n\r\nfunction sglScalingM4S(s) {\r\n\treturn sglScalingM4C(s, s, s);\r\n}\r\n\r\nfunction sglLookAtM4V(position, target, up) {\r\n\tvar v = sglNormalizedV3(sglSubV3(target, position));\r\n\tvar u = sglNormalizedV3(up);\r\n\tvar s = sglNormalizedV3(sglCrossV3(v, u));\r\n\r\n\tu = sglNormalizedV3(sglCrossV3(s, v));\r\n\r\n\tvar m = sglUndefM4();\r\n\r\n\tm[ 0] =  s[0];\r\n\tm[ 1] =  u[0];\r\n\tm[ 2] = -v[0];\r\n\tm[ 3] =   0.0;\r\n\r\n\tm[ 4] =  s[1];\r\n\tm[ 5] =  u[1];\r\n\tm[ 6] = -v[1];\r\n\tm[ 7] =   0.0;\r\n\r\n\tm[ 8] =  s[2];\r\n\tm[ 9] =  u[2];\r\n\tm[10] = -v[2];\r\n\tm[11] =   0.0;\r\n\r\n\tm[12] =   0.0;\r\n\tm[13] =   0.0;\r\n\tm[14] =   0.0;\r\n\tm[15] =   1.0;\r\n\r\n\tm = sglMulM4(m, sglTranslationM4V(sglNegV3(position)));\r\n\r\n\treturn m;\r\n}\r\n\r\nfunction sglLookAtM4C(positionX, positionY, positionZ, targetX, targetY, targetZ, upX, upY, upZ) {\r\n\treturn sglLookAtM4V([positionX, positionY, positionZ], [targetX, targetY, targetZ], [upX, upY, upZ]);\r\n}\r\n\r\nfunction sglOrthoM4V(omin, omax) {\r\n\tvar sum   = sglAddV3(omax, omin);\r\n\tvar dif   = sglSubV3(omax, omin);\r\n\r\n\tvar m = sglUndefM4();\r\n\r\n\tm[ 0] =      2.0 / dif[0];\r\n\tm[ 1] =               0.0;\r\n\tm[ 2] =               0.0;\r\n\tm[ 3] =               0.0;\r\n\r\n\tm[ 4] =               0.0;\r\n\tm[ 5] =      2.0 / dif[1];\r\n\tm[ 6] =               0.0;\r\n\tm[ 7] =               0.0;\r\n\r\n\tm[ 8] =               0.0;\r\n\tm[ 9] =               0.0;\r\n\tm[10] =     -2.0 / dif[2];\r\n\tm[11] =                 0.0;\r\n\r\n\tm[12] =  -sum[0] / dif[0];\r\n\tm[13] =  -sum[1] / dif[1];\r\n\tm[14] =  -sum[2] / dif[2];\r\n\tm[15] =               1.0;\r\n\r\n\treturn m;\r\n}\r\n\r\nfunction sglOrthoM4C(left, right, bottom, top, zNear, zFar) {\r\n\treturn sglOrthoM4V([left, bottom, zNear], [right, top, zFar]);\r\n}\r\n\r\nfunction sglFrustumM4V(fmin, fmax) {\r\n\tvar sum   = sglAddV3(fmax, fmin);\r\n\tvar dif   = sglSubV3(fmax, fmin);\r\n\tvar t     = 2.0 * fmin[2];\r\n\r\n\tvar m = sglUndefM4();\r\n\t\r\n\tm[ 0] =            t / dif[0];\r\n\tm[ 1] =                   0.0;\r\n\tm[ 2] =                   0.0;\r\n\tm[ 3] =                   0.0;\r\n\r\n\tm[ 4] =                   0.0;\r\n\tm[ 5] =            t / dif[1];\r\n\tm[ 6] =                   0.0;\r\n\tm[ 7] =                   0.0;\r\n\r\n\tm[ 8] =       sum[0] / dif[0];\r\n\tm[ 9] =       sum[1] / dif[1];\r\n\tm[10] =      -sum[2] / dif[2];\r\n\tm[11] =                  -1.0;\r\n\r\n\tm[12] =                   0.0;\r\n\tm[13] =                   0.0;\r\n\tm[14] = -t * fmax[2] / dif[2];\r\n\tm[15] =                   0.0;\r\n\r\n\treturn m;\r\n}\r\n\r\nfunction sglFrustumM4C(left, right, bottom, top, zNear, zFar) {\r\n\treturn sglFrustumM4V([left, bottom, zNear], [right, top, zFar]);\r\n}\r\n\r\nfunction sglPerspectiveM4(fovYRad, aspectRatio, zNear, zFar) {\r\n\tvar pmin = sglUndefV4();\r\n\tvar pmax = sglUndefV4();\r\n\r\n\tpmin[2] = zNear;\r\n\tpmax[2] = zFar;\r\n\r\n\tpmax[1] = pmin[2] * sglTan(fovYRad / 2.0);\r\n\tpmin[1] = -pmax[1];\r\n\r\n\tpmax[0] = pmax[1] * aspectRatio;\r\n\tpmin[0] = -pmax[0];\r\n\r\n\treturn sglFrustumM4V(pmin, pmax);\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// quaternion\r\n/***********************************************************************/\r\nfunction sglUndefQuat(v) {\r\n\treturn new Array(4);\r\n}\r\n\r\nfunction sglQuatV(v) {\r\n\treturn v.slice(0, 4);\r\n}\r\n\r\nfunction sglIdentityQuat() {\r\n\treturn [ 0.0, 0.0, 0.0, 1.0 ];\r\n}\r\n\r\nfunction sglAngleAxisQuat(angleRad, axis) {\r\n\tvar halfAngle = angleRad / 2.0;\r\n\tvar fsin = sglSin(halfAngle);\r\n\treturn [\r\n\t\tfsin * axis[0],\r\n\t\tfsin * axis[1],\r\n\t\tfsin * axis[2],\r\n\t\tsglCos(halfAngle)\r\n\t];\r\n}\r\n\r\nfunction sglM4Quat(m) {\r\n\tvar trace = sglGetElemM4(m, 0, 0) + sglGetElemM4(m, 1, 1) + sglGetElemM4(m, 2, 2);\r\n\tvar root = null;\r\n\tvar q = sglUndefQuat();\r\n\r\n\tif (trace > 0.0) {\r\n\t\troot = sglSqrt(trace + 1.0);\r\n\t\tq[3] = root / 2.0;\r\n\t\troot = 0.5 / root;\r\n\t\tq[0] = (sglGetElemM4(m, 2, 1) - sglGetElemM4(m, 1, 2)) * root;\r\n\t\tq[1] = (sglGetElemM4(m, 0, 2) - sglGetElemM4(m, 2, 0)) * root;\r\n\t\tq[2] = (sglGetElemM4(m, 1, 0) - sglGetElemM4(m, 0, 1)) * root;\r\n\t}\r\n\telse {\r\n\t\tvar i = 0;\r\n\r\n\t\tif (sglGetElemM4(m, 1, 1) > sglGetElemM4(m, 0, 0)) i = 1;\r\n\t\tif (sglGetElemM4(m, 2, 2) > sglGetElemM4(m, i, i)) i = 2;\r\n\r\n\t\tvar j = (i + 1) % 3;\r\n\t\tvar k = (j + 1) % 3;\r\n\r\n\t\troot = sglSqrt(sglGetElemM4(m, i, i) - sglGetElemM4(m, j, j) - sglGetElemM4(m, k, k) + 1.0);\r\n\r\n\t\tq[i] = root / 2.0;\r\n\t\troot = 0.5 / root;\r\n\t\tq[3] = (sglGetElemM4(m, k, j) - sglGetElemM4(m, j, k)) * root;\r\n\t\tq[j] = (sglGetElemM4(m, j, i) + sglGetElemM4(m, i, j)) * root;\r\n\t\tq[k] = (sglGetElemM4(m, k, i) + sglGetElemM4(m, i, k)) * root;\r\n\t}\r\n\treturn q;\r\n}\r\n\r\nfunction sglGetQuatAngleAxis(q) {\r\n\tvar v = new Array(4);\r\n\r\n\tvar sqLen = sglSqLengthV4(q);\r\n\tvar angle = null;\r\n\r\n\tif (sqLen > 0.0) {\r\n\t\tvar invLen = 1.0 / sglSqrt(sqLen);\r\n\t\tv[0] = q[0] * invLen;\r\n\t\tv[1] = q[1] * invLen;\r\n\t\tv[2] = q[2] * invLen;\r\n\t\tv[3] = 2.0 * aglAcos(q[3]);\r\n\t}\r\n\telse\r\n\t{\r\n\t\tv[0] = 0.0;\r\n\t\tv[1] = 0.0;\r\n\t\tv[2] = 1.0;\r\n\t\tv[3] = 0.0;\r\n\t}\r\n\r\n\treturn v;\r\n}\r\n\r\nfunction sglGetQuatRotationM4(q) {\r\n\tvar tx  = 2.0 * q[0];\r\n\tvar ty  = 2.0 * q[1];\r\n\tvar tz  = 2.0 * q[2];\r\n\tvar twx = tx * q[3];\r\n\tvar twy = ty * q[3];\r\n\tvar twz = tz * q[3];\r\n\tvar txx = tx * q[0];\r\n\tvar txy = ty * q[0];\r\n\tvar txz = tz * q[0];\r\n\tvar tyy = ty * q[1];\r\n\tvar tyz = tz * q[1];\r\n\tvar tzz = tz * q[2];\r\n\r\n\tvar m = sglIdentityM4();\r\n\r\n\tsglSetElemM4(m, 0, 0, 1.0 - (tyy + tzz));\r\n\tsglSetElemM4(m, 0, 1, txy - twz);\r\n\tsglSetElemM4(m, 0, 2, txz + twy);\r\n\tsglSetElemM4(m, 1, 0, txy + twz);\r\n\tsglSetElemM4(m, 1, 1, 1.0 - (txx + tzz));\r\n\tsglSetElemM4(m, 1, 2, tyz - twx);\r\n\tsglSetElemM4(m, 2, 0, txz - twy);\r\n\tsglSetElemM4(m, 2, 1, tyz + twx);\r\n\tsglSetElemM4(m, 2, 2, 1.0 - (txx + tyy));\r\n\r\n\treturn m;\r\n}\r\n\r\nfunction sglNormalizedQuat(q) {\r\n\treturn sglNormalizedV4(q);\r\n}\r\n\r\nfunction sglMulQuat(q1, q2) {\r\n\tvar r = sglUndefQuat();\r\n\r\n\tr[0] = p[3] * q[0] + p[0] * q[3] + p[1] * q[2] - p[2] * q[1];\r\n\tr[1] = p[3] * q[1] + p[1] * q[3] + p[2] * q[0] - p[0] * q[2];\r\n\tr[2] = p[3] * q[2] + p[2] * q[3] + p[0] * q[1] - p[1] * q[0];\r\n\tr[3] = p[3] * q[3] - p[0] * q[0] - p[1] * q[1] - p[2] * q[2];\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// SglVec2\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglVec2.\r\n * @class 2-dimensional vector.\r\n */\r\nfunction SglVec2() {\r\n\tthis.v = new Array(2);\r\n\tvar n = arguments.length;\r\n\tswitch (n) {\r\n\t\tcase 1:\r\n\t\t\tif (arguments[0] instanceof Array) {\r\n\t\t\t\tthis.setVec(arguments[0]);\r\n\t\t\t}\r\n\t\t\telse if (arguments[0] instanceof SglVec2) {\r\n\t\t\t\tthis.setVec(arguments[0].v);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthis.setScalar(arguments[0]);\r\n\t\t\t}\r\n\t\tbreak;\r\n\t\tcase 2:\r\n\t\t\tthis.setVec(arguments);\r\n\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tthis.setZero();\r\n\t\tbreak;\r\n\t}\r\n}\r\n\r\nSglVec2.prototype = {\r\n\tclone : function() {\r\n\t\treturn new SglVec2(this);\r\n\t},\r\n\r\n\tget copy() {\r\n\t\treturn this.clone();\r\n\t},\r\n\r\n\tget x( ) { return this.v[0]; },\r\n\tset x(n) { this.v[0] = n;    },\r\n\tget y( ) { return this.v[1]; },\r\n\tset y(n) { this.v[1] = n;    },\r\n\r\n\tset : function(x, y) {\r\n\t\tthis.v[0] = x;\r\n\t\tthis.v[1] = y;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsetVec : function(v) {\r\n\t\treturn this.set(v[0], v[1]);\r\n\t},\r\n\r\n\tsetScalar : function(s) {\r\n\t\treturn this.set(s, s);\r\n\t},\r\n\r\n\tsetZero : function() {\r\n\t\treturn this.setScalar(0.0);\r\n\t},\r\n\r\n\tsetOne : function() {\r\n\t\treturn this.setScalar(1.0);\r\n\t},\r\n\r\n\tat : function(i) {\r\n\t\treturn this.v[i];\r\n\t},\r\n\r\n\tget squaredLength() {\r\n\t\treturn this.dot(this);\r\n\t},\r\n\r\n\tget length() {\r\n\t\treturn sglSqrt(this.squaredLength);\r\n\t},\r\n\r\n\tnormalize : function() {\r\n\t\tvar f = this.length;\r\n\t\tif (f > 0.0) f = 1.0 / f;\r\n\t\tthis.v[0] *= f;\r\n\t\tthis.v[1] *= f;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tget normalized() {\r\n\t\treturn this.clone().normalize();\r\n\t},\r\n\r\n\tget neg() {\r\n\t\treturn new SglVec2(-(this.v[0]), -(this.v[1]));\r\n\t},\r\n\r\n\tget abs() {\r\n\t\treturn new SglVec2(sglAbs(this.v[0]), sglAbs(this.v[1]));\r\n\t},\r\n\r\n\tget minComp() {\r\n\t\tvar m = this.v[0];\r\n\t\tif (m > this.v[1]) m = this.v[1];\r\n\t\treturn m;\r\n\t},\r\n\r\n\tget maxComp() {\r\n\t\tvar m = this.v[0];\r\n\t\tif (m < this.v[1]) m = this.v[1];\r\n\t\treturn m;\r\n\t},\r\n\r\n\tget argMin() {\r\n\t\tvar a = 0;\r\n\t\tif (this.v[a] > this.v[1]) a = 1;\r\n\t\treturn a;\r\n\t},\r\n\r\n\tget argMax() {\r\n\t\tvar a = 0;\r\n\t\tif (this.v[a] > this.v[1]) a = 1;\r\n\t\treturn a;\r\n\t},\r\n\r\n\tadd : function(v) {\r\n\t\treturn new SglVec2(this.v[0] + v.v[0], this.v[1] + v.v[1]);\r\n\t},\r\n\r\n\tsub : function(v) {\r\n\t\treturn new SglVec2(this.v[0] - v.v[0], this.v[1] - v.v[1]);\r\n\t},\r\n\r\n\tmul : function(v) {\r\n\t\treturn new SglVec2(this.v[0] * v.v[0], this.v[1] * v.v[1]);\r\n\t},\r\n\r\n\tdiv : function(v) {\r\n\t\treturn new SglVec2(this.v[0] / v.v[0], this.v[1] / v.v[1]);\r\n\t},\r\n\r\n\tget rcp() {\r\n\t\treturn new SglVec2(1.0 / this.v[0], 1.0 / this.v[1]);\r\n\t},\r\n\r\n\tdot : function(v) {\r\n\t\treturn (this.v[0] * v.v[0] + this.v[1] * v.v[1]);\r\n\t},\r\n\r\n\tcross : function(v) {\r\n\t\treturn (this.v[0]*v.v[1] - this.v[1]*v.v[0]);\r\n\t},\r\n\r\n\tmin : function(v) {\r\n\t\treturn new SglVec2(sglMin(this.v[0], v.v[0]), sglMin(this.v[1], v.v[1]));\r\n\t},\r\n\r\n\tmax : function(v) {\r\n\t\treturn new SglVec2(sglMax(this.v[0], v.v[0]), sglMax(this.v[1], v.v[1]));\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglVec3\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglVec3.\r\n * @class 3-dimensional vector.\r\n */\r\nfunction SglVec3() {\r\n\tthis.v = new Array(3);\r\n\tvar n = arguments.length;\r\n\tswitch (n) {\r\n\t\tcase 1:\r\n\t\t\tif (arguments[0] instanceof Array) {\r\n\t\t\t\tthis.setVec(arguments[0]);\r\n\t\t\t}\r\n\t\t\telse if (arguments[0] instanceof SglVec3) {\r\n\t\t\t\tthis.setVec(arguments[0].v);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthis.setScalar(arguments[0]);\r\n\t\t\t}\r\n\t\tbreak;\r\n\t\tcase 3:\r\n\t\t\tthis.setVec(arguments);\r\n\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tthis.setZero();\r\n\t\tbreak;\r\n\t}\r\n}\r\n\r\nSglVec3.prototype = {\r\n\tclone : function() {\r\n\t\treturn new SglVec3(this);\r\n\t},\r\n\r\n\tget copy() {\r\n\t\treturn this.clone();\r\n\t},\r\n\r\n\tget x( ) { return this.v[0]; },\r\n\tset x(n) { this.v[0] = n;    },\r\n\tget y( ) { return this.v[1]; },\r\n\tset y(n) { this.v[1] = n;    },\r\n\tget z( ) { return this.v[2]; },\r\n\tset z(n) { this.v[2] = n;    },\r\n\r\n\tset : function(x, y, z) {\r\n\t\tthis.v[0] = x;\r\n\t\tthis.v[1] = y;\r\n\t\tthis.v[2] = z;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsetVec : function(v) {\r\n\t\treturn this.set(v[0], v[1], v[2]);\r\n\t},\r\n\r\n\tsetScalar : function(s) {\r\n\t\treturn this.set(s, s, s);\r\n\t},\r\n\r\n\tsetZero : function() {\r\n\t\treturn this.setScalar(0.0);\r\n\t},\r\n\r\n\tsetOne : function() {\r\n\t\treturn this.setScalar(1.0);\r\n\t},\r\n\r\n\tat : function(i) {\r\n\t\treturn this.v[i];\r\n\t},\r\n\r\n\tget squaredLength() {\r\n\t\treturn this.dot(this);\r\n\t},\r\n\r\n\tget length() {\r\n\t\treturn sglSqrt(this.squaredLength);\r\n\t},\r\n\r\n\tnormalize : function() {\r\n\t\tvar f = this.length;\r\n\t\tif (f > 0.0) f = 1.0 / f;\r\n\t\tthis.v[0] *= f;\r\n\t\tthis.v[1] *= f;\r\n\t\tthis.v[2] *= f;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tget normalized() {\r\n\t\treturn this.clone().normalize();\r\n\t},\r\n\r\n\tget neg() {\r\n\t\treturn new SglVec3(-(this.v[0]), -(this.v[1]), -(this.v[2]));\r\n\t},\r\n\r\n\tget abs() {\r\n\t\treturn new SglVec3(sglAbs(this.v[0]), sglAbs(this.v[1]), sglAbs(this.v[2]));\r\n\t},\r\n\r\n\tget minComp() {\r\n\t\tvar m = this.v[0];\r\n\t\tif (m > this.v[1]) m = this.v[1];\r\n\t\tif (m > this.v[2]) m = this.v[2];\r\n\t\treturn m;\r\n\t},\r\n\r\n\tget maxComp() {\r\n\t\tvar m = this.v[0];\r\n\t\tif (m < this.v[1]) m = this.v[1];\r\n\t\tif (m < this.v[2]) m = this.v[2];\r\n\t\treturn m;\r\n\t},\r\n\r\n\tget argMin() {\r\n\t\tvar a = 0;\r\n\t\tif (this.v[a] > this.v[1]) a = 1;\r\n\t\tif (this.v[a] > this.v[2]) a = 2;\r\n\t\treturn a;\r\n\t},\r\n\r\n\tget argMax() {\r\n\t\tvar a = 0;\r\n\t\tif (this.v[a] > this.v[1]) a = 1;\r\n\t\tif (this.v[a] > this.v[2]) a = 2;\r\n\t\treturn a;\r\n\t},\r\n\r\n\tadd : function(v) {\r\n\t\treturn new SglVec3(this.v[0] + v.v[0], this.v[1] + v.v[1], this.v[2] + v.v[2]);\r\n\t},\r\n\r\n\tsub : function(v) {\r\n\t\treturn new SglVec3(this.v[0] - v.v[0], this.v[1] - v.v[1], this.v[2] - v.v[2]);\r\n\t},\r\n\r\n\tmul : function(v) {\r\n\t\treturn new SglVec3(this.v[0] * v.v[0], this.v[1] * v.v[1], this.v[2] * v.v[2]);\r\n\t},\r\n\r\n\tdiv : function(v) {\r\n\t\treturn new SglVec3(this.v[0] / v.v[0], this.v[1] / v.v[1], this.v[2] / v.v[2]);\r\n\t},\r\n\r\n\tget rcp() {\r\n\t\treturn new SglVec3(1.0 / this.v[0], 1.0 / this.v[1], 1.0 / this.v[2]);\r\n\t},\r\n\r\n\tdot : function(v) {\r\n\t\treturn (this.v[0] * v.v[0] + this.v[1] * v.v[1] + this.v[2] * v.v[2]);\r\n\t},\r\n\r\n\tcross : function(v) {\r\n\t\treturn new SglVec3(this.v[1]*v.v[2] - this.v[2]*v.v[1], this.v[2]*v.v[0] - this.v[0]*v.v[2], this.v[0]*v.v[1] - this.v[1]*v.v[0]);\r\n\t},\r\n\r\n\tmin : function(v) {\r\n\t\treturn new SglVec3(sglMin(this.v[0], v.v[0]), sglMin(this.v[1], v.v[1]), sglMin(this.v[2], v.v[2]));\r\n\t},\r\n\r\n\tmax : function(v) {\r\n\t\treturn new SglVec3(sglMax(this.v[0], v.v[0]), sglMax(this.v[1], v.v[1]), sglMax(this.v[2], v.v[2]));\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglVec4\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglVec3.\r\n * @class 4-dimensional vector.\r\n */\r\nfunction SglVec4() {\r\n\tthis.v = new Array(4);\r\n\tvar n = arguments.length;\r\n\tswitch (n) {\r\n\t\tcase 1:\r\n\t\t\tif (arguments[0] instanceof Array) {\r\n\t\t\t\tthis.setVec(arguments[0]);\r\n\t\t\t}\r\n\t\t\telse if (arguments[0] instanceof SglVec4) {\r\n\t\t\t\tthis.setVec(arguments[0].v);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthis.setScalar(arguments[0]);\r\n\t\t\t}\r\n\t\tbreak;\r\n\t\tcase 4:\r\n\t\t\tthis.setVec(arguments);\r\n\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tthis.setZero();\r\n\t\tbreak;\r\n\t}\r\n}\r\n\r\nSglVec4.prototype = {\r\n\tclone : function() {\r\n\t\treturn new SglVec4(this);\r\n\t},\r\n\r\n\tget copy() {\r\n\t\treturn this.clone();\r\n\t},\r\n\r\n\tget x( ) { return this.v[0]; },\r\n\tset x(n) { this.v[0] = n;    },\r\n\tget y( ) { return this.v[1]; },\r\n\tset y(n) { this.v[1] = n;    },\r\n\tget z( ) { return this.v[2]; },\r\n\tset z(n) { this.v[2] = n;    },\r\n\tget w( ) { return this.v[3]; },\r\n\tset w(n) { this.v[3] = n;    },\r\n\r\n\tset : function(x, y, z, w) {\r\n\t\tthis.v[0] = x;\r\n\t\tthis.v[1] = y;\r\n\t\tthis.v[2] = z;\r\n\t\tthis.v[3] = w;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tsetVec : function(v) {\r\n\t\treturn this.set(v[0], v[1], v[2], v[3]);\r\n\t},\r\n\r\n\tsetScalar : function(s) {\r\n\t\treturn this.set(s, s, s, s);\r\n\t},\r\n\r\n\tsetZero : function() {\r\n\t\treturn this.setScalar(0.0);\r\n\t},\r\n\r\n\tsetOne : function() {\r\n\t\treturn this.setScalar(1.0);\r\n\t},\r\n\r\n\tat : function(i) {\r\n\t\treturn this.v[i];\r\n\t},\r\n\r\n\tget squaredLength() {\r\n\t\treturn this.dot(this);\r\n\t},\r\n\r\n\tget length() {\r\n\t\treturn sglSqrt(this.squaredLength);\r\n\t},\r\n\r\n\tnormalize : function() {\r\n\t\tvar f = this.length;\r\n\t\tif (f > 0.0) f = 1.0 / f;\r\n\t\tthis.v[0] *= f;\r\n\t\tthis.v[1] *= f;\r\n\t\tthis.v[2] *= f;\r\n\t\tthis.v[3] *= f;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tget normalized() {\r\n\t\treturn this.clone().normalize();\r\n\t},\r\n\r\n\tget neg() {\r\n\t\treturn new SglVec4(-(this.v[0]), -(this.v[1]), -(this.v[2]), -(this.v[3]));\r\n\t},\r\n\r\n\tget abs() {\r\n\t\treturn new SglVec4(sglAbs(this.v[0]), sglAbs(this.v[1]), sglAbs(this.v[2]), sglAbs(this.v[3]));\r\n\t},\r\n\r\n\tget minComp() {\r\n\t\tvar m = this.v[0];\r\n\t\tif (m > this.v[1]) m = this.v[1];\r\n\t\tif (m > this.v[2]) m = this.v[2];\r\n\t\tif (m > this.v[3]) m = this.v[3];\r\n\t\treturn m;\r\n\t},\r\n\r\n\tget maxComp() {\r\n\t\tvar m = this.v[0];\r\n\t\tif (m < this.v[1]) m = this.v[1];\r\n\t\tif (m < this.v[2]) m = this.v[2];\r\n\t\tif (m < this.v[3]) m = this.v[3];\r\n\t\treturn m;\r\n\t},\r\n\r\n\tget argMin() {\r\n\t\tvar a = 0;\r\n\t\tif (this.v[a] > this.v[1]) a = 1;\r\n\t\tif (this.v[a] > this.v[2]) a = 2;\r\n\t\tif (this.v[a] > this.v[3]) a = 2;\r\n\t\treturn a;\r\n\t},\r\n\r\n\tget argMax() {\r\n\t\tvar a = 0;\r\n\t\tif (this.v[a] > this.v[1]) a = 1;\r\n\t\tif (this.v[a] > this.v[2]) a = 2;\r\n\t\tif (this.v[a] > this.v[3]) a = 2;\r\n\t\treturn a;\r\n\t},\r\n\r\n\tadd : function(v) {\r\n\t\treturn new SglVec4(this.v[0] + v.v[0], this.v[1] + v.v[1], this.v[2] + v.v[2], this.v[3] + v.v[3]);\r\n\t},\r\n\r\n\tsub : function(v) {\r\n\t\treturn new SglVec4(this.v[0] - v.v[0], this.v[1] - v.v[1], this.v[2] - v.v[2], this.v[3] - v.v[3]);\r\n\t},\r\n\r\n\tmul : function(v) {\r\n\t\treturn new SglVec4(this.v[0] * v.v[0], this.v[1] * v.v[1], this.v[2] * v.v[2], this.v[3] * v.v[3]);\r\n\t},\r\n\r\n\tdiv : function(v) {\r\n\t\treturn new SglVec4(this.v[0] / v.v[0], this.v[1] / v.v[1], this.v[2] / v.v[2], this.v[3] / v.v[3]);\r\n\t},\r\n\r\n\tget rcp() {\r\n\t\treturn new SglVec4(1.0 / this.v[0], 1.0 / this.v[1], 1.0 / this.v[2], 1.0 / this.v[3]);\r\n\t},\r\n\r\n\tdot : function(v) {\r\n\t\treturn (this.v[0] * v.v[0] + this.v[1] * v.v[1] + this.v[2] * v.v[2] + this.v[3] * v.v[3]);\r\n\t},\r\n\r\n\t/*\r\n\tcross : function(u, v, w) {\r\n\t\treturn null;\r\n\t},\r\n\t*/\r\n\r\n\tmin : function(v) {\r\n\t\treturn new SglVec4(sglMin(this.v[0], v.v[0]), sglMin(this.v[1], v.v[1]), sglMin(this.v[2], v.v[2]), sglMin(this.v[3], v.v[3]));\r\n\t},\r\n\r\n\tmax : function(v) {\r\n\t\treturn new SglVec4(sglMax(this.v[0], v.v[0]), sglMax(this.v[1], v.v[1]), sglMax(this.v[2], v.v[2]), sglMax(this.v[3], v.v[3]));\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// SglPlane3\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglPlane3.\r\n * @class Represents a plane in space.\r\n */\r\nfunction SglPlane3(normal, offset, normalize) {\r\n\tthis._normal = [ 0.0, 0.0, 1.0 ];\r\n\tthis._offset = 0.0;\r\n\r\n\tif (normal && offset) {\r\n\t\tthis.setup(normal, offset, normalize);\r\n\t}\r\n}\r\n\r\nSglPlane3.prototype = {\r\n\tget normal()  { return this._normal;          },\r\n\tset normal(n) { this._normal = n.slice(0, 3); },\r\n\r\n\tget offset()  { return this._offset;          },\r\n\tset offset(o) { this._offset = o.slize(0, 3); },\r\n\r\n\tclone : function() {\r\n\t\treturn new SglPlane3(this._normal, this._offset, false);\r\n\t},\r\n\r\n\tget copy() {\r\n\t\treturn this.clone();\r\n\t},\r\n\r\n\tsetup : function(normal, offset, nomalize) {\r\n\t\tthis._normal[0] = normal[0];\r\n\t\tthis._normal[1] = normal[1];\r\n\t\tthis._normal[2] = normal[2];\r\n\t\tthis._offset    = offset;\r\n\r\n\t\tif (normalize) {\r\n\t\t\tvar s = sglSqrt(sglDotV3(this._normal));\r\n\r\n\t\t\tif (s > 0.0) {\r\n\t\t\t\ts = 1.0 / s;\r\n\t\t\t\tsglSelfMulV3S(this._normal, s);\r\n\t\t\t\tthis._offset    *= s;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglBox3\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglBox3.\r\n * @class Represents an axis-aligned box in space.\r\n */\r\nfunction SglBox3(min, max) {\r\n\tthis._min = [  1.0,  1.0,  1.0 ];\r\n\tthis._max = [ -1.0, -1.0, -1.0 ];\r\n\r\n\tif (min && max) {\r\n\t\tthis.setup(min, max);\r\n\t}\r\n}\r\n\r\nSglBox3.prototype = {\r\n\tget min()  { return this._min;          },\r\n\tset min(m) { this._min = m.slice(0, 3); },\r\n\r\n\tget max()  { return this._max;          },\r\n\tset max(m) { this._max = m.slice(0, 3); },\r\n\r\n\tclone : function() {\r\n\t\treturn new SglBox3(this._min, this._max);\r\n\t},\r\n\r\n\tget copy() {\r\n\t\treturn this.clone();\r\n\t},\r\n\r\n\tsetup : function(min, max) {\r\n\t\tfor (var i=0; i<3; ++i) {\r\n\t\t\tthis._min[i] = min[i];\r\n\t\t\tthis._max[i] = max[i];\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tget isNull() {\r\n\t\treturn (this._min[0] > this._max[0]);\r\n\t},\r\n\r\n\tget isEmpty() {\r\n\t\treturn (\r\n\t\t\t   (this._min[0] == this._max[0])\r\n\t\t\t&& (this._min[1] == this._max[1])\r\n\t\t\t&& (this._min[2] == this._max[2])\r\n\t\t);\r\n\t},\r\n\r\n\tget center() {\r\n\t\treturn sglSelfMulV3S(sglAddV3(this._min, this._max), 0.5);\r\n\t},\r\n\r\n\tget size() {\r\n\t\treturn sglSubV3(this._max, this._min);\r\n\t},\r\n\r\n\tget squaredDiagonal() {\r\n\t\tvar s = this.size;\r\n\t\treturn sglDotV3(s, s);\r\n\t},\r\n\r\n\tget diagonal() {\r\n\t\treturn sglSqrt(this.squaredDiagonal);\r\n\t},\r\n\r\n\tget facesAreas() {\r\n\t\tvar s = this.size;\r\n\t\treturn [\r\n\t\t\t(s[1] * s[2]),\r\n\t\t\t(s[0] * s[2]),\r\n\t\t\t(s[0] * s[1])\r\n\t\t];\r\n\t},\r\n\r\n\tget surfaceArea() {\r\n\t\tvar a = this.facesArea;\r\n\t\treturn ((a[0] + a[1] + a[2]) * 2.0);\r\n\t},\r\n\r\n\tget volume() {\r\n\t\tvar s = this.size;\r\n\t\treturn (s[0] * s[1] * s[2]);\r\n\t},\r\n\r\n\toffset : function(halfDelta) {\r\n\t\tsglSelfSubV3S(this._min[i], halfDelta);\r\n\t\tsglSelfAddV3S(this._max[i], halfDelta);\r\n\t\treturn this;\r\n\t},\r\n\r\n\tcorner : function(index) {\r\n\t\tvar s = this.size;\r\n\t\treturn [\r\n\t\t\tthis._min[0] + (((index % 2)       != (0.0)) ? (1.0) : (0.0)) * s[0],\r\n\t\t\tthis._min[1] + ((((index / 2) % 2) != (0.0)) ? (1.0) : (0.0)) * s[1],\r\n\t\t\tthis._min[2] + (((index > 3)       != (0.0)) ? (1.0) : (0.0)) * s[2]\r\n\t\t];\r\n\t},\r\n\r\n\ttransformed : function(matrix) {\r\n\t\tvar b = new SglBox3();\r\n\t\tvar p = sglMulM4V3(matrix, this.corner(0), 1.0);\r\n\t\tb.min = p;\r\n\t\tb.max = p;\r\n\t\tfor (var i=1; i<8; ++i) {\r\n\t\t\tp = sglMulM4V3(matrix, this.corner(i), 1.0);\r\n\t\t\tb.min = sglMinV3(b.min, p);\r\n\t\t\tb.max = sglMaxV3(b.max, p);\r\n\t\t}\r\n\t\treturn b;\r\n\t},\r\n\r\n\taddPoint : function(p) {\r\n\t\tif (this.isNull) {\r\n\t\t\tthis.min = p;\r\n\t\t\tthis.max = p;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis.min = sglMinV3(this.min, p);\r\n\t\t\tthis.max = sglMaxV3(this.min, p);\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\taddBox : function(b) {\r\n\t\tif (!b.isNull) {\r\n\t\t\tif (this.isNull) {\r\n\t\t\t\tthis.min = b.min;\r\n\t\t\t\tthis.max = b.max;\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tthis.min = sglMinV3(this.min, b.min);\r\n\t\t\t\tthis.max = sglMaxV3(this.max, b.max);\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn this;\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglSphere3\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglSphere3.\r\n * @class Represents a sphere in space.\r\n */\r\nfunction SglSphere3(center, radius) {\r\n\tthis._center = [ 0.0, 0.0, 0.0 ];\r\n\tthis._radius = -1.0;\r\n\r\n\tif (center && radius) {\r\n\t\tthis.setup(center, radius);\r\n\t}\r\n}\r\n\r\nSglSphere3.prototype = {\r\n\tget center()  { return this._center;          },\r\n\tset center(c) { this._center = c.slice(0, 3); },\r\n\r\n\tget radius()  { return this._redius;          },\r\n\tset radius(r) { this._radius = r;             },\r\n\r\n\tclone : function() {\r\n\t\treturn new SglSphere3(this._center, this._radius);\r\n\t},\r\n\r\n\tget copy() {\r\n\t\treturn this.clone();\r\n\t},\r\n\r\n\tsetup : function(center, radius) {\r\n\t\tthis._center[0] = center[0];\r\n\t\tthis._center[1] = center[1];\r\n\t\tthis._center[2] = center[2];\r\n\t\tthis._radius    = radius;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tget isNull() {\r\n\t\treturn (this._radius < 0.0);\r\n\t},\r\n\r\n\tget isEmpty() {\r\n\t\treturn (this._radius == 0.0);\r\n\t},\r\n\r\n\tget surfaceArea() {\r\n\t\treturn (4.0 * SGL_PI * this._radius * this._radius);\r\n\t},\r\n\r\n\tget volume() {\r\n\t\treturn ((4.0 / 3.0) * SGL_PI * this._radius * this._radius * this._radius);\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// SglMatrixStack\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglMatrixStack.\r\n * @class Represents a stack of 4x4 matrices.\r\n */\r\nfunction SglMatrixStack() {\r\n\tthis._s = [ ];\r\n\tthis._s.push(sglIdentityM4());\r\n\tthis._n = 0;\r\n}\r\n\r\nSglMatrixStack.prototype = {\r\n\tclone : function() {\r\n\t\tvar ss = new SglMatrixStack();\r\n\t\tss.s = [ ];\r\n\t\tfor (var i=0; i<(this._n+1); ++i) {\r\n\t\t\tss._s.push(sglDupM4(this._s[i]));\r\n\t\t}\r\n\t\treturn ss;\r\n\t},\r\n\r\n\tget copy() {\r\n\t\treturn this.clone();\r\n\t},\r\n\r\n\treset : function() {\r\n\t\tthis._s = [ ];\r\n\t\tthis._s.push(sglIdentityM4());\r\n\t\tthis._n = 0;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tget size() {\r\n\t\treturn (this._n + 1);\r\n\t},\r\n\r\n\tget top() {\r\n\t\treturn sglDupM4(this._s[this._n]);\r\n\t},\r\n\r\n\tget topRef() {\r\n\t\treturn this._s[this._n];\r\n\t},\r\n\r\n\tpush : function() {\r\n\t\tthis._s.push(sglDupM4(this._s[this._n]));\r\n\t\tthis._n++;\r\n\t\treturn this;\r\n\t},\r\n\r\n\tpop : function() {\r\n\t\tif (this._n > 0) {\r\n\t\t\tthis._s.pop();\r\n\t\t\tthis._n--;\r\n\t\t}\r\n\t\treturn this;\r\n\t},\r\n\r\n\tload : function(m) {\r\n\t\tthis._s[this._n] = sglDupM4(m);\r\n\t\treturn this;\r\n\t},\r\n\r\n\tmultiply : function(m) {\r\n\t\tthis._s[this._n] = sglMulM4(this._s[this._n], m);\r\n\t\treturn this;\r\n\t},\r\n\r\n\tloadIdentity : function() {\r\n\t\tthis._s[this._n] = sglIdentityM4();\r\n\t\treturn this;\r\n\t},\r\n\r\n\ttranslate : function(x, y, z) {\r\n\t\treturn this.multiply(sglTranslationM4C(x, y, z));\r\n\t},\r\n\r\n\trotate : function(angleRad, x, y, z) {\r\n\t\treturn this.multiply(sglRotationAngleAxisM4C(angleRad, x, y, z));\r\n\t},\r\n\r\n\tscale : function(x, y, z) {\r\n\t\treturn this.multiply(sglScalingM4C(x, y, z));\r\n\t},\r\n\r\n\tlookAt : function(positionX, positionY, positionZ, targetX, targetY, targetZ, upX, upY, upZ) {\r\n\t\treturn this.multiply(sglLookAtM4C(positionX, positionY, positionZ, targetX, targetY, targetZ, upX, upY, upZ));\r\n\t},\r\n\r\n\tortho : function(left, right, bottom, top, zNear, zFar) {\r\n\t\treturn this.multiply(sglOrthoM4C(left, right, bottom, top, zNear, zFar));\r\n\t},\r\n\r\n\tfrustum : function(left, right, bottom, top, zNear, zFar) {\r\n\t\treturn this.multiply(sglFrustumM4C(left, right, bottom, top, zNear, zFar));\r\n\t},\r\n\r\n\tperspective : function(fovYRad, aspectRatio, zNear, zFar) {\r\n\t\treturn this.multiply(sglPerspectiveM4(fovYRad, aspectRatio, zNear, zFar));\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglTransformStack\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglTransformStack.\r\n * @class Holds model, view and projection matrix stacks.\r\n */\r\nfunction SglTransformStack() {\r\n\tthis._ms = new SglMatrixStack();\r\n\tthis._vs = new SglMatrixStack();\r\n\tthis._ps = new SglMatrixStack();\r\n}\r\n\r\nSglTransformStack.prototype = {\r\n\tclone : function() {\r\n\t\tvar xs = new SglTransformStack();\r\n\t\txs._ms = this._ms.clone();\r\n\t\txs._vs = this._vs.clone();\r\n\t\txs._ps = this._ps.clone();\r\n\t\treturn xs;\r\n\t},\r\n\r\n\tget copy() {\r\n\t\treturn this.clone();\r\n\t},\r\n\r\n\treset : function() {\r\n\t\tthis._ms.reset();\r\n\t\tthis._vs.reset();\r\n\t\tthis._ps.reset();\r\n\t\treturn this;\r\n\t},\r\n\r\n\tget model() {\r\n\t\treturn this._ms;\r\n\t},\r\n\r\n\tget view() {\r\n\t\treturn this._vs;\r\n\t},\r\n\r\n\tget projection() {\r\n\t\treturn this._ps;\r\n\t},\r\n\r\n\tget modelMatrix() {\r\n\t\treturn this.model.top;\r\n\t},\r\n\r\n\tget modelMatrixRef() {\r\n\t\treturn this.model.topRef;\r\n\t},\r\n\r\n\tget modelMatrixTranspose() {\r\n\t\treturn sglTransposeM4(this.modelMatrixRef);\r\n\t},\r\n\r\n\tget modelMatrixInverse() {\r\n\t\treturn sglInverseM4(this.modelMatrixRef);\r\n\t},\r\n\r\n\tget modelMatrixInverseTranspose() {\r\n\t\treturn sglTransposeM4(this.modelMatrixInverse);\r\n\t},\r\n\r\n\tget viewMatrix() {\r\n\t\treturn this.view.top;\r\n\t},\r\n\r\n\tget viewMatrixRef() {\r\n\t\treturn this.view.topRef;\r\n\t},\r\n\r\n\tget viewMatrixTranspose() {\r\n\t\treturn sglTransposeM4(this.viewMatrixRef);\r\n\t},\r\n\r\n\tget viewMatrixInverse() {\r\n\t\treturn sglInverseM4(this.viewMatrixRef);\r\n\t},\r\n\r\n\tget viewMatrixInverseTranspose() {\r\n\t\treturn sglTransposeM4(this.viewMatrixInverse);\r\n\t},\r\n\r\n\tget projectionMatrix() {\r\n\t\treturn this.projection.top;\r\n\t},\r\n\r\n\tget projectionMatrixRef() {\r\n\t\treturn this.projection.topRef;\r\n\t},\r\n\r\n\tget projectionMatrixTranspose() {\r\n\t\treturn sglTransposeM4(this.projectionMatrixRef);\r\n\t},\r\n\r\n\tget projectionMatrixInverse() {\r\n\t\treturn sglInverseM4(this.projectionMatrixRef);\r\n\t},\r\n\r\n\tget projectionMatrixInverseTranspose() {\r\n\t\treturn sglTransposeM4(this.projectionMatrixInverse);\r\n\t},\r\n\r\n\tget modelViewMatrix() {\r\n\t\treturn sglMulM4(this.viewMatrixRef, this.modelMatrixRef);\r\n\t},\r\n\r\n\tget modelViewMatrixTranspose() {\r\n\t\treturn sglTransposeM4(this.modelViewMatrix);\r\n\t},\r\n\r\n\tget modelViewMatrixInverse() {\r\n\t\treturn sglInverseM4(this.modelViewMatrix);\r\n\t},\r\n\r\n\tget modelViewMatrixInverseTranspose() {\r\n\t\treturn sglTransposeM4(this.modelViewMatrixInverse);\r\n\t},\r\n\r\n\tget viewProjectionMatrix() {\r\n\t\treturn sglMulM4(this.projectionMatrixRef, this.viewMatrixRef);\r\n\t},\r\n\r\n\tget viewProjectionMatrixTranspose() {\r\n\t\treturn sglTransposeM4(this.viewProjectionMatrix);\r\n\t},\r\n\r\n\tget viewProjectionMatrixInverse() {\r\n\t\treturn sglInverseM4(this.viewProjectionMatrix);\r\n\t},\r\n\r\n\tget viewProjectionMatrixInverseTranspose() {\r\n\t\treturn sglTransposeM4(this.viewProjectionMatrixInverse);\r\n\t},\r\n\r\n\tget modelViewProjectionMatrix() {\r\n\t\treturn sglMulM4(this.projectionMatrixRef, sglMulM4(this.viewMatrixRef, this.modelMatrixRef));\r\n\t},\r\n\r\n\tget modelViewProjectionMatrixTranspose() {\r\n\t\treturn sglTransposeM4(this.modelViewProjectionMatrix);\r\n\t},\r\n\r\n\tget modelViewProjectionMatrixInverse() {\r\n\t\treturn sglInverseM4(this.modelViewProjectionMatrix);\r\n\t},\r\n\r\n\tget modelViewProjectionMatrixInverseTranspose() {\r\n\t\treturn sglTransposeM4(this.modelViewProjectionMatrixInverse);\r\n\t},\r\n\r\n\tget worldSpaceNormalMatrix() {\r\n\t\treturn sglM4toM3(this.modelMatrixInverseTranspose);\r\n\t},\r\n\r\n\tget viewSpaceNormalMatrix() {\r\n\t\treturn sglM4toM3(this.modelViewMatrixInverseTranspose);\r\n\t},\r\n\r\n\tget modelSpaceViewerPosition() {\r\n\t\treturn sglV4toV3(sglGetColM4(this.modelViewMatrixInverse, 3));\r\n\t},\r\n\r\n\tget modelSpaceViewDirection() {\r\n\t\treturn sglNegV3(sglV4toV3(sglGetRowM4(this.modelViewMatrix, 2)));\r\n\t},\r\n\r\n\tget worldSpaceViewerPosition() {\r\n\t\treturn sglV4toV3(sglGetColM4(this.viewMatrixInverse, 3));\r\n\t},\r\n\r\n\tget worldSpaceViewDirection() {\r\n\t\treturn ssglNegV3(sglV4toV3(sglGetRowM4(this.viewMatrixRef, 2)));\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// _SglFrustumPlane\r\n/**********************************************************/\r\nfunction _SglFrustumPlane() {\r\n\tthis.normal     = [ 0.0, 0.0, 1.0 ];\r\n\tthis.offset     = 0.0;\r\n\tthis.testVertex = [ 0, 0, 0 ];\r\n}\r\n\r\n_SglFrustumPlane.prototype = {\r\n\tsetup : function(nx, ny, nz, off) {\r\n\t\tvar s = 1.0 / sglSqrt(nx*nx + ny*ny + nz*nz);\r\n\r\n\t\tthis.normal[0] = nx * s;\r\n\t\tthis.normal[1] = ny * s;\r\n\t\tthis.normal[2] = nz * s;\r\n\r\n\t\tthis.offset = off * s;\r\n\r\n\t\tthis.testVertex[0] = (this.normal[0] >= 0.0) ? (1) : (0);\r\n\t\tthis.testVertex[1] = (this.normal[1] >= 0.0) ? (1) : (0);\r\n\t\tthis.testVertex[2] = (this.normal[2] >= 0.0) ? (1) : (0);\r\n\t}\r\n};\r\n/**********************************************************/\r\n\r\n\r\n// SglFrustum\r\n/**********************************************************/\r\nvar SGL_OUTSIDE_FRUSTUM   = 0;\r\nvar SGL_INTERSECT_FRUSTUM = 1;\r\nvar SGL_INSIDE_FRUSTUM    = 2;\r\n\r\n/**\r\n * Constructs a SglFrustum.\r\n * @class Holds frustum information for operations such as visibility culling.\r\n */\r\nfunction SglFrustum(projectionMatrix, modelViewMatrix, viewport) {\r\n\tthis._mvpMatrix       = sglIdentityM4();\r\n\tthis._viewport        = [ 0, 0, 1, 1 ];\r\n\tthis._vp              = [ 0, 0, 1, 1 ];\r\n\tthis._billboardMatrix = sglIdentityM4();\r\n\r\n\tthis._planes = new Array(6);\r\n\tfor (var i=0; i<6; ++i) {\r\n\t\tthis._planes[i] = new _SglFrustumPlane();\r\n\t}\r\n\r\n\tif (projectionMatrix && modelViewMatrix && viewport) {\r\n\t\tthis.setup(projectionMatrix, modelViewMatrix, viewport);\r\n\t}\r\n}\r\n\r\nSglFrustum.prototype = {\r\n\tsetup : function (projectionMatrix, modelViewMatrix, viewport) {\r\n\t\tvar rot = [\r\n\t\t\tsglGetColM4(modelViewMatrix, 0),\r\n\t\t\tsglGetColM4(modelViewMatrix, 1),\r\n\t\t\tsglGetColM4(modelViewMatrix, 2)\r\n\t\t];\r\n\r\n\t\tvar sc = [\r\n\t\t\tsglLengthV4(rot[0]),\r\n\t\t\tsglLengthV4(rot[1]),\r\n\t\t\tsglLengthV4(rot[2])\r\n\t\t];\r\n\r\n\t\tvar scRcp = sglRcpV3(sc);\r\n\r\n\t\tvar sMat    = sglScalingM4V(sc);\r\n\t\tvar sMatInv = sglScalingM4V(scRcp);\r\n\r\n\t\trot[0] = sglMulV4S(rot[0], scRcp[0]);\r\n\t\trot[1] = sglMulV4S(rot[1], scRcp[1]);\r\n\t\trot[2] = sglMulV4S(rot[2], scRcp[2]);\r\n\r\n\t\tvar rMatInv = sglIdentityM4();\r\n\t\tsglSetRowM4V(rMatInv, 0, rot[0]);\r\n\t\tsglSetRowM4V(rMatInv, 1, rot[1]);\r\n\t\tsglSetRowM4V(rMatInv, 2, rot[2]);\r\n\r\n\t\tthis._mvpMatrix       = sglMulM4(projectionMatrix, modelViewMatrix);\r\n\t\tthis._billboardMatrix = sglMulM4(sMatInv, sglMulM4(rMatInv, sMat));\r\n\t\tthis._viewport        = viewport.slice(0, 4);\r\n\r\n\t\tthis._vp[0] = this._viewport[2] * 0.5;\r\n\t\tthis._vp[1] = this._viewport[0] + this._viewport[2] * 0.5;\r\n\t\tthis._vp[2] = this._viewport[3] * 0.5;\r\n\t\tthis._vp[3] = this._viewport[1] + this._viewport[3] * 0.5;\r\n\r\n\r\n\t\tvar m = this._mvpMatrix;\r\n\t\tvar q = [ m[3], m[7], m[11] ];\r\n\r\n\t\tthis._planes[0].setup(q[ 0] - m[ 0], q[ 1] - m[ 4], q[ 2] - m[ 8], m[15] - m[12]);\r\n\t\tthis._planes[1].setup(q[ 0] + m[ 0], q[ 1] + m[ 4], q[ 2] + m[ 8], m[15] + m[12]);\r\n\t\tthis._planes[2].setup(q[ 0] - m[ 1], q[ 1] - m[ 5], q[ 2] - m[ 9], m[15] - m[13]);\r\n\t\tthis._planes[3].setup(q[ 0] + m[ 1], q[ 1] + m[ 5], q[ 2] + m[ 9], m[15] + m[13]);\r\n\t\tthis._planes[4].setup(q[ 0] - m[ 2], q[ 1] - m[ 6], q[ 2] - m[10], m[15] - m[14]);\r\n\t\tthis._planes[5].setup(q[ 0] + m[ 2], q[ 1] + m[ 6], q[ 2] + m[10], m[15] + m[14]);\r\n\t},\r\n\r\n\tboxVisibility : function(boxMin, boxMax) {\r\n\t\tvar ret = SGL_INSIDE_FRUSTUM;\r\n\r\n\t\tvar bminmax = [ boxMin, boxMax ];\r\n\r\n\t\tvar fp = null;\r\n\t\tfor (var i=0; i<6; ++i) {\r\n\t\t\tfp = this._planes[i];\r\n\t\t\tif (\r\n\t\t\t\t((fp.normal[0] * bminmax[fp.testVertex[0]][0]) +\r\n\t\t\t\t (fp.normal[1] * bminmax[fp.testVertex[1]][1]) +\r\n\t\t\t\t (fp.normal[2] * bminmax[fp.testVertex[2]][2]) +\r\n\t\t\t\t (fp.offset)) < 0.0\r\n\t\t\t) {\r\n\t\t\t\treturn SGL_OUTSIDE_FRUSTUM;\r\n\t\t\t}\r\n\r\n\t\t\tif (\r\n\t\t\t\t((fp.normal[0] * bminmax[1 - fp.testVertex[0]][0]) +\r\n\t\t\t\t (fp.normal[1] * bminmax[1 - fp.testVertex[1]][1]) +\r\n\t\t\t\t (fp.normal[2] * bminmax[1 - fp.testVertex[2]][2]) +\r\n\t\t\t\t (fp.offset)) < 0.0\r\n\t\t\t) {\r\n\t\t\t\tret = SGL_INTERSECT_FRUSTUM;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn ret;\r\n\t},\r\n\r\n\tprojectedSegmentSize : function(center, size) {\r\n\t\tvar hs = size * 0.5;\r\n\r\n\t\tvar p0 = sglV3toV4(center, 0.0);\r\n\t\tvar p1 = [ -hs, 0.0, 0.0, 1.0 ];\r\n\t\tvar p2 = [  hs, 0.0, 0.0, 1.0 ];\r\n\r\n\t\tp1 = sglMulM4V4(this._billboardMatrix, p1);\r\n\t\tp1 = sglAddV4(p1, p0);\r\n\t\tp1 = sglProjectV4(sglMulM4V4(this._mvpMatrix, p1));\r\n\r\n\t\tp2 = sglMulM4V4(this._billboardMatrix, p2);\r\n\t\tp2 = sglAddV4(p2, p0);\r\n\t\tp2 = sglProjectV4(sglMulM4V4(this._mvpMatrix, p2));\r\n\r\n\t\t/*\r\n\t\tp1[0] = this._vp[0] * p1[0] + this._vp[1];\r\n\t\tp2[0] = this._vp[0] * p2[0] + this._vp[1];\r\n\t\t//p1[1] = this.viewport[3] * 0.5 * p1[1] + this.viewport[1] + this.viewport[3] * 0.5;\r\n\r\n\t\tp2[0] = this.viewport[2] * 0.5 * p2[0] + this.viewport[0] + this.viewport[2] * 0.5;\r\n\t\t//p2[1] = this.viewport[3] * 0.5 * p2[1] + this.viewport[1] + this.viewport[3] * 0.5;\r\n\r\n\t\tvar size = aglAbs(p2[0] - p1[0]);\r\n\t\t*/\r\n\r\n\t\tvar sz = this._vp[0] * sglAbs(p2[0] - p1[0]);\r\n\r\n\t\treturn sz;\r\n\t}\r\n};\r\n\r\nfunction sglBoxVisibility(modelViewProjectionMatrix, boxMin, boxMax) {\r\n\tvar fc = new SglFrustum(modelViewProjectionMatrix);\r\n\treturn fc.boxVisibility(boxMin, boxMax);\r\n}\r\n/**********************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// GL utilities\r\n/***********************************************************************/\r\nfunction _sglConsolidateOptions(fullOptions, usedOptions)\r\n{\r\n\tif (usedOptions) {\r\n\t\tfor (var attr in usedOptions) {\r\n\t\t\tfullOptions[attr] = usedOptions[attr];\r\n\t\t}\r\n\t}\r\n\treturn fullOptions;\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// SglBufferInfo\r\n/***********************************************************************/\r\nfunction sglGetBufferOptions(gl, options) {\r\n\tvar opt = {\r\n\t\tusage : gl.STATIC_DRAW\r\n\t};\r\n\treturn _sglConsolidateOptions(opt, options);\r\n}\r\n\r\n/**\r\n * Constructs a SglBufferInfo.\r\n * @class Holds information about a WebGL buffer object.\r\n */\r\nfunction SglBufferInfo() {\r\n\tthis.handle = null;\r\n\tthis.valid  = false;\r\n\tthis.target = 0;\r\n\tthis.size   = 0;\r\n\tthis.usage  = 0;\r\n}\r\n\r\nfunction sglBufferFromData(gl, target, values, options) {\r\n\tvar opt = sglGetBufferOptions(gl, options);\r\n\tvar buff = gl.createBuffer();\r\n\tgl.bindBuffer(target, buff);\r\n\tgl.bufferData(target, values, opt.usage);\r\n\tgl.bindBuffer(target, null);\r\n\r\n\tvar obj = new SglBufferInfo();\r\n\tobj.handle = buff;\r\n\tobj.valid  = true;\r\n\tobj.target = target;\r\n\tobj.size   = values.sizeInBytes;\r\n\tobj.usage  = opt.usage;\r\n\r\n\treturn obj;\r\n}\r\n\r\nfunction sglVertexBufferFromData(gl, values, usage) {\r\n\treturn sglBufferFromData(gl, gl.ARRAY_BUFFER, values, usage);\r\n}\r\n\r\nfunction sglIndexBufferFromData(gl, values, usage) {\r\n\treturn sglBufferFromData(gl, gl.ELEMENT_ARRAY_BUFFER, values, usage);\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// SglShaderInfo\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglShaderInfo.\r\n * @class Holds information about a WebGL shader object.\r\n */\r\nfunction SglShaderInfo() {\r\n\tthis.handle = null;\r\n\tthis.valid  = false;\r\n\tthis.type   = 0;\r\n\tthis.log    = \"\";\r\n}\r\n\r\nfunction sglShaderFromSource(gl, type, src) {\r\n\tvar log = \"\";\r\n\tlog += \"----------------------\\n\";\r\n\r\n\tvar shd  = gl.createShader(type);\r\n\tgl.shaderSource(shd, src);\r\n\tgl.compileShader(shd);\r\n\r\n\tlog += \"[SHADER LOG]\\n\";\r\n\tvar valid = true;\r\n\tif (gl.getShaderParameter(shd, gl.COMPILE_STATUS) != 0) {\r\n\t\tlog += \"SUCCESS:\\n\";\r\n\t}\r\n\telse {\r\n\t\tvalid = false;\r\n\t\tlog += \"FAIL:\\n\";\r\n\t}\r\n\tlog += gl.getShaderInfoLog(shd);\r\n\tlog += \"\\n\";\r\n\tlog += \"----------------------\\n\";\r\n\r\n\tvar obj = new SglShaderInfo();\r\n\tobj.handle = shd;\r\n\tobj.valid  = valid;\r\n\tobj.type   = type;\r\n\tobj.log    = log;\r\n\r\n\treturn obj;\r\n}\r\n\r\nfunction sglVertexShaderFromSource(gl, src) {\r\n\treturn sglShaderFromSource(gl, gl.VERTEX_SHADER, src);\r\n}\r\n\r\nfunction sglFragmentShaderFromSource(gl, src) {\r\n\treturn sglShaderFromSource(gl, gl.FRAGMENT_SHADER, src);\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// SglProgramAttributeInfo\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglProgramAttributeInfo.\r\n * @class Holds information about a WebGL program active attribute.\r\n */\r\nfunction SglProgramAttributeInfo() {\r\n\tthis.name       = \"\";\r\n\tthis.nativeType = 0;\r\n\t//this.scalarType = 0;\r\n\t//this.dimensions = 0;\r\n\tthis.size       = 0;\r\n\tthis.location   = -1;\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// SglProgramUniformInfo\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglProgramAttributeInfo.\r\n * @class Holds information about a WebGL program active uniform.\r\n */\r\nfunction SglProgramUniformInfo() {\r\n\tthis.name       = \"\";\r\n\tthis.nativeType = 0;\r\n\t//this.scalarType = 0;\r\n\t//this.dimensions = 0;\r\n\tthis.size       = 0;\r\n\tthis.location   = -1;\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// SglProgramSamplerInfo\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglProgramSamplerInfo.\r\n * @class Holds information about a WebGL program active sampler.\r\n */\r\nfunction SglProgramSamplerInfo() {\r\n\tthis.name       = \"\";\r\n\tthis.nativeType = 0;\r\n\t//this.scalarType = 0;\r\n\t//this.dimensions = 0;\r\n\tthis.size       = 0;\r\n\tthis.location   = -1;\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// SglProgramInfo\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglProgramInfo.\r\n * @class Holds information about a WebGL program object.\r\n */\r\nfunction SglProgramInfo() {\r\n\tthis.handle     = null;\r\n\tthis.valid      = false;\r\n\tthis.shaders    = [ ];\r\n\tthis.attributes = new Object();\r\n\tthis.uniforms   = new Object();\r\n\tthis.samplers   = new Object();\r\n\tthis.log        = \"\";\r\n}\r\n\r\nfunction sglProgramFromShaders(gl, shaders) {\r\n\tvar log = \"\";\r\n\tlog += \"----------------------\\n\";\r\n\r\n\tvar prg = gl.createProgram();\r\n\tfor (var s in shaders) {\r\n\t\tvar shd = shaders[s];\r\n\t\t//if (shd.valid) {\r\n\t\t\tgl.attachShader(prg, shd.handle);\r\n\t\t//}\r\n\t}\r\n\tgl.linkProgram(prg);\r\n\r\n\tvar valid = true;\r\n\tvalid = valid && (gl.getProgramParameter(prg, gl.LINK_STATUS)     != 0);\r\n\r\n\t// validation is needed when uniforms are set, so skip this.\r\n\t//gl.validateProgram(prg);\r\n\t//valid = valid && (gl.getProgramParameter(prg, gl.VALIDATE_STATUS) != 0);\r\n\r\n\tlog += \"[PROGRAM LOG]\\n\";\r\n\tif (valid) {\r\n\t\tlog += \"SUCCESS:\\n\";\r\n\t}\r\n\telse {\r\n\t\tlog += \"FAIL:\\n\";\r\n\t}\r\n\tlog += gl.getProgramInfoLog(prg);\r\n\tlog += \"\\n\";\r\n\tlog += \"----------------------\\n\";\r\n\r\n\tvar obj = new SglProgramInfo();\r\n\tobj.handle = prg;\r\n\tobj.valid  = valid;\r\n\tfor (var s in shaders) {\r\n\t\tvar shd = shaders[s]\r\n\t\t//if (shd.valid) {\r\n\t\t\tobj.shaders.push(shd);\r\n\t\t//}\r\n\t}\r\n\tobj.log = log;\r\n\r\n\tvar attribs_count = gl.getProgramParameter(prg, gl.ACTIVE_ATTRIBUTES);\r\n\tvar attr, loc, a;\r\n\tfor (var i=0; i<attribs_count; ++i) {\r\n\t\tattr = gl.getActiveAttrib(prg, i);\r\n\t\tif (!attr) continue;\r\n\t\ta    = new SglProgramAttributeInfo();\r\n\t\ta.name = attr.name;\r\n\t\ta.nativeType = attr.type;\r\n\t\ta.size = attr.size;\r\n\t\ta.location = gl.getAttribLocation(prg, attr.name);\r\n\t\tobj.attributes[a.name] = a;\r\n\t}\r\n\r\n\tvar uniforms_count = gl.getProgramParameter(prg, gl.ACTIVE_UNIFORMS);\r\n\tvar unif, loc, u;\r\n\tfor (var i=0; i<uniforms_count; ++i) {\r\n\t\tunif = gl.getActiveUniform(prg, i);\r\n\t\tif (!unif) continue;\r\n\t\tloc  = gl.getUniformLocation(prg, unif.name);\r\n\t\tif ((unif.type == gl.SAMPLER_2D) || (unif.type == gl.SAMPLER_CUBE) || (unif.type == 35682)) {\r\n\t\t\ts = new SglProgramSamplerInfo();\r\n\t\t\ts.name = unif.name;\r\n\t\t\ts.nativeType = unif.type;\r\n\t\t\ts.size = unif.size;\r\n\t\t\ts.location = loc;\r\n\t\t\tobj.samplers[s.name] = s;\r\n\t\t}\r\n\t\telse {\r\n\t\t\tu = new SglProgramUniformInfo();\r\n\t\t\tu.name = unif.name;\r\n\t\t\tu.nativeType = unif.type;\r\n\t\t\tu.size = unif.size;\r\n\t\t\tu.location = loc;\r\n\t\t\tobj.uniforms[u.name] = u;\r\n\t\t}\r\n\t}\r\n\r\n\tsglSetDefaultProgramBindings(gl, obj);\r\n\r\n\treturn obj;\r\n}\r\n\r\nfunction sglProgramFromSources(gl, vertexSources, fragmentSources) {\r\n\tvar shd = null;\r\n\tvar shaders = [ ];\r\n\tfor (var s in vertexSources) {\r\n\t\tvar src = vertexSources[s];\r\n\t\tshd = sglVertexShaderFromSource(gl, src);\r\n\t\tshaders.push(shd);\r\n\t}\r\n\tfor (var s in fragmentSources) {\r\n\t\tvar src = fragmentSources[s];\r\n\t\tshd = sglFragmentShaderFromSource(gl, src);\r\n\t\tshaders.push(shd);\r\n\t}\r\n\treturn sglProgramFromShaders(gl, shaders);\r\n}\r\n\r\nfunction sglSetDefaultProgramBindings(gl, programInfo) {\r\n\tvar prg = programInfo.handle;\r\n\r\n\t// ensure index is sequential in \"for (attr in programInfo.attributes)\" loops\r\n\tvar index = 0;\r\n\tfor (var v in programInfo.attributes) {\r\n\t\tvar vattr = programInfo.attributes[v];\r\n\t\tgl.bindAttribLocation(prg, index, vattr.name);\r\n\t\tvattr.location = index;\r\n\t\tindex++;\r\n\t}\r\n\t// must relink after attributes binding\r\n\tgl.linkProgram(prg);\r\n\r\n\t// uniform locations could change after program linking, so update them\r\n\tfor (var u in programInfo.uniforms) {\r\n\t\tvar unif = programInfo.uniforms[u];\r\n\t\tunif.location = gl.getUniformLocation(prg, unif.name);\r\n\t}\r\n\r\n\tgl.useProgram(programInfo.handle);\r\n\t// ensure texture unit is sequential in \"for (attr in programInfo.samplers)\" loops\r\n\tvar unit = 0;\r\n\tfor (var s in programInfo.samplers) {\r\n\t\tvar smp = programInfo.samplers[s];\r\n\t\tsmp.location = gl.getUniformLocation(prg, smp.name);\r\n\t\tgl.uniform1i(smp.location, unit);\r\n\t\tunit++;\r\n\t}\r\n\t//gl.useProgram(null);\r\n}\r\n\r\nfunction sglProgramSynchronize(gl, programInfo) {\r\n\tvar prg = programInfo.handle;\r\n\r\n\tfor (var v in programInfo.attributes) {\r\n\t\tvar vattr = programInfo.attributes[v];\r\n\t\tvattr.location = gl.getAttribLocation(prg, vattr.name);\r\n\t}\r\n\r\n\tfor (var u in programInfo.uniforms) {\r\n\t\tvar unif = programInfo.uniforms[u];\r\n\t\tunif.location = gl.getUniformLocation(prg, unif.name);\r\n\t}\r\n\r\n\tfor (var s in programInfo.samplers) {\r\n\t\tvar smp = programInfo.samplers[s];\r\n\t\tsmp.location = gl.getUniformLocation(prg, smp.name);\r\n\t}\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// SglTextureInfo\r\n/***********************************************************************/\r\nfunction sglGetTextureOptions(gl, options) {\r\n\tvar opt = {\r\n\t\tminFilter        : gl.LINEAR,\r\n\t\tmagFilter        : gl.LINEAR,\r\n\t\twrapS            : gl.CLAMP_TO_EDGE,\r\n\t\twrapT            : gl.CLAMP_TO_EDGE,\r\n\t\tisDepth          : false,\r\n\t\tdepthMode        : gl.LUMINANCE,\r\n\t\tdepthCompareMode : gl.COMPARE_R_TO_TEXTURE,\r\n\t\tdepthCompareFunc : gl.LEQUAL,\r\n\t\tgenerateMipmap   : false,\r\n\t\tflipY            : true,\r\n\t\tpremultiplyAlpha : false,\r\n\t\tonload           : null\r\n\t};\r\n\treturn _sglConsolidateOptions(opt, options);\r\n}\r\n\r\n/**\r\n * Constructs a SglTextureInfo.\r\n * @class Holds information about a WebGL texture object.\r\n */\r\nfunction SglTextureInfo() {\r\n\tthis.handle           = null;\r\n\tthis.valid            = false;\r\n\tthis.target           = 0;\r\n\tthis.format           = 0;\r\n\tthis.width            = 0;\r\n\tthis.height           = 0;\r\n\tthis.minFilter        = 0;\r\n\tthis.magFilter        = 0;\r\n\tthis.wrapS            = 0;\r\n\tthis.wrapT            = 0;\r\n\tthis.isDepth          = false;\r\n\tthis.depthMode        = 0;\r\n\tthis.depthCompareMode = 0;\r\n\tthis.depthCompareFunc = 0;\r\n}\r\n\r\nfunction sglTexture2DFromData(gl, internalFormat, width, height, sourceFormat, sourceType, texels, options) {\r\n\tvar opt = sglGetTextureOptions(gl, options);\r\n\r\n\t// Chrome does not like texels == null\r\n\tif (!texels) {\r\n\t\tif (sourceType == gl.FLOAT) {\r\n\t\t\ttexels = new Float32Array(width * height * 4);\r\n\t\t}\r\n\t\telse {\r\n\t\t\ttexels = new Uint8Array(width * height * 4);\r\n\t\t}\r\n\t}\r\n\r\n\tvar tex = gl.createTexture();\r\n\tgl.bindTexture(gl.TEXTURE_2D, tex);\r\n\r\n\tvar flipYEnabled  = gl.getParameter(gl.UNPACK_FLIP_Y_WEBGL);\r\n\tvar flipYRequired = (opt.flipY === true);\r\n\tif (flipYEnabled != flipYRequired) {\r\n\t\tgl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, ((flipYRequired) ? (1) : (0)));\r\n\t}\r\n\tgl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, width, height, 0, sourceFormat, sourceType, texels);\r\n\tif (flipYEnabled != flipYRequired) {\r\n\t\tgl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, ((flipYEnabled) ? (1) : (0)));\r\n\t}\r\n\r\n\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, opt.minFilter);\r\n\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, opt.magFilter);\r\n\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S,     opt.wrapS    );\r\n\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T,     opt.wrapT    );\r\n\tif (opt.isDepth) {\r\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.DEPTH_TEXTURE_MODE,   opt.depthMode);\r\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_COMPARE_MODE, opt.depthCompareMode);\r\n\t\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_COMPARE_FUNC, opt.depthCompareFunc);\r\n\t}\r\n\tif (opt.generateMipmap) {\r\n\t\tgl.generateMipmap(gl.TEXTURE_2D);\r\n\t}\r\n\tgl.bindTexture(gl.TEXTURE_2D, null);\r\n\r\n\tvar obj = new SglTextureInfo();\r\n\tobj.handle           = tex;\r\n\tobj.valid            = true;\r\n\tobj.target           = gl.TEXTURE_2D;\r\n\tobj.format           = internalFormat;\r\n\tobj.width            = width;\r\n\tobj.height           = height;\r\n\tobj.minFilter        = opt.minFilter;\r\n\tobj.magFilter        = opt.magFilter;\r\n\tobj.wrapS            = opt.wrapS;\r\n\tobj.wrapT            = opt.wrapT;\r\n\tobj.isDepth          = opt.isDepth;\r\n\tobj.depthMode        = opt.depthMode;\r\n\tobj.depthCompareMode = opt.depthCompareMode;\r\n\tobj.depthCompareFunc = opt.depthCompareFunc;\r\n\r\n\treturn obj;\r\n}\r\n\r\nfunction sglTexture2DFromImage(gl, image, options) {\r\n\tvar opt = sglGetTextureOptions(gl, options);\r\n\r\n\tvar tex = gl.createTexture();\r\n\tgl.bindTexture(gl.TEXTURE_2D, tex);\r\n\r\n\tvar flipYEnabled  = gl.getParameter(gl.UNPACK_FLIP_Y_WEBGL);\r\n\tvar flipYRequired = (opt.flipY === true);\r\n\tif (flipYEnabled != flipYRequired) {\r\n\t\tgl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, ((flipYRequired) ? (1) : (0)));\r\n\t}\r\n\tgl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, image);\r\n\tif (flipYEnabled != flipYRequired) {\r\n\t\tgl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, ((flipYEnabled) ? (1) : (0)));\r\n\t}\r\n\r\n\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, opt.minFilter);\r\n\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, opt.magFilter);\r\n\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S,     opt.wrapS    );\r\n\tgl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T,     opt.wrapT    );\r\n\tif (opt.generateMipmap) {\r\n\t\tgl.generateMipmap(gl.TEXTURE_2D);\r\n\t}\r\n\tgl.bindTexture(gl.TEXTURE_2D, null);\r\n\r\n\tvar obj = new SglTextureInfo();\r\n\tobj.handle           = tex;\r\n\tobj.valid            = true;\r\n\tobj.target           = gl.TEXTURE_2D;\r\n\tobj.format           = gl.RGBA;\r\n\tobj.width            = image.width;\r\n\tobj.height           = image.height;\r\n\tobj.minFilter        = opt.minFilter;\r\n\tobj.magFilter        = opt.magFilter;\r\n\tobj.wrapS            = opt.wrapS;\r\n\tobj.wrapT            = opt.wrapT;\r\n\tobj.isDepth          = false;\r\n\tobj.depthMode        = 0;\r\n\tobj.depthCompareMode = 0;\r\n\tobj.depthCompareFunc = 0;\r\n\r\n\treturn obj;\r\n}\r\n\r\nfunction sglTexture2DFromUrl(gl, url, options) {\r\n\tvar opt = sglGetTextureOptions(gl, options);\r\n\tvar obj = new SglTextureInfo();\r\n\r\n\tvar img = new Image();\r\n\timg.crossOrigin = '';\r\n\timg.onload = function() {\r\n\t\tvar texInfo = sglTexture2DFromImage(gl, img, opt);\r\n\t\tfor (var a in texInfo) {\r\n\t\t\tobj[a] = texInfo[a];\r\n\t\t}\r\n\t\tif (opt.onload) {\r\n\t\t\topt.onload(gl, obj, url);\r\n\t\t}\r\n\t};\r\n\timg.src = url;\r\n\r\n\treturn obj;\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n/***********************************************************************/\r\nfunction sglTextureCubeFromData(gl, internalFormat, width, height, sourceFormat, sourceType, facesTexels, options) {\r\n\tvar opt = sglGetTextureOptions(gl, options);\r\n\r\n\t// Chrome does not like texels == null\r\n\tif (!facesTexels) {\r\n\t\tvar tx = null;\r\n\t\tif (sourceType == gl.FLOAT) {\r\n\t\t\ttx = new Float32Array(width * height * 4);\r\n\t\t}\r\n\t\telse {\r\n\t\t\ttx = new Uint8Array(width * height * 4);\r\n\t\t}\r\n\t\tfacesTexels = new Array(6);\r\n\t\tfor (var i=0; i<6; ++i) {\r\n\t\t\tfacesTexels[i] = tx;\r\n\t\t}\r\n\t}\r\n\r\n\tvar tex = gl.createTexture();\r\n\tgl.bindTexture(gl.TEXTURE_CUBE_MAP, tex);\r\n\r\n\tvar flipYEnabled  = gl.getParameter(gl.UNPACK_FLIP_Y_WEBGL);\r\n\tvar flipYRequired = (opt.flipY === true);\r\n\tif (flipYEnabled != flipYRequired) {\r\n\t\tgl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, ((flipYRequired) ? (1) : (0)));\r\n\t}\r\n\tfor (var i=0; i<6; ++i) {\r\n\t\tgl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X + i, 0, internalFormat, width, height, 0, sourceFormat, sourceType, facesTexels[i]);\r\n\t}\r\n\tif (flipYEnabled != flipYRequired) {\r\n\t\tgl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, ((flipYEnabled) ? (1) : (0)));\r\n\t}\r\n\r\n\tgl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MIN_FILTER, opt.minFilter);\r\n\tgl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MAG_FILTER, opt.magFilter);\r\n\tgl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_S,     opt.wrapS    );\r\n\tgl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_T,     opt.wrapT    );\r\n\tif (opt.isDepth) {\r\n\t\tgl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.DEPTH_TEXTURE_MODE,   opt.depthMode);\r\n\t\tgl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_COMPARE_MODE, opt.depthCompareMode);\r\n\t\tgl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_COMPARE_FUNC, opt.depthCompareFunc);\r\n\t}\r\n\tif (opt.generateMipmap) {\r\n\t\tgl.generateMipmap(gl.TEXTURE_CUBE_MAP);\r\n\t}\r\n\tgl.bindTexture(gl.TEXTURE_CUBE_MAP, null);\r\n\r\n\tvar obj = new SglTextureInfo();\r\n\tobj.handle           = tex;\r\n\tobj.valid            = true;\r\n\tobj.target           = gl.TEXTURE_CUBE_MAP;\r\n\tobj.format           = internalFormat;\r\n\tobj.width            = width;\r\n\tobj.height           = height;\r\n\tobj.minFilter        = opt.minFilter;\r\n\tobj.magFilter        = opt.magFilter;\r\n\tobj.wrapS            = opt.wrapS;\r\n\tobj.wrapT            = opt.wrapT;\r\n\tobj.isDepth          = opt.isDepth;\r\n\tobj.depthMode        = opt.depthMode;\r\n\tobj.depthCompareMode = opt.depthCompareMode;\r\n\tobj.depthCompareFunc = opt.depthCompareFunc;\r\n\r\n\treturn obj;\r\n}\r\n\r\nfunction sglTextureCubeFromImages(gl, images, options) {\r\n\tvar opt = sglGetTextureOptions(gl, options);\r\n\r\n\tvar tex = gl.createTexture();\r\n\tgl.bindTexture(gl.TEXTURE_CUBE_MAP, tex);\r\n\r\n\tvar flipYEnabled  = gl.getParameter(gl.UNPACK_FLIP_Y_WEBGL);\r\n\tvar flipYRequired = (opt.flipY === true);\r\n\tif (flipYEnabled != flipYRequired) {\r\n\t\tgl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, ((flipYRequired) ? (1) : (0)));\r\n\t}\r\n\tfor (var i=0; i<6; ++i) {\r\n\t\tgl.texImage2D(gl.TEXTURE_CUBE_MAP_POSITIVE_X + i, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, images[i]);\r\n\t}\r\n\tif (flipYEnabled != flipYRequired) {\r\n\t\tgl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, ((flipYEnabled) ? (1) : (0)));\r\n\t}\r\n\tgl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MIN_FILTER, opt.minFilter);\r\n\tgl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_MAG_FILTER, opt.magFilter);\r\n\tgl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_S,     opt.wrapS    );\r\n\tgl.texParameteri(gl.TEXTURE_CUBE_MAP, gl.TEXTURE_WRAP_T,     opt.wrapT    );\r\n\tif (opt.generateMipmap) {\r\n\t\tgl.generateMipmap(gl.TEXTURE_CUBE_MAP);\r\n\t}\r\n\tgl.bindTexture(gl.TEXTURE_CUBE_MAP, null);\r\n\r\n\tvar obj = new SglTextureInfo();\r\n\tobj.handle           = tex;\r\n\tobj.valid            = true;\r\n\tobj.target           = gl.TEXTURE_CUBE_MAP;\r\n\tobj.format           = gl.RGBA;\r\n\tobj.width            = images[0].width;\r\n\tobj.height           = images[0].height;\r\n\tobj.minFilter        = opt.minFilter;\r\n\tobj.magFilter        = opt.magFilter;\r\n\tobj.wrapS            = opt.wrapS;\r\n\tobj.wrapT            = opt.wrapT;\r\n\tobj.isDepth          = false;\r\n\tobj.depthMode        = 0;\r\n\tobj.depthCompareMode = 0;\r\n\tobj.depthCompareFunc = 0;\r\n\r\n\treturn obj;\r\n}\r\n\r\nfunction sglTextureCubeFromUrls(gl, urls, options) {\r\n\tvar opt = sglGetTextureOptions(gl, options);\r\n\tvar obj = new SglTextureInfo();\r\n\r\n\tvar remaining = 6;\r\n\tvar images = new Array(6);\r\n\tfor (var i=0; i<6; ++i) {\r\n\t\timages[i] = new Image();\r\n\t\timages[i].crossOrigin = '';\r\n\t}\r\n\tvar watcher = function() {\r\n\t\tremaining--;\r\n\t\tif (remaining == 0) {\r\n\t\t\tvar texInfo = sglTextureCubeFromImages(gl, images, opt);\r\n\t\t\tfor (var a in texInfo) {\r\n\t\t\t\tobj[a] = texInfo[a];\r\n\t\t\t}\r\n\t\t\tif (opt.onload) {\r\n\t\t\t\topt.onload(gl, obj, urls);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\tfor (var i=0; i<6; ++i) {\r\n\t\timages[i].onload = watcher;\r\n\t\timages[i].src    = urls[i];\r\n\t}\r\n\r\n\treturn obj;\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// SglRenderbufferInfo\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglRenderbufferInfo.\r\n * @class Holds information about a WebGL renderbuffer object.\r\n */\r\nfunction SglRenderbufferInfo() {\r\n\tthis.handle    = null;\r\n\tthis.valid     = false;\r\n\tthis.target    = 0;\r\n\tthis.format    = 0;\r\n\tthis.width     = 0;\r\n\tthis.height    = 0;\r\n}\r\n\r\nfunction sglRenderbufferFromFormat(gl, format, width, height) {\r\n\tvar rb = gl.createRenderbuffer();\r\n\tgl.bindRenderbuffer(gl.RENDERBUFFER, rb);\r\n\tgl.renderbufferStorage(gl.RENDERBUFFER, format, width, height);\r\n\tgl.bindRenderbuffer(gl.RENDERBUFFER, null);\r\n\r\n\tvar obj = new SglRenderbufferInfo();\r\n\tobj.handle = rb;\r\n\tobj.valid  = true;\r\n\tobj.target = gl.RENDERBUFFER;\r\n\tobj.format = format;\r\n\tobj.width  = width;\r\n\tobj.height = height;\r\n\r\n\treturn obj;\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// SglFramebufferInfo\r\n/***********************************************************************/\r\nfunction sglGetFramebufferOptions(gl, options) {\r\n\tvar opt = {\r\n\t\tminFilter             : gl.LINEAR,\r\n\t\tmagFilter             : gl.LINEAR,\r\n\t\twrapS                 : gl.CLAMP_TO_EDGE,\r\n\t\twrapT                 : gl.CLAMP_TO_EDGE,\r\n\t\tisDepth               : false,\r\n\t\tdepthMode             : gl.LUMINANCE,\r\n\t\tdepthCompareMode      : gl.COMPARE_R_TO_TEXTURE,\r\n\t\tdepthCompareFunc      : gl.LEQUAL,\r\n\t\tcolorsAsRenderbuffer  : false,\r\n\t\tdepthAsRenderbuffer   : false,\r\n\t\tstencilAsRenderbuffer : false,\r\n\t\tgenerateColorsMipmap  : false,\r\n\t\tgenerateDepthMipmap   : false,\r\n\t\tgenerateStencilMipmap : false\r\n\t};\r\n\treturn _sglConsolidateOptions(opt, options);\r\n}\r\n\r\n/**\r\n * Constructs a SglFramebufferInfo.\r\n * @class Holds information about a WebGL framebuffer object.\r\n */\r\nfunction SglFramebufferInfo() {\r\n\tthis.handle        = null;\r\n\tthis.valid         = false;\r\n\tthis.width         = 0;\r\n\tthis.height        = 0;\r\n\tthis.colorTargets  = [ ];\r\n\tthis.depthTarget   = null;\r\n\tthis.stencilTarget = null;\r\n\tthis.status        = 0;\r\n}\r\n\r\nfunction sglFramebufferFromTargets(gl, colorTargets, depthTarget, stencilTarget, options) {\r\n\tvar opt = sglGetFramebufferOptions(gl, options);\r\n\r\n\tvar fb = gl.createFramebuffer();\r\n\tgl.bindFramebuffer(gl.FRAMEBUFFER, fb);\r\n\r\n\tif ((depthTarget != undefined) && (depthTarget != null) && (depthTarget != gl.NONE)) {\r\n\t\tif (depthTarget.target == gl.TEXTURE_2D) {\r\n\t\t\tgl.framebufferTexture2D(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.TEXTURE_2D, depthTarget.handle, 0);\r\n\t\t}\r\n\t\telse if (depthTarget.target == gl.RENDERBUFFER) {\r\n\t\t\tgl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, depthTarget.handle);\r\n\t\t}\r\n\t}\r\n\r\n\tif ((stencilTarget != undefined) && (stencilTarget != null) && (stencilTarget != gl.NONE)) {\r\n\t\tif (stencilTarget.target == gl.TEXTURE_2D) {\r\n\t\t\tgl.framebufferTexture2D(gl.FRAMEBUFFER, gl.STENCIL_ATTACHMENT, gl.TEXTURE_2D, stencilTarget.handle, 0);\r\n\t\t}\r\n\t\telse if (stencilTarget.target == gl.RENDERBUFFER) {\r\n\t\t\tgl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.STENCIL_ATTACHMENT, gl.RENDERBUFFER, stencilTarget.handle);\r\n\t\t}\r\n\t}\r\n\r\n\tvar cts = [ ];\r\n\tvar drawBuffers = [ ];\r\n\tif ((colorTargets != undefined) && (colorTargets != null)) {\r\n\t\tvar n = colorTargets.length;\r\n\t\tif (n == 0) {\r\n\t\t\tdrawBuffers.push(gl.NONE);\r\n\t\t\t//gl.readBuffer(gl.NONE);\r\n\t\t}\r\n\t\telse {\r\n\t\t\tvar att = gl.COLOR_ATTACHMENT0;\r\n\t\t\tfor (var c in colorTargets) {\r\n\t\t\t\tvar ct = colorTargets[c];\r\n\t\t\t\tif (ct.target == gl.TEXTURE_2D) {\r\n\t\t\t\t\tgl.framebufferTexture2D(gl.FRAMEBUFFER, att, gl.TEXTURE_2D, ct.handle, 0);\r\n\t\t\t\t}\r\n\t\t\t\telse if (ct.target == gl.RENDERBUFFER) {\r\n\t\t\t\t\tgl.framebufferRenderbuffer(gl.FRAMEBUFFER, att, gl.RENDERBUFFER, ct.handle);\r\n\t\t\t\t}\r\n\t\t\t\tdrawBuffers.push(att);\r\n\t\t\t\tcts.push(ct);\r\n\t\t\t\tatt++;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t//gl.drawBuffers(drawBuffers);\r\n\tvar fbStatus = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\r\n\r\n\tgl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n\r\n\tvar trg = null;\r\n\tif (cts.length > 0) {\r\n\t\ttrg = cts[0];\r\n\t}\r\n\telse if (depthTarget) {\r\n\t\ttrg = depthTarget;\r\n\t}\r\n\telse if (stencilTarget) {\r\n\t\ttrg = stencilTarget;\r\n\t}\r\n\r\n\tvar width  = 0;\r\n\tvar height = 0;\r\n\tif (trg) {\r\n\t\twidth  = trg.width;\r\n\t\theight = trg.height;\r\n\t}\r\n\r\n\tvar obj = new SglFramebufferInfo()\r\n\tobj.handle        = fb;\r\n\tobj.valid         = (fbStatus == gl.FRAMEBUFFER_COMPLETE);\r\n\tobj.width         = width;\r\n\tobj.height        = height;\r\n\tobj.colorTargets  = cts;\r\n\tobj.depthTarget   = (depthTarget  ) ? (depthTarget  ) : (null);\r\n\tobj.stencilTarget = (stencilTarget) ? (stencilTarget) : (null);\r\n\tobj.status        = fbStatus;\r\n\r\n\treturn obj;\r\n}\r\n\r\nfunction sglFramebufferFromFormats(gl, width, height, colorFormats, depthFormat, stencilFormat, options) {\r\n\tvar opt = sglGetFramebufferOptions(gl, options);\r\n\r\n\tvar colorTargets = null;\r\n\tif (colorFormats) {\r\n\t\topt.isDepth = false;\r\n\t\tcolorTargets = [ ];\r\n\t\tvar ct = null;\r\n\t\tif (opt.colorsAsRenderbuffer) {\r\n\t\t\tfor (var c in colorFormats) {\r\n\t\t\t\tvar cc = colorFormats[c];\r\n\t\t\t\tct = sglRenderbufferFromFormat(gl, cc, width, height);\r\n\t\t\t\tcolorTargets.push(ct);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\topt.generateMipmap = opt.generateColorsMipmap;\r\n\t\t\tfor (var c in colorFormats) {\r\n\t\t\t\tvar cc = colorFormats[c];\r\n\t\t\t\tct = sglTexture2DFromData(gl, cc, width, height, gl.RGBA, gl.UNSIGNED_BYTE, null, opt);\r\n\t\t\t\tcolorTargets.push(ct);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tvar depthTarget = null;\r\n\tif (depthFormat) {\r\n\t\topt.isDepth = true;\r\n\t\tif (opt.depthAsRenderbuffer) {\r\n\t\t\tdepthTarget = sglRenderbufferFromFormat(gl, depthFormat, width, height);\r\n\t\t}\r\n\t\telse {\r\n\t\t\topt.generateMipmap = opt.generateDepthMipmap;\r\n\t\t\tdepthTarget = sglTexture2DFromData(gl, depthFormat, width, height, gl.DEPTH_COMPONENT, gl.FLOAT, null, opt);\r\n\t\t}\r\n\t}\r\n\r\n\tvar stencilTarget = null;\r\n\tif (stencilFormat) {\r\n\t\topt.isDepth = false;\r\n\t\tif (opt.stencilAsRenderbuffer) {\r\n\t\t\tstencilTarget = sglRenderbufferFromFormat(gl, stencilFormat, width, height);\r\n\t\t}\r\n\t\telse {\r\n\t\t\topt.generateMipmap = opt.generateStencilMipmap;\r\n\t\t\tstencilTarget = sglTexture2DFromData(gl, stencilFormat, width, height, gl.STENCIL_COMPONENT, gl.UNSIGNED_BYTE, null, opt);\r\n\t\t}\r\n\t}\r\n\r\n\treturn sglFramebufferFromTargets(gl, colorTargets, depthTarget, stencilTarget, opt);\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// SglVertexBuffer\r\n/***********************************************************************/\r\n// SglVertexBuffer(gl, info)\r\n// SglVertexBuffer(gl, values, usage)\r\n/**\r\n * Constructs a SglVertexBuffer.\r\n * @class Manages a WebGL vertex buffer object.\r\n */\r\nfunction SglVertexBuffer() {\r\n\tthis.gl    = arguments[0];\r\n\tthis._info = null;\r\n\tif (arguments[1] instanceof SglBufferInfo) {\r\n\t\tthis._info = arguments[1];\r\n\t}\r\n\telse {\r\n\t\tthis._info = sglVertexBufferFromData(this.gl, arguments[1], arguments[2]);\r\n\t}\r\n}\r\n\r\nSglVertexBuffer.prototype = {\r\n\tget info() { return this._info; },\r\n\r\n\tdestroy : function() {\r\n\t\tif (this._info.valid) {\r\n\t\t\tthis.gl.deleteBuffer(this._info.handle);\r\n\t\t}\r\n\t\tthis._info = null;\r\n\t},\r\n\r\n\tget handle() {\r\n\t\treturn this._info.handle;\r\n\t},\r\n\r\n\tget isValid() {\r\n\t\treturn this._info.valid;\r\n\t},\r\n\r\n\tbind : function() {\r\n\t\tthis.gl.bindBuffer(this.gl.ARRAY_BUFFER, this._info.handle);\r\n\t},\r\n\r\n\tunbind : function() {\r\n\t\tthis.gl.bindBuffer(this.gl.ARRAY_BUFFER, null);\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglIndexBuffer\r\n/***********************************************************************/\r\n// SglIndexBuffer(gl, info)\r\n// SglIndexBuffer(gl, values, usage)\r\n/**\r\n * Constructs a SglIndexBuffer.\r\n * @class Manages a WebGL index buffer object.\r\n */\r\nfunction SglIndexBuffer() {\r\n\tthis.gl    = arguments[0];\r\n\tthis._info = null;\r\n\tif (arguments[1] instanceof SglBufferInfo) {\r\n\t\tthis._info = arguments[1];\r\n\t}\r\n\telse {\r\n\t\tthis._info = sglIndexBufferFromData(this.gl, arguments[1], arguments[2]);\r\n\t}\r\n}\r\n\r\nSglIndexBuffer.prototype = {\r\n\tget info() { return this._info; },\r\n\r\n\tdestroy : function() {\r\n\t\tif (this._info.valid) {\r\n\t\t\tthis.gl.deleteBuffer(this._info.handle);\r\n\t\t}\r\n\t\tthis._info = null;\r\n\t},\r\n\r\n\tget handle() {\r\n\t\treturn this._info.handle;\r\n\t},\r\n\r\n\tget isValid() {\r\n\t\treturn this._info.valid;\r\n\t},\r\n\r\n\tbind : function() {\r\n\t\tthis.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER, this._info.handle);\r\n\t},\r\n\r\n\tunbind : function() {\r\n\t\tthis.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER, null);\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglProgramAttribute\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglProgramAttribute.\r\n * @class Manages a program attribute.\r\n */\r\nfunction SglProgramAttribute(program, info) {\r\n\tthis._prog = program;\r\n\tthis._info = info;\r\n}\r\n\r\nSglProgramAttribute.prototype = {\r\n\tset index(n) {\r\n\t\tthis._prog.gl.bindAttribLocation(this._prog._info.handle, n, this._info.name)\r\n\t\tthis._info.location = n;\r\n\t},\r\n\r\n\tget index () {\r\n\t\treturn this._info.location;\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglProgramUniform\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglProgramUniform.\r\n * @class Manages a program uniform.\r\n */\r\nfunction SglProgramUniform(program, info) {\r\n\tthis._prog = program;\r\n\tthis._info = info;\r\n\tthis._func = null;\r\n\r\n\tvar gl   = this._prog.gl;\r\n\tvar type = this._info.nativeType;\r\n\r\n\tif (type == gl.BOOL) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniform1i(this._info.location, v); };\r\n\t}\r\n\telse if (type == gl.BOOL_VEC2) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniform2iv(this._info.location, v); };\r\n\t}\r\n\telse if (type == gl.BOOL_VEC3) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniform3iv(this._info.location, v); };\r\n\t}\r\n\telse if (type == gl.BOOL_VEC4) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniform4iv(this._info.location, v); };\r\n\t}\r\n\telse if (type == gl.INT) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniform1i(this._info.location, v); };\r\n\t}\r\n\telse if (type == gl.INT_VEC2) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniform2iv(this._info.location, v); };\r\n\t}\r\n\telse if (type == gl.INT_VEC3) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniform3iv(this._info.location, v); };\r\n\t}\r\n\telse if (type == gl.INT_VEC4) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniform4iv(this._info.location, v); };\r\n\t}\r\n\telse if (type == gl.FLOAT) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniform1f(this._info.location, v); };\r\n\t}\r\n\telse if (type == gl.FLOAT_VEC2) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniform2fv(this._info.location, v); };\r\n\t}\r\n\telse if (type == gl.FLOAT_VEC3) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniform3fv(this._info.location, v); };\r\n\t}\r\n\telse if (type == gl.FLOAT_VEC4) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniform4fv(this._info.location, v); };\r\n\t}\r\n\telse if (type == gl.FLOAT_MAT2) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniformMatrix2fv(this._info.location, this._prog.gl.FALSE, v); };\r\n\t}\r\n\telse if (type == gl.FLOAT_MAT3) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniformMatrix3fv(this._info.location, this._prog.gl.FALSE, v); };\r\n\t}\r\n\telse if (type == gl.FLOAT_MAT4) {\r\n\t\tthis._func = function (v) { this._prog.gl.uniformMatrix4fv(this._info.location, this._prog.gl.FALSE, v); };\r\n\t}\r\n\telse {\r\n\t\tsglUnknown();\r\n\t}\r\n}\r\n\r\nSglProgramUniform.prototype = {\r\n\tset value(v) {\r\n\t\tthis._func(v);\r\n\t},\r\n\r\n\tget value() {\r\n\t\treturn this._prog.gl.getUniform(this._prog._info.handle, this._info.location);\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglProgramSampler\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglProgramSampler.\r\n * @class Manages a program sampler.\r\n */\r\nfunction SglProgramSampler(program, info) {\r\n\tthis._prog = program;\r\n\tthis._info = info;\r\n\tthis._unit = -1;\r\n\r\n\tvar gl   = this._prog.gl;\r\n\tvar type = this._info.nativeType;\r\n\r\n\tif (type == gl.SAMPLER_2D) {\r\n\t\t;\r\n\t}\r\n\telse if (type == gl.SAMPLER_CUBE) {\r\n\t\t;\r\n\t}\r\n\telse if (type == 35682) {\r\n\t\t;\r\n\t}\r\n\telse {\r\n\t\tsglUnknown();\r\n\t}\r\n}\r\n\r\nSglProgramSampler.prototype = {\r\n\tset unit(n) {\r\n\t\tthis._prog.gl.uniform1i(this._info.location, n);\r\n\t\tthis._unit = n;\r\n\t},\r\n\r\n\tget unit() {\r\n\t\t//return this._prog.gl.getUniform(this._prog._info.handle, this._info.location);\r\n\t\treturn this._unit;\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglProgram\r\n/***********************************************************************/\r\n// SglProgram(gl, info)\r\n// SglProgram(gl, [vertexSources], [fragmentSources])\r\n/**\r\n * Constructs a SglProgram.\r\n * @class Manages a WebGL program object.\r\n */\r\nfunction SglProgram() {\r\n\tthis.gl    = arguments[0];\r\n\tthis._info = null;\r\n\r\n\tif (arguments[1] instanceof SglProgramInfo) {\r\n\t\tthis._info = arguments[1];\r\n\t}\r\n\telse {\r\n\t\tthis._info = sglProgramFromSources(this.gl, arguments[1], arguments[2]);\r\n\t}\r\n\r\n\tthis._attributes = new Object();\r\n\tfor (var a in this._info.attributes) {\r\n\t\tthis._attributes[a] = new SglProgramAttribute(this, this._info.attributes[a]);\r\n\t}\r\n\r\n\tthis._uniforms = new Object();\r\n\tfor (var u in this._info.uniforms) {\r\n\t\tthis._uniforms[u] = new SglProgramUniform(this, this._info.uniforms[u]);\r\n\t}\r\n\r\n\tvar unit = 0;\r\n\tthis._samplers = new Object();\r\n\tfor (var s in this._info.samplers) {\r\n\t\tthis._samplers[s] = new SglProgramSampler(this, this._info.samplers[s]);\r\n\t\tthis._samplers[s]._unit = unit;\r\n\t\tunit++;\r\n\t}\r\n}\r\n\r\nSglProgram.prototype =\r\n{\r\n\tget info()       { return this._info;        },\r\n\tget attributes() { return this._attributes;  },\r\n\tget uniforms()   { return this._uniforms;    },\r\n\tget samplers()   { return this._samplers;    },\r\n\r\n\tdestroy : function() {\r\n\t\tif (this._info.valid == null) return;\r\n\r\n\t\tvar gl = this.gl;\r\n\r\n\t\tgl.deleteProgram(this._info.handle);\r\n\t\tfor (var s in this._info.shaders) {\r\n\t\t\tgl.deleteShader(this._info.shaders[s].handle);\r\n\t\t}\r\n\r\n\t\tthis._attributes = null;\r\n\t\tthis._uniforms   = null;\r\n\t\tthis._samplers   = null;\r\n\r\n\t\tthis._info = null;\r\n\t},\r\n\r\n\tget handle() {\r\n\t\treturn this._info.handle;\r\n\t},\r\n\r\n\tget isValid() {\r\n\t\treturn this._info.valid;\r\n\t},\r\n\r\n\tget log() {\r\n\t\tvar log = \"\";\r\n\t\tlog += \"-------------------------------------\\n\";\r\n\t\tfor (var s in this._info.shaders) {\r\n\t\t\tlog += this._info.shaders[s].log;\r\n\t\t}\r\n\t\tlog += this._info.log;\r\n\t\tlog += \"-------------------------------------\\n\";\r\n\t\tlog += \"\\n\";\r\n\t\treturn log;\r\n\t},\r\n\r\n\tsetDefaultBindings : function() {\r\n\t\tsglSetDefaultProgramBindings(this.gl, this._info);\r\n\t},\r\n\r\n\tsynchronize : function() {\r\n\t\tsglProgramSynchronize(this.gl, this._info);\r\n\t},\r\n\r\n\tbind : function() {\r\n\t\tthis.gl.useProgram(this._info.handle);\r\n\t},\r\n\r\n\tunbind : function() {\r\n\t\t//this.gl.useProgram(null);\r\n\t},\r\n\r\n\tsetAttributes : function(mapping) {\r\n\t\tvar attr = null;\r\n\t\tfor (var a in mapping) {\r\n\t\t\tattr = this._attributes[a];\r\n\t\t\tif (attr) {\r\n\t\t\t\tattr.index = mapping[a];\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.link();\r\n\t},\r\n\r\n\tsetUniforms : function(mapping) {\r\n\t\tvar unif = null;\r\n\t\tfor (var u in mapping) {\r\n\t\t\tunif = this._uniforms[u];\r\n\t\t\tif (unif) {\r\n\t\t\t\tunif.value = mapping[u];\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\tsetSamplers : function(mapping) {\r\n\t\tvar smp = null;\r\n\t\tfor (var s in mapping) {\r\n\t\t\tsmp = this._samplers[s];\r\n\t\t\tif (smp != undefined) {\r\n\t\t\t\tsmp.unit = mapping[s];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglTexture2D\r\n/***********************************************************************/\r\n// SglTexture2D(gl, info)\r\n// SglTexture2D(gl, internalFormat, width, height, sourceFormat, sourceType, texels, options)\r\n// SglTexture2D(gl, image, options)\r\n// SglTexture2D(gl, url, options)\r\n/**\r\n * Constructs a SglTexture2D.\r\n * @class Manages a WebGL 2D texture object.\r\n */\r\nfunction SglTexture2D() {\r\n\tthis.gl    = arguments[0];\r\n\tthis._info = null;\r\n\r\n\tvar gl = this.gl;\r\n\r\n\tvar n = arguments.length;\r\n\tif ((n == 2) || (n == 3)) {\r\n\t\tif (arguments[1] instanceof Image) {\r\n\t\t\tthis._info = sglTexture2DFromImage(gl, arguments[1], arguments[2]);\r\n\t\t}\r\n\t\t//else if (arguments[1] instanceof String) {\r\n\t\telse if (typeof(arguments[1]) == \"string\") {\r\n\t\t\tthis._info = sglTexture2DFromUrl(gl, arguments[1], arguments[2]);\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis._info = arguments[1];\r\n\t\t}\r\n\t}\r\n\telse {\r\n\t\tthis._info = sglTexture2DFromData(gl, arguments[1], arguments[2], arguments[3], arguments[4], arguments[5], arguments[6], arguments[7]);\r\n\t}\r\n}\r\n\r\nSglTexture2D.prototype = {\r\n\tget info() { return this._info; },\r\n\r\n\tdestroy : function() {\r\n\t\tif (this._info.handle == null) return;\r\n\t\tthis.gl.deleteTexture(this._info.handle);\r\n\t\tthis._info = null;\r\n\t},\r\n\r\n\tget handle() {\r\n\t\treturn this._info.handle;\r\n\t},\r\n\r\n\tget isValid() {\r\n\t\treturn this._info.valid;\r\n\t},\r\n\r\n\tbind : function(unit) {\r\n\t\tthis.gl.activeTexture(this.gl.TEXTURE0 + unit);\r\n\t\tthis.gl.bindTexture(this._info.target, this._info.handle);\r\n\t},\r\n\r\n\tunbind : function(unit) {\r\n\t\tthis.gl.activeTexture(this.gl.TEXTURE0 + unit);\r\n\t\tthis.gl.bindTexture(this._info.target, null);\r\n\t},\r\n\r\n\tgenerateMipmap : function() {\r\n\t\tthis.gl.generateMipmap(this._info.target);\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglTextureCube\r\n/***********************************************************************/\r\n// SglTextureCube(gl, info)\r\n// SglTextureCube(gl, internalFormat, width, height, sourceFormat, sourceType, facesTexels, options)\r\n// SglTextureCube(gl, images, options)\r\n// SglTextureCube(gl, urls, options)\r\n/**\r\n * Constructs a SglTextureCube.\r\n * @class Manages a WebGL cube texture object.\r\n */\r\nfunction SglTextureCube() {\r\n\tthis.gl    = arguments[0];\r\n\tthis._info = null;\r\n\r\n\tvar gl = this.gl;\r\n\r\n\tvar n = arguments.length;\r\n\tif ((n == 2) || (n == 3)) {\r\n\t\tif (arguments[1] instanceof Array) {\r\n\t\t\tif (arguments[1][0] instanceof Image) {\r\n\t\t\t\tthis._info = sglTextureCubeFromImages(gl, arguments[1], arguments[2]);\r\n\t\t\t}\r\n\t\t\t//else if (arguments[1] instanceof String) {\r\n\t\t\telse if (typeof(arguments[1][0]) == \"string\") {\r\n\t\t\t\tthis._info = sglTextureCubeFromUrls(gl, arguments[1], arguments[2]);\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis._info = arguments[1];\r\n\t\t}\r\n\t}\r\n\telse {\r\n\t\tthis._info = sglTextureCubeFromData(gl, arguments[1], arguments[2], arguments[3], arguments[4], arguments[5], arguments[6], arguments[7]);\r\n\t}\r\n}\r\n\r\nSglTextureCube.prototype = {\r\n\tget info() { return this._info; },\r\n\r\n\tdestroy : function() {\r\n\t\tif (this._info.handle == null) return;\r\n\t\tthis.gl.deleteTexture(this._info.handle);\r\n\t\tthis._info = null;\r\n\t},\r\n\r\n\tget handle() {\r\n\t\treturn this._info.handle;\r\n\t},\r\n\r\n\tget isValid() {\r\n\t\treturn this._info.valid;\r\n\t},\r\n\r\n\tbind : function(unit) {\r\n\t\tthis.gl.activeTexture(this.gl.TEXTURE0 + unit);\r\n\t\tthis.gl.bindTexture(this._info.target, this._info.handle);\r\n\t},\r\n\r\n\tunbind : function(unit) {\r\n\t\tthis.gl.activeTexture(this.gl.TEXTURE0 + unit);\r\n\t\tthis.gl.bindTexture(this._info.target, null);\r\n\t},\r\n\r\n\tgenerateMipmap : function() {\r\n\t\tthis.gl.generateMipmap(this._info.target);\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglRenderbuffer\r\n/***********************************************************************/\r\n// SglRenderbuffer(gl, info)\r\n// SglRenderbuffer(gl, format, width, height)\r\n/**\r\n * Constructs a SglRenderbuffer.\r\n * @class Manages a WebGL renderbuffer object.\r\n */\r\nfunction SglRenderbuffer() {\r\n\tthis.gl    = arguments[0];\r\n\tthis._info = null;\r\n\r\n\tvar gl = this.gl;\r\n\r\n\tvar n = arguments.length;\r\n\tif (n == 2) {\r\n\t\tthis._info = arguments[1];\r\n\t}\r\n\telse {\r\n\t\tthis._info = sglRenderbufferFromFormat(gl, arguments[1], arguments[2], arguments[3]);\r\n\t}\r\n}\r\n\r\nSglRenderbuffer.prototype = {\r\n\tget info() { return this._info; },\r\n\r\n\tdestroy : function() {\r\n\t\tif (this._info.handle == null) return;\r\n\t\tthis.gl.deleteRenderbuffer(this._info.handle);\r\n\t\tthis._info = null;\r\n\t},\r\n\r\n\tget handle() {\r\n\t\treturn this._info.handle;\r\n\t},\r\n\r\n\tget isValid() {\r\n\t\treturn this._info.valid;\r\n\t},\r\n\r\n\tbind : function() {\r\n\t\tthis.gl.bindRenderbuffer(this.gl.RENDERBUFFER, this._info.handle);\r\n\t},\r\n\r\n\tunbind : function() {\r\n\t\tthis.gl.bindRenderbuffer(this.gl.RENDERBUFFER, null);\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// SglFramebuffer\r\n/***********************************************************************/\r\n// SglFramebuffer(gl, info)\r\n// SglFramebuffer(gl, width, height, colorFormats, depthFormat, stencilFormat, options)\r\n/**\r\n * Constructs a SglFramebuffer.\r\n * @class Manages a WebGL framebuffer object.\r\n */\r\nfunction SglFramebuffer() {\r\n\tthis.gl    = arguments[0];\r\n\tthis._info = null;\r\n\r\n\tvar gl = this.gl;\r\n\r\n\tvar n = arguments.length;\r\n\tif (n == 2) {\r\n\t\tthis._info = arguments[1];\r\n\t}\r\n\telse {\r\n\t\tthis._info = sglFramebufferFromFormats(gl, arguments[1], arguments[2], arguments[3], arguments[4], arguments[5], arguments[6]);\r\n\t}\r\n\r\n\tvar s = null;\r\n\tvar t = null;\r\n\r\n\tthis._colorTargets = [ ];\r\n\tfor (var c in this._info.colorTargets) {\r\n\t\ts = this._info.colorTargets[c];\r\n\t\tt = null;\r\n\t\tif (s.target == gl.TEXTURE_2D) {\r\n\t\t\tt = new SglTexture2D(gl, s);\r\n\t\t}\r\n\t\telse if (s.target == gl.RENDERBUFFER) {\r\n\t\t\tt = new SglRenderbuffer(gl, s);\r\n\t\t}\r\n\t\tthis._colorTargets.push(t);\r\n\t}\r\n\r\n\tthis._depthTarget = null;\r\n\tif (this._info.depthTarget) {\r\n\t\ts = this._info.depthTarget;\r\n\t\tt = null;\r\n\t\tif (s.target == gl.TEXTURE_2D) {\r\n\t\t\tt = new SglTexture2D(gl, s);\r\n\t\t}\r\n\t\telse if (s.target == gl.RENDERBUFFER) {\r\n\t\t\tt = new SglRenderbuffer(gl, s);\r\n\t\t}\r\n\t\tthis._depthTarget = t;\r\n\t}\r\n\r\n\tthis._stencilTarget = null;\r\n\tif (this._info.stencilTarget) {\r\n\t\ts = this._info.stencilTarget;\r\n\t\tt = null;\r\n\t\tif (s.target == gl.TEXTURE_2D) {\r\n\t\t\tt = new SglTexture2D(gl, s);\r\n\t\t}\r\n\t\telse if (s.target == gl.RENDERBUFFER) {\r\n\t\t\tt = new SglRenderbuffer(gl, s);\r\n\t\t}\r\n\t\tthis._stencilTarget = t;\r\n\t}\r\n}\r\n\r\nSglFramebuffer.prototype = {\r\n\tget info()          { return this._info;          },\r\n\tget colorTargets()  { return this._colorTargets;  },\r\n\tget depthTarget()   { return this._depthTarget;   },\r\n\tget stencilTarget() { return this._stencilTarget; },\r\n\r\n\tdestroy : function() {\r\n\t\tif (this._info.handle == null) return;\r\n\t\tthis.gl.deleteFramebuffer(this._info.handle);\r\n\t\tfor (var t in this._colorTargets) {\r\n\t\t\tvar ct = this._colorTargets[t];\r\n\t\t\tif (ct) {\r\n\t\t\t\tthis._colorTargets[t].destroy();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (this._depthTarget) {\r\n\t\t\tthis._depthTarget.destroy();\r\n\t\t}\r\n\t\tif (this._stencilTarget) {\r\n\t\t\tthis._stencilTarget.destroy();\r\n\t\t}\r\n\t\tthis._info   = null;\r\n\t\tthis.targets = null;\r\n\t},\r\n\r\n\tget handle() {\r\n\t\treturn this._info.handle;\r\n\t},\r\n\r\n\tget isValid() {\r\n\t\treturn this._info.valid;\r\n\t},\r\n\r\n\tget width() {\r\n\t\treturn this._info.width;\r\n\t},\r\n\r\n\tget height() {\r\n\t\treturn this._info.height;\r\n\t},\r\n\r\n\tbind : function(setViewport) {\r\n\t\tvar vp = true;\r\n\t\tif (setViewport != undefined) vp = setViewport;\r\n\r\n\t\tif (vp) {\r\n\t\t\tthis.gl.viewport(0, 0, this._info.width, this._info.height);\r\n\t\t}\r\n\r\n\t\tthis.gl.bindFramebuffer(this.gl.FRAMEBUFFER, this._info.handle);\r\n\t},\r\n\r\n\tunbind : function() {\r\n\t\tthis.gl.bindFramebuffer(this.gl.FRAMEBUFFER, null);\r\n\t},\r\n\r\n\tbindColor : function(index, unit) {\r\n\t\tthis._colorTargets[index].bind(unit);\r\n\t},\r\n\r\n\tunbindColor : function(index, unit) {\r\n\t\tthis._colorTargets[index].unbind(unit);\r\n\t},\r\n\r\n\tbindDepth : function(unit) {\r\n\t\tthis._depthTarget.bind(unit);\r\n\t},\r\n\r\n\tunbindDepth : function(unit) {\r\n\t\tthis._depthTarget.unbind(unit);\r\n\t},\r\n\r\n\tbindStencil : function(unit) {\r\n\t\tthis._stencilTarget.bind(unit);\r\n\t},\r\n\r\n\tunbindStencil : function(unit) {\r\n\t\tthis._stencilTarget.unbind(unit);\r\n\t},\r\n\r\n\tgenerateMipmap : function(colors, depth, stencil) {\r\n\t\tvar t = null;\r\n\r\n\t\tif (colors) {\r\n\t\t\tfor (var c in this._colorTargets) {\r\n\t\t\t\tt = this._colorTargets[c];\r\n\t\t\t\tif (!t) continue;\r\n\t\t\t\tif (t.info.target == this.gl.TEXTURE_2D) {\r\n\t\t\t\t\tt.bind(0);\r\n\t\t\t\t\tt.generateMipmap();\r\n\t\t\t\t\tt.unbind(0);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (depth) {\r\n\t\t\tt = this._depthTarget;\r\n\t\t\tif (t) {\r\n\t\t\t\tif (t.info.target == this.gl.TEXTURE_2D) {\r\n\t\t\t\t\tt.bind(0);\r\n\t\t\t\t\tt.generateMipmap();\r\n\t\t\t\t\tt.unbind(0);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (stencil) {\r\n\t\t\tt = this._stencilTarget;\r\n\t\t\tif (t) {\r\n\t\t\t\tif (t.info.target == this.gl.TEXTURE_2D) {\r\n\t\t\t\t\tt.bind(0);\r\n\t\t\t\t\tt.generateMipmap();\r\n\t\t\t\t\tt.unbind(0);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\tattachColorTarget : function(index, t) {\r\n\t\tif (!t) return false;\r\n\t\tif ((index < 0) || (index >= this._colorTargets.length)) return false;\r\n\t\tif ((t.width != this.width) || (t.height != this.height)) return false;\r\n\r\n\t\tvar gl = this.gl;\r\n\r\n\t\tvar att = this.gl.COLOR_ATTACHMENT0 + index;\r\n\t\tif (t.target == gl.TEXTURE_2D) {\r\n\t\t\tgl.framebufferTexture2D(gl.FRAMEBUFFER, att, gl.TEXTURE_2D, t.handle, 0);\r\n\t\t}\r\n\t\telse if (t.target == gl.RENDERBUFFER) {\r\n\t\t\tgl.framebufferRenderbuffer(gl.FRAMEBUFFER, att, gl.RENDERBUFFER, t.handle);\r\n\t\t}\r\n\r\n\t\tthis._colorTargets[index] = t;\r\n\r\n\t\treturn true;\r\n\t},\r\n\r\n\tdetachColorTarget : function(index) {\r\n\t\tif ((index < 0) || (index >= this._colorTargets.length)) return false;\r\n\r\n\t\tvar t = this._colorTargets[index]\r\n\t\tif (!t) return false;\r\n\r\n\t\tvar gl = this.gl;\r\n\r\n\t\tif (t.target == gl.TEXTURE_2D) {\r\n\t\t\tgl.framebufferTexture2D(gl.FRAMEBUFFER, att, gl.TEXTURE_2D, null, 0);\r\n\t\t}\r\n\t\telse if (t.target == gl.RENDERBUFFER) {\r\n\t\t\tgl.framebufferRenderbuffer(gl.FRAMEBUFFER, att, gl.RENDERBUFFER, null);\r\n\t\t}\r\n\r\n\t\tthis._colorTargets[index] = null;\r\n\r\n\t\treturn true;\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// SglAttributeStreamJS\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglAttributeStreamJS.\r\n * @class Holds the properties and the storage array of a vertex attribute stream.\r\n */\r\nfunction SglAttributeStreamJS(name, size, values, byCopy) {\r\n\tthis._name = name;\r\n\tthis._size = size;\r\n\tthis._buff = (byCopy) ? ((values) ? (values.slice()) : (null)) : (values);\r\n}\r\n\r\nSglAttributeStreamJS.prototype = {\r\n\tget name()       { return this._name; },\r\n\tget size()       { return this._size; },\r\n\tget buffer()     { return this._buff; },\r\n\tget length()     { return this._buff.length; },\r\n\r\n\tget : function(index) {\r\n\t\treturn this._buff.slice(index * this._size, this._size);\r\n\t},\r\n\r\n\tset : function(index, value) {\r\n\t\tvar k = index * this._size;\r\n\t\tfor (var i=0; i<this._size; ++i) {\r\n\t\t\tthis._buff[k++] = value[i];\r\n\t\t}\r\n\t\treturn r;\r\n\t}\r\n};\r\n/***************************************************************/\r\n\r\n\r\n// SglVertexStreamJS\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglVertexStreamJS.\r\n * @class Container of vertex attribute streams.\r\n */\r\nfunction SglVertexStreamJS() {\r\n\tthis._attribs = { };\r\n\tthis._length  = 0;\r\n}\r\n\r\nSglVertexStreamJS.prototype = {\r\n\tget attributes() { return this._attribs; },\r\n\tget length()     { return this._length;  },\r\n\r\n\taddAttribute : function(name, size, values, byCopy) {\r\n\t\tvar attr = new SglAttributeStreamJS(name, size, values, byCopy);\r\n\t\tthis._attribs[name] = attr;\r\n\t\tthis._length = attr.length;\r\n\t},\r\n\r\n\tremoveAttribute : function(name) {\r\n\t\tif (!this._attribs[name]) return;\r\n\r\n\t\tdelete this._attribs[name];\r\n\r\n\t\tthis._length = 0;\r\n\t\tfor (var a in this._attribs) {\r\n\t\t\tthis._length = this._attribs[a].length;\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n};\r\n/***************************************************************/\r\n\r\n\r\nvar SGL_ARRAY_PRIMITIVE_STREAM          = 1;\r\nvar SGL_INDEXED_PRIMITIVE_STREAM        = 2;\r\nvar SGL_PACKED_INDEXED_PRIMITIVE_STREAM = 3;\r\n\r\nvar SGL_POINTS_LIST    = 1;\r\nvar SGL_LINES_LIST     = 2;\r\nvar SGL_LINE_STRIP     = 3;\r\nvar SGL_LINE_LOOP      = 4;\r\nvar SGL_TRIANGLES_LIST = 5;\r\nvar SGL_TRIANGLE_STRIP = 6;\r\nvar SGL_TRIANGLE_FAN   = 7;\r\n\r\n\r\n// SglPrimitiveStreamJS\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglPrimitiveStreamJS.\r\n * @class Holds the primitives stream information and storage (if any).\r\n */\r\nfunction SglPrimitiveStreamJS(name, mode, first, length) {\r\n\tthis._name = name;\r\n\tthis._mode = mode;\r\n\tthis._first  = (first)  ? (first)  : (0);\r\n\tthis._length = (length) ? (length) : (0);\r\n}\r\n\r\nSglPrimitiveStreamJS.prototype = {\r\n\tget type()   { return undefined;    },\r\n\tget name()   { return this._name;   },\r\n\tget mode()   { return this._mode;   },\r\n\tget first()  { return this._first;  },\r\n\tget length() { return this._length; }\r\n}\r\n/***************************************************************/\r\n\r\n\r\n// SglArrayPrimitiveStreamJS\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglArrayPrimitiveStreamJS.\r\n * @class Holds the array primitive stream information.\r\n */\r\nfunction SglArrayPrimitiveStreamJS(name, mode, first, count) {\r\n\tSglPrimitiveStreamJS.call(this, name, mode, first, count);\r\n\tObject.defineProperty(this, \"type\", {get: function(){return SGL_ARRAY_PRIMITIVE_STREAM;}});\r\n}\r\n\r\nsglInherit(SglArrayPrimitiveStreamJS, SglPrimitiveStreamJS);\r\n/*sglDefineGetter(SglArrayPrimitiveStreamJS, \"type\", function() {\r\n\treturn SGL_ARRAY_PRIMITIVE_STREAM;\r\n});*/\r\n/***************************************************************/\r\n\r\n\r\n// SglIndexedPrimitiveStreamJS\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglIndexedPrimitiveStreamJS.\r\n * @class Holds the indexed primitive stream information and storage.\r\n */\r\nfunction SglIndexedPrimitiveStreamJS(name, mode, indices, byCopy) {\r\n\tSglPrimitiveStreamJS.call(this, name, mode, 0, indices.length);\r\n\r\n\tthis._buff = (byCopy) ? ((indices) ? (indices.slice()) : (null)) : (indices);\r\n\t\r\n\tObject.defineProperty(this, \"type\", {get: function(){return SGL_INDEXED_PRIMITIVE_STREAM;}});\r\n\tObject.defineProperty(this, \"buffer\", {get: function(){return this._buff;}});\r\n\tObject.defineProperty(this, \"length\", {get: function(){return this._buff.length;}});\r\n}\r\n\r\n\r\nsglInherit(SglIndexedPrimitiveStreamJS, SglPrimitiveStreamJS);\r\n/*sglDefineGetter(SglIndexedPrimitiveStreamJS, \"type\", function() {\r\n\treturn SGL_INDEXED_PRIMITIVE_STREAM;\r\n});\r\n\r\nsglDefineGetter(SglIndexedPrimitiveStreamJS, \"buffer\", function() {\r\n\treturn this._buff;\r\n});\r\n\r\nsglDefineGetter(SglIndexedPrimitiveStreamJS, \"length\", function() {\r\n\treturn this._buff.length;\r\n});*/\r\n/***************************************************************/\r\n\r\n\r\n// SglConnectivityJS\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglConnectivityJS.\r\n * @class Container for primitive streams.\r\n */\r\nfunction SglConnectivityJS() {\r\n\tthis._prims = { };\r\n}\r\n\r\nSglConnectivityJS.prototype = {\r\n\tget primitives() { return this._prims; },\r\n\r\n\taddArrayPrimitives : function(name, mode, first, count) {\r\n\t\tvar prim = new SglArrayPrimitiveStreamJS(name, mode, first, count)\r\n\t\tthis._prims[name] = prim;\r\n\t},\r\n\r\n\taddIndexedPrimitives : function(name, mode, indices, byCopy) {\r\n\t\tvar prim = new SglIndexedPrimitiveStreamJS(name, mode, indices, byCopy)\r\n\t\tthis._prims[name] = prim;\r\n\t},\r\n\r\n\tremovePrimitives : function(name) {\r\n\t\tif (!this._prims[name]) return;\r\n\t\tdelete this._prims[name];\r\n\t}\r\n};\r\n/***************************************************************/\r\n\r\n\r\n// SglMeshJS\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglMeshJS.\r\n * @class Mesh definition with vertex stream and primitive stream.\r\n */\r\nfunction SglMeshJS() {\r\n\tthis._valid = false;\r\n\tthis._vert  = new SglVertexStreamJS();\r\n\tthis._conn  = new SglConnectivityJS();\r\n}\r\n\r\nSglMeshJS.prototype = {\r\n\tget isValid()      { return this._valid;  },\r\n\tset isValid(value) { this._valid = value; },\r\n\r\n\tget vertices()     { return this._vert; },\r\n\tget connectivity() { return this._conn; },\r\n\r\n\taddVertexAttribute : function(name, size, values, byCopy) {\r\n\t\tthis._vert.addAttribute(name, size, values, byCopy);\r\n\t},\r\n\r\n\tremoveVertexAttribute : function(name) {\r\n\t\tthis._vert.removeAttribute(name);\r\n\t},\r\n\r\n\taddArrayPrimitives : function(name, mode, first, count) {\r\n\t\tthis._conn.addArrayPrimitives(name, mode, first, count);\r\n\t},\r\n\r\n\taddIndexedPrimitives : function(name, mode, indices, byCopy) {\r\n\t\tthis._conn.addIndexedPrimitives(name, mode, indices, byCopy);\r\n\t},\r\n\r\n\tremovePrimitives : function(name) {\r\n\t\tthis._conn.removePrimitives(name);\r\n\t}\r\n};\r\n/***************************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// importers\r\n/***********************************************************************/\r\nfunction sglMeshJSImportOBJFromString(mesh, text) {\r\n\tvar positionsArray = [ ];\r\n\tvar texcoordsArray = [ ];\r\n\tvar normalsArray   = [ ];\r\n\tvar indicesArray   = [ ];\r\n\r\n\tvar positions = [ ];\r\n\tvar texcoords = [ ];\r\n\tvar normals   = [ ];\r\n\tvar facemap   = { };\r\n\tvar index     = 0;\r\n\r\n\tvar line = null;\r\n\tvar f   = null;\r\n\tvar pos = 0;\r\n\tvar tex = 0;\r\n\tvar nor = 0;\r\n\tvar x   = 0.0;\r\n\tvar y   = 0.0;\r\n\tvar z   = 0.0;\r\n\tvar tokens = null;\r\n\r\n\tvar hasPos = false;\r\n\tvar hasTex = false;\r\n\tvar hasNor = false;\r\n\r\n\tvar lines = text.split(\"\\n\");\r\n\tfor (var lineIndex in lines) {\r\n\t\tline = lines[lineIndex].replace(/[ \\t]+/g, \" \").replace(/\\s\\s*$/, \"\");\r\n\r\n\t\tif (line[0] == \"#\") continue;\r\n\r\n\t\ttokens = line.split(\" \");\r\n\t\tif (tokens[0] == \"v\") {\r\n\t\t\tpositions.push(parseFloat(tokens[1]));\r\n\t\t\tpositions.push(parseFloat(tokens[2]));\r\n\t\t\tpositions.push(parseFloat(tokens[3]));\r\n\t\t}\r\n\t\telse if (tokens[0] == \"vt\") {\r\n\t\t\ttexcoords.push(parseFloat(tokens[1]));\r\n\t\t\ttexcoords.push(parseFloat(tokens[2]));\r\n\t\t}\r\n\t\telse if (tokens[0] == \"vn\") {\r\n\t\t\tnormals.push(parseFloat(tokens[1]));\r\n\t\t\tnormals.push(parseFloat(tokens[2]));\r\n\t\t\tnormals.push(parseFloat(tokens[3]));\r\n\t\t}\r\n\t\telse if (tokens[0] == \"f\") {\r\n\t\t\tif (tokens.length != 4) continue;\r\n\r\n\t\t\tfor (var i=1; i<4; ++i) {\r\n\t\t\t\tif (!(tokens[i] in facemap)) {\r\n\t\t\t\t\tf = tokens[i].split(\"/\");\r\n\r\n\t\t\t\t\tif (f.length == 1) {\r\n\t\t\t\t\t\tpos = parseInt(f[0]) - 1;\r\n\t\t\t\t\t\ttex = pos;\r\n\t\t\t\t\t\tnor = pos;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (f.length == 3) {\r\n\t\t\t\t\t\tpos = parseInt(f[0]) - 1;\r\n\t\t\t\t\t\ttex = parseInt(f[1]) - 1;\r\n\t\t\t\t\t\tnor = parseInt(f[2]) - 1;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tx = 0.0;\r\n\t\t\t\t\ty = 0.0;\r\n\t\t\t\t\tz = 0.0;\r\n\t\t\t\t\tif ((pos * 3 + 2) < positions.length) {\r\n\t\t\t\t\t\thasPos = true;\r\n\t\t\t\t\t\tx = positions[pos*3+0];\r\n\t\t\t\t\t\ty = positions[pos*3+1];\r\n\t\t\t\t\t\tz = positions[pos*3+2];\r\n\t\t\t\t\t}\r\n\t\t\t\t\tpositionsArray.push(x);\r\n\t\t\t\t\tpositionsArray.push(y);\r\n\t\t\t\t\tpositionsArray.push(z);\r\n\r\n\t\t\t\t\tx = 0.0;\r\n\t\t\t\t\ty = 0.0;\r\n\t\t\t\t\tif ((tex * 2 + 1) < texcoords.length) {\r\n\t\t\t\t\t\thasTex = true;\r\n\t\t\t\t\t\tx = texcoords[tex*2+0];\r\n\t\t\t\t\t\ty = texcoords[tex*2+1];\r\n\t\t\t\t\t}\r\n\t\t\t\t\ttexcoordsArray.push(x);\r\n\t\t\t\t\ttexcoordsArray.push(y);\r\n\r\n\t\t\t\t\tx = 0.0;\r\n\t\t\t\t\ty = 0.0;\r\n\t\t\t\t\tz = 1.0;\r\n\t\t\t\t\tif ((nor * 3 + 2) < normals.length) {\r\n\t\t\t\t\t\thasNor = true;\r\n\t\t\t\t\t\tx = normals[nor*3+0];\r\n\t\t\t\t\t\ty = normals[nor*3+1];\r\n\t\t\t\t\t\tz = normals[nor*3+2];\r\n\t\t\t\t\t}\r\n\t\t\t\t\tnormalsArray.push(x);\r\n\t\t\t\t\tnormalsArray.push(y);\r\n\t\t\t\t\tnormalsArray.push(z);\r\n\r\n\t\t\t\t\tfacemap[tokens[i]] = index++;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tindicesArray.push(facemap[tokens[i]]);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (hasPos) {\r\n\t\tmesh.addVertexAttribute(\"position\", 3, positionsArray, false);\r\n\t}\r\n\tif (hasNor) {\r\n\t\tmesh.addVertexAttribute(\"normal\", 3, normalsArray, false);\r\n\t}\r\n\tif (hasTex) {\r\n\t\tmesh.addVertexAttribute(\"texcoord\", 2, texcoordsArray, false);\r\n\t}\r\n\r\n\tif (indicesArray.length > 0) {\r\n\t\tmesh.addIndexedPrimitives(\"triangles\", SGL_TRIANGLES_LIST, indicesArray, false);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction sglMeshJSImportOBJFromURL(mesh, url, asynch, callback) {\r\n\tmesh.isValid = false;\r\n\r\n\tif (!asynch) {\r\n\t\tvar txt = sglLoadFile(url);\r\n\t\tmesh.isValid = sglMeshJSImportOBJFromString(mesh, txt);\r\n\t\tif (callback) {\r\n\t\t\tcallback(mesh, url);\r\n\t\t}\r\n\t\treturn mesh.isValid;\r\n\t}\r\n\r\n\tsglLoadFile(url, function(txt) {\r\n\t\tmesh.isValid = sglMeshJSImportOBJFromString(mesh, txt);\r\n\t\tif (callback) {\r\n\t\t\tcallback(mesh, url);\r\n\t\t}\r\n\t});\r\n\r\n\treturn true;\r\n}\r\n\r\nSglMeshJS.prototype.parseOBJ = function(txt) {\r\n\tthis.isValid = sglMeshJSImportOBJFromString(this, txt);\r\n\treturn this.isValid;\r\n};\r\n\r\nSglMeshJS.prototype.importOBJ = function(url, asynch, callback) {\r\n\treturn sglMeshJSImportOBJFromURL(this, url, asynch, callback);\r\n};\r\n\r\nfunction _sglFindVertexAttributeJSON(m, name) {\r\n\tfor (var a in m.vertices) {\r\n\t\tif (m.vertices[a].name === name) {\r\n\t\t\treturn m.vertices[a];\r\n\t\t}\r\n\t}\r\n\treturn null;\r\n}\r\n\r\nfunction _sglFindConnectivityJSON(m, name) {\r\n\tfor (var a in m.connectivity) {\r\n\t\tif (m.connectivity[a].name === name) {\r\n\t\t\treturn m.connectivity[a];\r\n\t\t}\r\n\t}\r\n\treturn null;\r\n}\r\n\r\nfunction sglMeshJSImportJSONFromString(mesh, text) {\r\n\tvar m = JSON.parse(text);\r\n\tif (!m) return false;\r\n\r\n\tvar mapping = m.mapping;\r\n\tvar stdMapping = null;\r\n\tfor (var v in mapping) {\r\n\t\tif (mapping[v].name === \"standard\") {\r\n\t\t\tstdMapping = mapping[v];\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\tif (!stdMapping) return false;\r\n\r\n\tfor (var a in stdMapping.attributes) {\r\n\t\tvar vm = stdMapping.attributes[a];\r\n\t\tvar vattr = _sglFindVertexAttributeJSON(m, vm.source);\r\n\t\tif (!vattr) continue;\r\n\t\tif (vattr.normalized) {\r\n\t\t\tfor (var i=0, n=vattr.values.length; i<n; ++i) {\r\n\t\t\t\tvattr.values[i] /= 255.0;\r\n\t\t\t}\r\n\t\t}\r\n\t\tmesh.addVertexAttribute(vm.semantic, vattr.size, vattr.values, false);\r\n\t}\r\n\r\n\tvar conn = _sglFindConnectivityJSON(m, stdMapping.primitives);\r\n\tif (!conn) return false;\r\n\tmesh.addIndexedPrimitives(conn.name, SGL_TRIANGLES_LIST, conn.indices, false);\r\n\r\n\treturn true;\r\n}\r\n\r\nfunction sglMeshJSImportJSONFromURL(mesh, url, asynch, callback) {\r\n\tmesh.isValid = false;\r\n\r\n\tif (!asynch) {\r\n\t\tvar txt = sglLoadFile(url);\r\n\t\tmesh.isValid = sglMeshJSImportJSONFromString(mesh, txt);\r\n\t\tif (callback) {\r\n\t\t\tcallback(mesh, url);\r\n\t\t}\r\n\t\treturn mesh.isValid;\r\n\t}\r\n\r\n\tsglLoadFile(url, function(txt) {\r\n\t\tmesh.isValid = sglMeshJSImportJSONFromString(mesh, txt);\r\n\t\tif (callback) {\r\n\t\t\tcallback(mesh, url);\r\n\t\t}\r\n\t});\r\n\r\n\treturn true;\r\n}\r\n\r\nSglMeshJS.prototype.parseJSON = function(txt) {\r\n\tthis.isValid = sglMeshJSImportJSONFromString(this, txt);\r\n\treturn this.isValid;\r\n};\r\n\r\nSglMeshJS.prototype.importJSON = function(url, asynch, callback) {\r\n\treturn sglMeshJSImportJSONFromURL(this, url, asynch, callback);\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// utilities\r\n/***************************************************************/\r\nfunction sglGLTypeSize(gl, type) {\r\n\tif (type == gl.BYTE)           return 1;\r\n\tif (type == gl.UNSIGNED_BYTE)  return 1;\r\n\tif (type == gl.SHORT)          return 2;\r\n\tif (type == gl.UNSIGNED_SHORT) return 2;\r\n\tif (type == gl.INT)            return 4;\r\n\tif (type == gl.UNSIGNED_INT)   return 4;\r\n\tif (type == gl.FLOAT)          return 4;\r\n\treturn null;\r\n}\r\n\r\nfunction sglGLTypeFromWebGLArray(gl, wglArray) {\r\n\tif (wglArray instanceof Int8Array   ) return gl.BYTE;\r\n\tif (wglArray instanceof Uint8Array  ) return gl.UNSIGNED_BYTE;\r\n\tif (wglArray instanceof Int16Array  ) return gl.SHORT;\r\n\tif (wglArray instanceof Uint16Array ) return gl.UNSIGNED_SHORT;\r\n\tif (wglArray instanceof Int32Array  ) return gl.INT;\r\n\tif (wglArray instanceof Uint32Array ) return gl.UNSIGNED_INT;\r\n\tif (wglArray instanceof Float32Array) return gl.FLOAT;\r\n\treturn null;\r\n}\r\n/***************************************************************/\r\n\r\n\r\n// SglAttributeStreamGL\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglAttributeStreamGL.\r\n * @class Holds the properties and the storage buffer of a vertex attribute stream.\r\n */\r\nfunction SglAttributeStreamGL(gl, name, size, values, normalized) {\r\n\tvar type   = sglGLTypeFromWebGLArray(gl, values);\r\n\tvar stride = sglGLTypeSize(gl, type) * size;\r\n\r\n\tthis.gl      = gl;\r\n\tthis._name   = name;\r\n\tthis._size   = size;\r\n\tthis._type   = type;\r\n\tthis._norm   = (normalized) ? (true) : (false);\r\n\tthis._stride = stride;\r\n\tthis._offset = 0;\r\n\tthis._length = values.length / size;\r\n\tthis._buff   = new SglVertexBuffer(gl, values, { usage : gl.STATIC_DRAW });\r\n}\r\n\r\nSglAttributeStreamGL.prototype = {\r\n\tget name()         { return this._name;   },\r\n\tget size()         { return this._size;   },\r\n\tget type()         { return this._type;   },\r\n\tget isNormalized() { return this._norm;   },\r\n\tget stride()       { return this._stride; },\r\n\tget offset()       { return this._offset; },\r\n\tget buffer()       { return this._buff;   },\r\n\tget length()       { return this._length; },\r\n\r\n\tdestroy : function() {\r\n\t\tthis._buff.destroy();\r\n\t},\r\n\r\n\tbind : function(index, baseVertex) {\r\n\t\tvar off = ((baseVertex) ? (baseVertex) : (0)) * this._stride;\r\n\t\tthis._buff.bind();\r\n\t\tthis.gl.vertexAttribPointer(index, this._size, this._type, this._norm, this._stride, this._offset + off);\r\n\t},\r\n\r\n\tunbind : function(index) {\r\n\t\tthis._buff.unbind();\r\n\t}\r\n};\r\n/***************************************************************/\r\n\r\n\r\n// SglVertexStreamGL\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglVertexStreamGL.\r\n * @class Container of vertex attribute streams.\r\n */\r\nfunction SglVertexStreamGL(gl) {\r\n\tthis.gl       = gl;\r\n\tthis._attribs = new Object();\r\n\tthis._length  = 0;\r\n}\r\n\r\nSglVertexStreamGL.prototype = {\r\n\tget attributes() { return this._attribs; },\r\n\tget length()     { return this._length;  },\r\n\r\n\tdestroy : function() {\r\n\t\tfor (var attr in this._attribs) {\r\n\t\t\tthis._attribs[attr].destroy();\r\n\t\t}\r\n\t},\r\n\r\n\taddAttribute : function(name, size, normalized, values) {\r\n\t\tvar attr = new SglAttributeStreamGL(this.gl, name, size, normalized, values)\r\n\t\tthis._attribs[name] = attr;\r\n\t\tthis._length = attr.length;\r\n\t},\r\n\r\n\tremoveAttribute : function(name, doDestroy) {\r\n\t\tif (!this._attribs[name]) return;\r\n\r\n\t\tif (doDestroy) {\r\n\t\t\tthis._attribs[name].destroy();\r\n\t\t}\r\n\r\n\t\tdelete this._attribs[name];\r\n\r\n\t\tthis._length = 0;\r\n\t\tfor (var a in this._attribs) {\r\n\t\t\tthis._length = this._attribs[a].length;\r\n\t\t\tbreak;\r\n\t\t}\r\n\t},\r\n\r\n\tbind : function(mapping, baseVertex) {\r\n\t\tvar vm = null;\r\n\t\tfor (var m in mapping) {\r\n\t\t\tvm = this._attribs[m];\r\n\t\t\tif (vm) {\r\n\t\t\t\tvm.bind(mapping[m], baseVertex)\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\tunbind : function(mapping) {\r\n\t\tvar vm = null;\r\n\t\tfor (var m in mapping) {\r\n\t\t\tvm = this._attribs[m];\r\n\t\t\tif (vm) {\r\n\t\t\t\tvm.unbind(mapping[m])\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n};\r\n/***************************************************************/\r\n\r\n\r\n// SglPrimitiveStreamGL\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglPrimitiveStreamGL.\r\n * @class Holds the primitives stream information and storage (if any).\r\n */\r\nfunction SglPrimitiveStreamGL(gl, name, mode, first, length) {\r\n\tthis.gl      = gl;\r\n\tthis._name   = name;\r\n\tthis._mode   = mode;\r\n\tthis._first  = (first)  ? (first)  : (0);\r\n\tthis._length = (length) ? (length) : (0);\r\n}\r\n\r\nSglPrimitiveStreamGL.prototype = {\r\n\t_clampRange : function(first, count) {\r\n\t\tvar end = this._first + this._length;\r\n\r\n\t\tvar f = this._first + ((first >= 0) ? (first) : (0));\r\n\t\tif (f >= end) return null;\r\n\r\n\t\tvar c = (count >= 0) ? (count) : (this._length);\r\n\t\tvar vEnd = (f + c);\r\n\t\tif (vEnd > end) c -= vEnd - end;\r\n\r\n\t\treturn [f, c];\r\n\t},\r\n\r\n\t_render : function(first, count) {\r\n\t\t;\r\n\t},\r\n\r\n\tget type()   { return undefined;    },\r\n\tget name()   { return this._name;   },\r\n\tget mode()   { return this._mode;   },\r\n\tget first()  { return this._first;  },\r\n\tget length() { return this._length; },\r\n\r\n\tdestroy : function() {\r\n\t\tif (this._destroy) {\r\n\t\t\tthis._destroy();\r\n\t\t}\r\n\t},\r\n\r\n\tbind : function() {\r\n\t\t;\r\n\t},\r\n\r\n\tunbind : function() {\r\n\t\t;\r\n\t},\r\n\r\n\trender : function(first, count) {\r\n\t\tvar range = this._clampRange(first, count);\r\n\t\tthis._render(range[0], range[1]);\r\n\t}\r\n}\r\n/***************************************************************/\r\n\r\n\r\n// SglArrayPrimitiveStreamGL\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglArrayPrimitiveStreamGL.\r\n * @class Holds the array primitive stream information.\r\n */\r\nfunction SglArrayPrimitiveStreamGL(gl, name, mode, first, count) {\r\n\tSglPrimitiveStreamGL.call(this, gl, name, mode, first, count);\r\n\tObject.defineProperty(this, \"type\", {get: function(){return SGL_ARRAY_PRIMITIVE_STREAM;}});\r\n}\r\n\r\nsglInherit(SglArrayPrimitiveStreamGL, SglPrimitiveStreamGL);\r\n\r\n/*sglDefineGetter(SglArrayPrimitiveStreamGL, \"type\", function() {\r\n\treturn SGL_ARRAY_PRIMITIVE_STREAM;\r\n});*/\r\n\r\n\r\n\r\nSglArrayPrimitiveStreamGL.prototype._render = function(first, count) {\r\n\tthis.gl.drawArrays(this._mode, first, count);\r\n}\r\n/***************************************************************/\r\n\r\n\r\n// SglIndexedPrimitiveStreamGL\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglIndexedPrimitiveStreamGL.\r\n * @class Holds the indexed primitive stream information and storage.\r\n */\r\nfunction SglIndexedPrimitiveStreamGL(gl, name, mode, indices) {\r\n\tSglPrimitiveStreamGL.call(this, gl, name, mode, 0, indices.length);\r\n\r\n\tvar type   = sglGLTypeFromWebGLArray(gl, indices);\r\n\tvar stride = sglGLTypeSize(gl, type);\r\n\r\n\tthis._idxType = type;\r\n\tthis._stride  = stride;\r\n\tthis._buff    = new SglIndexBuffer(gl, indices, { usage : gl.STATIC_DRAW });\r\n\t\r\n\tObject.defineProperty(this, \"indexType\", {get: function(){return this._idxType;}});\r\n\tObject.defineProperty(this, \"stride\", {get: function(){return this._stride;}});\r\n\tObject.defineProperty(this, \"type\", {get: function(){return SGL_INDEXED_PRIMITIVE_STREAM;}});\r\n}\r\n\r\n\r\nsglInherit(SglIndexedPrimitiveStreamGL, SglPrimitiveStreamGL);\r\n\r\n/*sglDefineGetter(SglIndexedPrimitiveStreamGL, \"indexType\", function() {\r\n\treturn this._idxType;\r\n});\r\n\r\nsglDefineGetter(SglIndexedPrimitiveStreamGL, \"stride\", function() {\r\n\treturn this._stride;\r\n});\r\n\r\nsglDefineGetter(SglIndexedPrimitiveStreamGL, \"type\", function() {\r\n\treturn SGL_INDEXED_PRIMITIVE_STREAM;\r\n});*/\r\n\r\nSglIndexedPrimitiveStreamGL.prototype._destroy = function() {\r\n\tthis._buff.destroy();\r\n\tthis._buff = null;\r\n}\r\n\r\nSglIndexedPrimitiveStreamGL.prototype.bind = function() {\r\n\tthis._buff.bind();\r\n}\r\n\r\nSglIndexedPrimitiveStreamGL.prototype.unbind = function() {\r\n\tthis._buff.unbind();\r\n}\r\n\r\nSglIndexedPrimitiveStreamGL.prototype._render = function(first, count) {\r\n\tthis.gl.drawElements(this._mode, count, this._idxType, first * this._stride);\r\n}\r\n\r\n\r\n\r\n/***************************************************************/\r\n\r\n\r\n// SglPackedIndexedPrimitiveStreamGL\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglPackedIndexedPrimitiveStream.\r\n * @class Holds the packed indexed primitive stream information and storage.\r\n */\r\nfunction SglPackedIndexedPrimitiveStreamGL(gl, name, mode, indices, blockStartingIndices, blockStartingVertices) {\r\n\tif (blockStartingIndices.length != blockStartingVertices.length) {\r\n\t\tsglInvalidParameter();\r\n\t}\r\n\r\n\tSglPrimitiveStreamGL.call(this, gl, name, mode, 0, indices.length);\r\n\r\n\tvar type   = sglGLTypeFromWebGLArray(gl, indices);\r\n\tvar stride = sglGLTypeSize(gl, type);\r\n\r\n\tthis._idxType = type;\r\n\tthis._stride  = stride;\r\n\tthis._buff    = new SglIndexBuffer(gl, indices, { usage : gl.STATIC_DRAW });\r\n\r\n\r\n\tthis._blockStartingVertices = blockStartingVertices.slice();\r\n\tvar n = this._blockStartingVertices.length;\r\n\r\n\tthis._blockStartingIndices = blockStartingIndices.slice();\r\n\tthis._blockIndicesCount    = new Array(n);\r\n\r\n\tvar start = this._blockStartingIndices[0];\r\n\tfor (var i=0; i<(n-1); ++i) {\r\n\t\tvar sIdx = this._blockStartingIndices[i+1];\r\n\t\tthis._blockIndicesCount[i] = sIdx - start;\r\n\t\tstart = sIdx;\r\n\t}\r\n\tthis._blockIndicesCount[n-1] = indices.length - start;\r\n\t\r\n\tObject.defineProperty(this, \"isPacked\", {get: function(){return true;}});\r\n\tObject.defineProperty(this, \"indexType\", {get: function(){return this._idxType;}});\r\n\tObject.defineProperty(this, \"stride\", {get: function(){return this._stride;}});\r\n\tObject.defineProperty(this, \"type\", {get: function(){return SGL_PACKED_INDEXED_PRIMITIVE_STREAM;}});\r\n\tObject.defineProperty(this, \"blocksCount\", {get: function(){return this._blockStartingIndices.length;}});\r\n\tObject.defineProperty(this, \"blockStartingVertices\", {get: function(){return this._blockStartingVertices;}});\r\n\tObject.defineProperty(this, \"blockIndicesCount\", {get: function(){return this._blockIndicesCount;}});\r\n}\r\n\r\nsglInherit(SglPackedIndexedPrimitiveStreamGL, SglPrimitiveStreamGL);\r\n\r\n\r\nSglPackedIndexedPrimitiveStreamGL.prototype._destroy = function() {\r\n\tthis._buff.destroy();\r\n\tthis._buff = null;\r\n}\r\n\r\nSglPackedIndexedPrimitiveStreamGL.prototype.bind = function() {\r\n\tthis._buff.bind();\r\n}\r\n\r\nSglPackedIndexedPrimitiveStreamGL.prototype.unbind = function() {\r\n\tthis._buff.unbind();\r\n}\r\n\r\nSglPackedIndexedPrimitiveStreamGL.prototype._clampBlockRange = function(block, first, count) {\r\n\tvar end = this._blockStartingIndices[block] + this._blockIndicesCount[block];\r\n\r\n\tvar f = this._blockStartingIndices[block] + ((first >= 0) ? (first) : (0));\r\n\tif (f >= end) return null;\r\n\r\n\tvar c = (count >= 0) ? (count) : (this._blockIndicesCount[block]);\r\n\tvar vEnd = (f + c);\r\n\tif (vEnd > end) c -= vEnd - end;\r\n\r\n\treturn [f, c];\r\n}\r\n\r\nSglPackedIndexedPrimitiveStreamGL.prototype.blockRanges = function(first, count) {\r\n\tvar range = this._clampRange(first, count);\r\n\tvar n     = this._blockStartingIndices.length;\r\n\r\n\tvar firstBlock = 0;\r\n\twhile ((firstBlock < n) && (range[0] < this._blockStartingIndices[firstBlock])) {\r\n\t\tfirstBlock++;\r\n\t}\r\n\tif (firstBlock >= n) return null;\r\n\r\n\tvar last = range[0] + range[1] - 1;\r\n\tvar lastBlock = firstBlock;\r\n\twhile ((lastBlock < n) && (last >= (this._blockStartingIndices[lastBlock] + this._blockIndicesCount[lastBlock]))) {\r\n\t\tlastBlock++;\r\n\t}\r\n\tif (lastBlock >= n) lastBlock = n - 1;\r\n\r\n\tvar ranges = [ ];\r\n\tvar f = range[0] - this._blockStartingIndices[firstBlock];\r\n\tvar c = range[1];\r\n\tvar e = f + range[1];\r\n\tif (e > this._blockIndicesCount[firstBlock]) c = this._blockIndicesCount[firstBlock] - this._blockStartingIndices[firstBlock];\r\n\tranges.push([firstBlock, f, c, this._blockStartingVertices[firstBlock]]);\r\n\tfor (var i=firstBlock+1; i<lastBlock; ++i) {\r\n\t\tranges.push([i, 0, this._blockIndicesCount[i], this._blockStartingVertices[i]]);\r\n\t}\r\n\tif (lastBlock > firstBlock) {\r\n\t\tranges.push([i, 0, range[0] + range[1] - this._blockStartingIndices[lastBlock], this._blockStartingVertices[lastBlock]]);\r\n\t}\r\n\r\n\treturn ranges;\r\n}\r\n\r\nSglPackedIndexedPrimitiveStreamGL.prototype.renderBlock = function(block, first, count) {\r\n\tvar range = this._clampBlockRange(block, first, count);\r\n\tthis.gl.drawElements(this._mode, range[1], this._idxType, range[0] * this._stride);\r\n}\r\n/***************************************************************/\r\n\r\n\r\n// SglConnectivityGL\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglConnectivityGL.\r\n * @class Container of primitive streams.\r\n */\r\nfunction SglConnectivityGL(gl) {\r\n\tthis.gl     = gl;\r\n\tthis._prims = new Object();\r\n}\r\n\r\nSglConnectivityGL.prototype = {\r\n\tget primitives() { return this._prims; },\r\n\r\n\tdestroy : function() {\r\n\t\tfor (var prim in this._prims) {\r\n\t\t\tthis._prims[prim].destroy();\r\n\t\t}\r\n\t},\r\n\r\n\taddArrayPrimitives: function(name, mode, first, count) {\r\n\t\tvar prim = new SglArrayPrimitiveStreamGL(this.gl, name, mode, first, count)\r\n\t\tthis._prims[name] = prim;\r\n\t},\r\n\r\n\taddIndexedPrimitives : function(name, mode, indices) {\r\n\t\tvar prim = new SglIndexedPrimitiveStreamGL(this.gl, name, mode, indices)\r\n\t\tthis._prims[name] = prim;\r\n\t},\r\n\r\n\taddPackedIndexedPrimitives : function(name, mode, indices, blockStartingIndices, blockStartingVertices) {\r\n\t\tvar prim = new SglPackedIndexedPrimitiveStreamGL(this.gl, name, mode, indices, blockStartingIndices, blockStartingVertices)\r\n\t\tthis._prims[name] = prim;\r\n\t},\r\n\r\n\tremovePrimitives : function(name, doDestroy) {\r\n\t\tif (!this._prims[name]) return;\r\n\r\n\t\tif (doDestroy) {\r\n\t\t\tthis._prims[name].destroy();\r\n\t\t}\r\n\r\n\t\tdelete this._prims[name];\r\n\t}\r\n};\r\n/***************************************************************/\r\n\r\n\r\n// SglMeshGL\r\n/***************************************************************/\r\n/**\r\n * Constructs a SglMeshGL.\r\n * @class Mesh definition with vertex stream and primitive stream.\r\n */\r\nfunction SglMeshGL(gl) {\r\n\tthis.gl    = gl;\r\n\tthis._vert = new SglVertexStreamGL(this.gl);\r\n\tthis._conn = new SglConnectivityGL(this.gl);\r\n}\r\n\r\nSglMeshGL.prototype = {\r\n\tget vertices()     { return this._vert; },\r\n\tget connectivity() { return this._conn; },\r\n\r\n\tdestroy : function() {\r\n\t\tthis._vert.destroy();\r\n\t\tthis._conn.destroy();\r\n\t},\r\n\r\n\taddVertexAttribute : function(name, size, values, normalized) {\r\n\t\tthis._vert.addAttribute(name, size, values, normalized);\r\n\t},\r\n\r\n\tremoveVertexAttribute : function(name, doDestroy) {\r\n\t\tthis._vert.removeAttribute(name, doDestroy);\r\n\t},\r\n\r\n\taddArrayPrimitives : function(name, mode, first, count) {\r\n\t\tthis._conn.addArrayPrimitives(name, mode, first, count);\r\n\t},\r\n\r\n\taddIndexedPrimitives : function(name, mode, indices) {\r\n\t\tthis._conn.addIndexedPrimitives(name, mode, indices);\r\n\t},\r\n\r\n\taddPackedIndexedPrimitives : function(name, mode, indices, blockStartingIndices, blockStartingVertices) {\r\n\t\tthis._conn.addPackedIndexedPrimitives(name, mode, indices, blockStartingIndices, blockStartingVertices);\r\n\t},\r\n\r\n\tremovePrimitives : function(name, doDestroy) {\r\n\t\tthis._conn.removePrimitives(name, doDestroy);\r\n\t}\r\n};\r\n/***************************************************************/\r\n\r\n\r\n// SglMeshRenderer\r\n/***************************************************************/\r\nvar SGL_DefaultStreamMappingPrefix = \"a_\";\r\n\r\n/**\r\n * Constructs a SglMeshGLRenderer.\r\n * @class Takes charge of mesh rendering, including program attributes, uniforms and samplers bindings.\r\n */\r\nfunction SglMeshGLRenderer(program, doSynchronize) {\r\n\tthis._prog        = program;\r\n\tthis._mapping     = null;\r\n\tthis._meshAttrMap = null;\r\n\tthis._mesh        = null;\r\n\tthis._primStream  = null;\r\n\tthis._phase       = 0;\r\n\r\n\tthis._updateEnabledVB = false;\r\n\r\n\tif (doSynchronize) {\r\n\t\tthis.synchronizeProgram();\r\n\t}\r\n\r\n\tthis.setStreamMapping();\r\n}\r\n\r\nSglMeshGLRenderer.prototype = {\r\n\t_bindVertexBuffers : function(baseVertex) {\r\n\t\tthis._mesh.vertices.bind(this._meshAttrMap, baseVertex);\r\n\t},\r\n\r\n\t_unbindVertexBuffers : function() {\r\n\t\tthis._mesh.vertices.unbind(this._meshAttrMap);\r\n\t},\r\n\r\n\tget program() { return this.prog; },\r\n\r\n\tsynchronizeProgram : function() {\r\n\t\tthis._prog.synchronize();\r\n\r\n\t\tvar doLink = false;\r\n\t\tvar index = 0;\r\n\t\tvar attr = null;\r\n\t\tfor (var a in this._prog.attributes) {\r\n\t\t\tattr = this._prog.attributes[a];\r\n\t\t\tif (attr.index != index) {\r\n\t\t\t\tattr.index = index;\r\n\t\t\t\tdoLink = true;\r\n\t\t\t}\r\n\t\t\tindex++;\r\n\t\t}\r\n\t\tif (doLink) {\r\n\t\t\tthis._prog.link();\r\n\t\t}\r\n\r\n\t\tvar unit = 0;\r\n\t\tvar smp = null;\r\n\t\tfor (var s in this._prog.samplers) {\r\n\t\t\tsmp = this._prog.samplers[s];\r\n\t\t\tsmp.unit = unit;\r\n\t\t\tunit++;\r\n\t\t}\r\n\t},\r\n\r\n\tgetStreamMappingFromPrefix : function(prefix) {\r\n\t\tvar n = prefix.length;\r\n\t\tvar mapping = new Object();\r\n\t\tvar src = null;\r\n\t\tfor (var attr in this._prog.attributes) {\r\n\t\t\tif (attr.substr(0, n) == prefix) {\r\n\t\t\t\tsrc = attr.substr(n);\r\n\t\t\t\tif (src.length > 0) {\r\n\t\t\t\t\tmapping[attr] = src;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn mapping;\r\n\t},\r\n\r\n\tsetStreamMapping : function(mapping) {\r\n\t\t//if ((this._phase != 0) && (this._phase != 1)) return;\r\n\r\n\t\tthis._updateEnabledVB = true;\r\n\r\n\t\tvar meshAttrName = null;\r\n\r\n\t\tthis._mapping = this.getStreamMappingFromPrefix(SGL_DefaultStreamMappingPrefix);\r\n\t\tfor (var progAttrName in mapping) {\r\n\t\t\tmeshAttrName = mapping[progAttr];\r\n\t\t\tif (this._prog.attributes[progAttrName]) {\r\n\t\t\t\tthis._mapping[progAttrName] = meshAttrName;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis._meshAttrMap = { };\r\n\t\tvar progAttr = null;\r\n\t\tfor (var progAttrName in this._mapping) {\r\n\t\t\tmeshAttrName = this._mapping[progAttrName];\r\n\t\t\tprogAttr     = this._prog.attributes[progAttrName];\r\n\t\t\tthis._meshAttrMap[meshAttrName] = progAttr.index;\r\n\t\t}\r\n\r\n\t\tif (this._mesh) {\r\n\t\t\tthis._bindVertexBuffers(0);\r\n\t\t}\r\n\t},\r\n\r\n\tsetStreamMappingFromPrefix : function(prefix) {\r\n\t\tif (!prefix) prefix = SGL_DefaultStreamMappingPrefix;\r\n\t\tvar mapping = this.getStreamMappingFromPrefix(prefix);\r\n\t\tthis.setStreamMapping(mapping);\r\n\t},\r\n\r\n\tsetUniforms : function(mapping) {\r\n\t\tif (this._phase == 0) return;\r\n\t\tthis._prog.setUniforms(mapping);\r\n\t},\r\n\r\n\tsetSamplers : function(mapping) {\r\n\t\tif (this._phase == 0) return;\r\n\r\n\t\tvar samplers = { };\r\n\t\tvar textures = { };\r\n\r\n\t\tvar t = null;\r\n\t\tfor (var s in mapping) {\r\n\t\t\tt = mapping[s];\r\n\t\t\tif (typeof(t) == \"number\") {\r\n\t\t\t\tsamplers[s] = t;\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\ttextures[s] = t;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis._prog.setSamplers(samplers);\r\n\r\n\t\tvar smp = null;\r\n\t\tfor (var s in textures) {\r\n\t\t\tsmp = this._prog.samplers[s];\r\n\t\t\tif (smp) {\r\n\t\t\t\ttextures[s].bind(smp.unit);\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\tbegin : function() {\r\n\t\tif (this._phase != 0) return;\r\n\t\t/*\r\n\t\tvar gl = this._prog.gl;\r\n\t\tfor (var a in this._prog.attributes) {\r\n\t\t\tgl.enableVertexAttribArray(this._prog.attributes[a].index);\r\n\t\t}\r\n\t\t*/\r\n\t\tthis._prog.bind();\r\n\t\tthis._phase = 1;\r\n\t},\r\n\r\n\tend : function() {\r\n\t\tif (this._phase != 1) return;\r\n\t\tthis._prog.unbind();\r\n\t\tvar gl = this._prog.gl;\r\n\t\tfor (var a in this._prog.attributes) {\r\n\t\t\tgl.disableVertexAttribArray(this._prog.attributes[a].index);\r\n\t\t}\r\n\t\tthis._phase = 0;\r\n\t},\r\n\r\n\tbeginMesh : function(mesh) {\r\n\t\tif (this._phase != 1) return;\r\n\t\tthis._updateEnabledVB = true;\r\n\t\tthis._mesh = mesh;\r\n\t\tthis._bindVertexBuffers(0);\r\n\t\tthis._phase = 2;\r\n\t},\r\n\r\n\tendMesh : function() {\r\n\t\tif (this._phase != 2) return;\r\n\t\tthis._unbindVertexBuffers();\r\n\t\tthis._prog.gl.bindBuffer(this._prog.gl.ARRAY_BUFFER, null);\r\n\t\tthis._mesh = null;\r\n\t\tthis._phase = 1;\r\n\t},\r\n\r\n\tbeginPrimitives : function(name) {\r\n\t\tif (this._phase != 2) return;\r\n\t\tthis._primStream = this._mesh.connectivity.primitives[name];\r\n\t\tthis._primStream.bind();\r\n\t\tthis._phase = 3;\r\n\t},\r\n\r\n\tendPrimitives : function() {\r\n\t\tif (this._phase != 3) return;\r\n\t\tthis._primStream.unbind();\r\n\t\tthis._primStream = null;\r\n\t\tthis._phase = 2;\r\n\t},\r\n\r\n\trender : function(first, count) {\r\n\t\tif (this._phase != 3) return;\r\n\r\n\t\tvar gl = this._prog.gl;\r\n\t\tvar vIndex = 0;\r\n\r\n\t\tif (this._updateEnabledVB) {\r\n\t\t\tthis._updateEnabledVB = false;\r\n\t\t\tfor (var progAttr in this._mapping) {\r\n\t\t\t\tvIndex = this._prog.attributes[progAttr].index;\r\n\t\t\t\tif (this._mesh.vertices.attributes[this._mapping[progAttr]]) {\r\n\t\t\t\t\tgl.enableVertexAttribArray(vIndex);\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\tgl.disableVertexAttribArray(vIndex);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (this._primStream.isPacked) {\r\n\t\t\tif (this._primStream.blocksCount > 0) {\r\n\t\t\t\tvar blocks = this._primStream.blockRanges(first, count);\r\n\t\t\t\tvar n = blocks.length;\r\n\t\t\t\tfor (var i=0; i<n; ++i) {\r\n\t\t\t\t\tthis._bindVertexBuffers(blocks[i][3]);\r\n\t\t\t\t\tthis._primStream.renderBlock(blocks[i][0], blocks[i][1], blocks[i][2]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\telse {\r\n\t\t\tthis._primStream.render(first, count);\r\n\t\t}\r\n\t},\r\n\r\n\trenderMeshPrimitives : function(mesh, name, first, count) {\r\n\t\tthis.beginMesh(mesh);\r\n\t\t\tthis.beginPrimitives(name);\r\n\t\t\t\tthis.render(first, count);\r\n\t\t\tthis.endPrimitives();\r\n\t\tthis.endMesh();\r\n\t}\r\n};\r\n\r\nfunction sglRenderMeshGLPrimitives(mesh, name, program, streamMapping, uniforms, samplers, first, count) {\r\n\tvar renderer = new SglMeshGLRenderer(program);\r\n\trenderer.begin();\r\n\tif (streamMapping) renderer.setStreamMapping (streamMapping);\r\n\tif (uniforms     ) renderer.setUniforms      (uniforms     );\r\n\tif (samplers     ) renderer.setSamplers      (samplers     );\r\n\tif (name) {\r\n\t\trenderer.renderMeshPrimitives(mesh, name, first, count);\r\n\t}\r\n\telse {\r\n\t\tvar primitives = mesh.connectivity.primitives;\r\n\t\tfor (var p in primitives) {\r\n\t\t\trenderer.renderMeshPrimitives(mesh, p, first, count);\r\n\t\t}\r\n\t}\r\n}\r\n/***************************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// utilities\r\n/***********************************************************************/\r\nfunction sglMeshJSCalculateBBox(meshJS, attribName) {\r\n\tvar attrn     = attribName || \"position\";\r\n\r\n\tvar posAttrib = meshJS.vertices.attributes[attrn];\r\n\tvar posSize   = posAttrib.size;\r\n\tvar posBuffer = posAttrib.buffer;\r\n\r\n\tvar bbox = new SglBox3();\r\n\tif (posSize != 3) return bbox;\r\n\r\n\tvar n = posBuffer.length / posSize;\r\n\tif (n <= 0) return bbox;\r\n\r\n\tn *= posSize;\r\n\r\n\tfor (var j=0; j<posSize; ++j) {\r\n\t\tbbox.min[j] = posBuffer[j];\r\n\t\tbbox.max[j] = posBuffer[j];\r\n\t}\r\n\r\n\tvar val = 0.0;\r\n\tfor (var i=posSize; i<n; i+=posSize) {\r\n\t\tfor (var j=0; j<posSize; ++j) {\r\n\t\t\tval = posBuffer[i+j];\r\n\t\t\tif (bbox.min[j] > val) bbox.min[j] = val;\r\n\t\t\tif (bbox.max[j] < val) bbox.max[j] = val;\r\n\t\t}\r\n\t}\r\n\r\n\treturn bbox;\r\n}\r\n\r\nSglMeshJS.prototype.calculateBoundingBox = function(attribName) {\r\n\treturn sglMeshJSCalculateBBox(this, attribName);\r\n};\r\n\r\nfunction sglGLPrimitiveType(gl, primType) {\r\n\tswitch (primType) {\r\n\t\tcase SGL_POINTS_LIST    : return gl.POINTS;         break;\r\n\t\tcase SGL_LINES_LIST     : return gl.LINES;          break;\r\n\t\tcase SGL_LINE_STRIP     : return gl.LINE_STRIP;     break;\r\n\t\tcase SGL_LINE_LOOP      : return gl.LINE_LOOP;      break;\r\n\t\tcase SGL_TRIANGLES_LIST : return gl.TRIANGLES;      break;\r\n\t\tcase SGL_TRIANGLE_STRIP : return gl.TRIANGLE_STRIP; break;\r\n\t\tcase SGL_TRIANGLE_FAN   : return gl.TRIANGLE_FAN;   break;\r\n\t\tdefault                 : return undefined;         break;\r\n\t}\r\n\treturn undefined;\r\n}\r\n\r\nfunction sglMeshJStoGL(gl, meshJS) {\r\n\tvar meshGL = new SglMeshGL(gl);\r\n\r\n\tfor (a in meshJS.vertices.attributes) {\r\n\t\tvar attr = meshJS.vertices.attributes[a];\r\n\t\tmeshGL.addVertexAttribute(attr.name, attr.size, new Float32Array(attr.buffer));\r\n\t}\r\n\r\n\tfor (p in meshJS.connectivity.primitives) {\r\n\t\tvar prim = meshJS.connectivity.primitives[p];\r\n\t\tvar ptype = sglGLPrimitiveType(meshGL.gl, prim.mode);\r\n\t\tif (ptype == undefined) continue;\r\n\r\n\t\tswitch (prim.type) {\r\n\t\t\tcase SGL_ARRAY_PRIMITIVE_STREAM :\r\n\t\t\t\tmeshGL.addArrayPrimitives(prim.name, ptype, prim.first, prim.length);\r\n\t\t\tbreak;\r\n\t\t\tcase SGL_INDEXED_PRIMITIVE_STREAM :\r\n\t\t\t\tmeshGL.addIndexedPrimitives(prim.name, ptype, new Uint16Array(prim.buffer));\r\n\t\t\tbreak;\r\n\t\t\tdefault :\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\treturn meshGL;\r\n}\r\n\r\nSglMeshJS.prototype.toMeshGL = function(gl) {\r\n\treturn sglMeshJStoGL(gl, this);\r\n};\r\n\r\nfunction sglPackMeshJStoGL(gl, mesh, primitives, maxVertexIndex) {\r\n\tvar primName = primitives     || \"triangles\";\r\n\tvar maxInd   = maxVertexIndex || 65000;\r\n\r\n\tvar prim = mesh.connectivity.primitives[primName];\r\n\r\n\tif (!prim) return null;\r\n\tif (prim.type != SGL_INDEXED_PRIMITIVE_STREAM) return null;\r\n\r\n\tvar pmode = sglGLPrimitiveType(gl, prim.mode);\r\n\tif (pmode == undefined) return null;\r\n\r\n\tvar ariety   = 0;\r\n\tif (pmode === gl.TRIANGLES) {\r\n\t\tariety = 3;\r\n\t}\r\n\telse if (pmode === gl.LINES) {\r\n\t\tariety = 2;\r\n\t}\r\n\telse if (pmode === gl.POINTS) {\r\n\t\tariety = 1;\r\n\t}\r\n\telse {\r\n\t\treturn null;\r\n\t}\r\n\r\n\tvar res   = [ ];\r\n\r\n\tvar srcIndices = prim.buffer;\r\n\tvar n          = srcIndices.length;\r\n\tn -= (n % ariety);\r\n\r\n\tvar start = 0;\r\n\r\n\tvar startVertex = 0;\r\n\tvar startIndex  = 0;\r\n\tvar startVertices = [ ];\r\n\tvar startIndices  = [ ];\r\n\r\n\tvar newIndices = [ ];\r\n\tvar newAttribs = { };\r\n\tfor (var a in mesh.vertices.attributes) {\r\n\t\tvar attr  = mesh.vertices.attributes[a];\r\n\t\tnewAttribs[a] = {\r\n\t\t\tname   : attr.name,\r\n\t\t\tsize   : attr.size,\r\n\t\t\tbuffer : [ ]\r\n\t\t};\r\n\t}\r\n\r\n\twhile (start < n) {\r\n\t\tvar indicesMap = { };\r\n\t\tvar dstIndices = [ ];\r\n\t\tvar vtxCount = 0;\r\n\r\n\t\tvar indicesMap = { };\r\n\t\tvar vtxCount   = 0;\r\n\t\tfor (var i=start; i<n; i+=ariety) {\r\n\t\t\tvar triIndices       = { };\r\n\t\t\tvar newVerticesCount = 0;\r\n\t\t\tfor (var j=0; j<ariety; ++j) {\r\n\t\t\t\tvar srcIdx = srcIndices[i+j];\r\n\t\t\t\tif (triIndices[srcIdx] == undefined) {\r\n\t\t\t\t\ttriIndices[srcIdx] = true;\r\n\t\t\t\t\tif (indicesMap[srcIdx] == undefined) {\r\n\t\t\t\t\t\tnewVerticesCount++;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif ((vtxCount + newVerticesCount) <= maxInd) {\r\n\t\t\t\tfor (var j=0; j<ariety; ++j) {\r\n\t\t\t\t\tvar srcIdx = srcIndices[i+j];\r\n\t\t\t\t\tvar dstIdx = indicesMap[srcIdx];\r\n\t\t\t\t\tif (dstIdx == undefined) {\r\n\t\t\t\t\t\tindicesMap[srcIdx] = vtxCount;\r\n\t\t\t\t\t\tdstIdx = vtxCount;\r\n\t\t\t\t\t\tvtxCount++;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tdstIndices.push(dstIdx);\r\n\t\t\t\t}\r\n\t\t\t\tstart += ariety;\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (vtxCount <= 0) break;\r\n\r\n\t\tvar idxCount = dstIndices.length;\r\n\r\n\t\tfor (var a in mesh.vertices.attributes) {\r\n\t\t\tvar srcAttr  = mesh.vertices.attributes[a];\r\n\t\t\tvar dstAttr  = newAttribs[a];\r\n\t\t\tvar asize    = srcAttr.size;\r\n\t\t\tvar dstBase  = dstAttr.buffer.length;\r\n\t\t\tvar newArr   = new Array(vtxCount * asize);\r\n\t\t\tdstAttr.buffer = dstAttr.buffer.concat(newArr);\r\n\r\n\t\t\tvar srcBuff = srcAttr.buffer;\r\n\t\t\tvar dstBuff = dstAttr.buffer;\r\n\t\t\tfor (var i in indicesMap) {\r\n\t\t\t\tvar dstIdx = indicesMap[i];\r\n\t\t\t\tfor (var c=0; c<asize; ++c) {\r\n\t\t\t\t\tdstBuff[dstBase + (dstIdx*asize+c)] = srcBuff[i*asize+c];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tnewIndices = newIndices.concat(dstIndices);\r\n\r\n\t\tstartVertices.push(startVertex);\r\n\t\tstartIndices.push(startIndex);\r\n\r\n\t\tstartVertex += vtxCount;\r\n\t\tstartIndex  += idxCount;\r\n\t}\r\n\r\n\tvar m = new SglMeshGL(gl);\r\n\r\n\tfor (var a in newAttribs) {\r\n\t\tvar attr = newAttribs[a];\r\n\t\tm.addVertexAttribute(attr.name, attr.size, new Float32Array(attr.buffer));\r\n\t}\r\n\r\n\tif (startVertices.length == 1) {\r\n\t\tm.addIndexedPrimitives(primName, pmode, new Uint16Array(newIndices));\r\n\t}\r\n\telse {\r\n\t\tm.addPackedIndexedPrimitives(primName, pmode, new Uint16Array(newIndices), startIndices, startVertices);\r\n\t}\r\n\r\n\treturn m;\r\n}\r\n\r\nSglMeshJS.prototype.toPackedMeshGL = function(gl, primitives, maxVertexIndex) {\r\n\treturn sglPackMeshJStoGL(gl, this, primitives, maxVertexIndex);\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// SglTrackball\r\n/***********************************************************************/\r\nvar SGL_TRACKBALL_NO_ACTION = 0;\r\nvar SGL_TRACKBALL_ROTATE    = 1;\r\nvar SGL_TRACKBALL_PAN       = 2;\r\nvar SGL_TRACKBALL_DOLLY     = 3;\r\nvar SGL_TRACKBALL_SCALE     = 4;\r\n\r\n/**\r\n * Constructs a SglTrackball object.\r\n * @class Interactor which implements a typical trackball controller.\r\n */\r\nfunction SglTrackball() {\r\n\tthis._matrix = sglIdentityM4();\r\n\tthis._pts    = [ [0.0, 0.0], [0.0, 0.0] ];\r\n\tthis._action = SGL_TRACKBALL_NO_ACTION;\r\n\r\n\tthis.reset();\r\n}\r\n\r\nSglTrackball.prototype = {\r\n\t_projectOnSphere : function(x, y) {\r\n\t\tvar r = 1.0;\r\n\r\n\t\tvar z = 0.0;\r\n\t\tvar d = sglSqrt(x*x + y*y);\r\n\t\tif (d < (r * 0.70710678118654752440)) {\r\n\t\t\t/* Inside sphere */\r\n\t\t\tz = sglSqrt(r*r - d*d);\r\n\t\t}\r\n\t\telse {\r\n\t\t\t/* On hyperbola */\r\n\t\t\tt = r / 1.41421356237309504880;\r\n\t\t\tz = t*t / d;\r\n\t\t}\r\n\t\treturn z;\r\n\t},\r\n\r\n\t_transform : function(m, x, y, z) {\r\n\t\treturn sglMulM4V4(m, sglV4C(x, y, z, 0.0));\r\n\t},\r\n\r\n\t_transformOnSphere : function(m, x, y) {\r\n\t\tvar z = this._projectOnSphere(x, y);\r\n\t\treturn this._transform(m, x, y, z);\r\n\t},\r\n\r\n\t_translate : function(offset, f) {\r\n\t\tvar invMat = sglInverseM4(this._matrix);\r\n\t\tvar t = sglV3toV4(offset, 0.0);\r\n\t\tt = sglMulM4V4(invMat, t);\r\n\t\tt = sglMulSV4(f, t);\r\n\t\tvar trMat = sglTranslationM4V(t);\r\n\t\tthis._matrix = sglMulM4(this._matrix, trMat);\r\n\t},\r\n\r\n\tget action()  { return this._action; },\r\n\tset action(a) { this._action = a     },\r\n\r\n\tget matrix() { return this._matrix; },\r\n\r\n\treset : function () {\r\n\t\tthis._matrix = sglIdentityM4();\r\n\t\tthis._pts    = [ [0.0, 0.0], [0.0, 0.0] ];\r\n\t\tthis._action = SGL_TRACKBALL_NO_ACTION\r\n\t},\r\n\r\n\ttrack : function(m, x, y, z) {\r\n\t\tthis._pts[0][0] = this._pts[1][0];\r\n\t\tthis._pts[0][1] = this._pts[1][1];\r\n\t\tthis._pts[1][0] = x;\r\n\t\tthis._pts[1][1] = y;\r\n\r\n\t\tswitch (this._action) {\r\n\t\t\tcase SGL_TRACKBALL_ROTATE:\r\n\t\t\t\tthis.rotate(m);\r\n\t\t\tbreak;\r\n\r\n\t\t\tcase SGL_TRACKBALL_PAN:\r\n\t\t\t\tthis.pan(m);\r\n\t\t\tbreak;\r\n\r\n\t\t\tcase SGL_TRACKBALL_DOLLY:\r\n\t\t\t\tthis.dolly(m, z);\r\n\t\t\tbreak;\r\n\r\n\t\t\tcase SGL_TRACKBALL_SCALE:\r\n\t\t\t\tthis.scale(m, z);\r\n\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\t\t\tbreak;\r\n\t\t}\r\n\t},\r\n\r\n\trotate : function(m) {\r\n\t\tif ((this._pts[0][0] == this._pts[1][0]) && (this._pts[0][1] == this._pts[1][1])) return;\r\n\r\n\t\tvar mInv = sglInverseM4(m);\r\n\r\n\t\tvar v0 = this._transformOnSphere(mInv, this._pts[0][0], this._pts[0][1]);\r\n\t\tvar v1 = this._transformOnSphere(mInv, this._pts[1][0], this._pts[1][1]);\r\n\r\n\t\tvar axis   = sglCrossV3(v0, v1);\r\n\t\tvar angle  = sglLengthV3(axis);\r\n\t\tvar rotMat = sglRotationAngleAxisM4V(angle, axis);\r\n\r\n\t\tthis._matrix = sglMulM4(rotMat, this._matrix);\r\n\t},\r\n\r\n\tpan : function(m) {\r\n\t\tvar mInv = sglInverseM4(m);\r\n\t\tvar v0 = this._transform(mInv, this._pts[0][0], this._pts[0][1], -1.0);\r\n\t\tvar v1 = this._transform(mInv, this._pts[1][0], this._pts[1][1], -1.0);\r\n\t\tvar offset = sglSubV3(v1, v0);\r\n\t\tthis._translate(offset, 2.0);\r\n\t},\r\n\r\n\tdolly : function(m, dz) {\r\n\t\tvar mInv = sglInverseM4(m);\r\n\t\tvar offset = this._transform(mInv, 0.0, 0.0, dz);\r\n\t\tthis._translate(offset, 1.0);\r\n\t},\r\n\r\n\tscale : function(m, s) {\r\n\t\tvar scaleMat = sglScalingM4C(s, s, s);\r\n\t\tthis._matrix = sglMulM4(this._matrix, scaleMat);\r\n\t}\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// SglFirstPersonCamera\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglFirstPersonCamera object.\r\n * The default pose is positioned at the origin, looking towards the -Z axis with 0 degrees roll.\r\n * The camera moves on the XZ plane, having +Y as upward axis.\r\n * @class Interactor which implements typical First-Person camera movements.\r\n */\r\nfunction SglFirstPersonCamera() {\r\n\tthis._position = sglZeroV3();\r\n\tthis._angles   = sglZeroV3();\r\n\r\n\tthis.lookAt(0.0, 0.0, 0.0, 0.0, 0.0, -1.0, 0.0);\r\n}\r\n\r\nSglFirstPersonCamera.prototype = {\r\n\t/**\r\n\t * Clones the object.\r\n\t * @return {SglFirstPersonCamera} A clone of the object.\r\n\t * @see SglFirstPersonCamera#get:copy\r\n\t */\r\n\tclone : function() {\r\n\t\tvar r = new SglFirstPersonCamera();\r\n\t\tr._position = this._position.slice();\r\n\t\tr._angles   = this._angles.slice();\r\n\t\treturn r;\r\n\t},\r\n\r\n\t/**\r\n\t * Getter for the whole object clone.\r\n\t * It returns a clone of the object.\r\n\t * @name SglFirstPersonCamera#get:copy\r\n\t * @function.\r\n\t * @return {SglFirstPersonCamera}\r\n\t * @see SglFirstPersonCamera#clone\r\n\t */\r\n\tget copy() {\r\n\t\treturn this.clone();\r\n\t},\r\n\r\n\t/**\r\n\t * Sets camera pose.\r\n\t * @param {number} positionX The X coordinate of the camera position.\r\n\t * @param {number} positionY The Y coordinate of the camera position.\r\n\t * @param {number} positionZ The Z coordinate of the camera position.\r\n\t * @param {number} targetX   The X coordinate of the point the camera will be looking at.\r\n\t * @param {number} targetY   The Y coordinate of the point the camera will be looking at.\r\n\t * @param {number} targetZ   The Z coordinate of the point the camera will be looking at.\r\n\t * @param {number} roll      The angle (in radians) of rotation around the view direction (upward vector is kepth at Y axis).\r\n\t * @return {SglFirstPersonCamera} A self reference.\r\n\t */\r\n\tlookAt : function(positionX, positionY, positionZ, targetX, targetY, targetZ, roll) {\r\n\t\tthis._position = sglV3C(positionX, positionY, positionZ);\r\n\r\n\t\tvar viewDir = sglSubV3([ targetX, targetY, targetZ ], this._position);\r\n\r\n\t\tthis._angles[0] = sglAtan2( viewDir[1], -viewDir[2]);\r\n\t\tthis._angles[1] = sglAtan2(-viewDir[0], -viewDir[2]);\r\n\t\tthis._angles[2] = (roll) ? (roll) : (0.0);\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\t/**\r\n\t * Translates the camera position in its frame of reference.\r\n\t * @param {number} xOffset The amount of translation along the X axis.\r\n\t * @param {number} yOffset The amount of translation along the Y axis.\r\n\t * @param {number} zOffset The amount of translation along the Z axis.\r\n\t * @return {SglFirstPersonCamera} A self reference.\r\n\t */\r\n\ttranslate : function(xOffset, yOffset, zOffset) {\r\n\t\tvar pitchMat  = sglRotationAngleAxisM4C(this._angles[0], 1.0, 0.0, 0.0);\r\n\t\tvar yawMat    = sglRotationAngleAxisM4C(this._angles[1], 0.0, 1.0, 0.0);\r\n\t\tvar rollMat   = sglRotationAngleAxisM4C(this._angles[2], 0.0, 0.0, 1.0);\r\n\t\tvar rotMat    = sglMulM4(rollMat, sglMulM4(yawMat, pitchMat));\r\n\t\tvar rotOffset = sglMulM4V4(rotMat, [ xOffset, yOffset, zOffset, 0.0 ]);\r\n\r\n\t\tthis._position[0] += rotOffset[0];\r\n\t\tthis._position[1] += rotOffset[1];\r\n\t\tthis._position[2] += rotOffset[2];\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\t/**\r\n\t * Translates the camera position in its frame of reference, while preserving the Y coordinate (i.e. altitude).\r\n\t * @param {number} xOffset The amount of translation along the X axis.\r\n\t * @param {number} yOffset The amount of translation along the Y axis.\r\n\t * @param {number} zOffset The amount of translation along the Z axis.\r\n\t * @return {SglFirstPersonCamera} A self reference.\r\n\t */\r\n\ttranslateOnPlane : function(xOffset, yOffset, zOffset) {\r\n\t\tvar rotMat    = sglRotationAngleAxisM4C(this._angles[1], 0.0, 1.0, 0.0);\r\n\t\tvar rotOffset = sglMulM4V4(rotMat, [ xOffset, yOffset, zOffset, 0.0 ]);\r\n\r\n\t\tthis._position[0] += rotOffset[0];\r\n\t\tthis._position[1] += rotOffset[1];\r\n\t\tthis._position[2] += rotOffset[2];\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\t/**\r\n\t * Rotate the camera in its pitch-yaw-roll reference frame.\r\n\t * @param {number} pitchOffset The amount of rotation around the X axis (in radians).\r\n\t * @param {number} yawOffset   The amount of rotation around the Y axis (in radians).\r\n\t * @param {number} rollOffset  The amount of rotation around the view direction (in radians).\r\n\t * @return {SglFirstPersonCamera} A self reference.\r\n\t */\r\n\trotate : function(pitchOffset, yawOffset, rollOffset) {\r\n\t\tthis._angles[0] += pitchOffset;\r\n\t\tthis._angles[1] += yawOffset;\r\n\t\tthis._angles[2] += rollOffset;\r\n\r\n\t\treturn this;\r\n\t},\r\n\r\n\t/**\r\n\t * Getter for the camera pose matrix.\r\n\t * The camera pose is returned as a 16-element array representing a 4x4 column major transofrmation matrix.\r\n\t * @name SglFirstPersonCamera#get:matrix\r\n\t * @function.\r\n\t * @return {Array}\r\n\t */\r\n\tget matrix() {\r\n\t\tvar pitchMat  = sglRotationAngleAxisM4C(-this._angles[0], 1.0, 0.0, 0.0);\r\n\t\tvar yawMat    = sglRotationAngleAxisM4C(-this._angles[1], 0.0, 1.0, 0.0);\r\n\t\tvar rollMat   = sglRotationAngleAxisM4C(-this._angles[2], 0.0, 0.0, 1.0);\r\n\t\tvar posMat    = sglTranslationM4V(sglNegV3(this._position));\r\n\t\tvar res       = sglMulM4(rollMat, sglMulM4(pitchMat, sglMulM4(yawMat, posMat)));\r\n\r\n\t\treturn res;\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n/*************************************************************************/\r\n/*                                                                       */\r\n/*  SpiderGL                                                             */\r\n/*  JavaScript 3D Graphics Library on top of WebGL                       */\r\n/*                                                                       */\r\n/*  Copyright (C) 2010                                                   */\r\n/*  Marco Di Benedetto                                                   */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it                                               */\r\n/*  mailto: marco[DOT]dibenedetto[AT]isti[DOT]cnr[DOT]it                 */\r\n/*                                                                       */\r\n/*  This file is part of SpiderGL.                                       */\r\n/*                                                                       */\r\n/*  SpiderGL is free software; you can redistribute it and/or modify     */\r\n/*  under the terms of the GNU Lesser General Public License as          */\r\n/*  published by the Free Software Foundation; either version 2.1 of     */\r\n/*  the License, or (at your option) any later version.                  */\r\n/*                                                                       */\r\n/*  SpiderGL is distributed in the hope that it will be useful, but      */\r\n/*  WITHOUT ANY WARRANTY; without even the implied warranty of           */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                 */\r\n/*  See the GNU Lesser General Public License                            */\r\n/*  (http://www.fsf.org/licensing/licenses/lgpl.html) for more details.  */\r\n/*                                                                       */\r\n/*************************************************************************/\r\n\r\n\r\n// canvas utilities\r\n/***********************************************************************/\r\nfunction sglGetCanvasContext(canvasID) {\r\n\tvar canvas = document.getElementById(canvasID);\r\n\tif (!canvas) return null;\r\n\r\n\tvar contextNames = ['webgl','experimental-webgl','moz-webgl','webkit-3d'];\r\n\t\r\n\tvar gl = null\r\n\tfor(var i = 0; i < contextNames.length; i++)\r\n\t{\r\n\t\ttry \r\n\t\t{\r\n\t\t\tgl = canvas.getContext(contextNames[i]);\r\n\t\t}\r\n\t\tcatch (x) { gl = null; }\r\n        if (gl) break;\r\n\t}\r\n\t\t\r\n\tif (gl == null) return null;\r\n\r\n\tif (gl.FALSE == undefined) gl.FALSE = 0;\r\n\tif (gl.TRUE  == undefined) gl.TRUE  = 1;\r\n\r\n\treturn gl;\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n// SglCanvasUI\r\n/***********************************************************************/\r\n/**\r\n * Constructs a SglCanvasUI.\r\n * @class Holds current information about the canvas object and input devices state.\r\n */\r\nfunction SglCanvasUI(manager, handler, canvas, gl) {\r\n\tthis._manager = manager;\r\n\tthis._handler = handler;\r\n\tthis._canvas  = canvas;\r\n\r\n\tthis._timerID = null;\r\n\tthis._updRate = 0.0;\r\n\tthis._ignoreKeyRepeat = true;\r\n\r\n\tthis.gl = gl;\r\n\r\n\tthis.loadEvent        = null;\r\n\tthis.unloadEvent      = null;\r\n\tthis.keyDownEvent     = null;\r\n\tthis.keyUpEvent       = null;\r\n\tthis.keyPressEvent    = null;\r\n\tthis.mouseDownEvent   = null;\r\n\tthis.mouseUpEvent     = null;\r\n\tthis.mouseMoveEvent   = null;\r\n\tthis.mouseWheelEvent  = null;\r\n\tthis.clickEvent       = null;\r\n\tthis.dblClickEvent    = null;\r\n\tthis.resizeEvent      = null;\r\n\tthis.updateEvent      = null;\r\n\tthis.drawEvent        = null;\r\n\r\n\tthis.keysDown         = new Object();\r\n\r\n\tthis.mouseButtonsDown = new Object();\r\n\tthis.mousePos         = { x:0, y:0 };\r\n\tthis.mousePrevPos     = { x:0, y:0 };\r\n\tthis.mouseDeltaPos    = { x:0, y:0 };\r\n\r\n\tthis.timeNow   = Date.now() / 1000.0;\r\n\tthis.timePrev  = this.timeNow;\r\n\tthis.timeDelta = 0.0;\r\n}\r\n\r\nSglCanvasUI.prototype = {\r\n\tget canvas() {\r\n\t\treturn this._canvas;\r\n\t},\r\n\r\n\tget width() {\r\n\t\treturn this._canvas.width;\r\n\t},\r\n\r\n\tget height() {\r\n\t\treturn this._canvas.height;\r\n\t},\r\n\r\n\tget ignoreKeyRepeat() {\r\n\t\treturn this._ignoreKeyRepeat;\r\n\t},\r\n\r\n\tset ignoreKeyRepeat(v) {\r\n\t\tthis._ignoreKeyRepeat = v;\r\n\t},\r\n\r\n\tget updateRate() {\r\n\t\tif (this._updRate <= 0.0) return 0.0;\r\n\t\treturn this._updRate;\r\n\t},\r\n\r\n\tset updateRate(r) {\r\n\t\tvar updR = r;\r\n\t\tif (updR < 0.0) updR = 0.0;\r\n\t\tif (updR > 1000.0) updR = 1000.0;\r\n\t\tif (this._updRate == updR) return;\r\n\r\n\t\tthis._updRate = updR;\r\n\r\n\t\tif (this._timerID != null)\r\n\t\t{\r\n\t\t\tclearInterval(this._timerID);\r\n\t\t\tthis._timerID = null;\r\n\t\t}\r\n\r\n\t\tif (this._updRate > 0.0)\r\n\t\t{\r\n\t\t\tvar ms  = 1000.0 / this._updRate;\r\n\t\t\tif (ms < 1.0) ms = 1.0;\r\n\t\t\tvar mgr = this._manager;\r\n\r\n\t\t\tthis.timeNow   = Date.now() / 1000.0;\r\n\t\t\tthis.timePrev  = this.timeNow;\r\n\t\t\tthis.timeDelta = 0.0;\r\n\r\n\t\t\tthis._timerID = setInterval(function() { mgr.update(); }, ms);\r\n\t\t}\r\n\t},\r\n\r\n\tget requestDraw() {\r\n\t\tvar t = this;\r\n\t\treturn (function() { t._manager.requestDraw(); });\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// _SglCanvasManager\r\n/***********************************************************************/\r\nfunction _SglCanvasManager(canvasID, handler, updateRate) {\r\n\tvar canvas = document.getElementById(canvasID);\r\n\tif (!canvas) throw new Error(\"SpiderGL : Canvas not found\");\r\n\r\n\tcanvas.contentEditable = true;\r\n\r\n\tvar gl = sglGetCanvasContext(canvasID);\r\n\tif (!gl) throw new Error(\"SpiderGL : Cannot get WebGL context\");\r\n\r\n\tgl.pixelStorei(gl.PACK_ALIGNMENT,                     1);\r\n\tgl.pixelStorei(gl.UNPACK_ALIGNMENT,                   1);\r\n\tgl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,                true);\r\n\tgl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,     false);\r\n\tgl.pixelStorei(gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, gl.NONE);\r\n\r\n\t// for some strange reason, this is a workaround\r\n\t// to have Chrome work properly...\r\n\t// (anyway it should be harmless...)\r\n\tgl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n\r\n\tvar ui  = new SglCanvasUI(this, handler, canvas, gl);\r\n\tthis.ui = ui;\r\n\r\n\tvar mgr = this;\r\n\r\n\tthis.gl      = gl;\r\n\tthis.canvas  = canvas;\r\n\tthis.handler = handler;\r\n\t//this.handler.prototype.ui = get function() { return ui };\r\n\t//this.handler.ui = get function() { return ui };\r\n\tthis.handler.ui = ui;\r\n\r\n\tthis._drawPending = false;\r\n\tthis.rendering = true;\r\n\tthis._drawFunc = function() {\r\n\t\tmgr.draw();\r\n\t};\r\n\r\n\r\n\tthis.canvas.addEventListener(\"load\",            function(e) { mgr.load        (e); }, false);\r\n\tthis.canvas.addEventListener(\"unload\",          function(e) { mgr.unload      (e); }, false);\r\n\tthis.canvas.addEventListener(\"keydown\",         function(e) { mgr.keyDown     (e); }, false);\r\n\tthis.canvas.addEventListener(\"keyup\",           function(e) { mgr.keyUp       (e); }, false);\r\n\tthis.canvas.addEventListener(\"keypress\",        function(e) { mgr.keyPress    (e); }, false);\r\n\tthis.canvas.addEventListener(\"mousedown\",       function(e) { mgr.mouseDown   (e); }, false);\r\n\tthis.canvas.addEventListener(\"mouseup\",         function(e) { mgr.mouseUp     (e); }, false);\r\n\tthis.canvas.addEventListener(\"mousemove\",       function(e) { mgr.mouseMove   (e); }, false);\r\n\tthis.canvas.addEventListener(\"click\",           function(e) { mgr.click       (e); }, false);\r\n\tthis.canvas.addEventListener(\"dblclick\",        function(e) { mgr.dblClick    (e); }, false);\r\n\tthis.canvas.addEventListener(\"resize\",          function(e) { mgr.resize      (e); }, false);\r\n\r\n\tthis.canvas.addEventListener(\"mousewheel\",      function(e) { mgr.mouseWheel  (e); }, false);\r\n\tthis.canvas.addEventListener(\"DOMMouseScroll\",  function(e) { mgr.mouseWheel  (e); }, false);\r\n\r\n\tthis.canvas.addEventListener(\"blur\",            function(e) { mgr.blur        (e); }, false);\r\n\tthis.canvas.addEventListener(\"mouseout\",        function(e) { mgr.mouseOut    (e); }, false);\r\n\tthis.canvas.addEventListener(\"mouseover\",       function(e) { mgr.mouseOver    (e); }, false);\r\n\t\r\n\tthis.canvas.addEventListener(\"touchstart\",      function(e) { mgr.touchStart  (e); }, false);\r\n\tthis.canvas.addEventListener(\"touchend\",        function(e) { mgr.touchEnd    (e); }, false);\r\n\tthis.canvas.addEventListener(\"touchmove\",       function(e) { mgr.touchMove   (e); }, false);\r\n\t\r\n\tthis.load();\r\n\r\n\tif (updateRate) {\r\n\t\tthis.ui.updateRate = updateRate;\r\n\t}\r\n}\r\n\r\n_SglCanvasManager.prototype = {\r\n\t_getMouseClientPos : function(e) {\r\n\t\tvar rct = this.canvas.getBoundingClientRect();\r\n\t\treturn {\r\n\t\t\tx : (e.clientX - rct.left),\r\n\t\t\ty : (e.clientY - rct.top )\r\n\t\t};\r\n\t},\r\n\r\n\trequestDraw : function() {\r\n\t\tif (this.rendering)\r\n\t\t{\r\n\t\t\tif (!this._drawPending) {\r\n\t\t\t\tthis._drawPending = true;\r\n\t\t\t\tsetTimeout(this._drawFunc, 0);\r\n\t\t\t}\r\n\t\t}\t\r\n\t},\r\n\r\n\tblur : function(e) {\r\n\t\tvar doDraw = false;\r\n\t\tfor (var button in this.ui.mouseButtonsDown) {\r\n\t\t\tif (this.ui.mouseButtonsDown[button]) {\r\n\t\t\t\tthis.ui.mouseButtonsDown[button] = false;\r\n\t\t\t\tif (this.handler.mouseUp) {\r\n\t\t\t\t\tif (this.handler.mouseUp(this.gl, button, this.ui.mousePos.x, this.ui.mousePos.y) != false) {\r\n\t\t\t\t\t\tdoDraw = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (var key in this.ui.keysDown) {\r\n\t\t\tif (this.ui.keysDown[key]) {\r\n\t\t\t\tthis.ui.keysDown[key] = false;\r\n\t\t\t\tif (this.handler.keyUp) {\r\n\t\t\t\t\t// WARNING : passing 0 as keyCode\r\n\t\t\t\t\tif (this.handler.keyUp(this.gl, 0, key) != false) {\r\n\t\t\t\t\t\tdoDraw = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (doDraw) {\r\n\t\t\tthis.requestDraw();\r\n\t\t}\r\n\t},\r\n\r\n\tmouseOut: function(e) {\r\n\t\tvar doDraw = false;\r\n\t\tfor (var button in this.ui.mouseButtonsDown) {\r\n\t\t\tif (this.ui.mouseButtonsDown[button]) {\r\n\t\t\t\tthis.ui.mouseButtonsDown[button] = false;\r\n\t\t\t\tif (this.handler.mouseOut) {\r\n\t\t\t\t\tif (this.handler.mouseOut(this.gl, this.ui.mousePos.x, this.ui.mousePos.y) != false) {\r\n\t\t\t\t\t\tdoDraw = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (doDraw) {\r\n\t\t\tthis.requestDraw();\r\n\t\t}\r\n\t},\r\n\t\r\n\tmouseOver: function(e) {\r\n\t\r\n\t},\r\n\r\n\tload : function() {\r\n\t\tthis.ui.loadEvent = null;\r\n\t\tif (this.handler.load) {\r\n\t\t\tif (this.handler.load(this.gl) != false) {\r\n\t\t\t\t;\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.requestDraw();\r\n\t},\r\n\r\n\tunload : function()\r\n\t{\r\n\t\tthis.ui.unloadEvent = null;\r\n\t\tthis.ui.updateRate = 0.0;\r\n\t\tif (this.handler.unload) {\r\n\t\t\tthis.handler.unload(this.gl);\r\n\t\t}\r\n\t\tthis.handler.ui = null;\r\n\t\tthis.handler    = null;\r\n\t\tthis.ui         = null;\r\n\t},\r\n\r\n\tkeyDown : function(e) {\r\n\t\tthis.ui.keyDownEvent = e;\r\n\t\tvar keyString = String.fromCharCode(e.keyCode);\r\n\t\tthis.ui.keysDown[keyString.toLowerCase()] = true;\r\n\t\tthis.ui.keysDown[keyString.toUpperCase()] = true;\r\n\t\tif (!this.ui.keysDown[e.keyCode] || !this.ui.ignoreKeyRepeat) {\r\n\t\t\tthis.ui.keysDown[e.keyCode] = true;\r\n\t\t\tif (this.handler.keyDown) {\r\n\t\t\t\tif (this.handler.keyDown(this.gl, e.keyCode, keyString) != false) {\r\n\t\t\t\t\tthis.requestDraw();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\t/*\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t\t*/\r\n\t},\r\n\r\n\tkeyUp : function(e) {\r\n\t\tthis.ui.keyUpEvent = e;\r\n\t\tvar keyString = String.fromCharCode(e.keyCode);\r\n\t\tthis.ui.keysDown[keyString.toLowerCase()] = false;\r\n\t\tthis.ui.keysDown[keyString.toUpperCase()] = false;\r\n\t\tthis.ui.keysDown[e.keyCode] = false;\r\n\t\tif (this.handler.keyUp) {\r\n\t\t\tif (this.handler.keyUp(this.gl, e.keyCode, keyString) != false) {\r\n\t\t\t\tthis.requestDraw();\r\n\t\t\t}\r\n\t\t}\r\n\t\t/*\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t\t*/\r\n\t},\r\n\r\n\tkeyPress : function(e) {\r\n\t\tthis.ui.keyPressEvent = e;\r\n\t\tvar keyString = String.fromCharCode(e.charCode);\r\n\t\tif (this.handler.keyPress) {\r\n\t\t\tif (this.handler.keyPress(this.gl, e.charCode, keyString) != false) {\r\n\t\t\t\tthis.requestDraw();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t},\r\n\r\n\tmouseDown : function(e) {\r\n\t\tthis.ui.mouseDownEvent = e;\r\n\t\tvar xy = this._getMouseClientPos(e);\r\n\t\tvar x = xy.x;\r\n\t\tvar y = this.canvas.height - 1 - xy.y;\r\n\t\tthis.ui.mousePrevPos.x = x;\r\n\t\tthis.ui.mousePrevPos.y = y;\r\n\t\tthis.ui.mousePos.x = x;\r\n\t\tthis.ui.mousePos.y = y;\r\n\t\tthis.ui.mouseDeltaPos.x = 0;\r\n\t\tthis.ui.mouseDeltaPos.y = 0;\r\n\t\tthis.ui.mouseButtonsDown[e.button] = true;\r\n\t\tif (this.handler.mouseDown) {\r\n\t\t\tif (this.handler.mouseDown(this.gl, e.button, x, y) != false) {\r\n\t\t\t\tthis.requestDraw();\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.canvas.focus();\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t},\r\n\r\n\tmouseUp : function(e) {\r\n\t\tthis.ui.mouseUpEvent = e;\r\n\t\tvar xy = this._getMouseClientPos(e);\r\n\t\tvar x = xy.x;\r\n\t\tvar y = this.canvas.height - 1 - xy.y;\r\n\t\tthis.ui.mousePrevPos.x = x;\r\n\t\tthis.ui.mousePrevPos.y = y;\r\n\t\tthis.ui.mousePos.x = x;\r\n\t\tthis.ui.mousePos.y = y;\r\n\t\tthis.ui.mouseDeltaPos.x = 0;\r\n\t\tthis.ui.mouseDeltaPos.y = 0;\r\n\t\tthis.ui.mouseButtonsDown[e.button] = false;\r\n\t\tif (this.handler.mouseUp) {\r\n\t\t\tif (this.handler.mouseUp(this.gl, e.button, x, y) != false) {\r\n\t\t\t\tthis.requestDraw();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t},\r\n\r\n\tmouseMove : function(e) {\r\n\t\tthis.ui.mouseMoveEvent = e;\r\n\t\tvar xy = this._getMouseClientPos(e);\r\n\t\tvar x = xy.x;\r\n\t\tvar y = this.canvas.height - 1 - xy.y;\r\n\t\tthis.ui.mousePrevPos.x = this.ui.mousePos.x;\r\n\t\tthis.ui.mousePrevPos.y = this.ui.mousePos.y;\r\n\t\tthis.ui.mousePos.x = x;\r\n\t\tthis.ui.mousePos.y = y;\r\n\t\tthis.ui.mouseDeltaPos.x = this.ui.mousePos.x - this.ui.mousePrevPos.x;\r\n\t\tthis.ui.mouseDeltaPos.y = this.ui.mousePos.y - this.ui.mousePrevPos.y;\r\n\t\tif (this.handler.mouseMove) {\r\n\t\t\tif (this.handler.mouseMove(this.gl, x, y) != false) {\r\n\t\t\t\tthis.requestDraw();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t},\r\n\r\n\tmouseWheel : function(e) {\r\n\t\tthis.ui.mouseWheelEvent = e;\r\n\t\tvar xy = this._getMouseClientPos(e);\r\n\t\tvar x = xy.x;\r\n\t\tvar y = this.canvas.height - 1 - xy.y;\r\n\t\tthis.ui.mousePrevPos.x = x;\r\n\t\tthis.ui.mousePrevPos.y = y;\r\n\t\tthis.ui.mousePos.x = x;\r\n\t\tthis.ui.mousePos.y = y;\r\n\t\tthis.ui.mouseDeltaPos.x = 0;\r\n\t\tthis.ui.mouseDeltaPos.y = 0;\r\n\t\tif (this.handler.mouseWheel) {\r\n\t\t\tvar delta = 0;\r\n\t\t\tif (!e) /* For IE. */ {\r\n\t\t\t\te = window.event;\r\n\t\t\t}\r\n\t\t\tif (e.wheelDelta) /* IE/Opera. */ {\r\n\t\t\t\tdelta = e.wheelDelta / 120;\r\n\t\t\t\t/* In Opera 9, delta differs in sign as compared to IE.\r\n\t\t\t\t */\r\n\t\t\t\tif (window.opera) {\r\n\t\t\t\t\tdelta = -delta;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (e.detail) /** Mozilla case. */ {\r\n\t\t\t\t/** In Mozilla, sign of delta is different than in IE.\r\n\t\t\t\t * Also, delta is multiple of 3.\r\n\t\t\t\t */\r\n\t\t\t\tdelta = -e.detail / 3;\r\n\t\t\t}\r\n\t\t\t/* If delta is nonzero, handle it.\r\n\t\t\t * Basically, delta is now positive if wheel was scrolled up,\r\n\t\t\t * and negative, if wheel was scrolled down.\r\n\t\t\t */\r\n\t\t\tif (delta) {\r\n\t\t\t\tif (this.handler.mouseWheel(this.gl, delta, x, y) != false) {\r\n\t\t\t\t\tthis.requestDraw();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t/* Prevent default actions caused by mouse wheel.\r\n\t\t * That might be ugly, but we handle scrolls somehow\r\n\t\t * anyway, so don't bother here..\r\n\t\t */\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t\t//e.returnValue = false;\r\n\t},\r\n\r\n\ttouchStart : function(e) {\r\n\t\tthis.ui.mouseDownEvent = e.touches[0];\r\n\t\tvar xy = this._getMouseClientPos(e.touches[0]);\r\n\t\tvar x = xy.x;\r\n\t\tvar y = this.canvas.height - 1 - xy.y;\r\n\t\tthis.ui.mousePrevPos.x = x;\r\n\t\tthis.ui.mousePrevPos.y = y;\r\n\t\tthis.ui.mousePos.x = x;\r\n\t\tthis.ui.mousePos.y = y;\r\n\t\tthis.ui.mouseDeltaPos.x = 0;\r\n\t\tthis.ui.mouseDeltaPos.y = 0;\r\n\t\tthis.ui.mouseButtonsDown[0] = true;\r\n\t\tif (this.handler.mouseDown) {\r\n\t\t\tif (this.handler.mouseDown(this.gl, 0, x, y) != false) {\r\n\t\t\t\tthis.requestDraw();\r\n\t\t\t}\r\n\t\t}\r\n\t\tthis.canvas.focus();\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t},\r\n\r\n\ttouchEnd : function(e) {\r\n\t\tthis.ui.mouseUpEvent = e.changedTouches[0];\r\n\t\tvar xy = this._getMouseClientPos(e.changedTouches[0]);\r\n\t\tvar x = xy.x;\r\n\t\tvar y = this.canvas.height - 1 - xy.y;\r\n\t\tthis.ui.mousePrevPos.x = x;\r\n\t\tthis.ui.mousePrevPos.y = y;\r\n\t\tthis.ui.mousePos.x = x;\r\n\t\tthis.ui.mousePos.y = y;\r\n\t\tthis.ui.mouseDeltaPos.x = 0;\r\n\t\tthis.ui.mouseDeltaPos.y = 0;\r\n\t\tthis.ui.mouseButtonsDown[0] = false;\r\n\t\tif (this.handler.mouseUp) {\r\n\t\t\tif (this.handler.mouseUp(this.gl, 0, x, y) != false) {\r\n\t\t\t\tthis.requestDraw();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t},\r\n\r\n\ttouchMove : function(e) {\r\n\t\tthis.ui.mouseMoveEvent = e.changedTouches[0];\r\n\t\tvar xy = this._getMouseClientPos(e.changedTouches[0]);\r\n\t\tvar x = xy.x;\r\n\t\tvar y = this.canvas.height - 1 - xy.y;\r\n\t\tthis.ui.mousePrevPos.x = this.ui.mousePos.x;\r\n\t\tthis.ui.mousePrevPos.y = this.ui.mousePos.y;\r\n\t\tthis.ui.mousePos.x = x;\r\n\t\tthis.ui.mousePos.y = y;\r\n\t\tthis.ui.mouseDeltaPos.x = this.ui.mousePos.x - this.ui.mousePrevPos.x;\r\n\t\tthis.ui.mouseDeltaPos.y = this.ui.mousePos.y - this.ui.mousePrevPos.y;\r\n\t\tif (this.handler.mouseMove) {\r\n\t\t\tif (this.handler.mouseMove(this.gl, x, y) != false) {\r\n\t\t\t\tthis.requestDraw();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t},\r\n\t\r\n\tclick : function(e) {\r\n\t\tthis.ui.clickEvent = e;\r\n\t\tvar xy = this._getMouseClientPos(e);\r\n\t\tvar x = xy.x;\r\n\t\tvar y = this.canvas.height - 1 - xy.y;\r\n\t\tif (this.handler.click) {\r\n\t\t\tif (this.handler.click(this.gl, e.button, x, y) != false) {\r\n\t\t\t\tthis.requestDraw();\r\n\t\t\t}\r\n\t\t}\r\n\t\t/*\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t\t*/\r\n\t},\r\n\r\n\tdblClick : function(e) {\r\n\t\tthis.ui.dblClickEvent = e;\r\n\t\tvar xy = this._getMouseClientPos(e);\r\n\t\tvar x = xy.x;\r\n\t\tvar y = this.canvas.height - 1 - xy.y;\r\n\t\tif (this.handler.dblClick) {\r\n\t\t\tif (this.handler.dblClick(this.gl, e.button, x, y) != false) {\r\n\t\t\t\tthis.requestDraw();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t},\r\n\r\n\tresize : function(e) {\r\n\t\tthis.ui.resizeEvent = e;\r\n\t\tif (this.handler.resize) {\r\n\t\t\tif (this.handler.resize(this.gl, this.canvas.width, this.canvas.height) != false) {\r\n\t\t\t\tthis.requestDraw();\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (e.preventDefault) {\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t},\r\n\r\n\tupdate : function() {\r\n\t\tthis.ui.updateEvent = null;\r\n\t\tvar now = Date.now() / 1000.0;\r\n\t\tthis.ui.timePrev  = this.ui.timeNow;\r\n\t\tthis.ui.timeNow   = now;\r\n\t\tthis.ui.timeDelta = (this.ui.timeNow - this.ui.timePrev);\r\n\t\tvar doDraw = true;\r\n\t\tif (this.handler.update) {\r\n\t\t\tdoDraw = (this.handler.update(this.gl, this.ui.timeDelta) != false);\r\n\t\t}\r\n\t\tif (doDraw) {\r\n\t\t\tthis.requestDraw();\r\n\t\t}\r\n\t},\r\n\r\n\tdraw : function() {\r\n\t\tthis.ui.drawEvent = null;\r\n\t\tif (this.handler.draw) {\r\n\t\t\tthis.handler.draw(this.gl);\r\n\t\t}\r\n\t\tthis.gl.flush();\r\n\t\tthis._drawPending = false;\r\n\t}\r\n};\r\n/***********************************************************************/\r\n\r\n\r\n// canvas registration\r\n/***********************************************************************/\r\nvar _SGL_RegisteredCanvas = new Object();\r\n\r\nfunction _sglManageCanvas(canvasID, handler, updateRate) {\r\n\tvar manager = new _SglCanvasManager(canvasID, handler, updateRate);\r\n\t_SGL_RegisteredCanvas[canvasID] = manager;\r\n}\r\n\r\nfunction _sglUnmanageCanvas(canvasID) {\r\n\tif (_SGL_RegisteredCanvas[canvasID]) {\r\n\t\t_SGL_RegisteredCanvas[canvasID] = null;\r\n\t\tdelete _SGL_RegisteredCanvas[canvasID];\r\n\t}\r\n}\r\n\r\nfunction _sglManageCanvasOnLoad(canvasID, handler, updateRate) {\r\n\twindow.addEventListener(\"load\", function() { _sglManageCanvas(canvasID, handler, updateRate); }, false);\r\n}\r\n\r\nfunction _sglUnmanageCanvasOnLoad(canvasID) {\r\n\twindow.addEventListener(\"unload\", function() { _sglUnmanageCanvas(canvasID); }, false);\r\n}\r\n\r\nfunction sglRegisterCanvas(canvasID, handler, updateRate) {\r\n\t_sglManageCanvasOnLoad(canvasID, handler, updateRate);\r\n\t_sglUnmanageCanvasOnLoad(canvasID);\r\n}\r\n\r\nfunction sglRegisterLoadedCanvas(canvasID, handler, updateRate) {\r\n\t_sglManageCanvas(canvasID, handler, updateRate);\r\n\t_sglUnmanageCanvasOnLoad(canvasID);\r\n}\r\n/***********************************************************************/\r\n\r\n\r\n","/*************************************************************************/\r\n/*                                                                       */\r\n/*  WebMultiRes                                                          */\r\n/*  JavaScript 3D Graphics Library on top of SpiderGL for web            */\r\n/*  visualization of high resolution RTI images                          */\r\n/*                                                                       */\r\n/*  Copyright (C) 2013-2015                                              */\r\n/*  Gianpaolo Palma                                                      */\r\n/*  Visual Computing Laboratory                                          */\r\n/*  ISTI - Italian National Research Council (CNR)                       */\r\n/*  http://vcg.isti.cnr.it/rti/webviewer.php                             */\r\n/*  mailto: gianpaolo[DOT]palma[AT]isti[DOT]cnr[DOT]it                   */\r\n/*                                                                       */\r\n/*                                                                       */\r\n/*  This program is free software: you can redistribute it and/or modify */\r\n/*  it under the terms of the GNU General Public License as published by */\r\n/*  the Free Software Foundation, either version 3 of the License, or    */\r\n/*  (at your option) any later version.                                  */\r\n/*                                                                       */\r\n/*  This program is distributed in the hope that it will be useful,      */\r\n/*  but WITHOUT ANY WARRANTY; without even the implied warranty of       */\r\n/*  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        */\r\n/*  GNU General Public License for more details.                         */\r\n/*                                                                       */ \r\n/*  You should have received a copy of the GNU General Public License    */\r\n/*  along with this program.  If not, see <http://www.gnu.org/licenses/> */\r\n/*************************************************************************/\r\n\r\nfunction createRtiViewer(idDiv, imageUrlOrFunction, width, height)\r\n{\r\n\tvar canvasHeight = height;\r\n\tvar canvasWidth = width;\r\n\tvar fullscreen = false;\r\n\tvar canvasContainer = $($(\"#\"+idDiv)[0]);\r\n\tvar canvasDiv = document.createElement(\"div\");\r\n\tcanvasDiv.id = idDiv + \"_div\";\r\n\tcanvasDiv.style.height = height + \"px\";\r\n\tcanvasDiv.style.width = width + \"px\";\r\n\tcanvasDiv.style.margin = \"auto\";\r\n\tcanvasDiv.style.position = \"relative\";\r\n\tcanvasContainer.append(canvasDiv);\r\n\t\r\n\tvar canvasNode = $($(\"#\"+idDiv + \"_div\")[0]);\r\n\tvar canvasName = idDiv + \"_webgl\";\r\n\tvar canvas = document.createElement(\"canvas\");\r\n\tcanvas.id = canvasName;\r\n\tcanvas.width = width;\r\n\tcanvas.height = height;\r\n\tcanvasNode.append(canvas);\r\n\t\r\n\tvar aNode = document.createElement(\"a\");\r\n\taNode.href = \"http://vcg.isti.cnr.it/rti/webviewer.php\";\r\n\taNode.target =\"_blank\";\r\n\t\r\n\tvar aNodeDiv = document.createElement(\"div\");\r\n\taNodeDiv.style.width = 80 + \"px\";\r\n\taNodeDiv.style.height = 50 + \"px\";\r\n\t\r\n\taNode.appendChild(aNodeDiv);\r\n\taNode.style.position = \"absolute\";\r\n\taNode.style.bottom = \"0px\";\r\n\taNode.style.left = \"0px\";\r\n\taNode.style.cssFloat = \"left\";\r\n\tcanvasNode.append(aNode);\r\n\t\t\r\n\tvar toolbar = document.createElement(\"div\");\r\n\ttoolbar.setAttribute(\"class\", \"toolbar\");\r\n\ttoolbar.style.position = \"absolute\";\r\n\ttoolbar.style.top = \"10px\";\r\n\ttoolbar.style.left = \"10px\";\r\n\ttoolbar.style.cssFloat = \"left\";\r\n\ttoolbar.style.width = \"40px\";\r\n\ttoolbar.style.height = \"200px\";\r\n\ttoolbar.style.visibility = \"hidden\";\r\n\ttoolbar.innerHTML = '<button class = \"toolbarButton\" id = \"zoomIn\"></button><button class = \"toolbarButton\" id = \"zoomOut\"></button><button class = \"toolbarButton\" id = \"light\"></button><button class = \"toolbarButton\" id = \"fullscreen\"></button><button class = \"toolbarButton\" id = \"help\"></button>'\r\n\tcanvasNode.append(toolbar);\r\n\t\r\n\tvar divHelp = document.createElement(\"div\");\r\n\tdivHelp.id = idDiv + \"_guide\";\r\n\tdivHelp.style.width = \"100%\";\r\n\tdivHelp.style.height = \"100%\";\r\n\tdivHelp.style.position = \"absolute\";\r\n\tdivHelp.style.left = \"0px\";\r\n\tdivHelp.style.top = \"0px\";\r\n\tdivHelp.style.color = \"#FFFFFF\";\r\n\tdivHelp.style.backgroundColor=\"rgba(0, 0, 0, 0.9)\";\r\n\t\r\n\tdivHelp.innerHTML = '<div id = \"guideTable\"><div id = \"guideCell\"> <div id = \"guideList\"><h3>WebRTIViewer<br/></h3><ul><li>Pan: LeftMouseButton + MouseMove.</li><li>Zoom in: MouseWhell or press the button <span><img src = \"/assets/webViewer/css/icons/zoomin.png\" alt=\"\"/></span></li><li>Zoom out: MouseWheel or press the button <span><img src = \"/assets/webViewer/css/icons/zoomout.png\" alt=\"\"/></span></li><li>To change the light direction: activate the light with the button <span><img src = \"/assets/webViewer/css/icons/light.png\" alt=\"\"/></span> and press LeftMouseButton + MouseMove or Ctrl + LeftMouseButton + MouseMove.</li><li>Fullscreen: press the button <span><img src = \"/assets/webViewer/css/icons/full.png\" alt=\"\"/></span> to active the fullscreen mode and the button <span><img src = \"/assets/webViewer/css/icons/full_on.png\" alt=\"\"/></span> to exit</li><li>To reset the viewpoint: press R.</li></ul><a href=\"http://vcg.isti.cnr.it/rti/webviewer.php\" target = \"_black\">Visual Computing Lab ISTI CNR Pisa</a></div></div></div>'\r\n\tdivHelp.style.display = \"none\";\r\n\tcanvasNode.append(divHelp);\r\n\t\r\n\t$( \"#\"+idDiv + \"_div #zoomIn\" ).button({\r\n      icons: {\r\n        primary: \"zoomInIcon toolbarIcon\"\r\n      },\r\n\t  text: false,\r\n      label: \"Zoom In\"\r\n    }).click(function(){multiResRTI.startZoomIn();});\r\n\t\r\n\t$( \"#\"+idDiv + \"_div #zoomOut\" ).button({\r\n      icons: {\r\n        primary: \"zoomOutIcon toolbarIcon\"\r\n      },\r\n\t  text: false,\r\n      label: \"Zoom Out\"\r\n    }).click(function(){multiResRTI.startZoomOut();});\r\n\r\n\t$( \"#\"+idDiv + \"_div #light\" ).button({\r\n      icons: {\r\n        primary: \"lightIcon toolbarIcon\"\r\n      },\r\n      text: false,\r\n\t  label: \"Light Off\"\r\n    }).click(function(){\r\n\t\tvar options;\r\n\t\tif ( $.trim($( this ).text()) == \"Light Off\" ) \r\n\t\t{\r\n\t\t\toptions = {\r\n\t\t\t\tlabel: \"Light On\",\r\n\t\t\t\ticons: {\r\n\t\t\t\t\tprimary: \"lightOnIcon toolbarIcon\"\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tmultiResRTI.setMode(1);\r\n\t\t} else {\r\n\t\t\toptions = {\r\n\t\t\t\tlabel: \"Light Off\",\r\n\t\t\t\ticons: {\r\n\t\t\t\t\tprimary: \"lightIcon toolbarIcon\"\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tmultiResRTI.setMode(0);\r\n\t\t}\r\n\t\t$( this ).button( \"option\", options );\r\n\t});\r\n\t\r\n\t$( \"#\"+idDiv + \"_div #help\" ).button({\r\n      icons: {\r\n        primary: \"helpIcon toolbarIcon\"\r\n      },\r\n\t  text: false,\r\n      label: \"Help\"\r\n    }).click(function(){$( \"#\"+idDiv + \"_guide\" ).show();});\r\n\t\r\n\t\r\n\tfunction fullScreenOn(){\r\n\t\tvar i = document.getElementById(idDiv + \"_div\");\r\n\t\tif (i.requestFullscreen) {\r\n\t\t\ti.requestFullscreen();\r\n\t\t} else if (i.webkitRequestFullscreen) {\r\n\t\t\ti.webkitRequestFullscreen();\r\n\t\t} else if (i.mozRequestFullScreen) {\r\n\t\t\ti.mozRequestFullScreen();\r\n\t\t} else if (i.msRequestFullscreen) {\r\n\t\t\ti.msRequestFullscreen();\r\n\t\t}\r\n\t\t\r\n\t\ti.style.height = screen.height + \"px\";\r\n\t\ti.style.width = screen.width + \"px\";\r\n\t\tvar canvas = $(\"#\" + idDiv + \"_webgl\");\r\n\t\tcanvas.height(screen.height);\r\n\t\tcanvas.width(screen.width);\r\n\t\tcanvas.attr(\"width\", screen.width);\r\n\t\tcanvas.attr(\"height\", screen.height);\r\n\t\tmultiResRTI.resize();\r\n\t\tfullscreen = true\r\n\t\tvar options = {\r\n\t\t\t\t\tlabel: \"Exit Fullscreen\",\r\n\t\t\t\t\ticons: {\r\n\t\t\t\t\t\tprimary: \"fullOnIcon toolbarIcon\"\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t$( \"#\"+idDiv + \"_div #fullscreen\").button( \"option\", options );\r\n\t};\r\n\t\r\n\tfunction fullScreenOff(){\r\n\t\tvar i = document.getElementById(idDiv + \"_div\");\r\n\t\tif (document.exitFullscreen) {\r\n\t\t\tdocument.exitFullscreen();\r\n\t\t} else if (document.webkitExitFullscreen) {\r\n\t\t\tdocument.webkitExitFullscreen();\r\n\t\t} else if (document.mozCancelFullScreen) {\r\n\t\t\tdocument.mozCancelFullScreen();\r\n\t\t} else if (document.msExitFullscreen) {\r\n\t\t\tdocument.msExitFullscreen();\r\n\t\t}\r\n\t\ti.style.height = canvasHeight + \"px\";\r\n\t\ti.style.width = canvasWidth + \"px\";\r\n\t\tvar canvas = $(\"#\" + idDiv + \"_webgl\");\r\n\t\tcanvas.height(canvasHeight);\r\n\t\tcanvas.width(canvasWidth);\r\n\t\tcanvas.attr(\"width\", canvasWidth);\r\n\t\tcanvas.attr(\"height\", canvasHeight);\r\n\t\tmultiResRTI.resize();\r\n\t\tfullscreen = false;\r\n\t\tvar options = {\r\n\t\t\t\t\tlabel: \"Active Fullscreen\",\r\n\t\t\t\t\ticons: {\r\n\t\t\t\t\t\tprimary: \"fullIcon toolbarIcon\"\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t$( \"#\"+idDiv + \"_div #fullscreen\").button( \"option\", options );\r\n\t};\r\n\t\r\n\t$( \"#\"+idDiv + \"_div #fullscreen\" ).button({\r\n      icons: {\r\n        primary: \"fullIcon toolbarIcon\"\r\n      },\r\n\t  text: false,\r\n      label: \"Active Fullscreen\"\r\n    }).click(\r\n\tfunction(){\r\n\t\t\tvar options;\r\n\t\t\tif (!fullscreen)\r\n\t\t\t\tfullScreenOn();\r\n\t\t\telse\r\n\t\t\t\tfullScreenOff();\r\n\t\t\t$(\"#\"+idDiv + \"_div #fullscreen\").removeClass(\"ui-state-hover\");\r\n\t\t}\r\n\t);\r\n\t\r\n\tdocument.addEventListener(\"MSFullscreenChange\", function () {\r\n    if(!document.msFullscreenElement) fullScreenOff();\r\n\t}, false);\r\n\tdocument.addEventListener(\"mozfullscreenchange\", function () {\r\n\t\tif(!document.mozFullScreen) fullScreenOff();\r\n\t}, false);\r\n\tdocument.addEventListener(\"webkitfullscreenchange\", function () {\r\n\t\tif(!document.webkitIsFullScreen) fullScreenOff();\r\n\t}, false);\r\n\t\t\r\n\t$( \"#\"+idDiv + \"_guide\" ).click(function(){$( \"#\"+idDiv + \"_guide\" ).hide();});\r\n\t\r\n\t\r\n\tvar divError = document.createElement(\"div\");\r\n\tdivError.id = idDiv + \"_error\";\r\n\tdivError.style.width = \"100%\";\r\n\tdivError.style.height = \"100%\";\r\n\tdivError.style.position = \"absolute\";\r\n\tdivError.style.left = \"0px\";\r\n\tdivError.style.top = \"0px\";\r\n\tdivError.style.color = \"#FFFFFF\";\r\n\tdivError.style.backgroundColor=\"rgba(0, 0, 0, 1.0)\";\r\n\t\r\n\tdivError.innerHTML = '<canvas id = \"testCanvas\" width= \"800\" height= \"600\" contenteditable=\"true\"></canvas>';\r\n\tdivError.style.display = \"none\";\r\n\tcanvasNode.append(divError);\r\n\tif (sglGetCanvasContext(\"testCanvas\") == null)\r\n\t{\r\n\t\tdivError.style.display = \"block\";\r\n\t\tdivError.innerHTML = '<div id = \"contentError\" style = \"width: 90%; height: 100%; text-align:left; padding:0% 5% 0% 5%; font-family:  Verdana,sans-serif; overflow-y: scroll;\"><h3>WebGL is not available or not enabled.</h3><p><a href=\"http://en.wikipedia.org/wiki/WebGL\">WebGL</a> is the technology we use to display the RTI images. It is currently supported, but sometimes not enabled by default, by recent versions of <a href=\"http://www.mozilla.org/firefox\">Firefox</a>, <a href=\"http://www.google.com/chrome\">Chrome</a> and <a href=\"http://www.apple.com/safari\">Safari</a>. An external plugins is available for <a href=\"http://microsoft.com/ie\">Internet  Explorer</a>.<br/> It also requires a moderately recent and capable hardware and up to date drivers.</p><p><b>Chrome</b><br/>Type \"chrome://flags\" in the address bar.<br/>Disable (yes, it is a confusing double negation!) the WebGL entry.<br/>Click the <em>relaunch now</em> button at the bottom.</p><p><b>Firefox</b><br/>Type \"about:config\" in the address bar<br/>Type \"webgl\" in the <em>Filter</em>.<br/>Doubleclick the entry <b>webgl.force-enable</b>, and restart Firefox.</p><p><b>Safari</b><br/>Open the Safari menu and select Preferences.<br/>Then, click the Advanced tab in the Preferences window.<br/>Then, at the bottom of the window, check the Show Develop menu in menu bar checkbox.<br/>Then, open the Develop menu in the menu bar and select Enable WebGL.</p><p><b>Internet Explorer (from version 9.0)</b><br/>Install the <a href=\"http://www.google.com/chromeframe\">Chrome Frame</a> <br/>Open the Tools menu and select Manage add-ons.<br/>Then, enable the ChromeFrame BHO plugins and restart Internet Explorer.<br/></p><p><b>Installing updated drivers</b><br/>If the visualization of the RTI image fails you must update the drivers of your graphics cards.</p></div>'\r\n\t}\r\n\telse\r\n\t{\r\n\t\tdivError.innerHTML = '';\r\n\t\tvar multiResRTI = new MultiRes(canvasName);\r\n\t\tif($.type(imageUrlOrFunction) === \"string\") {\r\n\t\t\tmultiResRTI.setImageUrl(imageUrlOrFunction);\t\r\n\t\t}\r\n\t\telse {\r\n\t\t\tmultiResRTI.setImageFunction(imageUrlOrFunction);\r\n\t\t}\r\n\t\t\r\n\t\tfunction isRelitable(type){\r\n\t\t\tif (type ==  \"IMAGE\")\r\n\t\t\t{\r\n\t\t\t\t$( \"#\"+idDiv + \"_div #light\" ).css(\"display\", \"none\");\r\n\t\t\t}\r\n\t\t\t$( \".toolbar\").css(\"visibility\", \"visible\");\r\n\t\t};\r\n\t\tmultiResRTI.setOnLoadImageCallback(isRelitable);\r\n\t\tsglRegisterCanvas(canvasName, multiResRTI, 10.0);\r\n\t}\r\n}\r\n\r\n\r\n\r\nfunction log(msg) \r\n{\r\n\t//console.log(msg);\r\n}\r\n\r\nfunction MultiRes(canvas)\r\n{\r\n\tthis.mode = 0;\r\n\tthis.stepAnimation = 0;\r\n\tthis.idTimer;\r\n\tthis.flipAngles = [];\r\n\tthis.flipAngles[0] = 0.0;\r\n\tthis.canvas = canvas;\r\n\tthis.rendering = false;\r\n\tthis.onDrawCallback = null;\r\n\tthis.animating = false;\r\n\tthis.moveToCenter = false;\r\n\tthis.imageUrl = \"\";\r\n\tthis.imageFunction = null;\r\n\tthis.OnLoadImageCallback = null;\r\n\t\r\n\tthis.currentSpeed = 0.0;\r\n\tthis.maxStep = 7;\r\n\tthis.animationStack = [];\r\n\tthis.isMoving = false;\r\n\tfor (var  i = 1; i < 21; i++)\r\n\t\tthis.flipAngles[i] = SGL_PI / 2.0 * (Math.sin(i / 40.0 * SGL_PI));\r\n}\r\n\r\nMultiRes.prototype = {\r\n\r\n\tsetMode: function(x)\r\n\t{\r\n\t\tthis.mode = x;\r\n\t},\t\t\t\r\n\r\n\t\r\n\t_setLightDir : function(x, y) \r\n\t{\r\n\t\tvar lx = ((x / this.ui.width) * 2.2 - 1.1);\r\n\t\tvar ly = ((y / this.ui.height) * 2.2 - 1.1);\r\n\t\tlx = Math.min(1.0, Math.max(-1.0, lx));\r\n\t\tly = Math.min(1.0, Math.max(-1.0, ly));\r\n\t\tvar norm = Math.sqrt(lx*lx + ly*ly);\r\n\t\tif (norm > 1.0)\r\n\t\t\tnorm = 1.0;\r\n\t\tvar alpha = Math.PI / 2;\r\n\t\tif (lx != 0.0)\r\n\t\t\talpha = Math.atan2(ly, lx);\r\n\t\tlx = norm * Math.cos(alpha);\r\n\t\tly = norm * Math.sin(alpha);\r\n\t\tvar lpos = []\r\n\t\tif (norm < 1.0)\r\n\t\t\tlpos = [lx, ly, Math.sqrt(1.0 - lx*lx - ly*ly)];\r\n\t\telse\r\n\t\t\tlpos = [lx, ly, 0.0];\r\n\t\tlpos = sglNormalizedV3(lpos);\r\n\t\tthis.renderer.lightPos = lpos.slice(0, 3);\r\n\t\tthis.renderer.lweights = this.renderer.computeLightingFunction(lpos);\r\n\t},\r\n\r\n\tresetViewpoint : function()\r\n\t{\r\n\t\tthis.translation[0] = 0.0;\r\n\t\tthis.translation[1] = 0.0;\r\n\t\tthis.mat = sglIdentityM4();\r\n\t\tthis.flipMatrix = sglIdentityM4();\r\n\t},\r\n\t\r\n\t\r\n\tsetImageUrl: function(url)\r\n\t{\r\n\t\tthis.imageUrl = url;\r\n\t},\r\n\tsetImageFunction: function(imageFunction)\r\n\t{\r\n\t\tthis.imageFunction = imageFunction;\r\n\t},\r\n\t\r\n\tsetOnLoadImageCallback: function(callback)\r\n\t{\r\n\t\tthis.OnLoadImageCallback = callback;\r\n\t},\r\n\r\n\tload : function(gl)\r\n\t{\r\n\t\tlog(\"SpiderGL Version : \" + SGL_VERSION_STRING + \"\\n\");\r\n\t\t/*************************************************************/\r\n\t\tthis.xform  = new SglTransformStack();\r\n\t\t/*************************************************************/\r\n\r\n\t\tthis.renderer = new MultiResRenderer(gl, 256 * 1024 * 1024);\r\n\t\t\r\n\t\tthis.translation = [ 0.0, 0.0 ];\r\n\t\tthis.mat = sglIdentityM4();\r\n\t\tthis.flipMatrix = sglIdentityM4();\r\n\t\tif (this.imageUrl != \"\")\r\n\t\t\tthis.loadImage(this.imageUrl);\r\n\t\telse if(this.imageFunction !== null)\r\n\t\t\tthis.loadImage(this.imageFunction);\r\n\t},\r\n\t\r\n\t\r\n\tloadImage : function(url)\r\n\t{\r\n\t\tthis.renderer.loadImage(url);\r\n\t\tthis.OnLoadImageCallback(this.renderer.type);\r\n\t\tthis.xform  = new SglTransformStack();\r\n\t\tthis.translation = [ 0.0, 0.0 ];\r\n\t\tthis.mat = sglIdentityM4();\r\n\t\tthis.rendering = true;\r\n\t\t\r\n\t\tthis.leftBottom = [(this.renderer._tree.scale[0] - this.renderer.imgWidth) / 2.0, (this.renderer._tree.scale[1] - this.renderer.imgHeight) / 2.0];\r\n\t\tthis.rightTop = [this.leftBottom[0] + this.renderer.imgWidth, this.leftBottom[1] + this.renderer.imgHeight];\r\n\t\t\r\n\t\tthis.scale = 0;\r\n\t\tvar w = this.ui.width;\r\n\t\tvar h = this.ui.height;\r\n\t\tvar scale1 = this.renderer._tree.scale[0] / this.renderer.imgWidth * w;\r\n\t\tvar scale2 = this.renderer._tree.scale[1] / this.renderer.imgHeight * h;\r\n\t\tthis.scale = Math.min(scale1, scale2);\r\n\t\tthis.maxScale = Math.max(this.renderer.imgWidth / w, this.renderer.imgHeight / h) * 2.5;\r\n\t\tthis.viewerdx = 100;\r\n\t\tthis.viewerdy = 100;\r\n\t},\t\t\t\r\n\t\r\n\t\r\n\tstopRendering: function()\r\n\t{\r\n\t\tthis.rendering = false;\r\n\t},\r\n\t\r\n\tsetOnDrawCallback: function(onDraw)\r\n\t{\r\n\t\tif (onDraw)\r\n\t\t\tthis.onDrawCallback = onDraw;\r\n\t},\r\n\r\n\tkeyDown : function(gl, keyCode, keyString)\r\n\t{\r\n\t\tif (keyString == \"R\") this.resetViewpoint();\r\n\t\tif (keyString == \"1\") this.renderer.renderData = !this.renderer.renderData;\r\n\t\tif (keyString == \"2\") this.renderer.renderBoxes = !this.renderer.renderBoxes;\r\n\t},\r\n \r\n\tmouseWheel : function(gl, delta, x, y)\r\n\t{\r\n\t\tif (this.isMoving)\r\n\t\t\treturn false;\r\n\t\tvar tx = x - this.translation[0];\r\n\t\tvar ty = y - this.translation[1];\r\n\t\tvar s = sglPow(0.98, 10 * delta);\r\n\t\tthis._startZoom(s, tx, ty);\r\n\t},\r\n\t\r\n\t\r\n\tstartZoomIn: function()\r\n\t{\r\n\t\tif (this.isMoving)\r\n\t\t\treturn false;\r\n\t\tvar tx = this.ui.width / 2.0 - this.translation[0];\r\n\t\tvar ty = this.ui.height / 2.0 - this.translation[1];\r\n\t\tvar s = 1.2;\r\n\t\tthis._startZoom(s, tx, ty);\r\n\t},\r\n\t\r\n\t\r\n\tstartZoomOut: function()\r\n\t{\r\n\t\tif (this.isMoving)\r\n\t\t\treturn false;\r\n\t\tvar tx = this.ui.width / 2.0 - this.translation[0];\r\n\t\tvar ty = this.ui.height / 2.0 - this.translation[1];\r\n\t\tvar s = 0.8;\r\n\t\tthis._startZoom(s, tx, ty);\r\n\t},\r\n\t\r\n\t\r\n\t_startZoom: function(s, tx, ty)\r\n\t{\r\n\t\tvar tmp = this.mat[0] * s;\r\n\t\tif (tmp  > this.maxScale)\r\n\t\t\ts = this.maxScale / this.mat[0];\r\n\t\tif (tmp < 1.0 )\r\n\t\t\ts = 1.0 / this.mat[0];\r\n\t\tif (tmp <= 1.00000001)\r\n\t\t\tthis.moveToCenter = true;\r\n\t\tvar deltaPos = s*this.mat[0] - this.mat[0];\r\n\t\tif (deltaPos > 0.0001 || deltaPos < -0.0001)\r\n\t\t{\r\n\t\t\tthis.animationStack = [];\r\n\t\t\tvar t = this.maxStep * 2; \r\n\t\t\tvar d = 3 * deltaPos /(t * t * t);\r\n\t\t\tvar b = -2 * t * d;\r\n\t\t\tvar speed = d * t * t;\r\n\t\t\tvar tmpScale = this.mat[0];\r\n\t\t\tfor (var i = 0; i < t; i++)\r\n\t\t\t{\r\n\t\t\t\tvar delta = d * i + d / 3.0 + b / 2.0 + speed;\r\n\t\t\t\tspeed += d * (2*i + 1) + b;\r\n\t\t\t\tvar deltaScale = 1 + delta / tmpScale;\r\n\t\t\t\ttmpScale += delta;\r\n\t\t\t\tthis.animationStack.push([deltaScale, tx, ty]);\r\n\t\t\t}\r\n\t\t\tthis.animating = this.moveToCenter;\r\n\t\t\tvar that = this;\r\n\t\t\tclearInterval(this.moveInterval);\r\n\t\t\tclearInterval(this.zoomInterval);\r\n\t\t\tthis.zoomInterval = setInterval(function(){that._zoomAnimation();}, 35);\r\n\t\t\tthis.renderer.updateData = false;\r\n\t\t\tthis.isMoving = this.moveToCenter;\r\n\t\t}\r\n\t\telse if (this.moveToCenter)\r\n\t\t{\r\n\t\t\tthis.animating = true;\r\n\t\t\tthis.isMoving = true;\r\n\t\t\tvar that = this;\r\n\t\t\tthis.animationStack = [];\r\n\t\t\tclearInterval(this.moveInterval);\r\n\t\t\tclearInterval(this.zoomInterval);\r\n\t\t\tthis.zoomInterval = setInterval(function(){that._zoomAnimation();}, 35);\r\n\t\t\tthis.renderer.updateData = false;\r\n\t\t}\r\n\t\treturn false;\r\n\t},\r\n\t\r\n\t_zoomAnimation: function()\r\n\t{\r\n\t\tif (this.animationStack.length == 0)\r\n\t\t{\r\n\t\t\tclearInterval(this.zoomInterval);\r\n\t\t\tif (this.moveToCenter)\r\n\t\t\t{\r\n\t\t\t\tvar that = this;\r\n\t\t\t\tclearInterval(this.moveInterval);\r\n\t\t\t\tthis.moveInterval = setInterval(function(){that._moveAnimation();}, 35);\r\n\t\t\t\tthis.renderer.updateData = false;\r\n\t\t\t\tthis.isMoving = true;\r\n\t\t\t\t\r\n\t\t\t\tthis.computeModelMatrix();\t\t\t\t\r\n\t\t\t\tvar matrix = this.xform.model.top;\r\n\t\t\t\tvar tempPos = [this.renderer._tree.scale[0] / 2.0, this.renderer._tree.scale[1] / 2.0 ];\r\n\t\t\t\tvar endPoint = [this.ui.width/2.0, this.ui.height/2.0];\r\n\t\t\t\tvar pos = sglMulM4V4(matrix, sglV4C(tempPos[0], tempPos[1], 0.0, 1.0)).slice(0,2);\r\n\t\t\t\tvar deltaX = endPoint[0] - pos[0];\r\n\t\t\t\tvar deltaY = endPoint[1] - pos[1];\r\n\t\t\t\tthis.currentSpeed = 0;\r\n\t\t\t\tthis.currentPoint = pos;\t\t\t\t\r\n\t\t\t\tthis._updateMoveStack(pos, endPoint, sglV2C(deltaX, deltaY));\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t\tthis.renderer.updateData = true;\r\n\t\t\tthis.animating = false;\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tvar step = this.animationStack.splice(0, 1)[0];\r\n\t\tvar s = step[0];\r\n\t\ttx = step[1];\r\n\t\tty = step[2];\r\n\r\n\t\tvar tmpMat = sglMulM4(sglTranslationM4C(tx, ty, 0.0), sglMulM4(sglScalingM4C(s, s, 1.0), sglMulM4(sglTranslationM4C(-tx, -ty, 0.0), this.mat)));\r\n\t\tvar m = this.returnModelMatrix(this.translation, tmpMat);\r\n\t\tvar lb = sglMulM4V4(m, sglV4C(this.leftBottom[0], this.leftBottom[1], 0.0, 1.0)).slice(0,2);\r\n\t\tvar rt = sglMulM4V4(m, sglV4C(this.rightTop[0], this.rightTop[1], 0.0, 1.0)).slice(0,2);\r\n\t\tlb[0] -= this.viewerdx;\r\n\t\tlb[1] -= this.viewerdy;\r\n\t\trt[0] += this.viewerdx;\r\n\t\trt[1] += this.viewerdy;\r\n\t\tvar realwidth = rt[0] - lb[0];\r\n\t\tvar realheight = rt[1] - lb[1];\r\n\t\tvar deltaX = 0;\r\n\t\tvar deltaY = 0;\r\n\t\tif (realwidth > this.ui.width && realheight > this.ui.height)\r\n\t\t{\r\n\t\t\tif (rt[0] < this.ui.width)\r\n\t\t\t\tdeltaX += this.ui.width - rt[0];\r\n\t\t\telse if (lb[0] > 0)\r\n\t\t\t\tdeltaX -= lb[0];\r\n\t\t\tif (rt[1] < this.ui.height)\r\n\t\t\t\tdeltaY += this.ui.height - rt[1];\r\n\t\t\telse if (lb[1] > 0)\r\n\t\t\t\tdeltaY -= lb[1];\r\n\t\t}\r\n\t\telse if (realwidth > this.ui.width)\r\n\t\t{\r\n\t\t\tty = this.ui.height / 2.0 - this.translation[1];\r\n\t\t\tif (rt[0] < this.ui.width)\r\n\t\t\t\tdeltaX += this.ui.width - rt[0];\r\n\t\t\telse if (lb[0] > 0)\r\n\t\t\t\tdeltaX -= lb[0];\r\n\t\t}\r\n\t\telse if (realheight > this.ui.height)\r\n\t\t{\r\n\t\t\ttx = this.ui.width / 2.0 - this.translation[0];\r\n\t\t\tif (rt[1] < this.ui.height)\r\n\t\t\t\tdeltaY += this.ui.height - rt[1];\r\n\t\t\telse if (lb[1] > 0)\r\n\t\t\t\tdeltaY -= lb[1];\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\ttx = this.ui.width / 2.0;\r\n\t\t\tty = this.ui.height / 2.0;\r\n\t\t\tthis.resetViewpoint();\r\n\t\t\tif (this.animationStack.lenght == 0)\r\n\t\t\t{\r\n\t\t\t\tclearInterval(this.zoomInterval);\r\n\t\t\t\tthis.renderer.updateData = true;\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.mat = sglMulM4(sglTranslationM4C(tx, ty, 0.0), sglMulM4(sglScalingM4C(s, s, 1.0), sglMulM4(sglTranslationM4C(-tx, -ty, 0.0), this.mat)));\r\n\t\t\r\n\t\tthis.translation[0] += deltaX;\r\n\t\tthis.translation[1] += deltaY;\r\n\t\t\r\n\t\t_SGL_RegisteredCanvas[this.canvas].requestDraw();\r\n\t\treturn;\t\r\n\t},\r\n\t\r\n\tsendMouseDown : function(e)\r\n\t{\r\n\t\t_SGL_RegisteredCanvas[this.canvas].mouseDown(e);\r\n\t},\r\n \r\n\tmouseDown : function(gl, button, x, y)\r\n\t{\r\n\t\tif (this.animating)\r\n\t\t\treturn false;\r\n\t\tif (button == 0)\r\n\t\t{\r\n\t\t\tif (this.ui.keysDown[17])\r\n\t\t\t{\r\n\t\t\t\tthis._setLightDir(x, y);\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t\tif (this.mode == 0)\r\n\t\t\t{\r\n\t\t\t\tthis.endAnimation = false;\r\n\t\t\t\tthis.currentPoint = [x, y];\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tthis.animationStack = [];\r\n\t\t\t\t\r\n\t\t\t\tvar that = this;\r\n\t\t\t\tclearInterval(this.zoomInterval);\r\n\t\t\t\tclearInterval(this.moveInterval);\r\n\t\t\t\tthis.moveInterval = setInterval(function(){that._moveAnimation();}, 35);\r\n\t\t\t\tthis.renderer.updateData = false;\r\n\t\t\t\tthis.isMoving = true;\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\telse if (this.mode == 1) \r\n\t\t\t\tthis._setLightDir(x, y);\r\n\t\t\treturn true;\r\n\t\t}\r\n\t},\r\n\t\r\n\t_moveAnimation: function()\r\n\t{\r\n\t\tif ((this.moveToCenter ||this.endAnimation) && this.animationStack.length == 0)\r\n\t\t{\r\n\t\t\tclearInterval(this.moveInterval);\r\n\t\t\tthis.renderer.updateData = true;\r\n\t\t\tthis.isMoving = false;\r\n\t\t\tthis.animating = false;\r\n\t\t\tthis.moveToCenter = false;\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t\r\n\t\tif (this.animationStack.length == 0)\r\n\t\t{\r\n\t\t\tthis.currentSpeed = 0;\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tvar step = this.animationStack.splice(0, 1)[0];\r\n\t\t\r\n\t\tvar deltaX = step[0] - this.currentPoint[0];\r\n\t\tvar deltaY = step[1] - this.currentPoint[1];\r\n\t\tthis.currentSpeed = step[2];\r\n\t\t\r\n\t\tthis.translation[0] += deltaX;\r\n\t\tthis.translation[1] += deltaY;\r\n\t\t\r\n\t\tthis.currentPoint[0] = step[0];\r\n\t\tthis.currentPoint[1] = step[1];\r\n\t\t\r\n\t\t_SGL_RegisteredCanvas[this.canvas].requestDraw();\r\n\t\treturn;\r\n\t},\r\n\t\r\n\t\r\n\tmouseUp : function(gl, button, x, y)\r\n\t{\r\n\t\tif (button == 0)\r\n\t\t{\r\n\t\t\tif (this.mode == 0) \r\n\t\t\t{\r\n\t\t\t\tthis.endAnimation = true;\r\n\t\t\t\tthis.renderer.updateData = true;\r\n\t\t\t\tthis.isMoving = false;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn false;\r\n\t},\r\n\t\r\n\tmouseOut:function(gl, button, x, y)\r\n\t{\r\n\t\tthis.endAnimation = true;\r\n\t\tthis.isMoving = false;\r\n\t},\r\n\r\n\tmouseMove: function(gl, x, y)\r\n\t{\r\n\t\tif (this.animating)\r\n\t\t\treturn false;\r\n\t\tif (this.ui.mouseButtonsDown[0])\r\n\t\t{\r\n\t\t\tif (this.mode == 0)\r\n\t\t\t{\r\n\t\t\t\tif (this.ui.keysDown[17])\r\n\t\t\t\t{\r\n\t\t\t\t\tthis._setLightDir(x, y);\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t\tvar endPoint = [x, y];\r\n\t\t\t\tvar deltaX = endPoint[0] - this.currentPoint[0];\r\n\t\t\t\tvar deltaY = endPoint[1] - this.currentPoint[1];\r\n\t\t\t\t\r\n\t\t\t\tvar tmpVector = this._adjustTranslation(deltaX, deltaY);\r\n\t\t\t\tendPoint = [this.currentPoint[0] + tmpVector[0], this.currentPoint[1] + tmpVector[1]];\r\n\t\t\t\tthis._updateMoveStack(this.currentPoint, endPoint, tmpVector);\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t\tthis._setLightDir(x, y);\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t},\r\n\t\r\n\t\r\n\t_updateMoveStack: function(startPoint, endPoint, deltaVect)\r\n\t{\r\n\t\tvar deltaPos = sglLengthV2(deltaVect);\r\n\t\tif (deltaPos > 0.1)\r\n\t\t{\r\n\t\t\tthis.animationStack.splice(0, this.animationStack.length);\r\n\t\t\tvar movementVector = sglNormalizedV2(deltaVect);\r\n\t\t\tvar acceleration = (deltaPos / 2.0 - this.currentSpeed * this.maxStep) * 2.0 / (this.maxStep*this.maxStep);\r\n\t\t\tvar speed = this.currentSpeed;\r\n\t\t\tvar tmpPoint = [startPoint[0], startPoint[1]];\r\n\t\t\tvar totDelta = 0;\r\n\t\t\tvar t = this.maxStep;\r\n\t\t\tvar b = 0;\r\n\t\t\tvar d = 0;\r\n\t\t\tif (acceleration > 0)\r\n\t\t\t{\r\n\t\t\t\tfor (var i = 0 ; i < this.maxStep; i++)\r\n\t\t\t\t{\r\n\t\t\t\t\tvar delta = acceleration / 2.0  + speed;\r\n\t\t\t\t\tspeed += acceleration;\r\n\t\t\t\t\ttotDelta += delta;\r\n\t\t\t\t\tvar x = movementVector[0] * delta;\r\n\t\t\t\t\tvar y = movementVector[1] * delta;\r\n\t\t\t\t\ttmpPoint[0] += x;\r\n\t\t\t\t\ttmpPoint[1] += y;\r\n\t\t\t\t\tthis.animationStack.push([tmpPoint[0], tmpPoint[1], speed, acceleration]);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tt = 3 * deltaPos / (2 * speed);\r\n\t\t\t\td = 4 * speed * speed * speed / (9 * deltaPos * deltaPos);\r\n\t\t\t\tb = - 4 * speed * speed / (3 * deltaPos);\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tt = 6 * deltaPos / (2 * speed);\r\n\t\t\t\td = speed * speed * speed / (9 * deltaPos * deltaPos);\r\n\t\t\t\tb = - 2 * speed * speed / (3 * deltaPos);\r\n\t\t\t}\t\t\t\t\t\r\n\t\t\t\r\n\t\t\tfor (var i = 0 ; i < t; i++)\r\n\t\t\t{\r\n\t\t\t\tvar delta = d * i + d / 3.0 + b / 2.0 + speed;\r\n\t\t\t\tspeed += d * (2*i + 1) + b;\r\n\t\t\t\tvar acc = d * (i + 1) + b; \r\n\t\t\t\tvar x = movementVector[0] * delta;\r\n\t\t\t\tvar y = movementVector[1] * delta;\r\n\t\t\t\ttmpPoint[0] += x;\r\n\t\t\t\ttmpPoint[1] += y;\r\n\t\t\t\tthis.animationStack.push([tmpPoint[0], tmpPoint[1], speed, d]);\r\n\t\t\t}\r\n\t\t\tthis.animationStack.push([endPoint[0], endPoint[1], 0, 0]);\t\r\n\t\t}\r\n\t},\r\n\t\r\n\t_adjustTranslation: function(deltaX, deltaY)\r\n\t{\r\n\t\tvar translVector = sglV4C(this.translation[0] + deltaX, this.translation[1] + deltaY, 0, 1.0);\r\n\t\tvar m = this.returnModelMatrix(translVector, this.mat);\r\n\t\t\r\n\t\tvar lb = sglMulM4V4(m, sglV4C(this.leftBottom[0], this.leftBottom[1], 0.0, 1.0)).slice(0,2);\r\n\t\tvar rt = sglMulM4V4(m, sglV4C(this.rightTop[0], this.rightTop[1], 0.0, 1.0)).slice(0,2);\r\n\t\tlb[0] -= this.viewerdx;\r\n\t\tlb[1] -= this.viewerdy;\r\n\t\trt[0] += this.viewerdx;\r\n\t\trt[1] += this.viewerdy;\r\n\t\tvar realwidth = rt[0] - lb[0];\r\n\t\tvar realheight = rt[1] - lb[1];\r\n\t\tvar realDeltaX = deltaX;\r\n\t\tvar realDeltaY = deltaY;\r\n\t\tif (realwidth > this.ui.width && realheight > this.ui.height)\r\n\t\t{\r\n\t\t\tif (rt[0] < this.ui.width)\r\n\t\t\t\trealDeltaX += this.ui.width - rt[0];\r\n\t\t\telse if (lb[0] > 0)\r\n\t\t\t\trealDeltaX -= lb[0];\r\n\t\t\tif (rt[1] < this.ui.height)\r\n\t\t\t\trealDeltaY += this.ui.height - rt[1];\r\n\t\t\telse if (lb[1] > 0)\r\n\t\t\t\trealDeltaY -= lb[1];\r\n\t\t}\r\n\t\telse if (realwidth > this.ui.width)\r\n\t\t{\r\n\t\t\tif (rt[0] < this.ui.width)\r\n\t\t\t\trealDeltaX += this.ui.width - rt[0];\r\n\t\t\telse if (lb[0] > 0)\r\n\t\t\t\trealDeltaX -= lb[0];\r\n\t\t\trealDeltaY = 0;\r\n\t\t}\r\n\t\telse if (realheight > this.ui.height)\r\n\t\t{\r\n\t\t\tif (rt[1] < this.ui.height)\r\n\t\t\t\trealDeltaY += this.ui.height - rt[1];\r\n\t\t\telse if (lb[1] > 0)\r\n\t\t\t\trealDeltaY -= lb[1];\r\n\t\t\trealDeltaX = 0;\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\trealDeltaX = 0;\r\n\t\t\trealDeltaY = 0;\r\n\t\t}\r\n\t\treturn sglV2C(realDeltaX, realDeltaY);\t\r\n\t},\r\n\t\r\n\tupdate : function(gl, dt)\r\n\t{\r\n\t\t;\r\n\t},\r\n\t\r\n\t\r\n\treturnModelMatrix: function(translVect, scaleMatrix)\r\n\t{\r\n\t\tvar m = (sglMulM4(sglTranslationM4C(translVect[0], translVect[1], 1.0), scaleMatrix));\r\n\t\tm = sglMulM4(this.flipMatrix, m);\r\n\t\tthis.xform.model.load(m);\r\n\t\r\n\t\tvar t = sglTranslationM4C(this.ui.width / 2.0, this.ui.height / 2.0, 0.0);\r\n\t\t\r\n\t\tthis.xform.model.multiply(t);\r\n\t\tthis.xform.model.scale(this.scale, this.scale, 1.0);\r\n\t\tthis.xform.model.multiply(this.renderer.normalizedTreeTransform);\r\n\t\treturn this.xform.model.top;\r\n\t},\r\n\t\r\n\t\r\n\tcomputeModelMatrix: function()\r\n\t{\r\n\t\tvar m = (sglMulM4(sglTranslationM4C(this.translation[0], this.translation[1], 1.0), this.mat));\r\n\t\tm = sglMulM4(this.flipMatrix, m);\r\n\t\tthis.xform.model.load(m);\r\n\t\r\n\t\tvar t = sglTranslationM4C(this.ui.width / 2.0, this.ui.height / 2.0, 0.0);\r\n\t\t\r\n\t\tthis.xform.model.multiply(t);\r\n\t\tthis.xform.model.scale(this.scale, this.scale, 1.0);\r\n\t\tthis.xform.model.multiply(this.renderer.normalizedTreeTransform);\r\n\t},\r\n\t\r\n\t\r\n\tresize : function()\r\n\t{\r\n\t\tthis.xform  = new SglTransformStack();\r\n\t\tthis.translation = [ 0.0, 0.0 ];\r\n\t\tthis.mat = sglIdentityM4();\r\n\t\tthis.rendering = true;\r\n\t\t\r\n\t\tthis.leftBottom = [(this.renderer._tree.scale[0] - this.renderer.imgWidth) / 2.0, (this.renderer._tree.scale[1] - this.renderer.imgHeight) / 2.0];\r\n\t\tthis.rightTop = [this.leftBottom[0] + this.renderer.imgWidth, this.leftBottom[1] + this.renderer.imgHeight];\r\n\t\t\r\n\t\tthis.scale = 0;\r\n\t\tvar w = this.ui.width;\r\n\t\tthis.offsetHeight = 0;\r\n\t\tvar h = this.ui.height + this.offsetHeight;\r\n\t\t\r\n\t\tthis.scale = Math.min(this.renderer._tree.scale[0] / this.renderer.imgWidth * w, this.renderer._tree.scale[1] / this.renderer.imgHeight * h);\r\n\t\tthis.maxScale = Math.max(this.renderer.imgWidth / w, this.renderer.imgHeight / h) * 3;\r\n\t\t\r\n\t\tthis.viewerdx = this.ui.width / 2.0 - 10;\r\n\t\tthis.viewerdy = this.ui.height / 2.0 - 10;\r\n\t},\r\n\t\r\n\r\n\tdraw : function(gl)\r\n\t{\r\n\t\tvar error = gl.getError();\r\n\t\tif (error == gl.CONTEXT_LOST_WEBGL)\r\n\t\t\tconsole.log(\"WebGL Context lost\");\r\n\t\tgl.clearColor(0.0, 0.0, 0.0, 1.0);\r\n\t\tgl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT | gl.STENCIL_BUFFER_BIT);\r\n\t\tif (this.rendering == true)\r\n\t\t{\r\n\t\t\tvar w = this.ui.width;\r\n\t\t\tvar h = this.ui.height;\r\n\r\n\t\t\tgl.viewport(0, 0, w, h);\r\n\r\n\t\t\tthis.xform.projection.loadIdentity();\r\n\t\t\tthis.xform.projection.ortho(0.0, w, 0.0, h, -4096.0, 4096.0);\r\n\r\n\t\t\tthis.xform.view.loadIdentity();\r\n\t\t\tthis.xform.view.lookAt(0.0, 0.0, 2.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0);\r\n\r\n\t\t\tthis.computeModelMatrix();\r\n\t\t\t\t\t\r\n\t\t\tvar m = this.xform.model.top;\r\n\t\t\tif (this.onDrawCallback)\r\n\t\t\t\tthis.onDrawCallback(m);\r\n\t\t\t\r\n\t\t\tthis.renderer.render(this.xform.projectionMatrix, this.xform.modelViewMatrix, [ 0, 0, w, h ]);\r\n\t\t}\r\n\t},\r\n};\r\n\r\n\r\n\r\n\r\nfunction MultiResNode()\r\n{\r\n\tthis.id              = 0;\r\n\tthis.parentIndex     = -1;\r\n\tthis.childrenIndices = [ -1, -1, -1, -1 ];\r\n\tthis.projectedSize   = 1.0;\r\n\tthis.zScale          = 1.0;\r\n\tthis.box             = new SglBox3();\r\n\tthis.priority        = { timestamp: -1, error: Number.MAX_VALUE };\r\n\tthis.req             = null;\r\n\tthis.data            = null;\r\n\tthis.isLeaf          = true;\r\n}\r\n\r\n\r\n\r\nfunction MultiResTree(url, onloadCallback)\r\n{\r\n\tthis.ready      = true;\r\n\tthis.nodesCount = 0;\r\n\tthis.rootIndex  = -1;\r\n\tthis.nodes      = null;\r\n\tthis.url        = null;\r\n\tthis.tileSize   = 0;\r\n\tthis.scale      = [ 1.0, 1.0, 1.0 ];\r\n\tthis.offset     = [ 0.0, 0.0, 0.0 ];\r\n\tthis.forma\t\t= \"\";\r\n\r\n\tif (url)\r\n\t\tthis.load(url, imgW, imgH, onloadCallback);\r\n}\r\n\r\nMultiResTree.prototype = {\r\n\r\n\t_load : function(text, imgW, imgH)\r\n\t{\r\n\t\tthis.ready = true;\r\n\r\n\t\tvar lines = sglGetLines(text);\r\n\t\tvar n = lines.length;\r\n\t\tvar tokens = null;\r\n\t\tvar i = 0;\r\n\r\n\t\tif (n <= i) return;\r\n\t\ttokens = lines[i++].split(\" \");\r\n\t\tif (tokens.length < 2) return;\r\n\t\tvar nodesCount = parseInt(tokens[0]);\r\n\t\tif (nodesCount <= 0) return;\r\n\t\tvar rootIndex = parseInt(tokens[1]);\r\n\t\tif ((rootIndex < 0) || (rootIndex >= nodesCount)) return;\r\n\r\n\t\tif (n <= i) return;\r\n\t\ttokens = lines[i++].split(\" \");\r\n\t\tif (tokens.length < 1) return;\r\n\t\tvar tileSize = parseInt(tokens[0]);\r\n\t\tif (tileSize <= 0) return;\r\n\r\n\t\tif (n <= i) return;\r\n\t\ttokens = lines[i++].split(\" \");\r\n\t\tif (tokens.length < 3) return;\r\n\t\tvar scale = [ 1.0, 1.0, 1.0 ];\r\n\t\tscale[0] = parseFloat(tokens[0]);\r\n\t\tscale[1] = parseFloat(tokens[1]);\r\n\t\tscale[2] = parseFloat(tokens[2]);\r\n\r\n\t\tif (n <= i) return;\r\n\t\ttokens = lines[i++].split(\" \");\r\n\t\tif (tokens.length < 3) return;\r\n\t\tvar offset = [ 0.0, 0.0, 0.0 ];\r\n\t\toffset[0] = parseFloat(tokens[0]);\r\n\t\toffset[1] = parseFloat(tokens[1]);\r\n\t\toffset[2] = parseFloat(tokens[2]);\r\n\r\n\t\tvar nodes = new Array(nodesCount);\r\n\t\tif ( n > i )\r\n\t\t{\r\n\t\t\tfor (var k=0; k<nodesCount; ++k)\r\n\t\t\t{\r\n\t\t\t\tvar node = new MultiResNode();\r\n\r\n\t\t\t\tif (n <= i) return;\r\n\t\t\t\ttokens = lines[i++].split(\" \");\r\n\t\t\t\tif (tokens.length < 14) return;\r\n\r\n\t\t\t\tnode.id = parseInt(tokens[0]);\r\n\t\t\t\tif (node.id <= 0) return;\r\n\r\n\t\t\t\tnode.parentIndex = parseInt(tokens[1]);\r\n\t\t\t\tif ((node.parentIndex < -1) || (node.parentIndex >= nodesCount)) return;\r\n\r\n\t\t\t\tfor (var c=0; c<4; ++c) \r\n\t\t\t\t{\r\n\t\t\t\t\tnode.childrenIndices[c] = parseInt(tokens[c+2]);\r\n\t\t\t\t\tif ((node.childrenIndices[c] < -1) || (node.childrenIndices[c] >= nodesCount)) return;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnode.projectedSize = parseFloat(tokens[6]);\r\n\r\n\t\t\t\tnode.zScale = parseFloat(tokens[7]);\r\n\r\n\t\t\t\tnode.box.min[0] = parseFloat(tokens[ 8]);\r\n\t\t\t\tnode.box.min[1] = parseFloat(tokens[ 9]);\r\n\t\t\t\tnode.box.min[2] = parseFloat(tokens[10]);\r\n\t\t\t\tnode.box.max[0] = parseFloat(tokens[11]);\r\n\t\t\t\tnode.box.max[1] = parseFloat(tokens[12]);\r\n\t\t\t\tnode.box.max[2] = parseFloat(tokens[13]);\r\n\r\n\t\t\t\tnode.isLeaf = true;\r\n\t\t\t\tfor (var j=0; j<4; ++j) \r\n\t\t\t\t{\r\n\t\t\t\t\tif (node.childrenIndices[j] >= 0) \r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tnode.isLeaf = false;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnodes[k] = node;\r\n\t\t\t}\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\tvar index = 0;\r\n\t\t\tvar temp = scale[0];\r\n\t\t\tvar nLevel = 1;\r\n\t\t\twhile (temp > tileSize)\r\n\t\t\t{\r\n\t\t\t\tnLevel++;\r\n\t\t\t\ttemp /= 2;\r\n\t\t\t}\r\n\t\t\tvar woffset = ((scale[0] - imgW) / 2.0) / scale[0];\r\n\t\t\tvar hoffset = ((scale[1] - imgH) / 2.0) / scale[1];\r\n\t\t\tvar imgBox = new SglBox3([woffset, hoffset, 0], [woffset + imgW / scale[0] , hoffset + imgH / scale[1], 1.0]);\r\n\t\t\tvar imgSize = imgBox.size;\r\n\t\t\tvar imgCenter = imgBox.center;\r\n\t\t\tfor (var i = 0; i < nLevel; i++)\r\n\t\t\t{\r\n\t\t\t\tvar count = Math.pow(4, i);\r\n\t\t\t\tfor (var j = 0; j < count; j++)\r\n\t\t\t\t{\r\n\t\t\t\t\tvar node = new MultiResNode();\r\n\t\t\t\t\tnode.id = index + 1;\r\n\t\t\t\t\tif (index > 0)\r\n\t\t\t\t\t\tnode.parentIndex = Math.ceil(index / 4) - 1;\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tnode.parentIndex = -1;\r\n\t\t\t\t\tif (i < nLevel - 1)\r\n\t\t\t\t\t\tnode.isLeaf = false;\r\n\t\t\t\t\tfor (var c=0; c<4; ++c) \r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif (i == nLevel - 1)\r\n\t\t\t\t\t\t\tnode.childrenIndices[c] = -1;\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tnode.childrenIndices[c] = index * 4 + 1 + (c + 2) % 4;\r\n\t\t\t\t\t}\t\t\t\t\t\r\n\t\t\t\t\tnode.projectedSize = tileSize;\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tif (index > 0)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar t = index % 4;\r\n\t\t\t\t\t\tvar parentNode = nodes[node.parentIndex];\r\n\t\t\t\t\t\tvar halfW = parentNode.box.min[0] + (parentNode.box.max[0] -  parentNode.box.min[0]) / 2.0;\r\n\t\t\t\t\t\tvar halfH = parentNode.box.min[1] + (parentNode.box.max[1] -  parentNode.box.min[1]) / 2.0;\r\n\t\t\t\t\t\tif (t == 1)\r\n\t\t\t\t\t\t\tnode.box = new SglBox3([parentNode.box.min[0], halfH, 0.0], [halfW, parentNode.box.max[1], 1.0]);\r\n\t\t\t\t\t\telse if (t == 2)\r\n\t\t\t\t\t\t\tnode.box = new SglBox3([halfW, halfH, 0.0], parentNode.box.max);\r\n\t\t\t\t\t\telse if (t == 3)\r\n\t\t\t\t\t\t\tnode.box = new SglBox3(parentNode.box.min, [halfW, halfH, 1.0]);\r\n\t\t\t\t\t\telse if (t == 0)\r\n\t\t\t\t\t\t\tnode.box = new SglBox3([halfW, parentNode.box.min[1], 0.0], [parentNode.box.max[0], halfH, 1.0]);\r\n\t\t\t\t\t\tvar center = node.box.center;\r\n\t\t\t\t\t\tvar size = node.box.size;\r\n\t\t\t\t\t\tvar halfSize = sglSelfMulV3S(sglAddV3(imgSize, size), 0.5);\r\n\t\t\t\t\t\tvar diff = sglSubV3(imgCenter, center);\r\n\t\t\t\t\t\tif (Math.abs(diff[0]) <= halfSize[0] && Math.abs(diff[1]) <= halfSize[1] && Math.abs(diff[2]) <= halfSize[2])\r\n\t\t\t\t\t\t\tnode.zScale = 1;\r\n\t\t\t\t\t\telse \r\n\t\t\t\t\t\t\tnode.zScale = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tnode.box = new SglBox3([0.0, 0.0, 0.0], [1.0, 1.0, 1.0]);\r\n\t\t\t\t\t\tnode.zScale = 1;\r\n\t\t\t\t\t}\t\r\n\t\t\t\t\tnodes[index] = node;\r\n\t\t\t\t\tindex++;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.nodesCount = nodesCount;\r\n\t\tthis.rootIndex  = rootIndex;\r\n\t\tthis.tileSize   = tileSize;\r\n\t\tthis.scale      = scale;\r\n\t\tthis.offset     = offset;\r\n\t\tthis.nodes      = nodes;\r\n\t},\r\n\r\n\tdestroy : function(destroyData)\r\n\t{\r\n\t\tvar n = null;\r\n\t\tfor (var i in this.nodes) \r\n\t\t{\r\n\t\t\tn = this.nodes[i];\r\n\t\t\tif (n.req) \r\n\t\t\t{\r\n\t\t\t\tn.req.onLoad = null;\r\n\t\t\t\tn.req = null;\r\n\t\t\t}\r\n\t\t\tif (n.data) \r\n\t\t\t{\r\n\t\t\t\tdestroyData(n.data);\r\n\t\t\t\tn.data = null;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tthis.ready      = true;\r\n\t\tthis.nodesCount = 0;\r\n\t\tthis.rootIndex  = -1;\r\n\t\tthis.nodes      = null\r\n\t\tthis.url        = null;\r\n\t\tthis.tileSize   = 0;\r\n\t\tthis.scale      = [ 1.0, 1.0, 1.0 ];\r\n\t},\r\n\r\n\tload : function(url, imgW, imgH, onloadCallback)\r\n\t{\r\n\t\tif (!url) return false;\r\n\t\tthis._load(url, imgW, imgH);\r\n\t},\r\n\r\n\tget isEmpty() \r\n\t{\r\n\t\treturn (this.nodesCount <= 0);\r\n\t},\r\n\r\n\tget root() \r\n\t{\r\n\t\tvar idx = this.rootIndex;\r\n\t\tif (idx < 0) return null;\r\n\t\treturn this.nodes[idx];\r\n\t},\r\n\r\n\tparent : function(n)\r\n\t{\r\n\t\tvar idx = n.parentIndex;\r\n\t\tif (idx < 0) return null;\r\n\t\treturn this.nodes[idx];\r\n\t},\r\n\r\n\tchild: function(n, i)\r\n\t{\r\n\t\tvar idx = n.childrenIndices[i];\r\n\t\tif (idx < 0) return null;\r\n\t\treturn this.nodes[idx];\r\n\t}\r\n};\r\n\r\nfunction _MultiResAssert(cond) \r\n{\r\n\tif (cond) return;\r\n\talert(\"MultiResAssert FAILED : \" + cond);\r\n}\r\n\r\nfunction _MultiResCompareNodes(a, b)\r\n{\r\n\t// higher timestamp first\r\n\tif (a.priority.timestamp != b.priority.timestamp)\r\n\t\treturn (b.priority.timestamp - a.priority.timestamp);\r\n\t\r\n\t// higher error first\r\n\tif (a.priority.error != b.priority.error)\r\n\t\treturn (b.priority.error - a.priority.error);\r\n\r\n\t// lower id first\r\n\treturn (a.id - b.id);\r\n};\r\n\r\nfunction MultiResRenderer(gl, cacheSizeInBytes, onLoad)\r\n {\r\n\tthis.lg = true;\r\n\tthis.gl = gl;\r\n\tthis._tree = new MultiResTree();\r\n\tthis._timestamp = 0;\r\n\tthis._frustum = new SglFrustum();\r\n\tthis._maxError = 1.0;\r\n\tthis._cache = [ ];\r\n\tthis._cacheSizeInBytes = cacheSizeInBytes;\r\n\tthis._maxCacheSize = 1;\r\n\tthis._maxOngoingRequests = 2;\r\n\tthis._currentOngoingRequests = 0;\r\n\tthis._toRequest = [ ];\r\n\tthis._toRenderFullRes = [ ];\r\n\tthis._toRenderHalfRes = [ ];\r\n\tthis._readyItems = [ ];\r\n\r\n\tthis.renderData  = true;\r\n\tthis.renderBoxes = false;\r\n\t//this.lightPos    = [ 0.0, 0.0, 1.0 ];\r\n\t//this.lweights \t = this.computeLightingFunction(this.lightPos);\r\n\r\n\t// box mesh\r\n\t/******************************************************/\r\n\tvar boxPositions = new Float32Array([\r\n\t\t-0.5, -0.5,  0.5,\r\n\t\t 0.5, -0.5,  0.5,\r\n\t\t-0.5,  0.5,  0.5,\r\n\t\t 0.5,  0.5,  0.5,\r\n\t\t-0.5, -0.5, -0.5,\r\n\t\t 0.5, -0.5, -0.5,\r\n\t\t-0.5,  0.5, -0.5,\r\n\t\t 0.5,  0.5, -0.5\r\n\t ]);\r\n\r\n\tvar trianglesIndices = new Uint16Array([\r\n\t\t0, 1, 2,  2, 1, 3,  // front\r\n\t\t5, 4, 7,  7, 4, 6,  // back\r\n\t\t4, 0, 6,  6, 0, 2,  // left\r\n\t\t1, 5, 3,  3, 5, 7,  // right\r\n\t\t2, 3, 6,  6, 3, 7,  // top\r\n\t\t4, 5, 0,  0, 5, 1   // bottom\r\n\t]);\r\n\r\n\tvar edgesIndices = new Uint16Array([\r\n\t\t0, 1, 1, 3, 3, 2, 2, 0,  // front\r\n\t\t5, 4, 4, 6, 6, 7, 7, 5,  // back\r\n\t\t0, 4, 1, 5, 3, 7, 2, 6   // middle\r\n\t]);\r\n\r\n\tvar box = new SglMeshGL(gl);\r\n\r\n\tbox.addVertexAttribute(\"position\", 3, boxPositions);\r\n\tbox.addIndexedPrimitives(\"triangles\", gl.TRIANGLES, trianglesIndices);\r\n\tbox.addIndexedPrimitives(\"edges\",     gl.LINES,     edgesIndices);\r\n\r\n\tthis._boxMesh = box;\r\n\t/******************************************************/\r\n\r\n\t/******************************************************/\r\n\tthis._tileFullMesh = null;\r\n\tthis._tileHalfMesh = null;\r\n\t/******************************************************/\r\n\r\n\t// image rendering\r\n\t/******************************************************/\r\n\tthis._program = null;\r\n\t/******************************************************/\r\n\r\n\t// box rendering\r\n\t/******************************************************/\r\n\tvar bvs = sglLoadFile(\"/assets/webViewer/spidergl/box.v.glsl\");\r\n\tvar bfs = sglLoadFile(\"/assets/webViewer/spidergl/box.f.glsl\");\r\n\tvar bprg = new SglProgram(gl, [bvs], [bfs]);\r\n\tlog(bprg.log);\r\n\r\n\tthis._boxProgram  = bprg;\r\n\tthis._boxRenderer = new SglMeshGLRenderer(this._boxProgram);\r\n\t/******************************************************/\r\n\r\n\tthis._treeTransform = sglIdentityM4();\r\n\tthis._normalizedTreeTransform = sglIdentityM4();\r\n\r\n\tthis.updateData = true;\r\n\r\n\tvar texVsrc = \"#ifdef GL_ES\\n\" + \"precision highp float;\\n\" + \"#endif\\n\" + \"uniform   mat4 u_mvp;\\n\" + \"attribute vec2 a_position;\\n\" + \"attribute vec2 a_texcoord;\\n\" + \"varying   vec2 v_texcoord;\\n\" + \"void main(void){\\n\" +\"v_texcoord  = a_texcoord;\\n\" + \"gl_Position = u_mvp * vec4(a_position, 0.0, 1.0);\\n}\";\r\n\tvar texFsrc = \"#ifdef GL_ES\\n\" + \"precision highp float;\\n\" + \"#endif\\n\" + \"uniform sampler2D s_texture;\\n\" + \"varying vec2     v_texcoord;\\n\" + \"void main(void){\" + \"vec4 color = texture2D(s_texture, v_texcoord).xyzw;\\n\" + \"if (color.w > 0.7)\\n\" + \"gl_FragData[0] = vec4(color.rgb, 1.0);\\n\" + \"else\\n\" +\r\n\t\"gl_FragData[0] = vec4(0.0);}\";\t\r\n\tthis.texProg = new SglProgram(this.gl, [texVsrc], [texFsrc]);\r\n\tlog(this.texProg.log);\r\n\t\t\r\n\tvar lgPositions = new Float32Array\r\n\t([\r\n\t\t 0, 0,\r\n\t\t 80,  0,\r\n\t\t 0,  50,\r\n\t\t 80,  50,\r\n\t]);\r\n\r\n\tvar lgTexcoords = new Float32Array\r\n\t([\r\n\t\t0.0, 0.0,\r\n\t\t1.0, 0.0,\r\n\t\t0.0, 1.0,\r\n\t\t1.0, 1.0\r\n\t]);\r\n\r\n\tif (this.lg)\r\n\t{\r\n\t\tvar tmp = new SglMeshGL(this.gl);\r\n\t\ttmp.addVertexAttribute(\"position\", 2, lgPositions);\r\n\t\ttmp.addVertexAttribute(\"texcoord\", 2, lgTexcoords);\r\n\t\ttmp.addArrayPrimitives(\"tristrip\", this.gl.TRIANGLE_STRIP, 0, 4);\r\n\t\tthis.lgMesh = tmp;\r\n\t\tthis.lgtex = null;\r\n\t\tthis._createLg();\r\n\t}\r\n\t\r\n\tthis.enumType = new Object();\r\n\tthis.enumType[\"HSH_RTI\"] = 1;\r\n\tthis.enumType[\"LRGB_PTM\"] = 2;\r\n\tthis.enumType[\"RGB_PTM\"] = 3;\r\n\tthis.enumType[\"IMAGE\"] = 4;\r\n}\r\n\r\n\r\nMultiResRenderer.prototype = {\r\n\r\n\tcomputeLightingFunction: function(lpos)\r\n\t{\r\n\t\tswitch (this.enumType[this.type])\r\n\t\t{\r\n\t\t\tcase 1:\r\n\t\t\t\tvar phi = Math.atan2(lpos[1], lpos[0]);\r\n\t\t\t\tif (phi < 0) \r\n\t\t\t\t\tphi = 2 * Math.PI + phi;\r\n\t\t\t\tvar theta = Math.min(Math.acos(lpos[2]), Math.PI / 2 - 0.15);\r\n\t\t\t\t\t\r\n\t\t\t\tvar cosPhi = Math.cos(phi);\r\n\t\t\t\tvar cosTheta = Math.cos(theta);\r\n\t\t\t\tvar cosTheta2 = cosTheta * cosTheta;\r\n\t\t\t\t\r\n\t\t\t\tvar lweights = new Array(9);\r\n\t\t\t\tlweights[0] = 1.0 / Math.sqrt(2.0 * Math.PI);\r\n\t\t\t\tlweights[1] = Math.sqrt(6.0 / Math.PI) * (cosPhi * Math.sqrt(cosTheta-cosTheta2));\r\n\t\t\t\tlweights[2] = Math.sqrt(3.0 / (2.0 * Math.PI)) * (-1.0 + 2.0*cosTheta);\r\n\t\t\t\tlweights[3] = Math.sqrt(6.0 / Math.PI) * (Math.sqrt(cosTheta - cosTheta2) * Math.sin(phi));\r\n\t\t\t\t\r\n\t\t\t\tlweights[4] = Math.sqrt(30.0 / Math.PI) * (Math.cos(2.0 * phi) * (-cosTheta + cosTheta2));\r\n\t\t\t\tlweights[5] = Math.sqrt(30.0 / Math.PI) * (cosPhi*(-1.0 + 2.0 * cosTheta) * Math.sqrt(cosTheta - cosTheta2));\r\n\t\t\t\tlweights[6] = Math.sqrt(5.0 / (2.0 * Math.PI)) * (1.0 - 6.0 * cosTheta + 6.0 * cosTheta2);\r\n\t\t\t\tlweights[7] = Math.sqrt(30.0 / Math.PI) * ((-1.0 + 2.0 * cosTheta) * Math.sqrt(cosTheta - cosTheta2) * Math.sin(phi));\r\n\t\t\t\tlweights[8] = Math.sqrt(30.0 / Math.PI) * ((-cosTheta + cosTheta2) * Math.sin(2.*phi));\r\n\t\t\t\treturn lweights;\r\n\t\t\tcase 2:\r\n\t\t\tcase 3:\r\n\t\t\t\tvar lweights = new Array(6);\r\n\t\t\t\tlweights[0] = lpos[0] * lpos[0];\r\n\t\t\t\tlweights[1] = lpos[1] * lpos[1];\r\n\t\t\t\tlweights[2] = lpos[0] * lpos[1];\r\n\t\t\t\tlweights[3] = lpos[0];\r\n\t\t\t\tlweights[4] = lpos[1];\r\n\t\t\t\tlweights[5] = 1.0;\r\n\t\t\t\treturn lweights;\r\n\t\t\tdefault:\r\n\t\t}\r\n\t\treturn [];\r\n\t},\r\n\t\r\n\t\r\n\tloadImage: function(url)\r\n\t{\r\n\t\tvar xhttp=new XMLHttpRequest();\r\n\t\tvar targetURL = null;\r\n\t\tif(typeof url === \"string\") {\r\n\t\t\ttargetURL = url + \"/info.xml\";\r\n\t\t}\r\n\t\telse {\r\n\t\t\ttargetURL = url(\"/info.xml\");\r\n\t\t}\r\n\t\txhttp.overrideMimeType('text/xml');\r\n\t\txhttp.open(\"GET\", targetURL, false);\r\n\t\txhttp.send();\r\n\r\n\t\tvar doc = xhttp.responseXML;\r\n\t\tthis.format = \"jpg\";\r\n\t\tvar val = parseInt(doc.getElementsByTagName(\"MultiRes\")[0].getAttribute(\"format\"));\r\n\t\tif (!isNaN(val))\r\n\t\t\tif (val == 1)\r\n\t\t\t\tthis.format = \"png\";\r\n\t\tvar content = doc.getElementsByTagName(\"Content\")[0];\r\n\t\tthis.type = content.getAttribute(\"type\");\r\n\t\tif (!(this.type in this.enumType))\r\n\t\t\treturn false;\r\n\t\tvar tree = null;\r\n\t\tswitch (this.enumType[this.type])\r\n\t\t{\r\n\t\t\tcase 1:\r\n\t\t\tcase 2:\r\n\t\t\tcase 3:\r\n\t\t\t\tvar size = doc.getElementsByTagName(\"Size\")[0];\r\n\t\t\t\tvar scale = doc.getElementsByTagName(\"Scale\")[0];\r\n\t\t\t\tvar bias = doc.getElementsByTagName(\"Bias\")[0];\r\n\t\t\t\ttree = doc.getElementsByTagName(\"Tree\")[0];\r\n\t\t\t\t\t\t\t\r\n\t\t\t\tthis.imgWidth = parseInt(size.getAttribute(\"width\"));\r\n\t\t\t\tthis.imgHeight = parseInt(size.getAttribute(\"height\"));\r\n\t\t\t\tthis.ordlen = parseInt(size.getAttribute(\"coefficients\"));\r\n\t\t\t\tthis.numLayers = this.ordlen;\r\n\t\t\t\tif (this.enumType[this.type] == 2)\r\n\t\t\t\t\tthis.numLayers = 3;\r\n\t\t\t\ttokens = scale.childNodes[0].nodeValue.split(\" \");\r\n\t\t\t\tif (tokens.length < this.ordlen) return;\r\n\t\t\t\tthis.gmax = [];\r\n\t\t\t\tfor (var j = 0; j < this.ordlen; j++ )\r\n\t\t\t\t\tthis.gmax[j] = parseFloat(tokens[j]);\r\n\t\t\t\t\t\t\r\n\t\t\t\ttokens = bias.childNodes[0].nodeValue.split(\" \");\r\n\t\t\t\tif (tokens.length < this.ordlen) return;\r\n\t\t\t\tthis.gmin = [];\r\n\t\t\t\tfor (var j = 0; j < this.ordlen; j++ )\r\n\t\t\t\t\tthis.gmin[j] = parseFloat(tokens[j]);\r\n\t\t\t\tbreak;\r\n\t\t\tcase 4:\r\n\t\t\t\tvar size = doc.getElementsByTagName(\"Size\")[0];\r\n\t\t\t\ttree = doc.getElementsByTagName(\"Tree\")[0];\r\n\t\t\t\t\t\t\t\r\n\t\t\t\tthis.imgWidth = parseInt(size.getAttribute(\"width\"));\r\n\t\t\t\tthis.imgHeight = parseInt(size.getAttribute(\"height\"));\r\n\t\t\t\tthis.ordlen = parseInt(size.getAttribute(\"coefficients\"));\r\n\t\t\t\tthis.numLayers = this.ordlen;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\treturn;\t\t\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\tif (this._tree)\r\n\t\t\tthis._tree.destroy(this._destroyData);\r\n\t\t\r\n\t\tthis._tree.load(tree.textContent, this.imgWidth, this.imgHeight);\r\n\t\t\r\n\t\tthis._url  = url;\r\n\t\tthis._timestamp = 0;\r\n\t\tthis._frustum = new SglFrustum();\r\n\t\tthis._maxError = 1.0;\r\n\t\tthis._cache = [ ];\r\n\t\tthis._toRequest = [ ];\r\n\t\tthis._toRenderFullRes = [ ];\r\n\t\tthis._toRenderHalfRes = [ ];\r\n\t\tthis._readyItems = [ ];\r\n\r\n\t\tthis.renderData  = true;\r\n\t\tthis.renderBoxes = false;\r\n\t\t\r\n\t\t//var lpos = [0.241844, 0.241844, 0.939692]\r\n\t\t//lpos = sglNormalizedV3(lpos);\r\n\t\t//this.lightPos = lpos.slice(0, 3);\r\n\t\tthis.lightPos    = [ 0.0, 0.0, 1.0 ];\r\n\t\tthis.lweights \t = [];\r\n\t\tthis.lweights \t = this.computeLightingFunction(this.lightPos);\r\n\t\tif (this._program != null)\r\n\t\t\tthis._program.destroy();\r\n\t\tswitch (this.enumType[this.type])\r\n\t\t{\r\n\t\t\tcase 1:\r\n\t\t\t\tvar vs = sglLoadFile(\"/assets/webViewer/spidergl/multi.v.glsl\");\r\n\t\t\t\tvar fs = sglLoadFile(\"/assets/webViewer/spidergl/hsh.f.glsl\");\r\n\t\t\t\tvar prg = new SglProgram(this.gl, [vs], [fs]);\r\n\t\t\t\tlog(prg.log);\r\n\t\t\t\tthis._program  = prg;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 2:\r\n\t\t\t\tvar vs = sglLoadFile(\"/assets/webViewer/spidergl/multi.v.glsl\");\r\n\t\t\t\tvar fs = sglLoadFile(\"/assets/webViewer/spidergl/lrgbptm.f.glsl\");\r\n\t\t\t\tvar prg = new SglProgram(this.gl, [vs], [fs]);\r\n\t\t\t\tlog(prg.log);\r\n\t\t\t\tthis._program  = prg;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 3:\r\n\t\t\t\tvar vs = sglLoadFile(\"/assets/webViewer/spidergl/multi.v.glsl\");\r\n\t\t\t\tvar fs = sglLoadFile(\"/assets/webViewer/spidergl/rgbptm.f.glsl\");\r\n\t\t\t\tvar prg = new SglProgram(this.gl, [vs], [fs]);\r\n\t\t\t\tlog(prg.log);\r\n\t\t\t\tthis._program  = prg;\r\n\t\t\t\tbreak;\r\n\t\t\tcase 4:\r\n\t\t\t\tvar vs = sglLoadFile(\"/assets/webViewer/spidergl/multi.v.glsl\");\r\n\t\t\t\tvar fs = sglLoadFile(\"/assets/webViewer/spidergl/image.f.glsl\");\r\n\t\t\t\tvar prg = new SglProgram(this.gl, [vs], [fs]);\r\n\t\t\t\tlog(prg.log);\r\n\t\t\t\tthis._program  = prg;\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tthis._program = new SglProgram();\r\n\t\t}\r\n\t\tthis._renderer = new SglMeshGLRenderer(this._program);\r\n\t\tthis._treeTransform = sglIdentityM4();\r\n\t\tthis._normalizedTreeTransform = sglIdentityM4();\r\n\t\t\r\n\t\tthis.leftTex = (this._tree.scale[0] - this.imgWidth) / 2.0; \r\n\t\tthis.rightTex = this.leftTex + this.imgWidth; \r\n\t\t\r\n\t\tthis.bottomTex = (this._tree.scale[1] - this.imgHeight) / 2.0; \r\n\t\tthis.topTex = this.bottomTex + this.imgHeight;\r\n\t\tthis.leftTex /= this._tree.scale[0];\r\n\t\tthis.rightTex /= this._tree.scale[0];\r\n\t\t\r\n\t\tthis.bottomTex /= this._tree.scale[1];\r\n\t\tthis.topTex /= this._tree.scale[1];\r\n\t\t\r\n\t\tif (this._tree.ready) \r\n\t\t\tthis._setupTree();\r\n\t},\r\n\r\n\r\n\t_createLg: function()\r\n\t{\r\n\t\tvar canvas=document.createElement(\"canvas\");\r\n\t\tcanvas.height = 50;\r\n\t\tcanvas.width = 80;\r\n\t\tvar ctx = canvas.getContext(\"2d\");\r\n\t\tctx.save();\r\n\t\tctx.beginPath();\r\n\t\tctx.moveTo(0,0);\r\n\t\tctx.lineTo(80,0);\r\n\t\tctx.lineTo(80,50);\r\n\t\tctx.lineTo(0,50);\r\n\t\tctx.closePath();\r\n\t\tctx.clip();\r\n\t\tctx.strokeStyle = 'rgba(0,0,0,0)';\r\n\t\tctx.lineCap = 'butt';\r\n\t\tctx.lineJoin = 'miter';\r\n\t\tctx.miterLimit = 4;\r\n\t\tctx.save();\r\n\t\tctx.restore();\r\n\t\tctx.save();\r\n\t\tctx.restore();\r\n\t\tctx.save();\r\n\t\tctx.transform(0.21814175,0,0,0.21573678,-3.3721339,-3.3665838);\r\n\t\tctx.save();\r\n\t\tctx.translate(14.071762,20);\r\n\t\tctx.save();\r\n\t\tg=ctx.createRadialGradient(239.50893,204.66128888494003,0,239.50893,204.66128888494003,31.820419);\r\n\t\tg.addColorStop(0,\"rgba(255, 255, 255, 1)\");\r\n\t\tg.addColorStop(1,\"rgba(151, 151, 151, 1)\");\r\n\t\tctx.fillStyle = g;\r\n\t\tctx.strokeStyle = \"#000000\";\r\n\t\tctx.lineWidth = 2.4923694133758545;\r\n\t\tctx.lineCap = \"round\";\r\n\t\tctx.lineJoin = \"round\";\r\n\t\tctx.miterLimit = 4;\r\n\t\tctx.transform(2.1234583,0,0,1.6108995,-256.37574,-264.34719);\r\n\t\tctx.beginPath();\r\n\t\tctx.moveTo(271.42857,233.79076);\r\n\t\tctx.translate(240,233.80553976769053);\r\n\t\tctx.rotate(0);\r\n\t\tctx.scale(0.7586207296076113,1);\r\n\t\tctx.arc(0,0,41.42857,-0.00035675303306008355,3.1419494066230014,0);\r\n\t\tctx.scale(1.318181748760332,1);\r\n\t\tctx.rotate(0);\r\n\t\tctx.translate(-240,-233.80553976769053);\r\n\t\tctx.translate(240,233.77598023230948);\r\n\t\tctx.rotate(0);\r\n\t\tctx.scale(0.7586207296076113,1);\r\n\t\tctx.arc(0,0,41.42857,3.141235900556733,6.2835420602127945,0);\r\n\t\tctx.scale(1.318181748760332,1);\r\n\t\tctx.rotate(0);\r\n\t\tctx.translate(-240,-233.77598023230948);\r\n\t\tctx.closePath();\r\n\t\tctx.fill();\r\n\t\tctx.stroke();\r\n\t\tctx.restore();\r\n\t\tctx.save();\r\n\t\tctx.fillStyle = \"#ececec\";\r\n\t\tctx.strokeStyle = \"#000000\";\r\n\t\tctx.lineWidth = 4.609655857086182;\r\n\t\tctx.lineCap = \"butt\";\r\n\t\tctx.lineJoin = \"round\";\r\n\t\tctx.miterLimit = 4;\r\n\t\tctx.beginPath();\r\n\t\tctx.moveTo(49.495605,44.507569);\r\n\t\tctx.lineTo(129.49561,79.507569);\r\n\t\tctx.lineTo(209.49561,44.507569);\r\n\t\tctx.lineTo(49.495605,44.507569);\r\n\t\tctx.closePath();\r\n\t\tctx.fill();\r\n\t\tctx.stroke();\r\n\t\tctx.restore();\r\n\t\tctx.save();\r\n\t\tctx.fillStyle = \"#999999\";\r\n\t\tctx.strokeStyle = \"#000000\";\r\n\t\tctx.lineWidth = 4.609655857086182;\r\n\t\tctx.lineCap = \"butt\";\r\n\t\tctx.lineJoin = \"round\";\r\n\t\tctx.miterLimit = 4;\r\n\t\tctx.beginPath();\r\n\t\tctx.moveTo(129.49561,174.50757);\r\n\t\tctx.lineTo(129.49561,79.507572);\r\n\t\tctx.lineTo(209.49561,44.507572);\r\n\t\tctx.lineTo(129.49561,174.50757);\r\n\t\tctx.closePath();\r\n\t\tctx.fill();\r\n\t\tctx.stroke();\r\n\t\tctx.restore();\r\n\t\tctx.save();\r\n\t\tctx.fillStyle = \"#b3b3b3\";\r\n\t\tctx.strokeStyle = \"#000000\";\r\n\t\tctx.lineWidth = 4.609655857086182;\r\n\t\tctx.lineCap = \"butt\";\r\n\t\tctx.lineJoin = \"round\";\r\n\t\tctx.miterLimit = 4;\r\n\t\tctx.beginPath();\r\n\t\tctx.moveTo(129.49561,174.50757);\r\n\t\tctx.lineTo(129.49561,79.507569);\r\n\t\tctx.lineTo(49.495605,44.507569);\r\n\t\tctx.lineTo(129.49561,174.50757);\r\n\t\tctx.closePath();\r\n\t\tctx.fill();\r\n\t\tctx.stroke();\r\n\t\tctx.restore();\r\n\t\tctx.save();\r\n\t\tg=ctx.createLinearGradient(236.58487,196.44904,257.4877,320.66739);\r\n\t\tg.addColorStop(0,\"rgba(255, 255, 255, 1)\");\r\n\t\tg.addColorStop(1,\"rgba(151, 151, 151, 1)\");\r\n\t\tctx.fillStyle = g;\r\n\t\tctx.strokeStyle = \"#000000\";\r\n\t\tctx.lineWidth = 3.3579113483428955;\r\n\t\tctx.lineCap = \"round\";\r\n\t\tctx.lineJoin = \"round\";\r\n\t\tctx.miterLimit = 4;\r\n\t\tctx.transform(1.4965962,0,0,1.2591977,-86.218969,-182.0266);\r\n\t\tctx.beginPath();\r\n\t\tctx.moveTo(271.42857,233.79076);\r\n\t\tctx.translate(240,233.80553976769053);\r\n\t\tctx.rotate(0);\r\n\t\tctx.scale(0.7586207296076113,1);\r\n\t\tctx.arc(0,0,41.42857,-0.00035675303306008355,3.1419494066230014,0);\r\n\t\tctx.scale(1.318181748760332,1);\r\n\t\tctx.rotate(0);\r\n\t\tctx.translate(-240,-233.80553976769053);\r\n\t\tctx.translate(240,233.77598023230948);\r\n\t\tctx.rotate(0);\r\n\t\tctx.scale(0.7586207296076113,1);\r\n\t\tctx.arc(0,0,41.42857,3.141235900556733,6.2835420602127945,0);\r\n\t\tctx.scale(1.318181748760332,1);\r\n\t\tctx.rotate(0);\r\n\t\tctx.translate(-240,-233.77598023230948);\r\n\t\tctx.closePath();\r\n\t\tctx.fill();\r\n\t\tctx.stroke();\r\n\t\tctx.restore();\r\n\t\tctx.restore();\r\n\t\tctx.restore();\r\n\t\tctx.restore();\r\n\t\tvar image = new Image();\r\n\t\tvar dataURL = canvas.toDataURL(\"image/png\");\r\n\t\t// image.crossOrigin = '';\r\n\t\timage.src = dataURL;\r\n\r\n\t\tvar that = this;\r\n\t\timage.onload = function() \r\n\t\t\t\t\t\t{ \r\n\t\t\t\t\t\t\tvar texOpt =\r\n\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\tgenerateMipmap  : false,\r\n\t\t\t\t\t\t\t\tminFilter       : that.gl.NEAREST,\r\n\t\t\t\t\t\t\t\tmagFilter \t\t: that.gl.NEAREST,\r\n\t\t\t\t\t\t\t};\r\n\t\t\t\t\t\t\tthat.lgtex = new SglTexture2D(that.gl, image, texOpt);\r\n\t\t\t\t\t\t}\r\n\t\t\r\n\t\t\r\n\t\tvar error = this.gl.getError();\r\n\t\tconsole.log(error);\r\n\t},\r\n\r\n\r\n\t_createData : function(colorImgs)\r\n\t{\r\n\t\tvar colorTexOpts = {\r\n\t\t\tminFilter : this.gl.LINEAR,\r\n\t\t\tmagFilter : this.gl.LINEAR,\r\n\t\t\tgenerateMipmap : false\r\n\t\t};\r\n\r\n\t\tvar dataTextures = new Array(colorImgs.length);\r\n\t\tfor (var i=0; i < colorImgs.length; ++i) \r\n\t\t\tdataTextures[i] = new SglTexture2D(this.gl, colorImgs[i], colorTexOpts);\r\n\r\n\t\tvar data = {\r\n\t\t\ttextures : dataTextures\r\n\t\t};\r\n\r\n\t\treturn data;\r\n\t},\r\n\r\n\t\r\n\t_destroyData : function(data) \r\n\t{\r\n\t\tif (!data) return;\r\n\t\tfor (var i = 0; i < data.textures.length; ++i) \r\n\t\t\tdata.textures[i].destroy();\r\n\t\t\r\n\t\tdata.textures = null;\r\n\t},\r\n\r\n\t\r\n\t_requestNode : function(n)\r\n\t{\r\n\t\tif (n.req) return;\r\n\r\n\t\tvar that  = this;\r\n\t\tif(typeof this._url === \"string\") {\r\n\t\t\tvar url   = this._url + \"/\" + n.id;\t\r\n\t\t}\r\n\t\t\r\n\r\n\t\tvar requests = new Array();\r\n\r\n\t\tfor (var i = 1; i <= this.numLayers; i++) {\r\n\t\t\tif(typeof this._url === \"string\") {\r\n\t\t\t\tvar targetURL   = url + \"_\" + i + \".\" + this.format;\t\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tvar targetURL = this._url(\"/\" + n.id + \"_\" + i + \".\" + this.format)\r\n\t\t\t}\r\n\t\t\r\n\t\t\trequests.push(new SglImageRequest(targetURL));\r\n\t\t}\r\n\r\n\t\tvar watcher = new SglRequestWatcher(requests, function(w) {\r\n\t\t\tthat._currentOngoingRequests--;\r\n\t\t\tthat._readyItems.push(n);\r\n\t\t});\r\n\t\tn.req = watcher;\r\n\t\twatcher.send();\r\n\t},\r\n\r\n\t\r\n\t_collectNodesRec : function(n, parentFullyVisible)\r\n\t{\r\n\t\tvar result = {\r\n\t\t\tneeded : false,\r\n\t\t\tusable : ((n.data) ? (true) : (false))\r\n\t\t};\r\n\r\n\t\tif (n.zScale == 0)\r\n\t\t\treturn result;\r\n\t\t\r\n\t\t// test visibility only if parent is not completely inside frustum\r\n\t\tif (!parentFullyVisible) \r\n\t\t{\r\n\t\t\tvar visStatus = this._frustum.boxVisibility(n.box.min, n.box.max);\r\n\t\t\tif (visStatus == SGL_OUTSIDE_FRUSTUM) return result;\r\n\t\t\tparentFullyVisible = (visStatus == SGL_INSIDE_FRUSTUM);\r\n\t\t}\r\n\r\n\t\t// node is visible and thus needed\r\n\t\tresult.needed = true;\r\n\r\n\t\t// calculate error\r\n\t\tvar prjSize = this._frustum.projectedSegmentSize(n.box.center, n.box.size[0]);\r\n\t\tvar error   = prjSize / n.projectedSize;\r\n\r\n\t\tn.priority.timestamp = this._timestamp;\r\n\t\tn.priority.error     = error;\r\n\r\n\t\t// if node data is not available, request node and return\r\n\t\tif (!result.usable) \r\n\t\t{\r\n\t\t\tif (!n.req)\r\n\t\t\t{\r\n\t\t\t\tthis._toRequest.push(n);\r\n\t\t\t\t//this._toRequest[n.id] = n;\r\n\t\t\t}\r\n\t\t\treturn result;\r\n\t\t}\r\n\r\n\t\t// if node is below error, render it in full resolution and return\r\n\t\tif ((error < this._maxError) || n.isLeaf)\r\n\t\t{\r\n\t\t\tthis._toRenderFullRes.push(n);\r\n\t\t\t//this._toRenderFullRes[n.id] = n;\r\n\t\t\treturn result;\r\n\t\t}\r\n\r\n\t\t// recurse down to children\r\n\t\tvar c = null;\r\n\t\tvar neededCount = 0;\r\n\t\tvar usableCount = 0;\r\n\t\tvar cr = null;\r\n\t\tvar missingChildren = [ ];\r\n\r\n\t\tfor (var i = 0; i < 4; ++i)\r\n\t\t{\r\n\t\t\tc = this._tree.child(n, i);\r\n\t\t\tif (!c) continue;\r\n\t\t\tcr = this._collectNodesRec(c, parentFullyVisible);\r\n\t\t\tif (cr.usable) usableCount++;\r\n\t\t\tif (cr.needed)\r\n\t\t\t{\r\n\t\t\t\tneededCount++;\r\n\t\t\t\tif (!cr.usable)\r\n\t\t\t\t{\r\n\t\t\t\t\tmissingChildren.push(i);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t//_MultiResAssert(neededCount > 0);\r\n\r\n\t\tif (neededCount > 0) \r\n\t\t{\r\n\t\t\tif (usableCount <= 0)\r\n\t\t\t{\r\n\t\t\t\t// no needed child is available, render node in full resolution\r\n\t\t\t\tthis._toRenderFullRes.push(n);\r\n\t\t\t\t//this._toRenderFullRes[n.id] = n;\r\n\t\t\t}\r\n\t\t\telse if (missingChildren.length > 0)\r\n\t\t\t{\r\n\t\t\t\t// some child is needed but not usable, render their sectors in half resolution (wrt this node)\r\n\t\t\t\tthis._toRenderHalfRes.push({ n: n, children: missingChildren });\r\n\t\t\t\t//this._toRenderHalfRes[n.id] = { n: n, missingChildren: missingChildren };\r\n\t\t\t}\r\n\t\t\t// else all needed children can be rendered\r\n\t\t}\r\n\r\n\t\t// the node is needed and available\r\n\t\treturn result;\r\n\t},\r\n\r\n\t\r\n\t_collectNodes : function() \r\n\t{\r\n\t\tthis._toRequest = [ ];\r\n\t\tthis._toRenderFullRes = [ ];\r\n\t\tthis._toRenderHalfRes = [ ];\r\n\r\n\t\tvar root = this._tree.root;\r\n\t\tif (!root) return;\r\n\r\n\t\tthis._collectNodesRec(root, false);\r\n\t},\r\n\r\n\t\r\n\t_renderNodeFullRes : function(n)\r\n\t{\r\n\t\tvar uniforms = {\r\n\t\t\tu_world_box_min : n.box.min,\r\n\t\t\tu_world_box_max : n.box.max\r\n\t\t};\r\n\r\n\t\tvar samplers = [];\r\n\t\tfor (var i = 0; i < this.numLayers; i++)\r\n\t\t\tsamplers['coeff' + i] = n.data.textures[i];\r\n\t\t\r\n\t\tthis._renderer.setUniforms(uniforms);\r\n\t\tthis._renderer.setSamplers(samplers);\r\n\t\tthis._renderer.render();\r\n\t},\r\n\r\n\t_renderNodesFullRes : function(mvp)\r\n\t{\r\n\t\tvar mesh = null;\r\n\t\tvar primitives = null;\r\n\r\n\t\tmesh = this._tileFullMesh;\r\n\t\tprimitives = \"tristrip\";\r\n\r\n\t\tvar uniforms = {\r\n\t\t\tu_model_view_projection_matrix : mvp,\r\n\t\t\tu_scale_bias                   : [ 1.0, 1.0, 0.0, 0.0 ],\r\n\t\t\tu_texcoord_scale_bias          : [ (this._tree.tileSize / (this._tree.tileSize + 2.0)), (1.0 / (this._tree.tileSize + 2.0)) ],\r\n\t\t\tordlen\t\t\t\t\t\t   : this.ordlen,\r\n\t\t\tleftTex                        : this.leftTex,\r\n\t\t\trightTex                       : this.rightTex,\r\n\t\t\tbottomTex                      : this.bottomTex,\r\n\t\t\ttopTex                         : this.topTex\r\n\t\t}\r\n\t\t\r\n\t\tif (this.enumType[this.type] != 4)\r\n\t\t{\r\n\t\t\tfor (var i = 0; i < this.ordlen; i++)\r\n\t\t\t{\r\n\t\t\t\tuniforms['gmax' + i] = this.gmax[i];\r\n\t\t\t\tuniforms['gmin' + i] = this.gmin[i];\r\n\t\t\t\tuniforms['lweight' + i] = this.lweights[i];\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._renderer.begin();\r\n\t\t\tthis._renderer.setUniforms(uniforms);\r\n\t\t\tthis._renderer.beginMesh(mesh);\r\n\t\t\t\tthis._renderer.beginPrimitives(primitives);\r\n\t\t\t\tvar n = null;\r\n\t\t\t\tfor (var i in this._toRenderFullRes)\r\n\t\t\t\t{\r\n\t\t\t\t\tn = this._toRenderFullRes[i];\r\n\t\t\t\t\tthis._renderNodeFullRes(n);\r\n\t\t\t\t}\r\n\t\t\t\tthis._renderer.endPrimitives();\r\n\t\t\tthis._renderer.endMesh();\r\n\t\tthis._renderer.end();\r\n\t},\r\n\r\n\t_renderNodeHalfRes : function(n, children)\r\n\t{\r\n\t\tvar uniforms = {\r\n\t\t\tu_world_box_min : null,\r\n\t\t\tu_world_box_max : null,\r\n\t\t\tu_scale_bias    : null\r\n\t\t};\r\n\r\n\t\tvar samplers = [];\r\n\t\tfor (var i = 0; i < this.numLayers; i++)\r\n\t\t\tsamplers['coeff' + i] = n.data.textures[i];\r\n\t\t\r\n\t\tthis._renderer.setSamplers(samplers);\r\n\r\n\t\tvar scaleBias = [\r\n\t\t\t[ 0.5, 0.5, 0.0, 0.0 ],\r\n\t\t\t[ 0.5, 0.5, 0.5, 0.0 ],\r\n\t\t\t[ 0.5, 0.5, 0.0, 0.5 ],\r\n\t\t\t[ 0.5, 0.5, 0.5, 0.5 ]\r\n\t\t];\r\n\r\n\t\tvar c = null;\r\n\t\tfor (var i in children)\r\n\t\t{\r\n\t\t\tc = this._tree.child(n, children[i]);\r\n\t\t\tuniforms.u_world_box_min = c.box.min;\r\n\t\t\tuniforms.u_world_box_max = c.box.max;\r\n\t\t\tuniforms.u_scale_bias    = scaleBias[children[i]];\r\n\t\t\tthis._renderer.setUniforms(uniforms);\r\n\t\t\tthis._renderer.render();\r\n\t\t}\r\n\t},\r\n\r\n\t_renderNodesHalfRes : function(mvp)\r\n\t{\r\n\t\tvar mesh = null;\r\n\t\tvar primitives = null;\r\n\r\n\t\tmesh = this._tileHalfMesh;\r\n\t\tprimitives = \"tristrip\";\r\n\r\n\t\tvar uniforms = {\r\n\t\t\tu_model_view_projection_matrix : mvp,\r\n\t\t\tu_texcoord_scale_bias          : [ (this._tree.tileSize / (this._tree.tileSize + 2.0)), (1.0 / (this._tree.tileSize + 2.0)) ],\r\n\t\t\tordlen\t\t\t\t\t\t   : this.ordlen,\r\n\t\t\tleftTex                        : this.leftTex,\r\n\t\t\trightTex                       : this.rightTex,\r\n\t\t\tbottomTex                      : this.bottomTex,\r\n\t\t\ttopTex                         : this.topTex\r\n\t\t}\r\n\t\t\r\n\t\tif (this.enumType[this.type] != 4)\r\n\t\t{\r\n\t\t\tfor (var i = 0; i < this.ordlen; i++)\r\n\t\t\t{\r\n\t\t\t\tuniforms['gmax' + i] = this.gmax[i];\r\n\t\t\t\tuniforms['gmin' + i] = this.gmin[i];\r\n\t\t\t\tuniforms['lweight' + i] = this.lweights[i];\r\n\t\t\t}\r\n\t\t}\r\n\t\t\r\n\t\tthis._renderer.begin();\r\n\t\t\tthis._renderer.setUniforms(uniforms);\r\n\t\t\tthis._renderer.beginMesh(mesh);\r\n\t\t\t\tthis._renderer.beginPrimitives(primitives);\r\n\t\t\t\tvar nc = null;\r\n\t\t\t\tfor (var i in this._toRenderHalfRes)\r\n\t\t\t\t{\r\n\t\t\t\t\tnc = this._toRenderHalfRes[i];\r\n\t\t\t\t\tthis._renderNodeHalfRes(nc.n, nc.children);\r\n\t\t\t\t}\r\n\t\t\t\tthis._renderer.endPrimitives();\r\n\t\t\tthis._renderer.endMesh();\r\n\t\tthis._renderer.end();\r\n\t},\r\n\r\n\t_renderNodes : function(mvp)\r\n\t{\r\n\t\tthis._renderNodesFullRes(mvp);\r\n\t\tthis._renderNodesHalfRes(mvp);\r\n\t},\r\n\r\n\t_renderNodeFullResBox : function(n) \r\n\t{\r\n\t\tvar sz = n.box.size;\r\n\r\n\t\tvar uniforms = {\r\n\t\t\tu_world_box_min : sglAddV3S(n.box.min, sz[0] * 0.05),\r\n\t\t\tu_world_box_max : sglSubV3S(n.box.max, sz[0] * 0.05),\r\n\t\t\tu_color         : ((n.isLeaf) ? ([1.0, 0.0, 1.0]) : ([0.0, 1.0, 0.0]))\r\n\t\t};\r\n\r\n\t\tthis._boxRenderer.setUniforms(uniforms);\r\n\t\tthis._boxRenderer.render();\r\n\t},\r\n\r\n\t_renderNodesFullResBoxes : function(mvp) \r\n\t{\r\n\t\tvar uniforms = {\r\n\t\t\tu_model_view_projection_matrix : mvp\r\n\t\t};\r\n\r\n\t\tthis._boxRenderer.begin();\r\n\t\t\tthis._boxRenderer.setUniforms(uniforms);\r\n\t\t\tthis._boxRenderer.beginMesh(this._boxMesh);\r\n\t\t\t\tthis._boxRenderer.beginPrimitives(\"edges\");\r\n\t\t\t\tvar n = null;\r\n\t\t\t\tfor (var i in this._toRenderFullRes)\r\n\t\t\t\t{\r\n\t\t\t\t\tn = this._toRenderFullRes[i];\r\n\t\t\t\t\tthis._renderNodeFullResBox(n);\r\n\t\t\t\t}\r\n\t\t\t\tthis._boxRenderer.endPrimitives();\r\n\t\t\tthis._boxRenderer.endMesh();\r\n\t\tthis._boxRenderer.end();\r\n\t},\r\n\r\n\t_renderNodeHalfResBox : function(n, children) \r\n\t{\r\n\t\tvar uniforms = {\r\n\t\t\tu_world_box_min : null,\r\n\t\t\tu_world_box_max : null,\r\n\t\t\tu_color         : null\r\n\t\t};\r\n\r\n\t\tvar c  = null;\r\n\t\tvar sx = null;\r\n\t\tfor (var i in children)\r\n\t\t{\r\n\t\t\tc = this._tree.child(n, children[i]);\r\n\t\t\tsz = c.box.size;\r\n\t\t\tuniforms.u_world_box_min = sglAddV3S(c.box.min, sz[0] * 0.05);\r\n\t\t\tuniforms.u_world_box_max = sglSubV3S(c.box.max, sz[0] * 0.05);\r\n\t\t\tuniforms.u_color         = ((c.isLeaf) ? ([1.0, 1.0, 0.0]) : ([1.0, 1.0, 1.0]));\r\n\t\t\tthis._boxRenderer.setUniforms(uniforms);\r\n\t\t\tthis._boxRenderer.render();\r\n\t\t}\r\n\t},\r\n\r\n\t_renderNodesHalfResBoxes : function(mvp)\r\n\t{\r\n\t\tvar uniforms = {\r\n\t\t\tu_model_view_projection_matrix : mvp\r\n\t\t};\r\n\r\n\t\tthis._boxRenderer.begin();\r\n\t\t\tthis._boxRenderer.setUniforms(uniforms);\r\n\t\t\tthis._boxRenderer.beginMesh(this._boxMesh);\r\n\t\t\t\tthis._boxRenderer.beginPrimitives(\"edges\");\r\n\t\t\t\tvar nc = null;\r\n\t\t\t\tfor (var i in this._toRenderHalfRes)\r\n\t\t\t\t{\r\n\t\t\t\t\tnc = this._toRenderHalfRes[i];\r\n\t\t\t\t\tthis._renderNodeHalfResBox(nc.n, nc.children);\r\n\t\t\t\t}\r\n\t\t\t\tthis._boxRenderer.endPrimitives();\r\n\t\t\tthis._boxRenderer.endMesh();\r\n\t\tthis._boxRenderer.end();\r\n\t},\r\n\r\n\t_renderNodesBoxes : function(mvp)\r\n\t{\r\n\t\tthis.gl.lineWidth(2.0);\r\n\t\tthis.gl.depthFunc(this.gl.LEQUAL);\r\n\t\tthis._renderNodesFullResBoxes(mvp);\r\n\t\tthis._renderNodesHalfResBoxes(mvp);\r\n\t\tthis.gl.depthFunc(this.gl.LESS);\r\n\t\tthis.gl.lineWidth(1.0);\r\n\t},\r\n\r\n\t_doRender : function(projectionMatrix, modelViewMatrix, viewport)\r\n\t{\r\n\t\tvar mv = sglMulM4(modelViewMatrix, this._treeTransform);\r\n\t\t//var mv = modelViewMatrix;\r\n\r\n\t\tthis._timestamp++;\r\n\t\tthis._frustum.setup(projectionMatrix, mv, viewport);\r\n\r\n\t\tthis._collectNodes();\r\n\t\tvar mvp = sglMulM4(projectionMatrix, mv);\r\n\r\n\t\tif (this.renderData)\r\n\t\t\tthis._renderNodes(mvp);\r\n\r\n\t\tif (this.renderBoxes) \r\n\t\t\tthis._renderNodesBoxes(mvp);\r\n\t\t\r\n\t\tif (this.lg && this.lgtex != null)\r\n\t\t{\r\n\t\t\tthis.gl.enable(this.gl.BLEND);\r\n\t\t\tthis.gl.blendFunc(this.gl.SRC_ALPHA, this.gl.ONE_MINUS_SRC_ALPHA);\r\n\t\t\tvar mvp2 = sglMulM4(projectionMatrix, sglScalingM4C(1.0, 1.0, 1.0));\r\n\t\t\tvar quadUniforms = { u_mvp : mvp2 };\r\n\t\t\tvar quadSamplers = { s_texture : this.lgtex };\r\n\t\t\tsglRenderMeshGLPrimitives(this.lgMesh, \"tristrip\", this.texProg, null, quadUniforms, quadSamplers);\r\n\t\t\tthis.gl.disable(this.gl.BLEND);\r\n\t\t}\r\n\t\t//this.gl.finish();\r\n\t},\r\n\r\n\t_updateCache : function()\r\n\t{\r\n\t\tvar maxUpdatesPerFrame = 1;\r\n\t\tvar readyItems = this._readyItems.slice(0, maxUpdatesPerFrame);\r\n\t\tthis._readyItems.splice(0, maxUpdatesPerFrame);\r\n\r\n\t\tvar combined = this._cache.concat(readyItems);\r\n\t\tcombined.sort(_MultiResCompareNodes);\r\n\r\n\t\tvar cl = combined.length;\r\n\t\tvar k  = (this._maxCacheSize < cl) ? (this._maxCacheSize) : (cl);\r\n\r\n\t\tthis._cache = combined.splice(0, k);\r\n\t\tvar outOfCache = combined;\r\n\r\n\t\tvar n = null;\r\n\t\tvar r = null;\r\n\t\tvar failed = [ ];\r\n\r\n\t\tfor (var i=0; i<k; ++i) \r\n\t\t{\r\n\t\t\tn = this._cache[i];\r\n\t\t\tr = n.req;\r\n\t\t\tn.req = null;\r\n\r\n\t\t\tif (!r) continue;\r\n\t\t\tif (!r.succeeded)\r\n\t\t\t{\r\n\t\t\t\tfailed.push(i);\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tvar cimgs = new Array(r.requests.length);\r\n\t\t\tfor (var i=0; i<cimgs.length; ++i)\r\n\t\t\t\tcimgs[i] = r.requests[i].image;\r\n\t\t\t\t\r\n\t\t\tif (n.data)\r\n\t\t\t\tthis._destroyData(n.data);\r\n\t\t\t\r\n\t\t\tn.data = this._createData(cimgs);\r\n\t\t}\r\n\r\n\t\tvar fc = failed.length;\r\n\t\tvar reinsertedCount = 0;\r\n\r\n\t\tk = outOfCache.length;\r\n\t\tfor (var i=0; i<k; ++i)\r\n\t\t{\r\n\t\t\tn = outOfCache[i];\r\n\t\t\tr = n.req;\r\n\t\t\tn.req = null;\r\n\r\n\t\t\tif (r) continue;\r\n\r\n\t\t\tif (reinsertedCount < fc) \r\n\t\t\t{\r\n\t\t\t\tthis._cache[failed[reinsertedCount]] = n;\r\n\t\t\t\treinsertedCount++;\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tthis._destroyData(n.data);\r\n\t\t\t\tn.data = null;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (reinsertedCount > 0) \r\n\t\t\tthis._cache.sort(_MultiResCompareNodes);\r\n\t},\r\n\r\n\t\r\n\t_requestNodes : function() \r\n\t{\r\n\t\tvar cs = this._cache.length;\r\n\t\tvar lastItem = (cs > 0) ? (this._cache[cs-1]) : (null);\r\n\r\n\t\tthis._toRequest.sort(_MultiResCompareNodes);\r\n\t\tvar requestableCount = this._maxOngoingRequests - this._currentOngoingRequests;\r\n\r\n\t\tvar requested = 0;\r\n\t\tvar k = this._toRequest.length;\r\n\t\tvar n = null;\r\n\t\tvar canRequest = false;\r\n\r\n\t\tfor (var i=0; ((i<k) && (requested<requestableCount)); ++i) \r\n\t\t{\r\n\t\t\tn = this._toRequest[i];\r\n\t\t\tif (n.req) continue; // ongoing;\r\n\r\n\t\t\tcanRequest = true;\r\n\t\t\tif ((lastItem != null) && (cs >= this._maxCacheSize)) \r\n\t\t\t\tcanRequest = (_MultiResCompareNodes(n, lastItem) < 0);\r\n\t\t\t\r\n\t\t\tif (canRequest)\r\n\t\t\t{\r\n\t\t\t\tthis._requestNode(n);\r\n\t\t\t\trequested++\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t\r\n\t_calculateNormalizedTreeTransform : function() \r\n\t{\r\n\t\tvar root = this._tree.root;\r\n\t\tif (!root) return sglIdentityM4();\r\n\r\n\t\tvar rbox = new SglBox3();\r\n\t\trbox.min = sglAddV3(sglMulV3(root.box.min, this._tree.scale), this._tree.offset);\r\n\t\trbox.max = sglAddV3(sglMulV3(root.box.max, this._tree.scale), this._tree.offset);\r\n\t\t//rbox = root.box;\r\n\r\n\t\tthis._treeTransform = sglMulM4(sglTranslationM4V(this._tree.offset), sglScalingM4V(this._tree.scale));\r\n\t\t//this._treeTransform = sglIdentityM4();\r\n\r\n\t\tvar bc = rbox.center;\r\n\t\tvar bs = rbox.size;\r\n\r\n\t\tvar maxDim = bs[0];\r\n\t\tif (maxDim < bs[1]) maxDim = bs[1];\r\n\t\tif (maxDim < bs[2]) maxDim = bs[2];\r\n\r\n\t\tvar scale = (maxDim > 0.0) ? (1.0 / maxDim) : (1.0);\r\n\r\n\t\tvar s = sglScalingM4C(scale, scale, scale);\r\n\t\tvar t = sglTranslationM4C(-bc[0], -bc[1], -bc[2]);\r\n\r\n\t\tvar xform = sglMulM4(s, t);\r\n\t\tthis._normalizedTreeTransform = xform;\r\n\t\t/*\r\n\t\t//var r  = sglRotationAngleAxisM4C(sglDegToRad(-90.0), 1.0, 0.0, 0.0);\r\n\t\tvar r  = sglIdentityM4();\r\n\t\tvar t1 = sglTranslationM4C(0.0, 0.0, bs[2] / 2.0 * scale);\r\n\t\tvar s  = sglScalingM4C(scale, scale, scale);\r\n\t\tvar t2 = sglTranslationM4C(-bc[0], -bc[1], -bc[2]);\r\n\t\tthis._normalizedTreeTransform = sglMulM4(r, sglMulM4(t1, sglMulM4(s, t2)));\r\n\t\t*/\r\n\t},\r\n\r\n\t_setupTree : function() \r\n\t{\r\n\t\tvar root = this._tree.root;\r\n\t\tif (!root) return;\r\n\r\n\t\tvar gl = this.gl;\r\n\r\n\t\tvar csize = ((this._tree.tileSize + 2) * (this._tree.tileSize + 2)) * this.ordlen * 3;\r\n\r\n\t\tthis._maxCacheSize = sglFloor(this._cacheSizeInBytes / (csize));\r\n\t\tif (this._maxCacheSize <= 0) this._maxCacheSize = 1;\r\n\r\n\t\tvar quadPositions = new Float32Array([\r\n\t\t\t-0.5,  0.5,\r\n\t\t\t-0.5, -0.5,\r\n\t\t\t 0.5,  0.5,\r\n\t\t\t 0.5, -0.5\r\n\t\t]);\r\n\r\n\t\tvar quadMesh = new SglMeshGL(gl);\r\n\t\tquadMesh.addVertexAttribute(\"position\", 2, quadPositions);\r\n\t\tquadMesh.addArrayPrimitives(\"tristrip\", gl.TRIANGLE_STRIP, 0, 4);\r\n\r\n\t\tthis._tileFullMesh = quadMesh;\r\n\t\tthis._tileHalfMesh = quadMesh;\r\n\r\n\t\tthis._calculateNormalizedTreeTransform();\r\n\t},\r\n\r\n\t\r\n\trender : function(projectionMatrix, modelViewMatrix, viewport)\r\n\t{\r\n\t\tif (!this._tree.root) return;\r\n\r\n\t\tthis._doRender(projectionMatrix, modelViewMatrix, viewport);\r\n\t\tif (this.updateData)\r\n\t\t{\r\n\t\t\tthis._updateCache();\r\n\t\t\tthis._requestNodes();\r\n\t\t}\r\n\t},\r\n\r\n\t\r\n\tget normalizedTreeTransform() \r\n\t{\r\n\t\treturn this._normalizedTreeTransform;\r\n\t}\r\n};\r\n"]}