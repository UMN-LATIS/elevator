#!/bin/bash

# Script to update the admin user's password using the encryption key from .env
# This script is for LOCAL development use only

echo ""
echo "⚠️  FOR LOCAL DEVELOPMENT USE ONLY!"
echo ""

# Set fixed username
USERNAME="admin"

# Check if we're in a development environment
if [ -f .env ]; then
  ENVIRONMENT=$(grep "^CI_ENV=" .env | sed 's/CI_ENV=//')
  if [ "$ENVIRONMENT" != "local" ]; then
    echo "⚠️  WARNING: This script should only be run in development environments!"
    echo "Current environment: $ENVIRONMENT"
    exit 1
  fi
else
  echo "❌ Error: No .env file found in current directory."
  exit 1
fi

# Prompt for password (hidden input)
echo "This script will update the '$USERNAME' user password."
read -s -p "Enter new password: " PASSWORD
echo

# Validate password input
if [ -z "$PASSWORD" ]; then
  echo "❌ Error: Password cannot be empty."
  exit 1
fi

# Extract encryption key from .env file
ENCRYPTION_KEY=$(grep "ENCRYPTION_KEY=" .env | sed 's/ENCRYPTION_KEY=//')
if [ -z "$ENCRYPTION_KEY" ]; then
  echo "❌ Error: Could not find ENCRYPTION_KEY in .env file"
  exit 1
fi

# Create the hash by concatenating encryption key with password and running through sha1sum
HASH=$(echo -n "${ENCRYPTION_KEY}${PASSWORD}" | shasum -a 1 | cut -d' ' -f1)
echo "Generated hash for user '$USERNAME'"

# Update the admin user in the database
echo "Updating admin user password..."
UPDATE_RESULT=$(docker compose exec -T postgres psql -U elevator -d elevator -tc "UPDATE users SET password = '${HASH}' WHERE username = '${USERNAME}' RETURNING id;")

# Check if the update was successful
if [[ "$UPDATE_RESULT" == *"0 rows"* ]]; then
  echo "⚠️  Admin user not found in the database. Creating new admin user..."
  
  # Get the instance ID (assuming there's at least one instance)
  INSTANCE_ID=$(docker compose exec -T postgres psql -U elevator -d elevator -tc "SELECT id FROM instances LIMIT 1;" | tr -d '[:space:]')
  
  if [ -z "$INSTANCE_ID" ]; then
    echo "❌ No instances found. Please make sure to run the database initialization first."
    exit 1
  fi
  
  # Create new admin user
  CREATE_RESULT=$(docker compose exec -T postgres psql -U elevator -d elevator -tc "
    INSERT INTO users (instance_id, username, usertype, email, displayname, password, issuperadmin, hasexpiry, expires, createdat) 
    VALUES (${INSTANCE_ID}, '${USERNAME}', 'Local', '${USERNAME}@example.com', 'Administrator', '${HASH}', TRUE, FALSE, '2030-01-01 00:00:00', NOW())
    RETURNING id;
  ")
  
  if [[ "$CREATE_RESULT" =~ [0-9]+ ]]; then
    echo "✅ New admin user created successfully!"
  else
    echo "❌ Failed to create admin user!"
    exit 1
  fi
else
  echo "✅ Admin user password updated successfully!"
fi

echo ""
echo "======================================"
echo "You can now log in with:"
echo "Username: $USERNAME"
echo "Password: [your entered password]" 
echo "======================================"
echo ""
